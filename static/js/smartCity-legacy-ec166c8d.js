!function(){function t(t,e,i,n,r,s,o){try{var a=t[s](o),h=a.value}catch(l){return void i(l)}a.done?e(h):Promise.resolve(h).then(n,r)}System.register(["./axios-legacy-c0dde2c8.js","./vue-legacy-8dfae8d8.js","./_plugin-vue_export-helper-legacy-762b7923.js"],(function(e,i){"use strict";var n,r,s,o,a,h,l,c=document.createElement("style");return c.textContent='@charset "UTF-8";/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html[data-v-928086a4]{line-height:1.15;-webkit-text-size-adjust:100%}body[data-v-928086a4]{margin:0!important}main[data-v-928086a4]{display:block}h1[data-v-928086a4]{font-size:2em;margin:.67em 0}hr[data-v-928086a4]{box-sizing:content-box;height:0;overflow:visible}pre[data-v-928086a4]{font-family:monospace,monospace;font-size:1em}a[data-v-928086a4]{background-color:transparent}abbr[title][data-v-928086a4]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b[data-v-928086a4],strong[data-v-928086a4]{font-weight:bolder}code[data-v-928086a4],kbd[data-v-928086a4],samp[data-v-928086a4]{font-family:monospace,monospace;font-size:1em}small[data-v-928086a4]{font-size:80%}sub[data-v-928086a4],sup[data-v-928086a4]{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub[data-v-928086a4]{bottom:-.25em}sup[data-v-928086a4]{top:-.5em}img[data-v-928086a4]{border-style:none}button[data-v-928086a4],input[data-v-928086a4],optgroup[data-v-928086a4],select[data-v-928086a4],textarea[data-v-928086a4]{font-family:inherit;font-size:100%;margin:0}button[data-v-928086a4],input[data-v-928086a4]{overflow:visible}button[data-v-928086a4],select[data-v-928086a4]{text-transform:none}button[data-v-928086a4],[type=button][data-v-928086a4],[type=reset][data-v-928086a4],[type=submit][data-v-928086a4]{-webkit-appearance:button}button[data-v-928086a4]::-moz-focus-inner,[type=button][data-v-928086a4]::-moz-focus-inner,[type=reset][data-v-928086a4]::-moz-focus-inner,[type=submit][data-v-928086a4]::-moz-focus-inner{border-style:none;padding:0}button[data-v-928086a4]:-moz-focusring,[type=button][data-v-928086a4]:-moz-focusring,[type=reset][data-v-928086a4]:-moz-focusring,[type=submit][data-v-928086a4]:-moz-focusring{outline:.0625rem dotted ButtonText}fieldset[data-v-928086a4]{padding:.35em .75em .625em}legend[data-v-928086a4]{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress[data-v-928086a4]{vertical-align:baseline}textarea[data-v-928086a4]{overflow:auto}[type=checkbox][data-v-928086a4],[type=radio][data-v-928086a4]{box-sizing:border-box;padding:0}[type=number][data-v-928086a4]::-webkit-inner-spin-button,[type=number][data-v-928086a4]::-webkit-outer-spin-button{height:auto}[type=search][data-v-928086a4]{-webkit-appearance:textfield;outline-offset:-.125rem}[type=search][data-v-928086a4]::-webkit-search-decoration{-webkit-appearance:none}[data-v-928086a4]::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details[data-v-928086a4]{display:block}summary[data-v-928086a4]{display:list-item}template[data-v-928086a4]{display:none}[hidden][data-v-928086a4]{display:none}.layout-content[data-v-928086a4]{padding:1.5rem}.not-padding-bottom[data-v-928086a4]{padding-bottom:0}.ant-table-body[data-v-928086a4]::-webkit-scrollbar{width:.4375rem}.ant-table-body[data-v-928086a4]::-webkit-scrollbar-track{-webkit-box-shadow:inset0.375remrgba(0,0,0,.3);border-radius:.3125rem}.ant-table-body[data-v-928086a4]::-webkit-scrollbar-thumb{border-radius:.3125rem;background:rgba(0,0,0,.1);-webkit-box-shadow:inset0.375remrgba(0,0,0,.5)}.ant-table-body[data-v-928086a4]::-webkit-scrollbar-thumb:window-inactive{background:rgba(255,0,0,.4)}#maptalksID[data-v-928086a4]{height:100%;width:100%}\n',document.head.appendChild(c),{setters:[t=>{n=t.c},t=>{r=t.l,s=t.r,o=t.p,a=t.a1,h=t.V},t=>{l=t._}],execute:function(){
/**
			 * @license
			 * Copyright 2010-2023 Three.js Authors
			 * SPDX-License-Identifier: MIT
			 */
const i="149",c=100,u=301,d=302,f=306,p=1e3,g=1001,m=1002,_=1003,v=1005,y=1006,x=1008,w=1009,b=1014,M=1015,S=1016,C=1020,T=1023,P=1026,A=1027,E=33776,L=33777,R=33778,O=33779,D=36492,I=3e3,k=3001,z="srgb",N="srgb-linear",F=7680,j=35044,B="300 es",U=1035;// fallback for WebGL 1
/**
			 * https://github.com/mrdoob/eventdispatcher.js/
			 */
class G{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;// Make a copy, in case listeners are removed while iterating.
const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t);t.target=null}}}const H=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],V=Math.PI/180,W=180/Math.PI;// http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript/21963136#21963136
function Z(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;// .toLowerCase() here flattens concatenated strings to save heap memory space.
return(H[255&t]+H[t>>8&255]+H[t>>16&255]+H[t>>24&255]+"-"+H[255&e]+H[e>>8&255]+"-"+H[e>>16&15|64]+H[e>>24&255]+"-"+H[63&i|128]+H[i>>8&255]+"-"+H[i>>16&255]+H[i>>24&255]+H[255&n]+H[n>>8&255]+H[n>>16&255]+H[n>>24&255]).toLowerCase()}function q(t,e,i){return Math.max(e,Math.min(i,t))}// compute euclidean modulo of m % n
// https://en.wikipedia.org/wiki/Modulo_operation
// https://en.wikipedia.org/wiki/Linear_interpolation
function X(t,e,i){return(1-i)*t+i*e}function J(t){return 0==(t&t-1)&&0!==t}function Y(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function Q(t,e){switch(e.constructor){case Float32Array:return t;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function K(t,e){switch(e.constructor){case Float32Array:return t;case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}class ${constructor(t=0,e=0){$.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){// assumes min < max, componentwise
return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),r=this.x-t.x,s=this.y-t.y;return this.x=r*i-s*n+t.x,this.y=r*n+s*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class tt{constructor(){tt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1]}set(t,e,i,n,r,s,o,a,h){const l=this.elements;return l[0]=t,l[1]=n,l[2]=o,l[3]=e,l[4]=r,l[5]=a,l[6]=i,l[7]=s,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],o=i[3],a=i[6],h=i[1],l=i[4],c=i[7],u=i[2],d=i[5],f=i[8],p=n[0],g=n[3],m=n[6],_=n[1],v=n[4],y=n[7],x=n[2],w=n[5],b=n[8];return r[0]=s*p+o*_+a*x,r[3]=s*g+o*v+a*w,r[6]=s*m+o*y+a*b,r[1]=h*p+l*_+c*x,r[4]=h*g+l*v+c*w,r[7]=h*m+l*y+c*b,r[2]=u*p+d*_+f*x,r[5]=u*g+d*v+f*w,r[8]=u*m+d*y+f*b,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],h=t[7],l=t[8];return e*s*l-e*o*h-i*r*l+i*o*a+n*r*h-n*s*a}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],h=t[7],l=t[8],c=l*s-o*h,u=o*a-l*r,d=h*r-s*a,f=e*c+i*u+n*d;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);const p=1/f;return t[0]=c*p,t[1]=(n*h-l*i)*p,t[2]=(o*i-n*s)*p,t[3]=u*p,t[4]=(l*e-n*a)*p,t[5]=(n*r-o*e)*p,t[6]=d*p,t[7]=(i*a-h*e)*p,t[8]=(s*e-i*r)*p,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,r,s,o){const a=Math.cos(r),h=Math.sin(r);return this.set(i*a,i*h,-i*(a*s+h*o)+s+t,-n*h,n*a,-n*(-h*s+a*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(et.makeScale(t,e)),this}rotate(t){return this.premultiply(et.makeRotation(-t)),this}translate(t,e){return this.premultiply(et.makeTranslation(t,e)),this}// for 2D Transforms
makeTranslation(t,e){return this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){// counterclockwise
const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,i,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,i=t.elements;for(let n=0;n<9;n++)if(e[n]!==i[n])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const et=new tt;function it(t){// assumes larger values usually on last
for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;// account for PRIMITIVE_RESTART_FIXED_INDEX, #24565
return!1}function nt(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}function rt(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function st(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}// JavaScript RGB-to-RGB transforms, defined as
// FN[InputColorSpace][OutputColorSpace] callback functions.
const ot={[z]:{[N]:rt},[N]:{[z]:st}},at={legacyMode:!0,get workingColorSpace(){return N},set workingColorSpace(t){},convert:function(t,e,i){if(this.legacyMode||e===i||!e||!i)return t;if(ot[e]&&void 0!==ot[e][i]){const n=ot[e][i];return t.r=n(t.r),t.g=n(t.g),t.b=n(t.b),t}throw new Error("Unsupported color space conversion.")},fromWorkingColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this.workingColorSpace)}},ht={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},lt={r:0,g:0,b:0},ct={h:0,s:0,l:0},ut={h:0,s:0,l:0};function dt(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function ft(t,e){return e.r=t.r,e.g=t.g,e.b=t.b,e}class pt{constructor(t,e,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=z){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,at.toWorkingColorSpace(this,e),this}setRGB(t,e,i,n=at.workingColorSpace){return this.r=t,this.g=e,this.b=i,at.toWorkingColorSpace(this,n),this}setHSL(t,e,i,n=at.workingColorSpace){var r;if(// h,s,l ranges are in 0.0 - 1.0
t=(t%(r=1)+r)%r,e=q(e,0,1),i=q(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,r=2*i-n;this.r=dt(r,n,t+1/3),this.g=dt(r,n,t),this.b=dt(r,n,t-1/3)}return at.toWorkingColorSpace(this,n),this}setStyle(t,e=z){function i(t){void 0!==t&&parseFloat(t)}let n;if(n=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(t)){// rgb / hsl
let t;const r=n[1],s=n[2];switch(r){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))// rgb(255,0,0) rgba(255,0,0,0.5)
return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,at.toWorkingColorSpace(this,e),i(t[4]),this;if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))// rgb(100%,0%,0%) rgba(100%,0%,0%,0.5)
return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,at.toWorkingColorSpace(this,e),i(t[4]),this;break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s)){// hsl(120,50%,50%) hsla(120,50%,50%,0.5)
const n=parseFloat(t[1])/360,r=parseFloat(t[2])/100,s=parseFloat(t[3])/100;return i(t[4]),this.setHSL(n,r,s,e)}}}else if(n=/^\#([A-Fa-f\d]+)$/.exec(t)){// hex color
const t=n[1],i=t.length;if(3===i)// #ff0
return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,at.toWorkingColorSpace(this,e),this;if(6===i)// #ff0000
return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,at.toWorkingColorSpace(this,e),this}return t&&t.length>0?this.setColorName(t,e):this}setColorName(t,e=z){// color keywords
const i=ht[t.toLowerCase()];return void 0!==i&&// red
this.setHex(i,e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=rt(t.r),this.g=rt(t.g),this.b=rt(t.b),this}copyLinearToSRGB(t){return this.r=st(t.r),this.g=st(t.g),this.b=st(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=z){return at.fromWorkingColorSpace(ft(this,lt),t),q(255*lt.r,0,255)<<16^q(255*lt.g,0,255)<<8^q(255*lt.b,0,255)<<0}getHexString(t=z){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=at.workingColorSpace){// h,s,l ranges are in 0.0 - 1.0
at.fromWorkingColorSpace(ft(this,lt),e);const i=lt.r,n=lt.g,r=lt.b,s=Math.max(i,n,r),o=Math.min(i,n,r);let a,h;const l=(o+s)/2;if(o===s)a=0,h=0;else{const t=s-o;switch(h=l<=.5?t/(s+o):t/(2-s-o),s){case i:a=(n-r)/t+(n<r?6:0);break;case n:a=(r-i)/t+2;break;case r:a=(i-n)/t+4}a/=6}return t.h=a,t.s=h,t.l=l,t}getRGB(t,e=at.workingColorSpace){return at.fromWorkingColorSpace(ft(this,lt),e),t.r=lt.r,t.g=lt.g,t.b=lt.b,t}getStyle(t=z){return at.fromWorkingColorSpace(ft(this,lt),t),t!==z?`color(${t} ${lt.r} ${lt.g} ${lt.b})`:`rgb(${255*lt.r|0},${255*lt.g|0},${255*lt.b|0})`}offsetHSL(t,e,i){return this.getHSL(ct),ct.h+=t,ct.s+=e,ct.l+=i,this.setHSL(ct.h,ct.s,ct.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(ct),t.getHSL(ut);const i=X(ct.h,ut.h,e),n=X(ct.s,ut.s,e),r=X(ct.l,ut.l,e);return this.setHSL(i,n,r),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}let gt;pt.NAMES=ht;class mt{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===gt&&(gt=nt("canvas")),gt.width=t.width,gt.height=t.height;const i=gt.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=gt}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=nt("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");i.drawImage(t,0,0,t.width,t.height);const n=i.getImageData(0,0,t.width,t.height),r=n.data;for(let t=0;t<r.length;t++)r[t]=255*rt(r[t]/255);return i.putImageData(n,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*rt(e[t]/255)):// assuming float
e[t]=rt(e[t]);return{data:e,width:t.width,height:t.height}}return t}}class _t{constructor(t=null){this.isSource=!0,this.uuid=Z(),this.data=t,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let t;if(Array.isArray(n)){// cube texture
t=[];for(let e=0,i=n.length;e<i;e++)n[e].isDataTexture?t.push(vt(n[e].image)):t.push(vt(n[e]))}else// texture
t=vt(n);i.url=t}return e||(t.images[this.uuid]=i),i}}function vt(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?mt.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:{}}let yt=0;class xt extends G{constructor(t=xt.DEFAULT_IMAGE,e=xt.DEFAULT_MAPPING,i=1001,n=1001,r=1006,s=1008,o=1023,a=1009,h=xt.DEFAULT_ANISOTROPY,l=3e3){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:yt++}),this.uuid=Z(),this.name="",this.source=new _t(t),this.mipmaps=[],this.mapping=e,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=s,this.anisotropy=h,this.format=o,this.internalFormat=null,this.type=a,this.offset=new $(0,0),this.repeat=new $(1,1),this.center=new $(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new tt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,// valid values: 1, 2, 4, 8 (see http://www.khronos.org/opengles/sdk/docs/man/xhtml/glPixelStorei.xml)
// Values of encoding !== THREE.LinearEncoding only supported on map, envMap and emissiveMap.
// Also changing the encoding after already used by a Material will not automatically make the Material
// update. You need to explicitly call Material.needsUpdate to trigger it to recompile.
this.encoding=l,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,// indicates whether a texture belongs to a render target or not
this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(t){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),e||(t.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case p:t.x=t.x-Math.floor(t.x);break;case g:t.x=t.x<0?0:1;break;case m:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case p:t.y=t.y-Math.floor(t.y);break;case g:t.y=t.y<0?0:1;break;case m:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}}xt.DEFAULT_IMAGE=null,xt.DEFAULT_MAPPING=300,xt.DEFAULT_ANISOTROPY=1;class wt{constructor(t=0,e=0,i=0,n=1){wt.prototype.isVector4=!0,this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=this.w,s=t.elements;return this.x=s[0]*e+s[4]*i+s[8]*n+s[12]*r,this.y=s[1]*e+s[5]*i+s[9]*n+s[13]*r,this.z=s[2]*e+s[6]*i+s[10]*n+s[14]*r,this.w=s[3]*e+s[7]*i+s[11]*n+s[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){// http://www.euclideanspace.com/maths/geometry/rotations/conversions/quaternionToAngle/index.htm
// q is assumed to be normalized
this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){// http://www.euclideanspace.com/maths/geometry/rotations/conversions/matrixToAngle/index.htm
// assumes the upper 3x3 of m is a pure rotation matrix (i.e, unscaled)
let e,i,n,r;// variables for result
const s=.01,// margin to allow for rounding errors
o=.1,// margin to distinguish between 0 and 180 degrees
a=t.elements,h=a[0],l=a[4],c=a[8],u=a[1],d=a[5],f=a[9],p=a[2],g=a[6],m=a[10];if(Math.abs(l-u)<s&&Math.abs(c-p)<s&&Math.abs(f-g)<s){// singularity found
// first check for identity matrix which must have +1 for all terms
// in leading diagonal and zero in other terms
if(Math.abs(l+u)<o&&Math.abs(c+p)<o&&Math.abs(f+g)<o&&Math.abs(h+d+m-3)<o)// this singularity is identity matrix so angle = 0
return this.set(1,0,0,0),this;// zero angle, arbitrary axis
// otherwise this singularity is angle = 180
e=Math.PI;const t=(h+1)/2,a=(d+1)/2,_=(m+1)/2,v=(l+u)/4,y=(c+p)/4,x=(f+g)/4;return t>a&&t>_?// m11 is the largest diagonal term
t<s?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(t),n=v/i,r=y/i):a>_?// m22 is the largest diagonal term
a<s?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(a),i=v/n,r=x/n):// m33 is the largest diagonal term so base result on this
_<s?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(_),i=y/r,n=x/r),this.set(i,n,r,e),this;// return 180 deg rotation
}// as we have reached here there are no singularities so we can handle normally
let _=Math.sqrt((g-f)*(g-f)+(c-p)*(c-p)+(u-l)*(u-l));// used to normalize
return Math.abs(_)<.001&&(_=1),// prevent divide by zero, should not happen if matrix is orthogonal and should be
// caught by singularity test above, but I've left it in just in case
this.x=(g-f)/_,this.y=(c-p)/_,this.z=(u-l)/_,this.w=Math.acos((h+d+m-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){// assumes min < max, componentwise
return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}
/*
			 In options, we can specify:
			 * Texture parameters for an auto-generated target texture
			 * depthBuffer/stencilBuffer: Booleans to indicate if we should generate these buffers
			*/class bt extends G{constructor(t=1,e=1,i={}){super(),this.isWebGLRenderTarget=!0,this.width=t,this.height=e,this.depth=1,this.scissor=new wt(0,0,t,e),this.scissorTest=!1,this.viewport=new wt(0,0,t,e);const n={width:t,height:e,depth:1};this.texture=new xt(n,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.internalFormat=void 0!==i.internalFormat?i.internalFormat:null,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:y,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null,this.samples=void 0!==i.samples?i.samples:0}setSize(t,e,i=1){this.width===t&&this.height===e&&this.depth===i||(this.width=t,this.height=e,this.depth=i,this.texture.image.width=t,this.texture.image.height=e,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.texture.isRenderTargetTexture=!0;// ensure image object is not shared, see #20328
const e=Object.assign({},t.texture.image);return this.texture.source=new _t(e),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Mt extends xt{constructor(t=null,e=1,i=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:i,depth:n},this.magFilter=_,this.minFilter=_,this.wrapR=g,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class St extends xt{constructor(t=null,e=1,i=1,n=1){// We're going to add .setXXX() methods for setting properties later.
// Users can still set in DataTexture3D directly.
//	const texture = new THREE.DataTexture3D( data, width, height, depth );
// 	texture.anisotropy = 16;
// See #14839
super(null),this.isData3DTexture=!0,this.image={data:t,width:e,height:i,depth:n},this.magFilter=_,this.minFilter=_,this.wrapR=g,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Ct{constructor(t=0,e=0,i=0,n=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=n}static slerpFlat(t,e,i,n,r,s,o){// fuzz-free, array-based Quaternion SLERP operation
let a=i[n+0],h=i[n+1],l=i[n+2],c=i[n+3];const u=r[s+0],d=r[s+1],f=r[s+2],p=r[s+3];if(0===o)return t[e+0]=a,t[e+1]=h,t[e+2]=l,void(t[e+3]=c);if(1===o)return t[e+0]=u,t[e+1]=d,t[e+2]=f,void(t[e+3]=p);if(c!==p||a!==u||h!==d||l!==f){let t=1-o;const e=a*u+h*d+l*f+c*p,i=e>=0?1:-1,n=1-e*e;// Skip the Slerp for tiny steps to avoid numeric problems:
if(n>Number.EPSILON){const r=Math.sqrt(n),s=Math.atan2(r,e*i);t=Math.sin(t*s)/r,o=Math.sin(o*s)/r}const r=o*i;// Normalize in case we just did a lerp:
if(a=a*t+u*r,h=h*t+d*r,l=l*t+f*r,c=c*t+p*r,t===1-o){const t=1/Math.sqrt(a*a+h*h+l*l+c*c);a*=t,h*=t,l*=t,c*=t}}t[e]=a,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,i,n,r,s){const o=i[n],a=i[n+1],h=i[n+2],l=i[n+3],c=r[s],u=r[s+1],d=r[s+2],f=r[s+3];return t[e]=o*f+l*c+a*d-h*u,t[e+1]=a*f+l*u+h*c-o*d,t[e+2]=h*f+l*d+o*u-a*c,t[e+3]=l*f-o*c-a*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){const i=t._x,n=t._y,r=t._z,s=t._order,o=Math.cos,a=Math.sin,h=o(i/2),l=o(n/2),c=o(r/2),u=a(i/2),d=a(n/2),f=a(r/2);// http://www.mathworks.com/matlabcentral/fileexchange/
// 	20696-function-to-convert-between-dcm-euler-angles-quaternions-and-euler-vectors/
//	content/SpinCalc.m
switch(s){case"XYZ":this._x=u*l*c+h*d*f,this._y=h*d*c-u*l*f,this._z=h*l*f+u*d*c,this._w=h*l*c-u*d*f;break;case"YXZ":this._x=u*l*c+h*d*f,this._y=h*d*c-u*l*f,this._z=h*l*f-u*d*c,this._w=h*l*c+u*d*f;break;case"ZXY":this._x=u*l*c-h*d*f,this._y=h*d*c+u*l*f,this._z=h*l*f+u*d*c,this._w=h*l*c-u*d*f;break;case"ZYX":this._x=u*l*c-h*d*f,this._y=h*d*c+u*l*f,this._z=h*l*f-u*d*c,this._w=h*l*c+u*d*f;break;case"YZX":this._x=u*l*c+h*d*f,this._y=h*d*c+u*l*f,this._z=h*l*f-u*d*c,this._w=h*l*c-u*d*f;break;case"XZY":this._x=u*l*c-h*d*f,this._y=h*d*c-u*l*f,this._z=h*l*f+u*d*c,this._w=h*l*c+u*d*f}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){// http://www.euclideanspace.com/maths/geometry/rotations/conversions/angleToQuaternion/index.htm
// assumes axis is normalized
const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){// http://www.euclideanspace.com/maths/geometry/rotations/conversions/matrixToQuaternion/index.htm
// assumes the upper 3x3 of m is a pure rotation matrix (i.e, unscaled)
const e=t.elements,i=e[0],n=e[4],r=e[8],s=e[1],o=e[5],a=e[9],h=e[2],l=e[6],c=e[10],u=i+o+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-a)*t,this._y=(r-h)*t,this._z=(s-n)*t}else if(i>o&&i>c){const t=2*Math.sqrt(1+i-o-c);this._w=(l-a)/t,this._x=.25*t,this._y=(n+s)/t,this._z=(r+h)/t}else if(o>c){const t=2*Math.sqrt(1+o-i-c);this._w=(r-h)/t,this._x=(n+s)/t,this._y=.25*t,this._z=(a+l)/t}else{const t=2*Math.sqrt(1+c-i-o);this._w=(s-n)/t,this._x=(r+h)/t,this._y=(a+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){// assumes direction vectors vFrom and vTo are normalized
let i=t.dot(e)+1;return i<Number.EPSILON?(// vFrom and vTo point in opposite directions
i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(// crossVectors( vFrom, vTo ); // inlined to avoid cyclic dependency on Vector3
this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(q(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){// quaternion is assumed to have unit length
return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){// from http://www.euclideanspace.com/maths/algebra/realNormedAlgebra/quaternions/code/index.htm
const i=t._x,n=t._y,r=t._z,s=t._w,o=e._x,a=e._y,h=e._z,l=e._w;return this._x=i*l+s*o+n*h-r*a,this._y=n*l+s*a+r*o-i*h,this._z=r*l+s*h+i*a-n*o,this._w=s*l-i*o-n*a-r*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,r=this._z,s=this._w;// http://www.euclideanspace.com/maths/algebra/realNormedAlgebra/quaternions/slerp/
let o=s*t._w+i*t._x+n*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=s,this._x=i,this._y=n,this._z=r,this;const a=1-o*o;if(a<=Number.EPSILON){const t=1-e;return this._w=t*s+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const h=Math.sqrt(a),l=Math.atan2(h,o),c=Math.sin((1-e)*l)/h,u=Math.sin(e*l)/h;return this._w=s*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=r*c+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){// Derived from http://planning.cs.uiuc.edu/node198.html
// Note, this source uses w, x, y, z ordering,
// so we swap the order below.
const t=Math.random(),e=Math.sqrt(1-t),i=Math.sqrt(t),n=2*Math.PI*Math.random(),r=2*Math.PI*Math.random();return this.set(e*Math.cos(n),i*Math.sin(r),i*Math.cos(r),e*Math.sin(n))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Tt{constructor(t=0,e=0,i=0){Tt.prototype.isVector3=!0,this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),// sprite.scale.set(x,y)
this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(At.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(At.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6]*n,this.y=r[1]*e+r[4]*i+r[7]*n,this.z=r[2]*e+r[5]*i+r[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=t.elements,s=1/(r[3]*e+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*e+r[4]*i+r[8]*n+r[12])*s,this.y=(r[1]*e+r[5]*i+r[9]*n+r[13])*s,this.z=(r[2]*e+r[6]*i+r[10]*n+r[14])*s,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,r=t.x,s=t.y,o=t.z,a=t.w,h=a*e+s*n-o*i,l=a*i+o*e-r*n,c=a*n+r*i-s*e,u=-r*e-s*i-o*n;// calculate result * inverse quat
return this.x=h*a+u*-r+l*-o-c*-s,this.y=l*a+u*-s+c*-r-h*-o,this.z=c*a+u*-o+h*-s-l*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){// input: THREE.Matrix4 affine matrix
// vector interpreted as a direction
const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n,this.y=r[1]*e+r[5]*i+r[9]*n,this.z=r[2]*e+r[6]*i+r[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){// assumes min < max, componentwise
return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}// TODO lengthSquared?
lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,r=t.z,s=e.x,o=e.y,a=e.z;return this.x=n*a-r*o,this.y=r*s-i*a,this.z=i*o-n*s,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return Pt.copy(this).projectOnVector(t),this.sub(Pt)}reflect(t){// reflect incident vector off plane orthogonal to normal
// normal is assumed to have unit length
return this.sub(Pt.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;// clamp, to handle numerical problems
return Math.acos(q(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){// Derived from https://mathworld.wolfram.com/SpherePointPicking.html
const t=2*(Math.random()-.5),e=Math.random()*Math.PI*2,i=Math.sqrt(1-t**2);return this.x=i*Math.cos(e),this.y=i*Math.sin(e),this.z=t,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Pt=new Tt,At=new Ct;class Et{constructor(t=new Tt(1/0,1/0,1/0),e=new Tt(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,h=t.length;a<h;a+=3){const h=t[a],l=t[a+1],c=t[a+2];h<e&&(e=h),l<i&&(i=l),c<n&&(n=c),h>r&&(r=h),l>s&&(s=l),c>o&&(o=c)}return this.min.set(e,i,n),this.max.set(r,s,o),this}setFromBufferAttribute(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,h=t.count;a<h;a++){const h=t.getX(a),l=t.getY(a),c=t.getZ(a);h<e&&(e=h),l<i&&(i=l),c<n&&(n=c),h>r&&(r=h),l>s&&(s=l),c>o&&(o=c)}return this.min.set(e,i,n),this.max.set(r,s,o),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=Rt.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){// this is a more robust check for empty than ( volume <= 0 ) because volume can get positive with two negative axes
return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){// Computes the world-axis-aligned bounding box of an object (including its children),
// accounting for both the object's, and children's, world transforms
t.updateWorldMatrix(!1,!1);const i=t.geometry;if(void 0!==i)if(e&&null!=i.attributes&&void 0!==i.attributes.position){const e=i.attributes.position;for(let i=0,n=e.count;i<n;i++)Rt.fromBufferAttribute(e,i).applyMatrix4(t.matrixWorld),this.expandByPoint(Rt)}else null===i.boundingBox&&i.computeBoundingBox(),Ot.copy(i.boundingBox),Ot.applyMatrix4(t.matrixWorld),this.union(Ot);const n=t.children;for(let r=0,s=n.length;r<s;r++)this.expandByObject(n[r],e);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){// This can potentially have a divide by zero if the box
// has a size dimension of 0.
return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){// using 6 splitting planes to rule out intersections.
return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){// If that point is inside the sphere, the AABB and sphere intersect.
// Find the point on the AABB closest to the sphere center.
return this.clampPoint(t.center,Rt),Rt.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){// We compute the minimum and maximum dot product values. If those values
// are on the same side (back or front) of the plane, then there is no intersection.
let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;// compute box center and extents
this.getCenter(jt),Bt.subVectors(this.max,jt),// translate triangle to aabb origin
Dt.subVectors(t.a,jt),It.subVectors(t.b,jt),kt.subVectors(t.c,jt),// compute edge vectors for triangle
zt.subVectors(It,Dt),Nt.subVectors(kt,It),Ft.subVectors(Dt,kt);// test against axes that are given by cross product combinations of the edges of the triangle and the edges of the aabb
// make an axis testing of each of the 3 sides of the aabb against each of the 3 sides of the triangle = 9 axis of separation
// axis_ij = u_i x f_j (u0, u1, u2 = face normals of aabb = x,y,z axes vectors since aabb is axis aligned)
let e=[0,-zt.z,zt.y,0,-Nt.z,Nt.y,0,-Ft.z,Ft.y,zt.z,0,-zt.x,Nt.z,0,-Nt.x,Ft.z,0,-Ft.x,-zt.y,zt.x,0,-Nt.y,Nt.x,0,-Ft.y,Ft.x,0];return!!Ht(e,Dt,It,kt,Bt)&&(// test 3 face normals from the aabb
e=[1,0,0,0,1,0,0,0,1],!!Ht(e,Dt,It,kt,Bt)&&(// finally testing the face normal of the triangle
// use already existing triangle edge vectors here
Ut.crossVectors(zt,Nt),e=[Ut.x,Ut.y,Ut.z],Ht(e,Dt,It,kt,Bt)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return Rt.copy(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){return this.getCenter(t.center),t.radius=.5*this.getSize(Rt).length(),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),// ensure that if there is no overlap, the result is fully empty, not slightly empty with non-inf/+inf values that will cause subsequence intersects to erroneously return valid values.
this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){// transform of empty box is an empty box.
return this.isEmpty()||(// NOTE: I am using a binary pattern to specify all 2^3 combinations below
Lt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),// 000
Lt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),// 001
Lt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),// 010
Lt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),// 011
Lt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),// 100
Lt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),// 101
Lt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),// 110
Lt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),// 111
this.setFromPoints(Lt)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const Lt=[new Tt,new Tt,new Tt,new Tt,new Tt,new Tt,new Tt,new Tt],Rt=new Tt,Ot=new Et,Dt=new Tt,It=new Tt,kt=new Tt,zt=new Tt,Nt=new Tt,Ft=new Tt,jt=new Tt,Bt=new Tt,Ut=new Tt,Gt=new Tt;function Ht(t,e,i,n,r){for(let s=0,o=t.length-3;s<=o;s+=3){Gt.fromArray(t,s);// project the aabb onto the separating axis
const o=r.x*Math.abs(Gt.x)+r.y*Math.abs(Gt.y)+r.z*Math.abs(Gt.z),a=e.dot(Gt),h=i.dot(Gt),l=n.dot(Gt);// project all 3 vertices of the triangle onto the separating axis
// actual test, basically see if either of the most extreme of the triangle points intersects r
if(Math.max(-Math.max(a,h,l),Math.min(a,h,l))>o)// points of the projected triangle are outside the projected half-length of the aabb
// the axis is separating and we can exit
return!1}return!0}const Vt=new Et,Wt=new Tt,Zt=new Tt;let qt=class{constructor(t=new Tt,e=-1){this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):Vt.setFromPoints(t).getCenter(i);let n=0;for(let r=0,s=t.length;r<s;r++)n=Math.max(n,i.distanceToSquared(t[r]));return this.radius=Math.sqrt(n),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(// Empty sphere produces empty bounding box
t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Wt.subVectors(t,this.center);const e=Wt.lengthSq();if(e>this.radius*this.radius){// calculate the minimal sphere
const t=Math.sqrt(e),i=.5*(t-this.radius);this.center.addScaledVector(Wt,i/t),this.radius+=i}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(Zt.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Wt.copy(t.center).add(Zt)),this.expandByPoint(Wt.copy(t.center).sub(Zt))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}};const Xt=new Tt,Jt=new Tt,Yt=new Tt,Qt=new Tt,Kt=new Tt,$t=new Tt,te=new Tt;class ee{constructor(t=new Tt,e=new Tt(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Xt)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Xt.subVectors(t,this.origin).dot(this.direction);// point behind the ray
return e<0?this.origin.distanceToSquared(t):(Xt.copy(this.direction).multiplyScalar(e).add(this.origin),Xt.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){// from https://github.com/pmjoniak/GeometricTools/blob/master/GTEngine/Include/Mathematics/GteDistRaySegment.h
// It returns the min distance between the ray and the segment
// defined by v0 and v1
// It can also set two optional targets :
// - The closest point on the ray
// - The closest point on the segment
Jt.copy(t).add(e).multiplyScalar(.5),Yt.copy(e).sub(t).normalize(),Qt.copy(this.origin).sub(Jt);const r=.5*t.distanceTo(e),s=-this.direction.dot(Yt),o=Qt.dot(this.direction),a=-Qt.dot(Yt),h=Qt.lengthSq(),l=Math.abs(1-s*s);let c,u,d,f;if(l>0)if(// The ray and segment are not parallel.
c=s*a-o,u=s*o-a,f=r*l,c>=0)if(u>=-f)if(u<=f){// region 0
// Minimum at interior points of ray and segment.
const t=1/l;c*=t,u*=t,d=c*(c+s*u+2*o)+u*(s*c+u+2*a)+h}else// region 1
u=r,c=Math.max(0,-(s*u+o)),d=-c*c+u*(u+2*a)+h;else// region 5
u=-r,c=Math.max(0,-(s*u+o)),d=-c*c+u*(u+2*a)+h;else u<=-f?(// region 4
c=Math.max(0,-(-s*r+o)),u=c>0?-r:Math.min(Math.max(-r,-a),r),d=-c*c+u*(u+2*a)+h):u<=f?(// region 3
c=0,u=Math.min(Math.max(-r,-a),r),d=u*(u+2*a)+h):(// region 2
c=Math.max(0,-(s*r+o)),u=c>0?r:Math.min(Math.max(-r,-a),r),d=-c*c+u*(u+2*a)+h);else// Ray and segment are parallel.
u=s>0?-r:r,c=Math.max(0,-(s*u+o)),d=-c*c+u*(u+2*a)+h;return i&&i.copy(this.direction).multiplyScalar(c).add(this.origin),n&&n.copy(Yt).multiplyScalar(u).add(Jt),d}intersectSphere(t,e){Xt.subVectors(t.center,this.origin);const i=Xt.dot(this.direction),n=Xt.dot(Xt)-i*i,r=t.radius*t.radius;if(n>r)return null;const s=Math.sqrt(r-n),o=i-s,a=i+s;// t0 = first intersect point - entrance on front of sphere
// test to see if both t0 and t1 are behind the ray - if so, return null
return o<0&&a<0?null:// test to see if t0 is behind the ray:
// if it is, the ray is inside the sphere, so return the second exit point scaled by t1,
// in order to always return an intersect point that is in front of the ray.
o<0?this.at(a,e):this.at(o,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)// line is coplanar, return origin
return 0===t.distanceToPoint(this.origin)?0:null;// Null is preferable to undefined since undefined means.... it is undefined
const i=-(this.origin.dot(t.normal)+t.constant)/e;// Return if the ray never intersects the plane
return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){// check if the ray lies on the plane first
const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0;// ray origin is behind the plane (and is pointing behind it)
}intersectBox(t,e){let i,n,r,s,o,a;const h=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,u=this.origin;return h>=0?(i=(t.min.x-u.x)*h,n=(t.max.x-u.x)*h):(i=(t.max.x-u.x)*h,n=(t.min.x-u.x)*h),l>=0?(r=(t.min.y-u.y)*l,s=(t.max.y-u.y)*l):(r=(t.max.y-u.y)*l,s=(t.min.y-u.y)*l),i>s||r>n?null:((r>i||isNaN(i))&&(i=r),(s<n||isNaN(n))&&(n=s),c>=0?(o=(t.min.z-u.z)*c,a=(t.max.z-u.z)*c):(o=(t.max.z-u.z)*c,a=(t.min.z-u.z)*c),i>a||o>n?null:((o>i||i!=i)&&(i=o),(a<n||n!=n)&&(n=a),//return point closest to the ray (positive side)
n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,Xt)}intersectTriangle(t,e,i,n,r){// Compute the offset origin, edges, and normal.
// from https://github.com/pmjoniak/GeometricTools/blob/master/GTEngine/Include/Mathematics/GteIntrRay3Triangle3.h
Kt.subVectors(e,t),$t.subVectors(i,t),te.crossVectors(Kt,$t);// Solve Q + t*D = b1*E1 + b2*E2 (Q = kDiff, D = ray direction,
// E1 = kEdge1, E2 = kEdge2, N = Cross(E1,E2)) by
//   |Dot(D,N)|*b1 = sign(Dot(D,N))*Dot(D,Cross(Q,E2))
//   |Dot(D,N)|*b2 = sign(Dot(D,N))*Dot(D,Cross(E1,Q))
//   |Dot(D,N)|*t = -sign(Dot(D,N))*Dot(Q,N)
let s,o=this.direction.dot(te);if(o>0){if(n)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}Qt.subVectors(this.origin,t);const a=s*this.direction.dot($t.crossVectors(Qt,$t));// b1 < 0, no intersection
if(a<0)return null;const h=s*this.direction.dot(Kt.cross(Qt));// b2 < 0, no intersection
if(h<0)return null;// b1+b2 > 1, no intersection
if(a+h>o)return null;// Line intersects triangle, check if ray does.
const l=-s*Qt.dot(te);// t < 0, no intersection
return l<0?null:this.at(l/o,r);// Ray intersects triangle.
}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class ie{constructor(){ie.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}set(t,e,i,n,r,s,o,a,h,l,c,u,d,f,p,g){const m=this.elements;return m[0]=t,m[4]=e,m[8]=i,m[12]=n,m[1]=r,m[5]=s,m[9]=o,m[13]=a,m[2]=h,m[6]=l,m[10]=c,m[14]=u,m[3]=d,m[7]=f,m[11]=p,m[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new ie).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){// this method does not support reflection matrices
const e=this.elements,i=t.elements,n=1/ne.setFromMatrixColumn(t,0).length(),r=1/ne.setFromMatrixColumn(t,1).length(),s=1/ne.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*s,e[9]=i[9]*s,e[10]=i[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,i=t.x,n=t.y,r=t.z,s=Math.cos(i),o=Math.sin(i),a=Math.cos(n),h=Math.sin(n),l=Math.cos(r),c=Math.sin(r);if("XYZ"===t.order){const t=s*l,i=s*c,n=o*l,r=o*c;e[0]=a*l,e[4]=-a*c,e[8]=h,e[1]=i+n*h,e[5]=t-r*h,e[9]=-o*a,e[2]=r-t*h,e[6]=n+i*h,e[10]=s*a}else if("YXZ"===t.order){const t=a*l,i=a*c,n=h*l,r=h*c;e[0]=t+r*o,e[4]=n*o-i,e[8]=s*h,e[1]=s*c,e[5]=s*l,e[9]=-o,e[2]=i*o-n,e[6]=r+t*o,e[10]=s*a}else if("ZXY"===t.order){const t=a*l,i=a*c,n=h*l,r=h*c;e[0]=t-r*o,e[4]=-s*c,e[8]=n+i*o,e[1]=i+n*o,e[5]=s*l,e[9]=r-t*o,e[2]=-s*h,e[6]=o,e[10]=s*a}else if("ZYX"===t.order){const t=s*l,i=s*c,n=o*l,r=o*c;e[0]=a*l,e[4]=n*h-i,e[8]=t*h+r,e[1]=a*c,e[5]=r*h+t,e[9]=i*h-n,e[2]=-h,e[6]=o*a,e[10]=s*a}else if("YZX"===t.order){const t=s*a,i=s*h,n=o*a,r=o*h;e[0]=a*l,e[4]=r-t*c,e[8]=n*c+i,e[1]=c,e[5]=s*l,e[9]=-o*l,e[2]=-h*l,e[6]=i*c+n,e[10]=t-r*c}else if("XZY"===t.order){const t=s*a,i=s*h,n=o*a,r=o*h;e[0]=a*l,e[4]=-c,e[8]=h*l,e[1]=t*c+r,e[5]=s*l,e[9]=i*c-n,e[2]=n*c-i,e[6]=o*l,e[10]=r*c+t}// bottom row
return e[3]=0,e[7]=0,e[11]=0,// last column
e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(se,t,oe)}lookAt(t,e,i){const n=this.elements;return le.subVectors(t,e),0===le.lengthSq()&&(// eye and target are in the same position
le.z=1),le.normalize(),ae.crossVectors(i,le),0===ae.lengthSq()&&(// up and z are parallel
1===Math.abs(i.z)?le.x+=1e-4:le.z+=1e-4,le.normalize(),ae.crossVectors(i,le)),ae.normalize(),he.crossVectors(le,ae),n[0]=ae.x,n[4]=he.x,n[8]=le.x,n[1]=ae.y,n[5]=he.y,n[9]=le.y,n[2]=ae.z,n[6]=he.z,n[10]=le.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],o=i[4],a=i[8],h=i[12],l=i[1],c=i[5],u=i[9],d=i[13],f=i[2],p=i[6],g=i[10],m=i[14],_=i[3],v=i[7],y=i[11],x=i[15],w=n[0],b=n[4],M=n[8],S=n[12],C=n[1],T=n[5],P=n[9],A=n[13],E=n[2],L=n[6],R=n[10],O=n[14],D=n[3],I=n[7],k=n[11],z=n[15];return r[0]=s*w+o*C+a*E+h*D,r[4]=s*b+o*T+a*L+h*I,r[8]=s*M+o*P+a*R+h*k,r[12]=s*S+o*A+a*O+h*z,r[1]=l*w+c*C+u*E+d*D,r[5]=l*b+c*T+u*L+d*I,r[9]=l*M+c*P+u*R+d*k,r[13]=l*S+c*A+u*O+d*z,r[2]=f*w+p*C+g*E+m*D,r[6]=f*b+p*T+g*L+m*I,r[10]=f*M+p*P+g*R+m*k,r[14]=f*S+p*A+g*O+m*z,r[3]=_*w+v*C+y*E+x*D,r[7]=_*b+v*T+y*L+x*I,r[11]=_*M+v*P+y*R+x*k,r[15]=_*S+v*A+y*O+x*z,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],r=t[12],s=t[1],o=t[5],a=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14];//TODO: make this more efficient
//( based on http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm )
return t[3]*(+r*a*c-n*h*c-r*o*u+i*h*u+n*o*d-i*a*d)+t[7]*(+e*a*d-e*h*u+r*s*u-n*s*d+n*h*l-r*a*l)+t[11]*(+e*h*c-e*o*d-r*s*c+i*s*d+r*o*l-i*h*l)+t[15]*(-n*o*l-e*a*c+e*o*u+n*s*c-i*s*u+i*a*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){// based on http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm
const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11],f=t[12],p=t[13],g=t[14],m=t[15],_=c*g*h-p*u*h+p*a*d-o*g*d-c*a*m+o*u*m,v=f*u*h-l*g*h-f*a*d+s*g*d+l*a*m-s*u*m,y=l*p*h-f*c*h+f*o*d-s*p*d-l*o*m+s*c*m,x=f*c*a-l*p*a-f*o*u+s*p*u+l*o*g-s*c*g,w=e*_+i*v+n*y+r*x;if(0===w)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const b=1/w;return t[0]=_*b,t[1]=(p*u*r-c*g*r-p*n*d+i*g*d+c*n*m-i*u*m)*b,t[2]=(o*g*r-p*a*r+p*n*h-i*g*h-o*n*m+i*a*m)*b,t[3]=(c*a*r-o*u*r-c*n*h+i*u*h+o*n*d-i*a*d)*b,t[4]=v*b,t[5]=(l*g*r-f*u*r+f*n*d-e*g*d-l*n*m+e*u*m)*b,t[6]=(f*a*r-s*g*r-f*n*h+e*g*h+s*n*m-e*a*m)*b,t[7]=(s*u*r-l*a*r+l*n*h-e*u*h-s*n*d+e*a*d)*b,t[8]=y*b,t[9]=(f*c*r-l*p*r-f*i*d+e*p*d+l*i*m-e*c*m)*b,t[10]=(s*p*r-f*o*r+f*i*h-e*p*h-s*i*m+e*o*m)*b,t[11]=(l*o*r-s*c*r-l*i*h+e*c*h+s*i*d-e*o*d)*b,t[12]=x*b,t[13]=(l*p*n-f*c*n+f*i*u-e*p*u-l*i*g+e*c*g)*b,t[14]=(f*o*n-s*p*n-f*i*a+e*p*a+s*i*g-e*o*g)*b,t[15]=(s*c*n-l*o*n+l*i*a-e*c*a-s*i*u+e*o*u)*b,this}scale(t){const e=this.elements,i=t.x,n=t.y,r=t.z;return e[0]*=i,e[4]*=n,e[8]*=r,e[1]*=i,e[5]*=n,e[9]*=r,e[2]*=i,e[6]*=n,e[10]*=r,e[3]*=i,e[7]*=n,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){// Based on http://www.gamedev.net/reference/articles/article1199.asp
const i=Math.cos(e),n=Math.sin(e),r=1-i,s=t.x,o=t.y,a=t.z,h=r*s,l=r*o;return this.set(h*s+i,h*o-n*a,h*a+n*o,0,h*o+n*a,l*o+i,l*a-n*s,0,h*a-n*o,l*a+n*s,r*a*a+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,n,r,s){return this.set(1,i,r,0,t,1,s,0,e,n,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,r=e._x,s=e._y,o=e._z,a=e._w,h=r+r,l=s+s,c=o+o,u=r*h,d=r*l,f=r*c,p=s*l,g=s*c,m=o*c,_=a*h,v=a*l,y=a*c,x=i.x,w=i.y,b=i.z;return n[0]=(1-(p+m))*x,n[1]=(d+y)*x,n[2]=(f-v)*x,n[3]=0,n[4]=(d-y)*w,n[5]=(1-(u+m))*w,n[6]=(g+_)*w,n[7]=0,n[8]=(f+v)*b,n[9]=(g-_)*b,n[10]=(1-(u+p))*b,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let r=ne.set(n[0],n[1],n[2]).length();const s=ne.set(n[4],n[5],n[6]).length(),o=ne.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),t.x=n[12],t.y=n[13],t.z=n[14],// scale the rotation part
re.copy(this);const a=1/r,h=1/s,l=1/o;return re.elements[0]*=a,re.elements[1]*=a,re.elements[2]*=a,re.elements[4]*=h,re.elements[5]*=h,re.elements[6]*=h,re.elements[8]*=l,re.elements[9]*=l,re.elements[10]*=l,e.setFromRotationMatrix(re),i.x=r,i.y=s,i.z=o,this}makePerspective(t,e,i,n,r,s){const o=this.elements,a=2*r/(e-t),h=2*r/(i-n),l=(e+t)/(e-t),c=(i+n)/(i-n),u=-(s+r)/(s-r),d=-2*s*r/(s-r);return o[0]=a,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=h,o[9]=c,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,i,n,r,s){const o=this.elements,a=1/(e-t),h=1/(i-n),l=1/(s-r),c=(e+t)*a,u=(i+n)*h,d=(s+r)*l;return o[0]=2*a,o[4]=0,o[8]=0,o[12]=-c,o[1]=0,o[5]=2*h,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let n=0;n<16;n++)if(e[n]!==i[n])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const ne=new Tt,re=new ie,se=new Tt(0,0,0),oe=new Tt(1,1,1),ae=new Tt,he=new Tt,le=new Tt,ce=new ie,ue=new Ct;class de{constructor(t=0,e=0,i=0,n=de.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n=this._order){return this._x=t,this._y=e,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,i=!0){// assumes the upper 3x3 of m is a pure rotation matrix (i.e, unscaled)
const n=t.elements,r=n[0],s=n[4],o=n[8],a=n[1],h=n[5],l=n[9],c=n[2],u=n[6],d=n[10];switch(e){case"XYZ":this._y=Math.asin(q(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(u,h),this._z=0);break;case"YXZ":this._x=Math.asin(-q(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(a,h)):(this._y=Math.atan2(-c,r),this._z=0);break;case"ZXY":this._x=Math.asin(q(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-c,d),this._z=Math.atan2(-s,h)):(this._y=0,this._z=Math.atan2(a,r));break;case"ZYX":this._y=Math.asin(-q(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(a,r)):(this._x=0,this._z=Math.atan2(-s,h));break;case"YZX":this._z=Math.asin(q(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-c,r)):(this._x=0,this._y=Math.atan2(o,d));break;case"XZY":this._z=Math.asin(-q(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(u,h),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-l,d),this._y=0)}return this._order=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return ce.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ce,e,i)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){// WARNING: this discards revolution information -bhouston
return ue.setFromEuler(this),this.setFromQuaternion(ue,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}de.DEFAULT_ORDER="XYZ";class fe{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}isEnabled(t){return 0!=(this.mask&(1<<t|0))}}let pe=0;const ge=new Tt,me=new Ct,_e=new ie,ve=new Tt,ye=new Tt,xe=new Tt,we=new Ct,be=new Tt(1,0,0),Me=new Tt(0,1,0),Se=new Tt(0,0,1),Ce={type:"added"},Te={type:"removed"};class Pe extends G{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:pe++}),this.uuid=Z(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Pe.DEFAULT_UP.clone();const t=new Tt,e=new de,i=new Ct,n=new Tt(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new ie},normalMatrix:{value:new tt}}),this.matrix=new ie,this.matrixWorld=new ie,this.matrixAutoUpdate=Pe.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.matrixWorldAutoUpdate=Pe.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,// checked by the renderer
this.layers=new fe,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){// assumes axis is normalized
this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){// assumes the upper 3x3 of m is a pure rotation matrix (i.e, unscaled)
this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){// assumes q is normalized
this.quaternion.copy(t)}rotateOnAxis(t,e){// rotate object on axis in object space
// axis is assumed to be normalized
return me.setFromAxisAngle(t,e),this.quaternion.multiply(me),this}rotateOnWorldAxis(t,e){// rotate object on axis in world space
// axis is assumed to be normalized
// method assumes no rotated parent
return me.setFromAxisAngle(t,e),this.quaternion.premultiply(me),this}rotateX(t){return this.rotateOnAxis(be,t)}rotateY(t){return this.rotateOnAxis(Me,t)}rotateZ(t){return this.rotateOnAxis(Se,t)}translateOnAxis(t,e){// translate object by distance along axis in object space
// axis is assumed to be normalized
return ge.copy(t).applyQuaternion(this.quaternion),this.position.add(ge.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(be,t)}translateY(t){return this.translateOnAxis(Me,t)}translateZ(t){return this.translateOnAxis(Se,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(_e.copy(this.matrixWorld).invert())}lookAt(t,e,i){// This method does not support objects having non-uniformly-scaled parent(s)
t.isVector3?ve.copy(t):ve.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),ye.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?_e.lookAt(ye,ve,this.up):_e.lookAt(ve,ye,this.up),this.quaternion.setFromRotationMatrix(_e),n&&(_e.extractRotation(n.matrixWorld),me.setFromRotationMatrix(_e),this.quaternion.premultiply(me.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this||t&&t.isObject3D&&(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(Ce)),this}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Te)),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(Te)}return this.children.length=0,this}attach(t){// adds object as a child of this, while maintaining the object's world transform
// Note: This method does not support scene graphs having non-uniformly-scaled nodes(s)
return this.updateWorldMatrix(!0,!1),_e.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),_e.multiply(t.parent.matrixWorld)),t.applyMatrix4(_e),this.add(t),t.updateWorldMatrix(!1,!0),this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}}getObjectsByProperty(t,e){let i=[];this[t]===e&&i.push(this);for(let n=0,r=this.children.length;n<r;n++){const r=this.children[n].getObjectsByProperty(t,e);r.length>0&&(i=i.concat(r))}return i}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ye,t,xe),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ye,we,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);// update children
const e=this.children;for(let i=0,n=e.length;i<n;i++){const n=e[i];!0!==n.matrixWorldAutoUpdate&&!0!==t||n.updateMatrixWorld(t)}}updateWorldMatrix(t,e){const i=this.parent;// update children
if(!0===t&&null!==i&&!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!1,!0)}}}toJSON(t){// meta is a string when called from JSON.stringify
const e=void 0===t||"string"==typeof t,i={};// meta is a hash used to collect geometries, materials.
// not providing it implies that this is the root object
// being serialized.
e&&(// initialize meta obj
t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});// standard Object3D serialization
const n={};function r(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),// object specific properties
this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){const n=i[e];r(t.shapes,n)}else r(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(r(t.materials,this.material[i]));n.material=e}else n.material=r(t.materials,this.material);
if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}
if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];n.animations.push(r(t.animations,i))}}if(e){const e=s(t.geometries),n=s(t.materials),r=s(t.textures),o=s(t.images),a=s(t.shapes),h=s(t.skeletons),l=s(t.animations),c=s(t.nodes);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),o.length>0&&(i.images=o),a.length>0&&(i.shapes=a),h.length>0&&(i.skeletons=h),l.length>0&&(i.animations=l),c.length>0&&(i.nodes=c)}return i.object=n,i;// extract data from the cache hash
// remove metadata on each item
// and return as array
function s(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let i=0;i<t.children.length;i++){const e=t.children[i];this.add(e.clone())}return this}}Pe.DEFAULT_UP=new Tt(0,1,0),Pe.DEFAULT_MATRIX_AUTO_UPDATE=!0,Pe.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Ae=new Tt,Ee=new Tt,Le=new Tt,Re=new Tt,Oe=new Tt,De=new Tt,Ie=new Tt,ke=new Tt,ze=new Tt,Ne=new Tt;class Fe{constructor(t=new Tt,e=new Tt,i=new Tt){this.a=t,this.b=e,this.c=i}static getNormal(t,e,i,n){n.subVectors(i,e),Ae.subVectors(t,e),n.cross(Ae);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}// static/instance method to calculate barycentric coordinates
// based on: http://www.blackpawn.com/texts/pointinpoly/default.html
static getBarycoord(t,e,i,n,r){Ae.subVectors(n,e),Ee.subVectors(i,e),Le.subVectors(t,e);const s=Ae.dot(Ae),o=Ae.dot(Ee),a=Ae.dot(Le),h=Ee.dot(Ee),l=Ee.dot(Le),c=s*h-o*o;// collinear or singular triangle
if(0===c)// arbitrary location outside of triangle?
// not sure if this is the best idea, maybe should be returning undefined
return r.set(-2,-1,-1);const u=1/c,d=(h*a-o*l)*u,f=(s*l-o*a)*u;// barycentric coordinates must always sum to 1
return r.set(1-d-f,f,d)}static containsPoint(t,e,i,n){return this.getBarycoord(t,e,i,n,Re),Re.x>=0&&Re.y>=0&&Re.x+Re.y<=1}static getUV(t,e,i,n,r,s,o,a){return this.getBarycoord(t,e,i,n,Re),a.set(0,0),a.addScaledVector(r,Re.x),a.addScaledVector(s,Re.y),a.addScaledVector(o,Re.z),a}static isFrontFacing(t,e,i,n){// strictly front facing
return Ae.subVectors(i,e),Ee.subVectors(t,e),Ae.cross(Ee).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}setFromAttributeAndIndices(t,e,i,n){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,i),this.c.fromBufferAttribute(t,n),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Ae.subVectors(this.c,this.b),Ee.subVectors(this.a,this.b),.5*Ae.cross(Ee).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Fe.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Fe.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,i,n,r){return Fe.getUV(t,this.a,this.b,this.c,e,i,n,r)}containsPoint(t){return Fe.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Fe.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const i=this.a,n=this.b,r=this.c;let s,o;// algorithm thanks to Real-Time Collision Detection by Christer Ericson,
// published by Morgan Kaufmann Publishers, (c) 2005 Elsevier Inc.,
// under the accompanying license; see chapter 5.1.5 for detailed explanation.
// basically, we're distinguishing which of the voronoi regions of the triangle
// the point lies in with the minimum amount of redundant computation.
Oe.subVectors(n,i),De.subVectors(r,i),ke.subVectors(t,i);const a=Oe.dot(ke),h=De.dot(ke);if(a<=0&&h<=0)// vertex region of A; barycentric coords (1, 0, 0)
return e.copy(i);ze.subVectors(t,n);const l=Oe.dot(ze),c=De.dot(ze);if(l>=0&&c<=l)// vertex region of B; barycentric coords (0, 1, 0)
return e.copy(n);const u=a*c-l*h;if(u<=0&&a>=0&&l<=0)// edge region of AB; barycentric coords (1-v, v, 0)
return s=a/(a-l),e.copy(i).addScaledVector(Oe,s);Ne.subVectors(t,r);const d=Oe.dot(Ne),f=De.dot(Ne);if(f>=0&&d<=f)// vertex region of C; barycentric coords (0, 0, 1)
return e.copy(r);const p=d*h-a*f;if(p<=0&&h>=0&&f<=0)// edge region of AC; barycentric coords (1-w, 0, w)
return o=h/(h-f),e.copy(i).addScaledVector(De,o);const g=l*f-d*c;if(g<=0&&c-l>=0&&d-f>=0)// edge region of BC; barycentric coords (0, 1-w, w)
return Ie.subVectors(r,n),o=(c-l)/(c-l+(d-f)),e.copy(n).addScaledVector(Ie,o);// edge region of BC
// face region
const m=1/(g+p+u);// u = va * denom
return s=p*m,o=u*m,e.copy(i).addScaledVector(Oe,s).addScaledVector(De,o)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}let je=0;class Be extends G{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:je++}),this.uuid=Z(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=c,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=F,this.stencilZFail=F,this.stencilZPass=F,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,// override the renderer's default precision for this material
this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i)continue;const n=this[e];void 0!==n&&(n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i)}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};// standard Material serialization
// TODO: Copied from Object3D.toJSON
function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.colorWrite=this.colorWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,// rotation (SpriteMaterial)
void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaToCoverage&&(i.alphaToCoverage=this.alphaToCoverage),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.forceSinglePass&&(i.forceSinglePass=this.forceSinglePass),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=this.flatShading),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),e){const e=n(t.textures),r=n(t.images);e.length>0&&(i.textures=e),r.length>0&&(i.images=r)}return i}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}}class Ue extends Be{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new pt(16777215),// emissive
this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const Ge=new Tt,He=new $;class Ve{constructor(t,e,i=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=i,this.usage=j,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this}copyAt(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[t+n]=e.array[i+n];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)He.fromBufferAttribute(this,e),He.applyMatrix3(t),this.setXY(e,He.x,He.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)Ge.fromBufferAttribute(this,e),Ge.applyMatrix3(t),this.setXYZ(e,Ge.x,Ge.y,Ge.z);return this}applyMatrix4(t){for(let e=0,i=this.count;e<i;e++)Ge.fromBufferAttribute(this,e),Ge.applyMatrix4(t),this.setXYZ(e,Ge.x,Ge.y,Ge.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)Ge.fromBufferAttribute(this,e),Ge.applyNormalMatrix(t),this.setXYZ(e,Ge.x,Ge.y,Ge.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)Ge.fromBufferAttribute(this,e),Ge.transformDirection(t),this.setXYZ(e,Ge.x,Ge.y,Ge.z);return this}set(t,e=0){// Matching BufferAttribute constructor, do not normalize the array.
return this.array.set(t,e),this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=Q(e,this.array)),e}setX(t,e){return this.normalized&&(e=K(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=Q(e,this.array)),e}setY(t,e){return this.normalized&&(e=K(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=Q(e,this.array)),e}setZ(t,e){return this.normalized&&(e=K(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=Q(e,this.array)),e}setW(t,e){return this.normalized&&(e=K(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,i){return t*=this.itemSize,this.normalized&&(e=K(e,this.array),i=K(i,this.array)),this.array[t+0]=e,this.array[t+1]=i,this}setXYZ(t,e,i,n){return t*=this.itemSize,this.normalized&&(e=K(e,this.array),i=K(i,this.array),n=K(n,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this}setXYZW(t,e,i,n,r){return t*=this.itemSize,this.normalized&&(e=K(e,this.array),i=K(i,this.array),n=K(n,this.array),r=K(r,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==j&&(t.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(t.updateRange=this.updateRange),t}// @deprecated
copyColorsArray(){}copyVector2sArray(){}copyVector3sArray(){}copyVector4sArray(){}}class We extends Ve{constructor(t,e,i){super(new Uint16Array(t),e,i)}}class Ze extends Ve{constructor(t,e,i){super(new Uint32Array(t),e,i)}}class qe extends Ve{constructor(t,e,i){super(new Float32Array(t),e,i)}}let Xe=0;const Je=new ie,Ye=new Pe,Qe=new Tt,Ke=new Et,$e=new Et,ti=new Tt;class ei extends G{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Xe++}),this.uuid=Z(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(it(t)?Ze:We)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new tt).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return Je.makeRotationFromQuaternion(t),this.applyMatrix4(Je),this}rotateX(t){// rotate geometry around world x-axis
return Je.makeRotationX(t),this.applyMatrix4(Je),this}rotateY(t){// rotate geometry around world y-axis
return Je.makeRotationY(t),this.applyMatrix4(Je),this}rotateZ(t){// rotate geometry around world z-axis
return Je.makeRotationZ(t),this.applyMatrix4(Je),this}translate(t,e,i){// translate geometry
return Je.makeTranslation(t,e,i),this.applyMatrix4(Je),this}scale(t,e,i){// scale geometry
return Je.makeScale(t,e,i),this.applyMatrix4(Je),this}lookAt(t){return Ye.lookAt(t),Ye.updateMatrix(),this.applyMatrix4(Ye.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Qe).negate(),this.translate(Qe.x,Qe.y,Qe.z),this}setFromPoints(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new qe(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Et);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingBox.set(new Tt(-1/0,-1/0,-1/0),new Tt(1/0,1/0,1/0));else{if(void 0!==t){// process morph attributes if present
if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Ke.setFromBufferAttribute(i),this.morphTargetsRelative?(ti.addVectors(this.boundingBox.min,Ke.min),this.boundingBox.expandByPoint(ti),ti.addVectors(this.boundingBox.max,Ke.max),this.boundingBox.expandByPoint(ti)):(this.boundingBox.expandByPoint(Ke.min),this.boundingBox.expandByPoint(Ke.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new qt);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingSphere.set(new Tt,1/0);else if(t){// first, find the center of the bounding sphere
const i=this.boundingSphere.center;// process morph attributes if present
if(Ke.setFromBufferAttribute(t),e)for(let t=0,r=e.length;t<r;t++){const i=e[t];$e.setFromBufferAttribute(i),this.morphTargetsRelative?(ti.addVectors(Ke.min,$e.min),Ke.expandByPoint(ti),ti.addVectors(Ke.max,$e.max),Ke.expandByPoint(ti)):(Ke.expandByPoint($e.min),Ke.expandByPoint($e.max))}Ke.getCenter(i);// second, try to find a boundingSphere with a radius smaller than the
// boundingSphere of the boundingBox: sqrt(3) smaller in the best case
let n=0;for(let e=0,r=t.count;e<r;e++)ti.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(ti));// process morph attributes if present
if(e)for(let r=0,s=e.length;r<s;r++){const s=e[r],o=this.morphTargetsRelative;for(let e=0,r=s.count;e<r;e++)ti.fromBufferAttribute(s,e),o&&(Qe.fromBufferAttribute(t,e),ti.add(Qe)),n=Math.max(n,i.distanceToSquared(ti))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)}}computeTangents(){const t=this.index,e=this.attributes;// based on http://www.terathon.com/code/tangent.html
// (per vertex tangents)
if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return;const i=t.array,n=e.position.array,r=e.normal.array,s=e.uv.array,o=n.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Ve(new Float32Array(4*o),4));const a=this.getAttribute("tangent").array,h=[],l=[];for(let C=0;C<o;C++)h[C]=new Tt,l[C]=new Tt;const c=new Tt,u=new Tt,d=new Tt,f=new $,p=new $,g=new $,m=new Tt,_=new Tt;function v(t,e,i){c.fromArray(n,3*t),u.fromArray(n,3*e),d.fromArray(n,3*i),f.fromArray(s,2*t),p.fromArray(s,2*e),g.fromArray(s,2*i),u.sub(c),d.sub(c),p.sub(f),g.sub(f);const r=1/(p.x*g.y-g.x*p.y);// silently ignore degenerate uv triangles having coincident or colinear vertices
isFinite(r)&&(m.copy(u).multiplyScalar(g.y).addScaledVector(d,-p.y).multiplyScalar(r),_.copy(d).multiplyScalar(p.x).addScaledVector(u,-g.x).multiplyScalar(r),h[t].add(m),h[e].add(m),h[i].add(m),l[t].add(_),l[e].add(_),l[i].add(_))}let y=this.groups;0===y.length&&(y=[{start:0,count:i.length}]);for(let C=0,T=y.length;C<T;++C){const t=y[C],e=t.start;for(let n=e,r=e+t.count;n<r;n+=3)v(i[n+0],i[n+1],i[n+2])}const x=new Tt,w=new Tt,b=new Tt,M=new Tt;function S(t){b.fromArray(r,3*t),M.copy(b);const e=h[t];// Gram-Schmidt orthogonalize
x.copy(e),x.sub(b.multiplyScalar(b.dot(e))).normalize(),// Calculate handedness
w.crossVectors(M,e);const i=w.dot(l[t])<0?-1:1;a[4*t]=x.x,a[4*t+1]=x.y,a[4*t+2]=x.z,a[4*t+3]=i}for(let C=0,T=y.length;C<T;++C){const t=y[C],e=t.start;for(let n=e,r=e+t.count;n<r;n+=3)S(i[n+0]),S(i[n+1]),S(i[n+2])}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new Ve(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else// reset existing normals to zero
for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new Tt,r=new Tt,s=new Tt,o=new Tt,a=new Tt,h=new Tt,l=new Tt,c=new Tt;// indexed elements
if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),f=t.getX(u+1),p=t.getX(u+2);n.fromBufferAttribute(e,d),r.fromBufferAttribute(e,f),s.fromBufferAttribute(e,p),l.subVectors(s,r),c.subVectors(n,r),l.cross(c),o.fromBufferAttribute(i,d),a.fromBufferAttribute(i,f),h.fromBufferAttribute(i,p),o.add(l),a.add(l),h.add(l),i.setXYZ(d,o.x,o.y,o.z),i.setXYZ(f,a.x,a.y,a.z),i.setXYZ(p,h.x,h.y,h.z)}else// non-indexed elements (unconnected triangle soup)
for(let t=0,u=e.count;t<u;t+=3)n.fromBufferAttribute(e,t+0),r.fromBufferAttribute(e,t+1),s.fromBufferAttribute(e,t+2),l.subVectors(s,r),c.subVectors(n,r),l.cross(c),i.setXYZ(t+0,l.x,l.y,l.z),i.setXYZ(t+1,l.x,l.y,l.z),i.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),i.needsUpdate=!0}}// @deprecated since r144
merge(){return this}normalizeNormals(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)ti.fromBufferAttribute(t,e),ti.normalize(),t.setXYZ(e,ti.x,ti.y,ti.z)}toNonIndexed(){function t(t,e){const i=t.array,n=t.itemSize,r=t.normalized,s=new i.constructor(e.length*n);let o=0,a=0;for(let h=0,l=e.length;h<l;h++){o=t.isInterleavedBufferAttribute?e[h]*t.data.stride+t.offset:e[h]*n;for(let t=0;t<n;t++)s[a++]=i[o++]}return new Ve(s,n,r)}
if(null===this.index)return this;const e=new ei,i=this.index.array,n=this.attributes;// attributes
for(const o in n){const r=t(n[o],i);e.setAttribute(o,r)}// morph attributes
const r=this.morphAttributes;for(const o in r){const n=[],s=r[o];// morphAttribute: array of Float32BufferAttributes
for(let e=0,r=s.length;e<r;e++){const r=t(s[e],i);n.push(r)}e.morphAttributes[o]=n}e.morphTargetsRelative=this.morphTargetsRelative;// groups
const s=this.groups;for(let o=0,a=s.length;o<a;o++){const t=s[o];e.addGroup(t.start,t.count,t.materialIndex)}return e}toJSON(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};// standard BufferGeometry serialization
if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}// for simplicity the code assumes attributes are not shared across geometries, see #15811
t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const a in i){const e=i[a];t.data.attributes[a]=e.toJSON(t.data)}const n={};let r=!1;for(const a in this.morphAttributes){const e=this.morphAttributes[a],i=[];for(let n=0,r=e.length;n<r;n++){const r=e[n];i.push(r.toJSON(t.data))}i.length>0&&(n[a]=i,r=!0)}r&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return null!==o&&(t.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){// reset
this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;// used for storing cloned, shared data
const e={};// name
this.name=t.name;// index
const i=t.index;null!==i&&this.setIndex(i.clone(e));// attributes
const n=t.attributes;for(const h in n){const t=n[h];this.setAttribute(h,t.clone(e))}// morph attributes
const r=t.morphAttributes;for(const h in r){const t=[],i=r[h];// morphAttribute: array of Float32BufferAttributes
for(let n=0,r=i.length;n<r;n++)t.push(i[n].clone(e));this.morphAttributes[h]=t}this.morphTargetsRelative=t.morphTargetsRelative;// groups
const s=t.groups;for(let h=0,l=s.length;h<l;h++){const t=s[h];this.addGroup(t.start,t.count,t.materialIndex)}// bounding box
const o=t.boundingBox;null!==o&&(this.boundingBox=o.clone());// bounding sphere
const a=t.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),// draw range
this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,// user data
this.userData=t.userData,// geometry generator parameters
void 0!==t.parameters&&(this.parameters=Object.assign({},t.parameters)),this}dispose(){this.dispatchEvent({type:"dispose"})}}const ii=new ie,ni=new ee,ri=new qt,si=new Tt,oi=new Tt,ai=new Tt,hi=new Tt,li=new Tt,ci=new $,ui=new $,di=new $,fi=new Tt,pi=new Tt;class gi extends Pe{constructor(t=new ei,e=new Ue){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}getVertexPosition(t,e){const i=this.geometry,n=i.attributes.position,r=i.morphAttributes.position,s=i.morphTargetsRelative;e.fromBufferAttribute(n,t);const o=this.morphTargetInfluences;if(r&&o){li.set(0,0,0);for(let i=0,n=r.length;i<n;i++){const n=o[i],a=r[i];0!==n&&(hi.fromBufferAttribute(a,t),s?li.addScaledVector(hi,n):li.addScaledVector(hi.sub(e),n))}e.add(li)}return this.isSkinnedMesh&&this.boneTransform(t,e),e}raycast(t,e){const i=this.geometry,n=this.material,r=this.matrixWorld;if(void 0===n)return;// Checking boundingSphere distance to ray
if(null===i.boundingSphere&&i.computeBoundingSphere(),ri.copy(i.boundingSphere),ri.applyMatrix4(r),!1===t.ray.intersectsSphere(ri))return;
// Check boundingBox before continuing
if(ii.copy(r).invert(),ni.copy(t.ray).applyMatrix4(ii),null!==i.boundingBox&&!1===ni.intersectsBox(i.boundingBox))return;let s;const o=i.index,a=i.attributes.position,h=i.attributes.uv,l=i.attributes.uv2,c=i.groups,u=i.drawRange;if(null!==o)// indexed buffer geometry
if(Array.isArray(n))for(let d=0,f=c.length;d<f;d++){const i=c[d],r=n[i.materialIndex];for(let n=Math.max(i.start,u.start),a=Math.min(o.count,Math.min(i.start+i.count,u.start+u.count));n<a;n+=3){const a=o.getX(n),c=o.getX(n+1),u=o.getX(n+2);s=mi(this,r,t,ni,h,l,a,c,u),s&&(s.faceIndex=Math.floor(n/3),// triangle number in indexed buffer semantics
s.face.materialIndex=i.materialIndex,e.push(s))}}else{for(let i=Math.max(0,u.start),r=Math.min(o.count,u.start+u.count);i<r;i+=3){const r=o.getX(i),a=o.getX(i+1),c=o.getX(i+2);s=mi(this,n,t,ni,h,l,r,a,c),s&&(s.faceIndex=Math.floor(i/3),// triangle number in indexed buffer semantics
e.push(s))}}else if(void 0!==a)// non-indexed buffer geometry
if(Array.isArray(n))for(let d=0,f=c.length;d<f;d++){const i=c[d],r=n[i.materialIndex];for(let n=Math.max(i.start,u.start),o=Math.min(a.count,Math.min(i.start+i.count,u.start+u.count));n<o;n+=3){s=mi(this,r,t,ni,h,l,n,n+1,n+2),s&&(s.faceIndex=Math.floor(n/3),// triangle number in non-indexed buffer semantics
s.face.materialIndex=i.materialIndex,e.push(s))}}else{for(let i=Math.max(0,u.start),r=Math.min(a.count,u.start+u.count);i<r;i+=3){s=mi(this,n,t,ni,h,l,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),// triangle number in non-indexed buffer semantics
e.push(s))}}}}function mi(t,e,i,n,r,s,o,a,h){t.getVertexPosition(o,si),t.getVertexPosition(a,oi),t.getVertexPosition(h,ai);const l=function(t,e,i,n,r,s,o,a){let h;if(h=1===e.side?n.intersectTriangle(o,s,r,!0,a):n.intersectTriangle(r,s,o,0===e.side,a),null===h)return null;pi.copy(a),pi.applyMatrix4(t.matrixWorld);const l=i.ray.origin.distanceTo(pi);return l<i.near||l>i.far?null:{distance:l,point:pi.clone(),object:t}}(t,e,i,n,si,oi,ai,fi);if(l){r&&(ci.fromBufferAttribute(r,o),ui.fromBufferAttribute(r,a),di.fromBufferAttribute(r,h),l.uv=Fe.getUV(fi,si,oi,ai,ci,ui,di,new $)),s&&(ci.fromBufferAttribute(s,o),ui.fromBufferAttribute(s,a),di.fromBufferAttribute(s,h),l.uv2=Fe.getUV(fi,si,oi,ai,ci,ui,di,new $));const t={a:o,b:a,c:h,normal:new Tt,materialIndex:0};Fe.getNormal(si,oi,ai,t.normal),l.face=t}return l}class _i extends ei{constructor(t=1,e=1,i=1,n=1,r=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:r,depthSegments:s};const o=this;// segments
n=Math.floor(n),r=Math.floor(r),s=Math.floor(s);// buffers
const a=[],h=[],l=[],c=[];// helper variables
let u=0,d=0;function f(t,e,i,n,r,s,f,p,g,m,_){const v=s/g,y=f/m,x=s/2,w=f/2,b=p/2,M=g+1,S=m+1;let C=0,T=0;const P=new Tt;// generate vertices, normals and uvs
for(let o=0;o<S;o++){const s=o*y-w;for(let a=0;a<M;a++){const u=a*v-x;// set values to correct vector component
P[t]=u*n,P[e]=s*r,P[i]=b,// now apply vector to vertex buffer
h.push(P.x,P.y,P.z),// set values to correct vector component
P[t]=0,P[e]=0,P[i]=p>0?1:-1,// now apply vector to normal buffer
l.push(P.x,P.y,P.z),// uvs
c.push(a/g),c.push(1-o/m),// counters
C+=1}}// indices
// 1. you need three indices to draw a single face
// 2. a single segment consists of two faces
// 3. so we need to generate six (2*3) indices per segment
for(let o=0;o<m;o++)for(let t=0;t<g;t++){const e=u+t+M*o,i=u+t+M*(o+1),n=u+(t+1)+M*(o+1),r=u+(t+1)+M*o;// faces
a.push(e,i,r),a.push(i,n,r),// increase counter
T+=6}// add a group to the geometry. this will ensure multi material support
o.addGroup(d,T,_),// calculate new start value for groups
d+=T,// update total number of vertices
u+=C}// build each side of the box geometry
f("z","y","x",-1,-1,i,e,t,s,r,0),// px
f("z","y","x",1,-1,i,e,-t,s,r,1),// nx
f("x","z","y",1,1,t,i,e,n,s,2),// py
f("x","z","y",1,-1,t,i,-e,n,s,3),// ny
f("x","y","z",1,-1,t,e,i,n,r,4),// pz
f("x","y","z",-1,-1,t,e,-i,n,r,5),// nz
// build geometry
this.setIndex(a),this.setAttribute("position",new qe(h,3)),this.setAttribute("normal",new qe(l,3)),this.setAttribute("uv",new qe(c,2))}static fromJSON(t){return new _i(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}
/**
			 * Uniform Utilities
			 */function vi(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const r=t[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?e[i][n]=r.clone():Array.isArray(r)?e[i][n]=r.slice():e[i][n]=r}}return e}function yi(t){const e={};for(let i=0;i<t.length;i++){const n=vi(t[i]);for(const t in n)e[t]=n[t]}return e}function xi(t){return null===t.getRenderTarget()&&t.outputEncoding===k?z:N}// Legacy
const wi={clone:vi,merge:yi};class bi extends Be{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,// set to use scene fog
this.lights=!1,// set to use scene lights
this.clipping=!1,// set to use user-defined clipping planes
this.extensions={derivatives:!1,// set to use derivatives
fragDepth:!1,// set to use fragment depth values
drawBuffers:!1,// set to use draw buffers
shaderTextureLOD:!1},// When rendered geometry doesn't include these attributes but the material does,
// use these default values in WebGL. This avoids errors when buffer data is missing.
this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=vi(t.uniforms),this.uniformsGroups=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].clone());return e}(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const n in this.uniforms){const i=this.uniforms[n].value;i&&i.isTexture?e.uniforms[n]={type:"t",value:i.toJSON(t).uuid}:i&&i.isColor?e.uniforms[n]={type:"c",value:i.getHex()}:i&&i.isVector2?e.uniforms[n]={type:"v2",value:i.toArray()}:i&&i.isVector3?e.uniforms[n]={type:"v3",value:i.toArray()}:i&&i.isVector4?e.uniforms[n]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?e.uniforms[n]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?e.uniforms[n]={type:"m4",value:i.toArray()}:e.uniforms[n]={value:i}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const i={};for(const n in this.extensions)!0===this.extensions[n]&&(i[n]=!0);return Object.keys(i).length>0&&(e.extensions=i),e}}class Mi extends Pe{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new ie,this.projectionMatrix=new ie,this.projectionMatrixInverse=new ie}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class Si extends Mi{constructor(t=50,e=1,i=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,// width of the film (default in millimeters)
this.filmOffset=0,// horizontal film offset (same unit as gauge)
this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}
/**
				 * Sets the FOV by focal length in respect to the current .filmGauge.
				 *
				 * The default film gauge is 35, so that the focal length can be specified for
				 * a 35mm (full frame) camera.
				 *
				 * Values for focal length and film gauge must have the same unit.
				 */setFocalLength(t){/** see {@link http://www.bobatkins.com/photography/technical/field_of_view.html} */const e=.5*this.getFilmHeight()/t;this.fov=2*W*Math.atan(e),this.updateProjectionMatrix()}
/**
				 * Calculates the focal length from the current .fov and .filmGauge.
				 */getFocalLength(){const t=Math.tan(.5*V*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*W*Math.atan(Math.tan(.5*V*this.fov)/this.zoom)}getFilmWidth(){// film not completely covered in portrait format (aspect < 1)
return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){// film not completely covered in landscape format (aspect > 1)
return this.filmGauge/Math.max(this.aspect,1)}
/**
				 * Sets an offset in a larger frustum. This is useful for multi-window or
				 * multi-monitor/multi-machine setups.
				 *
				 * For example, if you have 3x2 monitors and each monitor is 1920x1080 and
				 * the monitors are in grid like this
				 *
				 *   +---+---+---+
				 *   | A | B | C |
				 *   +---+---+---+
				 *   | D | E | F |
				 *   +---+---+---+
				 *
				 * then for each monitor you would call it like this
				 *
				 *   const w = 1920;
				 *   const h = 1080;
				 *   const fullWidth = w * 3;
				 *   const fullHeight = h * 2;
				 *
				 *   --A--
				 *   camera.setViewOffset( fullWidth, fullHeight, w * 0, h * 0, w, h );
				 *   --B--
				 *   camera.setViewOffset( fullWidth, fullHeight, w * 1, h * 0, w, h );
				 *   --C--
				 *   camera.setViewOffset( fullWidth, fullHeight, w * 2, h * 0, w, h );
				 *   --D--
				 *   camera.setViewOffset( fullWidth, fullHeight, w * 0, h * 1, w, h );
				 *   --E--
				 *   camera.setViewOffset( fullWidth, fullHeight, w * 1, h * 1, w, h );
				 *   --F--
				 *   camera.setViewOffset( fullWidth, fullHeight, w * 2, h * 1, w, h );
				 *
				 *   Note there is no reason monitors have to be the same size or in a grid.
				 */setViewOffset(t,e,i,n,r,s){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*V*this.fov)/this.zoom,i=2*e,n=this.aspect*i,r=-.5*n;const s=this.view;if(null!==this.view&&this.view.enabled){const t=s.fullWidth,o=s.fullHeight;r+=s.offsetX*n/t,e-=s.offsetY*i/o,n*=s.width/t,i*=s.height/o}const o=this.filmOffset;0!==o&&(r+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,e,e-i,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}const Ci=-90;// negative fov is not an error
class Ti extends Pe{constructor(t,e,i){super(),this.type="CubeCamera",this.renderTarget=i;const n=new Si(Ci,1,t,e);n.layers=this.layers,n.up.set(0,1,0),n.lookAt(1,0,0),this.add(n);const r=new Si(Ci,1,t,e);r.layers=this.layers,r.up.set(0,1,0),r.lookAt(-1,0,0),this.add(r);const s=new Si(Ci,1,t,e);s.layers=this.layers,s.up.set(0,0,-1),s.lookAt(0,1,0),this.add(s);const o=new Si(Ci,1,t,e);o.layers=this.layers,o.up.set(0,0,1),o.lookAt(0,-1,0),this.add(o);const a=new Si(Ci,1,t,e);a.layers=this.layers,a.up.set(0,1,0),a.lookAt(0,0,1),this.add(a);const h=new Si(Ci,1,t,e);h.layers=this.layers,h.up.set(0,1,0),h.lookAt(0,0,-1),this.add(h)}update(t,e){null===this.parent&&this.updateMatrixWorld();const i=this.renderTarget,[n,r,s,o,a,h]=this.children,l=t.getRenderTarget(),c=t.toneMapping,u=t.xr.enabled;t.toneMapping=0,t.xr.enabled=!1;const d=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0),t.render(e,n),t.setRenderTarget(i,1),t.render(e,r),t.setRenderTarget(i,2),t.render(e,s),t.setRenderTarget(i,3),t.render(e,o),t.setRenderTarget(i,4),t.render(e,a),i.texture.generateMipmaps=d,t.setRenderTarget(i,5),t.render(e,h),t.setRenderTarget(l),t.toneMapping=c,t.xr.enabled=u,i.texture.needsPMREMUpdate=!0}}class Pi extends xt{constructor(t,e,i,n,r,s,o,a,h,l){super(t=void 0!==t?t:[],e=void 0!==e?e:u,i,n,r,s,o,a,h,l),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class Ai extends bt{constructor(t=1,e={}){super(t,t,e),this.isWebGLCubeRenderTarget=!0;const i={width:t,height:t,depth:1},n=[i,i,i,i,i,i];this.texture=new Pi(n,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),// By convention -- likely based on the RenderMan spec from the 1990's -- cube maps are specified by WebGL (and three.js)
// in a coordinate system in which positive-x is to the right when looking up the positive-z axis -- in other words,
// in a left-handed coordinate system. By continuing this convention, preexisting cube maps continued to render correctly.
// three.js uses a right-handed coordinate system. So environment maps used in three.js appear to have px and nx swapped
// and the flag isRenderTargetTexture controls this conversion. The flip is not required when using WebGLCubeRenderTarget.texture
// as a cube texture (this is detected when isRenderTargetTexture is set to true for cube textures).
this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==e.generateMipmaps&&e.generateMipmaps,this.texture.minFilter=void 0!==e.minFilter?e.minFilter:y}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.encoding=e.encoding,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:/* glsl */"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:/* glsl */"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new _i(5,5,5),r=new bi({name:"CubemapFromEquirect",uniforms:vi(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=e;const s=new gi(n,r),o=e.minFilter;// Avoid blurred poles
e.minFilter===x&&(e.minFilter=y);return new Ti(1,10,this).update(t,s),e.minFilter=o,s.geometry.dispose(),s.material.dispose(),this}clear(t,e,i,n){const r=t.getRenderTarget();for(let s=0;s<6;s++)t.setRenderTarget(this,s),t.clear(e,i,n);t.setRenderTarget(r)}}const Ei=new Tt,Li=new Tt,Ri=new tt;class Oi{constructor(t=new Tt(1,0,0),e=0){this.isPlane=!0,// normal is assumed to be normalized
this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=Ei.subVectors(i,e).cross(Li.subVectors(t,e)).normalize();// Q: should an error be thrown if normal is zero (e.g. degenerate plane)?
return this.setFromNormalAndCoplanarPoint(n,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){// Note: will lead to a divide by zero if the plane is invalid.
const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)}intersectLine(t,e){const i=t.delta(Ei),n=this.normal.dot(i);if(0===n)// line is coplanar, return origin
return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;// Unsure if this is the correct method to handle this case.
const r=-(t.start.dot(this.normal)+this.constant)/n;return r<0||r>1?null:e.copy(i).multiplyScalar(r).add(t.start)}intersectsLine(t){// Note: this tests if a line intersects the plane, not whether it (or its end-points) are coplanar with it.
const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||Ri.getNormalMatrix(t),n=this.coplanarPoint(Ei).applyMatrix4(t),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const Di=new qt,Ii=new Tt;class ki{constructor(t=new Oi,e=new Oi,i=new Oi,n=new Oi,r=new Oi,s=new Oi){this.planes=[t,e,i,n,r,s]}set(t,e,i,n,r,s){const o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(i),o[3].copy(n),o[4].copy(r),o[5].copy(s),this}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t){const e=this.planes,i=t.elements,n=i[0],r=i[1],s=i[2],o=i[3],a=i[4],h=i[5],l=i[6],c=i[7],u=i[8],d=i[9],f=i[10],p=i[11],g=i[12],m=i[13],_=i[14],v=i[15];return e[0].setComponents(o-n,c-a,p-u,v-g).normalize(),e[1].setComponents(o+n,c+a,p+u,v+g).normalize(),e[2].setComponents(o+r,c+h,p+d,v+m).normalize(),e[3].setComponents(o-r,c-h,p-d,v-m).normalize(),e[4].setComponents(o-s,c-l,p-f,v-_).normalize(),e[5].setComponents(o+s,c+l,p+f,v+_).normalize(),this}intersectsObject(t){const e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),Di.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(Di)}intersectsSprite(t){return Di.center.set(0,0,0),Di.radius=.7071067811865476,Di.applyMatrix4(t.matrixWorld),this.intersectsSphere(Di)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let r=0;r<6;r++){if(e[r].distanceToPoint(i)<n)return!1}return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];// corner at max distance
if(Ii.x=n.normal.x>0?t.max.x:t.min.x,Ii.y=n.normal.y>0?t.max.y:t.min.y,Ii.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(Ii)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function zi(){let t=null,e=!1,i=null,n=null;function r(e,s){i(e,s),n=t.requestAnimationFrame(r)}return{start:function(){!0!==e&&null!==i&&(n=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function Ni(t,e){const i=e.isWebGL2,n=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),n.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=n.get(e);i&&(t.deleteBuffer(i.buffer),n.delete(e))},update:function(e,r){if(e.isGLBufferAttribute){const t=n.get(e);return void((!t||t.version<e.version)&&n.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const s=n.get(e);void 0===s?n.set(e,function(e,n){const r=e.array,s=e.usage,o=t.createBuffer();let a;if(t.bindBuffer(n,o),t.bufferData(n,r,s),e.onUploadCallback(),r instanceof Float32Array)a=5126;else if(r instanceof Uint16Array)if(e.isFloat16BufferAttribute){if(!i)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");a=5131}else a=5123;else if(r instanceof Int16Array)a=5122;else if(r instanceof Uint32Array)a=5125;else if(r instanceof Int32Array)a=5124;else if(r instanceof Int8Array)a=5120;else if(r instanceof Uint8Array)a=5121;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);a=5121}return{buffer:o,type:a,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(e,r)):s.version<e.version&&(!function(e,n,r){const s=n.array,o=n.updateRange;t.bindBuffer(r,e),-1===o.count?// Not using update ranges
t.bufferSubData(r,0,s):(i?t.bufferSubData(r,o.offset*s.BYTES_PER_ELEMENT,s,o.offset,o.count):t.bufferSubData(r,o.offset*s.BYTES_PER_ELEMENT,s.subarray(o.offset,o.offset+o.count)),o.count=-1),n.onUploadCallback()}(s.buffer,e,r),s.version=e.version)}}}class Fi extends ei{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const r=t/2,s=e/2,o=Math.floor(i),a=Math.floor(n),h=o+1,l=a+1,c=t/o,u=e/a,d=[],f=[],p=[],g=[];for(let m=0;m<l;m++){const t=m*u-s;for(let e=0;e<h;e++){const i=e*c-r;f.push(i,-t,0),p.push(0,0,1),g.push(e/o),g.push(1-m/a)}}for(let m=0;m<a;m++)for(let t=0;t<o;t++){const e=t+h*m,i=t+h*(m+1),n=t+1+h*(m+1),r=t+1+h*m;d.push(e,i,r),d.push(i,n,r)}this.setIndex(d),this.setAttribute("position",new qe(f,3)),this.setAttribute("normal",new qe(p,3)),this.setAttribute("uv",new qe(g,2))}static fromJSON(t){return new Fi(t.width,t.height,t.widthSegments,t.heightSegments)}}const ji={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\tif ( diffuseColor.a < alphaTest ) discard;\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in float f90, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( V * D );\n}\n#ifdef USE_IRIDESCENCE\n\tvec3 BRDF_GGX_Iridescence( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in float f90, const in float iridescence, const in vec3 iridescenceFresnel, const in float roughness ) {\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = mix( F_Schlick( f0, f90, dotVH ), iridescenceFresnel, iridescence );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\t return vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat R21 = R12;\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = dFdx( surf_pos.xyz );\n\t\tvec3 vSigmaY = dFdy( surf_pos.xyz );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_v0 0.339\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_v1 0.276\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_v4 0.046\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_v5 0.016\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_v6 0.0038\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"vec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP )\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#if defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#if defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in GeometricContext geometry, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in GeometricContext geometry, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#else\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULARINTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vUv ).a;\n\t\t#endif\n\t\t#ifdef USE_SPECULARCOLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vUv ).rgb;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEENCOLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEENROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vUv ).a;\n\t#endif\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n};\nvec3 clearcoatSpecular = vec3( 0.0 );\nvec3 sheenSpecular = vec3( 0.0 );\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecular += ccIrradiance * BRDF_GGX( directLight.direction, geometry.viewDir, geometry.clearcoatNormal, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecular += irradiance * BRDF_Sheen( directLight.direction, geometry.viewDir, geometry.normal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\treflectedLight.directSpecular += irradiance * BRDF_GGX_Iridescence( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness );\n\t#else\n\t\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.roughness );\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecular += clearcoatRadiance * EnvironmentBRDF( geometry.clearcoatNormal, geometry.viewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecular += irradiance * material.sheenColor * IBLSheenBRDF( geometry.normal, geometry.viewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometry.normal, geometry.viewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometry.normal, geometry.viewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef USE_CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometry.viewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometry, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry.normal );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometry.normal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getIBLRadiance( geometry.viewDir, geometry.normal, material.roughness );\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * faceDirection;\n\t\t\tbitangent = bitangent * faceDirection;\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( - vViewPosition, normal, mapN, faceDirection );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );\n\t\treturn normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );\n\t#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",output_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha + 0.1;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n  varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n  uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n  uniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n  varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tuniform int boneTextureSize;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tfloat j = i * 4.0;\n\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\ty = dy * ( y + 0.5 );\n\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\treturn bone;\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmission = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmission.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmission.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\t#ifdef texture2DLodEXT\n\t\t\treturn texture2DLodEXT( transmissionSamplerMap, fragCoord.xy, framebufferLod );\n\t\t#else\n\t\t\treturn texture2D( transmissionSamplerMap, fragCoord.xy, framebufferLod );\n\t\t#endif\n\t}\n\tvec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn radiance;\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance * radiance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );\n\t}\n#endif",uv_pars_fragment:"#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULARINTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n\t#ifdef USE_SPECULARCOLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEENCOLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEENROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n\t#endif\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}"},Bi={common:{diffuse:{value:new pt(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new tt},uv2Transform:{value:new tt},alphaMap:{value:null},alphaTest:{value:0}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},// basic, lambert, phong
ior:{value:1.5},// physical
refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new $(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new pt(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},// TODO (abelnation): RectAreaLight BRDF data needs to be moved from example to main src
rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new pt(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new tt}},sprite:{diffuse:{value:new pt(16777215)},opacity:{value:1},center:{value:new $(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new tt}}},Ui={basic:{uniforms:yi([Bi.common,Bi.specularmap,Bi.envmap,Bi.aomap,Bi.lightmap,Bi.fog]),vertexShader:ji.meshbasic_vert,fragmentShader:ji.meshbasic_frag},lambert:{uniforms:yi([Bi.common,Bi.specularmap,Bi.envmap,Bi.aomap,Bi.lightmap,Bi.emissivemap,Bi.bumpmap,Bi.normalmap,Bi.displacementmap,Bi.fog,Bi.lights,{emissive:{value:new pt(0)}}]),vertexShader:ji.meshlambert_vert,fragmentShader:ji.meshlambert_frag},phong:{uniforms:yi([Bi.common,Bi.specularmap,Bi.envmap,Bi.aomap,Bi.lightmap,Bi.emissivemap,Bi.bumpmap,Bi.normalmap,Bi.displacementmap,Bi.fog,Bi.lights,{emissive:{value:new pt(0)},specular:{value:new pt(1118481)},shininess:{value:30}}]),vertexShader:ji.meshphong_vert,fragmentShader:ji.meshphong_frag},standard:{uniforms:yi([Bi.common,Bi.envmap,Bi.aomap,Bi.lightmap,Bi.emissivemap,Bi.bumpmap,Bi.normalmap,Bi.displacementmap,Bi.roughnessmap,Bi.metalnessmap,Bi.fog,Bi.lights,{emissive:{value:new pt(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:ji.meshphysical_vert,fragmentShader:ji.meshphysical_frag},toon:{uniforms:yi([Bi.common,Bi.aomap,Bi.lightmap,Bi.emissivemap,Bi.bumpmap,Bi.normalmap,Bi.displacementmap,Bi.gradientmap,Bi.fog,Bi.lights,{emissive:{value:new pt(0)}}]),vertexShader:ji.meshtoon_vert,fragmentShader:ji.meshtoon_frag},matcap:{uniforms:yi([Bi.common,Bi.bumpmap,Bi.normalmap,Bi.displacementmap,Bi.fog,{matcap:{value:null}}]),vertexShader:ji.meshmatcap_vert,fragmentShader:ji.meshmatcap_frag},points:{uniforms:yi([Bi.points,Bi.fog]),vertexShader:ji.points_vert,fragmentShader:ji.points_frag},dashed:{uniforms:yi([Bi.common,Bi.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ji.linedashed_vert,fragmentShader:ji.linedashed_frag},depth:{uniforms:yi([Bi.common,Bi.displacementmap]),vertexShader:ji.depth_vert,fragmentShader:ji.depth_frag},normal:{uniforms:yi([Bi.common,Bi.bumpmap,Bi.normalmap,Bi.displacementmap,{opacity:{value:1}}]),vertexShader:ji.meshnormal_vert,fragmentShader:ji.meshnormal_frag},sprite:{uniforms:yi([Bi.sprite,Bi.fog]),vertexShader:ji.sprite_vert,fragmentShader:ji.sprite_frag},background:{uniforms:{uvTransform:{value:new tt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:ji.background_vert,fragmentShader:ji.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:ji.backgroundCube_vert,fragmentShader:ji.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:ji.cube_vert,fragmentShader:ji.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:ji.equirect_vert,fragmentShader:ji.equirect_frag},distanceRGBA:{uniforms:yi([Bi.common,Bi.displacementmap,{referencePosition:{value:new Tt},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:ji.distanceRGBA_vert,fragmentShader:ji.distanceRGBA_frag},shadow:{uniforms:yi([Bi.lights,Bi.fog,{color:{value:new pt(0)},opacity:{value:1}}]),vertexShader:ji.shadow_vert,fragmentShader:ji.shadow_frag}};Ui.physical={uniforms:yi([Ui.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new $(1,1)},clearcoatNormalMap:{value:null},iridescence:{value:0},iridescenceMap:{value:null},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},sheen:{value:0},sheenColor:{value:new pt(0)},sheenColorMap:{value:null},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new $},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationColor:{value:new pt(0)},specularIntensity:{value:1},specularIntensityMap:{value:null},specularColor:{value:new pt(1,1,1)},specularColorMap:{value:null}}]),vertexShader:ji.meshphysical_vert,fragmentShader:ji.meshphysical_frag};const Gi={r:0,b:0,g:0};function Hi(t,e,i,n,r,s,o){const a=new pt(0);let h,l,c=!0===s?0:1,u=null,d=0,p=null;function g(e,i){e.getRGB(Gi,xi(t)),n.buffers.color.setClear(Gi.r,Gi.g,Gi.b,i,o)}return{getClearColor:function(){return a},setClearColor:function(t,e=1){a.set(t),c=e,g(a,c)},getClearAlpha:function(){return c},setClearAlpha:function(t){c=t,g(a,c)},render:function(n,s){let o=!1,m=!0===s.isScene?s.background:null;if(m&&m.isTexture){// use PMREM if the user wants to blur the background
m=(s.backgroundBlurriness>0?i:e).get(m)}// Ignore background in AR
// TODO: Reconsider this.
const _=t.xr,v=_.getSession&&_.getSession();v&&"additive"===v.environmentBlendMode&&(m=null),null===m?g(a,c):m&&m.isColor&&(g(m,1),o=!0),(t.autoClear||o)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),m&&(m.isCubeTexture||m.mapping===f)?(void 0===l&&(l=new gi(new _i(1,1,1),new bi({name:"BackgroundCubeMaterial",uniforms:vi(Ui.backgroundCube.uniforms),vertexShader:Ui.backgroundCube.vertexShader,fragmentShader:Ui.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),l.geometry.deleteAttribute("uv"),l.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},// add "envMap" material property so the renderer can evaluate it like for built-in materials
Object.defineProperty(l.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(l)),l.material.uniforms.envMap.value=m,l.material.uniforms.flipEnvMap.value=m.isCubeTexture&&!1===m.isRenderTargetTexture?-1:1,l.material.uniforms.backgroundBlurriness.value=s.backgroundBlurriness,l.material.uniforms.backgroundIntensity.value=s.backgroundIntensity,l.material.toneMapped=m.encoding!==k,u===m&&d===m.version&&p===t.toneMapping||(l.material.needsUpdate=!0,u=m,d=m.version,p=t.toneMapping),l.layers.enableAll(),// push to the pre-sorted opaque render list
n.unshift(l,l.geometry,l.material,0,0,null)):m&&m.isTexture&&(void 0===h&&(h=new gi(new Fi(2,2),new bi({name:"BackgroundMaterial",uniforms:vi(Ui.background.uniforms),vertexShader:Ui.background.vertexShader,fragmentShader:Ui.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),h.geometry.deleteAttribute("normal"),// add "map" material property so the renderer can evaluate it like for built-in materials
Object.defineProperty(h.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(h)),h.material.uniforms.t2D.value=m,h.material.uniforms.backgroundIntensity.value=s.backgroundIntensity,h.material.toneMapped=m.encoding!==k,!0===m.matrixAutoUpdate&&m.updateMatrix(),h.material.uniforms.uvTransform.value.copy(m.matrix),u===m&&d===m.version&&p===t.toneMapping||(h.material.needsUpdate=!0,u=m,d=m.version,p=t.toneMapping),h.layers.enableAll(),// push to the pre-sorted opaque render list
n.unshift(h,h.geometry,h.material,0,0,null))}}}function Vi(t,e,i,n){const r=t.getParameter(34921),s=n.isWebGL2?null:e.get("OES_vertex_array_object"),o=n.isWebGL2||null!==s,a={},h=f(null);let l=h,c=!1;function u(e){return n.isWebGL2?t.bindVertexArray(e):s.bindVertexArrayOES(e)}function d(e){return n.isWebGL2?t.deleteVertexArray(e):s.deleteVertexArrayOES(e)}function f(t){const e=[],i=[],n=[];for(let s=0;s<r;s++)e[s]=0,i[s]=0,n[s]=0;return{// for backward compatibility on non-VAO support browser
geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:n,object:t,attributes:{},index:null}}function p(){const t=l.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function g(t){m(t,0)}function m(i,r){const s=l.newAttributes,o=l.enabledAttributes,a=l.attributeDivisors;if(s[i]=1,0===o[i]&&(t.enableVertexAttribArray(i),o[i]=1),a[i]!==r){(n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),a[i]=r}}function _(){const e=l.newAttributes,i=l.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==e[n]&&(t.disableVertexAttribArray(n),i[n]=0)}function v(e,i,r,s,o,a){!0!==n.isWebGL2||5124!==r&&5125!==r?t.vertexAttribPointer(e,i,r,s,o,a):t.vertexAttribIPointer(e,i,r,o,a)}function y(){x(),c=!0,l!==h&&(l=h,u(l.object))}// for backward-compatibility
function x(){h.geometry=null,h.program=null,h.wireframe=!1}return{setup:function(r,h,d,y,x){let w=!1;if(o){const e=function(e,i,r){const o=!0===r.wireframe;let h=a[e.id];void 0===h&&(h={},a[e.id]=h);let l=h[i.id];void 0===l&&(l={},h[i.id]=l);let c=l[o];void 0===c&&(c=f(n.isWebGL2?t.createVertexArray():s.createVertexArrayOES()),l[o]=c);return c}(y,d,h);l!==e&&(l=e,u(l.object)),w=function(t,e,i,n){const r=l.attributes,s=e.attributes;let o=0;const a=i.getAttributes();for(const h in a){if(a[h].location>=0){const e=r[h];let i=s[h];if(void 0===i&&("instanceMatrix"===h&&t.instanceMatrix&&(i=t.instanceMatrix),"instanceColor"===h&&t.instanceColor&&(i=t.instanceColor)),void 0===e)return!0;if(e.attribute!==i)return!0;if(i&&e.data!==i.data)return!0;o++}}return l.attributesNum!==o||l.index!==n}(r,y,d,x),w&&function(t,e,i,n){const r={},s=e.attributes;let o=0;const a=i.getAttributes();for(const h in a){if(a[h].location>=0){let e=s[h];void 0===e&&("instanceMatrix"===h&&t.instanceMatrix&&(e=t.instanceMatrix),"instanceColor"===h&&t.instanceColor&&(e=t.instanceColor));const i={};i.attribute=e,e&&e.data&&(i.data=e.data),r[h]=i,o++}}l.attributes=r,l.attributesNum=o,l.index=n}(r,y,d,x)}else{const t=!0===h.wireframe;l.geometry===y.id&&l.program===d.id&&l.wireframe===t||(l.geometry=y.id,l.program=d.id,l.wireframe=t,w=!0)}null!==x&&i.update(x,34963),(w||c)&&(c=!1,function(r,s,o,a){if(!1===n.isWebGL2&&(r.isInstancedMesh||a.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;p();const h=a.attributes,l=o.getAttributes(),c=s.defaultAttributeValues;for(const e in l){const n=l[e];if(n.location>=0){let s=h[e];if(void 0===s&&("instanceMatrix"===e&&r.instanceMatrix&&(s=r.instanceMatrix),"instanceColor"===e&&r.instanceColor&&(s=r.instanceColor)),void 0!==s){const e=s.normalized,o=s.itemSize,h=i.get(s);// TODO Attribute may not be available on context restore
if(void 0===h)continue;const l=h.buffer,c=h.type,u=h.bytesPerElement;if(s.isInterleavedBufferAttribute){const i=s.data,h=i.stride,d=s.offset;if(i.isInstancedInterleavedBuffer){for(let t=0;t<n.locationSize;t++)m(n.location+t,i.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let t=0;t<n.locationSize;t++)g(n.location+t);t.bindBuffer(34962,l);for(let t=0;t<n.locationSize;t++)v(n.location+t,o/n.locationSize,c,e,h*u,(d+o/n.locationSize*t)*u)}else{if(s.isInstancedBufferAttribute){for(let t=0;t<n.locationSize;t++)m(n.location+t,s.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=s.meshPerAttribute*s.count)}else for(let t=0;t<n.locationSize;t++)g(n.location+t);t.bindBuffer(34962,l);for(let t=0;t<n.locationSize;t++)v(n.location+t,o/n.locationSize,c,e,o*u,o/n.locationSize*t*u)}}else if(void 0!==c){const i=c[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(n.location,i);break;case 3:t.vertexAttrib3fv(n.location,i);break;case 4:t.vertexAttrib4fv(n.location,i);break;default:t.vertexAttrib1fv(n.location,i)}}}}_()}(r,h,d,y),null!==x&&t.bindBuffer(34963,i.get(x).buffer))},reset:y,resetDefaultState:x,dispose:function(){y();for(const t in a){const e=a[t];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete a[t]}},releaseStatesOfGeometry:function(t){if(void 0===a[t.id])return;const e=a[t.id];for(const i in e){const t=e[i];for(const e in t)d(t[e].object),delete t[e];delete e[i]}delete a[t.id]},releaseStatesOfProgram:function(t){for(const e in a){const i=a[e];if(void 0===i[t.id])continue;const n=i[t.id];for(const t in n)d(n[t].object),delete n[t];delete i[t.id]}},initAttributes:p,enableAttribute:g,disableUnusedAttributes:_}}function Wi(t,e,i,n){const r=n.isWebGL2;let s;this.setMode=function(t){s=t},this.render=function(e,n){t.drawArrays(s,e,n),i.update(n,s,1)},this.renderInstances=function(n,o,a){if(0===a)return;let h,l;if(r)h=t,l="drawArraysInstanced";else if(h=e.get("ANGLE_instanced_arrays"),l="drawArraysInstancedANGLE",null===h)return;h[l](s,n,o,a),i.update(o,s,a)}}function Zi(t,e,i){let n;function r(e){if("highp"===e){if(t.getShaderPrecisionFormat(35633,36338).precision>0&&t.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(35633,36337).precision>0&&t.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext;let o=void 0!==i.precision?i.precision:"highp";const a=r(o);a!==o&&(o=a);const h=s||e.has("WEBGL_draw_buffers"),l=!0===i.logarithmicDepthBuffer,c=t.getParameter(34930),u=t.getParameter(35660),d=t.getParameter(3379),f=t.getParameter(34076),p=t.getParameter(34921),g=t.getParameter(36347),m=t.getParameter(36348),_=t.getParameter(36349),v=u>0,y=s||e.has("OES_texture_float");return{isWebGL2:s,drawBuffers:h,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===e.has("EXT_texture_filter_anisotropic")){const i=e.get("EXT_texture_filter_anisotropic");n=t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:r,precision:o,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:u,maxTextureSize:d,maxCubemapSize:f,maxAttributes:p,maxVertexUniforms:g,maxVaryings:m,maxFragmentUniforms:_,vertexTextures:v,floatFragmentTextures:y,floatVertexTextures:v&&y,maxSamples:s?t.getParameter(36183):0}}function qi(t){const e=this;let i=null,n=0,r=!1,s=!1;const o=new Oi,a=new tt,h={value:null,needsUpdate:!1};function l(t,i,n,r){const s=null!==t?t.length:0;let l=null;if(0!==s){if(l=h.value,!0!==r||null===l){const e=n+4*s,r=i.matrixWorldInverse;a.getNormalMatrix(r),(null===l||l.length<e)&&(l=new Float32Array(e));for(let i=0,h=n;i!==s;++i,h+=4)o.copy(t[i]).applyMatrix4(r,a),o.normal.toArray(l,h),l[h+3]=o.constant}h.value=l,h.needsUpdate=!0}return e.numPlanes=s,e.numIntersection=0,l}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e){const i=0!==t.length||e||// enable state of previous frame - the clipping code has to
// run another frame in order to reset the state:
0!==n||r;return r=e,n=t.length,i},this.beginShadows=function(){s=!0,l(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(t,e){i=l(t,e,0)},this.setState=function(o,a,c){const u=o.clippingPlanes,d=o.clipIntersection,f=o.clipShadows,p=t.get(o);if(!r||null===u||0===u.length||s&&!f)// there's no local clipping
s?// there's no global clipping
l(null):function(){h.value!==i&&(h.value=i,h.needsUpdate=n>0);e.numPlanes=n,e.numIntersection=0}();else{const t=s?0:n,e=4*t;let r=p.clippingState||null;h.value=r,// ensure unique state
r=l(u,a,e,c);for(let n=0;n!==e;++n)r[n]=i[n];p.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}function Xi(t){let e=new WeakMap;function i(t,e){return 303===e?t.mapping=u:304===e&&(t.mapping=d),t}function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture&&!1===r.isRenderTargetTexture){const s=r.mapping;if(303===s||304===s){if(e.has(r)){return i(e.get(r).texture,r.mapping)}{const s=r.image;if(s&&s.height>0){const o=new Ai(s.height/2);return o.fromEquirectangularTexture(t,r),e.set(r,o),r.addEventListener("dispose",n),i(o.texture,r.mapping)}// image not yet ready. try the conversion next frame
return null}}}return r},dispose:function(){e=new WeakMap}}}class Ji extends Mi{constructor(t=-1,e=1,i=1,n=-1,r=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=n,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,i,n,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-t,s=i+t,o=n+e,a=n-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,s=r+t*this.view.width,o-=e*this.view.offsetY,a=o-e*this.view.height}this.projectionMatrix.makeOrthographic(r,s,o,a,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}const Yi=[.125,.215,.35,.446,.526,.582],Qi=20,Ki=new Ji,$i=new pt;// The standard deviations (radians) associated with the extra mips. These are
// chosen to approximate a Trowbridge-Reitz distribution function times the
// geometric shadowing function. These sigma values squared must match the
// variance #defines in cube_uv_reflection_fragment.glsl.js.
let tn=null;// Golden Ratio
const en=(1+Math.sqrt(5))/2,nn=1/en,rn=[new Tt(1,1,1),new Tt(-1,1,1),new Tt(1,1,-1),new Tt(-1,1,-1),new Tt(0,en,nn),new Tt(0,en,-nn),new Tt(nn,0,en),new Tt(-nn,0,en),new Tt(en,nn,0),new Tt(-en,nn,0)];
/**
			 * This class generates a Prefiltered, Mipmapped Radiance Environment Map
			 * (PMREM) from a cubeMap environment texture. This allows different levels of
			 * blur to be quickly accessed based on material roughness. It is packed into a
			 * special CubeUV format that allows us to perform custom interpolation so that
			 * we can support nonlinear formats such as RGBE. Unlike a traditional mipmap
			 * chain, it only goes down to the LOD_MIN level (above), and then creates extra
			 * even more filtered 'mips' at the same LOD_MIN resolution, associated with
			 * higher roughness levels. In this way we maintain resolution to smoothly
			 * interpolate diffuse lighting while limiting sampling computation.
			 *
			 * Paper: Fast, Accurate Image-Based Lighting
			 * https://drive.google.com/file/d/15y8r_UpKlU9SvV4ILb0C3qCPecS8pvLz/view
			*/
class sn{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}
/**
				 * Generates a PMREM from a supplied Scene, which can be faster than using an
				 * image if networking bandwidth is low. Optional sigma specifies a blur radius
				 * in radians to be applied to the scene before PMREM generation. Optional near
				 * and far planes ensure the scene is rendered in its entirety (the cubeCamera
				 * is placed at the origin).
				 */fromScene(t,e=0,i=.1,n=100){tn=this._renderer.getRenderTarget(),this._setSize(256);const r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(t,i,n,r),e>0&&this._blur(r,0,0,e),this._applyPMREM(r),this._cleanup(r),r}
/**
				 * Generates a PMREM from an equirectangular texture, which can be either LDR
				 * or HDR. The ideal input image size is 1k (1024 x 512),
				 * as this matches best with the 256 x 256 cubemap output.
				 */fromEquirectangular(t,e=null){return this._fromTexture(t,e)}
/**
				 * Generates a PMREM from an cubemap texture, which can be either LDR
				 * or HDR. The ideal input cube size is 256 x 256,
				 * as this matches best with the 256 x 256 cubemap output.
				 */fromCubemap(t,e=null){return this._fromTexture(t,e)}
/**
				 * Pre-compiles the cubemap shader. You can get faster start-up by invoking this method during
				 * your texture's network fetch for increased concurrency.
				 */compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=ln(),this._compileMaterial(this._cubemapMaterial))}
/**
				 * Pre-compiles the equirectangular shader. You can get faster start-up by invoking this method during
				 * your texture's network fetch for increased concurrency.
				 */compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=hn(),this._compileMaterial(this._equirectMaterial))}
/**
				 * Disposes of the PMREMGenerator's internal memory. Note that PMREMGenerator is a static class,
				 * so you should not need more than one PMREMGenerator object. If you do, calling dispose() on
				 * one of them will cause any others to also become unusable.
				 */dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}// private interface
_setSize(t){this._lodMax=Math.floor(Math.log2(t)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let t=0;t<this._lodPlanes.length;t++)this._lodPlanes[t].dispose()}_cleanup(t){this._renderer.setRenderTarget(tn),t.scissorTest=!1,an(t,0,0,t.width,t.height)}_fromTexture(t,e){t.mapping===u||t.mapping===d?this._setSize(0===t.image.length?16:t.image[0].width||t.image[0].image.width):// Equirectangular
this._setSize(t.image.width/4),tn=this._renderer.getRenderTarget();const i=e||this._allocateTargets();return this._textureToCubeUV(t,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const t=3*Math.max(this._cubeSize,112),e=4*this._cubeSize,i={magFilter:y,minFilter:y,generateMipmaps:!1,type:S,format:T,encoding:I,depthBuffer:!1},n=on(t,e,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==t||this._pingPongRenderTarget.height!==e){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=on(t,e,i);const{_lodMax:n}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(t){const e=[],i=[],n=[];let r=t;const s=t-4+1+Yi.length;for(let o=0;o<s;o++){const s=Math.pow(2,r);i.push(s);let a=1/s;o>t-4?a=Yi[o-t+4-1]:0===o&&(a=0),n.push(a);const h=1/(s-2),l=-h,c=1+h,u=[l,l,c,l,c,c,l,l,c,c,l,c],d=6,f=6,p=3,g=2,m=1,_=new Float32Array(p*f*d),v=new Float32Array(g*f*d),y=new Float32Array(m*f*d);for(let t=0;t<d;t++){const e=t%3*2/3-1,i=t>2?0:-1,n=[e,i,0,e+2/3,i,0,e+2/3,i+1,0,e,i,0,e+2/3,i+1,0,e,i+1,0];_.set(n,p*f*t),v.set(u,g*f*t);const r=[t,t,t,t,t,t];y.set(r,m*f*t)}const x=new ei;x.setAttribute("position",new Ve(_,p)),x.setAttribute("uv",new Ve(v,g)),x.setAttribute("faceIndex",new Ve(y,m)),e.push(x),r>4&&r--}return{lodPlanes:e,sizeLods:i,sigmas:n}}(n)),this._blurMaterial=function(t,e,i){const n=new Float32Array(Qi),r=new Tt(0,1,0),s=new bi({name:"SphericalGaussianBlur",defines:{n:Qi,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${t}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:n},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:cn(),fragmentShader:/* glsl */"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return s}(n,t,e)}return n}_compileMaterial(t){const e=new gi(this._lodPlanes[0],t);this._renderer.compile(e,Ki)}_sceneToCubeUV(t,e,i,n){const r=new Si(90,1,e,i),s=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],a=this._renderer,h=a.autoClear,l=a.toneMapping;a.getClearColor($i),a.toneMapping=0,a.autoClear=!1;const c=new Ue({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),u=new gi(new _i,c);let d=!1;const f=t.background;f?f.isColor&&(c.color.copy(f),t.background=null,d=!0):(c.color.copy($i),d=!0);for(let p=0;p<6;p++){const e=p%3;0===e?(r.up.set(0,s[p],0),r.lookAt(o[p],0,0)):1===e?(r.up.set(0,0,s[p]),r.lookAt(0,o[p],0)):(r.up.set(0,s[p],0),r.lookAt(0,0,o[p]));const i=this._cubeSize;an(n,e*i,p>2?i:0,i,i),a.setRenderTarget(n),d&&a.render(u,r),a.render(t,r)}u.geometry.dispose(),u.material.dispose(),a.toneMapping=l,a.autoClear=h,t.background=f}_textureToCubeUV(t,e){const i=this._renderer,n=t.mapping===u||t.mapping===d;n?(null===this._cubemapMaterial&&(this._cubemapMaterial=ln()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===t.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=hn());const r=n?this._cubemapMaterial:this._equirectMaterial,s=new gi(this._lodPlanes[0],r);r.uniforms.envMap.value=t;const o=this._cubeSize;an(e,0,0,3*o,2*o),i.setRenderTarget(e),i.render(s,Ki)}_applyPMREM(t){const e=this._renderer,i=e.autoClear;e.autoClear=!1;for(let n=1;n<this._lodPlanes.length;n++){const e=Math.sqrt(this._sigmas[n]*this._sigmas[n]-this._sigmas[n-1]*this._sigmas[n-1]),i=rn[(n-1)%rn.length];this._blur(t,n-1,n,e,i)}e.autoClear=i}
/**
				 * This is a two-pass Gaussian blur for a cubemap. Normally this is done
				 * vertically and horizontally, but this breaks down on a cube. Here we apply
				 * the blur latitudinally (around the poles), and then longitudinally (towards
				 * the poles) to approximate the orthogonally-separable blur. It is least
				 * accurate at the poles, but still does a decent job.
				 */_blur(t,e,i,n,r){const s=this._pingPongRenderTarget;this._halfBlur(t,s,e,i,n,"latitudinal",r),this._halfBlur(s,t,i,i,n,"longitudinal",r)}_halfBlur(t,e,i,n,r,s,o){const a=this._renderer,h=this._blurMaterial,l=new gi(this._lodPlanes[n],h),c=h.uniforms,u=this._sizeLods[i]-1,d=isFinite(r)?Math.PI/(2*u):2*Math.PI/39,f=r/d,p=isFinite(r)?1+Math.floor(3*f):Qi,g=[];let m=0;for(let y=0;y<Qi;++y){const t=y/f,e=Math.exp(-t*t/2);g.push(e),0===y?m+=e:y<p&&(m+=2*e)}for(let y=0;y<g.length;y++)g[y]=g[y]/m;c.envMap.value=t.texture,c.samples.value=p,c.weights.value=g,c.latitudinal.value="latitudinal"===s,o&&(c.poleAxis.value=o);const{_lodMax:_}=this;c.dTheta.value=d,c.mipInt.value=_-i;const v=this._sizeLods[n];an(e,3*v*(n>_-4?n-_+4:0),4*(this._cubeSize-v),3*v,2*v),a.setRenderTarget(e),a.render(l,Ki)}}function on(t,e,i){const n=new bt(t,e,i);return n.texture.mapping=f,n.texture.name="PMREM.cubeUv",n.scissorTest=!0,n}function an(t,e,i,n,r){t.viewport.set(e,i,n,r),t.scissor.set(e,i,n,r)}function hn(){return new bi({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:cn(),fragmentShader:/* glsl */"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function ln(){return new bi({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:cn(),fragmentShader:/* glsl */"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function cn(){/* glsl */return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function un(t){let e=new WeakMap,i=null;function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping,o=303===s||304===s,a=s===u||s===d;// equirect/cube map to cubeUV conversion
if(o||a){if(r.isRenderTargetTexture&&!0===r.needsPMREMUpdate){r.needsPMREMUpdate=!1;let n=e.get(r);return null===i&&(i=new sn(t)),n=o?i.fromEquirectangular(r,n):i.fromCubemap(r,n),e.set(r,n),n.texture}if(e.has(r))return e.get(r).texture;{const s=r.image;if(o&&s&&s.height>0||a&&s&&function(t){let e=0;const i=6;for(let n=0;n<i;n++)void 0!==t[n]&&e++;return e===i}(s)){null===i&&(i=new sn(t));const s=o?i.fromEquirectangular(r):i.fromCubemap(r);return e.set(r,s),r.addEventListener("dispose",n),s.texture}// image not yet ready. try the conversion next frame
return null}}}return r},dispose:function(){e=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function dn(t){const e={};function i(i){if(void 0!==e[i])return e[i];let n;switch(i){case"WEBGL_depth_texture":n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return e[i]=n,n}return{has:function(t){return null!==i(t)},init:function(t){t.isWebGL2?i("EXT_color_buffer_float"):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture")},get:function(t){const e=i(t);return e}}}function fn(t,e,i,n){const r={},s=new WeakMap;function o(t){const a=t.target;null!==a.index&&e.remove(a.index);for(const i in a.attributes)e.remove(a.attributes[i]);a.removeEventListener("dispose",o),delete r[a.id];const h=s.get(a);h&&(e.remove(h),s.delete(a)),n.releaseStatesOfGeometry(a),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,i.memory.geometries--}function a(t){const i=[],n=t.index,r=t.attributes.position;let o=0;if(null!==n){const t=n.array;o=n.version;for(let e=0,n=t.length;e<n;e+=3){const n=t[e+0],r=t[e+1],s=t[e+2];i.push(n,r,r,s,s,n)}}else{const t=r.array;o=r.version;for(let e=0,n=t.length/3-1;e<n;e+=3){const t=e+0,n=e+1,r=e+2;i.push(t,n,n,r,r,t)}}const a=new(it(i)?Ze:We)(i,1);a.version=o;// Updating index buffer in VAO now. See WebGLBindingStates
const h=s.get(t);h&&e.remove(h),s.set(t,a)}return{get:function(t,e){return!0===r[e.id]||(e.addEventListener("dispose",o),r[e.id]=!0,i.memory.geometries++),e},update:function(t){const i=t.attributes;// Updating index buffer in VAO now. See WebGLBindingStates.
for(const r in i)e.update(i[r],34962);// morph targets
const n=t.morphAttributes;for(const r in n){const t=n[r];for(let i=0,n=t.length;i<n;i++)e.update(t[i],34962)}},getWireframeAttribute:function(t){const e=s.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&a(t)}else a(t);return s.get(t)}}}function pn(t,e,i,n){const r=n.isWebGL2;let s,o,a;this.setMode=function(t){s=t},this.setIndex=function(t){o=t.type,a=t.bytesPerElement},this.render=function(e,n){t.drawElements(s,n,o,e*a),i.update(n,s,1)},this.renderInstances=function(n,h,l){if(0===l)return;let c,u;if(r)c=t,u="drawElementsInstanced";else if(c=e.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===c)return;c[u](s,h,o,n*a,l),i.update(h,s,l)}}function gn(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(t,i,n){switch(e.calls++,i){case 4:e.triangles+=n*(t/3);break;case 1:e.lines+=n*(t/2);break;case 3:e.lines+=n*(t-1);break;case 2:e.lines+=n*t;break;case 0:e.points+=n*t}}}}function mn(t,e){return t[0]-e[0]}function _n(t,e){return Math.abs(e[1])-Math.abs(t[1])}function vn(t,e,i){const n={},r=new Float32Array(8),s=new WeakMap,o=new wt,a=[];for(let h=0;h<8;h++)a[h]=[h,0];return{update:function(h,l,c,u){const d=h.morphTargetInfluences;if(!0===e.isWebGL2){// instead of using attributes, the WebGL 2 code path encodes morph targets
// into an array of data textures. Each layer represents a single morph target.
const f=l.morphAttributes.position||l.morphAttributes.normal||l.morphAttributes.color,p=void 0!==f?f.length:0;let g=s.get(l);if(void 0===g||g.count!==p){void 0!==g&&g.texture.dispose();const v=void 0!==l.morphAttributes.position,y=void 0!==l.morphAttributes.normal,x=void 0!==l.morphAttributes.color,w=l.morphAttributes.position||[],b=l.morphAttributes.normal||[],S=l.morphAttributes.color||[];let C=0;!0===v&&(C=1),!0===y&&(C=2),!0===x&&(C=3);let T=l.attributes.position.count*C,P=1;T>e.maxTextureSize&&(P=Math.ceil(T/e.maxTextureSize),T=e.maxTextureSize);const A=new Float32Array(T*P*4*p),E=new Mt(A,T,P,p);E.type=M,E.needsUpdate=!0;// fill buffer
const L=4*C;for(let O=0;O<p;O++){const D=w[O],I=b[O],k=S[O],z=T*P*4*O;for(let N=0;N<D.count;N++){const F=N*L;!0===v&&(o.fromBufferAttribute(D,N),A[z+F+0]=o.x,A[z+F+1]=o.y,A[z+F+2]=o.z,A[z+F+3]=0),!0===y&&(o.fromBufferAttribute(I,N),A[z+F+4]=o.x,A[z+F+5]=o.y,A[z+F+6]=o.z,A[z+F+7]=0),!0===x&&(o.fromBufferAttribute(k,N),A[z+F+8]=o.x,A[z+F+9]=o.y,A[z+F+10]=o.z,A[z+F+11]=4===k.itemSize?o.w:1)}}function R(){E.dispose(),s.delete(l),l.removeEventListener("dispose",R)}g={count:p,texture:E,size:new $(T,P)},s.set(l,g),l.addEventListener("dispose",R)}
let m=0;for(let j=0;j<d.length;j++)m+=d[j];const _=l.morphTargetsRelative?1:1-m;u.getUniforms().setValue(t,"morphTargetBaseInfluence",_),u.getUniforms().setValue(t,"morphTargetInfluences",d),u.getUniforms().setValue(t,"morphTargetsTexture",g.texture,i),u.getUniforms().setValue(t,"morphTargetsTextureSize",g.size)}else{// When object doesn't have morph target influences defined, we treat it as a 0-length array
// This is important to make sure we set up morphTargetBaseInfluence / morphTargetInfluences
const B=void 0===d?0:d.length;let U=n[l.id];if(void 0===U||U.length!==B){// initialise list
U=[];for(let Z=0;Z<B;Z++)U[Z]=[Z,0];n[l.id]=U}// Collect influences
for(let q=0;q<B;q++){const X=U[q];X[0]=q,X[1]=d[q]}U.sort(_n);for(let J=0;J<8;J++)J<B&&U[J][1]?(a[J][0]=U[J][0],a[J][1]=U[J][1]):(a[J][0]=Number.MAX_SAFE_INTEGER,a[J][1]=0);a.sort(mn);const G=l.morphAttributes.position,H=l.morphAttributes.normal;let V=0;for(let Y=0;Y<8;Y++){const Q=a[Y],K=Q[0],tt=Q[1];K!==Number.MAX_SAFE_INTEGER&&tt?(G&&l.getAttribute("morphTarget"+Y)!==G[K]&&l.setAttribute("morphTarget"+Y,G[K]),H&&l.getAttribute("morphNormal"+Y)!==H[K]&&l.setAttribute("morphNormal"+Y,H[K]),r[Y]=tt,V+=tt):(G&&!0===l.hasAttribute("morphTarget"+Y)&&l.deleteAttribute("morphTarget"+Y),H&&!0===l.hasAttribute("morphNormal"+Y)&&l.deleteAttribute("morphNormal"+Y),r[Y]=0)}// GLSL shader uses formula baseinfluence * base + sum(target * influence)
// This allows us to switch between absolute morphs and relative morphs without changing shader code
// When baseinfluence = 1 - sum(influence), the above is equivalent to sum((target - base) * influence)
const W=l.morphTargetsRelative?1:1-V;u.getUniforms().setValue(t,"morphTargetBaseInfluence",W),u.getUniforms().setValue(t,"morphTargetInfluences",r)}}}}function yn(t,e,i,n){let r=new WeakMap;function s(t){const e=t.target;e.removeEventListener("dispose",s),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(t){const o=n.render.frame,a=t.geometry,h=e.get(t,a);// Update once per frame
return r.get(h)!==o&&(e.update(h),r.set(h,o)),t.isInstancedMesh&&(!1===t.hasEventListener("dispose",s)&&t.addEventListener("dispose",s),i.update(t.instanceMatrix,34962),null!==t.instanceColor&&i.update(t.instanceColor,34962)),h},dispose:function(){r=new WeakMap}}}
/**
			 * Uniforms of a program.
			 * Those form a tree structure with a special top-level container for the root,
			 * which you get by calling 'new WebGLUniforms( gl, program )'.
			 *
			 *
			 * Properties of inner nodes including the top-level container:
			 *
			 * .seq - array of nested uniforms
			 * .map - nested uniforms by name
			 *
			 *
			 * Methods of all nodes except the top-level container:
			 *
			 * .setValue( gl, value, [textures] )
			 *
			 * 		uploads a uniform value(s)
			 *  	the 'textures' parameter is needed for sampler uniforms
			 *
			 *
			 * Static methods of the top-level container (textures factorizations):
			 *
			 * .upload( gl, seq, values, textures )
			 *
			 * 		sets uniforms in 'seq' to 'values[id].value'
			 *
			 * .seqWithValue( seq, values ) : filteredSeq
			 *
			 * 		filters 'seq' entries with corresponding entry in values
			 *
			 *
			 * Methods of the top-level container (textures factorizations):
			 *
			 * .setValue( gl, name, value, textures )
			 *
			 * 		sets uniform with  name 'name' to 'value'
			 *
			 * .setOptional( gl, obj, prop )
			 *
			 * 		like .set for an optional property of the object
			 *
			 */const xn=new xt,wn=new Mt,bn=new St,Mn=new Pi,Sn=[],Cn=[],Tn=new Float32Array(16),Pn=new Float32Array(9),An=new Float32Array(4);// Flattening for arrays of vectors and matrices
function En(t,e,i){const n=t[0];if(n<=0||n>0)return t;// unoptimized: ! isNaN( firstElem )
// see http://jacksondunstan.com/articles/983
const r=e*i;let s=Sn[r];if(void 0===s&&(s=new Float32Array(r),Sn[r]=s),0!==e){n.toArray(s,0);for(let n=1,r=0;n!==e;++n)r+=i,t[n].toArray(s,r)}return s}function Ln(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function Rn(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}// Texture unit allocation
function On(t,e){let i=Cn[e];void 0===i&&(i=new Int32Array(e),Cn[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}// --- Setters ---
// Note: Defining these methods externally, because they come in a bunch
// and this way their names minify.
// Single scalar
function Dn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}// Single float vector (from flat array or THREE.VectorN)
function In(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Ln(i,e))return;t.uniform2fv(this.addr,e),Rn(i,e)}}function kn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(Ln(i,e))return;t.uniform3fv(this.addr,e),Rn(i,e)}}function zn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Ln(i,e))return;t.uniform4fv(this.addr,e),Rn(i,e)}}// Single matrix (from flat array or THREE.MatrixN)
function Nn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Ln(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),Rn(i,e)}else{if(Ln(i,n))return;An.set(n),t.uniformMatrix2fv(this.addr,!1,An),Rn(i,n)}}function Fn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Ln(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),Rn(i,e)}else{if(Ln(i,n))return;Pn.set(n),t.uniformMatrix3fv(this.addr,!1,Pn),Rn(i,n)}}function jn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Ln(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),Rn(i,e)}else{if(Ln(i,n))return;Tn.set(n),t.uniformMatrix4fv(this.addr,!1,Tn),Rn(i,n)}}// Single integer / boolean
function Bn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}// Single integer / boolean vector (from flat array or THREE.VectorN)
function Un(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2i(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Ln(i,e))return;t.uniform2iv(this.addr,e),Rn(i,e)}}function Gn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3i(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(Ln(i,e))return;t.uniform3iv(this.addr,e),Rn(i,e)}}function Hn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4i(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Ln(i,e))return;t.uniform4iv(this.addr,e),Rn(i,e)}}// Single unsigned integer
function Vn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}// Single unsigned integer vector (from flat array or THREE.VectorN)
function Wn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2ui(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Ln(i,e))return;t.uniform2uiv(this.addr,e),Rn(i,e)}}function Zn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3ui(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(Ln(i,e))return;t.uniform3uiv(this.addr,e),Rn(i,e)}}function qn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4ui(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Ln(i,e))return;t.uniform4uiv(this.addr,e),Rn(i,e)}}// Single texture (2D / Cube)
function Xn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2D(e||xn,r)}function Jn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(e||bn,r)}function Yn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTextureCube(e||Mn,r)}function Qn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(e||wn,r)}// Helper to pick the right setter for the singular case
// Array of scalars
function Kn(t,e){t.uniform1fv(this.addr,e)}// Array of vectors (from flat array or array of THREE.VectorN)
function $n(t,e){const i=En(e,this.size,2);t.uniform2fv(this.addr,i)}function tr(t,e){const i=En(e,this.size,3);t.uniform3fv(this.addr,i)}function er(t,e){const i=En(e,this.size,4);t.uniform4fv(this.addr,i)}// Array of matrices (from flat array or array of THREE.MatrixN)
function ir(t,e){const i=En(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function nr(t,e){const i=En(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function rr(t,e){const i=En(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}// Array of integer / boolean
function sr(t,e){t.uniform1iv(this.addr,e)}// Array of integer / boolean vectors (from flat array)
function or(t,e){t.uniform2iv(this.addr,e)}function ar(t,e){t.uniform3iv(this.addr,e)}function hr(t,e){t.uniform4iv(this.addr,e)}// Array of unsigned integer
function lr(t,e){t.uniform1uiv(this.addr,e)}// Array of unsigned integer vectors (from flat array)
function cr(t,e){t.uniform2uiv(this.addr,e)}function ur(t,e){t.uniform3uiv(this.addr,e)}function dr(t,e){t.uniform4uiv(this.addr,e)}// Array of textures (2D / 3D / Cube / 2DArray)
function fr(t,e,i){const n=this.cache,r=e.length,s=On(i,r);Ln(n,s)||(t.uniform1iv(this.addr,s),Rn(n,s));for(let o=0;o!==r;++o)i.setTexture2D(e[o]||xn,s[o])}function pr(t,e,i){const n=this.cache,r=e.length,s=On(i,r);Ln(n,s)||(t.uniform1iv(this.addr,s),Rn(n,s));for(let o=0;o!==r;++o)i.setTexture3D(e[o]||bn,s[o])}function gr(t,e,i){const n=this.cache,r=e.length,s=On(i,r);Ln(n,s)||(t.uniform1iv(this.addr,s),Rn(n,s));for(let o=0;o!==r;++o)i.setTextureCube(e[o]||Mn,s[o])}function mr(t,e,i){const n=this.cache,r=e.length,s=On(i,r);Ln(n,s)||(t.uniform1iv(this.addr,s),Rn(n,s));for(let o=0;o!==r;++o)i.setTexture2DArray(e[o]||wn,s[o])}// Helper to pick the right setter for a pure (bottom-level) array
// --- Uniform Classes ---
class _r{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return Dn;// FLOAT
case 35664:return In;// _VEC2
case 35665:return kn;// _VEC3
case 35666:return zn;// _VEC4
case 35674:return Nn;// _MAT2
case 35675:return Fn;// _MAT3
case 35676:return jn;// _MAT4
case 5124:case 35670:return Bn;// INT, BOOL
case 35667:case 35671:return Un;// _VEC2
case 35668:case 35672:return Gn;// _VEC3
case 35669:case 35673:return Hn;// _VEC4
case 5125:return Vn;// UINT
case 36294:return Wn;// _VEC2
case 36295:return Zn;// _VEC3
case 36296:return qn;// _VEC4
case 35678:// SAMPLER_2D
case 36198:// SAMPLER_EXTERNAL_OES
case 36298:// INT_SAMPLER_2D
case 36306:// UNSIGNED_INT_SAMPLER_2D
case 35682:// SAMPLER_2D_SHADOW
return Xn;case 35679:// SAMPLER_3D
case 36299:// INT_SAMPLER_3D
case 36307:// UNSIGNED_INT_SAMPLER_3D
return Jn;case 35680:// SAMPLER_CUBE
case 36300:// INT_SAMPLER_CUBE
case 36308:// UNSIGNED_INT_SAMPLER_CUBE
case 36293:// SAMPLER_CUBE_SHADOW
return Yn;case 36289:// SAMPLER_2D_ARRAY
case 36303:// INT_SAMPLER_2D_ARRAY
case 36311:// UNSIGNED_INT_SAMPLER_2D_ARRAY
case 36292:// SAMPLER_2D_ARRAY_SHADOW
return Qn}}(e.type)}}class vr{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return Kn;// FLOAT
case 35664:return $n;// _VEC2
case 35665:return tr;// _VEC3
case 35666:return er;// _VEC4
case 35674:return ir;// _MAT2
case 35675:return nr;// _MAT3
case 35676:return rr;// _MAT4
case 5124:case 35670:return sr;// INT, BOOL
case 35667:case 35671:return or;// _VEC2
case 35668:case 35672:return ar;// _VEC3
case 35669:case 35673:return hr;// _VEC4
case 5125:return lr;// UINT
case 36294:return cr;// _VEC2
case 36295:return ur;// _VEC3
case 36296:return dr;// _VEC4
case 35678:// SAMPLER_2D
case 36198:// SAMPLER_EXTERNAL_OES
case 36298:// INT_SAMPLER_2D
case 36306:// UNSIGNED_INT_SAMPLER_2D
case 35682:// SAMPLER_2D_SHADOW
return fr;case 35679:// SAMPLER_3D
case 36299:// INT_SAMPLER_3D
case 36307:// UNSIGNED_INT_SAMPLER_3D
return pr;case 35680:// SAMPLER_CUBE
case 36300:// INT_SAMPLER_CUBE
case 36308:// UNSIGNED_INT_SAMPLER_CUBE
case 36293:// SAMPLER_CUBE_SHADOW
return gr;case 36289:// SAMPLER_2D_ARRAY
case 36303:// INT_SAMPLER_2D_ARRAY
case 36311:// UNSIGNED_INT_SAMPLER_2D_ARRAY
case 36292:// SAMPLER_2D_ARRAY_SHADOW
return mr}}(e.type)}}class yr{constructor(t){this.id=t,this.seq=[],this.map={}}setValue(t,e,i){const n=this.seq;for(let r=0,s=n.length;r!==s;++r){const s=n[r];s.setValue(t,e[s.id],i)}}}// --- Top-level ---
// Parser - builds up the property tree from the path strings
const xr=/(\w+)(\])?(\[|\.)?/g;// extracts
// 	- the identifier (member name or array index)
//  - followed by an optional right bracket (found when array index)
//  - followed by an optional left bracket or dot (type of subscript)

// Note: These portions can be read in a non-overlapping fashion and
// allow straightforward parsing of the hierarchy that WebGL encodes
// in the uniform names.
function wr(t,e){t.seq.push(e),t.map[e.id]=e}function br(t,e,i){const n=t.name,r=n.length;// reset RegExp object, because of the early exit of a previous run
for(xr.lastIndex=0;;){const s=xr.exec(n),o=xr.lastIndex;let a=s[1];const h="]"===s[2],l=s[3];// convert to integer
if(h&&(a|=0),void 0===l||"["===l&&o+2===r){// bare name or "pure" bottom-level array "[0]" suffix
wr(i,void 0===l?new _r(a,t,e):new vr(a,t,e));break}{let t=i.map[a];void 0===t&&(t=new yr(a),wr(i,t)),i=t}}}// Root Container
class Mr{constructor(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,35718);for(let n=0;n<i;++n){const i=t.getActiveUniform(e,n);br(i,t.getUniformLocation(e,i.name),this)}}setValue(t,e,i,n){const r=this.map[e];void 0!==r&&r.setValue(t,i,n)}setOptional(t,e,i){const n=e[i];void 0!==n&&this.setValue(t,i,n)}static upload(t,e,i,n){for(let r=0,s=e.length;r!==s;++r){const s=e[r],o=i[s.id];!1!==o.needsUpdate&&// note: always updating when .needsUpdate is undefined
s.setValue(t,o.value,n)}}static seqWithValue(t,e){const i=[];for(let n=0,r=t.length;n!==r;++n){const r=t[n];r.id in e&&i.push(r)}return i}}function Sr(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}let Cr=0;function Tr(t,e,i){const n=t.getShaderParameter(e,35713),r=t.getShaderInfoLog(e).trim();if(n&&""===r)return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){// --enable-privileged-webgl-extension
// console.log( '**' + type + '**', gl.getExtension( 'WEBGL_debug_shaders' ).getTranslatedShaderSource( shader ) );
const n=parseInt(s[1]);return i.toUpperCase()+"\n\n"+r+"\n\n"+function(t,e){const i=t.split("\n"),n=[],r=Math.max(e-6,0),s=Math.min(e+6,i.length);for(let o=r;o<s;o++){const t=o+1;n.push(`${t===e?">":" "} ${t}: ${i[o]}`)}return n.join("\n")}(t.getShaderSource(e),n)}return r}function Pr(t,e){const i=function(t){switch(t){case I:return["Linear","( value )"];case k:return["sRGB","( value )"];default:return["Linear","( value )"]}}(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function Ar(t,e){let i;switch(e){case 1:default:i="Linear";break;case 2:i="Reinhard";break;case 3:i="OptimizedCineon";break;case 4:i="ACESFilmic";break;case 5:i="Custom"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Er(t){return""!==t}function Lr(t,e){const i=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Rr(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}// Resolve Includes
const Or=/^[ \t]*#include +<([\w\d./]+)>/gm;function Dr(t){return t.replace(Or,Ir)}function Ir(t,e){const i=ji[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return Dr(i)}// Unroll Loops
const kr=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function zr(t){return t.replace(kr,Nr)}function Nr(t,e,i,n){let r="";for(let s=parseInt(e);s<parseInt(i);s++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+s+" ]").replace(/UNROLLED_LOOP_INDEX/g,s);return r}
function Fr(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function jr(t,e,i,n){// TODO Send this event to Three.js DevTools
// console.log( 'WebGLProgram', cacheKey );
const r=t.getContext(),s=i.defines;let o=i.vertexShader,a=i.fragmentShader;const h=function(t){let e="SHADOWMAP_TYPE_BASIC";return 1===t.shadowMapType?e="SHADOWMAP_TYPE_PCF":2===t.shadowMapType?e="SHADOWMAP_TYPE_PCF_SOFT":3===t.shadowMapType&&(e="SHADOWMAP_TYPE_VSM"),e}(i),l=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case u:case d:e="ENVMAP_TYPE_CUBE";break;case f:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),c=function(t){let e="ENVMAP_MODE_REFLECTION";t.envMap&&t.envMapMode===d&&(e="ENVMAP_MODE_REFRACTION");return e}(i),p=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case 0:e="ENVMAP_BLENDING_MULTIPLY";break;case 1:e="ENVMAP_BLENDING_MIX";break;case 2:e="ENVMAP_BLENDING_ADD"}return e}(i),g=function(t){const e=t.envMapCubeUVHeight;if(null===e)return null;const i=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:n,maxMip:i}}(i),m=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUVHeight||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap||t.transmission)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Er).join("\n")}(i),_=function(t){const e=[];for(const i in t){const n=t[i];!1!==n&&e.push("#define "+i+" "+n)}return e.join("\n")}(s),v=r.createProgram();let y,x,w=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(y=[_].filter(Er).join("\n"),y.length>0&&(y+="\n"),x=[m,_].filter(Er).join("\n"),x.length>0&&(x+="\n")):(y=[Fr(i),"#define SHADER_NAME "+i.shaderName,_,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",i.specularColorMap?"#define USE_SPECULARCOLORMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEENCOLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors&&i.isWebGL2?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Er).join("\n"),x=[m,Fr(i),"#define SHADER_NAME "+i.shaderName,_,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+l:"",i.envMap?"#define "+c:"",i.envMap?"#define "+p:"",g?"#define CUBEUV_TEXEL_WIDTH "+g.texelWidth:"",g?"#define CUBEUV_TEXEL_HEIGHT "+g.texelHeight:"",g?"#define CUBEUV_MAX_MIP "+g.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",i.specularColorMap?"#define USE_SPECULARCOLORMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEENCOLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?ji.tonemapping_pars_fragment:"",// this code is required here because it is used by the toneMapping() function defined below
0!==i.toneMapping?Ar("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",ji.encodings_pars_fragment,// this code is required here because it is used by the various encoding/decoding function defined below
Pr("linearToOutputTexel",i.outputEncoding),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Er).join("\n")),o=Dr(o),o=Lr(o,i),o=Rr(o,i),a=Dr(a),a=Lr(a,i),a=Rr(a,i),o=zr(o),a=zr(a),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(// GLSL 3.0 conversion for built-in materials and ShaderMaterial
w="#version 300 es\n",y=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+y,x=["#define varying in",i.glslVersion===B?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===B?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+x);const b=w+x+a,M=Sr(r,35633,w+y+o),S=Sr(r,35632,b);// check for link errors
if(r.attachShader(v,M),r.attachShader(v,S),// Force a particular attribute to index 0.
void 0!==i.index0AttributeName?r.bindAttribLocation(v,0,i.index0AttributeName):!0===i.morphTargets&&// programs with morphTargets displace position out of attribute 0
r.bindAttribLocation(v,0,"position"),r.linkProgram(v),t.debug.checkShaderErrors){const t=r.getProgramInfoLog(v).trim(),e=r.getShaderInfoLog(M).trim(),i=r.getShaderInfoLog(S).trim();let n=!0,s=!0;if(!1===r.getProgramParameter(v,35714)){n=!1;Tr(r,M,"vertex"),Tr(r,S,"fragment")}else""!==t||""!==e&&""!==i||(s=!1);s&&(this.diagnostics={runnable:n,programLog:t,vertexShader:{log:e,prefix:y},fragmentShader:{log:i,prefix:x}})}// Clean up
// Crashes in iOS9 and iOS10. #18402
// gl.detachShader( program, glVertexShader );
// gl.detachShader( program, glFragmentShader );
// set up caching for uniform locations
let C,T;return r.deleteShader(M),r.deleteShader(S),this.getUniforms=function(){return void 0===C&&(C=new Mr(r,v)),C},this.getAttributes=function(){return void 0===T&&(T=function(t,e){const i={},n=t.getProgramParameter(e,35721);for(let r=0;r<n;r++){const n=t.getActiveAttrib(e,r),s=n.name;let o=1;35674===n.type&&(o=2),35675===n.type&&(o=3),35676===n.type&&(o=4),// console.log( 'THREE.WebGLProgram: ACTIVE VERTEX ATTRIBUTE:', name, i );
i[s]={type:n.type,location:t.getAttribLocation(e,s),locationSize:o}}return i}(r,v)),T},// free resource
this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(v),this.program=void 0},this.name=i.shaderName,this.id=Cr++,this.cacheKey=e,this.usedTimes=1,this.program=v,this.vertexShader=M,this.fragmentShader=S,this}let Br=0;class Ur{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(t){const e=t.vertexShader,i=t.fragmentShader,n=this._getShaderStage(e),r=this._getShaderStage(i),s=this._getShaderCacheForMaterial(t);return!1===s.has(n)&&(s.add(n),n.usedTimes++),!1===s.has(r)&&(s.add(r),r.usedTimes++),this}remove(t){const e=this.materialCache.get(t);for(const i of e)i.usedTimes--,0===i.usedTimes&&this.shaderCache.delete(i.code);return this.materialCache.delete(t),this}getVertexShaderID(t){return this._getShaderStage(t.vertexShader).id}getFragmentShaderID(t){return this._getShaderStage(t.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(t){const e=this.materialCache;let i=e.get(t);return void 0===i&&(i=new Set,e.set(t,i)),i}_getShaderStage(t){const e=this.shaderCache;let i=e.get(t);return void 0===i&&(i=new Gr(t),e.set(t,i)),i}}class Gr{constructor(t){this.id=Br++,this.code=t,this.usedTimes=0}}function Hr(t,e,i,n,r,s,o){const a=new fe,h=new Ur,l=[],c=r.isWebGL2,u=r.logarithmicDepthBuffer,d=r.vertexTextures;let p=r.precision;const g={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};return{getParameters:function(s,a,l,m,_){const v=m.fog,y=_.geometry,x=s.isMeshStandardMaterial?m.environment:null,w=(s.isMeshStandardMaterial?i:e).get(s.envMap||x),b=w&&w.mapping===f?w.image.height:null,M=g[s.type];// heuristics to create shader parameters according to lights in the scene
// (not to blow over maxLights budget)
null!==s.precision&&(p=r.getMaxPrecision(s.precision),s.precision);
const S=y.morphAttributes.position||y.morphAttributes.normal||y.morphAttributes.color,C=void 0!==S?S.length:0;let T,P,A,E,L=0;if(void 0!==y.morphAttributes.position&&(L=1),void 0!==y.morphAttributes.normal&&(L=2),void 0!==y.morphAttributes.color&&(L=3),M){const t=Ui[M];T=t.vertexShader,P=t.fragmentShader}else T=s.vertexShader,P=s.fragmentShader,h.update(s),A=h.getVertexShaderID(s),E=h.getFragmentShaderID(s);const R=t.getRenderTarget(),O=s.alphaTest>0,D=s.clearcoat>0,z=s.iridescence>0;return{isWebGL2:c,shaderID:M,shaderName:s.type,vertexShader:T,fragmentShader:P,defines:s.defines,customVertexShaderID:A,customFragmentShaderID:E,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:p,instancing:!0===_.isInstancedMesh,instancingColor:!0===_.isInstancedMesh&&null!==_.instanceColor,supportsVertexTextures:d,outputEncoding:null===R?t.outputEncoding:!0===R.isXRRenderTarget?R.texture.encoding:I,map:!!s.map,matcap:!!s.matcap,envMap:!!w,envMapMode:w&&w.mapping,envMapCubeUVHeight:b,lightMap:!!s.lightMap,aoMap:!!s.aoMap,emissiveMap:!!s.emissiveMap,bumpMap:!!s.bumpMap,normalMap:!!s.normalMap,objectSpaceNormalMap:1===s.normalMapType,tangentSpaceNormalMap:0===s.normalMapType,decodeVideoTexture:!!s.map&&!0===s.map.isVideoTexture&&s.map.encoding===k,clearcoat:D,clearcoatMap:D&&!!s.clearcoatMap,clearcoatRoughnessMap:D&&!!s.clearcoatRoughnessMap,clearcoatNormalMap:D&&!!s.clearcoatNormalMap,iridescence:z,iridescenceMap:z&&!!s.iridescenceMap,iridescenceThicknessMap:z&&!!s.iridescenceThicknessMap,displacementMap:!!s.displacementMap,roughnessMap:!!s.roughnessMap,metalnessMap:!!s.metalnessMap,specularMap:!!s.specularMap,specularIntensityMap:!!s.specularIntensityMap,specularColorMap:!!s.specularColorMap,opaque:!1===s.transparent&&1===s.blending,alphaMap:!!s.alphaMap,alphaTest:O,gradientMap:!!s.gradientMap,sheen:s.sheen>0,sheenColorMap:!!s.sheenColorMap,sheenRoughnessMap:!!s.sheenRoughnessMap,transmission:s.transmission>0,transmissionMap:!!s.transmissionMap,thicknessMap:!!s.thicknessMap,combine:s.combine,vertexTangents:!!s.normalMap&&!!y.attributes.tangent,vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!y.attributes.color&&4===y.attributes.color.itemSize,vertexUvs:!!(s.map||s.bumpMap||s.normalMap||s.specularMap||s.alphaMap||s.emissiveMap||s.roughnessMap||s.metalnessMap||s.clearcoatMap||s.clearcoatRoughnessMap||s.clearcoatNormalMap||s.iridescenceMap||s.iridescenceThicknessMap||s.displacementMap||s.transmissionMap||s.thicknessMap||s.specularIntensityMap||s.specularColorMap||s.sheenColorMap||s.sheenRoughnessMap),uvsVertexOnly:!(s.map||s.bumpMap||s.normalMap||s.specularMap||s.alphaMap||s.emissiveMap||s.roughnessMap||s.metalnessMap||s.clearcoatNormalMap||s.iridescenceMap||s.iridescenceThicknessMap||s.transmission>0||s.transmissionMap||s.thicknessMap||s.specularIntensityMap||s.specularColorMap||s.sheen>0||s.sheenColorMap||s.sheenRoughnessMap||!s.displacementMap),fog:!!v,useFog:!0===s.fog,fogExp2:v&&v.isFogExp2,flatShading:!!s.flatShading,sizeAttenuation:s.sizeAttenuation,logarithmicDepthBuffer:u,skinning:!0===_.isSkinnedMesh,morphTargets:void 0!==y.morphAttributes.position,morphNormals:void 0!==y.morphAttributes.normal,morphColors:void 0!==y.morphAttributes.color,morphTargetsCount:C,morphTextureStride:L,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numSpotLightMaps:a.spotLightMap.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numSpotLightShadowsWithMaps:a.numSpotLightShadowsWithMaps,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:s.dithering,shadowMapEnabled:t.shadowMap.enabled&&l.length>0,shadowMapType:t.shadowMap.type,toneMapping:s.toneMapped?t.toneMapping:0,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:s.premultipliedAlpha,doubleSided:2===s.side,flipSided:1===s.side,useDepthPacking:!!s.depthPacking,depthPacking:s.depthPacking||0,index0AttributeName:s.index0AttributeName,extensionDerivatives:s.extensions&&s.extensions.derivatives,extensionFragDepth:s.extensions&&s.extensions.fragDepth,extensionDrawBuffers:s.extensions&&s.extensions.drawBuffers,extensionShaderTextureLOD:s.extensions&&s.extensions.shaderTextureLOD,rendererExtensionFragDepth:c||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:c||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:c||n.has("EXT_shader_texture_lod"),customProgramCacheKey:s.customProgramCacheKey()}},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.customVertexShaderID),i.push(e.customFragmentShaderID)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);return!1===e.isRawShaderMaterial&&(!function(t,e){t.push(e.precision),t.push(e.outputEncoding),t.push(e.envMapMode),t.push(e.envMapCubeUVHeight),t.push(e.combine),t.push(e.vertexUvs),t.push(e.fogExp2),t.push(e.sizeAttenuation),t.push(e.morphTargetsCount),t.push(e.morphAttributeCount),t.push(e.numDirLights),t.push(e.numPointLights),t.push(e.numSpotLights),t.push(e.numSpotLightMaps),t.push(e.numHemiLights),t.push(e.numRectAreaLights),t.push(e.numDirLightShadows),t.push(e.numPointLightShadows),t.push(e.numSpotLightShadows),t.push(e.numSpotLightShadowsWithMaps),t.push(e.shadowMapType),t.push(e.toneMapping),t.push(e.numClippingPlanes),t.push(e.numClipIntersection),t.push(e.depthPacking)}(i,e),function(t,e){a.disableAll(),e.isWebGL2&&a.enable(0);e.supportsVertexTextures&&a.enable(1);e.instancing&&a.enable(2);e.instancingColor&&a.enable(3);e.map&&a.enable(4);e.matcap&&a.enable(5);e.envMap&&a.enable(6);e.lightMap&&a.enable(7);e.aoMap&&a.enable(8);e.emissiveMap&&a.enable(9);e.bumpMap&&a.enable(10);e.normalMap&&a.enable(11);e.objectSpaceNormalMap&&a.enable(12);e.tangentSpaceNormalMap&&a.enable(13);e.clearcoat&&a.enable(14);e.clearcoatMap&&a.enable(15);e.clearcoatRoughnessMap&&a.enable(16);e.clearcoatNormalMap&&a.enable(17);e.iridescence&&a.enable(18);e.iridescenceMap&&a.enable(19);e.iridescenceThicknessMap&&a.enable(20);e.displacementMap&&a.enable(21);e.specularMap&&a.enable(22);e.roughnessMap&&a.enable(23);e.metalnessMap&&a.enable(24);e.gradientMap&&a.enable(25);e.alphaMap&&a.enable(26);e.alphaTest&&a.enable(27);e.vertexColors&&a.enable(28);e.vertexAlphas&&a.enable(29);e.vertexUvs&&a.enable(30);e.vertexTangents&&a.enable(31);e.uvsVertexOnly&&a.enable(32);t.push(a.mask),a.disableAll(),e.fog&&a.enable(0);e.useFog&&a.enable(1);e.flatShading&&a.enable(2);e.logarithmicDepthBuffer&&a.enable(3);e.skinning&&a.enable(4);e.morphTargets&&a.enable(5);e.morphNormals&&a.enable(6);e.morphColors&&a.enable(7);e.premultipliedAlpha&&a.enable(8);e.shadowMapEnabled&&a.enable(9);e.physicallyCorrectLights&&a.enable(10);e.doubleSided&&a.enable(11);e.flipSided&&a.enable(12);e.useDepthPacking&&a.enable(13);e.dithering&&a.enable(14);e.specularIntensityMap&&a.enable(15);e.specularColorMap&&a.enable(16);e.transmission&&a.enable(17);e.transmissionMap&&a.enable(18);e.thicknessMap&&a.enable(19);e.sheen&&a.enable(20);e.sheenColorMap&&a.enable(21);e.sheenRoughnessMap&&a.enable(22);e.decodeVideoTexture&&a.enable(23);e.opaque&&a.enable(24);t.push(a.mask)}(i,e),i.push(t.outputEncoding)),i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=g[t.type];let i;if(e){const t=Ui[e];i=wi.clone(t.uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let n;// Check if code has been already compiled
for(let t=0,r=l.length;t<r;t++){const e=l[t];if(e.cacheKey===i){n=e,++n.usedTimes;break}}return void 0===n&&(n=new jr(t,i,e,s),l.push(n)),n},releaseProgram:function(t){if(0==--t.usedTimes){// Remove from unordered set
const e=l.indexOf(t);l[e]=l[l.length-1],l.pop(),// Free WebGL resources
t.destroy()}},releaseShaderCache:function(t){h.remove(t)},// Exposed for resource monitoring & error feedback via renderer.info:
programs:l,dispose:function(){h.dispose()}}}function Vr(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}}function Wr(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function Zr(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function qr(){const t=[];let e=0;const i=[],n=[],r=[];function s(i,n,r,s,o,a){let h=t[e];return void 0===h?(h={id:i.id,object:i,geometry:n,material:r,groupOrder:s,renderOrder:i.renderOrder,z:o,group:a},t[e]=h):(h.id=i.id,h.object=i,h.geometry=n,h.material=r,h.groupOrder=s,h.renderOrder=i.renderOrder,h.z=o,h.group=a),e++,h}return{opaque:i,transmissive:n,transparent:r,init:function(){e=0,i.length=0,n.length=0,r.length=0},push:function(t,e,o,a,h,l){const c=s(t,e,o,a,h,l);o.transmission>0?n.push(c):!0===o.transparent?r.push(c):i.push(c)},unshift:function(t,e,o,a,h,l){const c=s(t,e,o,a,h,l);o.transmission>0?n.unshift(c):!0===o.transparent?r.unshift(c):i.unshift(c)},finish:function(){// Clear references from inactive renderItems in the list
for(let i=e,n=t.length;i<n;i++){const e=t[i];if(null===e.id)break;e.id=null,e.object=null,e.geometry=null,e.material=null,e.group=null}},sort:function(t,e){i.length>1&&i.sort(t||Wr),n.length>1&&n.sort(e||Zr),r.length>1&&r.sort(e||Zr)}}}function Xr(){let t=new WeakMap;return{get:function(e,i){const n=t.get(e);let r;return void 0===n?(r=new qr,t.set(e,[r])):i>=n.length?(r=new qr,n.push(r)):r=n[i],r},dispose:function(){t=new WeakMap}}}function Jr(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new Tt,color:new pt};break;case"SpotLight":i={position:new Tt,direction:new Tt,color:new pt,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Tt,color:new pt,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Tt,skyColor:new pt,groundColor:new pt};break;case"RectAreaLight":i={color:new pt,position:new Tt,halfWidth:new Tt,halfHeight:new Tt}}return t[e.id]=i,i}}}let Yr=0;function Qr(t,e){return(e.castShadow?2:0)-(t.castShadow?2:0)+(e.map?1:0)-(t.map?1:0)}function Kr(t,e){const i=new Jr,n=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new $};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new $,shadowCameraNear:1,shadowCameraFar:1e3};// TODO (abelnation): set RectAreaLight shadow uniforms
}return t[e.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0};for(let h=0;h<9;h++)r.probe.push(new Tt);const s=new Tt,o=new ie,a=new ie;return{setup:function(s,o){let a=0,h=0,l=0;for(let t=0;t<9;t++)r.probe[t].set(0,0,0);let c=0,u=0,d=0,f=0,p=0,g=0,m=0,_=0,v=0,y=0;// ordering : [shadow casting + map texturing, map texturing, shadow casting, none ]
s.sort(Qr);// artist-friendly light intensity scaling factor
const x=!0!==o?Math.PI:1;for(let t=0,e=s.length;t<e;t++){const e=s[t],o=e.color,w=e.intensity,b=e.distance,M=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)a+=o.r*w*x,h+=o.g*w*x,l+=o.b*w*x;else if(e.isLightProbe)for(let t=0;t<9;t++)r.probe[t].addScaledVector(e.sh.coefficients[t],w);else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*x),e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.directionalShadow[c]=i,r.directionalShadowMap[c]=M,r.directionalShadowMatrix[c]=e.shadow.matrix,g++}r.directional[c]=t,c++}else if(e.isSpotLight){const t=i.get(e);t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(o).multiplyScalar(w*x),t.distance=b,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,r.spot[d]=t;const s=e.shadow;if(e.map&&(r.spotLightMap[v]=e.map,v++,// make sure the lightMatrix is up to date
// TODO : do it if required only
s.updateMatrices(e),e.castShadow&&y++),r.spotLightMatrix[d]=s.matrix,e.castShadow){const t=n.get(e);t.shadowBias=s.bias,t.shadowNormalBias=s.normalBias,t.shadowRadius=s.radius,t.shadowMapSize=s.mapSize,r.spotShadow[d]=t,r.spotShadowMap[d]=M,_++}d++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(o).multiplyScalar(w),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),r.rectArea[f]=t,f++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*x),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,r.pointShadow[u]=i,r.pointShadowMap[u]=M,r.pointShadowMatrix[u]=e.shadow.matrix,m++}r.point[u]=t,u++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(w*x),t.groundColor.copy(e.groundColor).multiplyScalar(w*x),r.hemi[p]=t,p++}}f>0&&(e.isWebGL2||!0===t.has("OES_texture_float_linear")?(// WebGL 2
r.rectAreaLTC1=Bi.LTC_FLOAT_1,r.rectAreaLTC2=Bi.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")&&(r.rectAreaLTC1=Bi.LTC_HALF_1,r.rectAreaLTC2=Bi.LTC_HALF_2)),r.ambient[0]=a,r.ambient[1]=h,r.ambient[2]=l;const w=r.hash;w.directionalLength===c&&w.pointLength===u&&w.spotLength===d&&w.rectAreaLength===f&&w.hemiLength===p&&w.numDirectionalShadows===g&&w.numPointShadows===m&&w.numSpotShadows===_&&w.numSpotMaps===v||(r.directional.length=c,r.spot.length=d,r.rectArea.length=f,r.point.length=u,r.hemi.length=p,r.directionalShadow.length=g,r.directionalShadowMap.length=g,r.pointShadow.length=m,r.pointShadowMap.length=m,r.spotShadow.length=_,r.spotShadowMap.length=_,r.directionalShadowMatrix.length=g,r.pointShadowMatrix.length=m,r.spotLightMatrix.length=_+v-y,r.spotLightMap.length=v,r.numSpotLightShadowsWithMaps=y,w.directionalLength=c,w.pointLength=u,w.spotLength=d,w.rectAreaLength=f,w.hemiLength=p,w.numDirectionalShadows=g,w.numPointShadows=m,w.numSpotShadows=_,w.numSpotMaps=v,r.version=Yr++)},setupView:function(t,e){let i=0,n=0,h=0,l=0,c=0;const u=e.matrixWorldInverse;for(let d=0,f=t.length;d<f;d++){const e=t[d];if(e.isDirectionalLight){const t=r.directional[i];t.direction.setFromMatrixPosition(e.matrixWorld),s.setFromMatrixPosition(e.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),i++}else if(e.isSpotLight){const t=r.spot[h];t.position.setFromMatrixPosition(e.matrixWorld),t.position.applyMatrix4(u),t.direction.setFromMatrixPosition(e.matrixWorld),s.setFromMatrixPosition(e.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),h++}else if(e.isRectAreaLight){const t=r.rectArea[l];t.position.setFromMatrixPosition(e.matrixWorld),t.position.applyMatrix4(u),// extract local rotation of light to derive width/height half vectors
a.identity(),o.copy(e.matrixWorld),o.premultiply(u),a.extractRotation(o),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),t.halfWidth.applyMatrix4(a),t.halfHeight.applyMatrix4(a),l++}else if(e.isPointLight){const t=r.point[n];t.position.setFromMatrixPosition(e.matrixWorld),t.position.applyMatrix4(u),n++}else if(e.isHemisphereLight){const t=r.hemi[c];t.direction.setFromMatrixPosition(e.matrixWorld),t.direction.transformDirection(u),c++}}},state:r}}function $r(t,e){const i=new Kr(t,e),n=[],r=[];return{init:function(){n.length=0,r.length=0},state:{lightsArray:n,shadowsArray:r,lights:i},setupLights:function(t){i.setup(n,t)},setupLightsView:function(t){i.setupView(n,t)},pushLight:function(t){n.push(t)},pushShadow:function(t){r.push(t)}}}function ts(t,e){let i=new WeakMap;return{get:function(n,r=0){const s=i.get(n);let o;return void 0===s?(o=new $r(t,e),i.set(n,[o])):r>=s.length?(o=new $r(t,e),s.push(o)):o=s[r],o},dispose:function(){i=new WeakMap}}}class es extends Be{constructor(t){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}class is extends Be{constructor(t){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.referencePosition=new Tt,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}function ns(t,e,i){let n=new ki;const r=new $,s=new $,o=new wt,a=new es({depthPacking:3201}),h=new is,l={},c=i.maxTextureSize,u={0:1,1:0,2:2},d=new bi({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new $},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),f=d.clone();f.defines.HORIZONTAL_PASS=1;const p=new ei;p.setAttribute("position",new Ve(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const g=new gi(p,d),m=this;function v(i,n){const s=e.update(g);d.defines.VSM_SAMPLES!==i.blurSamples&&(d.defines.VSM_SAMPLES=i.blurSamples,f.defines.VSM_SAMPLES=i.blurSamples,d.needsUpdate=!0,f.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new bt(r.x,r.y)),// vertical pass
d.uniforms.shadow_pass.value=i.map.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(n,null,s,d,g,null),// horizontal pass
f.uniforms.shadow_pass.value=i.mapPass.texture,f.uniforms.resolution.value=i.mapSize,f.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(n,null,s,f,g,null)}function y(e,i,n,r,s,o){let c=null;const d=!0===n.isPointLight?e.customDistanceMaterial:e.customDepthMaterial;if(void 0!==d)c=d;else if(c=!0===n.isPointLight?h:a,t.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0){// in this case we need a unique material instance reflecting the
// appropriate state
const t=c.uuid,e=i.uuid;let n=l[t];void 0===n&&(n={},l[t]=n);let r=n[e];void 0===r&&(r=c.clone(),n[e]=r),c=r}return c.visible=i.visible,c.wireframe=i.wireframe,c.side=3===o?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:u[i.side],c.alphaMap=i.alphaMap,c.alphaTest=i.alphaTest,c.map=i.map,c.clipShadows=i.clipShadows,c.clippingPlanes=i.clippingPlanes,c.clipIntersection=i.clipIntersection,c.displacementMap=i.displacementMap,c.displacementScale=i.displacementScale,c.displacementBias=i.displacementBias,c.wireframeLinewidth=i.wireframeLinewidth,c.linewidth=i.linewidth,!0===n.isPointLight&&!0===c.isMeshDistanceMaterial&&(c.referencePosition.setFromMatrixPosition(n.matrixWorld),c.nearDistance=r,c.farDistance=s),c}function x(i,r,s,o,a){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===a)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const n=e.update(i),r=i.material;if(Array.isArray(r)){const e=n.groups;for(let h=0,l=e.length;h<l;h++){const l=e[h],c=r[l.materialIndex];if(c&&c.visible){const e=y(i,c,o,s.near,s.far,a);t.renderBufferDirect(s,null,n,e,i,l)}}}else if(r.visible){const e=y(i,r,o,s.near,s.far,a);t.renderBufferDirect(s,null,n,e,i,null)}}const h=i.children;for(let t=0,e=h.length;t<e;t++)x(h[t],r,s,o,a)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(e,i,a){if(!1===m.enabled)return;if(!1===m.autoUpdate&&!1===m.needsUpdate)return;if(0===e.length)return;const h=t.getRenderTarget(),l=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),d=t.state;// Set GL state for depth map.
d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);// render depth map
for(let f=0,p=e.length;f<p;f++){const h=e[f],l=h.shadow;if(void 0===l)continue;if(!1===l.autoUpdate&&!1===l.needsUpdate)continue;r.copy(l.mapSize);const u=l.getFrameExtents();if(r.multiply(u),s.copy(l.mapSize),(r.x>c||r.y>c)&&(r.x>c&&(s.x=Math.floor(c/u.x),r.x=s.x*u.x,l.mapSize.x=s.x),r.y>c&&(s.y=Math.floor(c/u.y),r.y=s.y*u.y,l.mapSize.y=s.y)),null===l.map){const t=3!==this.type?{minFilter:_,magFilter:_}:{};l.map=new bt(r.x,r.y,t),l.map.texture.name=h.name+".shadowMap",l.camera.updateProjectionMatrix()}t.setRenderTarget(l.map),t.clear();const p=l.getViewportCount();for(let t=0;t<p;t++){const e=l.getViewport(t);o.set(s.x*e.x,s.y*e.y,s.x*e.z,s.y*e.w),d.viewport(o),l.updateMatrices(h,t),n=l.getFrustum(),x(i,a,l.camera,h,this.type)}// do blur pass for VSM
!0!==l.isPointLightShadow&&3===this.type&&v(l,a),l.needsUpdate=!1}m.needsUpdate=!1,t.setRenderTarget(h,l,u)}}function rs(t,e,i){const n=i.isWebGL2;const r=new function(){let e=!1;const i=new wt;let n=null;const r=new wt(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,s,o,a){!0===a&&(e*=o,n*=o,s*=o),i.set(e,n,s,o),!1===r.equals(i)&&(t.clearColor(e,n,s,o),r.copy(i))},reset:function(){e=!1,n=null,r.set(-1,0,0,0)}}},s=new function(){let e=!1,i=null,n=null,r=null;return{setTest:function(t){t?U(2929):G(2929)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){switch(e){case 0:t.depthFunc(512);break;case 1:t.depthFunc(519);break;case 2:t.depthFunc(513);break;case 3:default:t.depthFunc(515);break;case 4:t.depthFunc(514);break;case 5:t.depthFunc(518);break;case 6:t.depthFunc(516);break;case 7:t.depthFunc(517)}n=e}},setLocked:function(t){e=t},setClear:function(e){r!==e&&(t.clearDepth(e),r=e)},reset:function(){e=!1,i=null,n=null,r=null}}},o=new function(){let e=!1,i=null,n=null,r=null,s=null,o=null,a=null,h=null,l=null;return{setTest:function(t){e||(t?U(2960):G(2960))},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,o){n===e&&r===i&&s===o||(t.stencilFunc(e,i,o),n=e,r=i,s=o)},setOp:function(e,i,n){o===e&&a===i&&h===n||(t.stencilOp(e,i,n),o=e,a=i,h=n)},setLocked:function(t){e=t},setClear:function(e){l!==e&&(t.clearStencil(e),l=e)},reset:function(){e=!1,i=null,n=null,r=null,s=null,o=null,a=null,h=null,l=null}}},a=new WeakMap,h=new WeakMap;let l={},u={},d=new WeakMap,f=[],p=null,g=!1,m=null,_=null,v=null,y=null,x=null,w=null,b=null,M=!1,S=null,C=null,T=null,P=null,A=null;const E=t.getParameter(35661);let L=!1,R=0;const O=t.getParameter(7938);-1!==O.indexOf("WebGL")?(R=parseFloat(/^WebGL (\d)/.exec(O)[1]),L=R>=1):-1!==O.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL ES (\d)/.exec(O)[1]),L=R>=2);let D=null,I={};const k=t.getParameter(3088),z=t.getParameter(2978),N=(new wt).fromArray(k),F=(new wt).fromArray(z);function j(e,i,n){const r=new Uint8Array(4),s=t.createTexture();// 4 is required to match default unpack alignment of 4.
t.bindTexture(e,s),t.texParameteri(e,10241,9728),t.texParameteri(e,10240,9728);for(let o=0;o<n;o++)t.texImage2D(i+o,0,6408,1,1,0,6408,5121,r);return s}const B={};function U(e){!0!==l[e]&&(t.enable(e),l[e]=!0)}function G(e){!1!==l[e]&&(t.disable(e),l[e]=!1)}B[3553]=j(3553,3553,1),B[34067]=j(34067,34069,6),// init
r.setClear(0,0,0,1),s.setClear(1),o.setClear(0),U(2929),s.setFunc(3),Z(!1),q(1),U(2884),W(0);const H={[c]:32774,101:32778,102:32779};if(n)H[103]=32775,H[104]=32776;else{const t=e.get("EXT_blend_minmax");null!==t&&(H[103]=t.MIN_EXT,H[104]=t.MAX_EXT)}const V={200:0,201:1,202:768,204:770,210:776,208:774,206:772,203:769,205:771,209:775,207:773};function W(e,i,n,r,s,o,a,h){if(0!==e){if(!1===g&&(U(3042),g=!0),5===e)// custom blending
s=s||i,o=o||n,a=a||r,i===_&&s===x||(t.blendEquationSeparate(H[i],H[s]),_=i,x=s),n===v&&r===y&&o===w&&a===b||(t.blendFuncSeparate(V[n],V[r],V[o],V[a]),v=n,y=r,w=o,b=a),m=e,M=!1;else if(e!==m||h!==M){if(_===c&&x===c||(t.blendEquation(32774),_=c,x=c),h)switch(e){case 1:t.blendFuncSeparate(1,771,1,771);break;case 2:t.blendFunc(1,1);break;case 3:t.blendFuncSeparate(0,769,0,1);break;case 4:t.blendFuncSeparate(0,768,0,770)}else switch(e){case 1:t.blendFuncSeparate(770,771,1,771);break;case 2:t.blendFunc(770,1);break;case 3:t.blendFuncSeparate(0,769,0,1);break;case 4:t.blendFunc(0,768)}v=null,y=null,w=null,b=null,m=e,M=h}}else!0===g&&(G(3042),g=!1)}function Z(e){S!==e&&(e?t.frontFace(2304):t.frontFace(2305),S=e)}function q(e){0!==e?(U(2884),e!==C&&(1===e?t.cullFace(1029):2===e?t.cullFace(1028):t.cullFace(1032))):G(2884),C=e}function X(e,i,n){e?(U(32823),P===i&&A===n||(t.polygonOffset(i,n),P=i,A=n)):G(32823)}return{buffers:{color:r,depth:s,stencil:o},enable:U,disable:G,bindFramebuffer:function(e,i){return u[e]!==i&&(t.bindFramebuffer(e,i),u[e]=i,n&&(// 36009 is equivalent to 36160
36009===e&&(u[36160]=i),36160===e&&(u[36009]=i)),!0)},drawBuffers:function(n,r){let s=f,o=!1;if(n)if(s=d.get(r),void 0===s&&(s=[],d.set(r,s)),n.isWebGLMultipleRenderTargets){const t=n.texture;if(s.length!==t.length||36064!==s[0]){for(let e=0,i=t.length;e<i;e++)s[e]=36064+e;s.length=t.length,o=!0}}else 36064!==s[0]&&(s[0]=36064,o=!0);else 1029!==s[0]&&(s[0]=1029,o=!0);o&&(i.isWebGL2?t.drawBuffers(s):e.get("WEBGL_draw_buffers").drawBuffersWEBGL(s))},useProgram:function(e){return p!==e&&(t.useProgram(e),p=e,!0)},setBlending:W,setMaterial:function(t,e){2===t.side?G(2884):U(2884);let i=1===t.side;e&&(i=!i),Z(i),1===t.blending&&!1===t.transparent?W(0):W(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),s.setFunc(t.depthFunc),s.setTest(t.depthTest),s.setMask(t.depthWrite),r.setMask(t.colorWrite);const n=t.stencilWrite;o.setTest(n),n&&(o.setMask(t.stencilWriteMask),o.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),o.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),X(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?U(32926):G(32926)},setFlipSided:Z,setCullFace:q,setLineWidth:function(e){e!==T&&(L&&t.lineWidth(e),T=e)},setPolygonOffset:X,setScissorTest:function(t){t?U(3089):G(3089)}// texture
,activeTexture:function(e){void 0===e&&(e=33984+E-1),D!==e&&(t.activeTexture(e),D=e)},bindTexture:function(e,i,n){void 0===n&&(n=null===D?33984+E-1:D);let r=I[n];void 0===r&&(r={type:void 0,texture:void 0},I[n]=r),r.type===e&&r.texture===i||(D!==n&&(t.activeTexture(n),D=n),t.bindTexture(e,i||B[e]),r.type=e,r.texture=i)},unbindTexture:function(){const e=I[D];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(e){}},compressedTexImage3D:function(){try{t.compressedTexImage3D.apply(t,arguments)}catch(e){}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(e){}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(e){}}
,updateUBOMapping:function(e,i){let n=h.get(i);void 0===n&&(n=new WeakMap,h.set(i,n));let r=n.get(e);void 0===r&&(r=t.getUniformBlockIndex(i,e.name),n.set(e,r))},uniformBlockBinding:function(e,i){const n=h.get(i).get(e);a.get(i)!==n&&(// bind shader specific block index to global block point
t.uniformBlockBinding(i,n,e.__bindingPointIndex),a.set(i,n))}
,texStorage2D:function(){try{t.texStorage2D.apply(t,arguments)}catch(e){}},texStorage3D:function(){try{t.texStorage3D.apply(t,arguments)}catch(e){}},texSubImage2D:function(){try{t.texSubImage2D.apply(t,arguments)}catch(e){}},texSubImage3D:function(){try{t.texSubImage3D.apply(t,arguments)}catch(e){}},compressedTexSubImage2D:function(){try{t.compressedTexSubImage2D.apply(t,arguments)}catch(e){}},compressedTexSubImage3D:function(){try{t.compressedTexSubImage3D.apply(t,arguments)}catch(e){}},scissor:function(e){!1===N.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),N.copy(e))},viewport:function(e){!1===F.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),F.copy(e))},reset:function(){// reset state
t.disable(3042),t.disable(2884),t.disable(2929),t.disable(32823),t.disable(3089),t.disable(2960),t.disable(32926),t.blendEquation(32774),t.blendFunc(1,0),t.blendFuncSeparate(1,0,1,0),t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(513),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(519,0,4294967295),t.stencilOp(7680,7680,7680),t.clearStencil(0),t.cullFace(1029),t.frontFace(2305),t.polygonOffset(0,0),t.activeTexture(33984),t.bindFramebuffer(36160,null),!0===n&&(t.bindFramebuffer(36009,null),t.bindFramebuffer(36008,null)),t.useProgram(null),t.lineWidth(1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.viewport(0,0,t.canvas.width,t.canvas.height),// reset internals
l={},D=null,I={},u={},d=new WeakMap,f=[],p=null,g=!1,m=null,_=null,v=null,y=null,x=null,w=null,b=null,M=!1,S=null,C=null,T=null,P=null,A=null,N.set(0,0,t.canvas.width,t.canvas.height),F.set(0,0,t.canvas.width,t.canvas.height),r.reset(),s.reset(),o.reset()}}}function ss(t,e,i,n,r,s,o){const a=r.isWebGL2,h=(r.maxTextures,r.maxCubemapSize),l=r.maxTextureSize,c=r.maxSamples,u=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,d="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),f=new WeakMap;let w;const E=new WeakMap;// maps WebglTexture objects to instances of Source
// cordova iOS (as of 5.0) still uses UIWebView, which provides OffscreenCanvas,
// also OffscreenCanvas.getContext("webgl"), but not OffscreenCanvas.getContext("2d")!
// Some implementations may only implement OffscreenCanvas partially (e.g. lacking 2d).
let L=!1;try{L="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(at){// Ignore any errors
}function R(t,e){// Use OffscreenCanvas when available. Specially needed in web workers
return L?// eslint-disable-next-line compat/compat
new OffscreenCanvas(t,e):nt("canvas")}function O(t,e,i,n){let r=1;// handle case if texture exceeds max size
// only perform resize if necessary
if((t.width>n||t.height>n)&&(r=n/Math.max(t.width,t.height)),r<1||!0===e){// only perform resize for certain image types
if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const n=e?Y:Math.floor,s=n(r*t.width),o=n(r*t.height);void 0===w&&(w=R(s,o));// cube textures can't reuse the same canvas
const a=i?R(s,o):w;a.width=s,a.height=o;return a.getContext("2d").drawImage(t,0,0,s,o),a}return t}return t}function D(t){return J(t.width)&&J(t.height)}function z(t,e){return t.generateMipmaps&&e&&t.minFilter!==_&&t.minFilter!==y}function N(e){t.generateMipmap(e)}function F(i,n,r,s,o=!1){if(!1===a)return n;if(null!==i&&void 0!==t[i])return t[i];let h=n;return 6403===n&&(5126===r&&(h=33326),5131===r&&(h=33325),5121===r&&(h=33321)),33319===n&&(5126===r&&(h=33328),5131===r&&(h=33327),5121===r&&(h=33323)),6408===n&&(5126===r&&(h=34836),5131===r&&(h=34842),5121===r&&(h=s===k&&!1===o?35907:32856),32819===r&&(h=32854),32820===r&&(h=32855)),33325!==h&&33326!==h&&33327!==h&&33328!==h&&34842!==h&&34836!==h||e.get("EXT_color_buffer_float"),h}function j(t,e,i){return!0===z(t,i)||t.isFramebufferTexture&&t.minFilter!==_&&t.minFilter!==y?Math.log2(Math.max(e.width,e.height))+1:void 0!==t.mipmaps&&t.mipmaps.length>0?t.mipmaps.length:t.isCompressedTexture&&Array.isArray(t.image)?e.mipmaps.length:1}// Fallback filters for non-power-of-2 textures
function B(t){return t===_||1004===t||t===v?9728:9729}
function G(t){const e=t.target;e.removeEventListener("dispose",G),function(t){const e=n.get(t);if(void 0===e.__webglInit)return;// check if it's necessary to remove the WebGLTexture object
const i=t.source,r=E.get(i);if(r){const n=r[e.__cacheKey];n.usedTimes--,// the WebGLTexture object is not used anymore, remove it
0===n.usedTimes&&V(t),// remove the weak map entry if no WebGLTexture uses the source anymore
0===Object.keys(r).length&&E.delete(i)}n.remove(t)}(e),e.isVideoTexture&&f.delete(e)}function H(e){const i=e.target;i.removeEventListener("dispose",H),function(e){const i=e.texture,r=n.get(e),s=n.get(i);void 0!==s.__webglTexture&&(t.deleteTexture(s.__webglTexture),o.memory.textures--);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLCubeRenderTarget)for(let n=0;n<6;n++)t.deleteFramebuffer(r.__webglFramebuffer[n]),r.__webglDepthbuffer&&t.deleteRenderbuffer(r.__webglDepthbuffer[n]);else{if(t.deleteFramebuffer(r.__webglFramebuffer),r.__webglDepthbuffer&&t.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&t.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer)for(let e=0;e<r.__webglColorRenderbuffer.length;e++)r.__webglColorRenderbuffer[e]&&t.deleteRenderbuffer(r.__webglColorRenderbuffer[e]);r.__webglDepthRenderbuffer&&t.deleteRenderbuffer(r.__webglDepthRenderbuffer)}if(e.isWebGLMultipleRenderTargets)for(let a=0,h=i.length;a<h;a++){const e=n.get(i[a]);e.__webglTexture&&(t.deleteTexture(e.__webglTexture),o.memory.textures--),n.remove(i[a])}n.remove(i),n.remove(e)}
(i)}function V(e){const i=n.get(e);t.deleteTexture(i.__webglTexture);const r=e.source;delete E.get(r)[i.__cacheKey],o.memory.textures--}let W=0;function Z(t,e){const r=n.get(t);if(t.isVideoTexture&&function(t){const e=o.render.frame;// Check the last frame we updated the VideoTexture
f.get(t)!==e&&(f.set(t,e),t.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&r.__version!==t.version){const i=t.image;if(null===i);else if(!1!==i.complete)return void $(r,t,e)}i.bindTexture(3553,r.__webglTexture,33984+e)}const q={[p]:10497,[g]:33071,[m]:33648},X={[_]:9728,1004:9984,[v]:9986,[y]:9729,1007:9985,[x]:9987};function Q(i,s,o){if(o?(t.texParameteri(i,10242,q[s.wrapS]),t.texParameteri(i,10243,q[s.wrapT]),32879!==i&&35866!==i||t.texParameteri(i,32882,q[s.wrapR]),t.texParameteri(i,10240,X[s.magFilter]),t.texParameteri(i,10241,X[s.minFilter])):(t.texParameteri(i,10242,33071),t.texParameteri(i,10243,33071),32879!==i&&35866!==i||t.texParameteri(i,32882,33071),s.wrapS!==g||s.wrapT,t.texParameteri(i,10240,B(s.magFilter)),t.texParameteri(i,10241,B(s.minFilter)),s.minFilter!==_&&s.minFilter),!0===e.has("EXT_texture_filter_anisotropic")){const o=e.get("EXT_texture_filter_anisotropic");if(s.magFilter===_)return;if(s.minFilter!==v&&s.minFilter!==x)return;if(s.type===M&&!1===e.has("OES_texture_float_linear"))return;// verify extension for WebGL 1 and WebGL 2
if(!1===a&&s.type===S&&!1===e.has("OES_texture_half_float_linear"))return;// verify extension for WebGL 1 only
(s.anisotropy>1||n.get(s).__currentAnisotropy)&&(t.texParameterf(i,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),n.get(s).__currentAnisotropy=s.anisotropy)}}function K(e,i){let n=!1;void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",G));// create Source <-> WebGLTextures mapping if necessary
const r=i.source;let s=E.get(r);void 0===s&&(s={},E.set(r,s));// check if there is already a WebGLTexture object for the given texture parameters
const a=function(t){const e=[];return e.push(t.wrapS),e.push(t.wrapT),e.push(t.wrapR||0),e.push(t.magFilter),e.push(t.minFilter),e.push(t.anisotropy),e.push(t.internalFormat),e.push(t.format),e.push(t.type),e.push(t.generateMipmaps),e.push(t.premultiplyAlpha),e.push(t.flipY),e.push(t.unpackAlignment),e.push(t.encoding),e.join()}(i);if(a!==e.__cacheKey){// if not, create a new instance of WebGLTexture
void 0===s[a]&&(// create new entry
s[a]={texture:t.createTexture(),usedTimes:0},o.memory.textures++,// when a new instance of WebGLTexture was created, a texture upload is required
// even if the image contents are identical
n=!0),s[a].usedTimes++;// every time the texture cache key changes, it's necessary to check if an instance of
// WebGLTexture can be deleted in order to avoid a memory leak.
const r=s[e.__cacheKey];void 0!==r&&(s[e.__cacheKey].usedTimes--,0===r.usedTimes&&V(i)),// store references to cache key and WebGLTexture object
e.__cacheKey=a,e.__webglTexture=s[a].texture}return n}function $(e,r,o){let h=3553;(r.isDataArrayTexture||r.isCompressedArrayTexture)&&(h=35866),r.isData3DTexture&&(h=32879);const c=K(e,r),u=r.source;i.bindTexture(h,e.__webglTexture,33984+o);const d=n.get(u);if(u.version!==d.__version||!0===c){i.activeTexture(33984+o),t.pixelStorei(37440,r.flipY),t.pixelStorei(37441,r.premultiplyAlpha),t.pixelStorei(3317,r.unpackAlignment),t.pixelStorei(37443,0);const e=function(t){return!a&&(t.wrapS!==g||t.wrapT!==g||t.minFilter!==_&&t.minFilter!==y)}(r)&&!1===D(r.image);let n=O(r.image,e,!1,l);n=ot(r,n);const f=D(n)||a,p=s.convert(r.format,r.encoding);let m,v=s.convert(r.type),x=F(r.internalFormat,p,v,r.encoding,r.isVideoTexture);Q(h,r,f);const w=r.mipmaps,S=a&&!0!==r.isVideoTexture,E=void 0===d.__version||!0===c,L=j(r,n,f);if(r.isDepthTexture)// populate depth texture with dummy data
x=6402,a?x=r.type===M?36012:r.type===b?33190:r.type===C?35056:33189:r.type,// validation checks for WebGL 1
r.format===P&&6402===x&&1012!==r.type&&r.type!==b&&(r.type=b,v=s.convert(r.type)),r.format===A&&6402===x&&(// Depth stencil textures need the DEPTH_STENCIL internal format
// (https://www.khronos.org/registry/webgl/extensions/WEBGL_depth_texture/)
x=34041,// The error INVALID_OPERATION is generated by texImage2D if format and internalformat are
// DEPTH_STENCIL and type is not UNSIGNED_INT_24_8_WEBGL.
// (https://www.khronos.org/registry/webgl/extensions/WEBGL_depth_texture/)
r.type!==C&&(r.type=C,v=s.convert(r.type))),E&&(S?i.texStorage2D(3553,1,x,n.width,n.height):i.texImage2D(3553,0,x,n.width,n.height,0,p,v,null));else if(r.isDataTexture)// use manually created mipmaps if available
// if there are no manual mipmaps
// set 0 level mipmap and then use GL to generate other mipmap levels
if(w.length>0&&f){S&&E&&i.texStorage2D(3553,L,x,w[0].width,w[0].height);for(let t=0,e=w.length;t<e;t++)m=w[t],S?i.texSubImage2D(3553,t,0,0,m.width,m.height,p,v,m.data):i.texImage2D(3553,t,x,m.width,m.height,0,p,v,m.data);r.generateMipmaps=!1}else S?(E&&i.texStorage2D(3553,L,x,n.width,n.height),i.texSubImage2D(3553,0,0,0,n.width,n.height,p,v,n.data)):i.texImage2D(3553,0,x,n.width,n.height,0,p,v,n.data);else if(r.isCompressedTexture)if(r.isCompressedArrayTexture){S&&E&&i.texStorage3D(35866,L,x,w[0].width,w[0].height,n.depth);for(let t=0,e=w.length;t<e;t++)m=w[t],r.format!==T?null!==p&&(S?i.compressedTexSubImage3D(35866,t,0,0,0,m.width,m.height,n.depth,p,m.data,0,0):i.compressedTexImage3D(35866,t,x,m.width,m.height,n.depth,0,m.data,0,0)):S?i.texSubImage3D(35866,t,0,0,0,m.width,m.height,n.depth,p,v,m.data):i.texImage3D(35866,t,x,m.width,m.height,n.depth,0,p,v,m.data)}else{S&&E&&i.texStorage2D(3553,L,x,w[0].width,w[0].height);for(let t=0,e=w.length;t<e;t++)m=w[t],r.format!==T?null!==p&&(S?i.compressedTexSubImage2D(3553,t,0,0,m.width,m.height,p,m.data):i.compressedTexImage2D(3553,t,x,m.width,m.height,0,m.data)):S?i.texSubImage2D(3553,t,0,0,m.width,m.height,p,v,m.data):i.texImage2D(3553,t,x,m.width,m.height,0,p,v,m.data)}else if(r.isDataArrayTexture)S?(E&&i.texStorage3D(35866,L,x,n.width,n.height,n.depth),i.texSubImage3D(35866,0,0,0,0,n.width,n.height,n.depth,p,v,n.data)):i.texImage3D(35866,0,x,n.width,n.height,n.depth,0,p,v,n.data);else if(r.isData3DTexture)S?(E&&i.texStorage3D(32879,L,x,n.width,n.height,n.depth),i.texSubImage3D(32879,0,0,0,0,n.width,n.height,n.depth,p,v,n.data)):i.texImage3D(32879,0,x,n.width,n.height,n.depth,0,p,v,n.data);else if(r.isFramebufferTexture){if(E)if(S)i.texStorage2D(3553,L,x,n.width,n.height);else{let t=n.width,e=n.height;for(let n=0;n<L;n++)i.texImage2D(3553,n,x,t,e,0,p,v,null),t>>=1,e>>=1}}else// regular Texture (image, video, canvas)
// use manually created mipmaps if available
// if there are no manual mipmaps
// set 0 level mipmap and then use GL to generate other mipmap levels
if(w.length>0&&f){S&&E&&i.texStorage2D(3553,L,x,w[0].width,w[0].height);for(let t=0,e=w.length;t<e;t++)m=w[t],S?i.texSubImage2D(3553,t,0,0,p,v,m):i.texImage2D(3553,t,x,p,v,m);r.generateMipmaps=!1}else S?(E&&i.texStorage2D(3553,L,x,n.width,n.height),i.texSubImage2D(3553,0,0,0,p,v,n)):i.texImage2D(3553,0,x,p,v,n);z(r,f)&&N(h),d.__version=u.version,r.onUpdate&&r.onUpdate(r)}e.__version=r.version}// Render targets
// Setup storage for target texture and bind it to correct framebuffer
function tt(e,r,o,a,h){const l=s.convert(o.format,o.encoding),c=s.convert(o.type),d=F(o.internalFormat,l,c,o.encoding);n.get(r).__hasExternalTextures||(32879===h||35866===h?i.texImage3D(h,0,d,r.width,r.height,r.depth,0,l,c,null):i.texImage2D(h,0,d,r.width,r.height,0,l,c,null)),i.bindFramebuffer(36160,e),st(r)?u.framebufferTexture2DMultisampleEXT(36160,a,h,n.get(o).__webglTexture,0,rt(r)):(3553===h||h>=34069&&h<=34074)&&// see #24753
t.framebufferTexture2D(36160,a,h,n.get(o).__webglTexture,0),i.bindFramebuffer(36160,null)}// Setup storage for internal depth/stencil buffers and bind to correct framebuffer
function et(e,i,n){if(t.bindRenderbuffer(36161,e),i.depthBuffer&&!i.stencilBuffer){let r=33189;if(n||st(i)){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===M?r=36012:e.type===b&&(r=33190));const n=rt(i);st(i)?u.renderbufferStorageMultisampleEXT(36161,n,r,i.width,i.height):t.renderbufferStorageMultisample(36161,n,r,i.width,i.height)}else t.renderbufferStorage(36161,r,i.width,i.height);t.framebufferRenderbuffer(36160,36096,36161,e)}else if(i.depthBuffer&&i.stencilBuffer){const r=rt(i);n&&!1===st(i)?t.renderbufferStorageMultisample(36161,r,35056,i.width,i.height):st(i)?u.renderbufferStorageMultisampleEXT(36161,r,35056,i.width,i.height):t.renderbufferStorage(36161,34041,i.width,i.height),t.framebufferRenderbuffer(36160,33306,36161,e)}else{const e=!0===i.isWebGLMultipleRenderTargets?i.texture:[i.texture];for(let r=0;r<e.length;r++){const o=e[r],a=s.convert(o.format,o.encoding),h=s.convert(o.type),l=F(o.internalFormat,a,h,o.encoding),c=rt(i);n&&!1===st(i)?t.renderbufferStorageMultisample(36161,c,l,i.width,i.height):st(i)?u.renderbufferStorageMultisampleEXT(36161,c,l,i.width,i.height):t.renderbufferStorage(36161,l,i.width,i.height)}}t.bindRenderbuffer(36161,null)}// Setup resources for a Depth Texture for a FBO (needs an extension)
// Setup GL resources for a non-texture depth buffer
function it(e){const r=n.get(e),s=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture&&!r.__autoAllocateDepthBuffer){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(36160,e),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");// upload an empty depth texture with framebuffer size
n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),Z(r.depthTexture,0);const s=n.get(r.depthTexture).__webglTexture,o=rt(r);if(r.depthTexture.format===P)st(r)?u.framebufferTexture2DMultisampleEXT(36160,36096,3553,s,0,o):t.framebufferTexture2D(36160,36096,3553,s,0);else{if(r.depthTexture.format!==A)throw new Error("Unknown depthTexture format");st(r)?u.framebufferTexture2DMultisampleEXT(36160,33306,3553,s,0,o):t.framebufferTexture2D(36160,33306,3553,s,0)}}(r.__webglFramebuffer,e)}else if(s){r.__webglDepthbuffer=[];for(let n=0;n<6;n++)i.bindFramebuffer(36160,r.__webglFramebuffer[n]),r.__webglDepthbuffer[n]=t.createRenderbuffer(),et(r.__webglDepthbuffer[n],e,!1)}else i.bindFramebuffer(36160,r.__webglFramebuffer),r.__webglDepthbuffer=t.createRenderbuffer(),et(r.__webglDepthbuffer,e,!1);i.bindFramebuffer(36160,null)}// rebind framebuffer with external textures
function rt(t){return Math.min(c,t.samples)}function st(t){const i=n.get(t);return a&&t.samples>0&&!0===e.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function ot(t,i){const n=t.encoding,r=t.format;t.type;return!0===t.isCompressedTexture||!0===t.isVideoTexture||t.format===U||n!==I&&n===k&&!1===a&&(// in WebGL 1, try to use EXT_sRGB extension and unsized formats
!0===e.has("EXT_sRGB")&&r===T?(t.format=U,// it's not possible to generate mips in WebGL 1 with this extension
t.minFilter=y,t.generateMipmaps=!1):// slow fallback (CPU decode)
i=mt.sRGBToLinear(i)),i}
this.allocateTextureUnit=function(){const t=W;return W+=1,t},this.resetTextureUnits=function(){W=0},this.setTexture2D=Z,this.setTexture2DArray=function(t,e){const r=n.get(t);t.version>0&&r.__version!==t.version?$(r,t,e):i.bindTexture(35866,r.__webglTexture,33984+e)},this.setTexture3D=function(t,e){const r=n.get(t);t.version>0&&r.__version!==t.version?$(r,t,e):i.bindTexture(32879,r.__webglTexture,33984+e)},this.setTextureCube=function(e,r){const o=n.get(e);e.version>0&&o.__version!==e.version?function(e,r,o){if(6!==r.image.length)return;const l=K(e,r),c=r.source;i.bindTexture(34067,e.__webglTexture,33984+o);const u=n.get(c);if(c.version!==u.__version||!0===l){i.activeTexture(33984+o),t.pixelStorei(37440,r.flipY),t.pixelStorei(37441,r.premultiplyAlpha),t.pixelStorei(3317,r.unpackAlignment),t.pixelStorei(37443,0);const e=r.isCompressedTexture||r.image[0].isCompressedTexture,n=r.image[0]&&r.image[0].isDataTexture,d=[];for(let t=0;t<6;t++)d[t]=e||n?n?r.image[t].image:r.image[t]:O(r.image[t],!1,!0,h),d[t]=ot(r,d[t]);const f=d[0],p=D(f)||a,g=s.convert(r.format,r.encoding),m=s.convert(r.type),_=F(r.internalFormat,g,m,r.encoding),v=a&&!0!==r.isVideoTexture,y=void 0===u.__version||!0===l;let x,w=j(r,f,p);if(Q(34067,r,p),e){v&&y&&i.texStorage2D(34067,w,_,f.width,f.height);for(let t=0;t<6;t++){x=d[t].mipmaps;for(let e=0;e<x.length;e++){const n=x[e];r.format!==T?null!==g&&(v?i.compressedTexSubImage2D(34069+t,e,0,0,n.width,n.height,g,n.data):i.compressedTexImage2D(34069+t,e,_,n.width,n.height,0,n.data)):v?i.texSubImage2D(34069+t,e,0,0,n.width,n.height,g,m,n.data):i.texImage2D(34069+t,e,_,n.width,n.height,0,g,m,n.data)}}}else{x=r.mipmaps,v&&y&&(// TODO: Uniformly handle mipmap definitions
// Normal textures and compressed cube textures define base level + mips with their mipmap array
// Uncompressed cube textures use their mipmap array only for mips (no base level)
x.length>0&&w++,i.texStorage2D(34067,w,_,d[0].width,d[0].height));for(let t=0;t<6;t++)if(n){v?i.texSubImage2D(34069+t,0,0,0,d[t].width,d[t].height,g,m,d[t].data):i.texImage2D(34069+t,0,_,d[t].width,d[t].height,0,g,m,d[t].data);for(let e=0;e<x.length;e++){const n=x[e].image[t].image;v?i.texSubImage2D(34069+t,e+1,0,0,n.width,n.height,g,m,n.data):i.texImage2D(34069+t,e+1,_,n.width,n.height,0,g,m,n.data)}}else{v?i.texSubImage2D(34069+t,0,0,0,g,m,d[t]):i.texImage2D(34069+t,0,_,g,m,d[t]);for(let e=0;e<x.length;e++){const n=x[e];v?i.texSubImage2D(34069+t,e+1,0,0,g,m,n.image[t]):i.texImage2D(34069+t,e+1,_,g,m,n.image[t])}}}z(r,p)&&// We assume images for cube map have the same size.
N(34067),u.__version=c.version,r.onUpdate&&r.onUpdate(r)}e.__version=r.version}(o,e,r):i.bindTexture(34067,o.__webglTexture,33984+r)},this.rebindTextures=function(t,e,i){const r=n.get(t);void 0!==e&&tt(r.__webglFramebuffer,t,t.texture,36064,3553),void 0!==i&&it(t)}// Set up GL resources for the render target
,this.setupRenderTarget=function(e){const h=e.texture,l=n.get(e),c=n.get(h);e.addEventListener("dispose",H),!0!==e.isWebGLMultipleRenderTargets&&(void 0===c.__webglTexture&&(c.__webglTexture=t.createTexture()),c.__version=h.version,o.memory.textures++);const u=!0===e.isWebGLCubeRenderTarget,d=!0===e.isWebGLMultipleRenderTargets,f=D(e)||a;// Setup framebuffer
if(u){l.__webglFramebuffer=[];for(let e=0;e<6;e++)l.__webglFramebuffer[e]=t.createFramebuffer()}else{if(l.__webglFramebuffer=t.createFramebuffer(),d&&r.drawBuffers){const i=e.texture;for(let e=0,r=i.length;e<r;e++){const r=n.get(i[e]);void 0===r.__webglTexture&&(r.__webglTexture=t.createTexture(),o.memory.textures++)}}if(a&&e.samples>0&&!1===st(e)){const n=d?h:[h];l.__webglMultisampledFramebuffer=t.createFramebuffer(),l.__webglColorRenderbuffer=[],i.bindFramebuffer(36160,l.__webglMultisampledFramebuffer);for(let i=0;i<n.length;i++){const r=n[i];l.__webglColorRenderbuffer[i]=t.createRenderbuffer(),t.bindRenderbuffer(36161,l.__webglColorRenderbuffer[i]);const o=s.convert(r.format,r.encoding),a=s.convert(r.type),h=F(r.internalFormat,o,a,r.encoding,!0===e.isXRRenderTarget),c=rt(e);t.renderbufferStorageMultisample(36161,c,h,e.width,e.height),t.framebufferRenderbuffer(36160,36064+i,36161,l.__webglColorRenderbuffer[i])}t.bindRenderbuffer(36161,null),e.depthBuffer&&(l.__webglDepthRenderbuffer=t.createRenderbuffer(),et(l.__webglDepthRenderbuffer,e,!0)),i.bindFramebuffer(36160,null)}}// Setup color buffer
if(u){i.bindTexture(34067,c.__webglTexture),Q(34067,h,f);for(let t=0;t<6;t++)tt(l.__webglFramebuffer[t],e,h,36064,34069+t);z(h,f)&&N(34067),i.unbindTexture()}else if(d){const t=e.texture;for(let r=0,s=t.length;r<s;r++){const s=t[r],o=n.get(s);i.bindTexture(3553,o.__webglTexture),Q(3553,s,f),tt(l.__webglFramebuffer,e,s,36064+r,3553),z(s,f)&&N(3553)}i.unbindTexture()}else{let t=3553;(e.isWebGL3DRenderTarget||e.isWebGLArrayRenderTarget)&&a&&(t=e.isWebGL3DRenderTarget?32879:35866),i.bindTexture(t,c.__webglTexture),Q(t,h,f),tt(l.__webglFramebuffer,e,h,36064,t),z(h,f)&&N(t),i.unbindTexture()}// Setup depth and stencil buffers
e.depthBuffer&&it(e)},this.updateRenderTargetMipmap=function(t){const e=D(t)||a,r=!0===t.isWebGLMultipleRenderTargets?t.texture:[t.texture];for(let s=0,o=r.length;s<o;s++){const o=r[s];if(z(o,e)){const e=t.isWebGLCubeRenderTarget?34067:3553,r=n.get(o).__webglTexture;i.bindTexture(e,r),N(e),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(e){if(a&&e.samples>0&&!1===st(e)){const r=e.isWebGLMultipleRenderTargets?e.texture:[e.texture],s=e.width,o=e.height;let a=16384;const h=[],l=e.stencilBuffer?33306:36096,c=n.get(e),u=!0===e.isWebGLMultipleRenderTargets;// If MRT we need to remove FBO attachments
if(u)for(let e=0;e<r.length;e++)i.bindFramebuffer(36160,c.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(36160,36064+e,36161,null),i.bindFramebuffer(36160,c.__webglFramebuffer),t.framebufferTexture2D(36009,36064+e,3553,null,0);i.bindFramebuffer(36008,c.__webglMultisampledFramebuffer),i.bindFramebuffer(36009,c.__webglFramebuffer);for(let i=0;i<r.length;i++){h.push(36064+i),e.depthBuffer&&h.push(l);const f=void 0!==c.__ignoreDepthValues&&c.__ignoreDepthValues;if(!1===f&&(e.depthBuffer&&(a|=256),e.stencilBuffer&&(a|=1024)),u&&t.framebufferRenderbuffer(36008,36064,36161,c.__webglColorRenderbuffer[i]),!0===f&&(t.invalidateFramebuffer(36008,[l]),t.invalidateFramebuffer(36009,[l])),u){const e=n.get(r[i]).__webglTexture;t.framebufferTexture2D(36009,36064,3553,e,0)}t.blitFramebuffer(0,0,s,o,0,0,s,o,a,9728),d&&t.invalidateFramebuffer(36008,h)}// If MRT since pre-blit we removed the FBO we need to reconstruct the attachments
if(i.bindFramebuffer(36008,null),i.bindFramebuffer(36009,null),u)for(let e=0;e<r.length;e++){i.bindFramebuffer(36160,c.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(36160,36064+e,36161,c.__webglColorRenderbuffer[e]);const s=n.get(r[e]).__webglTexture;i.bindFramebuffer(36160,c.__webglFramebuffer),t.framebufferTexture2D(36009,36064+e,3553,s,0)}i.bindFramebuffer(36009,c.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=it,this.setupFrameBufferTexture=tt,this.useMultisampledRTT=st}function os(t,e,i){const n=i.isWebGL2;return{convert:function(i,r=null){let s;if(i===w)return 5121;if(1017===i)return 32819;if(1018===i)return 32820;if(1010===i)return 5120;if(1011===i)return 5122;if(1012===i)return 5123;if(1013===i)return 5124;if(i===b)return 5125;if(i===M)return 5126;if(i===S)return n?5131:(s=e.get("OES_texture_half_float"),null!==s?s.HALF_FLOAT_OES:null);if(1021===i)return 6406;if(i===T)return 6408;if(1024===i)return 6409;if(1025===i)return 6410;if(i===P)return 6402;if(i===A)return 34041;// WebGL 1 sRGB fallback
if(i===U)return s=e.get("EXT_sRGB"),null!==s?s.SRGB_ALPHA_EXT:null;// WebGL2 formats.
if(1028===i)return 6403;if(1029===i)return 36244;if(1030===i)return 33319;if(1031===i)return 33320;if(1033===i)return 36249;// S3TC
if(i===E||i===L||i===R||i===O)if(r===k){if(s=e.get("WEBGL_compressed_texture_s3tc_srgb"),null===s)return null;if(i===E)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===L)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===R)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===O)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(s=e.get("WEBGL_compressed_texture_s3tc"),null===s)return null;if(i===E)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===L)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===R)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===O)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}// PVRTC
if(35840===i||35841===i||35842===i||35843===i){if(s=e.get("WEBGL_compressed_texture_pvrtc"),null===s)return null;if(35840===i)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===i)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===i)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===i)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}// ETC1
if(36196===i)return s=e.get("WEBGL_compressed_texture_etc1"),null!==s?s.COMPRESSED_RGB_ETC1_WEBGL:null;// ETC2
if(37492===i||37496===i){if(s=e.get("WEBGL_compressed_texture_etc"),null===s)return null;if(37492===i)return r===k?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(37496===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC}// ASTC
if(37808===i||37809===i||37810===i||37811===i||37812===i||37813===i||37814===i||37815===i||37816===i||37817===i||37818===i||37819===i||37820===i||37821===i){if(s=e.get("WEBGL_compressed_texture_astc"),null===s)return null;if(37808===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===i)return r===k?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}// BPTC
if(i===D){if(s=e.get("EXT_texture_compression_bptc"),null===s)return null;if(i===D)return r===k?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT}// RGTC
if(36283===i||36284===i||36285===i||36286===i){if(s=e.get("EXT_texture_compression_rgtc"),null===s)return null;if(i===D)return s.COMPRESSED_RED_RGTC1_EXT;if(36284===i)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(36285===i)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(36286===i)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}
return i===C?n?34042:(s=e.get("WEBGL_depth_texture"),null!==s?s.UNSIGNED_INT_24_8_WEBGL:null):void 0!==t[i]?t[i]:null;// if "p" can't be resolved, assume the user defines a WebGL constant as a string (fallback/workaround for packed RGB formats)
}}}class as extends Si{constructor(t=[]){super(),this.isArrayCamera=!0,this.cameras=t}}class hs extends Pe{constructor(){super(),this.isGroup=!0,this.type="Group"}}const ls={type:"move"};class cs{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new hs,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new hs,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Tt,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Tt),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new hs,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Tt,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Tt),this._grip}dispatchEvent(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this}connect(t){if(t&&t.hand){const e=this._hand;if(e)for(const i of t.hand.values())// Initialize hand with joints when connected
this._getHandJoint(e,i)}return this.dispatchEvent({type:"connected",data:t}),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(t,e,i){let n=null,r=null,s=null;const o=this._targetRay,a=this._grip,h=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState){if(h&&t.hand){s=!0;for(const s of t.hand.values()){// Update the joints groups with the XRJoint poses
const t=e.getJointPose(s,i),n=this._getHandJoint(h,s);// The transform of this joint will be updated with the joint pose on each frame
null!==t&&(n.matrix.fromArray(t.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.jointRadius=t.radius),n.visible=null!==t}// Custom events
// Check pinchz
const n=h.joints["index-finger-tip"],r=h.joints["thumb-tip"],o=n.position.distanceTo(r.position),a=.02,l=.005;h.inputState.pinching&&o>a+l?(h.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!h.inputState.pinching&&o<=a-l&&(h.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==a&&t.gripSpace&&(r=e.getPose(t.gripSpace,i),null!==r&&(a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),r.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(r.linearVelocity)):a.hasLinearVelocity=!1,r.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(r.angularVelocity)):a.hasAngularVelocity=!1));null!==o&&(n=e.getPose(t.targetRaySpace,i),// Some runtimes (namely Vive Cosmos with Vive OpenXR Runtime) have only grip space and ray space is equal to it
null===n&&null!==r&&(n=r),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(ls)))}return null!==o&&(o.visible=null!==n),null!==a&&(a.visible=null!==r),null!==h&&(h.visible=null!==s),this}// private method
_getHandJoint(t,e){if(void 0===t.joints[e.jointName]){const i=new hs;i.matrixAutoUpdate=!1,i.visible=!1,t.joints[e.jointName]=i,t.add(i)}return t.joints[e.jointName]}}class us extends xt{constructor(t,e,i,n,r,s,o,a,h,l){if((l=void 0!==l?l:P)!==P&&l!==A)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&l===P&&(i=b),void 0===i&&l===A&&(i=C),super(null,n,r,s,o,a,l,i,h),this.isDepthTexture=!0,this.image={width:t,height:e},this.magFilter=void 0!==o?o:_,this.minFilter=void 0!==a?a:_,this.flipY=!1,this.generateMipmaps=!1}}class ds extends G{constructor(e,i){super();const n=this;let r=null,s=1,o=null,a="local-floor",h=1,l=null,c=null,u=null,d=null,f=null,p=null;const g=i.getContextAttributes();let m=null,_=null;const v=[],y=[],x=new Set,M=new Map,S=new Si;S.layers.enable(1),S.viewport=new wt;const E=new Si;E.layers.enable(2),E.viewport=new wt;const L=[S,E],R=new as;R.layers.enable(1),R.layers.enable(2);let O=null,D=null;function I(t){const e=y.indexOf(t.inputSource);if(-1===e)return;const i=v[e];void 0!==i&&i.dispatchEvent({type:t.type,data:t.inputSource})}function k(){r.removeEventListener("select",I),r.removeEventListener("selectstart",I),r.removeEventListener("selectend",I),r.removeEventListener("squeeze",I),r.removeEventListener("squeezestart",I),r.removeEventListener("squeezeend",I),r.removeEventListener("end",k),r.removeEventListener("inputsourceschange",z);for(let t=0;t<v.length;t++){const e=y[t];null!==e&&(y[t]=null,v[t].disconnect(e))}O=null,D=null,// restore framebuffer/rendering state
e.setRenderTarget(m),f=null,d=null,u=null,r=null,_=null,U.stop(),n.isPresenting=!1,n.dispatchEvent({type:"sessionend"})}function z(t){// Notify disconnected
for(let e=0;e<t.removed.length;e++){const i=t.removed[e],n=y.indexOf(i);n>=0&&(y[n]=null,v[n].disconnect(i))}// Notify connected
for(let e=0;e<t.added.length;e++){const i=t.added[e];let n=y.indexOf(i);if(-1===n){// Assign input source a controller that currently has no input source
for(let t=0;t<v.length;t++){if(t>=y.length){y.push(i),n=t;break}if(null===y[t]){y[t]=i,n=t;break}}// If all controllers do currently receive input we ignore new ones
if(-1===n)break}const r=v[n];r&&r.connect(i)}}
this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=v[t];return void 0===e&&(e=new cs,v[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=v[t];return void 0===e&&(e=new cs,v[t]=e),e.getGripSpace()},this.getHand=function(t){let e=v[t];return void 0===e&&(e=new cs,v[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){s=t,n.isPresenting},this.setReferenceSpaceType=function(t){a=t,n.isPresenting},this.getReferenceSpace=function(){return l||o},this.setReferenceSpace=function(t){l=t},this.getBaseLayer=function(){return null!==d?d:f},this.getBinding=function(){return u},this.getFrame=function(){return p},this.getSession=function(){return r},this.setSession=function(){var c,p=(c=function*(t){if(r=t,null!==r){if(m=e.getRenderTarget(),r.addEventListener("select",I),r.addEventListener("selectstart",I),r.addEventListener("selectend",I),r.addEventListener("squeeze",I),r.addEventListener("squeezestart",I),r.addEventListener("squeezeend",I),r.addEventListener("end",k),r.addEventListener("inputsourceschange",z),!0!==g.xrCompatible&&(yield i.makeXRCompatible()),void 0===r.renderState.layers||!1===e.capabilities.isWebGL2){const t={antialias:void 0!==r.renderState.layers||g.antialias,alpha:g.alpha,depth:g.depth,stencil:g.stencil,framebufferScaleFactor:s};f=new XRWebGLLayer(r,i,t),r.updateRenderState({baseLayer:f}),_=new bt(f.framebufferWidth,f.framebufferHeight,{format:T,type:w,encoding:e.outputEncoding,stencilBuffer:g.stencil})}else{let t=null,n=null,o=null;g.depth&&(o=g.stencil?35056:33190,t=g.stencil?A:P,n=g.stencil?C:b);const a={colorFormat:32856,depthFormat:o,scaleFactor:s};u=new XRWebGLBinding(r,i),d=u.createProjectionLayer(a),r.updateRenderState({layers:[d]}),_=new bt(d.textureWidth,d.textureHeight,{format:T,type:w,depthTexture:new us(d.textureWidth,d.textureHeight,n,void 0,void 0,void 0,void 0,void 0,void 0,t),stencilBuffer:g.stencil,encoding:e.outputEncoding,samples:g.antialias?4:0}),e.properties.get(_).__ignoreDepthValues=d.ignoreDepthValues}_.isXRRenderTarget=!0,// TODO Remove this when possible, see #23278
this.setFoveation(h),l=null,o=yield r.requestReferenceSpace(a),U.setContext(r),U.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},function(){var e=this,i=arguments;return new Promise((function(n,r){var s=c.apply(e,i);function o(e){t(s,n,r,o,a,"next",e)}function a(e){t(s,n,r,o,a,"throw",e)}o(void 0)}))});return function(t){return p.apply(this,arguments)}}();const N=new Tt,F=new Tt;function j(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.updateCamera=function(t){if(null===r)return;R.near=E.near=S.near=t.near,R.far=E.far=S.far=t.far,O===R.near&&D===R.far||(// Note that the new renderState won't apply until the next frame. See #18320
r.updateRenderState({depthNear:R.near,depthFar:R.far}),O=R.near,D=R.far);const e=t.parent,i=R.cameras;j(R,e);for(let r=0;r<i.length;r++)j(i[r],e);R.matrixWorld.decompose(R.position,R.quaternion,R.scale),// update user camera and its children
t.matrix.copy(R.matrix),t.matrix.decompose(t.position,t.quaternion,t.scale);const n=t.children;for(let r=0,s=n.length;r<s;r++)n[r].updateMatrixWorld(!0);// update projection matrix for proper view frustum culling
2===i.length?
/**
					 * Assumes 2 cameras that are parallel and share an X-axis, and that
					 * the cameras' projection and world matrices have already been set.
					 * And that near and far planes are identical for both cameras.
					 * Visualization of this technique: https://computergraphics.stackexchange.com/a/4765
					 */
function(t,e,i){N.setFromMatrixPosition(e.matrixWorld),F.setFromMatrixPosition(i.matrixWorld);const n=N.distanceTo(F),r=e.projectionMatrix.elements,s=i.projectionMatrix.elements,o=r[14]/(r[10]-1),a=r[14]/(r[10]+1),h=(r[9]+1)/r[5],l=(r[9]-1)/r[5],c=(r[8]-1)/r[0],u=(s[8]+1)/s[0],d=o*c,f=o*u,p=n/(-c+u),g=p*-c;// TODO: Better way to apply this offset?
e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(g),t.translateZ(p),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();// Find the union of the frustum values of the cameras and scale
// the values so that the near plane's position does not change in world space,
// although must now be relative to the new union camera.
const m=o+p,_=a+p,v=d-g,y=f+(n-g),x=h*a/_*m,w=l*a/_*m;t.projectionMatrix.makePerspective(v,y,x,w,m,_)}(R,S,E):// assume single camera setup (AR)
R.projectionMatrix.copy(S.projectionMatrix)},this.getCamera=function(){return R},this.getFoveation=function(){if(null!==d||null!==f)return h},this.setFoveation=function(t){// 0 = no foveation = full resolution
// 1 = maximum foveation = the edges render at lower resolution
h=t,null!==d&&(d.fixedFoveation=t),null!==f&&void 0!==f.fixedFoveation&&(f.fixedFoveation=t)},this.getPlanes=function(){return x};// Animation Loop
let B=null;const U=new zi;U.setAnimationLoop((function(t,i){if(c=i.getViewerPose(l||o),p=i,null!==c){const t=c.views;null!==f&&(e.setRenderTargetFramebuffer(_,f.framebuffer),e.setRenderTarget(_));let i=!1;// check if it's necessary to rebuild cameraVR's camera list
t.length!==R.cameras.length&&(R.cameras.length=0,i=!0);for(let n=0;n<t.length;n++){const r=t[n];let s=null;if(null!==f)s=f.getViewport(r);else{const t=u.getViewSubImage(d,r);s=t.viewport,// For side-by-side projection, we only produce a single texture for both eyes.
0===n&&(e.setRenderTargetTextures(_,t.colorTexture,d.ignoreDepthValues?void 0:t.depthStencilTexture),e.setRenderTarget(_))}let o=L[n];void 0===o&&(o=new Si,o.layers.enable(n),o.viewport=new wt,L[n]=o),o.matrix.fromArray(r.transform.matrix),o.projectionMatrix.fromArray(r.projectionMatrix),o.viewport.set(s.x,s.y,s.width,s.height),0===n&&R.matrix.copy(o.matrix),!0===i&&R.cameras.push(o)}}
for(let e=0;e<v.length;e++){const t=y[e],n=v[e];null!==t&&void 0!==n&&n.update(t,i,l||o)}if(B&&B(t,i),i.detectedPlanes){n.dispatchEvent({type:"planesdetected",data:i.detectedPlanes});let t=null;for(const e of x)i.detectedPlanes.has(e)||(null===t&&(t=[]),t.push(e));if(null!==t)for(const e of t)x.delete(e),M.delete(e),n.dispatchEvent({type:"planeremoved",data:e});for(const e of i.detectedPlanes)if(x.has(e)){const t=M.get(e);e.lastChangedTime>t&&(M.set(e,e.lastChangedTime),n.dispatchEvent({type:"planechanged",data:e}))}else x.add(e),M.set(e,i.lastChangedTime),n.dispatchEvent({type:"planeadded",data:e})}p=null})),this.setAnimationLoop=function(t){B=t},this.dispose=function(){}}}function fs(t,e){function i(i,n){i.opacity.value=n.opacity,n.color&&i.diffuse.value.copy(n.color),n.emissive&&i.emissive.value.copy(n.emissive).multiplyScalar(n.emissiveIntensity),n.map&&(i.map.value=n.map),n.alphaMap&&(i.alphaMap.value=n.alphaMap),n.bumpMap&&(i.bumpMap.value=n.bumpMap,i.bumpScale.value=n.bumpScale,1===n.side&&(i.bumpScale.value*=-1)),n.displacementMap&&(i.displacementMap.value=n.displacementMap,i.displacementScale.value=n.displacementScale,i.displacementBias.value=n.displacementBias),n.emissiveMap&&(i.emissiveMap.value=n.emissiveMap),n.normalMap&&(i.normalMap.value=n.normalMap,i.normalScale.value.copy(n.normalScale),1===n.side&&i.normalScale.value.negate()),n.specularMap&&(i.specularMap.value=n.specularMap),n.alphaTest>0&&(i.alphaTest.value=n.alphaTest);const r=e.get(n).envMap;if(r&&(i.envMap.value=r,i.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,i.reflectivity.value=n.reflectivity,i.ior.value=n.ior,i.refractionRatio.value=n.refractionRatio),n.lightMap){i.lightMap.value=n.lightMap;// artist-friendly light intensity scaling factor
const e=!0!==t.physicallyCorrectLights?Math.PI:1;i.lightMapIntensity.value=n.lightMapIntensity*e}// uv repeat and offset setting priorities
// 1. color map
// 2. specular map
// 3. displacementMap map
// 4. normal map
// 5. bump map
// 6. roughnessMap map
// 7. metalnessMap map
// 8. alphaMap map
// 9. emissiveMap map
// 10. clearcoat map
// 11. clearcoat normal map
// 12. clearcoat roughnessMap map
// 13. iridescence map
// 14. iridescence thickness map
// 15. specular intensity map
// 16. specular tint map
// 17. transmission map
// 18. thickness map
let s,o;n.aoMap&&(i.aoMap.value=n.aoMap,i.aoMapIntensity.value=n.aoMapIntensity),n.map?s=n.map:n.specularMap?s=n.specularMap:n.displacementMap?s=n.displacementMap:n.normalMap?s=n.normalMap:n.bumpMap?s=n.bumpMap:n.roughnessMap?s=n.roughnessMap:n.metalnessMap?s=n.metalnessMap:n.alphaMap?s=n.alphaMap:n.emissiveMap?s=n.emissiveMap:n.clearcoatMap?s=n.clearcoatMap:n.clearcoatNormalMap?s=n.clearcoatNormalMap:n.clearcoatRoughnessMap?s=n.clearcoatRoughnessMap:n.iridescenceMap?s=n.iridescenceMap:n.iridescenceThicknessMap?s=n.iridescenceThicknessMap:n.specularIntensityMap?s=n.specularIntensityMap:n.specularColorMap?s=n.specularColorMap:n.transmissionMap?s=n.transmissionMap:n.thicknessMap?s=n.thicknessMap:n.sheenColorMap?s=n.sheenColorMap:n.sheenRoughnessMap&&(s=n.sheenRoughnessMap),void 0!==s&&(// backwards compatibility
s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),i.uvTransform.value.copy(s.matrix)),n.aoMap?o=n.aoMap:n.lightMap&&(o=n.lightMap),void 0!==o&&(// backwards compatibility
o.isWebGLRenderTarget&&(o=o.texture),!0===o.matrixAutoUpdate&&o.updateMatrix(),i.uv2Transform.value.copy(o.matrix))}return{refreshFogUniforms:function(e,i){i.color.getRGB(e.fogColor.value,xi(t)),i.isFog?(e.fogNear.value=i.near,e.fogFar.value=i.far):i.isFogExp2&&(e.fogDensity.value=i.density)},refreshMaterialUniforms:function(t,n,r,s,o){n.isMeshBasicMaterial||n.isMeshLambertMaterial?i(t,n):n.isMeshToonMaterial?(i(t,n),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap)}(t,n)):n.isMeshPhongMaterial?(i(t,n),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4)}(t,n)):n.isMeshStandardMaterial?(i(t,n),function(t,i){t.roughness.value=i.roughness,t.metalness.value=i.metalness,i.roughnessMap&&(t.roughnessMap.value=i.roughnessMap);i.metalnessMap&&(t.metalnessMap.value=i.metalnessMap);const n=e.get(i).envMap;n&&(//uniforms.envMap.value = material.envMap; // part of uniforms common
t.envMapIntensity.value=i.envMapIntensity)}(t,n),n.isMeshPhysicalMaterial&&function(t,e,i){// also part of uniforms common
t.ior.value=e.ior,e.sheen>0&&(t.sheenColor.value.copy(e.sheenColor).multiplyScalar(e.sheen),t.sheenRoughness.value=e.sheenRoughness,e.sheenColorMap&&(t.sheenColorMap.value=e.sheenColorMap),e.sheenRoughnessMap&&(t.sheenRoughnessMap.value=e.sheenRoughnessMap));e.clearcoat>0&&(t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap),e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap),e.clearcoatNormalMap&&(t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),t.clearcoatNormalMap.value=e.clearcoatNormalMap,1===e.side&&t.clearcoatNormalScale.value.negate()));e.iridescence>0&&(t.iridescence.value=e.iridescence,t.iridescenceIOR.value=e.iridescenceIOR,t.iridescenceThicknessMinimum.value=e.iridescenceThicknessRange[0],t.iridescenceThicknessMaximum.value=e.iridescenceThicknessRange[1],e.iridescenceMap&&(t.iridescenceMap.value=e.iridescenceMap),e.iridescenceThicknessMap&&(t.iridescenceThicknessMap.value=e.iridescenceThicknessMap));e.transmission>0&&(t.transmission.value=e.transmission,t.transmissionSamplerMap.value=i.texture,t.transmissionSamplerSize.value.set(i.width,i.height),e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap),t.thickness.value=e.thickness,e.thicknessMap&&(t.thicknessMap.value=e.thicknessMap),t.attenuationDistance.value=e.attenuationDistance,t.attenuationColor.value.copy(e.attenuationColor));t.specularIntensity.value=e.specularIntensity,t.specularColor.value.copy(e.specularColor),e.specularIntensityMap&&(t.specularIntensityMap.value=e.specularIntensityMap);e.specularColorMap&&(t.specularColorMap.value=e.specularColorMap)}(t,n,o)):n.isMeshMatcapMaterial?(i(t,n),function(t,e){e.matcap&&(t.matcap.value=e.matcap)}(t,n)):n.isMeshDepthMaterial?i(t,n):n.isMeshDistanceMaterial?(i(t,n),function(t,e){t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(t,n)):n.isMeshNormalMaterial?i(t,n):n.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity}(t,n),n.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,n)):n.isPointsMaterial?function(t,e,i,n){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*i,t.scale.value=.5*n,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);e.alphaTest>0&&(t.alphaTest.value=e.alphaTest);// uv repeat and offset setting priorities
// 1. color map
// 2. alpha map
let r;e.map?r=e.map:e.alphaMap&&(r=e.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix))}(t,n,r,s):n.isSpriteMaterial?function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);e.alphaTest>0&&(t.alphaTest.value=e.alphaTest);// uv repeat and offset setting priorities
// 1. color map
// 2. alpha map
let i;e.map?i=e.map:e.alphaMap&&(i=e.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}(t,n):n.isShadowMaterial?(t.color.value.copy(n.color),t.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function ps(t,e,i,n){let r={},s={},o=[];const a=i.isWebGL2?t.getParameter(35375):0;// binding points are global whereas block indices are per shader program
function h(t,e,i){const n=t.value;if(void 0===i[e]){// cache entry does not exist so far
if("number"==typeof n)i[e]=n;else{const t=Array.isArray(n)?n:[n],r=[];for(let e=0;e<t.length;e++)r.push(t[e].clone());i[e]=r}return!0}// compare current value with cached entry
if("number"==typeof n){if(i[e]!==n)return i[e]=n,!0}else{const t=Array.isArray(i[e])?i[e]:[i[e]],r=Array.isArray(n)?n:[n];for(let e=0;e<t.length;e++){const i=t[e];if(!1===i.equals(r[e]))return i.copy(r[e]),!0}}return!1}function l(t){const e={boundary:0,// bytes
storage:0};// determine sizes according to STD140
return"number"==typeof t?(// float/int
e.boundary=4,e.storage=4):t.isVector2?(// vec2
e.boundary=8,e.storage=8):t.isVector3||t.isColor?(// vec3
e.boundary=16,e.storage=12):t.isVector4?(// vec4
e.boundary=16,e.storage=16):t.isMatrix3?(// mat3 (in STD140 a 3x3 matrix is represented as 3x4)
e.boundary=48,e.storage=48):t.isMatrix4?(// mat4
e.boundary=64,e.storage=64):t.isTexture,e}function c(e){const i=e.target;i.removeEventListener("dispose",c);const n=o.indexOf(i.__bindingPointIndex);o.splice(n,1),t.deleteBuffer(r[i.id]),delete r[i.id],delete s[i.id]}return{bind:function(t,e){const i=e.program;n.uniformBlockBinding(t,i)},update:function(i,u){let d=r[i.id];void 0===d&&(!function(t){// determine total buffer size according to the STD140 layout
// Hint: STD140 is the only supported layout in WebGL 2
const e=t.uniforms;let i=0;// global buffer offset in bytes
const n=16;// size of a chunk in bytes
let r=0;// offset within a single chunk in bytes
for(let s=0,o=e.length;s<o;s++){const t=e[s],o={boundary:0,// bytes
storage:0},a=Array.isArray(t.value)?t.value:[t.value];for(let e=0,i=a.length;e<i;e++){const t=l(a[e]);o.boundary+=t.boundary,o.storage+=t.storage}// the following two properties will be used for partial buffer updates
if(t.__data=new Float32Array(o.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=i,s>0){r=i%n;// check for chunk overflow
0!==r&&n-r-o.boundary<0&&(// add padding and adjust offset
i+=n-r,t.__offset=i)}i+=o.storage}// ensure correct final padding
r=i%n,r>0&&(i+=n-r);
t.__size=i,t.__cache={}}(i),d=function(e){// the setup of an UBO is independent of a particular shader program but global
const i=function(){for(let t=0;t<a;t++)if(-1===o.indexOf(t))return o.push(t),t;return 0}();e.__bindingPointIndex=i;const n=t.createBuffer(),r=e.__size,s=e.usage;return t.bindBuffer(35345,n),t.bufferData(35345,r,s),t.bindBuffer(35345,null),t.bindBufferBase(35345,i,n),n}(i),r[i.id]=d,i.addEventListener("dispose",c));// ensure to update the binding points/block indices mapping for this program
const f=u.program;n.updateUBOMapping(i,f);// update UBO once per frame
const p=e.render.frame;s[i.id]!==p&&(!function(e){const i=r[e.id],n=e.uniforms,s=e.__cache;t.bindBuffer(35345,i);for(let r=0,o=n.length;r<o;r++){const e=n[r];// partly update the buffer if necessary
if(!0===h(e,r,s)){const i=e.__offset,n=Array.isArray(e.value)?e.value:[e.value];let r=0;for(let s=0;s<n.length;s++){const o=n[s],a=l(o);"number"==typeof o?(e.__data[0]=o,t.bufferSubData(35345,i+r,e.__data)):o.isMatrix3?(// manually converting 3x3 to 3x4
e.__data[0]=o.elements[0],e.__data[1]=o.elements[1],e.__data[2]=o.elements[2],e.__data[3]=o.elements[0],e.__data[4]=o.elements[3],e.__data[5]=o.elements[4],e.__data[6]=o.elements[5],e.__data[7]=o.elements[0],e.__data[8]=o.elements[6],e.__data[9]=o.elements[7],e.__data[10]=o.elements[8],e.__data[11]=o.elements[0]):(o.toArray(e.__data,r),r+=a.storage/Float32Array.BYTES_PER_ELEMENT)}t.bufferSubData(35345,i,e.__data)}}t.bindBuffer(35345,null)}(i),s[i.id]=p)},dispose:function(){for(const e in r)t.deleteBuffer(r[e]);o=[],r={},s={}}}}function gs(t={}){this.isWebGLRenderer=!0;const e=void 0!==t.canvas?t.canvas:function(){const t=nt("canvas");return t.style.display="block",t}(),n=void 0!==t.context?t.context:null,r=void 0===t.depth||t.depth,s=void 0===t.stencil||t.stencil,o=void 0!==t.antialias&&t.antialias,a=void 0===t.premultipliedAlpha||t.premultipliedAlpha,h=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,l=void 0!==t.powerPreference?t.powerPreference:"default",c=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat;let u;u=null!==n?n.getContextAttributes().alpha:void 0!==t.alpha&&t.alpha;let d=null,f=null;// render() can be called from within a callback triggered by another render.
// We track this so that the nested render call gets its list and state isolated from the parent render call.
const p=[],g=[];// public properties
this.domElement=e,// Debug configuration container
this.debug={
/**
					 * Enables error checking and reporting when shader programs are being compiled
					 * @type {boolean}
					 */
checkShaderErrors:!0},// clearing
this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,// scene graph
this.sortObjects=!0,// user-defined clipping
this.clippingPlanes=[],this.localClippingEnabled=!1,// physically based shading
this.outputEncoding=I,// physical lights
this.physicallyCorrectLights=!1,// tone mapping
this.toneMapping=0,this.toneMappingExposure=1;// internal properties
const m=this;let _=!1,v=0,y=0,b=null,C=-1,P=null;// internal state cache
const A=new wt,E=new wt;let L=null,R=e.width,O=e.height,D=1,k=null,z=null;
const N=new wt(0,0,R,O),F=new wt(0,0,R,O);let j=!1;// frustum
const B=new ki;// clipping
let U=!1,G=!1,H=null;// camera matrices cache
const V=new ie,W=new $,Z=new Tt,q={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function X(){return null===b?D:1}// initialize
let J,Q,K,tt,et,it,rt,st,ot,at,ht,lt,ct,ut,dt,ft,pt,gt,mt,_t,vt,yt,xt,Mt,St=n;function Ct(t,i){for(let n=0;n<t.length;n++){const r=t[n],s=e.getContext(r,i);if(null!==s)return s}return null}try{const t={alpha:!0,depth:r,stencil:s,antialias:o,premultipliedAlpha:a,preserveDrawingBuffer:h,powerPreference:l,failIfMajorPerformanceCaveat:c};// OffscreenCanvas does not have setAttribute, see #22811
if("setAttribute"in e&&e.setAttribute("data-engine",`three.js r${i}`),// event listeners must be registered before WebGL context is created, see #12753
e.addEventListener("webglcontextlost",Et,!1),e.addEventListener("webglcontextrestored",Lt,!1),e.addEventListener("webglcontextcreationerror",Rt,!1),null===St){const e=["webgl2","webgl","experimental-webgl"];if(!0===m.isWebGL1Renderer&&e.shift(),St=Ct(e,t),null===St)throw Ct(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}// Some experimental-webgl implementations do not have getShaderPrecisionFormat
void 0===St.getShaderPrecisionFormat&&(St.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(Ht){throw Ht}function Pt(){J=new dn(St),Q=new Zi(St,J,t),J.init(Q),yt=new os(St,J,Q),K=new rs(St,J,Q),tt=new gn,et=new Vr,it=new ss(St,J,K,et,Q,yt,tt),rt=new Xi(m),st=new un(m),ot=new Ni(St,Q),xt=new Vi(St,J,ot,Q),at=new fn(St,ot,tt,xt),ht=new yn(St,at,ot,tt),mt=new vn(St,Q,it),ft=new qi(et),lt=new Hr(m,rt,st,J,Q,xt,ft),ct=new fs(m,et),ut=new Xr,dt=new ts(J,Q),gt=new Hi(m,rt,st,K,ht,u,a),pt=new ns(m,ht,Q),Mt=new ps(St,tt,Q,K),_t=new Wi(St,J,tt,Q),vt=new pn(St,J,tt,Q),tt.programs=lt.programs,m.capabilities=Q,m.extensions=J,m.properties=et,m.renderLists=ut,m.shadowMap=pt,m.state=K,m.info=tt}Pt();// xr
const At=new ds(m,St);// Events
function Et(t){t.preventDefault(),_=!0}function Lt(){_=!1;const t=tt.autoReset,e=pt.enabled,i=pt.autoUpdate,n=pt.needsUpdate,r=pt.type;Pt(),tt.autoReset=t,pt.enabled=e,pt.autoUpdate=i,pt.needsUpdate=n,pt.type=r}function Rt(t){}function Ot(t){const e=t.target;e.removeEventListener("dispose",Ot),// Buffer deallocation
function(t){(function(t){const e=et.get(t).programs;void 0!==e&&(e.forEach((function(t){lt.releaseProgram(t)})),t.isShaderMaterial&&lt.releaseShaderCache(t))}// Buffer rendering
)(t),et.remove(t)}(e)}this.xr=At,// API
this.getContext=function(){return St},this.getContextAttributes=function(){return St.getContextAttributes()},this.forceContextLoss=function(){const t=J.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=J.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return D},this.setPixelRatio=function(t){void 0!==t&&(D=t,this.setSize(R,O,!1))},this.getSize=function(t){return t.set(R,O)},this.setSize=function(t,i,n){At.isPresenting||(R=t,O=i,e.width=Math.floor(t*D),e.height=Math.floor(i*D),!1!==n&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return t.set(R*D,O*D).floor()},this.setDrawingBufferSize=function(t,i,n){R=t,O=i,D=n,e.width=Math.floor(t*n),e.height=Math.floor(i*n),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return t.copy(A)},this.getViewport=function(t){return t.copy(N)},this.setViewport=function(t,e,i,n){t.isVector4?N.set(t.x,t.y,t.z,t.w):N.set(t,e,i,n),K.viewport(A.copy(N).multiplyScalar(D).floor())},this.getScissor=function(t){return t.copy(F)},this.setScissor=function(t,e,i,n){t.isVector4?F.set(t.x,t.y,t.z,t.w):F.set(t,e,i,n),K.scissor(E.copy(F).multiplyScalar(D).floor())},this.getScissorTest=function(){return j},this.setScissorTest=function(t){K.setScissorTest(j=t)},this.setOpaqueSort=function(t){k=t},this.setTransparentSort=function(t){z=t},// Clearing
this.getClearColor=function(t){return t.copy(gt.getClearColor())},this.setClearColor=function(){gt.setClearColor.apply(gt,arguments)},this.getClearAlpha=function(){return gt.getClearAlpha()},this.setClearAlpha=function(){gt.setClearAlpha.apply(gt,arguments)},this.clear=function(t=!0,e=!0,i=!0){let n=0;t&&(n|=16384),e&&(n|=256),i&&(n|=1024),St.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",Et,!1),e.removeEventListener("webglcontextrestored",Lt,!1),e.removeEventListener("webglcontextcreationerror",Rt,!1),ut.dispose(),dt.dispose(),et.dispose(),rt.dispose(),st.dispose(),ht.dispose(),xt.dispose(),Mt.dispose(),lt.dispose(),At.dispose(),At.removeEventListener("sessionstart",It),At.removeEventListener("sessionend",kt),H&&(H.dispose(),H=null),zt.stop()},this.renderBufferDirect=function(t,e,i,n,r,s){null===e&&(e=q);// renderBufferDirect second parameter used to be fog (could be null)
const o=r.isMesh&&r.matrixWorld.determinant()<0,a=function(t,e,i,n,r){!0!==e.isScene&&(e=q);// scene could be a Mesh, Line, Points, ...
it.resetTextureUnits();const s=e.fog,o=n.isMeshStandardMaterial?e.environment:null,a=null===b?m.outputEncoding:!0===b.isXRRenderTarget?b.texture.encoding:I,h=(n.isMeshStandardMaterial?st:rt).get(n.envMap||o),l=!0===n.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,c=!!n.normalMap&&!!i.attributes.tangent,u=!!i.morphAttributes.position,d=!!i.morphAttributes.normal,p=!!i.morphAttributes.color,g=n.toneMapped?m.toneMapping:0,_=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,v=void 0!==_?_.length:0,y=et.get(n),x=f.state.lights;if(!0===U&&(!0===G||t!==P)){const e=t===P&&n.id===C;// we might want to call this function with some ClippingGroup
// object instead of the material, once it becomes feasible
// (#8465, #8379)
ft.setState(n,t,e)}
let w=!1;n.version===y.__version?y.needsLights&&y.lightsStateVersion!==x.state.version||y.outputEncoding!==a||r.isInstancedMesh&&!1===y.instancing?w=!0:r.isInstancedMesh||!0!==y.instancing?r.isSkinnedMesh&&!1===y.skinning?w=!0:r.isSkinnedMesh||!0!==y.skinning?y.envMap!==h||!0===n.fog&&y.fog!==s?w=!0:void 0===y.numClippingPlanes||y.numClippingPlanes===ft.numPlanes&&y.numIntersection===ft.numIntersection?(y.vertexAlphas!==l||y.vertexTangents!==c||y.morphTargets!==u||y.morphNormals!==d||y.morphColors!==p||y.toneMapping!==g||!0===Q.isWebGL2&&y.morphTargetsCount!==v)&&(w=!0):w=!0:w=!0:w=!0:(w=!0,y.__version=n.version);
let M=y.currentProgram;!0===w&&(M=Ut(n,e,r));let S=!1,T=!1,A=!1;const E=M.getUniforms(),L=y.uniforms;K.useProgram(M.program)&&(S=!0,T=!0,A=!0);n.id!==C&&(C=n.id,T=!0);if(S||P!==t){// load material specific uniforms
// (shader material also gets them for the sake of genericity)
if(E.setValue(St,"projectionMatrix",t.projectionMatrix),Q.logarithmicDepthBuffer&&E.setValue(St,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),P!==t&&(P=t,// lighting uniforms depend on the camera so enforce an update
// now, in case this material supports lights - or later, when
// the next material that does gets activated:
T=!0,// set to true on material change
A=!0),n.isShaderMaterial||n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshStandardMaterial||n.envMap){const e=E.map.cameraPosition;void 0!==e&&e.setValue(St,Z.setFromMatrixPosition(t.matrixWorld))}(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial)&&E.setValue(St,"isOrthographic",!0===t.isOrthographicCamera),(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial||n.isShadowMaterial||r.isSkinnedMesh)&&E.setValue(St,"viewMatrix",t.matrixWorldInverse)}// skinning and morph target uniforms must be set even if material didn't change
// auto-setting of texture unit for bone and morph texture must go before other textures
// otherwise textures used for skinning and morphing can take over texture units reserved for other material textures
if(r.isSkinnedMesh){E.setOptional(St,r,"bindMatrix"),E.setOptional(St,r,"bindMatrixInverse");const t=r.skeleton;t&&Q.floatVertexTextures&&(null===t.boneTexture&&t.computeBoneTexture(),E.setValue(St,"boneTexture",t.boneTexture,it),E.setValue(St,"boneTextureSize",t.boneTextureSize))}const R=i.morphAttributes;(void 0!==R.position||void 0!==R.normal||void 0!==R.color&&!0===Q.isWebGL2)&&mt.update(r,i,n,M);(T||y.receiveShadow!==r.receiveShadow)&&(y.receiveShadow=r.receiveShadow,E.setValue(St,"receiveShadow",r.receiveShadow));// https://github.com/mrdoob/three.js/pull/24467#issuecomment-1209031512
n.isMeshGouraudMaterial&&null!==n.envMap&&(L.envMap.value=h,L.flipEnvMap.value=h.isCubeTexture&&!1===h.isRenderTargetTexture?-1:1);T&&(E.setValue(St,"toneMappingExposure",m.toneMappingExposure),y.needsLights&&(// the current material requires lighting info
// note: all lighting uniforms are always set correctly
// they simply reference the renderer's state for their
// values
// use the current material's .needsUpdate flags to set
// the GL state when required
z=A,(k=L).ambientLightColor.needsUpdate=z,k.lightProbe.needsUpdate=z,k.directionalLights.needsUpdate=z,k.directionalLightShadows.needsUpdate=z,k.pointLights.needsUpdate=z,k.pointLightShadows.needsUpdate=z,k.spotLights.needsUpdate=z,k.spotLightShadows.needsUpdate=z,k.rectAreaLights.needsUpdate=z,k.hemisphereLights.needsUpdate=z),// refresh uniforms common to several materials
s&&!0===n.fog&&ct.refreshFogUniforms(L,s),ct.refreshMaterialUniforms(L,n,D,O,H),Mr.upload(St,y.uniformsList,L,it));// If uniforms are marked as clean, they don't need to be loaded to the GPU.
var k,z;n.isShaderMaterial&&!0===n.uniformsNeedUpdate&&(Mr.upload(St,y.uniformsList,L,it),n.uniformsNeedUpdate=!1);n.isSpriteMaterial&&E.setValue(St,"center",r.center);// common matrices
// UBOs
if(E.setValue(St,"modelViewMatrix",r.modelViewMatrix),E.setValue(St,"normalMatrix",r.normalMatrix),E.setValue(St,"modelMatrix",r.matrixWorld),n.isShaderMaterial||n.isRawShaderMaterial){const t=n.uniformsGroups;for(let e=0,i=t.length;e<i;e++)if(Q.isWebGL2){const i=t[e];Mt.update(i,M),Mt.bind(i,M)}}return M}(t,e,i,n,r);K.setMaterial(n,o);let h=i.index,l=1;!0===n.wireframe&&(h=at.getWireframeAttribute(i),l=2);
const c=i.drawRange,u=i.attributes.position;let d=c.start*l,p=(c.start+c.count)*l;null!==s&&(d=Math.max(d,s.start*l),p=Math.min(p,(s.start+s.count)*l)),null!==h?(d=Math.max(d,0),p=Math.min(p,h.count)):null!=u&&(d=Math.max(d,0),p=Math.min(p,u.count));const g=p-d;if(g<0||g===1/0)return;
let _;xt.setup(r,n,a,i,h);let v=_t;if(null!==h&&(_=ot.get(h),v=vt,v.setIndex(_)),r.isMesh)!0===n.wireframe?(K.setLineWidth(n.wireframeLinewidth*X()),v.setMode(1)):v.setMode(4);else if(r.isLine){let t=n.linewidth;void 0===t&&(t=1),// Not using Line*Material
K.setLineWidth(t*X()),r.isLineSegments?v.setMode(1):r.isLineLoop?v.setMode(2):v.setMode(3)}else r.isPoints?v.setMode(0):r.isSprite&&v.setMode(4);if(r.isInstancedMesh)v.renderInstances(d,g,r.count);else if(i.isInstancedBufferGeometry){const t=void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0,e=Math.min(i.instanceCount,t);v.renderInstances(d,g,e)}else v.render(d,g)},// Compile
this.compile=function(t,e){function i(t,e,i){!0===t.transparent&&2===t.side&&!1===t.forceSinglePass?(t.side=1,t.needsUpdate=!0,Ut(t,e,i),t.side=0,t.needsUpdate=!0,Ut(t,e,i),t.side=2):Ut(t,e,i)}f=dt.get(t),f.init(),g.push(f),t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(f.pushLight(t),t.castShadow&&f.pushShadow(t))})),f.setupLights(m.physicallyCorrectLights),t.traverse((function(e){const n=e.material;if(n)if(Array.isArray(n))for(let r=0;r<n.length;r++){i(n[r],t,e)}else i(n,t,e)})),g.pop(),f=null};// Animation Loop
let Dt=null;function It(){zt.stop()}function kt(){zt.start()}const zt=new zi;function Nt(t,e,i,n){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)f.pushLight(t),t.castShadow&&f.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||B.intersectsSprite(t)){n&&Z.setFromMatrixPosition(t.matrixWorld).applyMatrix4(V);const e=ht.update(t),r=t.material;r.visible&&d.push(t,e,r,i,Z.z,null)}}else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==tt.render.frame&&(t.skeleton.update(),t.skeleton.frame=tt.render.frame),!t.frustumCulled||B.intersectsObject(t))){n&&Z.setFromMatrixPosition(t.matrixWorld).applyMatrix4(V);const e=ht.update(t),r=t.material;if(Array.isArray(r)){const n=e.groups;for(let s=0,o=n.length;s<o;s++){const o=n[s],a=r[o.materialIndex];a&&a.visible&&d.push(t,e,a,i,Z.z,o)}}else r.visible&&d.push(t,e,r,i,Z.z,null)}const r=t.children;for(let s=0,o=r.length;s<o;s++)Nt(r[s],e,i,n)}function Ft(t,e,i,n){const r=t.opaque,s=t.transmissive,a=t.transparent;f.setupLightsView(i),!0===U&&ft.setGlobalState(m.clippingPlanes,i),s.length>0&&function(t,e,i){const n=Q.isWebGL2;null===H&&(H=new bt(1,1,{generateMipmaps:!0,type:J.has("EXT_color_buffer_half_float")?S:w,minFilter:x,samples:n&&!0===o?4:0}));m.getDrawingBufferSize(W),n?H.setSize(W.x,W.y):H.setSize(Y(W.x),Y(W.y));
const r=m.getRenderTarget();m.setRenderTarget(H),m.clear();// Turn off the features which can affect the frag color for opaque objects pass.
// Otherwise they are applied twice in opaque objects pass and transmission objects pass.
const s=m.toneMapping;m.toneMapping=0,jt(t,e,i),m.toneMapping=s,it.updateMultisampleRenderTarget(H),it.updateRenderTargetMipmap(H),m.setRenderTarget(r)}(r,e,i),n&&K.viewport(A.copy(n)),r.length>0&&jt(r,e,i),s.length>0&&jt(s,e,i),a.length>0&&jt(a,e,i),// Ensure depth buffer writing is enabled so it can be cleared on next render
K.buffers.depth.setTest(!0),K.buffers.depth.setMask(!0),K.buffers.color.setMask(!0),K.setPolygonOffset(!1)}function jt(t,e,i){const n=!0===e.isScene?e.overrideMaterial:null;for(let r=0,s=t.length;r<s;r++){const s=t[r],o=s.object,a=s.geometry,h=null===n?s.material:n,l=s.group;o.layers.test(i.layers)&&Bt(o,e,i,a,h,l)}}function Bt(t,e,i,n,r,s){t.onBeforeRender(m,e,i,n,r,s),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),r.onBeforeRender(m,e,i,n,t,s),!0===r.transparent&&2===r.side&&!1===r.forceSinglePass?(r.side=1,r.needsUpdate=!0,m.renderBufferDirect(i,e,n,r,t,s),r.side=0,r.needsUpdate=!0,m.renderBufferDirect(i,e,n,r,t,s),r.side=2):m.renderBufferDirect(i,e,n,r,t,s),t.onAfterRender(m,e,i,n,r,s)}function Ut(t,e,i){!0!==e.isScene&&(e=q);// scene could be a Mesh, Line, Points, ...
const n=et.get(t),r=f.state.lights,s=f.state.shadowsArray,o=r.state.version,a=lt.getParameters(t,r.state,s,e,i),h=lt.getProgramCacheKey(a);let l=n.programs;// always update environment and fog - changing these trigger an getProgram call, but it's possible that the program doesn't change
n.environment=t.isMeshStandardMaterial?e.environment:null,n.fog=e.fog,n.envMap=(t.isMeshStandardMaterial?st:rt).get(t.envMap||n.environment),void 0===l&&(// new material
t.addEventListener("dispose",Ot),l=new Map,n.programs=l);let c=l.get(h);if(void 0!==c){// early out if program and light state is identical
if(n.currentProgram===c&&n.lightsStateVersion===o)return Gt(t,a),c}else a.uniforms=lt.getUniforms(t),t.onBuild(i,a,m),t.onBeforeCompile(a,m),c=lt.acquireProgram(a,h),l.set(h,c),n.uniforms=a.uniforms;const u=n.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(u.clippingPlanes=ft.uniform),Gt(t,a),// store the light setup it was created for
n.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),n.lightsStateVersion=o,n.needsLights&&(// wire up the material to this renderer's lighting state
u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotLightMatrix.value=r.state.spotLightMatrix,u.spotLightMap.value=r.state.spotLightMap,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix);const d=c.getUniforms(),p=Mr.seqWithValue(d.seq,u);return n.currentProgram=c,n.uniformsList=p,c}function Gt(t,e){const i=et.get(t);i.outputEncoding=e.outputEncoding,i.instancing=e.instancing,i.skinning=e.skinning,i.morphTargets=e.morphTargets,i.morphNormals=e.morphNormals,i.morphColors=e.morphColors,i.morphTargetsCount=e.morphTargetsCount,i.numClippingPlanes=e.numClippingPlanes,i.numIntersection=e.numClipIntersection,i.vertexAlphas=e.vertexAlphas,i.vertexTangents=e.vertexTangents,i.toneMapping=e.toneMapping}zt.setAnimationLoop((function(t){Dt&&Dt(t)})),"undefined"!=typeof self&&zt.setContext(self),this.setAnimationLoop=function(t){Dt=t,At.setAnimationLoop(t),null===t?zt.stop():zt.start()},At.addEventListener("sessionstart",It),At.addEventListener("sessionend",kt),// Rendering
this.render=function(t,e){if(void 0!==e&&!0!==e.isCamera)return;if(!0===_)return;// update scene graph
!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),// update camera matrices and frustum
null===e.parent&&!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),!0===At.enabled&&!0===At.isPresenting&&(!0===At.cameraAutoUpdate&&At.updateCamera(e),e=At.getCamera()),!0===t.isScene&&t.onBeforeRender(m,t,e,b),f=dt.get(t,g.length),f.init(),g.push(f),V.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),B.setFromProjectionMatrix(V),G=this.localClippingEnabled,U=ft.init(this.clippingPlanes,G),d=ut.get(t,p.length),d.init(),p.push(d),Nt(t,e,0,m.sortObjects),d.finish(),!0===m.sortObjects&&d.sort(k,z),!0===U&&ft.beginShadows();const i=f.state.shadowsArray;if(pt.render(i,t,e),!0===U&&ft.endShadows(),!0===this.info.autoReset&&this.info.reset(),gt.render(d,t),// render scene
f.setupLights(m.physicallyCorrectLights),e.isArrayCamera){const i=e.cameras;for(let e=0,n=i.length;e<n;e++){const n=i[e];Ft(d,t,n,n.viewport)}}else Ft(d,t,e);
null!==b&&(// resolve multisample renderbuffers to a single-sample texture if necessary
it.updateMultisampleRenderTarget(b),// Generate mipmap if we're using any kind of mipmap filtering
it.updateRenderTargetMipmap(b)),!0===t.isScene&&t.onAfterRender(m,t,e),// _gl.finish();
xt.resetDefaultState(),C=-1,P=null,g.pop(),f=g.length>0?g[g.length-1]:null,p.pop(),d=p.length>0?p[p.length-1]:null},this.getActiveCubeFace=function(){return v},this.getActiveMipmapLevel=function(){return y},this.getRenderTarget=function(){return b},this.setRenderTargetTextures=function(t,e,i){et.get(t.texture).__webglTexture=e,et.get(t.depthTexture).__webglTexture=i;const n=et.get(t);n.__hasExternalTextures=!0,n.__hasExternalTextures&&(n.__autoAllocateDepthBuffer=void 0===i,n.__autoAllocateDepthBuffer||// The multisample_render_to_texture extension doesn't work properly if there
// are midframe flushes and an external depth buffer. Disable use of the extension.
!0===J.has("WEBGL_multisampled_render_to_texture")&&(n.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(t,e){const i=et.get(t);i.__webglFramebuffer=e,i.__useDefaultFramebuffer=void 0===e},this.setRenderTarget=function(t,e=0,i=0){b=t,v=e,y=i;let n=!0,r=null,s=!1,o=!1;if(t){const i=et.get(t);void 0!==i.__useDefaultFramebuffer?(// We need to make sure to rebind the framebuffer.
K.bindFramebuffer(36160,null),n=!1):void 0===i.__webglFramebuffer?it.setupRenderTarget(t):i.__hasExternalTextures&&// Color and depth texture must be rebound in order for the swapchain to update.
it.rebindTextures(t,et.get(t.texture).__webglTexture,et.get(t.depthTexture).__webglTexture);const a=t.texture;(a.isData3DTexture||a.isDataArrayTexture||a.isCompressedArrayTexture)&&(o=!0);const h=et.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(r=h[e],s=!0):r=Q.isWebGL2&&t.samples>0&&!1===it.useMultisampledRTT(t)?et.get(t).__webglMultisampledFramebuffer:h,A.copy(t.viewport),E.copy(t.scissor),L=t.scissorTest}else A.copy(N).multiplyScalar(D).floor(),E.copy(F).multiplyScalar(D).floor(),L=j;if(K.bindFramebuffer(36160,r)&&Q.drawBuffers&&n&&K.drawBuffers(t,r),K.viewport(A),K.scissor(E),K.setScissorTest(L),s){const n=et.get(t.texture);St.framebufferTexture2D(36160,36064,34069+e,n.__webglTexture,i)}else if(o){const n=et.get(t.texture),r=e||0;St.framebufferTextureLayer(36160,36064,n.__webglTexture,i||0,r)}C=-1},this.readRenderTargetPixels=function(t,e,i,n,r,s,o){if(!t||!t.isWebGLRenderTarget)return;let a=et.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==o&&(a=a[o]),a){K.bindFramebuffer(36160,a);try{const o=t.texture,a=o.format,h=o.type;if(a!==T&&yt.convert(a)!==St.getParameter(35739))return;const l=h===S&&(J.has("EXT_color_buffer_half_float")||Q.isWebGL2&&J.has("EXT_color_buffer_float"));if(!(h===w||yt.convert(h)===St.getParameter(35738)||h===M&&(Q.isWebGL2||J.has("OES_texture_float")||J.has("WEBGL_color_buffer_float"))||l))return;// the following if statement ensures valid read requests (no out-of-bounds pixels, see #8604)
e>=0&&e<=t.width-n&&i>=0&&i<=t.height-r&&St.readPixels(e,i,n,r,yt.convert(a),yt.convert(h),s)}finally{// restore framebuffer of current render target if necessary
const t=null!==b?et.get(b).__webglFramebuffer:null;K.bindFramebuffer(36160,t)}}},this.copyFramebufferToTexture=function(t,e,i=0){const n=Math.pow(2,-i),r=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n);it.setTexture2D(e,0),St.copyTexSubImage2D(3553,i,0,0,t.x,t.y,r,s),K.unbindTexture()},this.copyTextureToTexture=function(t,e,i,n=0){const r=e.image.width,s=e.image.height,o=yt.convert(i.format),a=yt.convert(i.type);it.setTexture2D(i,0),// As another texture upload may have changed pixelStorei
// parameters, make sure they are correct for the dstTexture
St.pixelStorei(37440,i.flipY),St.pixelStorei(37441,i.premultiplyAlpha),St.pixelStorei(3317,i.unpackAlignment),e.isDataTexture?St.texSubImage2D(3553,n,t.x,t.y,r,s,o,a,e.image.data):e.isCompressedTexture?St.compressedTexSubImage2D(3553,n,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,o,e.mipmaps[0].data):St.texSubImage2D(3553,n,t.x,t.y,o,a,e.image),// Generate mipmaps only when copying level 0
0===n&&i.generateMipmaps&&St.generateMipmap(3553),K.unbindTexture()},this.copyTextureToTexture3D=function(t,e,i,n,r=0){if(m.isWebGL1Renderer)return;const s=t.max.x-t.min.x+1,o=t.max.y-t.min.y+1,a=t.max.z-t.min.z+1,h=yt.convert(n.format),l=yt.convert(n.type);let c;if(n.isData3DTexture)it.setTexture3D(n,0),c=32879;else{if(!n.isDataArrayTexture)return;it.setTexture2DArray(n,0),c=35866}St.pixelStorei(37440,n.flipY),St.pixelStorei(37441,n.premultiplyAlpha),St.pixelStorei(3317,n.unpackAlignment);const u=St.getParameter(3314),d=St.getParameter(32878),f=St.getParameter(3316),p=St.getParameter(3315),g=St.getParameter(32877),_=i.isCompressedTexture?i.mipmaps[0]:i.image;St.pixelStorei(3314,_.width),St.pixelStorei(32878,_.height),St.pixelStorei(3316,t.min.x),St.pixelStorei(3315,t.min.y),St.pixelStorei(32877,t.min.z),i.isDataTexture||i.isData3DTexture?St.texSubImage3D(c,r,e.x,e.y,e.z,s,o,a,h,l,_.data):i.isCompressedArrayTexture?St.compressedTexSubImage3D(c,r,e.x,e.y,e.z,s,o,a,h,_.data):St.texSubImage3D(c,r,e.x,e.y,e.z,s,o,a,h,l,_),St.pixelStorei(3314,u),St.pixelStorei(32878,d),St.pixelStorei(3316,f),St.pixelStorei(3315,p),St.pixelStorei(32877,g),// Generate mipmaps only when copying level 0
0===r&&n.generateMipmaps&&St.generateMipmap(c),K.unbindTexture()},this.initTexture=function(t){t.isCubeTexture?it.setTextureCube(t,0):t.isData3DTexture?it.setTexture3D(t,0):t.isDataArrayTexture||t.isCompressedArrayTexture?it.setTexture2DArray(t,0):it.setTexture2D(t,0),K.unbindTexture()},this.resetState=function(){v=0,y=0,b=null,K.reset(),xt.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}(class extends gs{}).prototype.isWebGL1Renderer=!0;class ms extends Pe{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(e.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(e.object.backgroundIntensity=this.backgroundIntensity),e}// @deprecated
get autoUpdate(){return this.matrixWorldAutoUpdate}set autoUpdate(t){this.matrixWorldAutoUpdate=t}}class _s{constructor(t,e){this.isInterleavedBuffer=!0,this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=j,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=Z()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(t,e,i){t*=this.stride,i*=e.stride;for(let n=0,r=this.stride;n<r;n++)this.array[t+n]=e.array[i+n];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Z()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(e,this.stride);return i.setUsage(this.usage),i}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),// generate UUID for array buffer if necessary
void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Z()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const vs=new Tt;class ys{constructor(t,e,i,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(t){for(let e=0,i=this.data.count;e<i;e++)vs.fromBufferAttribute(this,e),vs.applyMatrix4(t),this.setXYZ(e,vs.x,vs.y,vs.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)vs.fromBufferAttribute(this,e),vs.applyNormalMatrix(t),this.setXYZ(e,vs.x,vs.y,vs.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)vs.fromBufferAttribute(this,e),vs.transformDirection(t),this.setXYZ(e,vs.x,vs.y,vs.z);return this}setX(t,e){return this.normalized&&(e=K(e,this.array)),this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.normalized&&(e=K(e,this.array)),this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.normalized&&(e=K(e,this.array)),this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.normalized&&(e=K(e,this.array)),this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){let e=this.data.array[t*this.data.stride+this.offset];return this.normalized&&(e=Q(e,this.array)),e}getY(t){let e=this.data.array[t*this.data.stride+this.offset+1];return this.normalized&&(e=Q(e,this.array)),e}getZ(t){let e=this.data.array[t*this.data.stride+this.offset+2];return this.normalized&&(e=Q(e,this.array)),e}getW(t){let e=this.data.array[t*this.data.stride+this.offset+3];return this.normalized&&(e=Q(e,this.array)),e}setXY(t,e,i){return t=t*this.data.stride+this.offset,this.normalized&&(e=K(e,this.array),i=K(i,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this}setXYZ(t,e,i,n){return t=t*this.data.stride+this.offset,this.normalized&&(e=K(e,this.array),i=K(i,this.array),n=K(n,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this}setXYZW(t,e,i,n,r){return t=t*this.data.stride+this.offset,this.normalized&&(e=K(e,this.array),i=K(i,this.array),n=K(n,this.array),r=K(r,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=r,this}clone(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new Ve(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new ys(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}// de-interleave data and save it as an ordinary buffer attribute for now
return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}// save as true interleaved attribute
return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class xs extends Ve{constructor(t,e,i,n=1){super(t,e,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const ws=new ie,bs=new ie,Ms=[],Ss=new ie,Cs=new gi;class Ts extends gi{constructor(t,e,i){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new xs(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.frustumCulled=!1;for(let n=0;n<i;n++)this.setMatrixAt(n,Ss)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),null!==t.instanceColor&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,this}getColorAt(t,e){e.fromArray(this.instanceColor.array,3*t)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,16*t)}raycast(t,e){const i=this.matrixWorld,n=this.count;if(Cs.geometry=this.geometry,Cs.material=this.material,void 0!==Cs.material)for(let r=0;r<n;r++){// calculate the world matrix for each instance
this.getMatrixAt(r,ws),bs.multiplyMatrices(i,ws),// the mesh represents this single instance
Cs.matrixWorld=bs,Cs.raycast(t,Ms);// process the result of raycast
for(let t=0,i=Ms.length;t<i;t++){const i=Ms[t];i.instanceId=r,i.object=this,e.push(i)}Ms.length=0}}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new xs(new Float32Array(3*this.instanceMatrix.count),3)),e.toArray(this.instanceColor.array,3*t)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,16*t)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}class Ps extends Be{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new pt(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}const As=new Tt,Es=new Tt,Ls=new ie,Rs=new ee,Os=new qt;let Ds=class extends Pe{constructor(t=new ei,e=new Ps){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;// we assume non-indexed geometry
if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)As.fromBufferAttribute(e,t-1),Es.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=As.distanceTo(Es);t.setAttribute("lineDistance",new qe(i,1))}return this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Line.threshold,s=i.drawRange;if(// Checking boundingSphere distance to ray
null===i.boundingSphere&&i.computeBoundingSphere(),Os.copy(i.boundingSphere),Os.applyMatrix4(n),Os.radius+=r,!1===t.ray.intersectsSphere(Os))return;
Ls.copy(n).invert(),Rs.copy(t.ray).applyMatrix4(Ls);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,h=new Tt,l=new Tt,c=new Tt,u=new Tt,d=this.isLineSegments?2:1,f=i.index,p=i.attributes.position;if(null!==f){for(let i=Math.max(0,s.start),n=Math.min(f.count,s.start+s.count)-1;i<n;i+=d){const n=f.getX(i),r=f.getX(i+1);h.fromBufferAttribute(p,n),l.fromBufferAttribute(p,r);if(Rs.distanceSqToSegment(h,l,u,c)>a)continue;u.applyMatrix4(this.matrixWorld);//Move back to world space for distance calculation
const s=t.ray.origin.distanceTo(u);s<t.near||s>t.far||e.push({distance:s,// What do we want? intersection point on the ray or on the segment??
// point: raycaster.ray.at( distance ),
point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,s.start),n=Math.min(p.count,s.start+s.count)-1;i<n;i+=d){h.fromBufferAttribute(p,i),l.fromBufferAttribute(p,i+1);if(Rs.distanceSqToSegment(h,l,u,c)>a)continue;u.applyMatrix4(this.matrixWorld);//Move back to world space for distance calculation
const n=t.ray.origin.distanceTo(u);n<t.near||n>t.far||e.push({distance:n,// What do we want? intersection point on the ray or on the segment??
// point: raycaster.ray.at( distance ),
point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}};const Is=new Tt,ks=new Tt;class zs extends Ds{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const t=this.geometry;// we assume non-indexed geometry
if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)Is.fromBufferAttribute(e,t),ks.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Is.distanceTo(ks);t.setAttribute("lineDistance",new qe(i,1))}return this}}class Ns extends Be{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new pt(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}const Fs=new ie,js=new ee,Bs=new qt,Us=new Tt;let Gs=class extends Pe{constructor(t=new ei,e=new Ns){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=t.material,this.geometry=t.geometry,this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Points.threshold,s=i.drawRange;if(// Checking boundingSphere distance to ray
null===i.boundingSphere&&i.computeBoundingSphere(),Bs.copy(i.boundingSphere),Bs.applyMatrix4(n),Bs.radius+=r,!1===t.ray.intersectsSphere(Bs))return;
Fs.copy(n).invert(),js.copy(t.ray).applyMatrix4(Fs);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,h=i.index,l=i.attributes.position;if(null!==h){for(let i=Math.max(0,s.start),r=Math.min(h.count,s.start+s.count);i<r;i++){const r=h.getX(i);Us.fromBufferAttribute(l,r),Hs(Us,r,a,n,t,e,this)}}else{for(let i=Math.max(0,s.start),r=Math.min(l.count,s.start+s.count);i<r;i++)Us.fromBufferAttribute(l,i),Hs(Us,i,a,n,t,e,this)}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}};function Hs(t,e,i,n,r,s,o){const a=js.distanceSqToPoint(t);if(a<i){const i=new Tt;js.closestPointToPoint(t,i),i.applyMatrix4(n);const h=r.ray.origin.distanceTo(i);if(h<r.near||h>r.far)return;s.push({distance:h,distanceToRay:Math.sqrt(a),point:i,index:e,face:null,object:o})}}
/**
			 * Extensible curve object.
			 *
			 * Some common of curve methods:
			 * .getPoint( t, optionalTarget ), .getTangent( t, optionalTarget )
			 * .getPointAt( u, optionalTarget ), .getTangentAt( u, optionalTarget )
			 * .getPoints(), .getSpacedPoints()
			 * .getLength()
			 * .updateArcLengths()
			 *
			 * This following curves inherit from THREE.Curve:
			 *
			 * -- 2D curves --
			 * THREE.ArcCurve
			 * THREE.CubicBezierCurve
			 * THREE.EllipseCurve
			 * THREE.LineCurve
			 * THREE.QuadraticBezierCurve
			 * THREE.SplineCurve
			 *
			 * -- 3D curves --
			 * THREE.CatmullRomCurve3
			 * THREE.CubicBezierCurve3
			 * THREE.LineCurve3
			 * THREE.QuadraticBezierCurve3
			 *
			 * A series of curves can be represented as a THREE.CurvePath.
			 *
			 **/let Vs=class{constructor(){this.type="Curve",this.arcLengthDivisions=200}// Virtual base class method to overwrite and implement in subclasses
//	- t [0 .. 1]
getPoint(){return null}// Get point at relative position in curve according to arc length
// - u [0 .. 1]
getPointAt(t,e){const i=this.getUtoTmapping(t);return this.getPoint(i,e)}// Get sequence of points using getPoint( t )
getPoints(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return e}// Get sequence of points using getPointAt( u )
getSpacedPoints(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e}// Get total curve arc length
getLength(){const t=this.getLengths();return t[t.length-1]}// Get list of cumulative segment lengths
getLengths(t=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let i,n=this.getPoint(0),r=0;e.push(0);for(let s=1;s<=t;s++)i=this.getPoint(s/t),r+=i.distanceTo(n),e.push(r),n=i;return this.cacheArcLengths=e,e;// { sums: cache, sum: sum }; Sum is in the last element.
}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}// Given u ( 0 .. 1 ), get a t to find p. This gives you points which are equidistant
getUtoTmapping(t,e){const i=this.getLengths();let n=0;const r=i.length;let s;// The targeted u distance value to get
s=e||t*i[r-1];// binary search for the index with largest value smaller than target u distance
let o,a=0,h=r-1;for(;a<=h;)if(n=Math.floor(a+(h-a)/2),// less likely to overflow, though probably not issue here, JS doesn't really have integers, all numbers are floats
o=i[n]-s,o<0)a=n+1;else{if(!(o>0)){h=n;break;// DONE
}h=n-1}if(n=h,i[n]===s)return n/(r-1);// we could get finer grain at lengths, or use simple interpolation between two points
const l=i[n];return(n+(s-l)/(i[n+1]-l))/(r-1)}// Returns a unit vector tangent at t
// In case any sub curve does not implement its tangent derivation,
// 2 points a small delta apart will be used to find its gradient
// which seems to give a reasonable approximation
getTangent(t,e){const i=1e-4;let n=t-i,r=t+i;// Capping in case of danger
n<0&&(n=0),r>1&&(r=1);const s=this.getPoint(n),o=this.getPoint(r),a=e||(s.isVector2?new $:new Tt);return a.copy(o).sub(s).normalize(),a}getTangentAt(t,e){const i=this.getUtoTmapping(t);return this.getTangent(i,e)}computeFrenetFrames(t,e){// see http://www.cs.indiana.edu/pub/techreports/TR425.pdf
const i=new Tt,n=[],r=[],s=[],o=new Tt,a=new ie;// compute the tangent vectors for each segment on the curve
for(let d=0;d<=t;d++){const e=d/t;n[d]=this.getTangentAt(e,new Tt)}// select an initial normal vector perpendicular to the first tangent vector,
// and in the direction of the minimum tangent xyz component
r[0]=new Tt,s[0]=new Tt;let h=Number.MAX_VALUE;const l=Math.abs(n[0].x),c=Math.abs(n[0].y),u=Math.abs(n[0].z);l<=h&&(h=l,i.set(1,0,0)),c<=h&&(h=c,i.set(0,1,0)),u<=h&&i.set(0,0,1),o.crossVectors(n[0],i).normalize(),r[0].crossVectors(n[0],o),s[0].crossVectors(n[0],r[0]);// compute the slowly-varying normal and binormal vectors for each segment on the curve
for(let d=1;d<=t;d++){if(r[d]=r[d-1].clone(),s[d]=s[d-1].clone(),o.crossVectors(n[d-1],n[d]),o.length()>Number.EPSILON){o.normalize();const t=Math.acos(q(n[d-1].dot(n[d]),-1,1));// clamp for floating pt errors
r[d].applyMatrix4(a.makeRotationAxis(o,t))}s[d].crossVectors(n[d],r[d])}// if the curve is closed, postprocess the vectors so the first and last normal vectors are the same
if(!0===e){let e=Math.acos(q(r[0].dot(r[t]),-1,1));e/=t,n[0].dot(o.crossVectors(r[0],r[t]))>0&&(e=-e);for(let i=1;i<=t;i++)// twist a little...
r[i].applyMatrix4(a.makeRotationAxis(n[i],e*i)),s[i].crossVectors(n[i],r[i])}return{tangents:n,normals:r,binormals:s}}clone(){return(new this.constructor).copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){const t={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}};class Ws extends Vs{constructor(t=0,e=0,i=1,n=1,r=0,s=2*Math.PI,o=!1,a=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=t,this.aY=e,this.xRadius=i,this.yRadius=n,this.aStartAngle=r,this.aEndAngle=s,this.aClockwise=o,this.aRotation=a}getPoint(t,e){const i=e||new $,n=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const s=Math.abs(r)<Number.EPSILON;// ensures that deltaAngle is 0 .. 2 PI
for(;r<0;)r+=n;for(;r>n;)r-=n;r<Number.EPSILON&&(r=s?0:n),!0!==this.aClockwise||s||(r===n?r=-n:r-=n);const o=this.aStartAngle+t*r;let a=this.aX+this.xRadius*Math.cos(o),h=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){const t=Math.cos(this.aRotation),e=Math.sin(this.aRotation),i=a-this.aX,n=h-this.aY;// Rotate the point about the center of the ellipse.
a=i*t-n*e+this.aX,h=i*e+n*t+this.aY}return i.set(a,h)}copy(t){return super.copy(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}toJSON(){const t=super.toJSON();return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t}fromJSON(t){return super.fromJSON(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}}
/**
			 * Centripetal CatmullRom Curve - which is useful for avoiding
			 * cusps and self-intersections in non-uniform catmull rom curves.
			 * http://www.cemyuksel.com/research/catmullrom_param/catmullrom.pdf
			 *
			 * curve.type accepts centripetal(default), chordal and catmullrom
			 * curve.tension is used for catmullrom which defaults to 0.5
			 */
/*
			Based on an optimized c++ solution in
			 - http://stackoverflow.com/questions/9489736/catmull-rom-curve-with-no-cusps-and-no-self-intersections/
			 - http://ideone.com/NoEbVM

			This CubicPoly class could be used for reusing some variables and calculations,
			but for three.js curve use, it could be possible inlined and flatten into a single function call
			which can be placed in CurveUtils.
			*/
function Zs(){let t=0,e=0,i=0,n=0;
/*
				 * Compute coefficients for a cubic polynomial
				 *   p(s) = c0 + c1*s + c2*s^2 + c3*s^3
				 * such that
				 *   p(0) = x0, p(1) = x1
				 *  and
				 *   p'(0) = t0, p'(1) = t1.
				 */function r(r,s,o,a){t=r,e=o,i=-3*r+3*s-2*o-a,n=2*r-2*s+o+a}return{initCatmullRom:function(t,e,i,n,s){r(e,i,s*(i-t),s*(n-e))},initNonuniformCatmullRom:function(t,e,i,n,s,o,a){// compute tangents when parameterized in [t1,t2]
let h=(e-t)/s-(i-t)/(s+o)+(i-e)/o,l=(i-e)/o-(n-e)/(o+a)+(n-i)/a;// rescale tangents for parametrization in [0,1]
h*=o,l*=o,r(e,i,h,l)},calc:function(r){const s=r*r;return t+e*r+i*s+n*(s*r)}}}
const qs=new Tt,Xs=new Zs,Js=new Zs,Ys=new Zs;
/**
			 * Bezier Curves formulas obtained from
			 * https://en.wikipedia.org/wiki/B%C3%A9zier_curve
			 */
function Qs(t,e,i,n,r){const s=.5*(n-e),o=.5*(r-i),a=t*t;return(2*i-2*n+s+o)*(t*a)+(-3*i+3*n-2*s-o)*a+s*t+i}
function Ks(t,e,i,n){return function(t,e){const i=1-t;return i*i*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,i)+function(t,e){return t*t*e}(t,n)}
function $s(t,e,i,n,r){return function(t,e){const i=1-t;return i*i*i*e}(t,e)+function(t,e){const i=1-t;return 3*i*i*t*e}(t,i)+function(t,e){return 3*(1-t)*t*t*e}(t,n)+function(t,e){return t*t*t*e}(t,r)}let to=class extends Vs{constructor(t=new $,e=new $,i=new $,n=new $){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=i,this.v3=n}getPoint(t,e=new $){const i=e,n=this.v0,r=this.v1,s=this.v2,o=this.v3;return i.set($s(t,n.x,r.x,s.x,o.x),$s(t,n.y,r.y,s.y,o.y)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}};class eo extends Vs{constructor(t=new $,e=new $){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=e}getPoint(t,e=new $){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i}// Line curve is linear, so we can overwrite default getPointAt
getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e){const i=e||new $;return i.copy(this.v2).sub(this.v1).normalize(),i}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class io extends Vs{constructor(t=new $,e=new $,i=new $){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new $){const i=e,n=this.v0,r=this.v1,s=this.v2;return i.set(Ks(t,n.x,r.x,s.x),Ks(t,n.y,r.y,s.y)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class no extends Vs{constructor(t=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=t}getPoint(t,e=new $){const i=e,n=this.points,r=(n.length-1)*t,s=Math.floor(r),o=r-s,a=n[0===s?s:s-1],h=n[s],l=n[s>n.length-2?n.length-1:s+1],c=n[s>n.length-3?n.length-1:s+2];return i.set(Qs(o,a.x,h.x,l.x,c.x),Qs(o,a.y,h.y,l.y,c.y)),i}copy(t){super.copy(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new $).fromArray(i))}return this}}var ro=Object.freeze({__proto__:null,ArcCurve:class extends Ws{constructor(t,e,i,n,r,s){super(t,e,i,i,n,r,s),this.isArcCurve=!0,this.type="ArcCurve"}},CatmullRomCurve3:class extends Vs{constructor(t=[],e=!1,i="centripetal",n=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=i,this.tension=n}getPoint(t,e=new Tt){const i=e,n=this.points,r=n.length,s=(r-(this.closed?0:1))*t;let o,a,h=Math.floor(s),l=s-h;this.closed?h+=h>0?0:(Math.floor(Math.abs(h)/r)+1)*r:0===l&&h===r-1&&(h=r-2,l=1),// 4 points (p1 & p2 defined below)
this.closed||h>0?o=n[(h-1)%r]:(// extrapolate first point
qs.subVectors(n[0],n[1]).add(n[0]),o=qs);const c=n[h%r],u=n[(h+1)%r];if(this.closed||h+2<r?a=n[(h+2)%r]:(// extrapolate last point
qs.subVectors(n[r-1],n[r-2]).add(n[r-1]),a=qs),"centripetal"===this.curveType||"chordal"===this.curveType){// init Centripetal / Chordal Catmull-Rom
const t="chordal"===this.curveType?.5:.25;let e=Math.pow(o.distanceToSquared(c),t),i=Math.pow(c.distanceToSquared(u),t),n=Math.pow(u.distanceToSquared(a),t);// safety check for repeated points
i<1e-4&&(i=1),e<1e-4&&(e=i),n<1e-4&&(n=i),Xs.initNonuniformCatmullRom(o.x,c.x,u.x,a.x,e,i,n),Js.initNonuniformCatmullRom(o.y,c.y,u.y,a.y,e,i,n),Ys.initNonuniformCatmullRom(o.z,c.z,u.z,a.z,e,i,n)}else"catmullrom"===this.curveType&&(Xs.initCatmullRom(o.x,c.x,u.x,a.x,this.tension),Js.initCatmullRom(o.y,c.y,u.y,a.y,this.tension),Ys.initCatmullRom(o.z,c.z,u.z,a.z,this.tension));return i.set(Xs.calc(l),Js.calc(l),Ys.calc(l)),i}copy(t){super.copy(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new Tt).fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}},CubicBezierCurve:to,CubicBezierCurve3:class extends Vs{constructor(t=new Tt,e=new Tt,i=new Tt,n=new Tt){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=i,this.v3=n}getPoint(t,e=new Tt){const i=e,n=this.v0,r=this.v1,s=this.v2,o=this.v3;return i.set($s(t,n.x,r.x,s.x,o.x),$s(t,n.y,r.y,s.y,o.y),$s(t,n.z,r.z,s.z,o.z)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}},EllipseCurve:Ws,LineCurve:eo,LineCurve3:class extends Vs{constructor(t=new Tt,e=new Tt){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=t,this.v2=e}getPoint(t,e=new Tt){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i}// Line curve is linear, so we can overwrite default getPointAt
getPointAt(t,e){return this.getPoint(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}},QuadraticBezierCurve:io,QuadraticBezierCurve3:class extends Vs{constructor(t=new Tt,e=new Tt,i=new Tt){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new Tt){const i=e,n=this.v0,r=this.v1,s=this.v2;return i.set(Ks(t,n.x,r.x,s.x),Ks(t,n.y,r.y,s.y),Ks(t,n.z,r.z,s.z)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}},SplineCurve:no});
/**************************************************************
			 *	Curved Path - a curve path is simply a array of connected
			 *  curves, but retains the api of a curve
			 **************************************************************/class so extends Vs{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(t){this.curves.push(t)}closePath(){// Add a line curve if start and end of lines are not connected
const t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new eo(e,t))}// To get accurate point with reference to
// entire path distance at time t,
// following has to be done:
// 1. Length of each sub path have to be known
// 2. Locate and identify type of curve
// 3. Get t for the curve
// 4. Return curve.getPointAt(t')
getPoint(t,e){const i=t*this.getLength(),n=this.getCurveLengths();let r=0;// To think about boundaries points.
for(;r<n.length;){if(n[r]>=i){const t=n[r]-i,s=this.curves[r],o=s.getLength(),a=0===o?0:1-t/o;return s.getPointAt(a,e)}r++}return null;// loop where sum != 0, sum > d , sum+1 <d
}// We cannot use the default THREE.Curve getPoint() with getLength() because in
// THREE.Curve, getLength() depends on getPoint() but in THREE.CurvePath
// getPoint() depends on getLength
getLength(){const t=this.getCurveLengths();return t[t.length-1]}// cacheLengths must be recalculated.
updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}// Compute lengths and cache them
// We cannot overwrite getLengths() because UtoT mapping uses it.
getCurveLengths(){// We use cache values if curves and cache array are same length
if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;// Get length of sub-curve
// Push sums into cached array
const t=[];let e=0;for(let i=0,n=this.curves.length;i<n;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t,t}getSpacedPoints(t=40){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e}getPoints(t=12){const e=[];let i;for(let n=0,r=this.curves;n<r.length;n++){const s=r[n],o=s.isEllipseCurve?2*t:s.isLineCurve||s.isLineCurve3?1:s.isSplineCurve?t*s.points.length:t,a=s.getPoints(o);for(let t=0;t<a.length;t++){const n=a[t];i&&i.equals(n)||(// ensures no consecutive points are duplicates
e.push(n),i=n)}}return this.autoClose&&e.length>1&&!e[e.length-1].equals(e[0])&&e.push(e[0]),e}copy(t){super.copy(t),this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push(i.clone())}return this.autoClose=t.autoClose,this}toJSON(){const t=super.toJSON();t.autoClose=this.autoClose,t.curves=[];for(let e=0,i=this.curves.length;e<i;e++){const i=this.curves[e];t.curves.push(i.toJSON())}return t}fromJSON(t){super.fromJSON(t),this.autoClose=t.autoClose,this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push((new ro[i.type]).fromJSON(i))}return this}}let oo=class extends so{constructor(t){super(),this.type="Path",this.currentPoint=new $,t&&this.setFromPoints(t)}setFromPoints(t){this.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y);return this}moveTo(t,e){// TODO consider referencing vectors instead of copying?
return this.currentPoint.set(t,e),this}lineTo(t,e){const i=new eo(this.currentPoint.clone(),new $(t,e));return this.curves.push(i),this.currentPoint.set(t,e),this}quadraticCurveTo(t,e,i,n){const r=new io(this.currentPoint.clone(),new $(t,e),new $(i,n));return this.curves.push(r),this.currentPoint.set(i,n),this}bezierCurveTo(t,e,i,n,r,s){const o=new to(this.currentPoint.clone(),new $(t,e),new $(i,n),new $(r,s));return this.curves.push(o),this.currentPoint.set(r,s),this}splineThru(t/*Array of Vector*/){const e=[this.currentPoint.clone()].concat(t),i=new no(e);return this.curves.push(i),this.currentPoint.copy(t[t.length-1]),this}arc(t,e,i,n,r,s){const o=this.currentPoint.x,a=this.currentPoint.y;return this.absarc(t+o,e+a,i,n,r,s),this}absarc(t,e,i,n,r,s){return this.absellipse(t,e,i,i,n,r,s),this}ellipse(t,e,i,n,r,s,o,a){const h=this.currentPoint.x,l=this.currentPoint.y;return this.absellipse(t+h,e+l,i,n,r,s,o,a),this}absellipse(t,e,i,n,r,s,o,a){const h=new Ws(t,e,i,n,r,s,o,a);if(this.curves.length>0){// if a previous curve is present, attempt to join
const t=h.getPoint(0);t.equals(this.currentPoint)||this.lineTo(t.x,t.y)}this.curves.push(h);const l=h.getPoint(1);return this.currentPoint.copy(l),this}copy(t){return super.copy(t),this.currentPoint.copy(t.currentPoint),this}toJSON(){const t=super.toJSON();return t.currentPoint=this.currentPoint.toArray(),t}fromJSON(t){return super.fromJSON(t),this.currentPoint.fromArray(t.currentPoint),this}};class ao extends oo{constructor(t){super(t),this.uuid=Z(),this.type="Shape",this.holes=[]}getPointsHoles(t){const e=[];for(let i=0,n=this.holes.length;i<n;i++)e[i]=this.holes[i].getPoints(t);return e}// get points of shape and holes (keypoints based on segments parameter)
extractPoints(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}}copy(t){super.copy(t),this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push(i.clone())}return this}toJSON(){const t=super.toJSON();t.uuid=this.uuid,t.holes=[];for(let e=0,i=this.holes.length;e<i;e++){const i=this.holes[e];t.holes.push(i.toJSON())}return t}fromJSON(t){super.fromJSON(t),this.uuid=t.uuid,this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push((new oo).fromJSON(i))}return this}}
/**
			 * Port from https://github.com/mapbox/earcut (v2.2.4)
			 */const ho=function(t,e,i=2){const n=e&&e.length,r=n?e[0]*i:t.length;let s=lo(t,0,r,i,!0);const o=[];if(!s||s.next===s.prev)return o;let a,h,l,c,u,d,f;// if the shape is not too simple, we'll use z-order curve hash later; calculate polygon bbox
if(n&&(s=// link every hole into the outer loop, producing a single-ring polygon without holes
function(t,e,i,n){const r=[];let s,o,a,h,l;for(s=0,o=e.length;s<o;s++)a=e[s]*n,h=s<o-1?e[s+1]*n:t.length,l=lo(t,a,h,n,!1),l===l.next&&(l.steiner=!0),r.push(wo(l));// process holes from left to right
for(r.sort(_o),s=0;s<r.length;s++)i=vo(r[s],i);return i}(t,e,s,i)),t.length>80*i){a=l=t[0],h=c=t[1];for(let e=i;e<r;e+=i)u=t[e],d=t[e+1],u<a&&(a=u),d<h&&(h=d),u>l&&(l=u),d>c&&(c=d);// minX, minY and invSize are later used to transform coords into integers for z-order calculation
f=Math.max(l-a,c-h),f=0!==f?32767/f:0}return uo(s,o,i,a,h,f,0),o};// create a circular doubly linked list from polygon points in the specified winding order
function lo(t,e,i,n,r){let s,o;if(r===function(t,e,i,n){let r=0;for(let s=e,o=i-n;s<i;s+=n)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}(t,e,i,n)>0)for(s=e;s<i;s+=n)o=Ro(s,t[s],t[s+1],o);else for(s=i-n;s>=e;s-=n)o=Ro(s,t[s],t[s+1],o);return o&&Co(o,o.next)&&(Oo(o),o=o.next),o}// eliminate colinear or duplicate points
function co(t,e){if(!t)return t;e||(e=t);let i,n=t;do{if(i=!1,n.steiner||!Co(n,n.next)&&0!==So(n.prev,n,n.next))n=n.next;else{if(Oo(n),n=e=n.prev,n===n.next)break;i=!0}}while(i||n!==e);return e}// main ear slicing loop which triangulates a polygon (given as a linked list)
function uo(t,e,i,n,r,s,o){if(!t)return;// interlink polygon nodes in z-order
!o&&s&&// interlink polygon nodes in z-order
function(t,e,i,n){let r=t;do{0===r.z&&(r.z=xo(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,// Simon Tatham's linked list merge sort algorithm
// http://www.chiark.greenend.org.uk/~sgtatham/algorithms/listsort.html
function(t){let e,i,n,r,s,o,a,h,l=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,n=i,a=0,e=0;e<l&&(a++,n=n.nextZ,n);e++);for(h=l;a>0||h>0&&n;)0!==a&&(0===h||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,h--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=n}s.nextZ=null,l*=2}while(o>1)}// z-order of a point given coords and inverse of the longer side of data bbox
(r)}(t,n,r,s);let a,h,l=t;// iterate through ears, slicing them one by one
for(;t.prev!==t.next;)if(a=t.prev,h=t.next,s?po(t,n,r,s):fo(t))// cut off the triangle
e.push(a.i/i|0),e.push(t.i/i|0),e.push(h.i/i|0),Oo(t),// skipping the next vertex leads to less sliver triangles
t=h.next,l=h.next;else// if we looped through the whole remaining polygon and can't find any more ears
if((t=h)===l){// try filtering points and slicing again
o?1===o?uo(t=go(co(t),e,i),e,i,n,r,s,2):2===o&&mo(t,e,i,n,r,s):uo(co(t),e,i,n,r,s,1);break}}// check whether a polygon node forms a valid ear with adjacent nodes
function fo(t){const e=t.prev,i=t,n=t.next;if(So(e,i,n)>=0)return!1;// reflex, can't be an ear
// now make sure we don't have other points inside the potential ear
const r=e.x,s=i.x,o=n.x,a=e.y,h=i.y,l=n.y,c=r<s?r<o?r:o:s<o?s:o,u=a<h?a<l?a:l:h<l?h:l,d=r>s?r>o?r:o:s>o?s:o,f=a>h?a>l?a:l:h>l?h:l;// triangle bbox; min & max are calculated like this for speed
let p=n.next;for(;p!==e;){if(p.x>=c&&p.x<=d&&p.y>=u&&p.y<=f&&bo(r,a,s,h,o,l,p.x,p.y)&&So(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function po(t,e,i,n){const r=t.prev,s=t,o=t.next;if(So(r,s,o)>=0)return!1;// reflex, can't be an ear
const a=r.x,h=s.x,l=o.x,c=r.y,u=s.y,d=o.y,f=a<h?a<l?a:l:h<l?h:l,p=c<u?c<d?c:d:u<d?u:d,g=a>h?a>l?a:l:h>l?h:l,m=c>u?c>d?c:d:u>d?u:d,_=xo(f,p,e,i,n),v=xo(g,m,e,i,n);// triangle bbox; min & max are calculated like this for speed
let y=t.prevZ,x=t.nextZ;// look for points inside the triangle in both directions
for(;y&&y.z>=_&&x&&x.z<=v;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&bo(a,c,h,u,l,d,y.x,y.y)&&So(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==r&&x!==o&&bo(a,c,h,u,l,d,x.x,x.y)&&So(x.prev,x,x.next)>=0)return!1;x=x.nextZ}// look for remaining points in decreasing z-order
for(;y&&y.z>=_;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&bo(a,c,h,u,l,d,y.x,y.y)&&So(y.prev,y,y.next)>=0)return!1;y=y.prevZ}// look for remaining points in increasing z-order
for(;x&&x.z<=v;){if(x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==r&&x!==o&&bo(a,c,h,u,l,d,x.x,x.y)&&So(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}// go through all polygon nodes and cure small local self-intersections
function go(t,e,i){let n=t;do{const r=n.prev,s=n.next.next;!Co(r,s)&&To(r,n,n.next,s)&&Eo(r,s)&&Eo(s,r)&&(e.push(r.i/i|0),e.push(n.i/i|0),e.push(s.i/i|0),// remove two nodes involved
Oo(n),Oo(n.next),n=t=s),n=n.next}while(n!==t);return co(n)}// try splitting polygon into two and triangulate them independently
function mo(t,e,i,n,r,s){// look for a valid diagonal that divides the polygon into two
let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&Mo(o,t)){// split the polygon in two by the diagonal
let a=Lo(o,t);// filter colinear points around the cuts
return o=co(o,o.next),a=co(a,a.next),// run earcut on each half
uo(o,e,i,n,r,s,0),void uo(a,e,i,n,r,s,0)}t=t.next}o=o.next}while(o!==t)}function _o(t,e){return t.x-e.x}// find a bridge between vertices that connects hole with an outer ring and link it
function vo(t,e){const i=// David Eberly's algorithm for finding a bridge between hole and outer polygon
function(t,e){let i,n=e,r=-1/0;const s=t.x,o=t.y;// find a segment intersected by a ray from the hole's leftmost point to the left;
// segment's endpoint with lesser x will be potential connection point
do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){const t=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=s&&t>r&&(r=t,i=n.x<n.next.x?n:n.next,t===s))return i;// hole touches outer segment; pick leftmost endpoint
}n=n.next}while(n!==e);if(!i)return null;// look for points inside the triangle of hole point, segment intersection and endpoint;
// if there are no points found, we have a valid connection;
// otherwise choose the point of the minimum angle with the ray as connection point
const a=i,h=i.x,l=i.y;let c,u=1/0;n=i;do{s>=n.x&&n.x>=h&&s!==n.x&&bo(o<l?s:r,o,h,l,o<l?r:s,o,n.x,n.y)&&(c=Math.abs(o-n.y)/(s-n.x),// tangential
Eo(n,t)&&(c<u||c===u&&(n.x>i.x||n.x===i.x&&yo(i,n)))&&(i=n,u=c)),n=n.next}while(n!==a);return i}// whether sector in vertex m contains sector in vertex p in the same coordinates
(t,e);if(!i)return e;const n=Lo(i,t);// filter collinear points around the cuts
return co(n,n.next),co(i,i.next)}function yo(t,e){return So(t.prev,t,e.prev)<0&&So(e.next,t,t.next)<0}function xo(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((// coords are transformed into non-negative 15-bit integer range
t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}// find the leftmost node of a polygon ring
function wo(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}// check if a point lies within a convex triangle
function bo(t,e,i,n,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(n-a)>=(i-o)*(e-a)&&(i-o)*(s-a)>=(r-o)*(n-a)}// check if a diagonal between two polygon nodes is valid (lies in polygon interior)
function Mo(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!// check if a polygon diagonal intersects any polygon segments
function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&To(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}// check if a polygon diagonal is locally inside the polygon
(t,e)&&(// dones't intersect other edges
Eo(t,e)&&Eo(e,t)&&// check if the middle point of a polygon diagonal is inside the polygon
function(t,e){let i=t,n=!1;const r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}// link two polygon vertices with a bridge; if the vertices belong to the same ring, it splits polygon into two;
// if one belongs to the outer ring and another to a hole, it merges it into a single ring
(t,e)&&(// locally visible
So(t.prev,t,e.prev)||So(t,e.prev,e))||// does not create opposite-facing sectors
Co(t,e)&&So(t.prev,t,t.next)>0&&So(e.prev,e,e.next)>0);// special zero-length case
}// signed area of a triangle
function So(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}// check if two points are equal
function Co(t,e){return t.x===e.x&&t.y===e.y}// check if two segments intersect
function To(t,e,i,n){const r=Ao(So(t,e,i)),s=Ao(So(t,e,n)),o=Ao(So(i,n,t)),a=Ao(So(i,n,e));return r!==s&&o!==a||(// general case
!(0!==r||!Po(t,i,e))||(// p1, q1 and p2 are collinear and p2 lies on p1q1
!(0!==s||!Po(t,n,e))||(// p1, q1 and q2 are collinear and q2 lies on p1q1
!(0!==o||!Po(i,t,n))||!(0!==a||!Po(i,e,n)))))}// for collinear points p, q, r, check if point q lies on segment pr
function Po(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Ao(t){return t>0?1:t<0?-1:0}function Eo(t,e){return So(t.prev,t,t.next)<0?So(t,e,t.next)>=0&&So(t,t.prev,e)>=0:So(t,e,t.prev)<0||So(t,t.next,e)<0}function Lo(t,e){const i=new Do(t.i,t.x,t.y),n=new Do(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}// create a node and optionally link it with previous one (in a circular doubly linked list)
function Ro(t,e,i,n){const r=new Do(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function Oo(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Do(t,e,i){// vertex index in coordinates array
this.i=t,// vertex coordinates
this.x=e,this.y=i,// previous and next vertex nodes in a polygon ring
this.prev=null,this.next=null,// z-order curve value
this.z=0,// previous and next nodes in z-order
this.prevZ=null,this.nextZ=null,// indicates whether this is a steiner point
this.steiner=!1}class Io{// calculate area of the contour polygon
static area(t){const e=t.length;let i=0;for(let n=e-1,r=0;r<e;n=r++)i+=t[n].x*t[r].y-t[r].x*t[n].y;return.5*i}static isClockWise(t){return Io.area(t)<0}static triangulateShape(t,e){const i=[],n=[],r=[];// flat array of vertices like [ x0,y0, x1,y1, x2,y2, ... ]
// final array of vertex indices like [ [ a,b,d ], [ b,c,d ] ]
ko(t),zo(i,t);let s=t.length;e.forEach(ko);for(let a=0;a<e.length;a++)n.push(s),s+=e[a].length,zo(i,e[a]);
const o=ho(i,n);
for(let a=0;a<o.length;a+=3)r.push(o.slice(a,a+3));return r}}function ko(t){const e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function zo(t,e){for(let i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}
/**
			 * Creates extruded geometry from a path shape.
			 *
			 * parameters = {
			 *
			 *  curveSegments: <int>, // number of points on the curves
			 *  steps: <int>, // number of points for z-side extrusions / used for subdividing segments of extrude spline too
			 *  depth: <float>, // Depth to extrude the shape
			 *
			 *  bevelEnabled: <bool>, // turn on bevel
			 *  bevelThickness: <float>, // how deep into the original shape bevel goes
			 *  bevelSize: <float>, // how far from shape outline (including bevelOffset) is bevel
			 *  bevelOffset: <float>, // how far from shape outline does bevel start
			 *  bevelSegments: <int>, // number of bevel layers
			 *
			 *  extrudePath: <THREE.Curve> // curve to extrude shape along
			 *
			 *  UVGenerator: <Object> // object that provides UV generator functions
			 *
			 * }
			 */class No extends ei{constructor(t=new ao([new $(.5,.5),new $(-.5,.5),new $(-.5,-.5),new $(.5,-.5)]),e={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},t=Array.isArray(t)?t:[t];const i=this,n=[],r=[];for(let o=0,a=t.length;o<a;o++){s(t[o])}// build geometry
// functions
function s(t){const s=[],o=void 0!==e.curveSegments?e.curveSegments:12,a=void 0!==e.steps?e.steps:1,h=void 0!==e.depth?e.depth:1;// options
let l=void 0===e.bevelEnabled||e.bevelEnabled,c=void 0!==e.bevelThickness?e.bevelThickness:.2,u=void 0!==e.bevelSize?e.bevelSize:c-.1,d=void 0!==e.bevelOffset?e.bevelOffset:0,f=void 0!==e.bevelSegments?e.bevelSegments:3;const p=e.extrudePath,g=void 0!==e.UVGenerator?e.UVGenerator:Fo;let m,_,v,y,x,w=!1;p&&(m=p.getSpacedPoints(a),w=!0,l=!1,// bevels not supported for path extrusion
// SETUP TNB variables
// TODO1 - have a .isClosed in spline?
_=p.computeFrenetFrames(a,!1),// console.log(splineTube, 'splineTube', splineTube.normals.length, 'steps', steps, 'extrudePts', extrudePts.length);
v=new Tt,y=new Tt,x=new Tt),// Safeguards if bevels are not enabled
l||(f=0,c=0,u=0,d=0);// Variables initialization
const b=t.extractPoints(o);let M=b.shape;const S=b.holes;if(!Io.isClockWise(M)){M=M.reverse();// Maybe we should also check if holes are in the opposite direction, just to be safe ...
for(let t=0,e=S.length;t<e;t++){const e=S[t];Io.isClockWise(e)&&(S[t]=e.reverse())}}const C=Io.triangulateShape(M,S),T=M;/* Vertices */ // vertices has all points but contour has only points of circumference
for(let e=0,i=S.length;e<i;e++){const t=S[e];M=M.concat(t)}function P(t,e,i){return e.clone().multiplyScalar(i).add(t)}const A=M.length,E=C.length;// Find directions for point movement
function L(t,e,i){// computes for inPt the corresponding point inPt' on a new contour
//   shifted by 1 unit (length of normalized vector) to the left
// if we walk along contour clockwise, this new contour is outside the old one
// inPt' is the intersection of the two lines parallel to the two
//  adjacent edges of inPt at a distance of 1 unit on the left side.
let n,r,s;// resulting translation vector for inPt
// good reading for geometry algorithms (here: line-line intersection)
// http://geomalgorithms.com/a05-_intersect-1.html
const o=t.x-e.x,a=t.y-e.y,h=i.x-t.x,l=i.y-t.y,c=o*o+a*a,u=o*l-a*h;if(Math.abs(u)>Number.EPSILON){// not collinear
// length of vectors for normalizing
const u=Math.sqrt(c),d=Math.sqrt(h*h+l*l),f=e.x-a/u,p=e.y+o/u,g=((i.x-l/d-f)*l-(i.y+h/d-p)*h)/(o*l-a*h);// vector from inPt to intersection point
n=f+o*g-t.x,r=p+a*g-t.y;// Don't normalize!, otherwise sharp corners become ugly
//  but prevent crazy spikes
const m=n*n+r*r;if(m<=2)return new $(n,r);s=Math.sqrt(m/2)}else{// handle special case of collinear edges
let t=!1;// assumes: opposite
o>Number.EPSILON?h>Number.EPSILON&&(t=!0):o<-Number.EPSILON?h<-Number.EPSILON&&(t=!0):Math.sign(a)===Math.sign(l)&&(t=!0),t?(// console.log("Warning: lines are a straight sequence");
n=-a,r=o,s=Math.sqrt(c)):(// console.log("Warning: lines are a straight spike");
n=o,r=a,s=Math.sqrt(c/2))}return new $(n/s,r/s)}const R=[];for(let e=0,i=T.length,n=i-1,r=e+1;e<i;e++,n++,r++)n===i&&(n=0),r===i&&(r=0),//  (j)---(i)---(k)
// console.log('i,j,k', i, j , k)
R[e]=L(T[e],T[n],T[r]);const O=[];let D,I=R.concat();for(let e=0,i=S.length;e<i;e++){const t=S[e];D=[];for(let e=0,i=t.length,n=i-1,r=e+1;e<i;e++,n++,r++)n===i&&(n=0),r===i&&(r=0),//  (j)---(i)---(k)
D[e]=L(t[e],t[n],t[r]);O.push(D),I=I.concat(D)}// Loop bevelSegments, 1 for the front, 1 for the back
for(let e=0;e<f;e++){//for ( b = bevelSegments; b > 0; b -- ) {
const t=e/f,i=c*Math.cos(t*Math.PI/2),n=u*Math.sin(t*Math.PI/2)+d;// contract shape
for(let e=0,r=T.length;e<r;e++){const t=P(T[e],R[e],n);N(t.x,t.y,-i)}// expand holes
for(let e=0,r=S.length;e<r;e++){const t=S[e];D=O[e];for(let e=0,r=t.length;e<r;e++){const r=P(t[e],D[e],n);N(r.x,r.y,-i)}}}const k=u+d;// Back facing vertices
for(let e=0;e<A;e++){const t=l?P(M[e],I[e],k):M[e];w?(// v( vert.x, vert.y + extrudePts[ 0 ].y, extrudePts[ 0 ].x );
y.copy(_.normals[0]).multiplyScalar(t.x),v.copy(_.binormals[0]).multiplyScalar(t.y),x.copy(m[0]).add(y).add(v),N(x.x,x.y,x.z)):N(t.x,t.y,0)}// Add stepped vertices...
// Including front facing vertices
for(let e=1;e<=a;e++)for(let t=0;t<A;t++){const i=l?P(M[t],I[t],k):M[t];w?(// v( vert.x, vert.y + extrudePts[ s - 1 ].y, extrudePts[ s - 1 ].x );
y.copy(_.normals[e]).multiplyScalar(i.x),v.copy(_.binormals[e]).multiplyScalar(i.y),x.copy(m[e]).add(y).add(v),N(x.x,x.y,x.z)):N(i.x,i.y,h/a*e)}// Add bevel segments planes
//for ( b = 1; b <= bevelSegments; b ++ ) {
for(let e=f-1;e>=0;e--){const t=e/f,i=c*Math.cos(t*Math.PI/2),n=u*Math.sin(t*Math.PI/2)+d;// contract shape
for(let e=0,r=T.length;e<r;e++){const t=P(T[e],R[e],n);N(t.x,t.y,h+i)}// expand holes
for(let e=0,r=S.length;e<r;e++){const t=S[e];D=O[e];for(let e=0,r=t.length;e<r;e++){const r=P(t[e],D[e],n);w?N(r.x,r.y+m[a-1].y,m[a-1].x+i):N(r.x,r.y,h+i)}}}/* Faces */ // Top and bottom faces
function z(t,e){let i=t.length;for(;--i>=0;){const n=i;let r=i-1;r<0&&(r=t.length-1);//console.log('b', i,j, i-1, k,vertices.length);
for(let t=0,i=a+2*f;t<i;t++){const i=A*t,s=A*(t+1);j(e+n+i,e+r+i,e+r+s,e+n+s)}}}function N(t,e,i){s.push(t),s.push(e),s.push(i)}function F(t,e,r){B(t),B(e),B(r);const s=n.length/3,o=g.generateTopUV(i,n,s-3,s-2,s-1);U(o[0]),U(o[1]),U(o[2])}function j(t,e,r,s){B(t),B(e),B(s),B(e),B(r),B(s);const o=n.length/3,a=g.generateSideWallUV(i,n,o-6,o-3,o-2,o-1);U(a[0]),U(a[1]),U(a[3]),U(a[1]),U(a[2]),U(a[3])}function B(t){n.push(s[3*t+0]),n.push(s[3*t+1]),n.push(s[3*t+2])}function U(t){r.push(t.x),r.push(t.y)}!/////  Internal functions
function(){const t=n.length/3;if(l){let t=0,e=A*t;// steps + 1
// Bottom faces
for(let i=0;i<E;i++){const t=C[i];F(t[2]+e,t[1]+e,t[0]+e)}t=a+2*f,e=A*t;// Top faces
for(let i=0;i<E;i++){const t=C[i];F(t[0]+e,t[1]+e,t[2]+e)}}else{// Bottom faces
for(let t=0;t<E;t++){const e=C[t];F(e[2],e[1],e[0])}// Top faces
for(let t=0;t<E;t++){const e=C[t];F(e[0]+A*a,e[1]+A*a,e[2]+A*a)}}i.addGroup(t,n.length/3-t,0)}// Create faces for the z-sides of the shape
(),// Sides faces
function(){const t=n.length/3;let e=0;z(T,e),e+=T.length;for(let i=0,n=S.length;i<n;i++){const t=S[i];z(t,e),//, true
e+=t.length}i.addGroup(t,n.length/3-t,1)}()}this.setAttribute("position",new qe(n,3)),this.setAttribute("uv",new qe(r,2)),this.computeVertexNormals()}toJSON(){const t=super.toJSON();return function(t,e,i){if(i.shapes=[],Array.isArray(t))for(let n=0,r=t.length;n<r;n++){const e=t[n];i.shapes.push(e.uuid)}else i.shapes.push(t.uuid);i.options=Object.assign({},e),void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON());return i}(this.parameters.shapes,this.parameters.options,t)}static fromJSON(t,e){const i=[];for(let r=0,s=t.shapes.length;r<s;r++){const n=e[t.shapes[r]];i.push(n)}const n=t.options.extrudePath;return void 0!==n&&(t.options.extrudePath=(new ro[n.type]).fromJSON(n)),new No(i,t.options)}}const Fo={generateTopUV:function(t,e,i,n,r){const s=e[3*i],o=e[3*i+1],a=e[3*n],h=e[3*n+1],l=e[3*r],c=e[3*r+1];return[new $(s,o),new $(a,h),new $(l,c)]},generateSideWallUV:function(t,e,i,n,r,s){const o=e[3*i],a=e[3*i+1],h=e[3*i+2],l=e[3*n],c=e[3*n+1],u=e[3*n+2],d=e[3*r],f=e[3*r+1],p=e[3*r+2],g=e[3*s],m=e[3*s+1],_=e[3*s+2];return Math.abs(a-c)<Math.abs(o-l)?[new $(o,1-h),new $(l,1-u),new $(d,1-p),new $(g,1-_)]:[new $(a,1-h),new $(c,1-u),new $(f,1-p),new $(m,1-_)]}};class jo extends ei{constructor(t=1,e=32,i=16,n=0,r=2*Math.PI,s=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:r,thetaStart:s,thetaLength:o},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const a=Math.min(s+o,Math.PI);let h=0;const l=[],c=new Tt,u=new Tt,d=[],f=[],p=[],g=[];// generate vertices, normals and uvs
for(let m=0;m<=i;m++){const d=[],_=m/i;// special case for the poles
let v=0;0==m&&0==s?v=.5/e:m==i&&a==Math.PI&&(v=-.5/e);for(let i=0;i<=e;i++){const a=i/e;// vertex
c.x=-t*Math.cos(n+a*r)*Math.sin(s+_*o),c.y=t*Math.cos(s+_*o),c.z=t*Math.sin(n+a*r)*Math.sin(s+_*o),f.push(c.x,c.y,c.z),// normal
u.copy(c).normalize(),p.push(u.x,u.y,u.z),// uv
g.push(a+v,1-_),d.push(h++)}l.push(d)}// indices
for(let m=0;m<i;m++)for(let t=0;t<e;t++){const e=l[m][t+1],n=l[m][t],r=l[m+1][t],o=l[m+1][t+1];(0!==m||s>0)&&d.push(e,n,o),(m!==i-1||a<Math.PI)&&d.push(n,r,o)}// build geometry
this.setIndex(d),this.setAttribute("position",new qe(f,3)),this.setAttribute("normal",new qe(p,3)),this.setAttribute("uv",new qe(g,2))}static fromJSON(t){return new jo(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class Bo extends ei{constructor(t=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:t},null!==t){// buffer
const e=[],i=new Set,n=new Tt,r=new Tt;if(null!==t.index){// indexed BufferGeometry
const s=t.attributes.position,o=t.index;let a=t.groups;0===a.length&&(a=[{start:0,count:o.count,materialIndex:0}]);// create a data structure that contains all edges without duplicates
for(let t=0,h=a.length;t<h;++t){const h=a[t],l=h.start;for(let t=l,a=l+h.count;t<a;t+=3)for(let h=0;h<3;h++){const a=o.getX(t+h),l=o.getX(t+(h+1)%3);n.fromBufferAttribute(s,a),r.fromBufferAttribute(s,l),!0===Uo(n,r,i)&&(e.push(n.x,n.y,n.z),e.push(r.x,r.y,r.z))}}}else{// non-indexed BufferGeometry
const s=t.attributes.position;for(let t=0,o=s.count/3;t<o;t++)for(let a=0;a<3;a++){// three edges per triangle, an edge is represented as (index1, index2)
// e.g. the first triangle has the following edges: (0,1),(1,2),(2,0)
const o=3*t+a,h=3*t+(a+1)%3;n.fromBufferAttribute(s,o),r.fromBufferAttribute(s,h),!0===Uo(n,r,i)&&(e.push(n.x,n.y,n.z),e.push(r.x,r.y,r.z))}}// build geometry
this.setAttribute("position",new qe(e,3))}}}function Uo(t,e,i){const n=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`,r=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`;// coincident edge
return!0!==i.has(n)&&!0!==i.has(r)&&(i.add(n),i.add(r),!0)}class Go extends Ps{constructor(t){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}copy(t){return super.copy(t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this}}const Ho={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(// console.log( 'THREE.Cache', 'Adding key:', key );
this.files[t]=e)},get:function(t){if(!1!==this.enabled)// console.log( 'THREE.Cache', 'Checking key:', key );
return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};class Vo{constructor(t,e,i){const n=this;let r,s=!1,o=0,a=0;const h=[];// Refer to #5689 for the reason why we don't set .onStart
// in the constructor
this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){a++,!1===s&&void 0!==n.onStart&&n.onStart(t,o,a),s=!0},this.itemEnd=function(t){o++,void 0!==n.onProgress&&n.onProgress(t,o,a),o===a&&(s=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return r?r(t):t},this.setURLModifier=function(t){return r=t,this},this.addHandler=function(t,e){return h.push(t,e),this},this.removeHandler=function(t){const e=h.indexOf(t);return-1!==e&&h.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=h.length;e<i;e+=2){const i=h[e],n=h[e+1];// see #17920
if(i.global&&(i.lastIndex=0),i.test(t))return n}return null}}}const Wo=new Vo;class Zo{constructor(t){this.manager=void 0!==t?t:Wo,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const i=this;return new Promise((function(n,r){i.load(t,n,e,r)}))}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}class qo extends Zo{constructor(t){super(t)}load(t,e,i,n){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=Ho.get(t);if(void 0!==s)return r.manager.itemStart(t),setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s;const o=nt("img");function a(){l(),Ho.add(t,this),e&&e(this),r.manager.itemEnd(t)}function h(e){l(),n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}function l(){o.removeEventListener("load",a,!1),o.removeEventListener("error",h,!1)}return o.addEventListener("load",a,!1),o.addEventListener("error",h,!1),"data:"!==t.slice(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(t),o.src=t,o}}class Xo extends Pe{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new pt(t),this.intensity=e}dispose(){// Empty here in base class; some subclasses override.
}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}const Jo=new ie,Yo=new Tt,Qo=new Tt;class Ko{constructor(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new $(512,512),this.map=null,this.mapPass=null,this.matrix=new ie,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new ki,this._frameExtents=new $(1,1),this._viewportCount=1,this._viewports=[new wt(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,i=this.matrix;Yo.setFromMatrixPosition(t.matrixWorld),e.position.copy(Yo),Qo.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(Qo),e.updateMatrixWorld(),Jo.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Jo),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(Jo)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}class $o extends Ko{constructor(){super(new Ji(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class ta extends Xo{constructor(t,e){super(t,e),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Pe.DEFAULT_UP),this.updateMatrix(),this.target=new Pe,this.shadow=new $o}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}class ea extends Xo{constructor(t,e){super(t,e),this.isAmbientLight=!0,this.type="AmbientLight"}}class ia extends ei{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(t){return super.copy(t),this.instanceCount=t.instanceCount,this}toJSON(){const t=super.toJSON();return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}class na extends _s{constructor(t,e,i=1){super(t,e),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}clone(t){const e=super.clone(t);return e.meshPerAttribute=this.meshPerAttribute,e}toJSON(t){const e=super.toJSON(t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}class ra{constructor(t,e,i=0,n=1/0){this.ray=new ee(t,e),// direction is assumed to be normalized (for accurate distance calculations)
this.near=i,this.far=n,this.camera=null,this.layers=new fe,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(t,e){// direction is assumed to be normalized (for accurate distance calculations)
this.ray.set(t,e)}setFromCamera(t,e){e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e.isOrthographicCamera&&(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),// set origin in plane of camera
this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e)}intersectObject(t,e=!0,i=[]){return oa(t,this,i,e),i.sort(sa),i}intersectObjects(t,e=!0,i=[]){for(let n=0,r=t.length;n<r;n++)oa(t[n],this,i,e);return i.sort(sa),i}}function sa(t,e){return t.distance-e.distance}function oa(t,e,i,n){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===n){const n=t.children;for(let t=0,r=n.length;t<r;t++)oa(n[t],e,i,!0)}}// r144
class aa extends _i{constructor(t,e,i,n,r,s){super(t,e,i,n,r,s)}}// r144
class ha extends jo{constructor(t,e,i,n,r,s,o){super(t,e,i,n,r,s,o)}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:i}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__=i));var la={};!function(t){!function(e){var i,n,r="fulfilled",s="undefined",o=function(){var t=[],i=0;function r(){for(;t.length-i;){try{t[i]()}catch(r){e.console&&e.console.error(r)}t[i++]=n,1024==i&&(t.splice(0,1024),i=0)}}var o=function(){if(typeof MutationObserver===s)return typeof process!==s&&"function"==typeof process.nextTick?function(){process.nextTick(r)}:typeof setImmediate!==s?function(){setImmediate(r)}:function(){setTimeout(r,0)};var t=document.createElement("div");return new MutationObserver(r).observe(t,{attributes:!0}),function(){t.setAttribute("a",0)}}();return function(e){t.push(e),t.length-i==1&&o()}}();function a(t){if(!(this instanceof a))throw new TypeError("Zousan must be created with the new keyword");if("function"==typeof t){var e=this;try{t((function(t){e.resolve(t)}),(function(t){e.reject(t)}))}catch(t){e.reject(t)}}else if(0<arguments.length)throw new TypeError("Zousan resolver "+t+" is not a function")}function h(t,e){if("function"==typeof t.y)try{var i=t.y.call(n,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.resolve(e)}function l(t,e){if("function"==typeof t.n)try{var i=t.n.call(n,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.reject(e)}a.prototype={resolve:function(t){if(this.state===i){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var e=this;if(t&&("function"==typeof t||"object"==typeof t))try{var n=!0,s=t.then;if("function"==typeof s)return void s.call(t,(function(t){n&&(n=!1,e.resolve(t))}),(function(t){n&&(n=!1,e.reject(t))}))}catch(s){return void(n&&this.reject(s))}this.state=r,this.v=t,e.c&&o((function(){for(var i=0,n=e.c.length;i<n;i++)h(e.c[i],t)}))}},reject:function(t){if(this.state===i){var n=this;this.state="rejected",this.v=t;var r=this.c;o(r?function(){for(var e=0,i=r.length;e<i;e++)l(r[e],t)}:function(){n.handled||!a.suppressUncaughtRejectionError&&e.console&&a.warn("You upset Zousan. Please catch rejections: ",t,t?t.stack:null)})}},then:function(t,e){var n=new a,s={y:t,n:e,p:n};if(this.state===i)this.c?this.c.push(s):this.c=[s];else{var c=this.state,u=this.v;this.handled=!0,o((function(){c===r?h(s,u):l(s,u)}))}return n},catch:function(t){return this.then(null,t)},finally:function(t){return this.then(t,t)},timeout:function(t,e){e=e||"Timeout";var i=this;return new a((function(n,r){setTimeout((function(){r(Error(e))}),t),i.then((function(t){n(t)}),(function(t){r(t)}))}))}},a.resolve=function(t){var e=new a;return e.resolve(t),e},a.reject=function(t){var e=new a;return e.c=[],e.reject(t),e},a.all=function(t){var e=[],i=0,n=new a;function r(r,s){r&&"function"==typeof r.then||(r=a.resolve(r)),r.then((function(r){e[s]=r,++i==t.length&&n.resolve(e)}),(function(t){n.reject(t)}))}for(var s=0;s<t.length;s++)r(t[s],s);return t.length||n.resolve(e),n},a.warn=console.warn,t.exports&&(t.exports=a),e.define&&e.define.amd&&e.define([],(function(){return a})),(e.Zousan=a).soon=o}(n)}({get exports(){return la},set exports(t){la=t}});const ca=la;var ua={},da={get exports(){return ua},set exports(t){ua=t}},fa={};!function(t,e){t.exports=function(){function t(t,i,r,s,o){e(t,i,r||0,s||t.length-1,o||n)}function e(t,n,r,s,o){for(;s>r;){if(s-r>600){var a=s-r+1,h=n-r+1,l=Math.log(a),c=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*c*(a-c)/a)*(h-a/2<0?-1:1);e(t,n,Math.max(r,Math.floor(n-h*c/a+u)),Math.min(s,Math.floor(n+(a-h)*c/a+u)),o)}var d=t[n],f=r,p=s;for(i(t,r,n),o(t[s],d)>0&&i(t,r,s);f<p;){for(i(t,f,p),f++,p--;o(t[f],d)<0;)f++;for(;o(t[p],d)>0;)p--}0===o(t[r],d)?i(t,r,p):i(t,++p,s),p<=n&&(r=p+1),n<=p&&(s=p-1)}}function i(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function n(t,e){return t<e?-1:t>e?1:0}return t}()}({get exports(){return fa},set exports(t){fa=t}}),da.exports=ga,ua.default=ga;var pa=fa;function ga(t,e){if(!(this instanceof ga))return new ga(t,e);// max entries in a node is 9 by default; min node fill is 40% for best performance
this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function ma(t,e,i){if(!i)return e.indexOf(t);for(var n=0;n<e.length;n++)if(i(t,e[n]))return n;return-1}// calculate node's bbox from bboxes of its children
function _a(t,e){va(t,0,t.children.length,e,t)}// min bounding rectangle of node children from k to p-1
function va(t,e,i,n,r){r||(r=Ta(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var s,o=e;o<i;o++)s=t.children[o],ya(r,t.leaf?n(s):s);return r}function ya(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function xa(t,e){return t.minX-e.minX}function wa(t,e){return t.minY-e.minY}function ba(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function Ma(t){return t.maxX-t.minX+(t.maxY-t.minY)}function Sa(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function Ca(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function Ta(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}// sort an array so that items come in groups of n unsorted items, with groups sorted between each other;
// combines selection algorithm with binary divide & conquer approach
function Pa(t,e,i,n,r){for(var s,o=[e,i];o.length;)(i=o.pop())-(e=o.pop())<=n||(s=e+Math.ceil((i-e)/n/2)*n,pa(t,s,e,i,r),o.push(e,s,s,i))}ga.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,i=[],n=this.toBBox;if(!Ca(t,e))return i;for(var r,s,o,a,h=[];e;){for(r=0,s=e.children.length;r<s;r++)o=e.children[r],Ca(t,a=e.leaf?n(o):o)&&(e.leaf?i.push(o):Sa(t,a)?this._all(o,i):h.push(o));e=h.pop()}return i},collides:function(t){var e=this.data,i=this.toBBox;if(!Ca(t,e))return!1;for(var n,r,s,o,a=[];e;){for(n=0,r=e.children.length;n<r;n++)if(s=e.children[n],Ca(t,o=e.leaf?i(s):s)){if(e.leaf||Sa(t,o))return!0;a.push(s)}e=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,i=t.length;e<i;e++)this.insert(t[e]);return this}// recursively build the tree with the given data from scratch using OMT algorithm
var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)// split root if trees have the same height
this._splitRoot(this.data,n);else{if(this.data.height<n.height){// swap trees if inserted one is bigger
var r=this.data;this.data=n,n=r}// insert the small tree into the large tree at appropriate level
this._insert(n,this.data.height-n.height-1,!0)}else// save as is if tree is empty
this.data=n;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=Ta([]),this},remove:function(t,e){if(!t)return this;// depth-first iterative tree traversal
for(var i,n,r,s,o=this.data,a=this.toBBox(t),h=[],l=[];o||h.length;){if(o||(// go up
o=h.pop(),n=h[h.length-1],i=l.pop(),s=!0),o.leaf&&-1!==(// check current node
r=ma(t,o.children,e)))// item found, remove the item and condense tree upwards
return o.children.splice(r,1),h.push(o),this._condense(h),this;s||o.leaf||!Sa(o,a)?n?(// go right
i++,o=n.children[i],s=!1):o=null:(// go down
h.push(o),l.push(i),i=0,n=o,o=o.children[0]);// nothing found
}return this},toBBox:function(t){return t},compareMinX:xa,compareMinY:wa,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},_build:function(t,e,i,n){var r,s=i-e+1,o=this._maxEntries;if(s<=o)// reached leaf level; return leaf
return _a(r=Ta(t.slice(e,i+1)),this.toBBox),r;n||(// target height of the bulk-loaded tree
n=Math.ceil(Math.log(s)/Math.log(o)),// target number of root entries to maximize storage utilization
o=Math.ceil(s/Math.pow(o,n-1))),(r=Ta([])).leaf=!1,r.height=n;// split the items into M mostly square tiles
var a,h,l,c,u=Math.ceil(s/o),d=u*Math.ceil(Math.sqrt(o));for(Pa(t,e,i,d,this.compareMinX),a=e;a<=i;a+=d)for(Pa(t,a,l=Math.min(a+d-1,i),u,this.compareMinY),h=a;h<=l;h+=u)c=Math.min(h+u-1,l),// pack each entry recursively
r.children.push(this._build(t,h,c,n-1));return _a(r,this.toBBox),r},_chooseSubtree:function(t,e,i,n){for(var r,s,o,a,h,l,c,u,d,f;n.push(e),!e.leaf&&n.length-1!==i;){for(c=u=1/0,r=0,s=e.children.length;r<s;r++)h=ba(o=e.children[r]),d=t,f=o,// choose entry with the least area enlargement
(l=(Math.max(f.maxX,d.maxX)-Math.min(f.minX,d.minX))*(Math.max(f.maxY,d.maxY)-Math.min(f.minY,d.minY))-h)<u?(u=l,c=h<c?h:c,a=o):l===u&&h<c&&(c=h,a=o);e=a||e.children[0]}return e},_insert:function(t,e,i){var n=this.toBBox,r=i?t:n(t),s=[],o=this._chooseSubtree(r,this.data,e,s);// find the best node for accommodating the item, saving all nodes along the path too
// split on node overflow; propagate upwards if necessary
for(// put the item into the node
o.children.push(t),ya(o,r);e>=0&&s[e].children.length>this._maxEntries;)this._split(s,e),e--;// adjust bboxes along the insertion path
this._adjustParentBBoxes(r,s,e)},// split overflowed node into two
_split:function(t,e){var i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var s=this._chooseSplitIndex(i,r,n),o=Ta(i.children.splice(s,i.children.length-s));o.height=i.height,o.leaf=i.leaf,_a(i,this.toBBox),_a(o,this.toBBox),e?t[e-1].children.push(o):this._splitRoot(i,o)},_splitRoot:function(t,e){// split root node
this.data=Ta([t,e]),this.data.height=t.height+1,this.data.leaf=!1,_a(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,i){var n,r,s,o,a,h,l,c,u,d,f,p,g,m;for(h=l=1/0,n=e;n<=i-e;n++)r=va(t,0,n,this.toBBox),s=va(t,n,i,this.toBBox),u=r,d=s,f=void 0,p=void 0,g=void 0,m=void 0,f=Math.max(u.minX,d.minX),p=Math.max(u.minY,d.minY),g=Math.min(u.maxX,d.maxX),m=Math.min(u.maxY,d.maxY),o=Math.max(0,g-f)*Math.max(0,m-p),a=ba(r)+ba(s),// choose distribution with minimum overlap
o<h?(h=o,c=n,l=a<l?a:l):o===h&&a<l&&(l=a,c=n);return c},// sorts node children by the best axis for split
_chooseSplitAxis:function(t,e,i){var n=t.leaf?this.compareMinX:xa,r=t.leaf?this.compareMinY:wa;// if total distributions margin value is minimal for x, sort by minX,
// otherwise it's already sorted by minY
this._allDistMargin(t,e,i,n)<this._allDistMargin(t,e,i,r)&&t.children.sort(n)},// total margin of all possible split distributions where each node is at least m full
_allDistMargin:function(t,e,i,n){t.children.sort(n);var r,s,o=this.toBBox,a=va(t,0,e,o),h=va(t,i-e,i,o),l=Ma(a)+Ma(h);for(r=e;r<i-e;r++)s=t.children[r],ya(a,t.leaf?o(s):s),l+=Ma(a);for(r=i-e-1;r>=e;r--)s=t.children[r],ya(h,t.leaf?o(s):s),l+=Ma(h);return l},_adjustParentBBoxes:function(t,e,i){// adjust bboxes along the given tree path
for(var n=i;n>=0;n--)ya(e[n],t)},_condense:function(t){// go through the path, removing empty nodes and updating bboxes
for(var e,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():_a(t[i],this.toBBox)},_initFormat:function(t){// data format (minX, minY, maxX, maxY accessors)
// uses eval-type function compilation instead of just accepting a toBBox function
// because the algorithms are very sensitive to sorting functions performance,
// so they should be dead simple and without inner calls
var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};var Aa={};
/*
			 (c) 2017, Vladimir Agafonkin
			 Simplify.js, a high-performance JS polyline simplification library
			 mourner.github.io/simplify-js
			*/
!function(t){!function(){// square distance from a point to a segment
function e(t,e,i){var n=e.x,r=e.y,s=i.x-n,o=i.y-r;if(0!==s||0!==o){var a=((t.x-n)*s+(t.y-r)*o)/(s*s+o*o);a>1?(n=i.x,r=i.y):a>0&&(n+=s*a,r+=o*a)}return(s=t.x-n)*s+(o=t.y-r)*o}// rest of the code doesn't care about point format
// basic distance-based simplification
function i(t,n,r,s,o){for(var a,h=s,l=n+1;l<r;l++){var c=e(t[l],t[n],t[r]);c>h&&(a=l,h=c)}h>s&&(a-n>1&&i(t,n,a,s,o),o.push(t[a]),r-a>1&&i(t,a,r,s,o))}// simplification using Ramer-Douglas-Peucker algorithm
function n(t,e){var n=t.length-1,r=[t[0]];return i(t,0,n,e,r),r.push(t[n]),r}// both algorithms combined for awesome performance
function r(t,e,i){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=i?t:function(t,e){for(var i,n,r,s,o,a=t[0],h=[a],l=1,c=t.length;l<c;l++)i=t[l],r=a,s=void 0,o=void 0,s=(n=i).x-r.x,o=n.y-r.y,s*s+o*o>e&&(h.push(i),a=i);return a!==i&&h.push(i),h}(t,r),t=n(t,r)}// export as AMD module / Node module / browser or worker variable
t.exports=r,t.exports.default=r}()}({get exports(){return Aa},set exports(t){Aa=t}});const Ea=Aa;
/*!
			* Contains code from THREE.js
			* MIT License
			* https://github.com/mrdoob/three.js
			*/for(var La=[],Ra=0;Ra<6;Ra++)La[Ra]=[];var Oa=[];function Da(t,e,i){var n,r,s,o,a,h,l,c,u,d,f,p,g,m,_,v,y;r=(n=t)[0],s=n[1],o=n[2],a=n[3],h=n[4],l=n[5],c=n[6],u=n[7],d=n[8],f=n[9],p=n[10],g=n[11],m=n[12],_=n[13],v=n[14],y=n[15],//right
ka(La[0],a-r,u-h,g-d,y-m),//left
ka(La[1],a+r,u+h,g+d,y+m),//bottom
ka(La[2],a+s,u+l,g+f,y+_),//top
ka(La[3],a-s,u-l,g-f,y-_),//z-far
ka(La[4],a-o,u-c,g-p,y-v),//z-near
ka(La[5],a+o,u+c,g+p,y+v);for(var x=0;x<6;x++)if(!i||"0"!==i.charAt(x)){var w=La[x];// corner at max distance
if(Oa[0]=w[0]>0?e[1][0]:e[0][0],Oa[1]=w[1]>0?e[1][1]:e[0][1],Oa[2]=w[2]>0?e[1][2]:e[0][2],za(w,Oa)<0)return!1}return!0}var Ia=1/6;function ka(t,e,i,n,r){return t[0]=e*Ia,t[1]=i*Ia,t[2]=n*Ia,t[3]=r*Ia,t}function za(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}
/*!
			 * maptalks v1.0.0-rc.17
			 * LICENSE : BSD-3-Clause
			 * (c) 2016-2022 maptalks.org
			 */var Na="_maptalks__internal_layer_",Fa=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],ja=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(Fa),Ba=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],Ua=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],Ga={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},Ha=["lineColor","polygonFill","markerFill","markerLineColor","textFill"];function Va(){return Date.now()}function Wa(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)t[n]=i[n]}return t}function Za(t){return null==t}function qa(t){return"number"==typeof t&&!isNaN(t)}function Xa(t){return(0|t)===t}function Ja(t){return"object"==typeof t&&!!t}function Ya(t){return!Za(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function Qa(t){return!Za(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var Ka=Object.prototype.hasOwnProperty;function $a(t,e){return Ka.call(t,e)}var th=Math.PI/180;function eh(t){return t*th}function ih(t){return t/th}var nh="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"],rh={},sh={};function oh(){return window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}if(!nh){var ah=navigator.userAgent.toLowerCase(),hh=document.documentElement,lh="ActiveXObject"in window,ch=-1!==ah.indexOf("webkit"),uh=-1!==ah.indexOf("phantom"),dh=-1!==ah.search("android [23]"),fh=-1!==ah.indexOf("chrome"),ph=-1!==ah.indexOf("gecko")&&!ch&&!window.opera&&!lh,gh="undefined"!=typeof orientation||-1!==ah.indexOf("mobile"),mh=!window.PointerEvent&&window.MSPointerEvent,_h=window.PointerEvent&&navigator.pointerEnabled||mh,vh=lh&&"transition"in hh.style,yh="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!dh,xh="MozPerspective"in hh.style,wh="OTransition"in hh.style,bh=(vh||yh||xh)&&!wh&&!uh,Mh="undefined"!=typeof window&&Qa(window.createImageBitmap),Sh="undefined"!=typeof window&&Qa(window.ResizeObserver),Ch="undefined"!=typeof window&&Qa(window.btoa),Th=0;fh&&(Th=ah.match(/chrome\/([\d.]+)/)[1]);var Ph=!uh&&(_h||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),Ah="undefined"!=typeof window&&"WebGLRenderingContext"in window,Eh=oh(),Lh=!1;try{new OffscreenCanvas(2,2).getContext("2d"),Lh=!0}catch(nM){Lh=!1}var Rh=!1;try{window.addEventListener("testPassive",(function(){}),{get passive(){Rh=!0}})}catch(rM){}if(rh={ie:lh,ielt9:lh&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:ch,gecko:ph,android:-1!==ah.indexOf("android"),android23:dh,chrome:fh,chromeVersion:Th,safari:!fh&&-1!==ah.indexOf("safari"),phantomjs:uh,ie3d:vh,webkit3d:yh,gecko3d:xh,opera12:wh,any3d:bh,mobile:gh,mobileWebkit:gh&&ch,mobileWebkit3d:gh&&yh,mobileOpera:gh&&window.opera,mobileGecko:gh&&ph,touch:!!Ph,msPointer:!!mh,pointer:!!_h,retina:Eh>1,devicePixelRatio:Eh,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:lh&&9===document.documentMode,ie10:lh&&10===document.documentMode,webgl:Ah,imageBitMap:Mh,resizeObserver:Sh,btoa:Ch,decodeImageInWorker:Lh,monitorDPRChange:!0,supportsPassive:Rh,removeDPRListening:function(t){t&&delete sh[t.id]},checkDevicePixelRatio:function(){if("undefined"!=typeof window&&rh.monitorDPRChange){var t=oh(),e=t!==rh.devicePixelRatio;return e&&(rh.devicePixelRatio=t),e}return!1},addDPRListening:function(t){t&&(sh[t.id]=t)}},"undefined"!=typeof window&&window.matchMedia)for(var Oh=1;Oh<500;Oh++){var Dh=(.01*Oh).toFixed(2),Ih=window.matchMedia("screen and (resolution: "+Dh+"dppx)");Ih&&(Ih.addEventListener?Ih.addEventListener("change",rh.checkDevicePixelRatio):Ih.addListener&&Ih.addListener(rh.checkDevicePixelRatio))}if(rh.devicePixelRatio){var kh=rh.devicePixelRatio;Object.defineProperty(rh,"devicePixelRatio",{get:function(){return kh},set:function(t){if(t!==kh&&(kh=t,rh.monitorDPRChange))for(var e in sh){var i=sh[e];if(i&&i.options&&!i.options.devicePixelRatio&&i.checkSize&&i.getRenderer)i.getRenderer()&&i.checkSize(!0)}}})}}var zh=rh;function Nh(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function Fh(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var jh,Bh,Uh=function(){function t(t,e,i){if(Za(t)||Za(e)?Za(t.x)||Za(t.y)?Array.isArray(t)&&(this.x=+t[0],this.y=+t[1],this.z=t[2]):(this.x=+t.x,this.y=+t.y,this.z=t.z):(this.x=+t,this.y=+e,this.z=i),this._isNaN())throw new Error("Position is NaN")}var e=t.prototype;return e.set=function(t,e,i){return this.x=t,this.y=e,this.z=i||0,this},e.abs=function(){return new this.constructor(Math.abs(this.x),Math.abs(this.y))},e._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},e._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},e.round=function(){return new this.constructor(Math.round(this.x),Math.round(this.y))},e._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},e.ceil=function(){return new this.constructor(Math.ceil(this.x),Math.ceil(this.y))},e.distanceTo=function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},e.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},e.floor=function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))},e.copy=function(){return new this.constructor(this.x,this.y,this.z)},e._add=function(t,e){return Za(t.x)?Za(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},e.add=function(t,e){var i,n;return Za(t.x)?Za(t[0])?(i=this.x+t,n=this.y+e):(i=this.x+t[0],n=this.y+t[1]):(i=this.x+t.x,n=this.y+t.y),new this.constructor(i,n)},e._sub=function(t,e){return Za(t.x)?Za(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(t,e){var i,n;return Za(t.x)?Za(t[0])?(i=this.x-t,n=this.y-e):(i=this.x-t[0],n=this.y-t[1]):(i=this.x-t.x,n=this.y-t.y),new this.constructor(i,n)},e.substract=function(){return this.sub.apply(this,arguments)},e.multi=function(t){return new this.constructor(this.x*t,this.y*t)},e._multi=function(t){return this.x*=t,this.y*=t,this},e.div=function(t){return this.multi(1/t)},e._div=function(t){return this._multi(1/t)},e.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y&&this.z===t.z)},e._isNaN=function(){return isNaN(this.x)||isNaN(this.y)},e.isZero=function(){return 0===this.x&&0===this.y},e.toArray=function(){return qa(this.z)?[this.x,this.y,this.z]:[this.x,this.y]},e.toFixed=function(t){return new this.constructor(this.x.toFixed(t),this.y.toFixed(t))},e.toJSON=function(){return{x:this.x,y:this.y}},t}(),Gh=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},i.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.unit=function(){return this.copy()._unit()},i._unit=function(){return this._div(this.mag()),this},i.perp=function(){return this.copy()._perp()},i._perp=function(){var t=this.y;return this.y=this.x,this.x=-t,this},i.angleWith=function(t){return this.angleWithSep(t.x,t.y)},i.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},i._rotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=e*this.x-i*this.y,r=i*this.x+e*this.y;return this.x=n,this.y=r,this},i.rotate=function(t){return this.copy()._rotate(t)},e}(Uh);function Hh(t){var e="data:image/svg+xml";return t.length>4&&".svg"===t.slice(-4)?1:t.slice(0,e.length)===e?2:0}function Vh(t,e){nh&&Vh.node?Vh.node(t,e):t.src=e[0]}!function(){if(nh)return jh=function(t){return setTimeout(t,16)},void(Bh=clearTimeout);var t,e;function i(t){return setTimeout(t,33.333333333333336)}function n(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}"undefined"!=typeof window?(t=window.requestAnimationFrame||n("RequestAnimationFrame")||i,e=window.cancelAnimationFrame||n("CancelAnimationFrame")||n("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(t=i,e=clearTimeout),jh=function(e){return t(e)},Bh=function(t){t&&e(t)}}();var Wh=0;function Zh(){return Wh++}var qh=Zh;function Xh(t){return t&&Ya(t)?JSON.parse(t):t}function Jh(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];if(i)for(var n=0,r=i.length;n<r;n++)t.push(i[n])}return t.length}function Yh(t,e){var i=e.indexOf(t);i>-1&&e.splice(i,1)}function Qh(t,e,i){if(!Array.isArray(t))return i?e.call(i,t):e(t);for(var n,r,s=[],o=0,a=t.length;o<a;o++)Za(n=t[o])?s.push(null):Array.isArray(n)?s.push(Qh(n,e,i)):(r=i?e.call(i,n):e(n),s.push(r));return s}function Kh(t,e){return void 0===t?e:t}function $h(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function tl(t){if(Math.log2)return Math.log2(t);var e=Math.log(t)*Math.LOG2E,i=Math.round(e);return Math.abs(i-e)<1e-14?i:e}function el(t,e,i){return t*(1-i)+e*i}function il(t,e,i){if(t===i||t===e)return t;var n=i-e;return((t-e)%n+n)%n+e}function nl(t,e,i){return Math.min(i,Math.max(e,t))}function rl(t){return Array.isArray(t)&&t.length>0}var sl=/^([a-z][a-z\d+\-.]*:)?\/\//i;var ol=/^url\((['"])(.+)\1\)$/i,al=/^url\(([^'"].*[^'"])\)$/i;function hl(t){return Ya(t)?al.test(t)?1:ol.test(t)?2:3:0}function ll(t){var e=hl(t);return 3===e?t:1===e?al.exec(t)[1]:2===e?ol.exec(t)[2]:t}function cl(t){if(zh.btoa)return window.btoa(t);for(var e,i,n=String(t),r="",s=0,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.charAt(0|s)||(o="=",s%1);r+=o.charAt(63&e>>8-s%1*8)){if((i=n.charCodeAt(s+=3/4))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|i}return r}function ul(t,e){for(var i=atob(t),n=new ArrayBuffer(i.length),r=new Uint8Array(n),s=0;s<i.length;s++)r[s]=255&i.charCodeAt(s);return new Blob([n],{type:e})}function dl(t,e,i,n){var r=i-t,s=n-e;return Math.atan2(s,r)}var fl,pl="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function gl(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var i in t)if("center"===i){if(!e[i]||!ml(t[i][0],e[i][0])||!ml(t[i][1],e[i][1]))return!1}else if(t[i]!==e[i])return!1;return!0}function ml(t,e,i){return null==i&&(i=1e-6),t>=e-i&&t<=e+i}function _l(t,e,i,n){t||(t=100),e||(e=4);var r=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout((function s(){if(0===e)return r.show(),void(i&&(n?i.call(n):i()));e%2==0?r.hide():r.show(),e--,r._flashTimeout=setTimeout(s,t)}),t),this}function vl(t,e){void 0===t&&(t=[]),void 0===e&&(e="_pt");for(var i=[],n=0,r=t.length;n<r;n++){var s=t[n];if(s){s[e]||(s[e]=new Gh(0,0));var o=s[e];o.x=0,o.y=0,i.push(o)}else i.push(null)}return i}if(zh.decodeImageInWorker){var yl=document.createElement("canvas");yl.width=1,yl.height=1,fl=yl.getContext("2d")}function xl(t,e){var i=fl.createImageData(t.width,t.height);i.data.set(t.data),createImageBitmap(i).then((function(t){e(t)}))}function wl(t){if(t&&0===t.indexOf("http://")||0===t.indexOf("https://"))return t;var e=document.createElement("a");return e.href=t,t=e.href,e=null,t}var bl,Ml={cssWidth:"1px",cssHeight:"1px",width:1,height:1};function Sl(t,e){void 0===e&&(e=1);var i=t.width,n=t.height;return Ml.cssWidth=i+"px",Ml.cssHeight=n+"px",Ml.width=Math.round(i*e),Ml.height=Math.round(n*e),Ml}var Cl={width:100,height:10};var Tl,Pl=function(){function t(t,e){if(void 0===e&&(e={}),Array.isArray(t)&&!(t.length<2)){this.colors=t;for(var i=1/0,n=-1/0,r=0,s=t.length;r<s;r++){var o=t[r][0];i=Math.min(o,i),n=Math.max(o,n)}this.min=i,this.max=n,this.valueOffset=this.max-this.min,this.options=Object.assign({},Cl,e),this._initImgData()}}var e=t.prototype;return e.getImageData=function(){return this.imgData},e._initImgData=function(){var t=function(){if(!bl){var t=Cl.width,e=Cl.height;OffscreenCanvas?bl=new OffscreenCanvas(t,e):((bl=document.createElement("canvas")).width=t,bl.height=e)}return bl}(),e=this.options,i=e.width,n=e.height;t.width=i,t.height=n;var r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);for(var s=r.createLinearGradient(0,0,t.width,0),o=this.colors,a=this.valueOffset,h=0,l=o.length;h<l;h++){var c=o[h],u=c[0],d=c[1],f=(u-this.min)/a;s.addColorStop(f,d)}r.fillStyle=s,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)},e.getColor=function(t){t=Math.max(this.min,t);var e=((t=Math.min(t,this.max))-this.min)/this.valueOffset,i=Math.round(e*this.imgData.width),n=4*(i=Math.min(i,this.imgData.width-1));return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]},t}();function Al(t,e){var i,n,r;if(Nl(t)){var s,o=t.stops&&"object"==typeof t.stops[0][0],a=o||void 0!==t.property,h=o||!a,l=t.type||e||"exponential";if("exponential"===l)s=Rl;else if("interval"===l)s=Ll;else if("categorical"===l)s=El;else if("identity"===l)s=Il;else{if("color-interpolate"!==l)throw new Error('Unknown function type "'+l+'"');s=Dl}if(o){for(var c={},u=[],d=0;d<t.stops.length;d++){var f=t.stops[d];void 0===c[f[0].zoom]&&(c[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),c[f[0].zoom].stops.push([f[0].value,f[1]])}for(var p in c)u.push([c[p].zoom,Al(c[p])]);i=function(e,i){var n=Rl({stops:u,base:t.base},e)(e,i);return"function"==typeof n?n(e,i):n},n=!1,r=!1}else h?(i=function(e){var i=s(t,e);return"function"==typeof i?i(e):i},n=!0,r=!1):(i=function(e,i){var n=s(t,i?i[t.property]:null);return"function"==typeof n?n(e,i):n},n=!1,r=!0)}else i=function(){return t},n=!0,r=!0;return i.isZoomConstant=r,i.isFeatureConstant=n,i}function El(t,e){for(var i=0;i<t.stops.length;i++)if(e===t.stops[i][0])return t.stops[i][1];return t.default}function Ll(t,e){for(var i=0;i<t.stops.length&&!(e<t.stops[i][0]);i++);return t.stops[Math.max(i-1,0)][1]}function Rl(t,e){for(var i=void 0!==t.base?t.base:1,n=0;!(n>=t.stops.length||e<=t.stops[n][0]);)n++;return 0===n?t.stops[n][1]:n===t.stops.length?t.stops[n-1][1]:kl(e,i,t.stops[n-1][0],t.stops[n][0],t.stops[n-1][1],t.stops[n][1])}"function"==typeof Map&&(Tl=new Map);var Ol={width:100,height:1};function Dl(t,e){var i=t.stops;if(i&&i.length>1){var n;if(Tl){var r=JSON.stringify(i);if(!Tl.has(r)){var s=new Pl(i,Ol);Tl.set(r,s)}n=Tl.get(r)}else n=new Pl(i,Ol);var o=n.getColor(e);return[o[0]/255,o[1]/255,o[2]/255,o[3]/255]}return i&&1===i.length?i[0][1]:null}function Il(t,e){return i=e,n=t.default,void 0!==i?i:void 0!==n?n:void 0!==r?r:null;var i,n,r}function kl(t,e,i,n,r,s){return"function"==typeof r?function(){var o=r.apply(void 0,arguments),a=s.apply(void 0,arguments);return kl(t,e,i,n,o,a)}:r.length?function(t,e,i,n,r,s){for(var o=[],a=0;a<r.length;a++)o[a]=zl(t,e,i,n,r[a],s[a]);return o}(t,e,i,n,r,s):zl(t,e,i,n,r,s)}function zl(t,e,i,n,r,s){var o,a=n-i,h=t-i;return r*(1-(o=1===e?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)))+s*o}function Nl(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function Fl(t){for(var e in t)if(Nl(t[e]))return!0;return!1}function jl(t){return Gl(t,"exponential")}function Bl(t,e){if(!t)return null;var i=!1;if(Array.isArray(t)){for(var n,r=[],s=0;s<t.length;s++)(n=Bl(t[s],e))?(r.push(n),i=!0):r.push(t[s]);return i?r:t}var o,a={__fn_types_loaded:!0},h=[];for(o in t)t.hasOwnProperty(o)&&h.push(o);for(var l=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=jl(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},c=0,u=h.length;c<u;c++)Nl(t[o=h[c]])?(i=!0,a["_"+o]=t[o],l(o)):a[o]=t[o];return i?a:t}function Ul(t){if(!t||!t.stops)return[];for(var e=[],i=0,n=t.stops.length;i<n;i++)e.push(t.stops[i][1]);return e}function Gl(t,e){if(!Nl(t))return function(){return t};var i=!0,n=!0,r=(t=JSON.parse(JSON.stringify(t))).stops;if(r)for(var s=0;s<r.length;s++)if(Nl(r[s][1])){var o=Gl(r[s][1],e);i=i&&o.isZoomConstant,n=n&&o.isFeatureConstant,r[s]=[r[s][0],o]}var a=Al(t,e);return a.isZoomConstant=i&&a.isZoomConstant,a.isFeatureConstant=n&&a.isFeatureConstant,a}var Hl=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function Vl(t){return new Function("f","var p = (f && f.properties || {}); return "+Wl(t))}function Wl(t){if(!t)return"true";var e=t[0];return t.length<=1?"any"===e?"false":"true":"("+("=="===e?ql(t[1],t[2],"===",!1):"!="===e?ql(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?ql(t[1],t[2],e,!0):"any"===e?Xl(t.slice(1),"||"):"all"===e?Xl(t.slice(1),"&&"):"none"===e?Ql(Xl(t.slice(1),"||")):"in"===e?Jl(t[1],t.slice(2)):"!in"===e?Ql(Jl(t[1],t.slice(2))):"has"===e?Yl(t[1]):"!has"===e?Ql(Yl(t[1])):"true")+")"}function Zl(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function ql(t,e,i,n){var r=Zl(t),s="$type"===t?Hl.indexOf(e):JSON.stringify(e);return(n?"typeof "+r+"=== typeof "+s+"&&":"")+r+i+s}function Xl(t,e){return t.map(Wl).join(e)}function Jl(t,e){"$type"===t&&(e=e.map((function(t){return Hl.indexOf(t)})));var i=JSON.stringify(e.sort(Kl)),n=Zl(t);return e.length<=200?i+".indexOf("+n+") !== -1":"function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }("+n+", "+i+",0,"+(e.length-1)+")"}function Yl(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function Ql(t){return"!("+t+")"}function Kl(t,e){return t<e?-1:t>e?1:0}function $l(t){var e=t._toJSON(),i=e.feature;return i.type=Hl.indexOf(i.geometry.type),i.subType=e.subType,i}function tc(t){if(!Array.isArray(t))return tc([t]);for(var e=[],i=0;i<t.length;i++){var n=void 0;n=!0===t[i].filter?function(){return!0}:Vl(t[i].filter),e.push(ec({},t[i],{filter:n}))}return e}function ec(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)t[n]=i[n]}return t}var ic=[],nc={};function rc(t,e){return Bl(t,(function(){var t=e.getMap();return function(t,e,i){return t[0]=e,t[1]=i,t}(ic,t?t.getZoom():12,Wa({},e.getProperties(),function(t,e,i,n){return t["{bearing}"]=e,t["{pitch}"]=i,t["{zoom}"]=n,t}(nc,t&&t.getBearing()||0,t&&t.getPitch()||0,t?t.getZoom():10)))}))}function sc(t){var e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}function oc(t,e,i){if(!t.markerPath)return null;var n=1,r=sc(t);qa(t.markerOpacity)&&(n=t.markerOpacity),qa(t.opacity)&&(n*=t.opacity);var s={};if(r){for(var o in r.stroke)r.stroke.hasOwnProperty(o)&&(Za(r.stroke[o])||(s[o]=r.stroke[o]));for(var a in r.fill)r.fill.hasOwnProperty(a)&&(Za(r.fill[a])||(s[a]=r.fill[a]))}for(var h,l=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath],c=[],u=0;u<l.length;u++)(h=Wa({},h=Ya(l[u])?{path:l[u]}:l[u],s)).d=h.path,delete h.path,c.push(h);var d=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];n<1&&d.push('opacity="'+n+'"'),t.markerPathWidth&&t.markerPathHeight&&d.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),d.push('preserveAspectRatio="none"'),e&&d.push('width="'+e+'"'),i&&d.push('height="'+i+'"'),d.push("><defs></defs>");for(var f=0;f<c.length;f++){var p="<path ";for(var g in c[f])c[f].hasOwnProperty(g)&&(p+=" "+g+'="'+c[f][g]+'"');p+="></path>",d.push(p)}return d.push("</svg>"),"data:image/svg+xml;base64,"+cl(d.join(" "))}function ac(t,e){if(!t)return[];var i=t;Array.isArray(t)||(i=[t]);for(var n,r,s,o,a=[],h=Ba,l=i.length-1;l>=0;l--)if(t=i[l]){e&&(t=hc(t));for(var c=0;c<h.length;c++)if(Nl(n=t[h[c]])&&(n=Ul(n)),n){Array.isArray(n)||(n=[n]);for(var u=0;u<n.length;u++)"url("===n[u].slice(0,4)&&(n[u]=ll(n[u])),r=Ua[c],a.push([n[u],t[r[0]],t[r[1]]])}if("path"===t.markerType&&t.markerPath)if(s=Nl(t.markerWidth)?200:t.markerWidth,o=Nl(t.markerHeight)?200:t.markerHeight,Nl(t.markerPath)){n=Ul(t.markerPath);for(var d=t.markerPath,f=0;f<n.length;f++)t.markerPath=n[f],a.push([oc(t),s,o]);t.markerPath=d}else a.push([oc(t),s,o])}return a}function hc(t){if(!t)return null;var e=t;if(nh)return e;for(var i,n=Ba,r=0,s=n.length;r<s;r++)(i=e[n[r]])&&(e[n[r]]=lc(i));return e}function lc(t){if(Nl(t)){for(var e=t.stops,i=0;i<e.length;i++)e[i][1]=lc(e[i][1]);return t}return"url("===t.slice(0,4)&&(t=ll(t)),t}var cc=function(){function t(t,e){qa(t)&&qa(e)?(this.width=t,this.height=e):qa(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}var e=t.prototype;return e.copy=function(){return new t(this.width,this.height)},e.add=function(e,i){var n,r;return e instanceof t?(n=this.width+e.width,r=this.height+e.height):(n=this.width+e,r=this.height+i),new t(n,r)},e.equals=function(t){return this.width===t.width&&this.height===t.height},e.multi=function(e){return new t(this.width*e,this.height*e)},e._multi=function(t){return this.width*=t,this.height*=t,this},e._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},e.toPoint=function(){return new Gh(this.width,this.height)},e.toArray=function(){return[this.width,this.height]},e.toJSON=function(){return{width:this.width,height:this.height}},t}();function uc(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}var dc=/[\b\t\r\v\f]/gim;function fc(t){return Ya(t)?t.replace(dc,""):t}function pc(t){return uc(t).split(/\s+/)}var gc="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function mc(t,e){return mc.node?mc.node(t,e):(gc.font=e,gc.measureText(t).width)}function _c(t,e,i){var n=mc(t,e);return new cc(n,i||14)}function vc(t,e,i,n){if(!t||0===t.length)return[{text:"",width:0}];var r=Za(n)?mc(t,e):n,s=r/t.length,o=Math.floor(i/s/2);if(s>=i||o<=0)return[{text:"",width:i}];if(r<=i)return[{text:t,width:r}];for(var a=[],h=t.substring(0,o),l=s*o,c=o,u=t.length;c<u;c++){var d=t[c],f=mc(h+d);f>=i?(a.push({text:h,width:l}),h=t.substring(c,o+c),c+=o-1,l=s*o):(h+=d,l=f),c>=u-1&&(l=mc(h),a.push({text:h,width:l}))}return a}var yc=/\{([\w_]+)\}/g;function xc(t,e){return Ya(t)?t.replace(yc,(function(t,i){if(!e)return"";var n=e[i];return Za(n)?"":Array.isArray(n)?n.join():n})):t}function wc(t,e){qa(t)&&(t+=""),t=t||"";var i=e.textMaxHeight||0,n=Sc(t,e);return i&&i<n.size.height&&(n.size.height=i),n}function bc(t,e,i){var n=t.width,r=t.height;return new Gh("left"===e?-n:"right"===e?0:-n/2,"top"===i?-r:"bottom"===i?0:-r/2)}function Mc(t){return t.textFont?t.textFont:(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+t.textSize+"px "+(t.textFaceName?'"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"':"monospace")}function Sc(t,e){var i=Mc(e),n=e.textLineSpacing||0,r=_c(t,i,e.textSize),s=r.width,o=r.height,a=e.textWrapCharacter,h=[],l=e.textWrapWidth;(!l||l>s)&&(l=s),Ya(t)||(t+="");var c=0;if(a&&t.indexOf(a)>=0)for(var u=t.split(a),d=0,f=u.length;d<f;d++){var p=u[d],g=mc(p,i);if(g>l)for(var m=vc(p,i,l,g),_=0,v=m.length;_<v;_++){var y=m[_].width;y>c&&(c=y),h.push({text:m[_].text,size:new cc(y,o)})}else g>c&&(c=g),h.push({text:p,size:new cc(g,o)})}else if(s>l)for(var x=vc(t,i,l,s),w=0;w<x.length;w++){var b=x[w].width;b>c&&(c=b),h.push({text:x[w].text,size:new cc(b,o)})}else s>c&&(c=s),h.push({text:t,size:r});var M=h.length;return{total:M,size:new cc(c,o*M+n*(M-1)),rows:h,rawSize:r}}function Cc(t){var e=0,i=t&&t.length||0;if(!i)return e;for(var n=0;n<i;n++)e=(e<<5)-e+t.charCodeAt(n),e&=e;return e}function Tc(t){return t&&t.colorStops}function Pc(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var i=[],n=t.colorStops.length-1;n>=0;n--)i.push(t.colorStops[n].join());e.push(i.join(","))}return e.join("_")}function Ac(t,e){if(!t)return 1;var i=[];if(Array.isArray(t)){for(var n=0;n<t.length;n++)i.push(Ac(t[n],e));return i.sort().join(",")}var r=Object.keys(t).sort().reduce((function(i,n){return e&&0!==n.indexOf(e)||(i[n]=t[n]),i}),{});return Cc(JSON.stringify(r))}function Ec(t,e){function i(t,e){Za(t.opacity)?t.opacity=e:t.opacity*=e}var n;if(Array.isArray(t)){n=[];for(var r=0;r<t.length;r++){var s=Wa({},t[r]);i(s,e),n.push(s)}}else i(n=Wa({},t),e);return n}function Lc(t){var e=Array.prototype.slice.call(arguments,1);if(e&&e.length||(e=[{}]),Array.isArray(t)){for(var i,n,r=[],s=0,o=t.length;s<o;s++){i=t[s],n={};for(var a=0,h=e.length;a<h;a++)Array.isArray(e[a])?Za(e[a][s])?Wa(n,i||{}):Wa(n,i,e[a][s]):Wa(n,i,e[a]?e[a]:{});r.push(n)}return r}var l=[{},t];return l.push.apply(l,e),Wa.apply(this,l)}function Rc(t){if(t.symbol&&(t=[t]),Array.isArray(t))return t;var e=t.$root,i=t.$iconset;if(t=t.style,e||i){e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),i&&"/"===i[i.length-1]&&(i=i.substring(0,i.length-1));Oc(t,(function(t){return"{$root}"===t?e:"{$iconset}"===t?i:null}))}return t}function Oc(t,e){for(var i=0;i<t.length;i++){var n=t[i].symbol;n&&Ic(n,e)}}var Dc=/(\{\$root\}|\{\$iconset\})/g;function Ic(t,e){for(var i in t)t.hasOwnProperty(i)&&"textName"!==i&&(Ya(t[i])&&t[i].length>2?t[i]=t[i].replace(Dc,e):Nl(t[i])?t[i]=kc(t[i],e):Ja(t[i])&&Ic(t[i],e))}function kc(t,e){var i=t.default;Ya(i)&&(t.default=i.replace(Dc,e));for(var n=t.stops,r=0;r<n.length;r++)Array.isArray(n[r])&&(Ya(n[r][1])?n[r][1]=n[r][1].replace(Dc,e):Nl(n[r][1])&&(n[r][1]=kc(n[r][1],e)));return t}function zc(t){void 0===t&&(t=[]),Array.isArray(t)||(t=[t]);for(var e=t.length,i=0;i<e;i++){var n=t[i];if(n.style){var r=n.style,s=r.lineDasharray,o=r.lineWidth;if(o&&qa(o)&&o>0&&s&&Array.isArray(s)&&s.length)return!0}}return!1}var Nc=Object.freeze({now:Va,extend:Wa,isNil:Za,isNumber:qa,isInteger:Xa,isObject:Ja,isString:Ya,isFunction:Qa,hasOwn:$a,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},isEmpty:function(t){var e;for(e in t)return!1;return!e},toRadian:eh,toDegree:ih,IS_NODE:nh,get requestAnimFrame(){return jh},get cancelAnimFrame(){return Bh},isSVG:Hh,loadImage:Vh,UID:Zh,GUID:qh,parseJSON:Xh,pushIn:Jh,removeFromArray:Yh,forEachCoord:Qh,getValueOrDefault:Kh,sign:$h,log2:tl,interpolate:el,wrap:il,clamp:nl,isArrayHasData:rl,isURL:function(t){return sl.test(t)},isCssUrl:hl,extractCssUrl:ll,btoa:cl,b64toBlob:ul,computeDegree:dl,emptyImageUrl:pl,equalMapView:gl,flash:_l,_defaults:function(t,e){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=i[n],s=Object.getOwnPropertyDescriptor(e,r);s&&s.configurable&&void 0===t[r]&&Object.defineProperty(t,r,s)}return t},getPointsResultPts:vl,getImageBitMap:xl,getAbsoluteURL:wl,calCanvasSize:Sl,translateToSVGStyles:sc,getMarkerPathBase64:oc,getExternalResources:ac,convertResourceUrl:hc,isGradient:Tc,getGradientStamp:Pc,getSymbolStamp:function(t,e){return Ac(t,e)},getSymbolHash:Ac,lowerSymbolOpacity:Ec,extendSymbol:Lc,parseStyleRootPath:Rc,convertStylePath:Oc,parseSymbolPath:Ic,isDashLine:zc,trim:uc,escapeSpecialChars:fc,splitWords:pc,stringWidth:mc,stringLength:_c,splitContent:vc,CONTENT_EXPRE:yc,replaceVariable:xc,describeText:wc,getAlignPoint:bc,getFont:Mc,splitTextToRow:Sc,hashCode:Cc}),Fc=nh?function(t){return t[0]}:function(t){for(var e=document.documentElement.style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return!1},jc=Fc(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),Bc=Fc(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),Uc=Fc(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),Gc=Fc(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function Hc(t,e){var i=document.createElement(t);return e&&ru(i,e),i}function Vc(t,e,i){var n=Hc(t);return e&&eu(n,e),i&&i.appendChild(n),n}function Wc(t){if(!t)return this;if(zh.ielt9||zh.ie9){var e=Hc("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function Zc(t,e,i,n){if(!(t&&t.addEventListener&&e&&i))return this;for(var r=function(e){e||(e=window.event),i.call(n||t,e)},s=e.split(" "),o=s.length-1;o>=0;o--){var a=s[o];if(a)t["Z__"+a]||(t["Z__"+a]=[]),Xc(t,a,i)>=0&&qc(t,a,i),t["Z__"+a].push({callback:r,src:i}),t.addEventListener(a,r,!!zh.supportsPassive&&{capture:!1,passive:!1})}return this}function qc(t,e,i){function n(e,i){"mousewheel"===e&&zh.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,i,!1)}if(!t||!t.removeEventListener||!e)return this;for(var r=e.split(" "),s=r.length-1;s>=0;s--){var o=r[s];if(o){if(!i&&t["Z__"+o]){for(var a=t["Z__"+o],h=0,l=a.length;h<l;h++)n(a[h].callback);return delete t["Z__"+o],this}var c=Xc(t,o,i);if(c<0)return this;n(o,t["Z__"+o][c].callback),t["Z__"+o].splice(c,1)}}return this}function Xc(t,e,i){if(!t||!t["Z__"+e]||!i)return-1;for(var n=t["Z__"+e],r=0,s=n.length;r<s;r++)if(n[r].src===i)return r;return-1}function Jc(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function Yc(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function Qc(t){return t.onselectstart=function(){return!1},t.ondragstart=function(){return!1},t.setAttribute("unselectable","on"),this}function Kc(t,e){return t?(zh.any3d?ou(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function $c(t){var e=window.getComputedStyle(t),i=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],n=t.getBoundingClientRect(),r=t.offsetWidth,s=t.offsetHeight,o=r?n.width/r:1,a=s?n.height/s:1;return t.__position=[n.left+i[0],n.top+i[1],o,a],t.__position}function tu(t,e){t||(t=window.event);var i=e.__position;return i||(i=$c(e)),new Gh((t.clientX-i[0]-e.clientLeft)/i[2],(t.clientY-i[1]-e.clientTop)/i[3])}function eu(t,e){var i,n,r,s=t.style.cssText;return n=";",(r=(i=s).length-n.length)>=0&&i.indexOf(n,r)===r||(s+=";"),t.style.cssText=s+e,this}function iu(t,e){if(void 0!==t.classList)return t.classList.contains(e);var i=su(t);return i.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(i)}function nu(t,e){if(void 0===t.classList||iu(t,e)){var i=su(t);ru(t,(i?i+" ":"")+e)}else for(var n=pc(e),r=0,s=n.length;r<s;r++)t.classList.add(n[r]);return this}function ru(t,e){return Za(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function su(t){return Za(t.className.baseVal)?t.className:t.className.baseVal}function ou(t,e){var i=e||new Gh(0,0);return t.style[jc]=zh.any3d?"translate3d("+i.x+"px,"+i.y+"px,0px)":"translate("+i.x+"px,"+i.y+"px)",this}function au(t){return/<[a-z\][\s\S]*>/i.test(t)}function hu(t,e){var i=lu(t);Ya(e)?i.innerHTML=e:i.appendChild(e);var n=new cc(i.clientWidth,i.clientHeight);return Wc(i),n}function lu(t){var e=document.createElement(t);return e.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(e),e}var cu,uu=Zc,du=qc,fu=Object.freeze({TRANSFORM:jc,TRANSFORMORIGIN:Bc,TRANSITION:Uc,CSSFILTER:Gc,createEl:Hc,createElOn:Vc,removeDomNode:Wc,addDomEvent:Zc,removeDomEvent:qc,listensDomEvent:Xc,preventDefault:Jc,stopPropagation:Yc,preventSelection:Qc,offsetDom:Kc,computeDomPosition:$c,getEventContainerPoint:tu,setStyle:eu,hasClass:iu,addClass:nu,setClass:ru,getClass:su,setOpacity:function(t,e){return t.style.opacity=e,this},setTransform:ou,setTransformMatrix:function(t,e){var i="matrix("+(Ya(e)?e:e.join())+")";return t.style[jc]!==i&&(t.style[jc]=i),this},removeTransform:function(t){return t.style[jc]&&(t.style[jc]=""),this},isHTML:au,measureDom:hu,getDomRuler:lu,on:uu,off:du}),pu="function"==typeof Map,gu=function(){},mu=function(){function t(t,e){this.max=t,this.onRemove=e||gu,this.reset()}var e=t.prototype;return e.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var i=this.getAndRemove(this.order[0]);i&&this.onRemove(i)}return this},e.has=function(t){return t in this.data},e.keys=function(){return this.order},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},e.get=function(t){return this.has(t)?this.data[t]:null},e.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},e.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},t}();pu&&(cu=function(){function t(t,e){this.max=t,this.onRemove=e||gu,this.reset()}var e=t.prototype;return e.reset=function(){if(this.data){var t=this.data.values(),e=Array.isArray(t),i=0;for(t=e?t:t[Symbol.iterator]();;){var n;if(e){if(i>=t.length)break;n=t[i++]}else{if((i=t.next()).done)break;n=i.value}var r=n;this.onRemove(r)}}return this.data=new Map,this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e),this.data.size>this.max&&this.shrink()):this.data.set(t,e),this):this},e.keys=function(){var t=new Array(this.data.size),e=0,i=this.data.keys(),n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var s;if(n){if(r>=i.length)break;s=i[r++]}else{if((r=i.next()).done)break;s=r.value}var o=s;t[e++]=o}return t},e.shrink=function(){for(var t=this.data.keys(),e=t.next();this.data.size>this.max;){var i=this.getAndRemove(e.value);i&&this.onRemove(i),e=t.next()}},e.has=function(t){return this.data.has(t)},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data.get(t);return this.data.delete(t),e},e.get=function(t){return this.has(t)?this.data.get(t):null},e.remove=function(t){if(!this.has(t))return this;var e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this},e.setMaxSize=function(t){return this.max=t,this.data.size>this.max&&this.shrink(),this},t}());var _u=pu?cu:mu,vu={jsonp:function(t,e){var i="_maptalks_jsonp_"+Zh();t.match(/\?/)?t+="&callback="+i:t+="?callback="+i;var n=document.createElement("script");return n.type="text/javascript",n.src=t,window[i]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[i]},document.getElementsByTagName("head")[0].appendChild(n),this},get:function(t,e,i){if(Qa(e)){var n=i;i=e,e=n}if(nh&&vu.get.node)return vu.get.node(t,i,e);var r=vu._getClient(i);if(r.open("GET",t,!0),e){for(var s in e.headers)r.setRequestHeader(s,e.headers[s]);r.withCredentials="include"===e.credentials,e.responseType&&(r.responseType=e.responseType)}return r.send(null),r},post:function(t,e,i){var n;if(Ya(t)){if(Qa(e)){var r=i;i=e,e=r}n=(e=e||{}).postData}else{var s=i;n=e,t=(e=t).url,i=s}if(nh&&vu.post.node)return e.url=t,vu.post.node(e,n,i);var o=vu._getClient(i);if(o.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in o)for(var a in e.headers)e.headers.hasOwnProperty(a)&&o.setRequestHeader(a,e.headers[a]);return Ya(n)||(n=JSON.stringify(n)),o.send(n),o},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e;try{e=new XMLHttpRequest}catch(rM){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(rM){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(rM){}}}return e.onreadystatechange=vu._wrapCallback(e,t),e},getArrayBuffer:function(t,e,i){if(Qa(e)){var n=i;i=e,e=n}return e||(e={}),e.responseType="arraybuffer",vu.get(t,e,i)},getImage:function(t,e,i){return vu.getArrayBuffer(e,i,(function(e,i){if(e)t.onerror&&t.onerror(e);else if(i){var n=window.URL||window.webkitURL,r=t.onload;t.onload=function(){r&&r(),n.revokeObjectURL(t.src)};var s=new Blob([new Uint8Array(i.data)],{type:i.contentType});t.cacheControl=i.cacheControl,t.expires=i.expires,t.src=i.data.byteLength?n.createObjectURL(s):pl}}))},getJSON:function(t,e,i){if(Qa(e)){var n=i;i=e,e=n}var r=function(t,e){var n=e?Xh(e):null;i(t,n)};return e&&e.jsonp?vu.jsonp(t,r):vu.get(t,e,r)}},yu="#000",xu=!1,wu=null,bu=Math.PI/180,Mu={getCanvas2DContext:function(t){return t.getContext("2d",{willReadFrequently:!0})},setHitTesting:function(t){xu=t},createCanvas:function(t,e,i){var n;return nh?n=new i(t,e):((n=Hc("canvas")).width=t,n.height=e),n},prepareCanvasFont:function(t,e){t.textBaseline="top",t.font=Mc(e);var i=e.textFill;i||(i="#000"),t.fillStyle=Mu.getRgba(i,e.textOpacity)},prepareCanvas:function(t,e,i,n){if(e){var r=e.lineWidth;Za(r)||t.lineWidth===r||(t.lineWidth=r);var s=e.linePatternFile,o=e.lineColor||yu;if(n)t.strokeStyle="#000";else if(s&&i){var a;(e.linePatternDx||e.linePatternDy)&&(a=[e.linePatternDx,e.linePatternDy]),Mu._setStrokePattern(t,s,r,a,i),e.lineDasharray=[]}else Tc(o)?e.lineGradientExtent?t.strokeStyle=Mu._createGradient(t,o,e.lineGradientExtent):t.strokeStyle=yu:(Array.isArray(o)&&(o=Mu.normalizeColorToRGBA(o)),t.strokeStyle=o);e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&rl(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var h=e.polygonPatternFile,l=e.polygonFill||"rgba(255,255,255,0)";if(n)t.fillStyle="#000";else if(h&&i){var c=Tu(h),u=i.getImage([c,null,null]);if(u||(u=i.getImage([c+"-texture",null,r])),Hh(c)&&u instanceof Image&&(zh.edge||zh.ie)){var d=u.width||20,f=u.height||20,p=Mu.createCanvas(d,f);Mu.image(p.getContext("2d"),u,0,0,d,f),u=p}u&&(t.fillStyle=t.createPattern(u,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy]))}else Tc(l)?e.polygonGradientExtent?t.fillStyle=Mu._createGradient(t,l,e.polygonGradientExtent):t.fillStyle="rgba(255,255,255,0)":(Array.isArray(l)&&(l=Mu.normalizeColorToRGBA(l)),t.fillStyle=l)}},_createGradient:function(t,e,i){var n=null,r=e.places,s=i.getMin(),o=i.getMax(),a=i.getWidth(),h=i.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(r){if(6!==r.length)throw new Error("A radial gradient's places should have 6 numbers.");r=[s.x+r[0]*a,s.y+r[1]*h,a*r[2],s.x+r[3]*a,s.y+r[4]*h,a*r[5]]}else{var l=i.getCenter()._round();r=[l.x,l.y,Math.abs(l.x-s.x),l.x,l.y,0]}n=t.createRadialGradient.apply(t,r)}}else{if(r){if(4!==r.length)throw new Error("A linear gradient's places should have 4 numbers.");r=[s.x+r[0]*a,s.y+r[1]*h,s.x+r[2]*a,s.y+r[3]*h]}else r=[s.x,s.y,o.x,s.y];n=t.createLinearGradient.apply(t,r)}return e.colorStops.forEach((function(t){n.addColorStop.apply(n,t)})),n},_setStrokePattern:function(t,e,i,n,r){var s,o=Tu(e);if(nh)s=r.getImage([o,null,i]);else{var a=o+"-texture-"+i;if(!(s=r.getImage(a))){var h=r.getImage([o,null,null]);if(h){var l;l=h.width&&h.height?Math.round(h.width*i/h.height):i;var c=Mu.createCanvas(l,i,t.canvas.constructor);Mu.image(c.getContext("2d"),h,0,0,l,i),r.addResource([a,null,i],c),s=c}}}s&&(t.strokeStyle=t.createPattern(s,"repeat"),t.strokeStyle.linePatternOffset=n)},clearRect:function(t,e,i,n,r){t.canvas._drawn=!1,t.clearRect(e,i,n,r)},fillCanvas:function(t,e,i,n){if(xu&&(e=1),t.canvas._drawn=!0,0!==e){var r,s=Mu._isPattern(t.fillStyle),o=t.fillStyle&&t.fillStyle.polygonPatternOffset,a=o?o[0]:0,h=o?o[1]:0;Za(e)&&(e=1),e<1&&(r=t.globalAlpha,t.globalAlpha*=e),s&&(i=i||0,n=n||0,t.translate(i+a,n+h)),t.fill(),s&&t.translate(-i-a,-n-h),e<1&&(t.globalAlpha=r)}},getRgba:function(t,e){return Za(e)&&(e=1),"#"!==t[0]?(Array.isArray(t)&&(t=Mu.normalizeColorToRGBA(t,e)),t):(7===t.length?(i=parseInt(t.substring(1,3),16),n=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16)):(i=17*parseInt(t.substring(1,2),16),n=17*parseInt(t.substring(2,3),16),r=17*parseInt(t.substring(3,4),16)),"rgba("+i+","+n+","+r+","+e+")");var i,n,r},normalizeColorToRGBA:function(t,e){return void 0===e&&(e=1),"rgba("+255*t[0]+","+255*t[1]+","+255*t[2]+","+(4===t.length?t[3]:1)*e+")"},image:function(t,e,i,n,r,s){t.canvas._drawn=!0;try{qa(r)&&qa(s)?t.drawImage(e,i,n,r,s):t.drawImage(e,i,n)}catch(o){console}},text:function(t,e,i,n,r){Mu._textOnMultiRow(t,r.rows,n,i,r.size,r.rawSize)},_textOnMultiRow:function(t,e,i,n,r,s){for(var o,a,h=bc(r,i.textHorizontalAlignment,i.textVerticalAlignment),l=s.height+i.textLineSpacing,c=n.add(0,h.y),u=i.textMaxHeight,d=0,f=0,p=e.length;f<p&&(o=e[f].text,a=bc(e[f].size,i.textHorizontalAlignment,i.textVerticalAlignment),Mu._textOnLine(t,o,c.add(a.x,f*l),i.textHaloRadius,i.textHaloFill,i.textHaloOpacity),!(u>0&&(d+=l)+s.height>=u));f++);},_textOnLine:function(t,e,i,n,r,s){xu&&(s=1);var o,a,h=0!==s&&0!==n;t.textBaseline="top";var l=t.shadowBlur,c=t.shadowOffsetX,u=t.shadowOffsetY;if(h){var d=t.globalAlpha;t.globalAlpha*=s,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*n,Array.isArray(r)&&(r=Mu.normalizeColorToRGBA(r)),t.strokeStyle=r,t.strokeText(e,i.x,i.y+1),t.miterLimit=10,t.globalAlpha=d,o=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",a=t.fillStyle,t.fillStyle="#000"}l&&h&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),Mu.fillText(t,e,i),o&&(t.globalCompositeOperation=o,Mu.fillText(t,e,i,a),l&&(t.shadowBlur=l,t.shadowOffsetX=c,t.shadowOffsetY=u))},fillText:function(t,e,i,n){t.canvas._drawn=!0,n&&(t.fillStyle=n),t.fillText(e,i.x,i.y+1)},_stroke:function(t,e,i,n){if(xu&&(e=1),t.canvas._drawn=!0,0!==e){var r,s=t.strokeStyle&&t.strokeStyle.linePatternOffset,o=s?s[0]:0,a=s?s[1]:0,h=Mu._isPattern(t.strokeStyle)&&(!Za(i)&&!Za(n)||!Za(o)&&!Za(a));Za(e)&&(e=1),e<1&&(r=t.globalAlpha,t.globalAlpha*=e),h&&(i=i||0,n=n||0,t.translate(i+o,n+a)),t.stroke(),h&&t.translate(-i-o,-n-a),e<1&&(t.globalAlpha=r)}},_path:function(t,e,i,n,r){if(rl(e))for(var s,o,a=rl(i),h=!0!==r&&Mu._isPattern(t.strokeStyle),l=0,c=e.length;l<c;l++)if(s=e[l],!a||t.setLineDash)t.lineTo(s.x,s.y),h&&l>0&&(u(e[l-1],s),t.beginPath(),t.moveTo(s.x,s.y));else if(a){if(l===c-1)break;o=e[l+1],Su(t,s,o,i)}function u(e,i){var r=dl(e.x,e.y,i.x,i.y);t.save();var s=Math.cos(r);Math.abs(s)<1e-7?t.translate(e.x-t.lineWidth/2,e.y):t.translate(e.x,e.y-t.lineWidth/2/s),t.rotate(r),Mu._stroke(t,n),t.restore()}},path:function(t,e,i,n,r){rl(e)&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),Mu._path(t,e,r,i),Mu._stroke(t,i))},_multiClip:function(t,e){if(e&&0!==e.length)for(var i=0,n=(e=e[0]).length;i<n;i++){var r=e[i],s=r.x,o=r.y;0===i?t.moveTo(s,o):t.lineTo(s,o),i===n-1&&(s=e[0].x,o=e[0].y,t.lineTo(s,o))}},polygon:function(t,e,i,n,r,s){if(t.isMultiClip)Mu._multiClip(t,e);else if(rl(e)){var o=Mu._isPattern(t.strokeStyle),a=rl(r)&&!t.setLineDash||o&&!s;rl(e[0])||(e=[e]);var h,l,c,u=t;if(e.length>1&&!nh&&(wu||(wu=Mu.createCanvas(1,1)),t.canvas._drawn=!1,wu.width=t.canvas.width,wu.height=t.canvas.height,Pu(t=wu.getContext("2d"),u)),a){for(t.save(),l=0,c=e.length;l<c;l++)rl(e[l])&&(Mu._ring(t,e[l],null,0,!0),h=n,l>0&&(t.globalCompositeOperation="destination-out",h=1),Mu.fillCanvas(t,h,e[l][0].x,e[l][0].y),l>0?t.globalCompositeOperation="source-over":c>1&&(t.fillStyle="#fff"),Mu._stroke(t,0));t.restore()}var d=t.fillStyle;for(l=0,c=e.length;l<c;l++)rl(e[l])&&(s?(Mu.paintSmoothLine(t,e[l],i,s,!0),t.closePath()):Mu._ring(t,e[l],r,i),a||(h=n,l>0&&(t.globalCompositeOperation="destination-out",h=1),Mu.fillCanvas(t,h,e[l][0].x,e[l][0].y),l>0?t.globalCompositeOperation="source-over":c>1&&(t.fillStyle="#fff")),Mu._stroke(t,i));t.fillStyle!==d&&(t.fillStyle=d),e.length>1&&!nh&&(u.drawImage(wu,0,0),u.canvas._drawn=t.canvas._drawn,Pu(u,t))}},_ring:function(t,e,i,n,r){var s=Mu._isPattern(t.strokeStyle);r||!s||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),Mu._path(t,e,i,n,r),s||t.closePath()},paintSmoothLine:function(t,e,i,n,r,s,o){if(e)if(e.length<=2||!n)Mu.path(t,e,i);else{var a,h=e.length,l=r?h:h-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==o&&(l-=Math.max(l-s-1,0));for(var c=0;c<l;c++){var u=e[c].x,d=e[c].y,f=void 0,p=void 0,g=void 0,m=void 0,_=void 0,v=void 0;c-1<0?r?(f=e[l-1].x,p=e[l-1].y):(f=e[c+1].x,p=e[c+1].y):(f=e[c-1].x,p=e[c-1].y),c+1<h?(g=e[c+1].x,m=e[c+1].y):(g=e[c+1-h].x,m=e[c+1-h].y),c+2<h?(_=e[c+2].x,v=e[c+2].y):r?(_=e[c+2-h].x,v=e[c+2-h].y):(_=e[c].x,v=e[c].y);var y=w(f,p,u,d,g,m,_,v,n,c===l-1?o:1);if(c===l-1&&o>=0&&o<1){t.bezierCurveTo(y[0],y[1],y[2],y[3],y[4],y[5]),e.splice(l-1,h-(l-1)-1);var x=new Gh(y[4],y[5]);x.prevCtrlPoint=new Gh(y[2],y[3]),e.push(x),h=e.length}else t.bezierCurveTo(y[0],y[1],y[2],y[3],g,m);e[c].nextCtrlPoint=y.slice(0,2),e[c].prevCtrlPoint=a?a.slice(2):null,a=y}!r&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[h-1].prevCtrlPoint||(e[h-1].prevCtrlPoint=e[h-2].nextCtrlPoint),Mu._stroke(t,i)}function w(t,e,i,n,r,s,o,a,h,l){var c=(t+i)/2,u=(e+n)/2,d=(i+r)/2,f=(n+s)/2,p=(r+o)/2,g=(s+a)/2,m=Math.sqrt((i-t)*(i-t)+(n-e)*(n-e)),_=Math.sqrt((r-i)*(r-i)+(s-n)*(s-n)),v=m/(m+_),y=_/(_+Math.sqrt((o-r)*(o-r)+(a-s)*(a-s))),x=c+(d-c)*v,w=u+(f-u)*v,b=d+(p-d)*y,M=f+(g-f)*y,S=x+(d-x)*h+i-x,C=w+(f-w)*h+n-w,T=b+(d-b)*h+r-b,P=M+(f-M)*h+s-M,A=[S,C,T,P];return l<1?function(t,e,i,n,r,s,o,a,h,l){var c=1-t,u=1-e,d=i*u*u+2*r*e*u+o*e*e,f=r*u*u+2*o*e*u+h*e*e,p=n*u*u+2*s*e*u+a*e*e,g=s*u*u+2*a*e*u+l*e*e;return[(i*c*c+2*r*t*c+o*t*t)*u+(r*c*c+2*o*t*c+h*t*t)*e,(n*c*c+2*s*t*c+a*t*t)*u+(s*c*c+2*a*t*c+l*t*t)*e,d*c+f*t,p*c+g*t,d*u+f*e,p*u+g*e]}(0,l,i,n,S,C,T,P,r,s):A}},_arcBetween:function(t,e,i,n){var r=n,s=e.distanceTo(i),o=s/2/Math.sin(r/2),a=Math.asin((i.y-e.y)/s);e.x>i.x&&(a=Math.PI-a);var h=a-(90*bu-r/2),l=Math.cos(h)*o,c=Math.sin(h)*o,u=e.x+l,d=e.y+c,f=Math.asin((i.y-d)/o);u>i.x&&(f=Math.PI-f);var p=f+r;return t.beginPath(),t.arc(u,d,o,f,p),[u,d]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,i,n){t.beginPath();var r=e[0];t.moveTo(r.x,r.y);var s=[t];s.push.apply(s,e.splice(1)),Mu._bezierCurveTo.apply(Mu,s),Mu.fillCanvas(t,n),Mu._stroke(t,i)},_bezierCurveTo:function(t,e,i,n){t.bezierCurveTo(e.x,e.y,i.x,i.y,n.x,n.y)},ellipse:function(t,e,i,n,r,s,o){var a,h,l,c,u,d,f,p,g;t.beginPath(),i===n&&i===r?t.arc(e.x,e.y,i,0,2*Math.PI):t.ellipse?n!==r?(t.ellipse(e.x,e.y,i,n,0,180*bu,360*bu,!1),t.ellipse(e.x,e.y,i,r,0,0,180*bu,!1)):t.ellipse(e.x,e.y,i,n,0,0,360*bu,!1):(a=e.x,h=e.y,f=(l=i)*(d=.5522848),p=(c=n)*d,g=(u=r)*d,t.moveTo(a-l,h),t.bezierCurveTo(a-l,h-p,a-f,h-c,a,h-c),t.bezierCurveTo(a+f,h-c,a+l,h-p,a+l,h),t.bezierCurveTo(a+l,h+g,a+f,h+u,a,h+u),t.bezierCurveTo(a-f,h+u,a-l,h+g,a-l,h),t.closePath()),Mu.fillCanvas(t,o,e.x-i,e.y-n),Mu._stroke(t,s,e.x-i,e.y-n)},rectangle:function(t,e,i,n,r){var s=e.x,o=e.y;t.beginPath(),t.rect(s,o,i.width,i.height),Mu.fillCanvas(t,r,s,o),Mu._stroke(t,n,s,o)},sector:function(t,e,i,n,r,s){var o=bu,a=n[0],h=n[1];function l(t,e,i,n,a,h){var l=o*-h,c=o*-a;t.beginPath(),t.moveTo(e,i),t.arc(e,i,n,l,c),t.lineTo(e,i),Mu.fillCanvas(t,s,e-n,i-n),Mu._stroke(t,r,e-n,i-n)}l(t,e.x,e.y,i,a,h)},_isPattern:function(t){return!Ya(t)&&!("addColorStop"in t)},drawCross:function(t,e,i,n,r){t.canvas._drawn=!0,t.strokeStyle=r,t.lineWidth=n,t.beginPath(),t.moveTo(e-5,i),t.lineTo(e+5,i),t.moveTo(e,i-5),t.lineTo(e,i+5),t.stroke()},copy:function(t,e){var i=e||Hc("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0),i},pixelRect:function(t,e,i,n){var r=t.lineWidth,s=t.globalAlpha,o=!1;if(r>0&&i>0)o=!0,i<1&&(t.globalAlpha*=i);else{if(!(n>0))return;n<1&&(t.globalAlpha*=n)}t.canvas._drawn=!0,o?t.strokeRect(e[0],e[1],1,1):t.fillRect(e[0],e[1],1,1),t.globalAlpha!==s&&(t.globalAlpha=s)}};function Su(t,e,i,n){var r=e.x,s=e.y,o=i.x,a=i.y,h=n,l=function(t,e){return t<=e},c=function(t,e){return t>=e},u=function(t,e){return Math.min(t,e)},d=function(t,e){return Math.max(t,e)},f={thereYet:c,cap:u},p={thereYet:c,cap:u};s-a>0&&(p.thereYet=l,p.cap=d),r-o>0&&(f.thereYet=l,f.cap=d),t.moveTo(r,s);for(var g,m,_=r,v=s,y=0,x=!0;!f.thereYet(_,o)||!p.thereYet(v,a);)g=Math.atan2(a-s,o-r),m=h[y],_=f.cap(o,_+Math.cos(g)*m),v=p.cap(a,v+Math.sin(g)*m),x?t.lineTo(_,v):t.moveTo(_,v),y=(y+1)%h.length,x=!x}var Cu="data:image/";function Tu(t){return t.substring(0,Cu.length)===Cu?t:ll(t)}function Pu(t,e){t.filter=e.filter,t.fillStyle=e.fillStyle,t.globalAlpha=e.globalAlpha,t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=e.shadowOffsetY,t.strokeStyle=e.strokeStyle}var Au="undefined"!=typeof Promise?Promise:ca,Eu=function(t){return function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.on=function(t,e,i){if(!t)return this;if(!Ya(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var n,r,s=t.toLowerCase().split(" ");i||(i=this);for(var o=0,a=s.length;o<a;o++){n=s[o],(r=this._eventMap[n])||(r=[],this._eventMap[n]=r);var h=r.length;if(h>0)for(var l=0;l<h;l++)if(e===r[l].handler&&r[l].context===i)return this;r.push({handler:e,context:i})}return this},i.addEventListener=function(){return this.on.apply(this,arguments)},i.once=function(t,e,i){if(!Ya(t)){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=this._wrapOnceHandler(r,t[r],i));return this._switch("on",n)}for(var s=t.split(" "),o=0,a=s.length;o<a;o++)this.on(s[o],this._wrapOnceHandler(s[o],e,i));return this},i.off=function(t,e,i){if(!this._eventMap||!t)return this;if(!Ya(t))return this._switch("off",t,e);if(!e)return this;var n,r,s,o=t.split(" ");i||(i=this);for(var a=0,h=o.length;a<h;a++){if(s="Z__"+(n=o[a].toLowerCase()),!(r=this._eventMap[n]))return this;for(var l=r.length-1;l>=0;l--){var c=r[l];e!==c.handler&&e!==c.handler[s]||c.context!==i||(delete c.handler[s],r.splice(l,1))}r.length||delete this._eventMap[n]}return this},i.removeEventListener=function(){return this.off.apply(this,arguments)},i.listens=function(t,e,i){if(!this._eventMap||!Ya(t))return 0;var n=this._eventMap[t.toLowerCase()];if(!n||!n.length)return 0;if(!e)return n.length;for(var r=0,s=n.length;r<s;r++)if(e===n[r].handler&&(Za(i)||n[r].context===i))return 1;return 0},i.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},i.copyEventListeners=function(t){var e,i=t._eventMap;if(!i)return this;for(var n in i)for(var r=0,s=(e=i[n]).length;r<s;r++)this.on(n,e[r].handler,e[r].context);return this},i.fire=function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},i._wrapOnceHandler=function(t,e,i){var n=this,r="Z__"+t,s=!1,o=function a(){s||(delete o[r],s=!0,i?e.apply(i,arguments):e.apply(this,arguments),n.off(t,a,this))};return o[r]=e,o},i._switch=function(t,e,i){for(var n in e)e.hasOwnProperty(n)&&this[t](n,e[n],i);return this},i._clearListeners=function(t){this._eventMap&&Ya(t)&&(this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null))},i._clearAllListeners=function(){this._eventMap=null},i._setEventParent=function(t){return this._eventParent=t,this},i._setEventTarget=function(t){return this._eventTarget=t,this},i._fire=function(t,e){if(!this._eventMap)return this;var i=this._eventMap[t.toLowerCase()];if(!i)return this;e||(e={}),e.type=t,e.target=this._eventTarget||this;for(var n,r,s=i.slice(0),o=0,a=s.length;o<a;o++)s[o]&&(n=s[o].context,!0,r=Wa({},e),!1===(n?s[o].handler.call(n,r):s[o].handler(r))&&e.domEvent&&Yc(e.domEvent));return this},e}(t)},Lu=function(){function t(t){this.target=t}var e=t.prototype;return e.enable=function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},e.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},e.enabled=function(){return!!this._enabled},e.remove=function(){this.disable(),delete this.target,delete this.dom},t}(),Ru=Eu(Lu),Ou=function(){function t(t){if(!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(t),this.callInitHooks()}var e=t.prototype;return e.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},e.setOptions=function(t){if(this.hasOwnProperty("options")||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},e.config=function(t){if(!t){var e={};for(var i in this.options)this.options.hasOwnProperty(i)&&(e[i]=this.options[i]);return e}if(2===arguments.length){var n={};n[t]=arguments[1],t=n}for(var r in t)this.options[r]=t[r],this[r]&&this[r]instanceof Ru&&(t[r]?this[r].enable():this[r].disable());return this.onConfig(t),this},e.onConfig=function(){},e._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var i=t._initHooks;if(i&&i!==e._initHooks)for(var n=0;n<i.length;n++)i[n].call(this)}},t.addInitHook=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];var r="function"==typeof t?t:function(){this[t].apply(this,i)},s=this.prototype,o=Object.getPrototypeOf(s);return s._initHooks&&s._initHooks!==o._initHooks||(s._initHooks=[]),s._initHooks.push(r),this},t.include=function(){for(var t=0;t<arguments.length;t++)Wa(this.prototype,t<0||arguments.length<=t?void 0:arguments[t]);return this},t.mergeOptions=function(t){var e=this.prototype,i=Object.getPrototypeOf(e);return e.options&&e.options!==i.options||(e.options=e.options?Object.create(e.options):{}),Wa(e.options,t),this},t}(),Du={},Iu=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return Nh(e,t),e.registerJSONType=function(t){return t?(Du[t]=this,this):this},e.getJSONClass=function(t){return t?Du[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in Du)if(Du[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered geometry class!");return this._jsonType},e}(t)},ku={},zu=function(){function t(){this._tree=ua(9,["[0]","[1]","[2]","[3]"])}var e=t.prototype;return e.collides=function(t){return ku.minX=t[0],ku.minY=t[1],ku.maxX=t[2],ku.maxY=t[3],this._tree.collides(ku)},e.insertBox=function(t){return this._tree.insert(t),this},e.bulkInsertBox=function(t){return this._tree.load(t),this},e.clear=function(){return this._tree.clear(),this},t}();function Nu(t){return function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},i.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var i=this._handlers.indexOf(e);i>=0&&this._handlers.splice(i,1),this[t].remove(),delete this[t]}return this},i._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)}var Fu="touchstart mousedown",ju={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},Bu={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},Uu=function(t){function e(e,i){var n;return void 0===i&&(i={}),(n=t.call(this,null)||this).dom=e,n.options=i,n}Nh(e,t);var i=e.prototype;return i.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},uu(this.dom,Fu,this._onMouseDown,this),this):this},i.disable=function(){return this.dom?(this._offEvents(),du(this.dom,Fu,this._onMouseDown),delete this._onMouseDown,this):this},i.onMouseDown=function(t){if((this.options.rightclick||2!==t.button)&&!(t.touches&&t.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var e=this.dom;e.setCapture?e.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),e.ondragstart=function(){return!1},delete this.moved;var i=t.touches?t.touches[0]:t;this.startPos=new Gh(i.clientX,i.clientY),du(document,ju[t.type],this.onMouseMove),du(document,Bu[t.type],this.onMouseUp),uu(document,ju[t.type],this.onMouseMove,this),uu(document,Bu[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||(du(this.dom,"mouseleave",this.onMouseUp),uu(this.dom,"mouseleave",this.onMouseUp,this)),this.fire("mousedown",{domEvent:t,mousePos:new Gh(i.clientX,i.clientY)})}},i.onMouseMove=function(t){if(t.touches&&t.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var e=t.touches?t.touches[0]:t,i=new Gh(e.clientX,e.clientY).sub(this.startPos);(i.x||i.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new Gh(e.clientX,e.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},i.onMouseUp=function(t){var e=t.changedTouches?t.changedTouches[0]:t;this._offEvents();var i={domEvent:t};qa(e.clientX)&&(i.mousePos=new Gh(parseInt(e.clientX,0),parseInt(e.clientY,0))),this.moved&&(i.interupted=this.interupted,this.fire("dragend",i),delete this.interupted,delete this.moved),this.fire("mouseup",i)},i._offEvents=function(){var t=this.dom;if(du(t,"mouseleave",this.onMouseUp),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in ju)du(document,ju[e],this.onMouseMove),du(document,Bu[e],this.onMouseUp);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP)}},e}(Ru),Gu=function(t){function e(){return t.apply(this,arguments)||this}return Nh(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?Qh(t,(function(t){return[t.x,t.y]})):[t.x,t.y]},e.toCoordinates=function(t){if(qa(t[0])&&qa(t[1]))return new e(t);if(t instanceof e)return t;for(var i=[],n=0,r=t.length;n<r;n++){var s=t[n];Array.isArray(s)?qa(s[0])?i.push(new e(s)):i.push(e.toCoordinates(s)):s instanceof e?i.push(s):i.push(new e(s))}return i},e}(Uh),Hu=function(){function t(t,e){this.type=t,this.properties=e}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();Hu.WGS84=Hu.createProj4("+proj=longlat +datum=WGS84 +no_defs"),Hu.EPSG4326=Hu.WGS84,Hu.EPSG3857=Hu.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),Hu.IDENTITY=Hu.createProj4("+proj=identity +no_defs"),Hu.CGCS2000=Hu.createProj4("+proj=longlat +datum=CGCS2000"),Hu.EPSG4490=Hu.CGCS2000,Hu.BD09LL=Hu.createProj4("+proj=longlat +datum=BD09"),Hu.GCJ02=Hu.createProj4("+proj=longlat +datum=GCJ02");var Vu,Wu=new Gh(0,0),Zu=new Gu(0,0),qu=new Gu(0,0),Xu=new Gu(0,0),Ju=new Gu(0,0),Yu=new Gu(0,0),Qu=new Gu(0,0),Ku=new Gu(0,0),$u=new Gu(0,0),td=[],ed=[],id=function(){function t(t,e,i,n){this._clazz=Gu;var r=arguments.length,s=r>0?arguments[r-1]:null;s&&s.unproject&&(this.projection=arguments[r-1]),this._dirty=!0,this._initialize(t,e,i,n)}var e=t.prototype;return e._initialize=function(t,e,i,n){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!Za(t)){var r=this.projection;qa(t)&&qa(e)&&qa(i)&&qa(n)?r?this.set(t,e,i,n):this.set(Math.min(t,i),Math.min(e,n),Math.max(t,i),Math.max(e,n)):Array.isArray(t)?r?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3])):qa(t.x)&&qa(e.x)&&qa(t.y)&&qa(e.y)?r?this.set(t.x,t.y,e.x,e.y):(t.x>e.x?(this.xmin=e.x,this.xmax=t.x):(this.xmin=t.x,this.xmax=e.x),t.y>e.y?(this.ymin=e.y,this.ymax=t.y):(this.ymin=t.y,this.ymax=e.y)):qa(t.xmin)&&qa(t.xmax)&&qa(t.ymin)&&qa(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},e._add=function(t){return this._dirty=!0,Za(t.x)?Za(t.xmin)?Za(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},e.add=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._add.apply(t,arguments)},e._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},e._sub=function(t){return this._dirty=!0,Za(t.x)?Za(t.xmin)?Za(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._sub.apply(t,arguments)},e.substract=function(){return this.sub.apply(this,arguments)},e.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},e._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},e.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},e.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},e.getCenter=function(t){var e=(this.xmin+this.xmax)/2,i=(this.ymin+this.ymax)/2;return t?(t.set(e,i),t):new this._clazz(e,i)},e.isValid=function(){return!(Za(this.xmin)||Za(this.ymin)||Za(this.xmax)||Za(this.ymax))},e.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},e.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),i=Math.max(this.pymin,t.pymin),n=Math.min(this.pxmax,t.pxmax),r=Math.min(this.pymax,t.pymax),s=!(e>n||i>r);return s},e.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},e.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e)if(void 0!==t.x){var i=Zu;Array.isArray(t)?(i.x=t[0],i.y=t[1]):(i.x=t.x,i.y=t.y),t=e.project(i,i)}else void 0!==t.xmin&&this._project(t);return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},e.getWidth=function(){return Math.abs(this.xmax-this.xmin)},e.getHeight=function(){return Math.abs(this.ymax-this.ymin)},e.getSize=function(){return new cc(this.getWidth(),this.getHeight())},e.set=function(t,e,i,n){return this.xmin=t,this.ymin=e,this.xmax=i,this.ymax=n,this._dirty=!0,this},e.__combine=function(t){var e,i,n,r;void 0!==t.x&&(Vu.xmin=Vu.xmax=t.x,Vu.ymin=Vu.ymax=t.y,t=Vu),this._project(t),this._project(this),qa(this.pxmin)?(e=Math.min(this.pxmin,t.pxmin),i=Math.min(this.pymin,t.pymin),n=Math.max(this.pxmax,t.pxmax),r=Math.max(this.pymax,t.pymax)):(e=t.pxmin,i=t.pymin,n=t.pxmax,r=t.pymax);var s=this.projection;if(s){qu.set(e,i),Xu.set(n,r);var o=s.unproject(qu,qu),a=s.unproject(Xu,Xu);e=o.x,i=o.y,n=a.x,r=a.y}return ed[0]=e,ed[1]=i,ed[2]=n,ed[3]=r,ed},e._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},e.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},e.intersection=function(t){if(!this.intersects(t))return null;Ju.x=Math.max(this.pxmin,t.pxmin),Ju.y=Math.max(this.pymin,t.pymin),Yu.x=Math.min(this.pxmax,t.pxmax),Yu.y=Math.min(this.pymax,t.pymax);var e=Ju,i=Yu,n=this.projection;return n&&(e=n.unproject(e,e),i=n.unproject(i,i)),new this.constructor(e,i,n)},e.expand=function(t){var e,i;return qa(t)?e=i=t:(e=t.width||t.x||t[0]||0,i=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-i,this.xmax+e,this.ymax+i,this.projection)},e._expand=function(t){var e,i;return qa(t)?e=i=t:(e=t.width||t.x||t[0]||0,i=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=i,this.xmax+=e,this.ymax+=i,this._dirty=!0,this},e.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},e.toArray=function(t){var e=this.xmin,i=this.ymin,n=this.xmax,r=this.ymax;return t?(t[0].x=e,t[0].y=r,t[1].x=n,t[1].y=r,t[2].x=n,t[2].y=i,t[3].x=e,t[3].y=i,t[4].x=e,t[4].y=r,t):[new this._clazz([e,r]),new this._clazz([n,r]),new this._clazz([n,i]),new this._clazz([e,i]),new this._clazz([e,r])]},e.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},e.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},e.convertTo=function(t,e){if(!this.isValid())return null;var i,n=e||new this.constructor;return e&&n.set(null,null,null,null),this._clazz===Gu?i=Qu:this._clazz===Gh&&(i=Wu),i.x=this.xmin,i.y=this.ymax,n._combine(t(i)),i.x=this.xmax,n._combine(t(i)),i.y=this.ymin,n._combine(t(i)),i.x=this.xmin,n._combine(t(i)),n},e._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){Ku.set(t.xmax,t.ymin),$u.set(t.xmin,t.ymax),td[0]=Ku,td[1]=$u;var i=e.projectCoords(td),n=i[0],r=i[1];t.pxmin=Math.min(n.x,r.x),t.pymin=Math.min(n.y,r.y),t.pxmax=Math.max(n.x,r.x),t.pymax=Math.max(n.y,r.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}else t&&(t.pxmin=t.pxmax=t.pymin=t.pymax=null)},t}();Vu=new id(0,0,0,0);var nd=function(t){function e(e,i,n,r){var s;return(s=t.call(this,e,i,n,r)||this)._clazz=Gh,s}return Nh(e,t),e}(id),rd=function(){function t(t){this.matrix=t}var e=t.prototype;return e.transform=function(t,e,i){var n=this.matrix[0]*(t.x-this.matrix[2])/e,r=-this.matrix[1]*(t.y-this.matrix[3])/e;return i?(i.x=n,i.y=r,i):new Gh(n,r)},e.untransform=function(t,e,i){var n=t.x*e/this.matrix[0]+this.matrix[2],r=t.y*e/-this.matrix[1]+this.matrix[3];return i?(i.x=n,i.y=r,i):new Gu(n,r)},t}(),sd={project:function(){},unproject:function(){},projectCoords:function(t,e){var i=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return Qh(t,this.project,this);if(Array.isArray(t[0]))return t.map((function(t){return i.projectCoords(t,e)}));for(var n,r,s,o,a,h,l=!1!==e,c=this.getCircum(),u=this.getSphereExtent(),d=u.sx,f=u.sy,p=t[0],g=[this.project(p)],m=1,_=t.length;m<_;m++)o=(s=t[m]).x-p.x,a=s.y-p.y,h=this.project(s),Math.abs(o)>180&&l&&(void 0===n&&(n=s.x>p.x),n&&(h._add(-c.x*$h(o)*d,0),s._add(-360*$h(o),0))),Math.abs(a)>90&&l&&(void 0===r&&(r=s.y<p.y),r&&(h._add(0,-c.y*$h(a)*f),s._add(0,-180*$h(a)))),p=s,g.push(h);return g},unprojectCoords:function(t){return t?Array.isArray(t)?Qh(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),i=new Gu(t);return e.contains(i)||(i.x=il(t.x,e.xmin,e.xmax),i.y=il(t.y,e.ymin,e.ymax)),i},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new Gu(180,90)),e=this.project(new Gu(-180,-90));this.extent=new id(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},od={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var i=0,n=0,r=t.length;n<r-1;n++)i+=this.measureLenBetween(t[n],t[n+1]);return i}},ad=Wa({measure:"IDENTITY",measureLenBetween:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(nM){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,i=0,n=t.length;i<n;i++){var r=t[i],s=null;s=i===n-1?t[0]:t[i+1],e+=r.x*s.y-r.y*s.x}return Math.abs(e/2)},locate:function(t,e,i,n){return(n=n||new Gu(0,0)).set(t.x,t.y),this._locate(n,e,i)},_locate:function(t,e,i){return t?(e||(e=0),i||(i=0),e||i?(t.x=t.x+e,t.y=t.y+i,t):t):null},rotate:function(t,e,i){return t=new Gu(t.x,t.y),this._rotate(t,e,i)},_rotate:function(){var t=new Gh(0,0);return function(e,i,n){return t.x=e.x-i.x,t.y=e.y-i.y,t._rotate(n*Math.PI/180),e.x=i.x+t.x,e.y=i.y+t.y,e}}()},od),hd=function(){function t(t){this.radius=t}var e=t.prototype;return e.measureLenBetween=function(t,e){if(!t||!e)return 0;var i=eh(t.y),n=eh(e.y),r=i-n,s=eh(t.x)-eh(e.x);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(n)*Math.pow(Math.sin(s/2),2))),i*=this.radius,Math.round(1e5*i)/1e5},e.measureArea=function(t){var e,i=eh(this.radius),n=0,r=t,s=r.length;if(s<3)return 0;for(e=0;e<s-1;e++){var o=r[e],a=r[e+1];n+=o.x*i*Math.cos(eh(o.y))*a.y*i-a.x*i*Math.cos(eh(a.y))*o.y*i}return s=r[e],r=r[0],n+=s.x*i*Math.cos(eh(s.y))*r.y*i-r.x*i*Math.cos(eh(r.y))*s.y*i,.5*Math.abs(n)},e.locate=function(t,e,i,n){return(n=n||new Gu(0,0)).set(t.x,t.y),this._locate(n,e,i)},e._locate=function(t,e,i){if(!t)return null;if(e||(e=0),i||(i=0),!e&&!i)return t;var n,r,s=eh(t.y);if(0!==i){var o=Math.abs(i);r=il(180*(s+=2*Math.sin(o/(2*this.radius))*(i>0?1:-1))/Math.PI,-90,90)}else r=t.y;if(0!==e){var a=Math.abs(e),h=eh(t.x);n=il(180*(h+=2*Math.sqrt(Math.pow(Math.sin(a/(2*this.radius)),2)/Math.pow(Math.cos(s),2))*(e>0?1:-1))/Math.PI,-180,180)}else n=t.x;return t.x=n,t.y=r,t},e.rotate=function(t,e,i){return t=new Gu(t),this._rotate(t,e,i)},e._rotate=function(t,e,i){var n=function(t,e,i){void 0===i&&(i={});var n;n=i.final?ld(e,t):ld(t,e);return n>180?-(360-n):n}(e,t),r=n-i,s=this.measureLenBetween(e,t);return t.x=e.x,t.y=e.y,function(t,e,i,n){var r=e/n,s=t.x*Math.PI/180,o=eh(t.y),a=eh(i),h=r*Math.cos(a),l=o+h;Math.abs(l)>Math.PI/2&&(l=l>0?Math.PI-l:-Math.PI-l);var c=Math.log(Math.tan(l/2+Math.PI/4)/Math.tan(o/2+Math.PI/4)),u=Math.abs(c)>1e-11?h/c:Math.cos(o),d=r*Math.sin(a)/u,f=s+d;return t.x=(180*f/Math.PI+540)%360-180,t.y=180*l/Math.PI,t}(t,s,r,this.radius)},t}();function ld(t,e){var i=eh(t.y),n=eh(e.y),r=eh(e.x-t.x);r>Math.PI&&(r-=2*Math.PI),r<-Math.PI&&(r+=2*Math.PI);var s=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(i/2+Math.PI/4));return(ih(Math.atan2(r,s))+360)%360}var cd=Wa({measure:"EPSG:4326",sphere:new hd(6378137),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},od),ud=Wa({measure:"BAIDU",sphere:new hd(6370996.81),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},od),dd=cd,fd={};function pd(t){fd[t.measure]=t}pd(ad),pd(cd),pd(ud);var gd={getInstance:function(t){if(!t)return dd;for(var e in fd)if($a(fd,e)){var i=fd[e].measure;if(!i)continue;if(t.toLowerCase()===i.toLowerCase())return fd[e]}return null}},md=Wa({},sd,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t,e){var i=this.rad,n=this.metersPerDegree,r=this.maxLatitude,s=t.x,o=Math.max(Math.min(r,t.y),-r),a=s*n,h=(0===o?0:Math.log(Math.tan((90+o)*i/2))/i)*n;return e?(e.x=a,e.y=h,e):new Gu(a,h)},unproject:function(t,e){var i,n=this.rad,r=this.metersPerDegree,s=t.x/r,o=t.y;0===o?i=0:(i=o/r,i=(2*Math.atan(Math.exp(i*n))-Math.PI/2)/n),Math.abs(Math.abs(s)-180)<1e-7&&(s=180*$h(s)),Math.abs(Math.abs(i)-this.maxLatitude)<1e-7&&(i=$h(i)*this.maxLatitude);var a=il(s,-180,180),h=il(i,-this.maxLatitude,this.maxLatitude);return e?(e.x=a,e.y=h,e):new Gu(a,h)}},cd),_d=Wa({},sd,{code:"EPSG:4326",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new Gu(t)},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new Gu(t)}},cd),vd=Wa({},_d,{code:"EPSG:4490"}),yd=Wa({},sd,{code:"BAIDU",project:function(t,e){return this.convertLL2MC(t,e)},unproject:function(t,e){return this.convertMC2LL(t,e)}},ud,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t,e){for(var i,n=0,r=this.MCBAND.length;n<r;n++)if(Math.abs(t.y)>=this.MCBAND[n]){i=this.MC2LL[n];break}return this.convertor(t,i,e)},convertLL2MC:function(t,e){var i,n,r;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var s=new Gu(t.x,t.y);for(n=0,r=this.LLBAND.length;n<r;n++)if(s.y>=this.LLBAND[n]){i=this.LL2MC[n];break}if(!i)for(n=this.LLBAND.length-1;n>=0;n--)if(s.y<=-this.LLBAND[n]){i=this.LL2MC[n];break}return this.convertor(t,i,e)},convertor:function(t,e,i){if(!t||!e)return null;var n=e[0]+e[1]*Math.abs(t.x),r=Math.abs(t.y)/e[9],s=e[2]+e[3]*r+e[4]*r*r+e[5]*r*r*r+e[6]*r*r*r*r+e[7]*r*r*r*r*r+e[8]*r*r*r*r*r*r;return n*=t.x<0?-1:1,s*=t.y<0?-1:1,i?(i.x=n,i.y=s,i):new Gu(n,s)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,i){return null!=e&&(t=Math.max(t,e)),null!=i&&(t=Math.min(t,i)),t},getLoop:function(t,e,i){if(t===1/0)return i;if(t===-1/0)return e;for(;t>i;)t-=i-e;for(;t<e;)t+=i-e;return t}}),xd=Wa({},sd,{code:"IDENTITY",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()}},ad),wd=md,bd=Object.freeze({EPSG3857:md,DEFAULT:wd,EPSG4326:_d,EPSG4490:vd,BAIDU:yd,IDENTITY:xd,Common:sd}),Md=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return Nh(e,t),e.registerRenderer=function(t,e){var i=this.prototype,n=Object.getPrototypeOf(i);return i._rendererClasses&&i._rendererClasses!==n._rendererClasses||(i._rendererClasses=i._rendererClasses?Object.create(i._rendererClasses):{}),i._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)},Sd={};function Cd(t,e){Sd[t]=e}var Td;function Pd(){if("undefined"==typeof window)return null;if(!Td){var t=function(){var t="\n    var adapters = {};\n    onmessage = function (msg) {\n        msg = msg.data;\n        if (msg.messageType === 'batch') {\n            const messages = msg.messages;\n            if (messages) {\n                for (let i = 0; i < messages.length; i++) {\n                    dispatch(messages[i]);\n                }\n            }\n        } else {\n            dispatch(msg);\n        }\n    };\n\n    function dispatch(msg) {\n        var workerKey = msg.workerKey;\n        var adapter = adapters[workerKey];\n        if (!adapter) {\n            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);\n            return;\n        }\n        try {\n            adapter.onmessage(msg, wrap(msg.callback));\n        } catch (err) {\n            post(msg.callback, workerKey + ':' + err.message);\n            console.error(err);\n            throw err;\n        }\n    }\n\n    function post(callback, err, data, buffers) {\n        var msg = {\n            callback : callback\n        };\n        if (err) {\n            msg.error = err;\n        } else {\n            msg.data = data;\n        }\n        if (buffers && buffers.length > 0) {\n            postMessage(msg, buffers);\n        } else {\n            postMessage(msg);\n        }\n    }\n    function wrap(callback) {\n        return function (err, data, buffers) {\n            post(callback, err, data, buffers);\n        };\n    }\n    var workerExports;\n";for(var e in Sd){var i=Sd[e];Qa(i)&&0===i.length&&(i=i()),t+="\n    workerExports = {};\n    ("+i+")(workerExports, self);\n    adapters['"+e+"'] = workerExports",t+="\n    workerExports.initialize && workerExports.initialize(self);\n        "}return t+"\n    workerExports = null;\n"}();Td=window.URL.createObjectURL(new Blob([t],{type:"text/javascript"})),Sd=null}return Td}var Ad,Ed="undefined"!=typeof window?window.navigator.hardwareConcurrency||4:0,Ld=Math.max(Math.floor(Ed/2),1),Rd=function(){function t(t){void 0===t&&(t=50),this._limit=t,this._messages=[],this.buffers=[]}var e=t.prototype;return e.addMessage=function(t,e){if(this._messages.push(t),Array.isArray(e))for(var i=0;i<e.length;i++)this.buffers.indexOf(e[i])<0&&this.buffers.push(e[i])},e.isFull=function(){return this._messages.length>=this._limit},e.getMessage=function(){return{messageType:"batch",messages:this._messages}},t}(),Od=function(){function t(){this.active={},this.workerCount="undefined"!=typeof window?window.MAPTALKS_WORKER_COUNT||Ld:0,this._messages=[],this._messageBuffers=[]}var e=t.prototype;return e.acquire=function(t){if(!this.workers){this.workers=[];for(var e=Pd(),i=0;i<this.workerCount;i++){var n=new Worker(e);n.id=i,this.workers.push(n)}URL.revokeObjectURL(e)}return this.active[t]=!0,this.workers.slice()},e.release=function(t){delete this.active[t],0===Object.keys(this.active).length&&(this.workers.forEach((function(t){t.terminate()})),this.workers=null)},e.addMessage=function(t,e,i){var n=this._messages[t];n&&n.length||(n=this._messages[t]=[new Rd]);var r=n[n.length-1];r.isFull()&&(r=new Rd,this._messages[t].push(r)),r.addMessage(e,i)},e.commit=function(){if(this._messages.length)for(var t=0;t<this._messages.length;t++)if(this._messages[t]&&this._messages[t].length){var e=this._messages[t].shift();this.workers[t].postMessage(e.getMessage(),e.buffers)}},t}();function Dd(){return Ad||(Ad=new Od),Ad}jh&&jh((function t(){Dd().commit(),jh(t)}));var Id=0,kd=[],zd=function(){function t(t){var e=this;this.workerKey=t,this.workerPool=Dd(),this.currentActor=0,this.actorId=Zh(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach((function(t){t.addEventListener("message",e.receiveFn,!1)}))}var e=t.prototype;return e.isActive=function(){return!!this.workers},e.broadcast=function(t,e,i){var n=this;return i=i||function(){},function(t,e,i){t.length||i(null,[]);var n=t.length,r=new Array(t.length),s=null;t.forEach((function(t,o){e(t,(function(t,e){t&&(s=t),r[o]=e,0==--n&&i(s,r)}))}))}(this.workers,(function(i,r){n.send(t,e,r,i.id)}),i),this},e.send=function(t,e,i,n){var r=i?this.actorId+":"+this.callbackID++:null;return i&&(this.callbacks[r]=i),this.post({data:t,callback:String(r)},e,n),this},e.receive=function(t){var e=this,i=t.data,n=i.callback,r=this.callbacks[n];delete this.callbacks[n],"<request>"===i.type?this.actorId===i.actorId&&this[i.command](i.params,(function(t,n,r){var s={type:"<response>",callback:i.callback};t?s.error=t.message:s.data=n,e.post(s,r||kd,i.workerId)})):r&&i.error?r(i.error):r&&r(null,i.data)},e.remove=function(){var t=this;this.workers.forEach((function(e){e.removeEventListener("message",t.receiveFn,!1)})),this.workerPool.release(this.actorId),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},e.post=function(t,e,i){return("number"!=typeof i||isNaN(i))&&(i=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),t.workerId=i,t.workerKey=this.workerKey,t.actorId=this.actorId,this.workerPool.addMessage(i,t,e||kd),i},e.getDedicatedWorker=function(){return Id=(Id+1)%this.workerPool.workerCount},t}();var Nd="core-fetch-image",Fd=[],jd=function(t){function e(){return t.call(this,Nd)||this}return Nh(e,t),e.prototype.fetchImage=function(t,e){var i={url:t};this.send(i,Fd,e)},e}(zd),Bd=function(t){function e(e){var i;return(i=t.call(this)||this).layer=e,i._painted=!1,i._drawTime=0,!zh.decodeImageInWorker||"gl"!==e.options.renderer&&zh.safari||(i._resWorkerConn=new jd),i.setToRedraw(),i}Nh(e,t);var i=e.prototype;return i.render=function(t){this.prepareRender(),this.getMap()&&this.layer.isVisible()&&(this.resources||(this.resources=new Ud),this.checkAndDraw(this._tryToDraw,t))},i.checkAndDraw=function(t){var e=this;this._toRedraw=!1;for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];if(this.checkResources){var s=this.checkResources();s.length>0?(this._loadingResource=!0,this.loadResources(s).then((function(){e._loadingResource=!1,e.layer&&(e.layer.fire("resourceload"),e.setToRedraw())}))):t.call.apply(t,[this].concat(n))}else t.call.apply(t,[this].concat(n))},i.testIfNeedRedraw=function(){var t=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(t.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},i.needToRedraw=function(){var t=this.getMap();return!(!t.isInteracting()&&!t.getRenderer().isViewChanged())&&!(!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},i.onSkipDrawOnInteracting=function(){},i.isLoadingResource=function(){return this._loadingResource},i.isRenderComplete=function(){return!!this._renderComplete},i.mustRenderOnInteracting=function(){return!this._painted},i.setToRedraw=function(){return this._toRedraw=!0,this},i.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},i.isCanvasUpdated=function(){return!!this._canvasUpdated},i.remove=function(){this.onRemove(),delete this._loadingResource,delete this.southWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,this.resources&&this.resources.remove(),delete this.resources,delete this.layer},i.onRemove=function(){},i.onAdd=function(){},i.getMap=function(){return this.layer?this.layer.getMap():null},i.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.southWest)._add(0,-t.height);return{image:this.canvas,layer:this.layer,point:e}},i.clear=function(){this.clearCanvas()},i.isBlank=function(){return!this._painted},i.show=function(){this.setToRedraw()},i.hide=function(){this.clear(),this.setToRedraw()},i.setZIndex=function(){this.setToRedraw()},i.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown||this.layer.isVisible&&!this.layer.isVisible())return!1;var e=this.getMap(),i=e.getDevicePixelRatio(),n=e.getSize();if(t.x<0||t.x>n.width*i||t.y<0||t.y>n.height*i)return!1;var r=this.getImageData&&this.getImageData();if(r){var s=Math.round(i*t.x),o=Math.round(i*t.y)*r.width*4+4*s;return r.data[o+3]>0}try{if(this.context.getImageData(i*t.x,i*t.y,1,1).data[3]>0)return!0}catch(a){return this._errorThrown||(console,this._errorThrown=!0),!1}return!1},i.loadResources=function(t){this.resources||(this.resources=new Ud);var e=this.resources,i=[];if(rl(t))for(var n={},r=t.length-1;r>=0;r--){var s=t[r];s&&s.length&&!n[s.join("-")]&&(n[s.join("-")]=1,e.isResourceLoaded(s,!0)||i.push(new Au(this._promiseResource(s))))}return Au.all(i)},i.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t._get2DExtent(),this.southWest=t._containerPointToPoint(new Gh(0,t.height))},i.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),i=t.getDevicePixelRatio(),n=Math.round(i*e.width),r=Math.round(i*e.height);if(this.layer._canvas){var s=this.layer._canvas;s.width=n,s.height=r,s.style&&(s.style.width=e.width+"px",s.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=Mu.createCanvas(n,r,t.CanvasClass);this.onCanvasCreate()}},i.onCanvasCreate=function(){},i.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=Mu.getCanvas2DContext(this.canvas),this.context)){this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var t=this.getMap().getDevicePixelRatio();1!==t&&this.context.scale(t,t)}},i.resetCanvasTransform=function(){if(this.context){var t=this.getMap().getDevicePixelRatio();this.context.setTransform(t,0,0,t,0,0)}},i.resizeCanvas=function(t){var e=this.canvas;if(e){var i=t||this.getMap().getSize(),n=this.getMap().getDevicePixelRatio(),r=Sl(i,n),s=r.width,o=r.height,a=r.cssWidth,h=r.cssHeight;!this.layer._canvas||e.style.width===a&&e.style.height===h||(e.style.width=a,e.style.height=h),e.width===s&&e.height===o||(e.height=o,e.width=s,1!==n&&this.context&&this.context.scale(n,n))}},i.clearCanvas=function(){if(this.context&&this.getMap()){var t=1/this.getMap().getDevicePixelRatio(),e=this.canvas.width*t,i=this.canvas.height*t;Mu.clearRect(this.context,0,0,Math.max(e,this.canvas.width),Math.max(i,this.canvas.height))}},i.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getMaskPainter().get2DExtent();return e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},i.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;var i=this.southWest,n=this.getMap();this.southWest=n._containerPointToPoint(new Gh(0,n.height)),t.save();var r=n.getDevicePixelRatio();if(1!==r&&(t.save(),t.scale(r,r)),e.getGeometries){t.isMultiClip=!0;var s=e.getGeometries()||[];t.beginPath(),s.forEach((function(e){e._getMaskPainter().paint(null,t)})),t.stroke(),delete t.isMultiClip}else{e._getMaskPainter().paint(null,t)}return 1!==r&&t.restore(),t.clip(),this.southWest=i,!0},i.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,southWest:this.southWest}},i.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},i.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},i.onZoomStart=function(){},i.onZoomEnd=function(){this.setToRedraw()},i.onZooming=function(){},i.onMoveStart=function(){},i.onMoving=function(){},i.onMoveEnd=function(){this.setToRedraw()},i.onResize=function(){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},i.onDragRotateStart=function(){},i.onDragRotating=function(){},i.onDragRotateEnd=function(){this.setToRedraw()},i.onSpatialReferenceChange=function(){},i.getDrawTime=function(){return this._drawTime},i._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},i._drawAndRecord=function(t){if(this.getMap()){var e=this._painted;this._painted=!0;var i=Va();this.draw(t),i=Va()-i,this._drawTime=e?i:i/2,e&&this.layer&&this.layer.options.logDrawTime}},i._promiseResource=function(t){var e=this,i=this.resources,n=this.layer.options.crossOrigin,r=this.layer.options.renderer||"";return function(s){if(i.isResourceLoaded(t,!0))s(t);else if(!Hh(t[0])&&e._resWorkerConn){var o=wl(t[0]);e._resWorkerConn.fetchImage(o,(function(i,n){i?s(t):xl(n,(function(i){e._cacheResource(t,i),s(t)}))}))}else{var a=new Image;Za(n)?"canvas"!==r&&(a.crossOrigin=""):a.crossOrigin=n,Hh(t[0])&&!nh&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),a.onload=function(){e._cacheResource(t,a),s(t)},a.onabort=function(e){console,e&&console,s(t)},a.onerror=function(e){i.markErrorResource(t),s(t)},Vh(a,t)}}},i._cacheResource=function(t,e){if(this.layer&&this.resources){var i=t[1],n=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===Hh(t[0])&&(zh.edge||zh.ie)){Za(i)&&(i=e.width||this.layer.options.defaultIconSize[0]),Za(n)&&(n=e.height||this.layer.options.defaultIconSize[1]);var r=Mu.createCanvas(i,n);Mu.image(r.getContext("2d"),e,0,0,i,n),e=r}this.resources.addResource(t,e)}},e}(Ou),Ud=function(){function t(){this.resources={},this._errors={}}var e=t.prototype;return e.addResource=function(t,e){var i=this;if(this.resources[t[0]]={image:e,width:+t[1],height:+t[2],refCnt:0},e&&!e.close&&zh.imageBitMap&&!zh.safari){if(e.src&&Hh(e.src))return;createImageBitmap(e).then((function(e){i.resources[t[0]]&&(i.resources[t[0]].image=e)}))}},e.isResourceLoaded=function(t,e){if(!t)return!1;var i=this._getImgUrl(t);if(this._errors[i])return!0;var n=this.resources[i];return!!n&&!(e&&Hh(t[0])&&(+t[1]>n.width||+t[2]>n.height))},e.login=function(t){var e=this.resources[t];e&&e.refCnt++},e.logout=function(t){var e=this.resources[t];e&&e.refCnt--<=0&&delete this.resources[t]},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},e.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},e.merge=function(t){if(!t)return this;for(var e in t.resources){var i=t.resources[e];this.addResource([e,i.width,i.height],i.image)}return this},e.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)$a(this.resources,e)&&t(e,this.resources[e]);return this},e._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},e.remove=function(){for(var t in this.resources){var e=this.resources[t];e&&e.image&&e.image.close&&e.image.close()}this.resources={}},t}();zh.decodeImageInWorker&&Cd(Nd,(function(){return"\nfunction (exports) {\n    exports.onmessage = function (msg, postResponse) {\n        var url = msg.data.url;\n        var fetchOptions = msg.data.fetchOptions;\n        requestImageOffscreen(url, function (err, data) {\n            var buffers = [];\n            if (data && data.data && data.data.buffer) {\n                buffers.push(data.data.buffer);\n            }\n            postResponse(err, data, buffers);\n        }, fetchOptions);\n    };\n\n    var offCanvas, offCtx;\n    function requestImageOffscreen(url, cb, fetchOptions) {\n        if (!offCanvas) {\n            offCanvas = new OffscreenCanvas(2, 2);\n            offCtx = offCanvas.getContext('2d',{willReadFrequently: true });\n        }\n        fetch(url, fetchOptions ? fetchOptions : {})\n            .then(response => response.blob())\n            .then(blob => createImageBitmap(blob))\n            .then(bitmap => {\n                var { width, height } = bitmap;\n                offCanvas.width = width;\n                offCanvas.height = height;\n                offCtx.drawImage(bitmap, 0, 0);\n                bitmap.close();\n                var imgData = offCtx.getImageData(0, 0, width, height);\n                // debugger\n                cb(null, { width, height, data: new Uint8Array(imgData.data) });\n            }).catch(err => {\n                console.warn('error when loading tile:', url);\n                console.warn(err);\n                cb(err);\n            });\n    }\n}"}));var Gd=10,Hd=10,Vd=1;var Wd=new Gh(0,0);function Zd(t,e,i,n,r,s,o){var a,h,l,c,u,d,f=Wd.set(e,i),p=t.set(f.x,f.y,f.x+s,f.y+o);return p._add(r),n&&(h=n,l=(a=p).xmin,c=a.ymin,u=a.xmax,d=a.ymax,tf.set(l,c,u,d),tf.convertTo((function(t){return t._rotate(h)}),a)),p}var qd=[];function Xd(t,e,i){var n=Kd(e,(i=i||$d(qd,e))[0],i[1]);return Zd(t,e.markerDx||0,e.markerDy||0,ef(e),n,i[0],i[1])}function Jd(t){return"rectangle"===t?"right":"middle"}function Yd(t){return"bar"===t||"pie"===t||"pin"===t?"top":"rectangle"===t?"bottom":"middle"}var Qd=new cc(0,0);function Kd(t,e,i){var n=2*(t.shadowBlur||0)+.5;Qd.width=e,Qd.height=i;var r=t.markerType,s=bc(Qd,t.markerHorizontalAlignment||Jd(r),t.markerVerticalAlignment||Yd(r));return s.x!==-e/2&&(s.x-=$h(s.x+e/2)*n),s.y!==-i/2&&(s.y-=$h(s.y+i/2)*n),s}function $d(t,e){var i=Kh(e.markerWidth,Gd),n=Kh(e.markerHeight,Hd),r=Kh(e.markerLineWidth,Vd),s=2*((e.shadowBlur||0)+Math.max(Math.abs(e.shadowOffsetX||0)+Math.abs(e.shadowOffsetY||0))),o=Math.round(i+r+s+1),a=Math.round(n+r+s+1);return t[0]=o,t[1]=a,t}var tf=new nd;function ef(t,e){void 0===e&&(e="markerRotation");var i=t[e];return qa(i)?-i*Math.PI/180:0}function nf(t,e,i){var n=e.markerFile,r=i?i.getImage(n):null,s=e.markerWidth||(r?r.width:0),o=e.markerHeight||(r?r.height:0);Qd.width=s,Qd.height=o;var a=bc(Qd,e.markerHorizontalAlignment||"middle",e.markerVerticalAlignment||"top");return Zd(t,e.markerDx||0,e.markerDy||0,ef(e),a,s,o)}function rf(t,e,i){var n=i.size,r=bc(n,e.textHorizontalAlignment,e.textVerticalAlignment);if(e.textHaloRadius){var s=e.textHaloRadius;n=n.add(2*s,2*s)}return Zd(t,e.textDx||0,e.textDy||0,ef(e,"textRotation"),r,n.width,n.height)}var sf=new nd;function of(t,e,i,n){var r=t||new nd;if(Array.isArray(e)){for(var s=e,o=0;o<s.length;o++)of(r,s[o],i,n[o]);return r}return af(e)&&r._combine(rf(sf,e,n)),hf(e)&&r._combine(nf(sf,e,i)),lf(e)&&r._combine(Xd(sf,e)),cf(e)&&r._combine(nf(sf,e)),r}function af(t){return!!t&&!Za(t.textName)}function hf(t){return!!t&&!Za(t.markerFile)}function lf(t){return!!t&&!(!Za(t.markerFile)||Za(t.markerType)||"path"===t.markerType)}function cf(t){return!!t&&!(!Za(t.markerFile)||"path"!==t.markerType)}var uf,df=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation"],ff=["textName","markerType","markerFile","textHaloRadius","shadowBlur","shadowOffsetX","shadowOffsetY","textWrapWidth"];function pf(t,e,i,n){for(var r,s=[],o=0,a=0,h=t.length;a<h-1;a++)(r=gf(t[a],t[a+1],e,a,i,n))&&(s[o]=s[o]||[],s[o].push({point:r[0],index:a}),r[1]===t[a+1]&&a!==h-2||(s[o].push({point:r[1],index:a+1}),o++));return s}function gf(t,e,i,n,r,s){var o,a,h,l=n?uf:vf(t,i),c=vf(e,i);for(uf=c;;){if(!(l|c))return[t,e];if(l&c)return!1;if(s)return[t,e];h=vf(a=_f(t,e,o=l||c,i,r),i),o===l?(t=a,l=h):(e=a,c=h)}}function mf(t,e,i){var n,r,s,o,a,h,l,c,u,d=[1,4,2,8];for(r=0,l=t.length;r<l;r++)t[r]._code=vf(t[r],e);for(o=0;o<4;o++){for(c=d[o],n=[],r=0,s=(l=t.length)-1;r<l;s=r++)a=t[r],h=t[s],a._code&c?h._code&c||((u=_f(h,a,c,e,i))._code=vf(u,e),n.push(u)):(h._code&c&&((u=_f(h,a,c,e,i))._code=vf(u,e),n.push(u)),n.push(a));t=n}return t}function _f(t,e,i,n,r){var s,o,a=e.x-t.x,h=e.y-t.y,l=n.getMin(),c=n.getMax();8&i?(s=t.x+a*(c.y-t.y)/h,o=c.y):4&i?(s=t.x+a*(l.y-t.y)/h,o=l.y):2&i?(s=c.x,o=t.y+h*(c.x-t.x)/a):1&i&&(s=l.x,o=t.y+h*(l.x-t.x)/a);var u=new Gh(s,o);return r&&u._round(),u}function vf(t,e){var i=0;return t.x<e.getMin().x?i|=1:t.x>e.getMax().x&&(i|=2),t.y<e.getMin().y?i|=4:t.y>e.getMax().y&&(i|=8),i}function yf(t,e,i,n){t=new Gh(t);var r,s,o,a=Math.abs(i.x-e.x),h=Math.abs(i.y-e.y),l=Math.sqrt(Math.abs(a*a-h*h));return a>=h?(r=new Gh(e.x-l,e.y),s=new Gh(e.x+l,e.y),o=2*a):(r=new Gh(e.x,e.y-l),s=new Gh(e.x,e.y+l),o=2*h),t.distanceTo(r)+t.distanceTo(s)<=o+2*n}var xf=function(){function t(){}var e=t.prototype;return e.getMap=function(){return this.geometry.getMap()},e.getPainter=function(){return this.painter},e.isDynamicSize=function(){return!1},t.testColor=function(t){return!(!t||!Ya(t))&&Ha.indexOf(t)>=0},t}(),wf=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i._prepareContext=function(t){if(Nl(this.symbol.opacity)?this._opacityFn||(this._opacityFn=jl(this.symbol.opacity)):delete this._opacityFn,qa(this.symbol.opacity))t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var e=this.getMap();t.globalAlpha=this._opacityFn(e.getZoom())}else 1!==t.globalAlpha&&(t.globalAlpha=1)},i.prepareCanvas=function(t,e,i){t.setLineDash&&rl(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var n=this.getPainter().isHitTesting();Mu.prepareCanvas(t,e,i,n)},i.remove=function(){},i.setZIndex=function(){},i.show=function(){},i.hide=function(){},i._defineStyle=function(t){return rc(t,this.geometry)},e}(xf);function bf(t,e,i,n){var r,s=Mf(i),o=i,a=o.markerType.toLowerCase(),h=Sf(a,o.markerWidth,o.markerHeight),l=s.lineOpacity,c=s.polygonOpacity;Tc(s.polygonFill)&&(Tc(s.polygonFill)&&(r||(r=function(t,e,i){var n=new nd;return n._combine(t),n.xmin+=-e/2,n.ymin+=-i/2,n.xmax+=e/2,n.ymax+=i/2,n}(e,o.markerWidth,o.markerHeight)),s.polygonGradientExtent=r));Mu.prepareCanvas(t,s,n);var u=o.markerWidth,d=o.markerHeight,f=o.markerLineWidth/2;if("ellipse"===a)Mu.ellipse(t,e,u/2,d/2,d/2,l,c);else if("cross"===a||"x"===a){for(var p=h.length-1;p>=0;p--)h[p]._add(e);Mu.path(t,h.slice(0,2),l),Mu.path(t,h.slice(2,4),l)}else if("diamond"===a||"bar"===a||"square"===a||"rectangle"===a||"triangle"===a){"bar"===a?e=e.add(0,-f):"rectangle"===a&&(e=e.add(f,f));for(var g=h.length-1;g>=0;g--)h[g]._add(e);Mu.polygon(t,h,l,c)}else if("pin"===a){e=e.add(0,-f);for(var m=h.length-1;m>=0;m--)h[m]._add(e);var _=t.lineCap;t.lineCap="round",Mu.bezierCurveAndFill(t,h,l,c),t.lineCap=_}else{if("pie"!==a)throw new Error("unsupported markerType: "+a);e=e.add(0,-f);var v=180*Math.atan(u/2/d)/Math.PI,y=t.lineCap;t.lineCap="round",Mu.sector(t,e,d,[90-v,90+v],l,c),t.lineCap=y}return t.canvas}function Mf(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e}function Sf(t,e,i){var n,r,s,o,a=i/2,h=e/2;if("triangle"===t)return[n=new Gh(0,0-a),r=new Gh(0-h,0+a),s=new Gh(0+h,0+a)];if("cross"===t)return[n=new Gh(0-h,0),r=new Gh(0+h,0),s=new Gh(0,0-a),o=new Gh(0,0+a)];if("diamond"===t)return[n=new Gh(0-h,0),r=new Gh(0,0-a),s=new Gh(0+h,0),o=new Gh(0,0+a)];if("square"===t)return[n=new Gh(0-h,0+a),r=new Gh(0+h,0+a),s=new Gh(0+h,0-a),o=new Gh(0-h,0-a)];if("rectangle"===t)return r=(n=new Gh(0,0)).add(e,0),s=n.add(e,i),o=n.add(0,i),[n,r,s,o];if("x"===t)return[n=new Gh(0-h,0+a),r=new Gh(0+h,0-a),s=new Gh(0+h,0+a),o=new Gh(0-h,0-a)];if("bar"===t)return[n=new Gh(0-h,0-i),r=new Gh(0+h,0-i),s=new Gh(0+h,0),o=new Gh(0-h,0)];if("pin"===t||"pie"===t){var l=i*Math.atan(h/a);return[n=new Gh(0,0),r=new Gh(0-l,0-i),s=new Gh(0+l,0-i),o=new Gh(0,0)]}return[]}var Cf,Tf=new Gh(0,0),Pf=new Gh(0,0),Af=new Gh(0,0),Ef=new Gh(0,0),Lf=function(t){function e(e,i,n){var r;return(r=t.call(this)||this).symbol=e,r.geometry=i,r.painter=n,r}Nh(e,t);var i=e.prototype;return i.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLRes(),i=new nd,n=this._getRenderPoints()[0],r=n.length-1;r>=0;r--)n[r]&&i._combine(t._pointAtResToPoint(n[r],e));return i},i.isDynamicSize=function(){var t=this.symbol;return Nl(t.markerWidth)||Nl(t.markerHeight)||Nl(t.textSize)},i._rotateExtent=function(t,e){return t.convertTo((function(t){return t._rotate(e)}))},i._getRenderPoints=function(){var t=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(t)},i._getRenderContainerPoints=function(t){var e=this.getPainter();if(e.isSpriting())return this._getRenderPoints()[0];var i,n=this.geometry,r=this.getDxDy();if(n._cPoint&&!t){var s=t?Af:Ef;s.set(n._cPoint.x,n._cPoint.y);var o=e.containerOffset;s._sub(o);var a=r.x,h=r.y;(a||h)&&s._add(a||0,h||0),i=[s]}else{var l=this._getRenderPoints()[0];i=this.painter._pointContainerPoints(l,r.x,r.y,t,!0,this.getPlacement())}if(!i||!Array.isArray(i[0]))return i;for(var c=[],u=0,d=i.length;u<d;u++)for(var f=0,p=i[u].length;f<p;f++)c.push(i[u][f]);return c},i.getPlacement=function(){return this.symbol.markerPlacement},i.getRotation=function(){return ef(this.style)},i.getDxDy=function(){var t=this.style,e=t.markerDx,i=t.markerDy;return new Gh(e,i)},i._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var i=this._getRenderPoints()[1];if(!i||!i[t])return e;var n=this.getMap(),r=i[t][0],s=i[t][1];if(n.isTransforming()){var o=n.getGLRes();return r=n._pointAtResToContainerPoint(i[t][0],o,0,Tf),s=n._pointAtResToContainerPoint(i[t][1],o,0,Pf),e+dl(r.x,r.y,s.x,s.y)}return e+-dl(r.x,r.y,s.x,s.y)},i._rotate=function(t,e,i){if(i){var n=this.getDxDy(),r=e.sub(n);return t.save(),t.translate(r.x,r.y),t.rotate(i),n}return null},e}(wf),Rf=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.getPlacement=function(){return"point"},i.getDxDy=function(){return new Gh(0,0)},i.symbolize=function(t){var e=this.geometry,i=e.getLayer();if(e.options.debug||!i||i.options.debug){var n=this.getMap();if(n&&!n.isZooming()){var r=i.options.debugOutline;t.strokeStyle=r,t.fillStyle=r;var s=e.getContainerExtent().toArray();Mu.polygon(t,[s],1,0);for(var o=this._getRenderContainerPoints(),a=this.geometry.getId(),h=Sf("cross",10,10),l=0;l<o.length;l++){var c=o[l];Za(a)||Mu.fillText(t,a,c.add(8,-4),r);for(var u=[],d=0;d<h.length;d++)u.push(h[d].add(c));Mu.path(t,u.slice(0,2),1),Mu.path(t,u.slice(2,4),1)}}}},e}(Lf),Of=new cc(1,1),Df=function(t){function e(e,i,n){var r;return(r=t.call(this,e,i,n)||this).style=r._defineStyle(r.translate()),r}Nh(e,t),e.test=function(t){return hf(t)};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(this.painter.isHitTesting()||0!==i.markerWidth&&0!==i.markerHeight&&0!==i.markerOpacity){var n=this._getRenderContainerPoints();if(rl(n)){var r=this._getImage(e);if(r){this._prepareContext(t);var s,o=i.markerWidth,a=i.markerHeight;if(!qa(o)||!qa(a)){o=r.width,a=r.height,i.markerWidth=o,i.markerHeight=a;var h=i.markerFile;e.isResourceLoaded(h)||e.addResource(h,r);var l=this.getPainter();l.isSpriting()||l.removeCache()}"path"!==this.symbol.markerType&&qa(i.markerOpacity)&&i.markerOpacity<1&&(s=t.globalAlpha,t.globalAlpha*=i.markerOpacity),Of.width=o,Of.height=a;for(var c=bc(Of,i.markerHorizontalAlignment,i.markerVerticalAlignment),u=0,d=n.length;u<d;u++){var f=n[u],p=this.getRotation()?this._rotate(t,f,this._getRotationAt(u)):null;p&&(f=p),Mu.image(t,r,f.x+c.x,f.y+c.y,o,a),p&&t.restore()}void 0!==s&&(t.globalAlpha=s)}}}},i._getImage=function(t){return function(t,e){return t&&t.getImage(e)||null}(t,this.style.markerFile)},i.getFixedExtent=function(t){return this._fixedExtent=this._fixedExtent||new nd,nf(this._fixedExtent,this.style,t)},i.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:Kh(t.markerOpacity,1),markerWidth:Kh(t.markerWidth,null),markerHeight:Kh(t.markerHeight,null),markerRotation:Kh(t.markerRotation,0),markerDx:Kh(t.markerDx,0),markerDy:Kh(t.markerDy,0),markerHorizontalAlignment:Kh(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:Kh(t.markerVerticalAlignment,"top")}},e}(Lf),If=new Gu(0,0),kf=new Gu(0,0),zf=function(t){function e(e,i,n){var r;return(r=t.call(this)||this).symbol=e,r.geometry=i,r.painter=n,"Point"===i.type?Fh(r):(r.style=r._defineStyle(r.translate()),r)}Nh(e,t),e.test=function(t,e){if(!t)return!1;if(e&&"Point"===e.type)return!1;for(var i in t){var n=i.slice(0,4);if("line"===n||"poly"===n)return!0}return!1};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(0!==i.polygonOpacity||0!==i.lineOpacity||this.painter.isHitTesting()){var n=this._getPaintParams();if(n){this._prepareContext(t);var r=Tc(i.lineColor),s="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!r||!i.lineColor.places&&s||(i.lineGradientExtent=this.geometry.getContainerExtent()._expand(i.lineWidth)),Tc(i.polygonFill)&&(i.polygonGradientExtent=this.geometry.getContainerExtent());var o=n[0];if("Polygon"===this.geometry.getJSONType()&&o.length>0&&Array.isArray(o[0][0])||"LineString"===this.geometry.type&&o.length>0&&Array.isArray(o[0]))for(var a=0;a<o.length;a++){this.prepareCanvas(t,i,e),r&&s&&!i.lineColor.places&&this._createGradient(t,o[a],i.lineColor);var h=[t,o[a]];n.length>1&&h.push.apply(h,n.slice(1)),h.push(i.lineOpacity,i.polygonOpacity,i.lineDasharray),this.geometry._paintOn.apply(this.geometry,h)}else{this.prepareCanvas(t,i,e),r&&s&&!i.lineColor.places&&this._createGradient(t,o,i.lineColor);var l=[t];l.push.apply(l,n),l.push(i.lineOpacity,i.polygonOpacity,i.lineDasharray),this.geometry._paintOn.apply(this.geometry,l)}t.setLineDash&&Array.isArray(i.lineDasharray)&&t.setLineDash([])}}},i.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new Gu(0,0),this._extMax=new Gu(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var i=t._prjToPoint(this._extMin,void 0,If),n=t._prjToPoint(this._extMax,void 0,kf);return this._pxExtent?this._pxExtent.set(Math.min(i.x,n.x),Math.min(i.y,n.y),Math.max(i.x,n.x),Math.max(i.y,n.y)):this._pxExtent=new nd(i,n),this._pxExtent},i.getFixedExtent=function(){var t=this.style.lineWidth/2;return new nd(-t,-t,t,t)},i._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},i.translate=function(){var t=this.symbol,e={lineColor:Kh(t.lineColor,"#000"),lineWidth:Kh(t.lineWidth,2),lineOpacity:Kh(t.lineOpacity,1),lineDasharray:Kh(t.lineDasharray,[]),lineCap:Kh(t.lineCap,"butt"),lineJoin:Kh(t.lineJoin,"miter"),linePatternFile:Kh(t.linePatternFile,null),lineDx:Kh(t.lineDx,0),lineDy:Kh(t.lineDy,0),polygonFill:Kh(t.polygonFill,null),polygonOpacity:Kh(t.polygonOpacity,1),polygonPatternFile:Kh(t.polygonPatternFile,null),polygonPatternDx:Kh(t.polygonPatternDx,0),polygonPatternDy:Kh(t.polygonPatternDy,0),linePatternDx:Kh(t.linePatternDx,0),linePatternDy:Kh(t.linePatternDy,0)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},i._createGradient=function(t,e,i){if(Array.isArray(e)&&e.length){var n=e.length,r=t.createLinearGradient(e[0].x,e[0].y,e[n-1].x,e[n-1].y);i.colorStops.forEach((function(t){r.addColorStop.apply(r,t)})),t.strokeStyle=r}},e}(wf),Nf=function(t){function e(e,i,n){var r,s=(r=t.call(this,e,i,n)||this).translate();return r._dynamic=Fl(s),r.style=r._defineStyle(s),0===r.style.textWrapWidth?Fh(r):(r.strokeAndFill=r._defineStyle(r.translateLineAndFill(r.style)),r)}Nh(e,t),e.test=function(t){return af(t)};var i=e.prototype;return i.symbolize=function(t,e){if(this.painter.isHitTesting()||0!==this.style.textSize&&(this.style.textOpacity||this.style.textHaloRadius&&this.style.textHaloOpacity)&&0!==this.style.textWrapWidth){var i=this._getRenderContainerPoints();if(rl(i)){var n=this.style,r=this.strokeAndFill,s=xc(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var o=this._textDesc=this._textDesc||wc(s,this.style);this._prepareContext(t),this.prepareCanvas(t,r,e),Mu.prepareCanvasFont(t,n);for(var a=0,h=i.length;a<h;a++){var l=i[a],c=this.getRotation()?this._rotate(t,l,this._getRotationAt(a)):null;c&&(l=c),Mu.text(t,s,l,n,o),c&&t.restore()}}}},i.getPlacement=function(){return this.symbol.textPlacement},i.getRotation=function(){var t=this.style.textRotation;return qa(t)?-t*Math.PI/180:null},i.getDxDy=function(){var t=this.style;return new Gh(t.textDx,t.textDy)},i.getFixedExtent=function(){var t=this.geometry.getTextDesc();return Array.isArray(t)&&(t=t[this._index]),this._fixedExtent=this._fixedExtent||new nd,t?rf(this._fixedExtent,this.style,t):this._fixedExtent},i.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:Kh(t.textFaceName,"monospace"),textWeight:Kh(t.textWeight,"normal"),textStyle:Kh(t.textStyle,"normal"),textSize:Kh(t.textSize,14),textFont:Kh(t.textFont,null),textFill:Kh(t.textFill,"#000"),textOpacity:Kh(t.textOpacity,1),textHaloFill:Kh(t.textHaloFill,"#ffffff"),textHaloRadius:Kh(t.textHaloRadius,0),textHaloOpacity:Kh(t.textHaloOpacity,1),textWrapWidth:Kh(t.textWrapWidth,null),textWrapCharacter:Kh(t.textWrapCharacter,"\n"),textLineSpacing:Kh(t.textLineSpacing,0),textDx:Kh(t.textDx,0),textDy:Kh(t.textDy,0),textHorizontalAlignment:Kh(t.textHorizontalAlignment,"middle"),textVerticalAlignment:Kh(t.textVerticalAlignment,"middle"),textAlign:Kh(t.textAlign,"center"),textRotation:Kh(t.textRotation,0),textMaxWidth:Kh(t.textMaxWidth,0),textMaxHeight:Kh(t.textMaxHeight,0)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},i.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},e}(Lf),Ff=[],jf=function(t){function e(e,i,n){var r,s=(r=t.call(this,e,i,n)||this).translate();return r._dynamic=Fl(s),r.style=r._defineStyle(s),r.strokeAndFill=r._defineStyle(Mf(r.style)),r.padding=0,r}Nh(e,t),e.test=function(t){return lf(t)};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(this.painter.isHitTesting()||0!==i.markerWidth&&0!==i.markerHeight&&(0!==i.polygonOpacity||0!==i.lineOpacity)){var n=this._getRenderContainerPoints();rl(n)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkers(t,n,e):this._drawMarkersWithCache(t,n,e))}},i._drawMarkers=function(t,e,i){for(var n=e.length-1;n>=0;n--){var r=e[n],s=this.getRotation()?this._rotate(t,r,this._getRotationAt(n)):null;s&&(r=s),this._drawVectorMarker(t,r,i),s&&t.restore()}},i._drawMarkersWithCache=function(t,e,i){var n=this._stampSymbol(),r=i.getImage(n);r||(r=this._createMarkerImage(t,i),i.addResource([n,r.width,r.height],r));for(var s=Kd(this.style,r.width,r.height),o=e.length-1;o>=0;o--){var a=e[o],h=this.getRotation()?this._rotate(t,a,this._getRotationAt(o)):null;h&&(a=h),Mu.image(t,r,a.x+s.x,a.y+s.y),h&&t.restore()}},i._createMarkerImage=function(t,e){var i=t.canvas.constructor,n=$d(Ff,this.style),r=Mu.createCanvas(n[0],n[1],i),s=this._getCacheImageAnchor(n[0],n[1]),o=r.getContext("2d");return this._drawVectorMarker(o,s,e),r},i._stampSymbol=function(){return this._stamp||(this._stamp=Cc([this.style.markerType,Tc(this.style.markerFill)?Pc(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,Tc(this.style.markerLineColor)?Pc(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},i._getCacheImageAnchor=function(t,e){var i=2*(this.symbol.shadowBlur||0)+this.padding,n=this.style.markerType;return"bar"===n||"pie"===n||"pin"===n?new Gh(t/2,e-i):"rectangle"===n?new Gh(i,i):new Gh(t/2,e/2)},i._getGraidentExtent=function(t){var e=new nd,i=this.getDxDy(),n=this.getFixedExtent();if(Array.isArray(t))for(var r=t.length-1;r>=0;r--)e._combine(t[r]);else e._combine(t);return e.xmin+=n.xmin-i.x,e.ymin+=n.ymin-i.y,e.xmax+=n.xmax-i.x,e.ymax+=n.ymax-i.y,e},i._drawVectorMarker=function(t,e,i){bf(t,e,this.style,i)},i.getFixedExtent=function(){var t=this.isDynamicSize(),e=this.style.markerWidth,i=this.style.markerHeight;return this._fixedExtent=this._fixedExtent||new nd,Xd(this._fixedExtent,this.style,t?[128,128*(0===e?1:i/e)]:null)},i.translate=function(){var t=this.symbol,e={markerType:Kh(t.markerType,"ellipse"),markerFill:Kh(t.markerFill,"#00f"),markerFillOpacity:Kh(t.markerFillOpacity,1),markerFillPatternFile:Kh(t.markerFillPatternFile,null),markerLineColor:Kh(t.markerLineColor,"#000"),markerLineWidth:Kh(t.markerLineWidth,Vd),markerLineOpacity:Kh(t.markerLineOpacity,1),markerLineDasharray:Kh(t.markerLineDasharray,[]),markerLinePatternFile:Kh(t.markerLinePatternFile,null),markerDx:Kh(t.markerDx,0),markerDy:Kh(t.markerDy,0),markerWidth:Kh(t.markerWidth,Gd),markerHeight:Kh(t.markerHeight,Hd),markerRotation:Kh(t.markerRotation,0),shadowBlur:Kh(t.shadowBlur,0),shadowOffsetX:Kh(t.shadowOffsetX,0),shadowOffsetY:Kh(t.shadowOffsetY,0)},i=e.markerType,n=Jd(i),r=Yd(i);return e.markerHorizontalAlignment=Kh(t.markerHorizontalAlignment,n),e.markerVerticalAlignment=Kh(t.markerVerticalAlignment,r),qa(t.markerOpacity)&&(qa(t.markerFillOpacity)&&(e.markerFillOpacity*=t.markerOpacity),qa(t.markerLineOpacity)&&(e.markerLineOpacity*=t.markerOpacity)),e},e}(Lf),Bf=function(t){function e(e,i,n){var r;Za(e.markerWidth)&&(e.markerWidth=80),Za(e.markerHeight)&&(e.markerHeight=80),e=Wa(e,(r=t.call(this,e,i,n)||this).translate());var s=r.style=r._defineStyle(e);return zh.gecko?r._url=[oc(s,s.markerWidth,s.markerHeight),s.markerWidth,s.markerHeight]:r._url=[oc(s),s.markerWidth,s.markerHeight],r}Nh(e,t),e.test=function(t){return cf(t)};var i=e.prototype;return i._prepareContext=function(){},i._getImage=function(t){var e=this;if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var i=this.painter,n=new Image;return n.onload=function(){var t=i.getLayer()&&i.getLayer().getRenderer();t&&t.setToRedraw()},n.onerror=function(i){t.markErrorResource(e._url)},n.src=this._url[0],t&&t.addResource(this._url,n),n},e}(Df),Uf={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Gf=function(t){function e(e,i,n){var r;return(r=t.call(this,e,i,n)||this).style=i.getLayer().options.drawAltitude,r.style&&Ja(r.style)||(r.style={lineWidth:2}),r.style.lineWidth||(r.style.lineWidth=0),r.dxdy=r._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),r}Nh(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var i=e.getJSONType();return"Marker"===i||"LineString"===i};var i=e.prototype;return i.symbolize=function(t){var e=this.geometry.getLayer();if(e.options.drawAltitude){var i=this.geometry.getProperties();if(i&&i[e.options.altitudeProperty]){var n=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var r=this._getPaintParams(n.lineDx,n.lineDy,!1,!0);if(!r)return;var s=this.getPainter().getPaintParams(n.lineDx,n.lineDy,!0,!0,"_groundpt")[0];this._drawLineAltitude(t,r[0],s)}else{var o=this._getRenderContainerPoints(),a=this._getRenderContainerPoints(!0);if(!o||0===o.length)return;this._drawMarkerAltitude(t,o[0],a[0])}}}},i.getDxDy=function(){var t=this.dxdy;return new Gh(t.dx||0,t.dy||0)},i.get2DExtent=function(){return"LineString"===this.geometry.type?zf.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},i.getPlacement=function(){return"point"},i._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0,null,!0,"_altpt")},i._drawMarkerAltitude=function(t,e,i){var n=this._getStyle();this.prepareCanvas(t,n),Mu.path(t,[e,i],n.lineOpacity,null,n.lineDasharray)},i._drawLineAltitude=function(t,e,i){var n=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var r=0;r<e.length;r++)this._drawLine(t,e[r],i[r]);else this._drawLine(t,e,i);t.setLineDash&&Array.isArray(n.lineDasharray)&&t.setLineDash([])},i._drawLine=function(t,e,i){var n=this._getStyle();this.prepareCanvas(t,n);for(var r=0,s=e.length-1;r<s;r++)Mu.polygon(t,[e[r],e[r+1],i[r+1],i[r]],n.lineOpacity,n.polygonOpacity,n.lineDasharray)},i._getStyle=function(){var t=this.geometry.getLayer().options.drawAltitude;return Ja(t)||(t=Uf),t.lineWidth||(t.lineWidth=0,t.lineOpacity=0),t},e}(Lf),Hf=[Gf,zf,Df,Bf,jf,Nf],Vf=new Gh(0,0),Wf=new nd,Zf=new nd,qf=new nd,Xf=new nd,Jf=new nd,Yf={},Qf={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},Kf=function(t){function e(e){var i;return(i=t.call(this)||this).geometry=e,i.symbolizers=i._createSymbolizers(),i._altAtGL=i._getGeometryAltitude(),i}Nh(e,t);var i=e.prototype;return i.getMap=function(){return this.geometry.getMap()},i.getLayer=function(){return this.geometry.getLayer()},i._createSymbolizers=function(){var t=this.getSymbol(),e=[],i=Hf,n=t;Array.isArray(t)||(n=[t]);for(var r=n.length-1;r>=0;r--)for(var s=n[r],o=i.length-1;o>=0;o--)if(i[o].test(s,this.geometry)){var a=new i[o](s,this.geometry,this);a._index=r,e.push(a),a instanceof Lf&&(this._hasPoint=!0)}if(!e.length&&console)this.geometry.getId();return this._debugSymbolizer=new Rf(t,this.geometry,this),e},i.hasPoint=function(){return!!this._hasPoint},i.getRenderPoints=function(t){return this._verifyProjection(),this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},i.getPaintParams=function(t,e,i,n,r){void 0===r&&(r="_pt");var s,o,a,h,l,c=this.getLayer()._getRenderer().mapStateCache,u=this.getMap();c&&!this._hitPoint?(s=c.resolution,o=c.pitch,a=c.bearing,h=c.glScale,l=c.containerExtent):(s=u.getResolution(),o=u.getPitch(),a=u.getBearing(),h=u.getGLScale(),l=u.getContainerExtent());var d=this.geometry,f=s,p=0!==o,g=0!==a,m=this._cachedParams,_=d._paintAsPath&&d._paintAsPath();if(_&&this._unsimpledParams&&f<=this._unsimpledParams._res)m=this._unsimpledParams;else if(!m||m._res!==s||this._pitched!==p&&d._redrawWhenPitch()||this._rotated!==g&&d._redrawWhenRotate()){if(!(m=d._getPaintParams()))return null;m._res=f,!d._simplified&&_&&(this._unsimpledParams||(this._unsimpledParams=m),f>this._unsimpledParams._res&&(this._unsimpledParams._res=f)),this._cachedParams=m}if(!m)return null;this._pitched=p,this._rotated=g;var v=h,y=[],x=m[0],w=l,b=this._pointContainerPoints(x,t,e,i,n||this._hitPoint&&!w.contains(this._hitPoint),null,r);if(!b)return null;y.push(b);for(var M=1,S=m.length;M<S;M++)qa(m[M])||m[M]instanceof cc?qa(m[M])?y.push(m[M]/v):y.push(m[M].multi(1/v)):y.push(m[M]);return y},i._pointContainerPoints=function(t,e,i,n,r,s,o){if(void 0===o&&(o="_pt"),this._aboveCamera())return null;var a,h,l,c=this.getLayer()._getRenderer(),u=c.mapStateCache,d=this.getMap(),f=this.geometry,p=this.containerOffset;u?(a=u.glRes,h=u.containerExtent):(a=d.getGLRes(),h=d.getContainerExtent());var g=this.getLayer().options.roundPoint,m=1/0,_=1/0,v=-1/0,y=-1/0,x=!r,w=c.layer.options.clipBBoxBufferSize||3,b=this.symbolizers;function M(t,n){void 0===t&&(t=[]),void 0===n&&(n=[]);for(var r=vl(t,o),s=0,l=(r=d._pointsAtResToContainerPoints(t,a,n,r)).length;s<l;s++){var c=r[s];c._sub(p),(e||i)&&c._add(e||0,i||0),g&&(c.x=Math.ceil(c.x),c.y=Math.ceil(c.y)),m=Math.min(c.x,m),_=Math.min(c.y,_),v=Math.max(c.x,v),y=Math.max(c.y,y)}if(x&&zc(b)){if(Jf.ymin=h.ymin,Jf.ymin<w&&(Jf.ymin=h.ymin-w),Jf.xmin=h.xmin-w,Jf.xmax=h.xmax+w,Jf.ymax=h.ymax+w,f.getShell&&f.getHoles)return mf(r,Jf);var u=pf(r,Jf,!1);if(u.length){var M=[];return u.forEach((function(t){for(var e=0,i=t.length;e<i;e++)M.push(t[e].point)})),M}}return r}var S=this.getAltitude();if(Array.isArray(t)){var C,T=this.geometry;!r&&T.options.enableClip?(C=this._clip(t,S)).inView&&(x=!1):C={points:t,altitude:S};var P=C.points;S=C.altitude,n&&(S=0);var A=S;l=[];for(var E=[],L=qa(S),R=0,O=P.length;R<O;R++){var D=P[R];if(Array.isArray(D)){if(L){var I=M(D,S);l.push(I);continue}for(var k=[],z=0,N=D.length;z<N;z++)Array.isArray(S)&&(A=S[R]?S[R][z]:0),k.push(A);var F=M(D,k);l.push(F)}else Array.isArray(S)&&(A="vertex-last"===s?S[S.length-1-R]:"line"===s?(S[R]+S[R+1])/2:S[R]),E.push(A)}E.length&&(l=M(P,E))}else t instanceof Gh&&(n&&(S=0),l=d._pointAtResToContainerPoint(t,a,S)._sub(p),(e||i)&&l._add(e,i));return Qf.minx=m,Qf.miny=_,Qf.maxx=v,Qf.maxy=y,this._containerBbox=Qf,l},i._clip=function(t,e){if(qa(e)&&0!==e)return{points:t,altitude:e};if(Array.isArray(e)){for(var i=!1,n=0,r=e.length;n<r;n++)if(0!==e[n]){i=!0;break}if(i)return{points:t,altitude:e}}var s=this.getMap(),o=this.geometry,a=this.getSymbol().lineWidth;qa(a)||(a=4);var h,l,c,u=this.getLayer()._getRenderer().mapStateCache;u?(h=u._2DExtent,l=u.glExtent,c=u.pitch):(h=s._get2DExtent(),l=s._get2DExtentAtRes(s.getGLRes()),c=s.getPitch());var d=h._expand(a);if(c>0&&e){var f=s.cameraLookAt,p=s.cameraPosition;Vf.set(p.x,p.y),d=d._combine(Vf._add($h(f[0]-p[0]),$h(f[1]-p[1])))}var g=t;if(this.get2DExtent(null,Xf).within(d))return{points:g,altitude:e,inView:!0};var m=l._expand(a*s._glScale);qf.xmin=m.xmin,qf.xmax=m.xmax,qf.ymin=m.ymin,qf.ymax=m.ymax;var _=o.options.smoothness;if(o.getShell&&this.geometry.getHoles&&!_){var v=m.xmin,y=m.ymin,x=m.xmax,w=m.ymax,b=Math.abs(x-v),M=Math.abs(w-y),S=Math.sqrt(b*b+M*M),C=(S-b)/2,T=(S-M)/2;if(qf.xmin=m.xmin-C,qf.xmax=m.xmax+C,qf.ymin=m.ymin-T,qf.ymax=m.ymax+T,Array.isArray(t[0])){g=[];for(var P=0;P<t.length;P++){var A=mf(t[P],qf);A.length&&g.push(A)}}else g=mf(t,qf)}else if("LineString"===o.getJSONType()&&!_){if(Array.isArray(t[0])){g=[];for(var E=0;E<t.length;E++)Jh(g,pf(t[E],qf,!1,!!_))}else g=pf(t,qf,!1,!!_);return this._interpolateSegAlt(g,t,e)}return{points:g,altitude:e}},i._interpolateSegAlt=function(t,e,i){if(!Array.isArray(i)){var n=function(t){return t.point};return{points:t.map((function(t){return Array.isArray(t)?t.map(n):t.point})),altitude:i}}var r=$f(t,e,i);i=[];var s=r.map((function(t){if(Array.isArray(t)){var e=[],n=t.map((function(t){return e.push(t.altitude),t.point}));return i.push(e),n}return i.push(t.altitude),t.point}));return{points:s,altitude:i}},i.getSymbol=function(){return this.geometry._getInternalSymbol()},i.paint=function(t,e,i){if(this.symbolizers){var n=this.getLayer(),r=n._getRenderer();if(r&&(r.context||e)){var s=r.mapStateCache||{};if(this.geometry._isCheck||!t||t.intersects(this.get2DExtent(r.resources,Wf))){var o=this.getMap(),a=this.getMinAltitude(),h=o.getFrustumAltitude();if(!(a&&h&&h<a)){this.containerOffset=i||s.offset||o._pointToContainerPoint(r.southWest)._add(0,-o.height),this._beforePaint();for(var l=e||r.context,c=[l,r.resources],u=this.symbolizers.length-1;u>=0;u--)(l.shadowBlur||this.symbolizers[u].symbol.shadowBlur)&&this._prepareShadow(l,this.symbolizers[u].symbol),this.symbolizers[u].symbolize.apply(this.symbolizers[u],c);this._afterPaint(),this._painted=!0,(this.geometry.options.debug||n.options.debug)&&this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,c)}}}}},i.getSprite=function(t,e){if("Point"!==this.geometry.type)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var i=new nd;this.symbolizers.forEach((function(e){var n=e.getFixedExtent(t);i._combine(n)}));var n,r=i.getMin().multi(-1),s=e||(this.getMap()?this.getMap().CanvasClass:null),o=Mu.createCanvas(i.getWidth(),i.getHeight(),s);this._renderPoints&&(n=this._renderPoints);for(var a=o.getContext("2d"),h=[a,t],l=this.symbolizers.length-1;l>=0;l--){var c=this.symbolizers[l].getDxDy();this._renderPoints={center:[[r.add(c)]]},this._prepareShadow(a,this.symbolizers[l].symbol),this.symbolizers[l].symbolize.apply(this.symbolizers[l],h)}n&&(this._renderPoints=n),this._sprite={canvas:o,offset:i.getCenter()}}return this._spriting=!1,this._sprite},i.isSpriting=function(){return!!this._spriting},i.hitTest=function(t,e){if((!e||e<.5)&&(e=.5),this._hitPoint=t.sub(e,e),!Cf){var i=this.getMap()?this.getMap().CanvasClass:null;Cf=Mu.createCanvas(1,1,i)}Mu.setHitTesting(!0),Cf.width=Cf.height=2*e;var n=Mu.getCanvas2DContext(Cf);try{this.paint(null,n,this._hitPoint)}catch(rM){throw rM}finally{Mu.setHitTesting(!1)}delete this._hitPoint;for(var r=n.getImageData(0,0,Cf.width,Cf.height).data,s=3,o=r.length;s<o;s+=4)if(r[s]>0)return!0;return!1},i.isHitTesting=function(){return!!this._hitPoint},i._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=this.isHitTesting()?0:e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},i._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var i=this.symbolizers.length-1;i>=0;i--)t.apply(e,[this.symbolizers[i]])}},i.get2DExtent=function(t,e){this._verifyProjection();var i=this.getMap();t=t||this.getLayer()._getRenderer().resources;var n=i.getZoom(),r=this._isDynamicSize();if(this._extent2D&&this._extent2D._zoom===n&&this._fixedExtent||(this._extent2D&&this._extent2D._zoom!==n&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new nd),this._extent2D._zoom=n),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(t,new nd)))),!this._extent2D)return r&&delete this._fixedExtent,null;var s=this._fixedExtent,o=s.xmin,a=s.ymin,h=s.xmax,l=s.ymax;return r&&delete this._fixedExtent,Zf.set(o,-l,h,-a),e?(e.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),e._add(Zf),e):this._extent2D.add(Zf)},i._computeExtent2D=function(t){for(var e=this.symbolizers.length-1;e>=0;e--){var i=this.symbolizers[e];t._combine(i.get2DExtent())}return t},i._computeFixedExtent=function(t,e){for(var i=this.symbolizers.length-1;i>=0;i--){var n=this.symbolizers[i];n.getFixedExtent&&e._combine(n.getFixedExtent(t))}return e},i._isDynamicSize=function(){for(var t=this.symbolizers.length-1;t>=0;t--){if(this.symbolizers[t].isDynamicSize())return!0}return!1},i._aboveCamera=function(){var t=this.getMinAltitude(),e=this.getMap().getFrustumAltitude();return t&&e&&e<t},i.getFixedExtent=function(){var t=this.getMap().getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new nd):(this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(null,Zf),this._fixedExtent)},i.setZIndex=function(t){this._eachSymbolizer((function(e){e.setZIndex(t)}))},i.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer((function(t){t.show()}))):this.getLayer().isCanvasRender()||this.paint()},i.hide=function(){this._eachSymbolizer((function(t){t.hide()}))},i.repaint=function(){this._altAtGL=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},i.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},i.remove=function(){this.removeCache(),this._removeSymbolizers()},i._removeSymbolizers=function(){this._eachSymbolizer((function(t){delete t.painter,t.remove()})),delete this.symbolizers},i.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},i.getAltitude=function(){return this.geometry.getAltitude()!==this._propAlt&&(this._altAtGL=this._getGeometryAltitude()),this._altAtGL?this._altAtGL:0},i.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},i.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},i._getGeometryAltitude=function(){var t=this;if(!this.getMap())return 0;var e=this.geometry.getAltitude();if(this._propAlt=e,!e)return this.minAltitude=this.maxAltitude=0,0;var i=this.geometry.getCenter();return i?Array.isArray(e)?(this.minAltitude=Number.MAX_VALUE,this.maxAltitude=Number.MIN_VALUE,e.map((function(e){var n=t._meterToPoint(i,e);return n<t.minAltitude&&(t.minAltitude=n),n>t.maxAltitude&&(t.maxAltitude=n),n}))):(this.minAltitude=this.maxAltitude=this._meterToPoint(i,e),this.minAltitude):0},i._meterToPoint=function(t,e){var i=this.getMap(),n=i.getGLRes();return i.altitudeToPoint(e,n)*$h(e)},i._verifyProjection=function(){var t=this.geometry._getProjection()||Yf;this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},i._beforePaint=function(){},i._afterPaint=function(){},e}(Ou);function $f(t,e,i){if(!Array.isArray(i))return t;for(var n=[],r=0,s=t.length;r<s;r++)if(Array.isArray(t[r]))n.push($f(t[r],e,i));else{var o=t[r];if(o.point.equals(e[o.index]))o.altitude=i[o.index],n.push(o);else{var a=void 0,h=void 0;0===o.index?(a=o.index,h=o.index+1):(a=o.index-1,h=o.index);var l=o.point.distanceTo(e[h]),c=l/(l+e[a].distanceTo(o.point)),u=el(i[a],i[h],1-c);o.altitude=u,n.push(o)}}return n}var tp=new nd,ep=function(t){function e(e,i){var n;return(n=t.call(this)||this).geometry=e,n.isMask=i,n}Nh(e,t);var i=e.prototype;return i._eachPainter=function(t){for(var e,i=this.geometry.getGeometries(),n=0,r=i.length;n<r&&(!(e=this.isMask?i[n]._getMaskPainter():i[n]._getPainter())||!e||!1!==t.call(this,e));n++);},i.paint=function(t){this.geometry&&this._eachPainter((function(e){e.paint(t)}))},i.get2DExtent=function(t,e){e&&e.set(null,null,null,null);var i=e||new nd;return this._eachPainter((function(e){i=i._combine(e.get2DExtent(t,tp))})),i},i.remove=function(){var t=arguments;this._eachPainter((function(e){e.remove.apply(e,t)}))},i.setZIndex=function(){var t=arguments;this._eachPainter((function(e){e.setZIndex.apply(e,t)}))},i.show=function(){var t=arguments;this._eachPainter((function(e){e.show.apply(e,t)}))},i.hide=function(){var t=arguments;this._eachPainter((function(e){e.hide.apply(e,t)}))},i.repaint=function(){var t=arguments;this._eachPainter((function(e){e.repaint.apply(e,t)}))},i.refreshSymbol=function(){var t=arguments;this._eachPainter((function(e){e.refreshSymbol.apply(e,t)}))},i.hasPoint=function(){var t=!1;return this._eachPainter((function(e){return!e.hasPoint()||(t=!0,!1)})),t},i.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter((function(i){var n=i.getMinAltitude();(t||n<e)&&(t=!1,e=n)})),e},i.getMaxAltitude=function(){var t=0;return this._eachPainter((function(e){var i=e.getMaxAltitude();i>t&&(t=i)})),t},e}(Ou),ip={"EPSG:3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],e=12756274*Math.PI,i=0;i<23;i++)t[i]=e/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<23;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{projection:"baidu",resolutions:function(){for(var t=Math.pow(2,18),e=[],i=0;i<23;i++)e[i]=t,t*=.5;return e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{projection:"identity",resolutions:function(){for(var t=Math.pow(2,8),e=[],i=0;i<23;i++)e[i]=t,t*=.5;return e}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}},"PRESET-VT-3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],e=6378137*Math.PI,i=0;i<23;i++)t[i]=e/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}}};ip["EPSG:4490"]=ip["EPSG:4326"];var np=function(){function t(t){void 0===t&&(t={}),this.options=t,this._initSpatialRef()}t.getPreset=function(t){return ip[t.toUpperCase()]},t.getAllPresets=function(){return Object.keys(ip)},t.getProjectionInstance=function(t){if(!t)return null;if(Ja(t))return t.locate||("identity"===(t=Wa({},t)).measure?Wa(t,gd.getInstance("IDENTITY")):Wa(t,gd.getInstance("EPSG:4326"))),t;for(var e in t=(t+"").toLowerCase(),bd)if($a(bd,e)){var i=bd[e].code;if(i&&i.toLowerCase()===t)return bd[e]}return null},t.equals=function(t,e){if(Ya(t)||Ya(e))return t===e;if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var i=t.fullExtent,n=e.fullExtent;if(i&&!n||!i&&n)return!1;if(i&&n&&(i.top!==n.top||i.bottom!==n.bottom||i.left!==n.left||i.right!==n.right))return!1;var r=t.resolutions,s=e.resolutions;if(r&&s){if(r.length!==s.length)return!1;for(var o=0;o<r.length;o++)if(r[o]!==s[o])return!1}else if(r||s)return!1;return!0};var e=t.prototype;return e._initSpatialRef=function(){var e=this.options.projection;if(!(e=e?t.getProjectionInstance(e):wd))throw new Error("must provide a valid projection in map's spatial reference.");(e=Wa({},sd,e)).measureLength||Wa(e,gd.DEFAULT),this._projection=e;var i,n=this.options.resolutions;if(!n&&(e.code&&(i=ip[e.code.toUpperCase()])&&(n=i.resolutions,this.isEPSG="IDENTITY"!==e.code),!n))throw new Error("must provide valid resolutions in map's spatial reference.");if(this._resolutions=n,this._pyramid=!0,this._pyramid)for(var r=0;r<n.length;r++)if(n[r]&&n[r-1]&&n[r-1]/n[r]!=2){this._pyramid=!1;break}var s=this.options.fullExtent;if(!s&&(e.code&&(i=ip[e.code.toUpperCase()])&&(s=i.fullExtent),!s))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(Za(s.left)?(this._fullExtent=new id(s),s.left=s.xmin,s.right=s.xmax,s.top=s.ymax,s.bottom=s.ymin):this._fullExtent=new id(new Gu(s.left,s.top),new Gu(s.right,s.bottom)),Za(s.top)||Za(s.bottom)||Za(s.left)||Za(s.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");Wa(this._fullExtent,s),this._projection.fullExtent=s;var o=s.right>=s.left?1:-1,a=s.top>=s.bottom?-1:1;this._transformation=new rd([o,a,0,0])},e.getResolutions=function(){return this._resolutions||[]},e.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var i=this._resolutions[e];return e!==t&&t>0&&e<this._resolutions.length-1?i+(this._resolutions[e+1]-i)*(t-e):i},e.getProjection=function(){return this._projection},e.getFullExtent=function(){return this._fullExtent},e.getTransformation=function(){return this._transformation},e.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!Za(this._resolutions[t]))return t;return 0},e.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!Za(this._resolutions[t]))return t;return this._resolutions.length-1},e.getZoomDirection=function(){return $h(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},e.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},e.isPyramid=function(){return this._pyramid},t}(),rp=new Gh(0,0),sp=new nd,op=function(t){function e(e){var i,n=Wa({},e),r=n.symbol,s=n.properties,o=n.id;return delete n.symbol,delete n.id,delete n.properties,i=t.call(this,n)||this,r?i.setSymbol(r):i._genSizeSymbol(),s&&i.setProperties(s),Za(o)||i.setId(o),i}Nh(e,t);var i=e.prototype;return i.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},i.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},i.addTo=function(t,e){return t.addGeometry(this,e),this},i.getLayer=function(){return this._layer?this._layer:null},i.getMap=function(){return this._layer?this._layer.getMap():null},i.getId=function(){return this._id},i.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},i.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},i.setProperties=function(t){var e=this.properties;return this.properties=Ja(t)?Wa({},t):t,this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},i.getType=function(){return this.type},i.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?Lc(t):Wa({},t):null},i.setSymbol=function(t){return this._symbolUpdated=t,this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),delete this._compiledSymbol,delete this._symbolHash,this},i.getSymbolHash=function(){return this._symbolHash||(this._symbolHash=Ac(this._symbolUpdated)),this._symbolHash},i.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol();if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Parameter of updateSymbol is not an array.");for(var i=0;i<t.length;i++)af(t[i])&&delete this._textDesc,e[i]&&t[i]&&(e[i]=Lc(e[i],t[i]))}else{if(Array.isArray(t))throw new Error("Geometry's symbol is not an array to update.");af(e)&&delete this._textDesc,e=Lc(e||this._getInternalSymbol(),t)}return this._eventSymbolProperties=t,delete this._compiledSymbol,this.setSymbol(e)},i.getTextContent=function(){var t=this._getInternalSymbol();if(Array.isArray(t)){for(var e=[],i=!1,n=0;n<t.length;n++)e[n]=xc(t[n]&&t[n].textName,this.getProperties()),Za(e[n])||(i=!0);return i?e:null}return xc(t&&t.textName,this.getProperties())},i.getTextDesc=function(){if(!this._textDesc){var t=this.getTextContent(),e=this._sizeSymbol,i=Array.isArray(t);Array.isArray(e)?this._textDesc=e.map((function(e,n){return wc(i?t[n]:"",e)})):this._textDesc=wc(t,e)}return this._textDesc},i.getCenter=function(){return this._computeCenter(this._getMeasurer())},i.getExtent=function(){var t=this._getPrjExtent(),e=this._getProjection();if(t&&e){var i=e.unproject(new Gu(t.xmin,t.ymin)),n=e.unproject(new Gu(t.xmax,t.ymax));return new id(i,n,e)}return this._computeExtent(this._getMeasurer())},i.getContainerExtent=function(t){var e=this.get2DExtent();if(!e||!e.isValid())return null;var i=this.getMap(),n=i.getGLRes(),r=this.getMinAltitude(),s=i.altitudeToPoint(r,n)*$h(r),o=e.convertTo((function(t){return i._pointAtResToContainerPoint(t,n,s,rp)}),t),a=this.getMaxAltitude();if(a!==r){a=i.altitudeToPoint(a,n)*$h(a);var h=e.convertTo((function(t){return i._pointAtResToContainerPoint(t,n,a,rp)}),sp);o._combine(h)}var l=this.getLayer();if(l&&"LineString"===this.type&&a&&l.options.drawAltitude){var c=e.convertTo((function(t){return i._pointAtResToContainerPoint(t,n,0,rp)}),sp);o._combine(c)}return o&&o._add(this._getFixedExtent()),this.options.smoothness&&o._expand(.15*o.getWidth()),o},i._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new nd);var t=this._sizeSymbol,e=(t&&t.lineWidth||1)/2;this._fixedExtent.set(-e,-e,e,e);var i=t&&t.lineDx||0;this._fixedExtent._add([i,0]);var n=t&&t.lineDy||0;return this._fixedExtent._add([0,n]),this._fixedExtent},i.get2DExtent=function(){var t=this.getMap();if(!t)return null;if(this._extent2d)return this._extent2d;var e=this._getPrjExtent();if(!e||!e.isValid())return null;var i=e.getMin(),n=e.getMax(),r=t.getGLRes();return t._prjToPointAtRes(i,r,i),t._prjToPointAtRes(n,r,n),this._extent2d=new nd(i,n),this._extent2d.z=t.getZoom(),this._extent2d},i.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},i.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof Gu&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},i._containsPoint=function(t,e){var i=this._getPainter();return!!i&&(e=e||0,this._hitTestTolerance&&(e+=this._hitTestTolerance()),i.hitTest(t,e))},i.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},i.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},i.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,i=t.length;e<i;e++)if(Za(t[e].opacity)||t[e].opacity>0)return!0;return!1}return Za(t.opacity)||Ja(t.opacity)||qa(t.opacity)&&t.opacity>0},i.getZIndex=function(){return this.options.zIndex||0},i.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},i.setZIndexSilently=function(t){return this.options.zIndex=t,this},i.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},i.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},i.translate=function(t,e){if(Za(t))return this;var i=new Gu(t,e);if(0===i.x&&0===i.y)return this;var n=this.getCoordinates();if(this._silence=!0,n)if(Array.isArray(n)){var r=Qh(n,(function(t){return t.add(i)}));this.setCoordinates(r)}else this.setCoordinates(n.add(i));return this._silence=!1,this._fireEvent("positionchange"),this},i.flash=function(t,e,i,n){return _l.call(this,t,e,i,n)},i.copy=function(){var t=this.toJSON(),i=e.fromJSON(t);return i.options.visible=!0,i},i.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},i.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},i.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(Za(t.geometry)||t.geometry){var i=this._exportGeoJSONGeometry();e.geometry=i}var n,r=this.getId();return Za(r)||(e.id=r),(Za(t.properties)||t.properties)&&(n=this._exportProperties()),e.properties=n,e},i.toJSON=function(t){t||(t={});var e=this._toJSON(t);return Wa(e,this._exportGraphicOptions(t)),e},i.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},i.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},i.rotate=function(t,e){if("GeometryCollection"===this.type)return this.getGeometries().forEach((function(i){return i.rotate(t,e)})),this;e=e?new Gu(e):this.getCenter();var i=this._getMeasurer(),n=this.getCoordinates();if(!Array.isArray(n)){if(e.x!==n.x||e.y!==n.y){var r=i._rotate(n,e,t);this.setCoordinates(r)}return this}return Qh(n,(function(n){return i._rotate(n,e,t)})),this.setCoordinates(n),this},i._getConnectPoints=function(){return[this.getCenter()]},i._initOptions=function(t){var e=Wa({},t),i=e.symbol,n=e.properties,r=e.id;delete e.symbol,delete e.id,delete e.properties,this.setOptions(e),i&&this.setSymbol(i),n&&this.setProperties(n),Za(r)||this.setId(r)},i._bindLayer=function(t){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache(),this._bindInfoWindow(),this._bindMenu()},i._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],i=0;i<t.length;i++)e.push(hc(this._checkAndCopySymbol(t[i])));return e}return t?hc(t=this._checkAndCopySymbol(t)):null},i._checkAndCopySymbol=function(t){var e={};for(var i in t)Ga[i]&&Ya(t[i])?e[i]=+t[i]:e[i]=t[i];return e},i._getSymbol=function(){return this._symbol},i._setExternSymbol=function(t){return this._eventSymbolProperties=t,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},i._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},i._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},i._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},i._getInternalId=function(){return this._internalId},i._setInternalId=function(t){this._internalId=t},i._getMeasurer=function(){return this._getProjection()?this._getProjection():np.getProjectionInstance(this.options.defaultProjection)},i._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},i._verifyProjection=function(){var t=this._getProjection();this._projCode&&t&&this._projCode!==t.code&&this._clearProjection(),this._projCode=t?t.code:this._projCode},i._getExternalResources=function(){return ac(this._getInternalSymbol())},i._getPainter=function(){var t=this.getLayer();if(!this._painter&&t)if(-1!==Fa.indexOf(this.type)){if(t.constructor.getCollectionPainterClass){var e=t.constructor.getCollectionPainterClass();e&&(this._painter=new e(this))}}else if(t.constructor.getPainterClass){var i=t.constructor.getPainterClass();i&&(this._painter=new i(this))}return this._painter},i._getMaskPainter=function(){return this._maskPainter||(this._maskPainter=this.getGeometries&&this.getGeometries()?new ep(this,!0):new Kf(this)),this._maskPainter},i._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},i._paint=function(t){if(this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var e=this._getProjection();e&&(this._pcenter=e.project(this._coordinates),this._clearCache())}this._painter.paint(t)}},i._clearCache=function(){delete this._extent,delete this._extent2d},i._clearProjection=function(){delete this._extent,delete this._extent2d},i._repaint=function(){this._painter&&this._painter.repaint()},i.onHide=function(){this.closeMenu(),this.closeInfoWindow()},i.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},i.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},i.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var t={};this._eventSymbolProperties?(t.properties=Wa({},this._eventSymbolProperties),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",t)},i._genSizeSymbol=function(){var t=this._getInternalSymbol();if(t)if(Array.isArray(t)){this._sizeSymbol=[];for(var e=!1,i=0;i<t.length;i++){var n=this._sizeSymbol[i]=this._getSizeSymbol(t[i]);!e&&n&&n._dynamic&&(e=!0)}this._sizeSymbol._dynamic=e}else this._sizeSymbol=this._getSizeSymbol(t);else delete this._sizeSymbol},i._getSizeSymbol=function(t){var e=rc({lineWidth:t.lineWidth,lineDx:t.lineDx,lineDy:t.lineDy},this);return(Nl(t.lineWidth)||Nl(t.lineDx)||Nl(t.lineDy))&&(e._dynamic=!0),e},i._getCompiledSymbol=function(){return this._compiledSymbol||(this._compiledSymbol=rc(this._getInternalSymbol(),this)),this._compiledSymbol},i.onConfig=function(t){var e;t.properties&&(e=t.properties,delete t.properties);var i=!1;for(var n in t)if(t.hasOwnProperty(n)){var r=n.slice(0,5);if("arrow"===r||"smoot"===r){i=!0;break}}e?(this.setProperties(e),this._repaint()):i&&this._repaint()},i._setParent=function(t){t&&(this._parent=t)},i._getParent=function(){return this._parent},i._fireEvent=function(t,e){this._silence||(this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e))},i._toJSON=function(t){return{feature:this.toGeoJSON(t)}},i._exportGraphicOptions=function(t){var e={};return(Za(t.options)||t.options)&&(e.options=this.config()),(Za(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(Za(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},i._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=Gu.toNumberArrays(t);return{type:this.getType(),coordinates:e}},i._exportProperties=function(){var t=null,e=this.getProperties();return Za(e)||(t=Ja(e)?Wa({},e):e),t},i._hitTestTolerance=function(){var t=this.getLayer();return t&&t.options.geometryEventTolerance||0},i.getAltitude=function(){var t=this.getLayer();if(!t)return 0;var e=t.options,i=this.getProperties(),n=e.enableAltitude&&i?i[e.altitudeProperty]:0,r=t.getAltitude?t.getAltitude():0;return Array.isArray(n)?n.map((function(t){return t+r})):n+r},i._genMinMaxAlt=function(){var t=this,e=this.getAltitude();Array.isArray(e)?(this._minAlt=Number.MAX_VALUE,this._maxAlt=Number.MIN_VALUE,e.forEach((function(e){var i=e;i<t._minAlt&&(t._minAlt=i),i>t._maxAlt&&(t._maxAlt=i)}))):this._minAlt=this._maxAlt=e},i.getMinAltitude=function(){return void 0===this._minAlt&&this._genMinMaxAlt(),this._minAlt?this._minAlt:0},i.getMaxAltitude=function(){return void 0===this._maxAlt&&this._genMinMaxAlt(),this._maxAlt?this._maxAlt:0},e}(Iu(Eu(Nu(Ou))));op.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,antiMeridian:!1,defaultProjection:"EPSG:4326"});var ap={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:!zh.mobile},hp=function(t){function e(e,i){var n,r;return i&&(r=i.canvas,delete i.canvas),(n=t.call(this,i)||this)._canvas=r,n.setId(e),i&&(n.setZIndex(i.zIndex),i.mask&&n.setMask(op.fromJSON(i.mask))),n}Nh(e,t);var i=e.prototype;return i.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();Za(t)||(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},i.getId=function(){return this._id},i.setId=function(t){var e=this._id;return Za(t)||(t+=""),this._id=t,this.fire("idchange",{old:e,new:t}),this},i.addTo=function(t){return t.addLayer(this),this},i.setZIndex=function(t){return this._zIndex=t,Za(t)?delete this.options.zIndex:this.options.zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this},i.getZIndex=function(){return this._zIndex||0},i.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},i.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),Za(e)?1/0:e):e},i.getOpacity=function(){return this.options.opacity},i.setOpacity=function(t){return this.config("opacity",t),this},i.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof Bd},i.getMap=function(){return this.map?this.map:null},i.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},i.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i+1),this},i.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i-1),this},i.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var i=this.getMap();e&&i?i.once("renderend",(function(){t.fire("show")})):this.fire("show")}return this},i.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var i=this.getMap();e&&i?i.once("renderend",(function(){t.fire("hide")})):this.fire("hide")}return this},i.isVisible=function(){if(qa(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var e=t.getZoom();if(!Za(this.options.maxZoom)&&this.options.maxZoom<e||!Za(this.options.minZoom)&&this.options.minZoom>e)return!1}return Za(this.options.visible)&&(this.options.visible=!0),this.options.visible},i.remove=function(){return this.map&&this.map.removeLayer(this),this},i.getMask=function(){return this._mask},i.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type||"MultiPolygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(t._bindLayer(this),"Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=t,this.options.mask=t.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},i.removeMask=function(){if(delete this._mask,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},i.onLoad=function(){return!0},i.onLoadEnd=function(){},i.isLoaded=function(){return!!this._loaded},i.getCollisionIndex=function(){if("layer"===this.options.collisionScope)return this._collisionIndex||(this._collisionIndex=new zu),this._collisionIndex;var t=this.getMap();return t?t.getCollisionIndex():null},i.clearCollisionIndex=function(){return"layer"===this.options.collisionScope&&this._collisionIndex&&this._collisionIndex.clear(),this},i.getRenderer=function(){return this._getRenderer()},i.onConfig=function(t){if(qa(t.opacity)||t.cssFilter){var e=this.getRenderer();e&&e.setToRedraw()}},i.onAdd=function(){},i.onRendererCreate=function(){},i.onCanvasCreate=function(){},i.onRemove=function(){},i._bindMap=function(t,e){t&&(this.map=t,Za(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},i._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{renderer:this._renderer})}},i._doRemove=function(){this._loaded=!1,this._switchEvents("off",this),this.onRemove(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},i._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()&&this.getMap()[t](e.getEvents(),e)},i._getRenderer=function(){return this._renderer},i._getLayerList=function(){return this.map?this.map._layers:[]},i._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getMaskPainter();return t?t.get2DExtent():null},e}(Iu(Eu(Md(Ou))));hp.mergeOptions(ap);var lp=hp.prototype.fire;hp.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={}),e.type=t,e.target=this,this.map._onLayerEvent(e)),lp.apply(this,arguments)};var cp,up,dp,fp,pp,gp,mp,_p=new Gu(0,0),vp={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:!nh,zoomAnimationDuration:330,panAnimation:!nh,panAnimationDuration:600,rotateAnimation:!nh,zoomable:!0,enableInfoWindow:!0,hitDetect:!zh.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:"canvas",cascadePitches:[10,60],renderable:!0,clickTimeThreshold:280,stopRenderOnOffscreen:!0},yp=function(t){function e(i,n){var r;if(!n)throw new Error("Invalid options when creating map.");if(!n.center)throw new Error("Invalid center when creating map.");var s=Wa({},n),o=s.zoom;delete s.zoom;var a=new Gu(s.center);delete s.center;var h=s.baseLayer;delete s.baseLayer;var l=s.layers;return delete s.layers,(r=t.call(this,s)||this).VERSION=e.VERSION,Object.defineProperty(Fh(Fh(r)),"id",{value:Zh(),writable:!1}),r._loaded=!1,r._initContainer(i),r._panels={},r._baseLayer=null,r._layers=[],r._zoomLevel=o,r._center=a,r.setSpatialReference(s.spatialReference||s.view),r._mapViewPoint=new Gh(0,0),r._initRenderer(),r._updateMapSize(r._getContainerDomSize()),h&&r.setBaseLayer(h),l&&r.addLayer(l),r.setMaxExtent(s.maxExtent),r._Load(),r}Nh(e,t),e.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(i),this};var i=e.prototype;return i.isLoaded=function(){return!!this._loaded},i.getContainer=function(){return this._containerDOM},i.getSpatialReference=function(){return this._spatialReference},i.setSpatialReference=function(t){var e=this.options.spatialReference;return this._loaded&&np.equals(e,t)||this._updateSpatialReference(t,e),this},i._updateSpatialReference=function(t,e){if(Ya(t)&&(t=np.getPreset(t)),t=Wa({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new np(t),this.options.spatialReference&&Qa(this.options.spatialReference.projection)){var i=this._spatialReference.getProjection();this.options.spatialReference.projection=i.code}return this._resetMapStatus(),this._fireEvent("spatialreferencechange",{old:e,new:Wa({},this.options.spatialReference)}),this},i.onConfig=function(t){var e=t.spatialReference||t.view;return Za(e)||this._updateSpatialReference(e,null),this},i.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},i.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},i.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},i.resetCursor=function(){return this.setCursor(null)},i.getCenter=function(){return this._loaded&&this._prjCenter?this.getProjection().unproject(this._prjCenter):this._center},i.setCenter=function(t){if(!t)return this;t=new Gu(t);var e=this.getProjection().project(t);return this._verifyExtent(e)?this._loaded?(this.onMoveStart(),this._setPrjCenter(e),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=t,this):this},i.getSize=function(){return Za(this.width)||Za(this.height)?this._getContainerDomSize():new cc(this.width,this.height)},i.getContainerExtent=function(){var t=this.height,e=this.getPitch(),i=this.options.maxVisualPitch;return i&&e>i&&(t=this._getVisualHeight(i)),new nd(0,this.height-t,this.width,this.height)},i._getVisualHeight=function(t){t=t||.01;var e=(90-this.getPitch())*Math.PI/180,i=this.getFov()*Math.PI/180;t*=Math.PI/180;var n=this.cameraCenterDistance/this.getGLScale(),r=Math.tan(i/2),s=n*r/(1/Math.tan(t)-r)/Math.sin(t),o=n*(Math.sin(e)*s/(n+Math.cos(e)*s));return this.height/2+o},i.getExtent=function(){return this._pointToExtent(this._get2DExtent())},i.getProjExtent=function(){var t=this._get2DExtent();return new id(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},i.getPrjExtent=function(){return this.getProjExtent()},i.getMaxExtent=function(){return this.options.maxExtent?new id(this.options.maxExtent,this.getProjection()):null},i.setMaxExtent=function(t){if(t){var e=new id(t,this.getProjection());this.options.maxExtent=e;var i=this.getProjection();this._prjMaxExtent=e.convertTo((function(t){return i.project(t)})),this._verifyExtent(this._getPrjCenter())||(this._loaded?this._panTo(this._prjMaxExtent.getCenter()):this._center=i.unproject(this._prjMaxExtent.getCenter()))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},i.getZoom=function(){return this._zoomLevel},i.getZoomForScale=function(t,e,i){var n=this.getZoom();if(Za(e)&&(e=n),1===t&&e===n)return n;var r=this._getResolution(e)/t,s=this.getZoomFromRes(r);if(i)return s;var o=1e-6;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(s-o):Math.floor(s+o)},i.getZoomFromRes=function(t){var e=this._getResolutions(),i=this._getResolution(this.getMinZoom()),n=this._getResolution(this.getMaxZoom());if(i<=n){if(t<=i)return this.getMinZoom();if(t>=n)return this.getMaxZoom()}else{if(t>=i)return this.getMinZoom();if(t<=n)return this.getMaxZoom()}for(var r=e.length,s=0;s<r-1;s++)if(e[s]){var o=e[s+1]-e[s],a=t-e[s];if($h(o)===$h(a)&&Math.abs(o)>=Math.abs(a))return s+a/o}return r-1},i.setZoom=function(t,e){return void 0===e&&(e={animation:!0}),isNaN(t)||Za(t)||(t=+t,this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t)),this},i.getMaxZoom=function(){return Za(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},i.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&(this.setZoom(t),t=+t),this.options.maxZoom=t,this},i.getMinZoom=function(){return Za(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},i.setMinZoom=function(t){if(null!==t){t=+t;var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},i.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},i.getGLRes=function(){if(this._glRes)return this._glRes;var t=this.getSpatialReference().getFullExtent();return this._glRes=(t.right-t.left)/Math.pow(2,19),this._glRes},i.getGLScale=function(t){return Za(t)&&(t=this.getZoom()),this._getResolution(t)/this.getGLRes()},i.zoomIn=function(){return this.setZoom(this.getZoom()+1)},i.zoomOut=function(){return this.setZoom(this.getZoom()-1)},i.isZooming=function(){return!!this._zooming},i.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},i.setCenterAndZoom=function(t,e){return Za(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},i.getFitZoom=function(t,e){var i=this;if(!(t&&t instanceof id))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var n=this.getSize(),r=t.convertTo((function(t){return i.coordToPoint(t)})),s=r.getWidth(),o=r.getHeight(),a=n.width/s,h=n.height/o,l=this.getSpatialReference().getZoomDirection()<0?Math.max(a,h):Math.min(a,h);return this.getZoomForScale(l,null,e)},i.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},i.setView=function(t){return t?(t.center&&this.setCenter(t.center),null===t.zoom||isNaN(+t.zoom)||this.setZoom(+t.zoom,{animation:!1}),null===t.pitch||isNaN(+t.pitch)||this.setPitch(+t.pitch),null===t.pitch||isNaN(+t.bearing)||this.setBearing(+t.bearing),this):this},i.getResolution=function(t){return this._getResolution(t)},i.getScale=function(t){var e=Za(t)?this.getZoom():t,i=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/i},i.fitExtent=function(t,e,i,n){if(void 0===i&&(i={}),!t)return this;t=new id(t,this.getProjection());var r=this.getFitZoom(t)+(e||0),s=t.getCenter();return void 0===i.animation||i.animation?this._animateTo({center:s,zoom:r},{duration:i.duration||this.options.zoomAnimationDuration,easing:i.easing||"out"},n):this.setCenterAndZoom(s,r)},i.getBaseLayer=function(){return this._baseLayer},i.setBaseLayer=function(t){var e=!1;if(this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!t)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",(function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))}),this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},i.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},i.getLayers=function(t){return this._getLayers((function(e){return!(e===this._baseLayer||e.getId().indexOf(Na)>=0)&&(!t||t(e))}))},i.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var i=this.getBaseLayer();return i&&i.getId()===t?i:null},i.addLayer=function(t){if(!t)return this;if(!Array.isArray(t))return t=Array.prototype.slice.call(arguments,0),this.addLayer(t);this._layerCache||(this._layerCache={});for(var e=this._layers,i=0,n=t.length;i<n;i++){var r=t[i],s=r.getId();if(Za(s))throw new Error("Invalid id for the layer: "+s);if(r.getMap()!==this){if(this._layerCache[s])throw new Error("Duplicate layer id in the map: "+s);this._layerCache[s]=r,r._bindMap(this),e.push(r),this._loaded&&r.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},i.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],i=0,n=t.length;i<n;i++){var r=t[i];if(r instanceof hp||(r=this.getLayer(r)),r){var s=r.getMap();if(s&&s===this){e.push(r),this._removeLayer(r,this._layers),this._loaded&&r._doRemove();var o=r.getId();this._layerCache&&delete this._layerCache[o]}}}if(e.length>0){var a=this.getRenderer();a&&a.setLayerCanvasUpdated(),e.forEach((function(t){t.fire("remove")}))}return this._fireEvent("removelayer",{layers:t}),this},i.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],i=Number.MAX_VALUE,n=0,r=t.length;n<r;n++){var s=t[n];if(Ya(t[n])&&(s=this.getLayer(s)),!(s instanceof hp&&s.getMap()&&s.getMap()===this))throw new Error("It must be a layer added to this map to order.");s.getZIndex()<i&&(i=s.getZIndex()),e.push(s)}for(var o=0,a=e.length;o<a;o++)e[o].setZIndex(i+o);return this},i.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var i=t.save,n=this._getRenderer();if(n&&n.toDataURL){var r=t.fileName;r||(r="export");var s=n.toDataURL(e,t.quality||.92);if(i&&s){var o;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var a=ul(s.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),e);o=URL.createObjectURL(a)}else o=s;var h=document.createElement("a");h.download=r,h.href=o,document.body.appendChild(h),h.click(),document.body.removeChild(h)}return s}return null},i.coordToPoint=function(t,e,i){return this.coordinateToPoint(t,e,i)},i.coordToPointAtRes=function(t,e,i){return this.coordinateToPointAtRes(t,e,i)},i.pointToCoord=function(t,e,i){return this.pointToCoordinate(t,e,i)},i.pointAtResToCoord=function(t,e,i){return this.pointAtResToCoordinate(t,e,i)},i.coordToViewPoint=function(t,e,i){return this.coordinateToViewPoint(t,e,i)},i.viewPointToCoord=function(t,e){return this.viewPointToCoordinate(t,e)},i.coordToContainerPoint=function(t,e,i){return this.coordinateToContainerPoint(t,e,i)},i.containerPointToCoord=function(t,e){return this.containerPointToCoordinate(t,e)},i.containerPointToViewPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._sub(this.getViewPoint())},i.viewPointToContainerPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._add(this.getViewPoint())},i.checkSize=function(t){var e=Va()-this._initTime<1500&&0===this.width||0===this.height,i=this._getContainerDomSize(),n=this.height,r=this.width;if(!t&&i.width===r&&i.height===n)return this;$c(this._containerDOM);var s=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(i);else{var o=this._getVisualHeight(this.getPitch()),a=new Gh(0,this.height-o),h=this._containerPointToPrj(a);this._updateMapSize(i);var l=this._getVisualHeight(this.getPitch()),c=new Gh(0,this.height-l);this._setPrjCoordAtContainerPoint(h,c),this._mapViewCoord=this._getPrjCenter()}var u=0===i.width||0===i.height||0===r||0===n;return(e||u)&&(this._eventSilence=!0,this.setCenter(s),delete this._eventSilence),this._fireEvent("resize"),this},i.locate=function(t,e,i){return this.getProjection()._locate(new Gu(t),e,i)},i.getMainPanel=function(){return this._getRenderer().getMainPanel()},i.getPanels=function(){return this._panels},i.remove=function(){var t=this;if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var e=this.getLayers(),i=0;i<e.length;i++)e[i].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter((function(t){return"maptalks-wrapper"===t.className})).forEach((function(e){return t._containerDOM.removeChild(e)})),delete this._panels,delete this._containerDOM,delete this.renderer,this._fireEvent("removeend"),this._clearAllListeners(),zh.removeDPRListening&&zh.removeDPRListening(this),this},i.isRemoved=function(){return!this._containerDOM},i.isMoving=function(){return!!this._moving},i.onMoveStart=function(t){this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer);var e=this._getPrjCenter();this._originCenter&&!this._verifyExtent(e)||(this._originCenter=e),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},i.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving"))},i.onMoveEnd=function(t){if(this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),!this._verifyExtent(this._getPrjCenter())&&this._originCenter){var e=this._originCenter;this._panTo(e)}},i.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},i.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},i.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},i.isDragRotating=function(){return!!this._dragRotating},i.isOffscreen=function(t,e){void 0===e&&(e=0);var i=this.width+e,n=this.height+e,r=t.xmin,s=t.ymin,o=t.xmax,a=t.ymax;return Array.isArray(t)&&(r=t[0],s=t[1],o=t[2],a=t[3]),o<e||r>=i||a<e||s>n},i.getRenderer=function(){return this._getRenderer()},i.getDevicePixelRatio=function(){return this.options.devicePixelRatio||zh.devicePixelRatio||1},i.setDevicePixelRatio=function(t){return qa(t)&&t>0&&t!==this.options.devicePixelRatio&&(this.options.devicePixelRatio=t,this.checkSize(!0)),this},i._initContainer=function(t){if(Ya(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,nh&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},i._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},i._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},i._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},i._removeLayer=function(t,e){if(t&&e){var i=e.indexOf(t);i>-1&&e.splice(i,1)}},i._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++)this._layers[t]._order=t,this._layers[t].sortLayersByZIndex&&this._layers[t].sortLayersByZIndex();this._layers.sort((function(t,e){var i=t.getZIndex()-e.getZIndex();return 0===i?t._order-e._order:i}))}},i._fireEvent=function(t,e){this._eventSilence||(this.fire("_"+t,e),this.fire(t,e))},i._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),delete this._glRes,this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=Va()},i._initRenderer=function(){var t=this.options.renderer,i=e.getRendererClass(t);this._renderer=new i(this),this._renderer.load()},i._getRenderer=function(){return this._renderer},i._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer((function(t){t&&t.load()}),this.getLayers())},i._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,i=[],n=0;n<e.length;n++)t&&!t.call(this,e[n])||i.push(e[n]);return i},i._eachLayer=function(t){if(!(arguments.length<2)){var e=Array.prototype.slice.call(arguments,1);e&&!Array.isArray(e)&&(e=[e]);for(var i=[],n=0,r=e.length;n<r;n++)i=i.concat(e[n]);for(var s=0,o=i.length;s<o;s++)t.call(t,i[s])}},i._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},i._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),i=this._spatialReference.getMaxZoom(),n=this._spatialReference.getMinZoom();(Za(t)||-1===t||t>i)&&this.setMaxZoom(i),(Za(e)||-1===e||e<n)&&this.setMinZoom(n),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(Za(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var r=this.getProjection();this._prjCenter=r.project(this._center),this._calcMatrices();var s=this._getRenderer();s&&s.resetContainer()},i._getContainerDomSize=function(){if(!this._containerDOM)return null;var t,e,i=this._containerDOM;if(this._containerDomContentRect)return t=this._containerDomContentRect.width,e=this._containerDomContentRect.height,new cc(t,e);if(Za(i.width)||Za(i.height)){if(Za(i.clientWidth)||Za(i.clientHeight))throw new Error("can not get size of container");t=parseInt(i.clientWidth,0),e=parseInt(i.clientHeight,0)}else{t=i.width,e=i.height;var n=this.getDevicePixelRatio();1!==n&&i.layer&&(t/=n,e/=n)}return new cc(t,e)},i._updateMapSize=function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this._calcMatrices(),this},i._getPrjCenter=function(){return this._prjCenter},i._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},i._setPrjCoordAtContainerPoint=function(t,e){if(e.x===this.width/2&&e.y===this.height/2)return this;var i=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),n=this._pointToPrj(this._prjToPoint(t).sub(i));return this._setPrjCenter(n),this},i._verifyExtent=function(t){if(!t)return!1;var e=this._prjMaxExtent;return!e||e.contains(t)},i._offsetCenterByPixel=function(t){var e=new Gh(this.width/2-t.x,this.height/2-t.y),i=this._containerPointToPrj(e);return this._setPrjCenter(i),i},i.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},i.getViewPoint=function(){var t=this._getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},i._resetMapViewPoint=function(){this._mapViewPoint=new Gh(0,0),this._mapViewCoord=this._getPrjCenter()},i._getResolution=function(t){return void 0!==t&&t!==this._zoomLevel||void 0===this._mapRes?(Za(t)&&(t=this._zoomLevel),this._spatialReference.getResolution(t)):this._mapRes},i._getResolutions=function(){return this._spatialReference.getResolutions()},i._prjToPoint=function(t,e,i){e=Za(e)?this.getZoom():e;var n=this._getResolution(e);return this._prjToPointAtRes(t,n,i)},i._prjToPointAtRes=function(t,e,i){return this._spatialReference.getTransformation().transform(t,e,i)},i._prjsToPointsAtRes=function(t,e,i){void 0===i&&(i=[]);for(var n=this._spatialReference.getTransformation(),r=[],s=0,o=t.length;s<o;s++){var a=n.transform(t[s],e,i[s]);r.push(a)}return r},i._pointToPrj=function(t,e,i){e=Za(e)?this.getZoom():e;var n=this._getResolution(e);return this._pointToPrjAtRes(t,n,i)},i._pointToPrjAtRes=function(t,e,i){return this._spatialReference.getTransformation().untransform(t,e,i)},i._pointToPoint=function(t,e,i){return Za(e)?(i?(i.x=t.x,i.y=t.y):i=t.copy(),i):this._pointAtResToPoint(t,this._getResolution(e),i)},i._pointAtResToPoint=function(t,e,i){return i?(i.x=t.x,i.y=t.y):i=t.copy(),i._multi(e/this._getResolution())},i._pointToPointAtRes=function(t,e,i){return i?(i.x=t.x,i.y=t.y):i=t.copy(),i._multi(this._getResolution()/e)},i._containerPointToPrj=function(t,e){return this._pointToPrj(this._containerPointToPoint(t,void 0,e),void 0,e)},i._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var i=0,n=t._onLoadHooks.length;i<n;i++)t._onLoadHooks[i].call(this)},i._fixPrjOnWorldWide=function(t){var e=this.getProjection();if(e&&e.fullExtent&&t){var i=e.fullExtent||{},n=i.left,r=i.bottom,s=i.top,o=i.right;qa(n)&&(t.x=Math.max(n,t.x)),qa(o)&&(t.x=Math.min(o,t.x)),qa(r)&&(t.y=Math.max(r,t.y)),qa(s)&&(t.y=Math.min(s,t.y))}return this},e}(Nu(Eu(Md(Ou))));yp.include({coordinateToPoint:function(t,e,i){var n=this._getResolution(e);return this.coordinateToPointAtRes(t,n,i)},coordinateToPointAtRes:(mp=new Gu(0,0),function(t,e,i){var n=this.getProjection().project(t,mp);return this._prjToPointAtRes(n,e,i)}),pointToCoordinate:function(){var t=new Gu(0,0);return function(e,i,n){var r=this._pointToPrj(e,i,t);return this.getProjection().unproject(r,n)}}(),pointAtResToCoordinate:function(){var t=new Gu(0,0);return function(e,i,n){var r=this._pointToPrjAtRes(e,i,t);return this.getProjection().unproject(r,n)}}(),coordinateToViewPoint:function(){var t=new Gu(0,0);return function(e,i,n){return this._prjToViewPoint(this.getProjection().project(e,t),i,n)}}(),viewPointToCoordinate:function(){var t=new Gu(0,0);return function(e,i){return this.getProjection().unproject(this._viewPointToPrj(e,t),i)}}(),coordinateToContainerPoint:function(t,e,i){var n=this._getResolution(e);return this.coordinateToContainerPointAtRes(t,n,i)},coordinateToContainerPointAtRes:function(){var t=new Gu(0,0);return function(e,i,n){var r=this.getProjection().project(e,t);return this._prjToContainerPointAtRes(r,i,n)}}(),coordinatesToContainerPoints:function(t,e){var i=this._getResolution(e);return this.coordinatesToContainerPointsAtRes(t,i)},coordinatesToContainerPointsAtRes:function(t,e){for(var i=[],n=this._spatialReference.getTransformation(),r=e/this._getResolution(),s=this.getProjection(),o=new Gu(0,0),a=this.isTransforming(),h=this._prjToPoint(this._getPrjCenter(),void 0,_p),l=0,c=t.length;l<c;l++){var u=s.project(t[l],o),d=n.transform(u,e);d=d._multi(r),this._toContainerPoint(d,a,r,0,h),i.push(d)}return i},containerPointToCoordinate:function(){var t=new Gu(0,0);return function(e,i){var n=this._containerPointToPrj(e,t);return this.getProjection().unproject(n,i)}}(),containerToExtent:(pp=new Gh(0,0),gp=new Gh(0,0),function(t){var e=new nd(this._containerPointToPoint(t.getMin(pp),void 0,pp),this._containerPointToPoint(t.getMax(gp),void 0,gp));return this._pointToExtent(e)}),distanceToPixel:function(){var t=new Gh(0,0),e=new Gh(0,0);return function(i,n,r){var s=this.getProjection();if(!s)return null;var o=this.getScale()/this.getScale(r),a=this.getCenter(),h=s.locate(a,i,n),l=this.coordToContainerPoint(a,void 0,t),c=this.coordToContainerPoint(h,void 0,e);return c._sub(l)._multi(o)._abs(),new cc(c.x,c.y)}}(),distanceToPoint:function(t,e,i,n){var r=this._getResolution(i);return this.distanceToPointAtRes(t,e,r,n)},distanceToPointAtRes:function(){var t=new Gh(0,0),e=new Gu(0,0);return function(i,n,r,s,o){var a=this.getProjection();if(!a)return null;var h=s||this.getCenter(),l=a.locate(h,i,n,e),c=this.coordToPointAtRes(h,r,t),u=this.coordToPointAtRes(l,r,o);return u._sub(c)._abs(),u}}(),altitudeToPoint:(dp=new Gu(0,40),fp=new Gh(0,0),function(t,e,i){void 0===t&&(t=0);var n=this.distanceToPointAtRes(t,t,e,i||dp,fp);t<0&&n.x>0&&(n.x=-n.x);var r=this.options.heightFactor;return r&&1!==r&&(n.x*=r,n.y*=r),n.x}),pointAtResToAltitude:function(){var t=new Gu(0,40);return function(e,i,n){return void 0===e&&(e=0),this.pointAtResToDistance(e,0,i,n||t)}}(),pixelToDistance:(cp=new Gu(0,0),up=new Gu(0,0),function(t,e){var i=this.getProjection();if(!i)return null;var n=this.getFullExtent(),r=n.top>n.bottom?-1:1,s=cp.set(this.width/2+t,this.height/2+r*e),o=this.containerPointToCoord(s,up);return i.measureLength(this.getCenter(),o)}),pointToDistance:function(t,e,i){var n=this.getResolution(i);return this.pointAtResToDistance(t,e,n)},pointAtResToDistance:function(){var t=new Gh(0,0),e=new Gu(0,0),i=new Gu(0,0),n=new Gu(0,0);return function(r,s,o,a){var h=this.getProjection();if(!h)return null;var l=a?h.project(a,e):this._getPrjCenter(),c=this._prjToPointAtRes(l,o,t);c._add(r,s);var u=this.pointAtResToCoord(c,o,i),d=a||h.unproject(l,n);return h.measureLength(d,u)}}(),locateByPoint:function(){var t=new Gh(0,0);return function(e,i,n){var r=this.coordToContainerPoint(e,void 0,t);return this.containerPointToCoord(r._add(i,n))}}(),_get2DExtent:function(t,e){var i;if(void 0!==t&&t!==this._zoomLevel||!this._mapExtent2D||(i=this._mapExtent2D),i)return e?(e.set(i.xmin,i.ymin,i.xmax,i.ymax),e):i.copy();var n=this._getResolution(t);return this._get2DExtentAtRes(n,e)},_get2DExtentAtRes:function(){var t=new Gh(0,0);return function(e,i){var n=this;return e===this._mapGlRes&&this._mapGlExtent2D?this._mapGlExtent2D:this.getContainerExtent().convertTo((function(i){return n._containerPointToPointAtRes(i,e,t)}),i)}}(),_pointToExtent:function(){var t=new Gu(0,0),e=new Gu(0,0);return function(i){var n=i.getMin(),r=i.getMax(),s=this.getFullExtent(),o=!s||s.left<=s.right?[n.x,r.x]:[r.x,n.x],a=o[0],h=o[1],l=!s||s.top>s.bottom?[r.y,n.y]:[n.y,r.y],c=l[0],u=l[1],d=n.set(a,u),f=r.set(h,c);return new id(this.pointToCoord(d,void 0,t),this.pointToCoord(f,void 0,e),this.getProjection())}}(),_getViewPointFrameOffset:function(){var t=new Gh(0,0);return function(){if(this.isZooming())return null;var e=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(e)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(e,void 0,t)):null}}(),_viewPointToPrj:function(){var t=new Gh(0,0);return function(e,i){return this._containerPointToPrj(this.viewPointToContainerPoint(e,t),i)}}(),_prjToContainerPoint:function(t,e,i,n){var r=this._getResolution(e);return this._prjToContainerPointAtRes(t,r,i,n)},_prjToContainerPointAtRes:function(){var t=new Gh(0,0);return function(e,i,n,r){return this._pointAtResToContainerPoint(this._prjToPointAtRes(e,i,t),i,r||0,n)}}(),_prjToViewPoint:function(){var t=new Gh(0,0);return function(e,i,n){var r=this._prjToContainerPoint(e,void 0,t,n);return this.containerPointToViewPoint(r,i)}}(),_viewPointToPoint:function(){var t=new Gh(0,0);return function(e,i,n){return this._containerPointToPoint(this.viewPointToContainerPoint(e,t),i,n)}}(),_pointToViewPoint:function(){var t=new Gu(0,0);return function(e,i,n){return this._prjToViewPoint(this._pointToPrj(e,i,t),n)}}()}),yp.mergeOptions(vp);var xp=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},i.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},i._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var i=e.getZoom(),n=t.domEvent.shiftKey?Math.ceil(i)-1:Math.floor(i)+1;e._zoomAnimation(n,t.containerPoint)}},e}(Ru);yp.mergeOptions({doubleClickZoom:!0}),yp.addOnLoadHook("addHandler","doubleClickZoom",xp);var wp=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){var t=this.target;if(t){var e=t._panels.mapWrapper||t._containerDOM;this._dragHandler=new Uu(e,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},i.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},i._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},i._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},i._onMouseDown=function(t){delete this.startDragTime,delete this._mode,2===t.domEvent.button||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),Jc(t.domEvent)},i._onDragStart=function(t){this.startDragTime=Va(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},i._onDragging=function(t){this.target._isEventOutMap(t.domEvent)||("move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t))},i._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},i._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY,this._startPrjCenter=this.target._getPrjCenter().copy()},i._moveStart=function(t){this._start(t);var e=this.target;e.onMoveStart(t);var i=tu(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e._containerPointToPrj(i)},i._moving=function(t){if(this.startDragTime){var e=this.target,i=tu(e._getActualEvent(t.domEvent),e.getContainer());e._setPrjCoordAtContainerPoint(this.startPrjCoord,i),e.onMoving(t)}},i._moveEnd=function(t){if(this.startDragTime){var e="touchend"===t.domEvent.type,i=this.target,n=Va()-this.startDragTime,r=t.mousePos.x,s=t.mousePos.y,o=r-this.startX,a=s-this.startY,h=i._getPrjCenter(),l=h.sub(this._startPrjCenter);if(this._clear(),i.options.panAnimation&&!t.interupted&&i._verifyExtent(i._getPrjCenter())&&n<280&&Math.abs(a)+Math.abs(o)>5){n*=5;var c=e?5:2.8,u=h.add(l._multi(c));i._panTo(u,{duration:e?3*n:2*n,easing:"outExpo"})}else i.onMoveEnd(t)}},i._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},i._rotating=function(t){var e=this.target,i=t.mousePos.x,n=t.mousePos.y,r=e.getPitch(),s=e.getBearing(),o=Math.abs(i-this.preX),a=Math.abs(n-this.preY);if(this._rotateMode||(e.options.dragRotatePitch?this._rotateMode="rotate_pitch":this._rotateMode=o>a?"rotate":o<a?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===r&&a<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var h=0;h=e.options.dragPitch||o>a?-.6*(this.preX-i):i>e.width/2?.6*(this.preY-n):-.6*(this.preY-n);var l=e.getBearing()+h;this._db=this._db||0,this._db+=h,e._setBearing(l)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e._setPitch(e.getPitch()+.4*(this.preY-n)),this.preX=i,this.preY=n,e.getBearing()===s&&e.getPitch()===r||e.onDragRotating(t)}},i._rotateEnd=function(t){var e=this.target,i=e.getBearing();this._clear();var n=Va()-this.startDragTime;if(e.onDragRotateEnd(t),e.options.rotateAnimation&&Math.abs(i-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&n<400){var r=e.getBearing();e._animateTo({bearing:r+this._db/1.5},{easing:"outQuint",duration:1600})}},i._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(Ru);yp.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),yp.addOnLoadHook("addHandler","draggable",wp);var bp="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",Mp={mousemove:["mousemove","mouseover","mouseout","mouseenter"],touchend:["touchend","click"]},Sp=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;uu(e,bp,this._identifyGeometryEvents,this)},i.removeHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;du(e,bp,this._identifyGeometryEvents)},i._identifyGeometryEvents=function(t,e){var i=this.target;if(!i.isInteracting()&&!i._ignoreEvent(t)){var n=null,r=e||t.type,s="mousedown"===r||"touchstart"===r&&t.touches&&1===t.touches.length;if(s)this._mouseDownTime=Va();else if(("click"===r||"touchend"===r)&&this._mouseDownTime){var o=this._mouseDownTime;if(delete this._mouseDownTime,Va()-o>300){if("click"===r)return}else"touchend"===r&&(n="click")}var a=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(a){var h=tu(a,i._containerDOM);"touchstart"===r&&Jc(t);for(var l=null,c=this.target.getRenderer().getTopElements(),u=s&&2!==t.button,d=0;d<c.length;d++)if(c[d].hitTest(h)){var f=c[d].options.cursor;if(f&&(l=f),u||c[d].events&&c[d].events.indexOf(r)>=0){var p={target:i,type:r,domEvent:t,containerPoint:h};if(u)return i._setPriorityCursor(l),void c[d].mousedown(p);c[d].onEvent(p)}}var g=i._getLayers((function(t){return!(!t.identify||!t.options.geometryEvents)}));if(i._setPriorityCursor(l),g.length){var m=Mp[r]||[r],_={includeInternals:!0,filter:function(e){if(!(e instanceof op))return!1;var i=e._getEventTypeToFire(t);if("mousemove"===r){if(!l&&e.options.cursor&&(l=e.options.cursor),!e.listens("mousemove")&&!e.listens("mouseover")&&!e.listens("mouseenter"))return!1}else if(!e.listens(i)&&!e.listens(n))return!1;return!0},count:1,onlyVisible:i.options.onlyVisibleGeometryEvents,containerPoint:h,layers:g,eventTypes:m},v=function(e){var s=!0;if("mousemove"===r){var o={};if(e.length>0)for(var a=e.length-1;a>=0;a--){var h=e[a];if(h instanceof op){var c=h._getInternalId();o[c]=h,h._onEvent(t),this._prevOverGeos&&this._prevOverGeos.geomap[c]||h._onEvent(t,"mouseenter"),s=h._onEvent(t,"mouseover")}}i._setPriorityCursor(l);var u=this._prevOverGeos&&this._prevOverGeos.geos;if(this._prevOverGeos={geos:e,geomap:o},u&&u.length>0)for(var d=u.length-1;d>=0;d--){var f=u[d];if(f instanceof op)o[u[d]._getInternalId()]||(s=f._onEvent(t,"mouseout"))}}else{if(!e||!e.length)return;for(var p=e.length-1;p>=0;p--)if(e[p]instanceof op){s=e[p]._onEvent(t),n&&e[p]._onEvent(t,n);break}}!1===s&&Yc(t)}.bind(this);"mousemove"===r||"touchmove"===r?this._queryIdentifyTimeout=i.getRenderer().callInNextFrame((function(){i.isInteracting()||i.identifyAtPoint(_,v)})):i.identifyAtPoint(_,v)}}}},e}(Ru);yp.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),yp.addOnLoadHook("addHandler","geometryEvents",Sp);var Cp=4.000244140625,Tp=function(t){function e(e){var i;return(i=t.call(this,e)||this)._thisScrollZoom=i._scrollZoom.bind(Fh(Fh(i))),i._wheelZoomRate=.0022222222222222222,i._defaultZoomRate=.01,i._delta=0,i}Nh(e,t);var i=e.prototype;return i.addHooks=function(){Zc(this.target._containerDOM,"wheel",this._onWheelScroll,this)},i.removeHooks=function(){qc(this.target._containerDOM,"wheel",this._onWheelScroll)},i._onWheelScroll=function(t){Jc(t),Yc(t);var e=this.target;if(e._ignoreEvent(t)||!e.options.zoomable)return!1;var i=e._containerDOM,n=e._checkZoomOrigin(tu(t,i));return e.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(t,n)):this._interval(t,n)},i._seamless=function(t,e){var i=t.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*t.deltaY:t.deltaY;if(i%Cp!=0&&(this._ensureTrackpad||(Math.abs(i)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(i*=14)),t.shiftKey&&i&&(i/=4),this._lastWheelEvent=t,this._delta-=i,!this._zooming&&this._delta){var n=this.target;this._zoomOrigin=e,n.onZoomStart(null,e)}this._start()},i._start=function(){if(this._delta){this._zooming=!0;var t=this.target;this._active||(t.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0)}},i._scrollZoom=function(){var t=this;if(this._active=!1,this._delta){var e=Math.abs(this._delta)>Cp?this._wheelZoomRate:this._defaultZoomRate,i=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==i&&(i=1/i);var n=this.target,r=n.getZoom(),s=n.getZoomForScale(i,r,!0);this._delta=0,n.onZooming(s,this._zoomOrigin),this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout((function(){t._zooming=!1,delete t._timeout,n.onZoomEnd(n.getZoom(),t._zoomOrigin)}),210)}},i._interval=function(t,e){var i=this,n=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var r=(t.deltaY?-1*t.deltaY:t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(r*=-1);var s=n.getZoom(),o=s+r;if((o=n._checkZoom(r>0?Math.ceil(o):Math.floor(o)))===s)return!1;this._zooming=!0,this._delta||(n.onZoomStart(null,e),this._origin=e,this._delta=r,this._startZoom=n.getZoom());return n._animateTo({zoom:o-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},(function(e){"finished"===e.state.playState?i._requesting<1||Math.abs(o-i._startZoom)>2||o===n.getMaxZoom()||o===n.getMinZoom()?(n._animateTo({zoom:o,around:i._origin},{continueOnViewChanged:!0,duration:100},(function(t){"running"!==t.state.playState&&(delete i._zooming,delete i._requesting)})),delete i._startZoom,delete i._origin,delete i._delta,i._requesting=0):Za(i._requesting)||(delete i._zooming,i._onWheelScroll(t)):"running"!==e.state.playState&&(delete i._zooming,delete i._requesting)})),!1},e}(Ru);yp.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),yp.addOnLoadHook("addHandler","scrollWheelZoom",Tp);var Pp=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){Zc(this.target.getContainer(),"touchstart",this._onTouchStart,this)},i.removeHooks=function(){qc(this.target.getContainer(),"touchstart",this._onTouchStart)},i._onTouchStart=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var i=e.getContainer(),n=tu(t.touches[0],i),r=tu(t.touches[1],i);this.preY=n.y,this._startP1=n,this._startP2=r,this._startDist=n.distanceTo(r),this._startVector=n.sub(r),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),du(document,"touchmove",this._onTouchMove),du(document,"touchend",this._onTouchEnd),Zc(document,"touchmove",this._onTouchMove,this),Zc(document,"touchend",this._onTouchEnd,this),Jc(t),e._fireEvent("touchactstart")}},i._onTouchMove=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var i=e.getContainer(),n=tu(t.touches[0],i),r=tu(t.touches[1],i),s=n.sub(this._startP1),o=r.sub(this._startP2),a=n.sub(r),h=n.distanceTo(r)/this._startDist,l=180*a.angleWith(this._startVector)/Math.PI,c=.4*((this.preY||n.y)-n.y);this.preY=n.y;var u={domEvent:t,mousePos:[n,r]};if(this.mode||(e.options.touchRotate&&Math.abs(l)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&s.y*o.y>0&&Math.abs(s.y)>10&&Math.abs(o.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-h)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(u)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=h;var d=e._getResolution(this._startZoom)/h,f=e.getZoomFromRes(d);e.onZooming(f,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e._setBearing(this._startBearing+l),e.onDragRotating(u)):"pitch"===this.mode&&(e._setPitch(e.getPitch()+c),e.onDragRotating(u)),e._fireEvent("touchactinging")}},i._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var i=e.getSize();this._Origin=new Gh(i.width/2,i.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},i._onTouchEnd=function(t){delete this.preY;var e=this.target;if(du(document,"touchmove",this._onTouchMove),du(document,"touchend",this._onTouchEnd),"zoom"===this.mode||"rotate_zoom"===this.mode){var i=this._scale,n=e._getResolution(this._startZoom)/i,r=e.getZoomFromRes(n);e.onZoomEnd(r,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(Ru);yp.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),yp.addOnLoadHook("addHandler","touchGesture",Pp);var Ap="__anim_player",Ep={outExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},outQuint:function(t){return 1-Math.pow(1-t,5)},in:function(t){return Math.pow(t,2)},out:function(t){return 1-Ep.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?Ep.inAndOut(2*t):1-Ep.inAndOut(2*(t-.5))}},Lp=function(t,e){this.state=t,this.styles=e},Rp=function(t,e,i,n){this._animation=t,this.options=e,this._onFrame=i,this.playState="idle",this.ready=!0,this.finished=!1,this.target=n},Op={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return Op._resolveStyles(t);for(var e=[],i=[],n=[],r=0;r<t.length;r++){var s=Op._resolveStyles(t[r]);s&&(e.push(s[0]),i.push(s[1]),n.push(s[2]))}return e.length?[e,i,n]:null}function i(t){var e,i=t;Array.isArray(t)||(i=qa(t)?[0,t]:t instanceof Gh||t instanceof Gu?[new(e=t.constructor)(0,0),t]:[t,t]);var n=i[0],r=i[1];return qa(n)&&qa(r)?n===r?null:[n,r-n,r]:Array.isArray(n)&&qa(n[0])||n instanceof Gu||n instanceof Gh?(Array.isArray(n)?(n=new Gu(n),r=new Gu(r)):(n=new(e=n.constructor)(n),r=new e(r)),n.equals(r)?null:[n,r.sub(n),r]):[n,r,r]}var n,r={},s={},o={};for(var a in t)if(t.hasOwnProperty(a)){var h=t[a];if(!h)continue;if(Array.isArray(h)&&(Za(h[0])||Za(h[1])))continue;var l=void 0;n=h,(l=!Array.isArray(n)&&n.constructor===Object||Array.isArray(n)&&n[0].constructor===Object?e(h):i(h))&&(s[a]=l[0],r[a]=l[1],o[a]=l[2])}return[s,r,o]},framing:function(t,e){e||(e={});var i,n,r,s=e.easing?Ep[e.easing]:Ep.linear;s||(s=Ep.linear),(t=Op._resolveStyles(t))&&(n=t[0],i=t[1],r=t[2]);var o=function t(e,i,n){if(!i||!n)return null;var s={};for(var o in n)if(n.hasOwnProperty(o)){if(i[o]===r[o]){s[o]=i[o];continue}var a=i[o],h=n[o];if(qa(h))s[o]=a+e*h;else if(Array.isArray(h)){for(var l=[],c=0;c<h.length;c++)l.push(t(e,a[c],h[c]));s[o]=l}else{var u=h.constructor;s[o]=u===Object?t(e,a,h):a instanceof Gh||a instanceof Gu?a.add(h.multi(e)):h}}return s};return function(t,e){var a,h;if(t<0)a={playState:"idle",delta:0},h=n;else if(t<e){var l=s(t/e);a={playState:"running",delta:l},h=o(l,n,i)}else a={playState:"finished",delta:1},h=r;return a.startStyles=n,a.destStyles=r,a.progress=t,a.remainingMs=e-t,new Lp(a,h)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=jh(Op._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,i=t.length;e<i;e++)t[e]();this._frameQueue.length?this._animationFrameId=jh(Op._frameFn):delete this._animationFrameId}},animate:function(t,e,i,n){e||(e={});var r=Op.framing(t,e);return new Rp(r,e,i,n)}};Op._frameFn=Op._run.bind(Op),Wa(Rp.prototype,{_prepare:function(){var t=this.options,e=t.speed||t.duration;Ya(e)&&((e=Op.speed[e])||(e=+e)),e||(e=Op.speed.normal),this.duration=e,this._framer=t.framer||Op._requestAnimFrame.bind(Op)},play:function(){if("idle"!==this.playState&&"paused"!==this.playState||this.target&&this.target[Ap])return this;this.target&&(this.target[Ap]=1),"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=Va();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},pause:function(){return"paused"===this.playState||(this.playState="paused",this._run()),this},cancel:function(){return"idle"===this.playState||(this.playState="idle",this.finished=!1,this._run()),this},finish:function(){return"finished"===this.playState||(this.playState="finished",this.finished=!0,this._run()),this},reverse:function(){},_run:function(){var t=this,e=this._onFrame,i=Va(),n=i-this._playStartTime;if(this.options.repeat&&n>=this.duration&&(this._playStartTime=i,n=0),"running"===this.playState){var r=this._animation(n,this.duration);this.playState=r.state.playState,"running"!==this.playState&&this.target&&delete this.target[Ap],"idle"===this.playState?this.startTime>i&&setTimeout(this._run.bind(this),this.startTime-i):"running"===this.playState?this._framer((function(){"running"===t.playState&&(t.currentTime=n,e&&e(r),t._run())})):"finished"===this.playState&&(this.finished=!0,e&&e(r))}else if(this.target&&delete this.target[Ap],e){"finished"===this.playState?n=this.duration:"idle"===this.playState&&(n=0);var s=this._animation(n,this.duration);s.state.playState=this.playState,e(s)}}});var Dp=Object.freeze({Animation:Op,Easing:Ep,Player:Rp,Frame:Lp}),Ip=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.animateShow=function(t,e){var i=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.finish(),Qa(t)&&(e=t={});var n=this.getCoordinates();if(0===n.length)return this;this._animIdx=0,this._animLenSoFar=0,this.show();var r=!!this.getShell?this.getShell().concat(this.getShell()[0]):n,s=this._getProjection(),o=s.projectCoords(r,this.options.antiMeridian);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=s.unproject(this._prjAniShowCenter);var a=t.duration||1e3,h=t.easing||"out";this.setCoordinates([]);var l=0;o.length&&(o[0]._distance=0);for(var c=1;c<o.length;c++){var u=o[c].distanceTo(o[c-1]);o[c]._distance=u,l+=u}this._tempCoord=new Gu(0,0),this._tempPrjCoord=new Gh(0,0);var d=this._showPlayer=Op.animate({t:a},{duration:a,easing:h},(function(t){if(i.getMap()){var s=i._drawAnimShowFrame(t.styles.t,a,l,r,o);"finished"===t.state.playState&&(delete i._showPlayer,delete i._aniShowCenter,delete i._prjAniShowCenter,delete i._animIdx,delete i._animLenSoFar,delete i._animTailRatio,delete i._tempCoord,delete i._tempPrjCoord,i.setCoordinates(n)),e&&e(t,s)}else if("finished"!==d.playState&&(d.finish(),e)){var h=i.getCoordinates();e(t,h[h.length-1])}}),this);return d.play(),d},i._drawAnimShowFrame=function(t,e,i,n,r){if(0===t)return n[0];var s,o,a=t/e*i,h=0;for(s=this._animIdx+1,o=r.length;s<o&&(h=r[s]._distance,!(this._animLenSoFar+h>a));s++)this._animLenSoFar+=h;if(this._animIdx=s-1,this._animIdx>=o-1)return this.setCoordinates(n),n[n.length-1];var l=this._animIdx,c=r[l],u=r[l+1],d=(a-this._animLenSoFar)/h;this._animTailRatio=d;var f=c.x+(u.x-c.x)*d,p=c.y+(u.y-c.y)*d;this._tempPrjCoord.x=f,this._tempPrjCoord.y=p;var g=this._tempPrjCoord,m=n[l],_=n[l+1],v=m.x+(_.x-m.x)*d,y=m.y+(_.y-m.y)*d;this._tempCoord.x=v,this._tempCoord.y=y;var x=this._tempCoord,w=!!this.getShell;if(!w&&this.options.smoothness>0){for(var b=[],M=[],S=0;S<=this._animIdx;S++)b.push(n[S]),M.push(r[S]);b.push(x,x),M.push(g,g),this.setCoordinates(b),this._setPrjCoordinates(M)}else{var C=n.slice(0,this._animIdx+1);C.push(x);var T=r.slice(0,this._animIdx+1);T.push(g),w?(this.setCoordinates([this._aniShowCenter].concat(C)),this._setPrjCoordinates([this._prjAniShowCenter].concat(T))):(this.setCoordinates(C),this._setPrjCoordinates(T))}return x},i._getCenterInExtent=function(t,e,i){var n=this.getExtent();if(!t.intersects(n))return null;var r=i(e,t);if(0===r.length)return null;var s=0,o=0,a=0;r.forEach((function(t){Array.isArray(t)?t.forEach((function(t){t.point&&(t=t.point),s+=t.x,o+=t.y,a++})):(t.point&&(t=t.point),s+=t.x,o+=t.y,a++)}));var h=new Gu(s,o)._multi(1/a);return h.count=a,h},i._getPath2DPoints=function(t,e,i){if(!rl(t))return[];var n=this.getMap(),r=!e&&this._shouldSimplify(),s=this.options.simplifyTolerance*n._getResolution(),o=Array.isArray(t[0]);if(delete this._simplified,r&&!o){var a=t.length;t=Ea(t,s,!1),this._simplified=t.length<a}if(i||(i=n._getResolution()),Array.isArray(t)){var h=[],l="_glPt";if(!Array.isArray(t[0]))return h=vl(t,l),n._prjsToPointsAtRes(t,i,h);for(var c=[],u=0,d=t.length;u<d;u++){var f=t[u];h=vl(f,l);var p=n._prjsToPointsAtRes(f,i,h);c.push(p)}return c}return n._prjToPointAtRes(t,i)},i._shouldSimplify=function(){var t=this.getLayer(),e=this.getProperties(),i=e&&t.options.enableAltitude&&!Za(e[t.options.altitudeProperty])&&0!==e[t.options.altitudeProperty];return t&&t.options.enableSimplify&&!i&&this.options.enableSimplify&&!this._showPlayer},i._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},i._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},i._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},i._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},i._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t,this.options.antiMeridian):[]},i._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},i._computeCenter=function(){var t=this._coordinates;if(!rl(t))return null;for(var e=0,i=0,n=0,r=t.length,s=0;s<r;s++)t[s]&&qa(t[s].x)&&qa(t[s].y)&&(e+=t[s].x,i+=t[s].y,n++);return new Gu(e/n,i/n)},i._computeExtent=function(){var t=this._coordinates;if(!rl(t))return null;var e=[t];return this.hasHoles&&this.hasHoles()&&e.push.apply(e,this.getHoles()),this._coords2Extent(e,this._getProjection())},i._computePrjExtent=function(){var t=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&t.push.apply(t,this._getPrjHoles()),this._coords2Extent(t)},i._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,i=1,n=t.length;i<n;i++)e+=t[i].distanceTo(t[i-1]);return e},i._hitTestTolerance=function(){var e,i=this._getInternalSymbol();if(Array.isArray(i)){e=0;for(var n=0;n<i.length;n++)qa(i[n].lineWidth)&&i[n].lineWidth>e&&(e=i[n].lineWidth)}else e=i.lineWidth;return t.prototype._hitTestTolerance.call(this)+(qa(e)?e/2:1.5)},i._coords2Extent=function(t,e){if(!t||0===t.length||Array.isArray(t[0])&&0===t[0].length)return null;for(var i=new id(e),n=0,r=t.length;n<r;n++)for(var s=0,o=t[n].length;s<o;s++)i._combine(t[n][s]);return i},e}(op);Ip.mergeOptions({smoothness:0,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var kp="Polygon",zp=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="Polygon",e&&n.setCoordinates(e),n}Nh(e,t);var i=e.prototype;return i.getOutline=function(){return this._getPainter()?new e(this.getExtent().toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}}):null},i.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=Gu.toCoordinates(t),i=e.length;if(Array.isArray(e[0])){if(this._coordinates=this._trimRing(e[0]),i>1){for(var n=[],r=1;r<i;r++)e[r]&&n.push(this._trimRing(e[r]));this._holes=n}}else this._coordinates=this._trimRing(e);return this._projectRings(),this},i.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],i=0,n=t.length;i<n;i++)e.push(this._copyAndCloseRing(t[i]));return e},i.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),mf)},i.getShell=function(){return this._coordinates||[]},i.getHoles=function(){return this._holes||[]},i.hasHoles=function(){return this.getHoles().length>0},i._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},i._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},i._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},i._checkRing=function(t){if(this._cleanRing(t),!t||!rl(t))return!1;var e=t[t.length-1],i=!0;return t[0].x===e.x&&t[0].y===e.y||(i=!1),i},i._trimRing=function(t){var e=this._checkRing(t);return rl(t)&&e&&t.splice(t.length-1,1),t},i._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return rl(t)&&!e?(t.push(t[0].copy()),t):t},i._getPrjShell=function(){return this.getJSONType()===kp?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this.getShell())),this._prjShell)},i._getPrjHoles=function(){var t=this._getProjection();return this._verifyProjection(),t&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},i._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!rl(e))return 0;for(var i=0,n=0,r=e.length;n<r;n++)i+=t.measureLength(e[n]);return i},i._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!rl(e))return 0;for(var i=t.measureArea(e[0]),n=1,r=e.length;n<r;n++)i-=t.measureArea(e[n]);return i},i._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},i._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},i._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(Ip);function Np(t){return function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.getCoordinates=function(){return this._coordinates},i.setCoordinates=function(t){var e=t instanceof Gu?t:new Gu(t);if(e.equals(this._coordinates))return this;if(this._coordinates=e,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var i=this._getProjection();return this._setPrjCoordinates(i.project(this._coordinates)),this},i._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var i=this._getPrjCoordinates();return i?(t||(t=e._getResolution()),e._prjToPointAtRes(i,t)):null},i._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pcenter&&t&&this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter},i._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},i._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},i._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},i._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)}zp.registerJSONType(kp);var Fp=new nd,jp=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="Point",e&&n.setCoordinates(e),n}Nh(e,t);var i=e.prototype;return i.getOutline=function(){var t=this.getCoordinates(),i=this.getContainerExtent(),n=this.getMap().coordToContainerPoint(t);return new e(t,{symbol:{markerType:"square",markerWidth:i.getWidth(),markerHeight:i.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:i.xmin-(n.x-i.getWidth()/2),markerDy:i.ymin-(n.y-i.getHeight()/2)}})},i.setSymbol=function(){var e;delete this._fixedExtent;for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.prototype.setSymbol).call.apply(e,[this].concat(n))},i._getSizeSymbol=function(t){for(var e,i={},n=!1,r=!1,s=0;s<df.length;s++){var o=t[df[s]];Za(o)||(!n&&Nl(o)&&(n=!0,r=!0),i[df[s]]=o)}for(var a=0;a<ff.length;a++){var h=t[ff[a]];Za(h)||(!n&&Nl(h)&&(n=!0),i[ff[a]]=h)}return n?(e=rc(i,this),r&&(e._dynamic=!0)):e=i,e},i._setExternSymbol=function(e){return this._symbol||delete this._fixedExtent,t.prototype._setExternSymbol.call(this,e)},i._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},i._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new nd,this._fixedExtent.set(null,null,null,null);var t=this._sizeSymbol;if(!t)return this._fixedExtent;var e=this.getLayer()&&this.getLayer().getRenderer(),i=e&&e.resources,n=this.getTextDesc();if(Array.isArray(t)){Fp.set(1/0,1/0,-1/0,-1/0);for(var r=0;r<t.length;r++)t[r]&&this._fixedExtent._combine(of(Fp,t[r],i,n&&n[r]))}else this._fixedExtent=of(this._fixedExtent,t,i,n);return this._fixedExtent},i._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&lf(t)},i._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(lf(t)||cf(t)||hf(t))},i._containsPoint=function(e,i){var n=this.getContainerExtent();return i&&(n=n.expand(i)),!!n.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,i))},i._computeExtent=function(){return Bp.call(this,"getCenter")},i._computePrjExtent=function(){return Bp.call(this,"_getPrjCoordinates")},i._computeGeodesicLength=function(){return 0},i._computeGeodesicArea=function(){return 0},i._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new Kf(this).getSprite(t,e)},e}(Np(op));function Bp(t){var e=this[t]();return e?new id(e,e,this._getProjection()):null}jp.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1}),jp.registerJSONType("Marker");var Up=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="LineString",e&&n.setCoordinates(e),n}Nh(e,t);var i=e.prototype;return i.getOutline=function(){return zp.prototype.getOutline.call(this)},i.setCoordinates=function(t){return t?(this._coordinates=Gu.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},i.getCoordinates=function(){return this._coordinates||[]},i.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),pf)},i._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},i._computeGeodesicArea=function(){return 0},e}(Ip);Up.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),Up.registerJSONType("LineString");var Gp=new nd,Hp=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="GeometryCollection",n.setGeometries(e),n}Nh(e,t);var i=e.prototype;return i.getContainerExtent=function(t){var e=t||new nd;return this.forEach((function(t){e._combine(t.getContainerExtent(Gp))})),e},i.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),i=this._getSymbol(),n=this.config(),r=e.length-1;r>=0;r--)e[r]._initOptions(n),e[r]._setParent(this),e[r]._setEventParent(this),i&&e[r].setSymbol(i);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},i.getGeometries=function(){return this._geometries||[]},i.forEach=function(t,e){for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)i[n]&&(e?t.call(e,i[n],n):t(i[n],n));return this},i.filter=function(t,i){if(!t)return new e;var n=[],r=Qa(t),s=r?t:Vl(t);return this.forEach((function(t){var e=r?t:$l(t);(i?s.call(i,e):s(e))&&n.push(t)}),this),new e(n)},i.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach((function(t){t&&t.translate&&t.translate.apply(t,e)})),this},i.isEmpty=function(){return!rl(this.getGeometries())},i.remove=function(){return this.forEach((function(t){t._unbind()})),op.prototype.remove.apply(this,arguments)},i.show=function(){return this.options.visible=!0,this.forEach((function(t){t.show()})),this},i.hide=function(){return this.options.visible=!1,this.forEach((function(t){t.hide()})),this},i.onConfig=function(t){this.forEach((function(e){e.config(t)}))},i.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var i=[],n=!1;this.forEach((function(t){t.getSymbol()&&!n&&(n=!0),i.push(t.getSymbol())})),n&&(e={children:i})}return e},i.setSymbol=function(t){if(t&&t.children)this._symbol=null,this.forEach((function(e,i){e.setSymbol(t.children[i])}));else{var e=this._prepareSymbol(t);this._symbol=e,this.forEach((function(t){t.setSymbol(e)}))}return this.onSymbolChanged(),this},i._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach((function(e){e._setExternSymbol(t)})),this.onSymbolChanged(),this},i._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},i._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach((function(e){e._bindLayer(t)}))},i._checkGeometries=function(t){var e="The geometry added to collection is invalid.";if(t&&!Array.isArray(t)){if(t instanceof op)return[t];throw new Error(e)}for(var i=0,n=t.length;i<n;i++)if(!this._checkGeo(t[i]))throw new Error(e+" Index: "+i);return t},i._checkGeo=function(t){return t instanceof op},i._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach((function(t){t&&t._updateCache&&t._updateCache()}))},i._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach((function(t){t._removePainter()}))},i._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,i=0,n=0,r=this.getGeometries(),s=0,o=r.length;s<o;s++)if(r[s]){var a=r[s]._computeCenter(t);a&&(e+=a.x,i+=a.y,n++)}return 0===n?null:new Gu(e/n,i/n)},i._containsPoint=function(t,e){if(this.isEmpty())return!1;delete this._pickGeometryIndex;for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)if(i[n]._containsPoint(t,e))return this._pickGeometryIndex=n,!0;return!1},i._computeExtent=function(t){return Vp.call(this,t,"_computeExtent")},i._computePrjExtent=function(t){return Vp.call(this,t,"_computePrjExtent")},i._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;n<r;n++)e[n]&&(i+=e[n]._computeGeodesicLength(t));return i},i._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;n<r;n++)e[n]&&(i+=e[n]._computeGeodesicArea(t));return i},i._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),i=0,n=e.length;i<n;i++)e[i]&&t.push(e[i]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},i._toJSON=function(t){var e,i={type:"Feature",geometry:{type:"GeometryCollection",geometries:this.getGeometries().filter((function(t){return t&&t._toJSON})).map((function(t){var e=t._toJSON();return e.subType?e:t._exportGeoJSONGeometry()}))}},n=this.getId();return Za(n)||(i.id=n),(Za(t.properties)||t.properties)&&(e=this._exportProperties()),i.properties=e,t.feature=i,t},i._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e]&&t[e]._clearProjection()},i._getConnectPoints=function(){var t=this.getExtent();return[new Gu(t.xmin,t.ymax),new Gu(t.xmax,t.ymin),new Gu(t.xmin,t.ymin),new Gu(t.xmax,t.ymax)]},i._getExternalResources=function(){if(this.isEmpty())return[];for(var t,e,i=this.getGeometries(),n=[],r={},s=0,o=i.length;s<o;s++)if(i[s])for(var a=0,h=(t=ac(i[s]._getInternalSymbol())).length;a<h;a++)r[e=t[a].join()]||(n.push(t[a]),r[e]=1);return n},i.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)i[n].startEdit(t);return this._editing=!0,this.hide(),setTimeout((function(){e.fire("editstart")}),1),this},i.endEdit=function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},i.isEditing=function(){return!!this._editing},e}(op);function Vp(t,e){if(this.isEmpty())return null;for(var i=new id,n=this.getGeometries(),r=0,s=n.length;r<s;r++)if(n[r]){var o=n[r][e](t);o&&i._combine(o)}return i}Hp.registerJSONType("GeometryCollection");var Wp=function(t){function e(e,i,n,r){var s;return(s=t.call(this,null,r)||this).GeometryType=e,s.type=i,s._initData(n),s}Nh(e,t);var i=e.prototype;return i.getCoordinates=function(){for(var t=[],e=this.getGeometries(),i=0,n=e.length;i<n;i++){var r=e[i];t.push(r.getShell&&"Polygon"!==r.getJSONType()?[r.getShell()]:r.getCoordinates())}return t},i.setCoordinates=function(t){for(var e=[],i=0,n=(t=t||[]).length;i<n;i++){var r=new this.GeometryType(t[i],this.config());e.push(r)}return this.setGeometries(e),this},i._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},i._checkGeo=function(t){return t instanceof this.GeometryType},i._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=Gu.toNumberArrays(t);return{type:this.getType(),coordinates:e}},i._toJSON=function(t){return{feature:this.toGeoJSON(t)}},e}(Hp),Zp=function(t){function e(e,i){return t.call(this,jp,"MultiPoint",e,i)||this}return Nh(e,t),e.prototype.findClosest=function(t){if(!t)return null;var e=this.getCoordinates(),i=null,n=1/0;return e.forEach((function(e){var r,s,o,a,h=(r=e,o=(s=t).x-r.x,a=s.y-r.y,Math.sqrt(o*o+a*a));h<n&&(i=e,n=h)})),i},e}(Wp);Zp.registerJSONType("MultiPoint");var qp=function(t){function e(){return t.apply(this,arguments)||this}return Nh(e,t),e.prototype.getCenterInExtent=function(t){var e=this.getGeometries(),i=0,n=0,r=0;return e.forEach((function(e){var s=e.getCenterInExtent(t);s&&(i+=s.x*s.count,n+=s.y*s.count,r+=s.count)})),0===r?null:new Gu(i,n)._multi(1/r)},e}(Wp),Xp=function(t){function e(e,i){return t.call(this,Up,"MultiLineString",e,i)||this}return Nh(e,t),e}(qp);Xp.registerJSONType("MultiLineString");var Jp=function(t){function e(e,i){return t.call(this,zp,"MultiPolygon",e,i)||this}return Nh(e,t),e}(qp);Jp.registerJSONType("MultiPolygon");var Yp={Marker:jp,LineString:Up,Polygon:zp,MultiPoint:Zp,MultiLineString:Xp,MultiPolygon:Jp},Qp={toGeometry:function(t,e){if(Ya(t)&&(t=Xh(t)),Array.isArray(t)){for(var i=[],n=0,r=t.length;n<r;n++){var s=Qp._convert(t[n],e);Array.isArray(s)?Jh(i,s):i.push(s)}return i}return Qp._convert(t,e)},_convert:function(t,e){if(!t||Za(t.type))return null;var i=t.type;if("Feature"===i){var n=t.geometry,r=Qp._convert(n);return r?(r.setId(t.id),r.setProperties(t.properties),e&&e(r),r):null}if("FeatureCollection"===i){var s=t.features;return s?Qp.toGeometry(s,e):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(i)>=0){var o=new Yp["Point"===i?"Marker":i](t.coordinates);return e&&e(o),o}if("GeometryCollection"===i){var a=t.geometries;if(!rl(a)){var h=new Hp;return e&&e(h),h}for(var l=[],c=a.length,u=0;u<c;u++)a[u].subType?l.push(op.getJSONClass(a[u].subType).fromJSON(a[u])):l.push(Qp._convert(a[u]));var d=new Hp(l);return e&&e(d),d}return null}},Kp=function(t){function e(e,i,n){var r;return r=t.call(this,null,n)||this,e&&r.setCoordinates(e),r._radius=i,r}Nh(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.radius,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getRadius=function(){return this._radius},i.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,n=this._getMeasurer(),r=this.getCoordinates(),s=this.options.numberOfShellPoints,o=this.getRadius(),a=[],h=0,l=s-1;h<l;h++){t=360*h/l*Math.PI/180,e=o*Math.cos(t),i=o*Math.sin(t);var c=n.locate(r,e,i);a.push(c)}return a.push(a[0]),a},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._containsPoint=function(e,i){var n=this.getMap();if(n.getPitch())return t.prototype._containsPoint.call(this,e,i);var r=n._pointToContainerPoint(this._getCenter2DPoint()),s=this.getSize(),o=Za(i)?this._hitTestTolerance():i,a=r.add(s.width/2,s.height/2);return yf(e,r,a,o)},i._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var i=this._getPrjCoordinates(),n=e.map((function(e){return t.project(e)})),r=n[0].x-i.x,s=n[1].x-i.x,o=n[2].y-i.y,a=n[3].y-i.y;return new id(i.add(r,o),i.add(s,a))},i._computeExtent=function(t){var e=this._getMinMax(t);return e?new id(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},i._getMinMax=function(t){if(!t||!this._coordinates||Za(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},i._computeGeodesicLength=function(){return Za(this._radius)?0:2*Math.PI*this._radius},i._computeGeodesicArea=function(){return Za(this._radius)?0:Math.PI*Math.pow(this._radius,2)},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:Gu.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=this.getCenter(),i=Wa({},t);i.geometry=!1;var n=this.toGeoJSON(i);return n.geometry={type:"Polygon"},{feature:n,subType:"Circle",coordinates:[e.x,e.y],radius:this.getRadius()}},e}(Np(zp));Kp.mergeOptions({numberOfShellPoints:60}),Kp.registerJSONType("Circle");var $p=function(t){function e(e,i,n,r){var s;return s=t.call(this,null,r)||this,e&&s.setCoordinates(e),s.width=i,s.height=n,s}Nh(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getWidth=function(){return this.width},i.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},i.getHeight=function(){return this.height},i.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,n,r=this._getMeasurer(),s=this.getCoordinates(),o=this.options.numberOfShellPoints,a=this.getWidth(),h=this.getHeight(),l=[],c=Math.pow(a/2,2)*Math.pow(h/2,2),u=Math.pow(a/2,2),d=Math.pow(h/2,2),f=0;f<o;f++){e=(t=360*f/o)*Math.PI/180,i=Math.sqrt(c/(u*Math.pow(Math.tan(e),2)+d)),n=Math.sqrt(c/(d*Math.pow(1/Math.tan(e),2)+u)),t>90&&t<270&&(i*=-1),t>180&&t<360&&(n*=-1);var p=r.locate(s,i,n);l.push(p)}return l},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._containsPoint=function(e,i){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,i);var r=n.getProjection(),s=Za(i)?this._hitTestTolerance():i,o=r.projectCoords([this._coordinates,n.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)],this.options.antiMeridian);return yf(e,n._prjToContainerPoint(o[0]),n._prjToContainerPoint(o[1]),s)},i._computePrjExtent=function(){return Kp.prototype._computePrjExtent.apply(this,arguments)},i._computeExtent=function(){return Kp.prototype._computeExtent.apply(this,arguments)},i._getMinMax=function(t){if(!t||!this._coordinates||Za(this.width)||Za(this.height))return null;var e=this.getWidth(),i=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-i/2),t.locate(this._coordinates,0,i/2)]},i._computeGeodesicLength=function(){if(Za(this.width)||Za(this.height))return 0;var t=this.width>this.height?this.width:this.height;return 2*Math.PI*t/2-4*Math.abs(this.width-this.height)},i._computeGeodesicArea=function(){return Za(this.width)||Za(this.height)?0:Math.PI*this.width*this.height/4},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:Gu.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=Wa({},t),i=this.getCenter();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Ellipse",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},e}(Np(zp));$p.mergeOptions({numberOfShellPoints:80}),$p.registerJSONType("Ellipse");var tg=function(t){function e(e,i,n,r){var s;return s=t.call(this,null,r)||this,e&&s.setCoordinates(e),s._width=i,s._height=n,s}Nh(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getCoordinates=function(){return this._coordinates},i.setCoordinates=function(t){if(this._coordinates=t instanceof Gu?t:new Gu(t),!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var e=this._getProjection();return this._setPrjCoordinates(e.project(this._coordinates)),this},i.getWidth=function(){return this._width},i.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},i.getHeight=function(){return this._height},i.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},i.getShell=function(){var t=this._getMeasurer(),e=this._coordinates,i=this.getMap(),n=1,r=-1;if(i){var s=i.getFullExtent();s.left>s.right&&(n=-1),s.bottom>s.top&&(r=1)}var o=[];return o.push(e),o.push(t.locate(e,n*this._width,0)),o.push(t.locate(e,n*this._width,r*this._height)),o.push(t.locate(e,0,r*this._height)),o.push(e),o},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pnw&&t&&this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw},i._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},i._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),i=this._getProjection();if(!i.isSphere())return e;for(var n=i.getSphereExtent(),r=n.sx,s=n.sy,o=this._getProjection().getCircum(),a=e[0],h=1,l=e.length;h<l;h++){var c=e[h],u=0,d=0;r*(a.x-c.x)>0&&(u=o.x*r),s*(a.y-c.y)<0&&(d=o.y*s),e[h]._add(u,d)}return e},i._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},i._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},i._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},i._containsPoint=function(e,i){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,i);var r=Za(i)?this._hitTestTolerance():i,s=n._getResolution()*r,o=this._getPrjExtent().expand(s),a=n._containerPointToPrj(e);return o.contains(a)},i._computePrjExtent=function(t){var e=this._getSouthEast(t);if(!e)return null;var i=t.projectCoords([new Gu(this._coordinates.x,e.y),new Gu(e.x,this._coordinates.y)],this.options.antiMeridian);return new id(i[0],i[1])},i._computeExtent=function(t){var e=this._getSouthEast(t);return e?new id(this._coordinates,e,this._getProjection()):null},i._getSouthEast=function(t){if(!t||!this._coordinates||Za(this._width)||Za(this._height))return null;var e=this.getWidth(),i=-this.getHeight();if(t.fullExtent){var n=t.fullExtent;e*=n.right>n.left?1:-1,i*=n.top>n.bottom?1:-1}var r=t.locate(this._coordinates,e,0),s=t.locate(this._coordinates,0,i);return r.y=s.y,r},i._computeGeodesicLength=function(){return Za(this._width)||Za(this._height)?0:2*(this._width+this._height)},i._computeGeodesicArea=function(){return Za(this._width)||Za(this._height)?0:this._width*this._height},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:Gu.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=Wa({},t),i=this.getCoordinates();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Rectangle",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},e}(zp);tg.registerJSONType("Rectangle");var eg=function(t){function e(e,i,n,r,s){var o;return(o=t.call(this,e,i,s)||this).startAngle=n,o.endAngle=r,o}Nh(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getStartAngle=function(){return this.startAngle},i.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},i.getEndAngle=function(){return this.endAngle},i.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,n=this._getMeasurer(),r=this.getCoordinates(),s=this.options.numberOfShellPoints-2,o=this.getRadius(),a=[r.copy()],h=this.getStartAngle(),l=this.getEndAngle()-h,c=0;c<s;c++){t=(l*c/(s-1)+h)*Math.PI/180,e=o*Math.cos(t),i=o*Math.sin(t);var u=n.locate(r,e,i);a.push(u)}return a.push(r.copy()),a},i._containsPoint=function(e,i){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,i);var r=n._pointToContainerPoint(this._getCenter2DPoint()),s=Za(i)?this._hitTestTolerance():i,o=this.getSize(),a=r,h=e,l=h.x-a.x,c=a.y-h.y,u=Math.atan2(c,l),d=u<0?360*(u+2*Math.PI)/(2*Math.PI):360*u/(2*Math.PI),f=this.startAngle%360,p=this.endAngle%360,g=!1;return g=f>p?!(d>p&&d<f):d>=f&&d<=p,h.distanceTo(a)<=o.width/2+s&&g},i._computeGeodesicLength=function(){return Za(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},i._computeGeodesicArea=function(){return Za(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},i._toJSON=function(t){var e=Wa({},t),i=this.getCenter();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Sector",coordinates:[i.x,i.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(Kp);eg.mergeOptions({numberOfShellPoints:60}),eg.registerJSONType("Sector");var ig=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i._arc=function(t,e,i){for(var n=this.options.arcDegree*Math.PI/180,r=1,s=e.length;r<s;r++){var o=Mu._arcBetween(t,e[r-1],e[r],n),a=[e[r-1].x+e[r].x-o[0],e[r-1].y+e[r].y-o[1]];e[r-1].nextCtrlPoint=a,e[r].prevCtrlPoint=a,Mu._stroke(t,i)}},i._quadraticCurve=function(t,e){if(e.length<=2)Mu._path(t,e);else{var i,n;for(i=2,n=e.length;i<n;i+=2)t.quadraticCurveTo(e[i-1].x,e[i-1].y,e[i].x,e[i].y);if((i-=1)<n)for(;i<n;i++)t.lineTo(e[i].x,e[i].y)}},i._bezierCurve=function(t,e){if(e.length<=3)Mu._path(t,e);else{var i,n;for(i=1,n=e.length;i+2<n;i+=3)t.bezierCurveTo(e[i].x,e[i].y,e[i+1].x,e[i+1].y,e[i+2].x,e[i+2].y);if(i<n)for(;i<n;i++)t.lineTo(e[i].x,e[i].y)}},i._getCurveArrowPoints=function(t,e,i,n,r,s){var o,a=e.length;for(o=s;o<a;o+=s){var h=this._getArrowShape(e[o-1],e[o],i,n,r);h&&t.push(h)}if((o-=s)<a-1)for(o+=1;o<a;o++){var l=this._getArrowShape(e[o-1],e[o],i,n,r);l&&t.push(l)}},e}(Up);ig.mergeOptions({enableSimplify:!1,enableClip:!1});var ng=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},i._paintOn=function(t,e,i){t.beginPath(),this._arc(t,e,i),Mu._stroke(t,i),this._paintArrow(t,e,i)},e.fromJSON=function(t){var i=t.feature,n=new e(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n},e}(ig);ng.registerJSONType("ArcCurve"),ng.mergeOptions({arcDegree:90});var rg=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},i._paintOn=function(t,e,i){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),Mu._stroke(t,i),this._paintArrow(t,e,i)},i._getArrowPoints=function(t,e,i,n,r){return this._getCurveArrowPoints(t,e,i,n,r,3)},e}(ig);rg.registerJSONType("CubicBezierCurve");var sg=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},i._paintOn=function(t,e,i){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,i),Mu._stroke(t,i),this._paintArrow(t,e,i)},i._getArrowPoints=function(t,e,i,n,r){return this._getCurveArrowPoints(t,e,i,n,r,2)},e}(ig);sg.registerJSONType("QuadBezierCurve");var og={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},ag={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},hg=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.getContent=function(){return this._content},i.setContent=function(t){var e=this._content;return this._content=fc(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},i.onAdd=function(){this._refresh()},i.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},i.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var i=this._parseSymbol(e);if(this.setTextStyle){var n=this.getTextStyle()||{};n.symbol=i[0],this.setTextStyle(n)}else this.setTextSymbol&&this.setTextSymbol(i[0]);if(this.setBoxStyle){var r=this.getBoxStyle()||{};r.symbol=i[1],this.setBoxStyle(r)}else this.setBoxSymbol&&this.setBoxSymbol(i[1]);return this},i._parseSymbol=function(t){var e={},i={};for(var n in t)$a(t,n)&&(0===n.indexOf("text")?e[n]=t[n]:i[n]=t[n]);return[e,i]},i._getTextSize=function(t){return Sc(this._content,t).size},i._getInternalSymbol=function(){return this._symbol},i._getDefaultTextSymbol=function(){return Wa({},og)},i._getDefaultBoxSymbol=function(){return Wa({},ag)},i._getDefaultPadding=function(){return[12,8]},e}(jp),lg=function(t){function e(e,i,n,r,s){var o;return void 0===s&&(s={}),(o=t.call(this,i,s)||this)._content=fc(e),o._width=Za(n)?100:n,o._height=Za(r)?40:r,s.boxSymbol&&o.setBoxSymbol(s.boxSymbol),s.textStyle&&o.setTextStyle(s.textStyle),o._refresh(),o}Nh(e,t);var i=e.prototype;return i.getWidth=function(){return this._width},i.setWidth=function(t){return this._width=t,this._refresh(),this},i.getHeight=function(){return this._height},i.setHeight=function(t){return this._height=t,this._refresh(),this},i.getBoxSymbol=function(){return Wa({},this.options.boxSymbol)},i.setBoxSymbol=function(t){return this.options.boxSymbol=t?Wa({},t):t,this.getSymbol()&&this._refresh(),this},i.getTextStyle=function(){return this.options.textStyle?Wa({},this.options.textStyle):null},i.setTextStyle=function(t){return this.options.textStyle=t?Wa({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var i=t.feature,n=new e(t.content,i.geometry.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n.setId(i.id),t.symbol&&n.setSymbol(t.symbol),n},i._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},i._refresh=function(){var t,e,i=this.getTextStyle()||{},n=i.padding||[12,8];if(Nl(this._width)){var r=(t=JSON.parse(JSON.stringify(this._width))).stops;if(r)for(var s=0;s<r.length;s++)r[s][1]=r[s][1]-2*n[0]}else t=this._width-2*n[0];if(Nl(this._height)){var o=(e=JSON.parse(JSON.stringify(this._height))).stops;if(o)for(var a=0;a<o.length;a++)o[a][1]=o[a][1]-2*n[1]}else e=this._height-2*n[1];var h=Wa({},i.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:t,textMaxHeight:e});i.wrap&&!h.textWrapWidth&&(h.textWrapWidth=t);var l,c=i.horizontalAlignment;if(h.textDx=h.markerDx||0,Nl(this._width)){var u=(l=JSON.parse(JSON.stringify(this._width))).stops;if(u)for(var d=0;d<u.length;d++)u[d][1]=u[d][1]/2-n[0],"left"===c&&(u[d][1]*=-1)}else l=h.markerWidth/2-n[0],"left"===c&&(l*=-1);"left"===c?(h.textHorizontalAlignment="right",h.textDx=l):"right"===c&&(h.textHorizontalAlignment="left",h.textDx=l);var f,p=i.verticalAlignment;if(h.textDy=h.markerDy||0,Nl(this._height)){var g=(f=JSON.parse(JSON.stringify(this._height))).stops;if(g)for(var m=0;m<g.length;m++)g[m][1]=g[m][1]/2-n[1],"top"===p&&(g[m][1]*=-1)}else f=h.markerHeight/2-n[1],"top"===p&&(f*=-1);"top"===p?(h.textVerticalAlignment="bottom",h.textDy=f):"bottom"===p&&(h.textVerticalAlignment="top",h.textDy=f),this._refreshing=!0,this.updateSymbol(h),delete this._refreshing},i.startEdit=function(e){var i=this._getCompiledSymbol();if(Nl(this._width)){var n=i.markerWidth;this._oldWidth=this._width,this.setWidth(n)}if(Nl(this._height)){var r=i.markerHeight;this._oldHeight=this._height,this.setHeight(r)}t.prototype.startEdit.call(this,e)},i.endEdit=function(){var e=this.getMap(),i=e&&e.getZoom();if(this._oldWidth){for(var n=this._width/jl(this._oldWidth)(i),r=this._oldWidth.stops,s=0;s<r.length;s++)r[s][1]*=n;this.setWidth(this._oldWidth),delete this._oldWidth}if(this._oldHeight){for(var o=this._height/jl(this._oldHeight)(i),a=this._oldHeight.stops,h=0;h<a.length;h++)a[h][1]*=o;this.setHeight(this._oldHeight),delete this._oldHeight}t.prototype.endEdit.call(this)},e}(hg);lg.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),lg.registerJSONType("TextBox");var cg=function(t){function e(e,i,n){var r;return void 0===n&&(n={}),r=t.call(this,i,n)||this,n.textSymbol&&r.setTextSymbol(n.textSymbol),n.boxStyle&&r.setBoxStyle(n.boxStyle),r._content=fc(e),r._refresh(),r}Nh(e,t);var i=e.prototype;return i.getBoxStyle=function(){return this.options.boxStyle?Wa({},this.options.boxStyle):null},i.setBoxStyle=function(t){return this.options.boxStyle=t?Wa({},t):t,this._refresh(),this},i.getTextSymbol=function(){return Wa({},this._getDefaultTextSymbol(),this.options.textSymbol)},i.setTextSymbol=function(t){return this.options.textSymbol=t?Wa({},t):t,this._refresh(),this},e.fromJSON=function(t){var i=t.feature,n=new e(t.content,i.geometry.coordinates,t.options);return n.setProperties(i.properties),n.setId(i.id),t.symbol&&n.setSymbol(t.symbol),n},i._canEdit=function(){return!1},i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},i._refresh=function(){var t=Wa({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){Wa(t,e.symbol);var i=this._getBoxSize(t),n=i[1],r=e.padding||this._getDefaultPadding(),s=i[0];t.markerWidth=s.width,t.markerHeight=s.height;var o=t.textDx||0,a=t.textDy||0,h=bc(n,t.textHorizontalAlignment,t.textVerticalAlignment)._add(o,a),l=e.horizontalAlignment||"middle";t.markerDx=h.x,"left"===l?t.markerDx+=t.markerWidth/2-r[0]:"right"===l?t.markerDx-=t.markerWidth/2-n.width-r[0]:t.markerDx+=n.width/2;var c=e.verticalAlignment||"middle";t.markerDy=h.y,"top"===c?t.markerDy+=t.markerHeight/2-r[1]:"bottom"===c?t.markerDy-=t.markerHeight/2-n.height-r[1]:t.markerDy+=n.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},i._getBoxSize=function(t){t.markerType||(t.markerType="square");var e,i,n=this.getBoxStyle(),r=this._getTextSize(t),s=n.padding||this._getDefaultPadding();return e=r.width+2*s[0],i=r.height+2*s[1],n.minWidth&&(!e||e<n.minWidth)&&(e=n.minWidth),n.minHeight&&(!i||i<n.minHeight)&&(i=n.minHeight),[new cc(e,i),r]},e}(hg);cg.mergeOptions({boxStyle:null,textSymbol:null}),cg.registerJSONType("Label");var ug=function(t){return function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t),e._hasConnectors=function(t){return!Za(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors};var i=e.prototype;return i.getConnectSource=function(){return this._connSource},i.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},i.getConnectTarget=function(){return this._connTarget},i.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},i._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e,i,n=this._connSource._getConnectPoints(),r=this._connTarget._getConnectPoints(),s=0,o=this.getCoordinates(),a=0,h=n.length;a<h;a++)for(var l=n[a],c=0,u=r.length;c<u;c++){var d=r[c],f=t.computeLength(l,d);0===a&&0===c?(e=l,i=d,s=f):f<s&&(e=l,i=d)}rl(o)&&o[0].equals(e)&&o[1].equals(i)||this.setCoordinates([e,i])}},i.onAdd=function(){this._registerEvents(),this._updateCoordinates()},i.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&Yh(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(Yh(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof op&&this._connTarget instanceof op)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},i._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},i._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof op&&this._connTarget instanceof op)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},dg={showOn:"always"},fg=function(t){function e(e,i,n){var r;return r=t.call(this,null,n)||this,1===arguments.length&&(n=e,e=null,i=null),r._connSource=e,r._connTarget=i,r}return Nh(e,t),e}(ug(Up));fg.mergeOptions(dg),fg.registerJSONType("ConnectorLine");var pg=function(t){function e(e,i,n){var r;return r=t.call(this,null,n)||this,1===arguments.length&&(n=e,e=null,i=null),r._connSource=e,r._connTarget=i,r}return Nh(e,t),e}(ug(ng));pg.mergeOptions(dg),pg.registerJSONType("ArcConnectorLine");var gg=[],mg=function(t){function e(e,i,n){var r;i&&!(i instanceof op)&&!Array.isArray(i)&&ja.indexOf(i.type)<0&&(n=i,i=null),(r=t.call(this,e,n)||this)._maxZIndex=0,r._minZIndex=0,r._initCache(),i&&r.addGeometry(i);var s=r.options.style;return s&&r.setStyle(s),r}Nh(e,t);var i=e.prototype;return i.getGeometryById=function(t){return Za(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},i.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var i,n=[],r=0,s=this._geoList.length;r<s;r++)i=this._geoList[r],(e?t.call(e,i):t(i))&&n.push(i);return n},i.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},i.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},i.getCount=function(){return this._geoList.length},i.getExtent=function(){if(0===this.getCount())return null;var t=new id(this.getProjection());return this.forEach((function(e){t._combine(e.getExtent())})),t},i.forEach=function(t,e){for(var i=this._geoList.slice(0),n=0,r=i.length;n<r;n++)e?t.call(e,i[n],n):t(i[n],n);return this},i.filter=function(t,e){var i=[],n=Qa(t),r=n?t:Vl(t);return this.forEach((function(t){var s=n?t:$l(t);(e?r.call(e,s):r(s))&&i.push(t)}),this),i},i.isEmpty=function(){return!this._geoList.length},i.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(Qp.toGeometry(t),e);if(!Array.isArray(t)){var i=arguments.length,n=arguments[i-1];return t=Array.prototype.slice.call(arguments,0,i-1),e=n,n&&Ja(n)&&("type"in n||n instanceof op)&&(t.push(n),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;var r;this._initCache(),e&&(r=new id),this._toSort=this._maxZIndex>0;for(var s=[],o=0,a=t.length;o<a;o++){var h=t[o];if(!h)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+o);if(!(h instanceof op)&&(h=op.fromJSON(h),Array.isArray(h)))for(var l=0,c=h.length;l<c;l++)this._add(h[l],r,o),s.push(h[l]);Array.isArray(h)||(this._add(h,r,o),s.push(h))}var u=this.getMap();if(u&&(this._getRenderer().onGeometryAdd(s),r&&!Za(r.xmin))){var d=r.getCenter(),f=u.getFitZoom(r);if(Ja(e)){var p=Qa(e.step)?e.step:function(){};u.animateTo({center:d,zoom:f},Wa({duration:u.options.zoomAnimationDuration,easing:"out"},e),p)}else!0===e&&u.setCenterAndZoom(d,f)}return this.fire("addgeo",{geometries:t}),this},i.getGeoMinZIndex=function(){return this._minZIndex},i.getGeoMaxZIndex=function(){return this._maxZIndex},i._add=function(t,e,i){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var n=t.getId();if(!Za(n)){if(!Za(this._geoMap[n]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+n+", at index:"+i);this._geoMap[n]=t}var r=Zh();t._setInternalId(r),this._geoList.push(t),this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(t)},i.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof op||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this.fire("removegeo",{geometries:t}),this},i.clear=function(){this._clearing=!0,this.forEach((function(t){t.remove()})),this._geoMap={};var t=this._geoList;this._geoList=[];var e=this._getRenderer();return e&&(e.onGeometryRemove(t),e.clearImageData&&e.clearImageData()),this._clearing=!1,this.fire("clear"),this},i.onRemoveGeometry=function(t){if(t&&!this._clearing&&(this===t.getLayer()&&!Za(t._getInternalId()))){var e=t.getId();Za(e)||delete this._geoMap[e];var i=this._findInList(t);i>=0&&this._geoList.splice(i,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},i.getStyle=function(){return this.options.style?this.options.style:null},i.setStyle=function(t){return this.options.style=t,t=Rc(t),this._cookedStyles=tc(t),this.forEach((function(t){this._styleGeometry(t)}),this),this.fire("setstyle",{style:t}),this},i._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=$l(t),i=0,n=this._cookedStyles.length;i<n;i++)if(!0===this._cookedStyles[i].filter(e))return t._setExternSymbol(this._cookedStyles[i].symbol),!0;return!1},i.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach((function(t){t._setExternSymbol(null)}),this),this.fire("removestyle"),this):this},i.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},i.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return hp.prototype.hide.call(this)},i._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},i._updateZIndex=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._maxZIndex=Math.max(this._maxZIndex,Math.max.apply(Math,e)),this._minZIndex=Math.min(this._minZIndex,Math.min.apply(Math,e))},i._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort((function(e,i){return t._updateZIndex(e.getZIndex(),i.getZIndex()),t._compare(e,i)})),this._toSort=!1)},i._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},i._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;this._sortGeometries();for(var i,n=0,r=e-1;n<=r;){if(i=Math.floor((n+r)/2),this._geoList[i]===t)return i;this._compare(this._geoList[i],t)>0?r=i-1:n=i+1}return-1},i._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},i._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!Za(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}Za(t.old)||t.new===t.old||delete this._geoMap[t.old]}},i._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},i._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},i._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},i._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},i._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},i._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},i._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},i._hasGeoListeners=function(t){if(!t)return!1;Array.isArray(t)||(gg[0]=t,t=gg);for(var e=this.getGeometries()||[],i=0,n=e.length;i<n;i++)for(var r=0,s=t.length;r<s;r++){var o=t[r];if(e[i].listens(o)>0)return!0}return!1},e}(hp);mg.mergeOptions({drawImmediate:!1});var _g=new nd,vg={debug:!1,enableSimplify:!0,geometryEvents:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:zh.gecko,enableAltitude:!1,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0,clipBBoxBufferSize:3,geometryEventTolerance:1},yg=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}Nh(e,t);var i=e.prototype;return i.onConfig=function(e){if(t.prototype.onConfig.call(this,e),e.enableAltitude||e.drawAltitude||e.altitudeProperty){var i=this.getRenderer();i&&i.setToRedraw&&i.setToRedraw()}},i.identify=function(t,e){void 0===e&&(e={});var i=this.getRenderer();t instanceof Gu||(t=new Gu(t));var n=this.getMap().coordToContainerPoint(t);return e.onlyVisible&&i&&i.identifyAtPoint?i.identifyAtPoint(n,e):this._hitGeos(this._geoList,n,e)},i.identifyAtPoint=function(t,e){void 0===e&&(e={});var i=this.getRenderer();return t instanceof Gh||(t=new Gh(t)),e.onlyVisible&&i&&i.identifyAtPoint?i.identifyAtPoint(t,e):this._hitGeos(this._geoList,t,e)},i._hitGeos=function(t,e,i){void 0===i&&(i={});var n=i.filter,r=[],s=i.tolerance,o=this.getMap(),a=this.getRenderer(),h=a&&a.getImageData&&a.getImageData();if(h){for(var l=0,c=t.length-1;c>=0;c--){var u=t[c]._hitTestTolerance()+(s||0);u>l&&(l=u)}var d=o.getDevicePixelRatio();h.r=d;for(var f=!1,p=e.x-l,g=e.y-l,m=-l;m<=l;m++){for(var _=-l;_<=l;_++){var v=Math.round((p+m)*d),y=Math.round((g+_)*d)*h.width*4+4*v;if(h.data[y+3]>0){f=!0;break}}if(f)break}if(!f)return r}for(var x=t.length-1;x>=0;x--){var w=t[x];if(w&&w.isVisible()&&w._getPainter()&&w.options.interactive){if(!(w instanceof Up&&(w._getArrowStyle()||w instanceof ig))){var b=w.getContainerExtent(_g);if(s&&(b=b._expand(s)),!b||!b.contains(e))continue}if(w._containsPoint(e,s)&&(!n||n(w))&&(r.push(w),i.count&&r.length>=i.count))break}}return r},i.getAltitude=function(){return this.options.altitude||0},i.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if(Za(t.geometries)||t.geometries){var i;if(t.clipExtent){var n=this.getMap(),r=n?n.getProjection():null;i=new id(t.clipExtent,r)}for(var s=[],o=this.getGeometries(),a=0,h=o.length;a<h;a++){var l=o[a],c=l.getExtent();if(c&&(!i||i.intersects(c))){var u=l.toJSON(t.geometries);s.push(u)}}e.geometries=s}return e},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var i=new e(t.id,t.options),n=t.geometries,r=[],s=0;s<n.length;s++){var o=op.fromJSON(n[s]);o&&r.push(o)}return i.addGeometry(r),i},e.getPainterClass=function(){return Kf},e.getCollectionPainterClass=function(){return ep},e}(mg);yg.mergeOptions(vg),yg.registerJSONType("VectorLayer");var xg="_map_tool",wg=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addTo=function(t){return t?(this._map=t,t[xg]&&t[xg].disable(),this.onAdd&&this.onAdd(),this.enable(),t[xg]=this,this._fireEvent("add"),this):this},i.getMap=function(){return this._map},i.enable=function(){return!this._map||this._enabled||(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable")),this},i.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},i.isEnabled=function(){return!!this._enabled},i.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[xg],delete this._map),this._fireEvent("remove"),this):this},i._registerEvents=function(){this._switchEvents("on")},i._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},i._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(Eu(Ou)),bg={},Mg=function(t){function e(e){var i;return(i=t.call(this,e)||this)._checkMode(),i._events={click:i._clickHandler,"mousemove touchmove":i._mouseMoveHandler,dblclick:i._doubleClickHandler,"mousedown touchstart":i._mouseDownHandler,"mouseup touchend":i._mouseUpHandler,mousemove:i._mouseMoveHandler,mousedown:i._mouseDownHandler,mouseup:i._mouseUpHandler},i}Nh(e,t),e.registerMode=function(t,e){bg[t.toLowerCase()]=e},e.getRegisterMode=function(t){return bg[t.toLowerCase()]};var i=e.prototype;return i.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},i.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},i.getSymbol=function(){var t=this.options.symbol;return Lc(t||this.options.symbol)},i.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},i.getCurrentGeometry=function(){return this._geometry},i.onAdd=function(){this._checkMode()},i.onEnable=function(){this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources();var t=this.getMap();return this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge=t.options.autoPanAtEdge,this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!0})),this._geometryEvents=t.options.geometryEvents,this.options.blockGeometryEvents&&t.config("geometryEvents",!1),this},i.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw({ignoreEndEvent:!0}),this._map&&(t.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!1}))),this.options.blockGeometryEvents&&t.config("geometryEvents",this._geometryEvents),this},i.undo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||!this._historyPointer)return this;var i=this._clickCoords.slice(0,--this._historyPointer);return t.update(this.getMap().getProjection(),i,this._geometry),this},i.redo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||Za(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var i=this._clickCoords.slice(0,++this._historyPointer);return t.update(this.getMap().getProjection(),i,this._geometry),this},i._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},i._checkMode=function(){this._getRegisterMode()},i._saveMapCfg=function(){var t=this.getMap();this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom});for(var e=this._getRegisterMode().action,i=!1,n=0;n<e.length;n++)if(e[n].indexOf("mousedown")>=0||e[n].indexOf("touchstart")>=0){i=!0;break}if(i){var r=this.getMap();this._mapDraggable=r.options.draggable,r.config({draggable:!1})}},i._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),Za(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},i._loadResources=function(){var t=ac(this.getSymbol());t.length>0&&this._drawToolLayer._getRenderer().loadResources(t)},i._getProjection=function(){return this._map.getProjection()},i._getRegisterMode=function(){var t=this.getMode(),i=e.getRegisterMode(t);if(!i)throw new Error(t+" is not a valid mode of DrawTool.");return i},i.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var i=0;i<t.length;i++)e[t[i]]=this._events[t[i]];return e}return null},i._mouseDownHandler=function(t){this._createGeometry(t)},i._mouseUpHandler=function(t){this.endDraw(t)},i._clickHandler=function(t){var e=this.getMap(),i=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var n=this._clickCoords.length,r=e._pointToPrj(t.point2d);if(this._clickCoords[n-1].equals(r))return}if(this._geometry){var s=e._pointToPrj(t.point2d);Za(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer));var o=this._geometry.snapTo;if(o&&Qa(o)){var a=this._getSnapResult(o,t.containerPoint);if(s=a.prjCoord,this._clickCoords=this._clickCoords.concat(a.effectedVertex),this._clickCoords[this._clickCoords.length-1].equals(s))return}if(this._clickCoords.push(s),this._historyPointer=this._clickCoords.length,t.drawTool=this,i.update(e.getProjection(),this._clickCoords,this._geometry,t),"point"===this.getMode())return void this.endDraw(t);this._clickCoords.length<=1?this._fireEvent("drawstart",t):this._fireEvent("drawvertex",t),i.clickLimit&&i.clickLimit===this._historyPointer&&this.endDraw(t)}else this._createGeometry(t)},i._createGeometry=function(t){var e=this.getMode(),i=this._getRegisterMode(),n=this.getMap()._pointToPrj(t.point2d),r=this.getSymbol();if(!this._geometry){this._clickCoords=[n],t.drawTool=this,this._geometry=i.create(this.getMap().getProjection(),this._clickCoords,t),r&&"point"!==e?this._geometry.setSymbol(r):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t);var s=this._geometry.snapTo;if(s&&Qa(s)){var o=this._getSnapResult(s,t.containerPoint),a=this.getMap();if(a&&o){var h=o.prjCoord;this._clickCoords=[h],i.update(a.getProjection(),this._clickCoords,this._geometry,t)}}}"point"===e&&"mousemove"!==t.type&&this.endDraw(t)},i._mouseMoveHandler=function(t){var e=this.getMap();if(e&&!e.isInteracting())if("point"!==this.getMode()||this._geometry){if(this._geometry){var i=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(i)){var n=e._pointToPrj(t.point2d),r=[],s=this._geometry.snapTo;if(s&&Qa(s)){var o=this._getSnapResult(s,i);n=o.prjCoord,r=o.effectedVertex}var a=e.getProjection();t.drawTool=this;var h=this._getRegisterMode();if(this._shouldRecordHistory(h.action)){var l=this._clickCoords.slice(0,this._historyPointer);if(l&&l.length>0&&n.equals(l[l.length-1]))return;h.update(a,l.concat(r,[n]),this._geometry,t)}else h.update(a,n,this._geometry,t);this._fireEvent("mousemove",t)}}}else this._createGeometry(t)},i._doubleClickHandler=function(t){if(this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var i=this._getRegisterMode(),n=this._clickCoords;if(!(n.length<2)){var r=this.getMode();if(!(r&&r.indexOf("polygon")>-1&&n.length<3)){for(var s=this.getMap().getProjection(),o=[n[0]],a=1,h=n.length;a<h;a++)n[a].x===n[a-1].x&&n[a].y===n[a-1].y||o.push(n[a]);o.length<2||this._geometry&&this._geometry instanceof zp&&o.length<3||(t.drawTool=this,i.update(s,o,this._geometry,t),this.endDraw(t))}}}}},i._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},i.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,t.ignoreEndEvent||this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this._vertexes&&(this._vertexes=[]),this},i._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},i._getMouseContainerPoint=function(t){var e=this._getRegisterMode().action;return(e[0].indexOf("mousedown")>=0||e[0].indexOf("touchstart")>=0)&&Yc(t.domEvent),t.containerPoint},i._isValidContainerPoint=function(t){var e=this._map.getSize(),i=e.width,n=e.height;return!(t.x<0||t.y<0)&&!(t.x>i||t.y>n)},i._getSnapResult=function(t,e){var i=this.getMap(),n=[];if(this.options.edgeAutoComplete){var r=this._clickCoords[(this._historyPointer||1)-1];n.push(i._prjToContainerPoint(r));var s=this._clickCoords[(this._historyPointer||1)-2];s&&n.push(i._prjToContainerPoint(s))}var o=t(e,n);e=(o.effectedVertex?o.point:o)||e;var a=i._containerPointToPrj(e);return o.effectedVertex&&(o.effectedVertex=o.effectedVertex.map((function(t){return i._containerPointToPrj(t)}))),{prjCoord:a,effectedVertex:o.effectedVertex||[]}},i._getDrawLayer=function(){var t=Na+"drawtool",e=this._map.getLayer(t);return e||(e=new yg(t,{enableSimplify:!1,enableAltitude:this.options.enableAltitude}),this._map.addLayer(e)),e},i._fireEvent=function(t,e){e||(e={}),e=Wa({},e),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}),e.tempGeometry=this._geometry),wg.prototype._fireEvent.call(this,t,e)},e}(wg);Mg.mergeOptions({symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0,blockGeometryEvents:!1});var Sg=function(t){function e(e){var i;return(i=t.call(this,e)||this).drawTool=new Mg({mode:"boxZoom",ignoreMouseleave:!1}),i}Nh(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},i.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},i._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},i._boxZoom=function(t){var e=this.target;this.drawTool.remove();var i=t.geometry,n=i.getCenter(),r=i.getSymbol(),s=r.markerWidth,o=r.markerHeight,a=new id(n,e.locateByPoint(n,s,o),e.getProjection()),h=e.getFitZoom(a);e._animateTo({center:a.getCenter(),zoom:h})},e}(Ru);yp.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),yp.addOnLoadHook("addHandler","boxZoom",Sg);var Cg=30,Tg=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},i.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},i._onMouseMove=function(t){var e=this.target;if(e.options.autoPanAtEdge){var i=t.containerPoint,n=e.getContainerExtent();if(n){var r,s=i.x,o=i.y,a=n.xmax,h=n.ymax;s<Cg&&(r=[Math.abs(s-Cg),0]),o<Cg&&(r=[0,Math.abs(o-Cg)]),s+Cg>a&&(r=[-Math.abs(s+Cg-a),0]),o+Cg>h&&(r=[0,-Math.abs(o+Cg-h)]),r&&e.panBy(r,{duration:1})}}},e}(Ru);function Pg(t,e,i){return t*(1-i)+e*i}yp.mergeOptions({autoPanAtEdge:!1}),yp.addOnLoadHook("addHandler","autoPanAtEdge",Tg),yp.include({animateTo:function(t,e,i){var n=this;void 0===e&&(e={}),Qa(e)&&(i=e,e={});var r=this.getProjection(),s=this.getView(),o={},a=!0;for(var h in t)if($a(t,h)&&!Za(t[h])&&("prjCenter"===h||!Za(s[h])))if(a=!1,"center"===h){var l=new Gu(s[h]),c=new Gu(t[h]);l.equals(c)||(o.center=[l,c])}else if("prjCenter"===h){var u=new Gu(this._getPrjCenter()),d=new Gu(t[h]);u.equals(d)||(o.prjCenter=[u,d])}else s[h]!==t[h]&&"around"!==h&&(o[h]=[s[h],t[h]]);if(a)return null;this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var f=t.around||new Gh(this.width/2,this.height/2),p=this._getRenderer(),g=this._animPlayer=Op.animate(o,{easing:e.easing||"out",duration:e.duration||this.options.zoomAnimationDuration,framer:function(t){p.callInNextFrame(t)},repeat:e.repeat},(function(t){if(n.isRemoved())g.finish();else{if("running"===g.playState){if(t.styles.center){var s=t.styles.center;n._setPrjCenter(r.project(s)),n.onMoving(n._parseEventFromCoord(n.getCenter()))}else if(t.styles.prjCenter){var a=t.styles.prjCenter;n._setPrjCenter(a),n.onMoving(n._parseEventFromCoord(n.getCenter()))}Za(t.styles.zoom)||n.onZooming(t.styles.zoom,f),Za(t.styles.pitch)||n._setPitch(t.styles.pitch),Za(t.styles.bearing)||n._setBearing(t.styles.bearing),n._fireEvent("animating")}else"paused"===g.playState&&g!==n._mapAnimPlayer||(g._interupted||(o.center?n._setPrjCenter(r.project(o.center[1])):o.prjCenter&&n._setPrjCenter(o.prjCenter[1]),Za(o.pitch)||n._setPitch(o.pitch[1]),Za(o.bearing)||n._setBearing(o.bearing[1])),n._endAnim(g,o,f,e));i&&i(t)}}),this);return this._startAnim(o,f),g},_animateTo:function(t,e,i){return void 0===e&&(e={}),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(t,e,i),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(t,e,i){var n=this;void 0===e&&(e={}),this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),Qa(e)&&(i=e,e={}),e=Wa({curve:1.42},e);var r=this;function s(t,e){return r.getResolution(e)/r.getResolution(t)}var o=t.around||new Gh(this.width/2,this.height/2),a=this.getMinZoom(),h=this.getMaxZoom(),l=this.getProjection(),c=this.getView(),u=c.zoom,d=c.bearing,f=c.pitch,p="zoom"in t?nl(+t.zoom,a,h):u,g="bearing"in t?+t.bearing:d,m="pitch"in t?+t.pitch:f,_=l.project(t.center&&new Gu(t.center)||this.getCenter()),v=s(p,u),y=l.project(this.getCenter()),x=_.sub(y),w=e.curve,b=Math.max(this.width,this.height),M=b/v,S=x.mag();if("minZoom"in e){var C=nl(Math.min(e.minZoom,u,p),a,h),T=b/s(C,u);w=Math.sqrt(T/S*2)}var P=w*w;function A(t){var e=(M*M-b*b+(t?-1:1)*P*P*S*S)/(2*(t?M:b)*P*S);return Math.log(Math.sqrt(e*e+1)-e)}function E(t){return(Math.exp(t)-Math.exp(-t))/2}function L(t){return(Math.exp(t)+Math.exp(-t))/2}var R=A(0),O=function(t){return L(R)/L(R+w*t)},D=function(t){return b*((L(R)*(E(e=R+w*t)/L(e))-E(R))/P)/S;var e},I=(A(1)-R)/w;if(Math.abs(S)<1e-6||!isFinite(I)){if(Math.abs(b-M)<1e-6)return this.animateTo(t,e,i);var k=M<b?-1:1;I=Math.abs(Math.log(M/b))/w,D=function(){return 0},O=function(t){return Math.exp(k*w*t)}}var z=this._getRenderer(),N=this._animPlayer=Op.animate({k:[0,1]},{easing:e.easing||"out",duration:e.duration||8,framer:function(t){z.callInNextFrame(t)}},(function(r){if(n.isRemoved())N.finish();else{var s=r.styles.k,a=s*I,h=1/O(a),l={};if(t.center){var c=1===s?_:y.add(x.multi(D(a)));l.prjCenter=[_,c]}if(u!==p){var v=1===s?p:n.getZoomForScale(h,u,!0);l.zoom=[u,v]}if(f!==m){var w=Pg(f,m,s);l.pitch=[m,w]}if(d!==g){var b=Pg(d,g,s);l.bearing=[g,b]}if("running"===N.playState){if(l.prjCenter){var M=l.prjCenter;n._setPrjCenter(M[1]),n.onMoving(n._parseEventFromCoord(n.getCenter()))}l.zoom&&n.onZooming(l.zoom[1],o),l.pitch&&n._setPitch(l.pitch[1]),l.bearing&&n._setBearing(l.bearing[1]),n._fireEvent("animating")}else"paused"===N.playState&&N!==n._mapAnimPlayer||(N._interupted||(l.prjCenter&&n._setPrjCenter(l.prjCenter[1]),l.pitch&&n._setPitch(l.pitch[1]),l.bearing&&n._setBearing(l.bearing[1])),n._endAnim(N,l,o,e));i&&i(r)}}));return this._startAnim({center:t.center,zoom:t.zoom!==u,pitch:m!==f,bearing:g!==d},o),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,i,n){delete this._animRotating;var r,s=t._interupted?"animateinterrupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer,e.center)r=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(r));else if(e.prjCenter){var o;o=t._interupted?this._getPrjCenter():e.prjCenter[1];var a=this._parseEventFromCoord(this.getProjection().unproject(o));a.point2d=this._prjToPoint(o),this.onMoveEnd(a)}Za(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom(),i):n.wheelZoom?this.onZooming(e.zoom[1],i):this.onZoomEnd(e.zoom[1],i)),s&&this._fireEvent(s),Za(e.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),n.wheelZoom||this._resumePrev(t)},_startAnim:function(t,e){this._animPlayer&&((t.center||t.prjCenter)&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&(delete this._animRotating,"finished"!==t.playState&&(t._interupted=!0,t.cancel()),t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(t){if(this._prevAnimPlayer){var e=this._prevAnimPlayer;"paused"!==e.playState&&delete this._prevAnimPlayer,t!==e&&(this._animPlayer=e,e.play())}}});var Ag="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend ";function Eg(t,e,i,n,r){var s=1/Math.tan(e/2),o=1/(n-r);return t[0]=s/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+n)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*n*o,t[15]=0,t}function Lg(t,e,i){var n,r,s,o,a,h,l,c,u,d,f,p,g=i[0],m=i[1],_=i[2];return e===t?(t[12]=e[0]*g+e[4]*m+e[8]*_+e[12],t[13]=e[1]*g+e[5]*m+e[9]*_+e[13],t[14]=e[2]*g+e[6]*m+e[10]*_+e[14],t[15]=e[3]*g+e[7]*m+e[11]*_+e[15]):(n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],f=e[10],p=e[11],t[0]=n,t[1]=r,t[2]=s,t[3]=o,t[4]=a,t[5]=h,t[6]=l,t[7]=c,t[8]=u,t[9]=d,t[10]=f,t[11]=p,t[12]=n*g+a*m+u*_+e[12],t[13]=r*g+h*m+d*_+e[13],t[14]=s*g+l*m+f*_+e[14],t[15]=o*g+c*m+p*_+e[15]),t}function Rg(t,e,i){var n=i[0],r=i[1],s=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Og(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],f=e[10],p=e[11],g=e[12],m=e[13],_=e[14],v=e[15],y=i[0],x=i[1],w=i[2],b=i[3];return t[0]=y*n+x*a+w*u+b*g,t[1]=y*r+x*h+w*d+b*m,t[2]=y*s+x*l+w*f+b*_,t[3]=y*o+x*c+w*p+b*v,y=i[4],x=i[5],w=i[6],b=i[7],t[4]=y*n+x*a+w*u+b*g,t[5]=y*r+x*h+w*d+b*m,t[6]=y*s+x*l+w*f+b*_,t[7]=y*o+x*c+w*p+b*v,y=i[8],x=i[9],w=i[10],b=i[11],t[8]=y*n+x*a+w*u+b*g,t[9]=y*r+x*h+w*d+b*m,t[10]=y*s+x*l+w*f+b*_,t[11]=y*o+x*c+w*p+b*v,y=i[12],x=i[13],w=i[14],b=i[15],t[12]=y*n+x*a+w*u+b*g,t[13]=y*r+x*h+w*d+b*m,t[14]=y*s+x*l+w*f+b*_,t[15]=y*o+x*c+w*p+b*v,t}function Dg(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],d=e[10],f=e[11],p=e[12],g=e[13],m=e[14],_=e[15],v=i*a-n*o,y=i*h-r*o,x=i*l-s*o,w=n*h-r*a,b=n*l-s*a,M=r*l-s*h,S=c*g-u*p,C=c*m-d*p,T=c*_-f*p,P=u*m-d*g,A=u*_-f*g,E=d*_-f*m,L=v*E-y*A+x*P+w*T-b*C+M*S;return L?(L=1/L,t[0]=(a*E-h*A+l*P)*L,t[1]=(r*A-n*E-s*P)*L,t[2]=(g*M-m*b+_*w)*L,t[3]=(d*b-u*M-f*w)*L,t[4]=(h*T-o*E-l*C)*L,t[5]=(i*E-r*T+s*C)*L,t[6]=(m*x-p*M-_*y)*L,t[7]=(c*M-d*x+f*y)*L,t[8]=(o*A-a*T+l*S)*L,t[9]=(n*T-i*A-s*S)*L,t[10]=(p*b-g*x+_*v)*L,t[11]=(u*x-c*b-f*v)*L,t[12]=(a*C-o*P-h*S)*L,t[13]=(i*P-n*C+r*S)*L,t[14]=(g*y-p*w-m*v)*L,t[15]=(c*w-u*y+d*v)*L,t):null}function Ig(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function kg(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function zg(t,e,i,n){return t[0]=e,t[1]=i,t[2]=n,t}function Ng(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function Fg(t){var e=t[0],i=t[1],n=t[2];return Math.sqrt(e*e+i*i+n*n)}function jg(t,e){var i=e[0],n=e[1],r=e[2],s=i*i+n*n+r*r;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s),t}function Bg(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[0],a=i[1],h=i[2];return t[0]=r*h-s*a,t[1]=s*o-n*h,t[2]=n*a-r*o,t}function Ug(t,e){var i=e[0]-t[0],n=e[1]-t[1],r=e[2]-t[2];return Math.hypot?Math.hypot(i,n,r):function(){var t=0,e=arguments.length;for(;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}(i,n,r)}function Gg(t,e,i){var n=e[0],r=e[1],s=e[2],o=1/(i[3]*n+i[7]*r+i[11]*s+i[15]);return t[0]=(i[0]*n+i[4]*r+i[8]*s+i[12])*o,t[1]=(i[1]*n+i[5]*r+i[9]*s+i[13])*o,t[2]=(i[2]*n+i[6]*r+i[10]*s+i[14])*o,t}yp.include({_registerDomEvents:function(){Zc(this._panels.mapWrapper||this._containerDOM,Ag,this._handleDOMEvent,this)},_removeDomEvents:function(){qc(this._panels.mapWrapper||this._containerDOM,Ag,this._handleDOMEvent)},_handleDOMEvent:function(t){var e=this.options.clickTimeThreshold,i=t.type,n="mousedown"===i||"touchstart"===i&&(!t.touches||1===t.touches.length);n&&(this._domMouseDownTime=Va(),this._domMouseDownView=this.getView());var r="contextmenu"===i&&function(t){if(!t._domMouseDownView)return!0;var e=t.getView(),i=t._domMouseDownView;return e.bearing!==i.bearing||e.pitch!==i.pitch}(this);if("contextmenu"===i){Jc(t);var s=this._domMouseDownTime;Va()-s<=e&&!r&&this._fireDOMEvent(this,t,"dom:"+t.type)}else this._fireDOMEvent(this,t,"dom:"+t.type);if(!this._ignoreEvent(t)){var o,a=!1;if(n)this._mouseDownTime=Va();else if("click"===i||"touchend"===i||"contextmenu"===i){if(!this._mouseDownTime)return;var h=this._mouseDownTime;if(delete this._mouseDownTime,Va()-h>e){if("click"===i||"contextmenu"===i)return}else if("contextmenu"===i){if(r)return}else"touchend"===i&&(a=!0)}a&&(this._clickTime&&Va()-this._clickTime<=e?(delete this._clickTime,o="dblclick",this._fireDOMEvent(this,t,"dom:dblclick")):(this._clickTime=Va(),o="click",this._fireDOMEvent(this,t,"dom:click"))),this._ignoreEvent(t)||(this._fireDOMEvent(this,t,i),o&&this._fireDOMEvent(this,t,o))}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;if(this._isEventOutMap(t))return!0;var e,i=t.srcElement||t.target;if(i)for(;i&&i!==this._containerDOM;){if(i.className&&i.className.indexOf&&(i.className.indexOf("maptalks-control")>=0||i.className.indexOf("maptalks-ui")>=0&&e&&!e.eventsPropagation))return!0;e=i,i=i.parentNode}return!1},_isEventOutMap:function(t){if(this.getPitch()>this.options.maxVisualPitch){var e=tu(this._getActualEvent(t),this._containerDOM);if(!this.getContainerExtent().contains(e))return!0}return!1},_parseEvent:function(t,e){if(!t)return null;var i={domEvent:t};if("keypress"!==e){var n=this._getActualEvent(t);if(n&&void 0!==n.clientX){var r=tu(n,this._containerDOM);i=Wa(i,{containerPoint:r,viewPoint:this.containerPointToViewPoint(r)});var s=this.options.maxVisualPitch;(this.getPitch()<=s||r.y>=this.height-this._getVisualHeight(s))&&(i=Wa(i,{coordinate:this.containerPointToCoord(r),point2d:this._containerPointToPoint(r)}))}}return i},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,i){if(!this.isRemoved()){var n=this._parseEvent(e,i);this._fireEvent(i,n)}},_getEventParams:function(t){var e=this,i={domEvent:t},n=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(n){var r=tu(n,e._containerDOM);i.coordinate=e.containerPointToCoordinate(r),i.containerPoint=r,i.viewPoint=e.containerPointToViewPoint(r),i.pont2d=e._containerPointToPoint(r)}return i}}),yp.addOnLoadHook("_registerDomEvents"),yp.include({isFullScreen:function(){return!!(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),yp.include({panTo:function(t,e,i){if(void 0===e&&(e={}),!t)return this;if(Qa(e)&&(i=e,e={}),t=new Gu(t),void 0===e.animation||e.animation){var n=this.getProjection().project(t);return this._panAnimation(n,e.duration,i)}return this.setCenter(t),this},_panTo:function(t,e){return void 0===e&&(e={}),void 0===e.animation||e.animation?this._panAnimation(t,e.duration):(this.onMoveStart(),this._setPrjCenter(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(t,e,i){if(void 0===e&&(e={}),!t)return this;if(Qa(e)&&(i=e,e={}),t=new Gh(t),this.getContainerExtent().ymin>0&&t.y>30){var n=t.y;t.y=30,t.x=30*t.x/n}if(this.onMoveStart(),void 0===e.animation||e.animation){t=t.multi(-1);var r=this._containerPointToPrj(new Gh(this.width/2+t.x,this.height/2+t.y));this._panAnimation(r,e.duration,i)}else this._offsetCenterByPixel(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter()));return this},_panAnimation:function(t,e,i){return this._animateTo({prjCenter:t},{duration:e||this.options.panAnimationDuration},i)}}),op.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],i=0,n=t.length;i<n;i++){var r=op.fromJSON(t[i]);Array.isArray(t)?e=e.concat(r):e.push(r)}return e}return t&&!t.feature?Qp.toGeometry(t):(t.subType?(s=op.getJSONClass(t.subType).fromJSON(t),Za(t.feature.id)||s.setId(t.feature.id)):(s=Qp.toGeometry(t.feature),t.options&&s.config(t.options)),t.symbol&&s.setSymbol(t.symbol),t.infoWindow&&s.setInfoWindow(t.infoWindow),s);var s},hp.fromJSON=function(t){if(!t)return null;var e=t.type,i=hp.getJSONClass(e);if(!i||!i.fromJSON)throw new Error("unsupported layer type:"+e);return i.fromJSON(t)},yp.include({JSON_VERSION:"1.0",toJSON:function(t){t||(t={});var e={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom(),e.options.bearing=this.getBearing(),e.options.pitch=this.getPitch();var i=this.getBaseLayer();(Za(t.baseLayer)||t.baseLayer)&&i&&(e.baseLayer=i.toJSON(t.baseLayer));var n={};t.clipExtent&&(!0===t.clipExtent?n.clipExtent=this.getExtent():n.clipExtent=t.clipExtent);var r=[];if(Za(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var s=this.getLayers(),o=0,a=s.length;o<a;o++)if(s[o].toJSON){var h=Wa({},Ja(t.layers)?t.layers:{},n);r.push(s[o].toJSON(h))}e.layers=r}else if(rl(t.layers)){for(var l=t.layers,c=0;c<l.length;c++){var u=l[c],d=this.getLayer(u.id);if(d.toJSON){var f=Wa({},u.options,n);r.push(d.toJSON(f))}}e.layers=r}else e.layers=[];return e}}),yp.fromJSON=function(t,e,i){if(!t||!e)return null;i||(i={});var n=new yp(t,e.options);if(Za(i.baseLayer)||i.baseLayer){var r=hp.fromJSON(e.baseLayer);r&&n.setBaseLayer(r)}if(Za(i.layers)||i.layers){for(var s=[],o=e.layers,a=0;a<o.length;a++){var h=hp.fromJSON(o[a]);s.push(h)}n.addLayer(s)}return n},yp.include({computeLength:function(t,e){if(!this.getProjection())return null;var i=new Gu(t),n=new Gu(e);return i.equals(n)?0:this.getProjection().measureLength(i,n)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){var i=new Gu((t=t||{}).coordinate);return this._identify(t,e,(function(e){return e.identify(i,t)}))},identifyAtPoint:function(t,e){var i=new Gh((t=t||{}).containerPoint),n=this.containerPointToCoord(i);return this._identify(t,e,(function(e){return e.identifyAtPoint?e.identifyAtPoint(i,t):n?e.identify(n,t):[]}))},_identify:function(t,e,i){var n=t.layers;if(!rl(n))return this;for(var r=t.eventTypes,s=[],o=0,a=n.length;o<a;o++)Ya(n[o])?s.push(this.getLayer(n[o])):s.push(n[o]);r&&(s=s.filter((function(t){return!t._hasGeoListeners||t._hasGeoListeners(r)})));for(var h=[],l=s.length-1;l>=0&&!(t.count&&h.length>=t.count);l--){var c=s[l];if(c&&c.getMap()&&(t.includeInvisible||c.isVisible())&&(t.includeInternals||!(c.getId().indexOf(Na)>=0))){var u=i(c);u&&(Array.isArray(u)?Jh(h,u):h.push(u))}}return e.call(this,h),this}}),yp.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,i){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,i)))},_checkZoomOrigin:function(t){return t&&!this.options.zoomInCenter||(t=new Gh(this.width/2,this.height/2)),this.options.zoomOrigin&&(t=new Gh(this.options.zoomOrigin)),t},_startZoomAnim:function(t,e,i){Za(i)&&(i=1);var n=this._getResolution(this._startZoomVal)/this._getResolution(t),r=this.options.zoomAnimationDuration*Math.abs(n-i)/Math.abs(n-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:r})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,i){if(this.options.zoomable&&this._frameZoom!==t){Za(i)&&(i=1),this._zoomTo(t,e);var n=this.getResolution(t),r=this.getResolution(this._startZoomVal)/n/i,s=this._prjToContainerPoint(this._startZoomCoord,this._startZoomVal),o=this.getViewPoint();if(!this.isRotating()&&!s.equals(e)&&1!==r){var a=this.getPitch(),h=s._sub(e)._multi(1/(1-r));a&&(h.y/=Math.cos(a*Math.PI/180)),e=e.add(h)}var l={view:[r,0,0,r,(e.x-o.x)*(1-r),(e.y-o.y)*(1-r)]},c=this.getDevicePixelRatio();1!==c&&(e=e.multi(c)),l.container=[r,0,0,r,e.x*(1-r),e.y*(1-r)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:e,matrix:l}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var i=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._fireEvent("zoomend",{from:i,to:t}),this._verifyExtent(this._getPrjCenter())||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(t,e){this._zoomLevel=t,this._calcMatrices(),e&&this._setPrjCoordAtContainerPoint(this._startZoomCoord,e)},_checkZoom:function(t){var e=this.getMaxZoom(),i=this.getMinZoom();return t<i&&(t=i),t>e&&(t=e),t}});var Hg,Vg,Wg,Zg,qg,Xg,Jg,Yg,Qg,Kg=Math.PI/180,$g=new Gu(0,0);function tm(){return Ig(new Array(16))}yp.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/Kg},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*Kg,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/Kg:0},setBearing:function(t){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setBearing(t)},_setBearing:function(t){if(zh.ie9)throw new Error("map can't rotate in IE9.");var e=-il(t,-180,180)*Kg;if(this._angle===e)return this;var i=this.getBearing();return this._fireEvent("rotatestart",{from:i,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:i,to:e}),this._fireEvent("rotateend",{from:i,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setPitch(t)},_setPitch:function(t){if(zh.ie9)throw new Error("map can't tilt in IE9.");var e=nl(t,0,this.options.maxPitch)*Kg;if(this._pitch===e)return this;var i=this.getPitch();return this._fireEvent("pitchstart",{from:i,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:i,to:e}),this._fireEvent("pitchend",{from:i,to:e}),this},isTransforming:function(){return!(!this._pitch&&!this._angle)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,i=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return i;e=Math.PI*e/180;var n=new Gh(this.cameraPosition).distanceTo(new Gh(this.cameraLookAt)),r=i*Math.tan(2*e);return i+Math.tan(e)*(n+r)},_pointToContainerPoint:function(t,e,i,n){void 0===i&&(i=0);var r=this._getResolution(e);return this._pointAtResToContainerPoint(t,r,i,n)},_pointAtResToContainerPoint:function(t,e,i,n){void 0===i&&(i=0),n||(n=new Gh(0,0)),t=this._pointAtResToPoint(t,e,n);var r,s=this.isTransforming(),o=e/this._getResolution();return s||i||(r=this._prjToPoint(this._getPrjCenter(),void 0,$g)),this._toContainerPoint(n,s,o,i,r),n},_pointsAtResToContainerPoints:function(t,e,i,n){void 0===i&&(i=[]),void 0===n&&(n=[]);var r=this.getPitch(),s=this.getBearing();if(0===r&&0===s){var o=this._get2DExtent(),a=o.xmin,h=o.ymin,l=o.xmax,c=o.ymax;if(l>a&&c>h){for(var u=e/this._getResolution(),d=this.getSize(),f=d.width,p=d.height,g=(l-a)/f,m=(c-h)/p,_=0,v=t.length;_<v;_++)if(t[_]){var y=n[_];y.x=t[_].x,y.y=t[_].y,y._multi(u),y.x=(y.x-a)*g,y.y=p-(y.y-h)*m}else n[_]=null;return n}}for(var x=Array.isArray(i),w=this.isTransforming(),b=e/this._getResolution(),M=this._prjToPoint(this._getPrjCenter(),void 0,$g),S=0,C=t.length;S<C;S++)if(t[S]){var T=n[S];T.x=t[S].x,T.y=t[S].y,T._multi(b);var P=x?i[S]||0:i;this._toContainerPoint(T,w,b,P,M)}else n[S]=null;return n},_toContainerPoint:(Qg=[0,0,0],function(t,e,i,n,r){var s=this.width/2,o=this.height/2;if(e||n){n*=i;var a=this._glScale;zg(Qg,t.x*a,t.y*a,n*a);var h=this._projIfBehindCamera(Qg,this.cameraPosition,this.cameraForward);Gg(h,h,this.projViewMatrix),t.x=h[0]*s+s,t.y=-h[1]*o+o}else t._sub(r.x,r.y),t.set(t.x,-t.y),t._add(s,o)}),_projIfBehindCamera:(Xg=new Array(3),Jg=new Array(3),Yg=new Array(3),function(t,e,i){Ng(Xg,t,e);var n=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(i,Xg);return n<=0&&(function(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}(Jg,i,1.01*n),function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}(t,e,Ng(Yg,Xg,Jg))),t}),_containerPointToPoint:function(t,e,i){var n=this._getResolution(e);return this._containerPointToPointAtRes(t,n,i)},_containerPointToPointAtRes:(Wg=[0,0,0],Zg=[0,0,0,1],qg=[0,0,0,1],function(t,e,i){if(this.isTransforming()){var n=this.width/2||1,r=this.height/2||1;zg(Wg,(t.x-n)/n,(r-t.y)/r,0),zg(Zg,Wg[0],Wg[1],0),zg(qg,Wg[0],Wg[1],1),Zg[3]=qg[3]=1,Gg(Zg,Zg,this.projViewMatrixInverse),Gg(qg,qg,this.projViewMatrixInverse);var s=Zg[0],o=qg[0],a=Zg[1],h=qg[1],l=Zg[2],c=qg[2],u=l===c?0:(0-l)/(c-l),d=el(s,o,u),f=el(a,h,u);return i?(i.x=d,i.y=f):i=new Gh(d,f),i._multi(1/this._glScale),this._getResolution()===e?i:this._pointToPointAtRes(i,e,i)}var p=this._prjToPointAtRes(this._getPrjCenter(),e,i),g=this._getResolution()/e,m=g*(t.x-this.width/2),_=g*(t.y-this.height/2);return p._add(m,-_)}),_calcMatrices:(Vg=tm(),function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,i=t.height||1;this._glScale=this.getGLScale();var n=this._getCameraWorldMatrix(),r=this.getFov()*Math.PI/180,s=this._getCameraFar(r,this.getPitch());this.cameraFar=s,this.cameraNear=this.cameraCenterDistance/20;var o=this.projMatrix||tm();Eg(o,r,e/i,this.cameraNear,s),this.projMatrix=o,this.viewMatrix=Dg(this.viewMatrix||tm(),n),this.projViewMatrix=Og(this.projViewMatrix||tm(),o,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=Og(this.projViewMatrixInverse||tm(),n,Dg(Vg,o)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this.getGLRes(),this._mapExtent2D=this._get2DExtent(),this._mapGlExtent2D=this._get2DExtentAtRes(this._mapGlRes)}),_getCameraFar:function(t,e){var i=this.cameraCenterDistance=Ug(this.cameraPosition,this.cameraLookAt),n=i,r=(this.options.cameraInfiniteFar?10:4)*i;if(e>0&&(e=e*Math.PI/180,2/Math.PI-e>t/2)){var s=Math.tan(t/2),o=Math.tan(e);r=Math.max(i*s/(1/o-s),r)}return(n+=r)+1},_calcCascadeMatrixes:function(){var t=tm();function e(e,i,n){var r=this.width,s=this.height,o=this.getFov()*Math.PI/180,a=this._getCameraFar(o,i),h=this.cameraCenterDistance;a=h+(a-h)/Math.cos((90-i)*Math.PI/180)*Math.cos((90-e)*Math.PI/180),Eg(t,o,r/s,.1,a);var l=this.viewMatrix;return Og(n,t,l)}return function(){var t=this.getPitch(),i=this.options.cascadePitches[0],n=this.options.cascadePitches[1],r=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||tm(),s=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||tm();t>i?e.call(this,t,i,r):kg(this.cascadeFrustumMatrix0,this.projViewMatrix),t>n?e.call(this,t,n,s):kg(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var t=tm(),e=tm(),i=[1,-1,1],n=[0,0,0];return function(){var r=this.width||1,s=this.height||1,o=.5/Math.tan(this._fov/2)*s;return Rg(t,this.projMatrix,i),Lg(t,t,zg(n,0,0,-o)),this._pitch&&function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],c=e[9],u=e[10],d=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*r+l*n,t[5]=o*r+c*n,t[6]=a*r+u*n,t[7]=h*r+d*n,t[8]=l*r-s*n,t[9]=c*r-o*n,t[10]=u*r-a*n,t[11]=d*r-h*n}(t,t,this._pitch),this._angle&&function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[0],o=e[1],a=e[2],h=e[3],l=e[4],c=e[5],u=e[6],d=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r+l*n,t[1]=o*r+c*n,t[2]=a*r+u*n,t[3]=h*r+d*n,t[4]=l*r-s*n,t[5]=c*r-o*n,t[6]=u*r-a*n,t[7]=d*r-h*n}(t,t,this._angle),Ig(e),Rg(e,e,zg(n,r/2,-s/2,1)),Og(this.domCssMatrix||tm(),e,t)}}(),_getFovZ:function(t){var e=this.getGLScale(t),i=this._getFovRatio();return e*(this.height||1)/2/i},_getCameraWorldMatrix:(Hg={},function(){var t=this.getGLRes(),e=this._prjToPointAtRes(this._prjCenter,t);this.cameraLookAt=zg(this.cameraLookAt||[0,0,0],e.x,e.y,0);var i=this.getPitch()*Kg,n=this.getBearing()*Kg,r=this._getFovZ(),s=r*Math.cos(i),o=Math.sin(i)*r,a=e.x-o*Math.sin(n),h=e.y-o*Math.cos(n);this.cameraPosition=zg(this.cameraPosition||[0,0,0],a,h,s),this.cameraToCenterDistance=Ug(this.cameraPosition,this.cameraLookAt);var l=o||1,c=this.cameraUp=zg(this.cameraUp||[0,0,0],Math.sin(n)*l,Math.cos(n)*l,0),u=this.cameraWorldMatrix=this.cameraWorldMatrix||tm();!function(t,e,i,n){var r=[0,0,0],s=[0,0,0],o=[0,0,0];Ng(o,e,i),0===Fg(o)&&(o[2]=1),jg(o,o),Bg(r,n,o),0===Fg(o)&&(1===Math.abs(n[2])?o[0]+=1e-4:o[2]+=1e-4,jg(o,o),Bg(r,n,o)),jg(r,r),Bg(s,o,r),t[0]=r[0],t[4]=s[0],t[8]=o[0],t[1]=r[1],t[5]=s[1],t[9]=o[1],t[2]=r[2],t[6]=s[2],t[10]=o[2]}(u,this.cameraPosition,this.cameraLookAt,c);var d,f,p,g=this.cameraForward||[0,0,0];return Ng(g,this.cameraLookAt,this.cameraPosition),this.cameraForward=jg(g,g),function(t,e){var i,n=e[0],r=e[4],s=e[8],o=e[1],a=e[5],h=e[9],l=e[2],c=e[6],u=e[10],d=n+a+u;d>0?(i=.5/Math.sqrt(d+1),t.w=.25/i,t.x=(c-h)*i,t.y=(s-l)*i,t.z=(o-r)*i):n>a&&n>u?(i=2*Math.sqrt(1+n-a-u),t.w=(c-h)/i,t.x=.25*i,t.y=(r+o)/i,t.z=(s+l)/i):a>u?(i=2*Math.sqrt(1+a-n-u),t.w=(s-l)/i,t.x=(r+o)/i,t.y=.25*i,t.z=(h+c)/i):(i=2*Math.sqrt(1+u-n-a),t.w=(o-r)/i,t.x=(s+l)/i,t.y=(h+c)/i,t.z=.25*i)}(Hg,u),function(t,e){var i=t,n=e.x,r=e.y,s=e.z,o=e.w,a=n+n,h=r+r,l=s+s,c=n*a,u=n*h,d=n*l,f=r*h,p=r*l,g=s*l,m=o*a,_=o*h,v=o*l;i[0]=1-(f+g),i[4]=u-v,i[8]=d+_,i[1]=u+v,i[5]=1-(c+g),i[9]=p-m,i[2]=d-_,i[6]=p+m,i[10]=1-(c+f),i[3]=0,i[7]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}(u,Hg),d=u,f=this.cameraPosition,(p=d)[12]=f[0],p[13]=f[1],p[14]=f[2],u}),_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*Kg)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach((function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}}))}}),yp.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),i=this._viewHistory.length-1;i>=0;i--)if(gl(t,this._viewHistory[i]))return this._viewHistoryPointer=i,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var n=this.options.viewHistoryCount;n>0&&this._viewHistory.length>n&&this._viewHistory.splice(0,this._viewHistory.length-n),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(t){if(void 0===t&&(t={}),!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(t){if(void 0===t&&(t={}),!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var i=this,n=this.getView();e.animation?this._animateTo(t,{duration:e.duration},(function(e){"finished"===e.state.playState&&i._fireViewChange(n,t)})):(this.setView(t),this._fireViewChange(n,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e})},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),yp.mergeOptions({viewHistory:!0,viewHistoryCount:10}),yp.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new zu,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this}});var em=function(t){function e(e){var i;return(i=t.call(this,e)||this).on("enable",i._afterEnable,Fh(Fh(i))).on("disable",i._afterDisable,Fh(Fh(i))),i._measureLayers=[],i}Nh(e,t);var i=e.prototype;return i.clear=function(){if(rl(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},i.getMeasureLayers=function(){return this._measureLayers},i.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},i.undo=function(){t.prototype.undo.call(this);var e=this._historyPointer;if(e!==this._vertexes.length)for(var i=e;i<this._vertexes.length;i++)this._vertexes[i].label&&this._vertexes[i].label.remove(),this._vertexes[i].marker.remove();return this},i.redo=function(){t.prototype.redo.call(this);var e=this._historyPointer-1;return this._vertexes[e]&&(this._vertexes[e].marker.getLayer()||(this._vertexes[e].label&&this._vertexes[e].label.addTo(this._measureMarkerLayer),this._vertexes[e].marker.addTo(this._measureMarkerLayer))),this},i._measure=function(t){var e,i,n=this.getMap();t instanceof op?e=n.computeGeometryLength(t):Array.isArray(t)&&(e=n.getProjection().measureLength(t)),this._lastMeasure=e,i="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];var r="";return this.options.metric&&(r+=e<1e3?e.toFixed(0)+i[0]:(e/1e3).toFixed(2)+i[1]),this.options.imperial&&(e*=3.2808399,r.length>0&&(r+="\n"),r+=e<5280?e.toFixed(0)+i[2]:(e/5280).toFixed(2)+i[3]),r},i._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},i._afterEnable=function(){this._registerMeasureEvents()},i._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},i._msOnDrawStart=function(t){var e=this.getMap(),i=e._pointToPrj(t.point2d),n=Zh(),r="distancetool_"+n,s="distancetool_markers_"+n;e.getLayer(r)?(this._measureLineLayer=e.getLayer(r),this._measureMarkerLayer=e.getLayer(s)):(this._measureLineLayer=new yg(r).addTo(e),this._measureMarkerLayer=new yg(s).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer);var o=new jp(t.coordinate,{symbol:this.options.vertexSymbol});o._setPrjCoordinates(i);var a="zh-CN"===this.options.language?"":"start",h=new cg(a,t.coordinate,this.options.labelOptions);h._setPrjCoordinates(i),this._lastVertex=h,this._addVertexMarker(o,h)},i._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var i=Lc(this.options.vertexSymbol);i.markerWidth/=2,i.markerHeight/=2,this._tailMarker=new jp(t.coordinate,{symbol:i}).addTo(this._measureMarkerLayer),this._tailLabel=new cg(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var n=this._geometry._getPrjCoordinates(),r=n[n.length-1];this._tailMarker.setCoordinates(t.coordinate),this._tailMarker._setPrjCoordinates(r),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(t.coordinate),this._tailLabel._setPrjCoordinates(r)},i._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},i._msOnDrawVertex=function(t){var e=this._geometry._getPrjCoordinates(),i=e[e.length-1],n=t.geometry,r=new jp(t.coordinate,{symbol:this.options.vertexSymbol}),s=this._measure(n),o=new cg(s,t.coordinate,this.options.labelOptions);this._addVertexMarker(r,o),o._setPrjCoordinates(i),r._setPrjCoordinates(i),this._lastVertex=o},i._addVertexMarker=function(t,e){this._vertexes||(this._vertexes=[]),void 0!==this._historyPointer&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:e,marker:t}),this._measureMarkerLayer.addGeometry(t),e&&this._measureMarkerLayer.addGeometry(e)},i._msOnDrawEnd=function(t){if(this._clearTailMarker(),t.geometry._getPrjCoordinates().length<2)return this._lastMeasure=0,void this._clearMeasureLayers();var e=this._lastVertex.getSize();e||(e=new cc(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),e.width);var i=t.geometry.copy();i._setPrjCoordinates(t.geometry._getPrjCoordinates()),i.addTo(this._measureLineLayer),this._lastMeasure=i.getLength()},i._addClearMarker=function(t,e,i){var n=this.options.clearButtonSymbol,r={markerDx:(n.markerDx||0)+i,textDx:(n.textDx||0)+i};Array.isArray(n)&&(r=n.map((function(t){return t?{markerDx:(t.markerDx||0)+i,textDx:(t.textDx||0)+i}:null}))),n=Lc(n,r);var s=new jp(t,{symbol:n}),o=this._measureLineLayer,a=this._measureMarkerLayer;s.on("click",(function(){return o.remove(),a.remove(),!1}),this),s.addTo(this._measureMarkerLayer),s._setPrjCoordinates(e)},i._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},i._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},e}(Mg);em.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});var im=function(t){function e(e){var i;return(i=t.call(this,e)||this)._measureLayers=[],i}Nh(e,t);var i=e.prototype;return i._measure=function(t){var e,i,n=this.getMap();t instanceof op?e=n.computeGeometryArea(t):Array.isArray(t)&&(e=n.getProjection().measureArea(t)),this._lastMeasure=e,i="zh-CN"===this.options.language?[" "," "," "," "]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var r="";if(this.options.metric&&(r+=e<1e6?e.toFixed(0)+i[0]:(e/1e6).toFixed(2)+i[1]),this.options.imperial){e*=3.2808399,r.length>0&&(r+="\n");var s=27878400;r+=e<s?e.toFixed(0)+i[2]:(e/s).toFixed(2)+i[3]}return r},i._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},i._msOnDrawVertex=function(t){var e=this.getMap()._pointToPrj(t.point2d),i=new jp(t.coordinate,{symbol:this.options.vertexSymbol});i._setPrjCoordinates(e),this._measure(t.geometry),this._lastVertex=i,this._addVertexMarker(i)},i._msOnDrawEnd=function(t){var e;if(this._clearTailMarker(),t.point2d)e=this.getMap()._pointToPrj(t.point2d);else{var i=t.geometry._getPrjCoordinates();i=i.slice(0,i.length-1),t.geometry._setPrjCoordinates(i),e=i[i.length-1]}if(t.geometry._getPrjCoordinates().length<3)return this._lastMeasure=0,void this._clearMeasureLayers();var n=this._measure(t.geometry),r=this.getMap().getProjection().unproject(e),s=new cg(n,r,this.options.labelOptions).addTo(this._measureMarkerLayer);s._setPrjCoordinates(e);var o=s.getSize();o||(o=new cc(10,10)),this._addClearMarker(r,e,o.width);var a=t.geometry.copy();a._setPrjCoordinates(t.geometry._getPrjCoordinates()),a.addTo(this._measureLineLayer),this._lastMeasure=a.getArea()},e}(em);im.mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}});var nm={create:function(t,e){var i=t.unproject(e[0]),n=new Kp(i,0);return n._setPrjCoordinates(e[0]),n},update:function(t,e,i){var n=i.getMap(),r=Array.isArray(e)?e[e.length-1]:e,s=t.unproject(r),o=n.computeLength(i.getCenter(),s);i.setRadius(o)},generate:function(t){return t}};Mg.registerMode("circle",Wa({clickLimit:2,action:["click","mousemove","click"]},nm)),Mg.registerMode("freeHandCircle",Wa({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},nm));var rm={create:function(t,e){var i=t.unproject(e[0]),n=new $p(i,0,0);return n._setPrjCoordinates(e[0]),n},update:function(t,e,i){var n=i.getMap(),r=i.getCenter(),s=Array.isArray(e)?e[e.length-1]:e,o=t.unproject(s),a=n.computeLength(r,new Gu({x:o.x,y:r.y})),h=n.computeLength(r,new Gu({x:r.x,y:o.y}));i.setWidth(2*a),i.setHeight(2*h)},generate:function(t){return t}};Mg.registerMode("ellipse",Wa({clickLimit:2,action:["click","mousemove","click"]},rm)),Mg.registerMode("freeHandEllipse",Wa({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},rm));var sm={create:function(t,e){var i=new zp([]);return i._firstClick=e[0],i},update:function(t,e,i,n){var r=i.getMap(),s=n.containerPoint,o=r._prjToContainerPoint(i._firstClick),a=[[o.x,o.y],[s.x,o.y],[s.x,s.y],[o.x,s.y]];i.setCoordinates(a.map((function(t){return r.containerPointToCoord(new Gh(t))}))),i._setPrjCoordinates(a.map((function(t){return r._containerPointToPrj(new Gh(t))})))},generate:function(t){return t}};Mg.registerMode("rectangle",Wa({clickLimit:2,action:["click","mousemove","click"]},sm)),Mg.registerMode("freeHandRectangle",Wa({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},sm)),Mg.registerMode("point",{clickLimit:1,action:["click","mousemove"],create:function(t,e){var i=t.unproject(e[0]),n=new jp(i);return n._setPrjCoordinates(e[0]),n},generate:function(t){return t},update:function(t,e,i){if(Array.isArray(e)&&(e=e[e.length-1]),!e)return i;var n=t.unproject(e);return i.setCoordinates(n),i}});var om={create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new Up(i);return n._setPrjCoordinates(e),n},update:function(t,e,i){var n,r=i.getSymbol();Array.isArray(e)?n=e:(n=i._getPrjCoordinates()).push(e);var s=n.map((function(e){return t.unproject(e)}));i.setCoordinates(s),i._setPrjCoordinates(n);var o=i.getLayer();if(o){var a=o.getGeometryById("polygon");if(!a&&n.length>=3){if(a=new zp([s],{id:"polygon"}),r){var h=Lc(r,{lineOpacity:0});a.setSymbol(h)}a.addTo(o)}a&&a._setPrjCoordinates(n)}},generate:function(t){var e=new zp(t.getCoordinates(),{symbol:t.getSymbol()});return e._setPrjCoordinates(t._getPrjCoordinates()),e._projCode=t._projCode,e}};Mg.registerMode("polygon",Wa({action:["click","mousemove","dblclick"]},om)),Mg.registerMode("freeHandPolygon",Wa({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},om));var am={create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new Up(i);return n._setPrjCoordinates(e),n},update:function(t,e,i){var n;Array.isArray(e)?n=e:(n=i._getPrjCoordinates()).push(e);var r=n.map((function(e){return t.unproject(e)}));i.setCoordinates(r),i._setPrjCoordinates(n)},generate:function(t){return t}};function hm(t){for(var e=t.tileInfo,i=[e.cols,e.rows],n=[],r=e.lods,s=0,o=r.length;s<o;s++)n.push(r[s].resolution);var a=t.fullExtent,h=e.origin,l=[1,-1,h.x,h.y];return delete a.spatialReference,{spatialReference:{resolutions:n,fullExtent:a},tileSystem:l,tileSize:i}}function lm(t,e){return void 0===e&&(e=[]),e.forEach((function(e){var i=e[0],n=e[1];t=t.replace(i,n)})),t}function cm(t){var e=t.projection,i=t.isArcgis,n=t.isGeoServer,r=t.isSuperMap,s=.0002645833333333333;return(i||n||r)&&(s=28e-5),e&&e.indexOf("4326")>-1&&(s=2.3767925226029154e-9,(i||r)&&(s=2.518101729011901e-9),n&&(s=2.51528279553466e-9)),s}Mg.registerMode("linestring",Wa({action:["click","mousemove","dblclick"]},am)),Mg.registerMode("freeHandLinestring",Wa({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},am)),Mg.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new ng(i);return n._setPrjCoordinates(e),n},update:am.update,generate:function(t){return t}}),Mg.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new sg(i);return n._setPrjCoordinates(e),n},update:am.update,generate:function(t){return t}}),Mg.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new rg(i);return n._setPrjCoordinates(e),n},update:am.update,generate:function(t){return t}}),Mg.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t,e){e=e[0];var i=t.unproject(e),n=new jp(i);return n._firstClick=e,n},update:function(t,e,i,n){var r=i.getMap(),s=r._prjToContainerPoint(i._firstClick),o=n.containerPoint;e=r._containerPointToPrj(new Gu(Math.min(s.x,o.x),Math.min(s.y,o.y)));var a=t.unproject(e);i.setCoordinates(a)._setPrjCoordinates(e),i.updateSymbol({markerWidth:Math.abs(s.x-o.x),markerHeight:Math.abs(s.y-o.y)})},generate:function(t){return t}}),np.loadArcgis=function(t,e,i){if(void 0===i&&(i={jsonp:!0}),Ya(t)&&"{"!==t.substring(0,1))vu.getJSON(t,(function(t,i){if(t)e(t);else{var n=hm(i);e(null,n)}}),i);else{Ya(t)&&(t=Xh(t));var n=hm(t);e(null,n)}return this};function um(t,e){var i=t.getElementsByTagName(e);if(i&&i.length)return i;var n="wmts:"+e;return t.getElementsByTagName(n)}function dm(t,e){for(var i=0;i<t.length;i++){var n=t[i];if((n=n.getElementsByTagName("ows:Identifier")[0])&&n.textContent===e)return t[i]}return null}function fm(t,e){void 0===e&&(e={});var i,n,r,s=um(t,"TileMatrix"),o=[],a=[],h=[],l=!1;if(!i){var c=t.getElementsByTagName("ows:SupportedCRS")[0];c&&(i=function(t){for(var e="",i=t.split(""),n=i.length-1;n>=0&&!isNaN(i[n]);n--)e=i[n]+e;return e}(i=(i=c.textContent).split("EPSG")[1]),i=function(t){var e=t.indexOf("EPSG")>-1?t:"EPSG:"+t;return lm(e,[["4490","4326"],["102100","3857"],["900913","3857"]])}(i))}n||(n=t.getElementsByTagName("ows:Identifier")[0])&&(n=n.textContent),e.projection=i;for(var u=1/0,d=0;d<s.length;d++){var f=s[d],p=f.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(p))?(r=p.substr(0,p.lastIndexOf(":")),p=(p=p.split(":"))[p.length-1],p=parseInt(p),l=!0,e.isGeoServer=!0):p=parseInt(p),u=Math.min(u,p);var g=um(f,"ScaleDenominator")[0].textContent,m=um(f,"TopLeftCorner")[0].textContent,_=um(f,"TileWidth")[0].textContent,v=um(f,"TileHeight")[0].textContent;if(0===h.length&&h.push(parseInt(_),parseInt(v)),0===a.length){var y=m.split(" ").filter((function(t){return""!==t})).map((function(t){return parseFloat(t)})),x=y[0],w=y[1];x>0?a.push(1,-1,w,x):a.push(1,-1,x,w)}var b=cm(e),M=parseFloat(g)*b;o.push(M)}if(u>0)for(var S=o[0],C=u-1;C>=0;C--)S*=2,o.splice(0,0,S);return{resolutions:o,tileSize:h,tileSystem:a,projection:i,TileMatrixSet:n,isGeoServer:l,levelStr:r}}np.loadWMTS=function(t,e,i){return void 0===i&&(i={jsonp:!0}),Ya(t)&&vu.get(t,(function(n,r){if(n)e(n);else{var s=function(t,e,i){null==i.isArcgis&&(i.isArcgis=t.indexOf("arcgis")>-1),null==i.isSuperMap&&(i.isSuperMap=t.indexOf("supermap")>-1);var n=(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("Contents")[0];if(!n)return[];var r=um(n,"Layer");if(!r.length)return[];for(var s=[],o=0,a=n.childNodes.length;o<a;o++)"TileMatrixSet"===n.childNodes[o].localName&&s.push(n.childNodes[o]);if(!s.length)return[];for(var h=[],l=0,c=r.length;l<c;l++){var u=r[l],d=u.querySelectorAll("Style")[0];d&&(d=d.getElementsByTagName("ows:Identifier")[0])&&(d=d.textContent);var f=u.getElementsByTagName("ows:Identifier")[0];f&&(f=f.textContent);var p=um(u,"TileMatrixSetLink");if(0!==p.length)for(var g=0,m=p.length;g<m;g++){var _=p[g];(_=um(_,"TileMatrixSet")[0])&&(_=_.textContent);var v=dm(s,_);if(v){var y=u.querySelectorAll("ResourceURL")[0],x="";y&&(x=y.attributes.template.value);var w=fm(v,i),b=w.resolutions,M=w.tileSize,S=w.tileSystem,C=w.projection,T=w.TileMatrixSet,P=w.isGeoServer,A=w.levelStr;x.length||(x=e.substr(0,e.lastIndexOf("?")),x+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var E=lm(x,[["{LAYER}",f],["{Layer}",f],["{layer}",f],["{STYLE}",d],["{Style}",d],["{style}",d],["{TileMatrixSet}",T],["{TileMatrix}",P?A+":{z}":"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",P?"image/png":"tiles"]]);h.push({tileSize:M,tileSystem:S,spatialReference:{resolutions:b,projection:C},urlTemplate:E,info:{layerName:f,TileMatrixSet:T,style:d,tileSize:M,tileSystem:S,resolutions:b,projection:C,urlTemplate:E}})}}}return h}(r,t,i);e(null,s)}}),i),this};var pm=function(t){function e(e){return t.call(this,e)||this}Nh(e,t);var i=e.prototype;return i.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},i.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},i.show=function(t){var e=this.getMap();if(!e)return this;this.options.visible=!0,t=t||this._coordinate||this._owner.getCenter();var i=this.isVisible();this._showBySymbolChange||this.fire("showstart");var n=this._getUIContainer();this._coordinate=t,this._removePrevDOM(),this._mapEventsOn||this._switchMapEvents("on");var r=this.__uiDOM=this.buildOn(e);if(r.eventsPropagation=this.options.eventsPropagation,this._observerDomSize(r),!r)return this._showBySymbolChange||this.fire("showend"),this;this._measureSize(r),this._singleton()&&(r._uiComponent=this,e[this._uiDomKey()]=r),this._setPosition(),r.style[Uc]=null,n.appendChild(r);var s=this._getAnimation();if(i&&(s.ok=!1),s.ok&&(s.fade&&(r.style.opacity=0),s.scale)){if(this.getTransformOrigin){var o=this.getTransformOrigin();r.style[Bc]=o}r.style[jc]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(r.style.display=""),this.options.eventsToStop&&uu(r,this.options.eventsToStop,Yc),this.options.autoPan&&this._autoPan();var a=s.transition;return s.ok&&a&&(r.offsetHeight,a&&(r.style[Uc]=a),s.fade&&(r.style.opacity=1),s.scale&&(r.style[jc]=this._toCSSTranslate(this._pos)+" scale(1)")),this._showBySymbolChange||this.fire("showend"),this},i.hide=function(){var t=this;if(!this.getDOM())return this;this.options.visible=!1;var e=this._getAnimation(),i=this.getDOM();return this.options.animationOnHide||(e.ok=!1),e.ok?(i.offsetHeight,i.style[Uc]=e.transition,setTimeout((function(){i.style.display="none",t.fire("hide")}),this.options.animationDuration)):(i.style.display="none",this.fire("hide")),e.fade&&(i.style.opacity=0),e.scale&&(i.style[jc]=this._toCSSTranslate(this._pos)+" scale(0)"),this._switchMapEvents("off"),this},i.isVisible=function(){if(!this.options.visible)return!1;var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},i.remove=function(){return delete this._mapEventsOn,this._owner?(this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this):this},i.getSize=function(){return this._domContentRect&&this._size&&(this._size.width=this._domContentRect.width,this._size.height=this._domContentRect.height),this._size?this._size.copy():null},i.getOwner=function(){return this._owner},i.getDOM=function(){return this.__uiDOM},i._roundPoint=function(t){return this.options.roundPoint&&(t=t._round()),t},i.getPosition=function(){if(!this.getMap())return null;var t=this._roundPoint(this._getViewPoint());if(this.getOffset){var e=this._roundPoint(this.getOffset());e&&t._add(e)}return t},i._getAnimation=function(){for(var t={fade:!1,scale:!1},e=this.options.animation?this.options.animation.split(","):[],i=0;i<e.length;i++){var n=uc(e[i]);"fade"===n?t.fade=!0:"scale"===n&&(t.scale=!0)}var r=null;return t.fade&&(r="opacity "+this.options.animationDuration+"ms"),t.scale&&(r=r?r+",":"",r+=jc+" "+this.options.animationDuration+"ms"),t.transition=r,t.ok=null!==r,t},i._getViewPoint=function(){var t=0,e=this._coordinate||{};qa(e.z)?t=e.z:this._owner&&this._owner.getAltitude&&(t=this._owner.getAltitude()||0);var i=this._meterToPoint(this._coordinate,t);return this.getMap().coordToViewPoint(this._coordinate,void 0,i)._add(this.options.dx,this.options.dy)},i._meterToPoint=function(t,e){var i=this.getMap();return i.altitudeToPoint(e,i._getResolution())*$h(e)},i._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(!t.isMoving()){var i=this._getViewPoint()._round(),n=t.width,r=t.height,s=t.viewPointToContainerPoint(i),o=this.getOffset(),a=s.add(o),h=t._viewPointToPrj(i),l=parseInt(e.clientWidth),c=parseInt(e.clientHeight),u=0,d=0;if(a.x<0?u=50-a.x:a.x+l>n&&(u=-(a.x+l-n)-50),a.y-c<0?d=Math.abs(a.y-c)+50:a.y+c>r&&(d=r-(a.y+c)-50),l>=n&&(u=n/2-s.x),0!==d||0!==u){var f=s.add(u,d),p=t._containerPointToPoint(f)._sub(t._prjToPoint(t._getPrjCenter())),g=t._pointToPrj(t._prjToPoint(h).sub(p));t._panAnimation(g)}}},i._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute";var i=t.style.bottom?"bottom":"top";if(t.style.display="",e.appendChild(t),t.getBoundingClientRect){var n=t.getBoundingClientRect();this._size=new cc(n.width,n.height)}else this._size=new cc(t.clientWidth,t.clientHeight);return t.style.display="none",t.style.left="0px",t.style[i]="0px",this._size},i._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),i=this._uiDomKey();if(e[i]){t&&du(e[i],t,Yc);var n=e[i]._uiComponent;n&&n!==this&&n.isVisible()&&n.fire("hide"),Wc(e[i]),n&&!this.hideDom&&n._switchMapEvents("off"),delete e[i]}delete this.__uiDOM}else this.__uiDOM&&(t&&du(this.__uiDOM,t,Yc),Wc(this.__uiDOM),delete this.__uiDOM);this._resizeObserver&&(this._resizeObserver.disconnect(),delete this._resizeObserver,delete this._domContentRect)},i._uiDomKey=function(){return"__ui_"+this._getClassName()},i._singleton=function(){return this.options.single},i._getUIContainer=function(){return this.getMap()._panels.ui},i._getClassName=function(){return"UIComponent"},i._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var i=this._getDefaultEvents();if(this.getEvents&&Wa(i,this.getEvents()),i)for(var n in i)i.hasOwnProperty(n)&&e[t](n,i[n],this)}},i._switchEvents=function(t){var e=this._getOwnerEvents();if(this._owner)for(var i in e)e.hasOwnProperty(i)&&this._owner[t](i,e[i],this)},i._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,moveend:this.onMoving,resize:this.onResize}},i._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof op&&(t.positionchange=this.onGeometryPositionChange,t.symbolchange=this._updatePosition),this.getOwnerEvents&&Wa(t,this.getOwnerEvents()),t},i.onGeometryPositionChange=function(t){this._owner&&this.isVisible()&&(this._showBySymbolChange=!0,this.show(t.target.getCenter()),delete this._showBySymbolChange)},i.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},i.onEvent=function(){this.isVisible()&&this._updatePosition()},i.onZoomEnd=function(){this.isVisible()&&this._setPosition()},i.onResize=function(){this.isVisible()&&this._setPosition()},i.onDomSizeChange=function(){this.isVisible()&&this._setPosition()},i._updatePosition=function(){return this.getMap()?(this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this)),this):this},i._setPosition=function(){var t=this.getDOM();if(t){t.style[Uc]=null;var e=this.getPosition();this._pos=e,t.style[jc]=this._toCSSTranslate(e)+" scale(1)"}},i._toCSSTranslate=function(t){if(!t)return"";if(zh.any3d){var e=this.getMap(),i=e?e.getBearing():0,n=e?e.getPitch():0,r="";return this.options.pitchWithMap&&n&&(r+=" rotateX("+Math.round(n)+"deg)"),this.options.rotateWithMap&&i&&(r+=" rotateZ("+Math.round(-i)+"deg)"),"translate3d("+t.x+"px,"+t.y+"px, 0px)"+r}return"translate("+t.x+"px,"+t.y+"px)"},i._observerDomSize=function(t){var e=this;return t&&zh.resizeObserver&&!this._resizeObserver?(this._resizeObserver=new ResizeObserver((function(t){t.length?e._domContentRect=t[0].contentRect:delete e._domContentRect,e.onDomSizeChange&&e.onDomSizeChange()})),this._resizeObserver.observe(t),this):this},i.isSupportZoomFilter=function(){return!1},e.isSupport=function(t){return!!(t&&Qa(t.on)&&Qa(t.off)&&Qa(t.getCenter))},e}(Eu(Ou));pm.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!1,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0,roundPoint:!1});var gm="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",mm=function(t){function e(e,i){var n;return(n=t.call(this,i)||this)._markerCoord=new Gu(e),n}Nh(e,t);var i=e.prototype;return i._getClassName=function(){return"UIMarker"},i.setCoordinates=function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition()),this},i.getCoordinates=function(){return this._markerCoord},i.getCenter=function(){return this.getCoordinates()},i.getAltitude=function(){var t=this.getCoordinates()||{};return qa(t.z)?t.z:this.options.altitude||0},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},i.getContent=function(){return this.options.content},i.onAdd=function(){this.show()},i.show=function(){return t.prototype.show.call(this,this._markerCoord)},i.flash=function(t,e,i,n){return _l.call(this,t,e,i,n)},i.buildOn=function(){var t,e=this.options.content,i=Ya(e);return i||Qa(e)?(t=Hc("div"),i?t.innerHTML=this.options.content:e.bind(this)(t)):t=this.options.content,this.options.containerClass&&(t.className=this.options.containerClass),this._registerDOMEvents(t),t},i.getOffset=function(){var t=this.getSize();return new Gh(-t.width/2,-t.height/2)},i.getTransformOrigin=function(){return"center center"},i.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},i.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},i._registerDOMEvents=function(t){uu(t,gm,this._onDomEvents,this)},i._onDomEvents=function(t){var e=this.getMap()._parseEvent(t,t.type),i=t.type;if("mousedown"===i&&(this._mousedownEvent=t),"mouseup"===i&&(this._mouseupEvent=t),("click"!==i||!this._mouseClickPositionIsChange())&&("touchstart"===i&&(this._touchstartTime=Va()),this.fire(t.type,e),"touchend"===i&&zh.touch)){var n=this.getMap().options.clickTimeThreshold||280;Va()-this._touchstartTime<n&&this._onDomEvents(Wa({},t,{type:"click"}))}},i._removeDOMEvents=function(t){du(t,gm,this._onDomEvents)},i._mouseClickPositionIsChange=function(){var t=this._mousedownEvent||{},e=t.x,i=t.y,n=this._mouseupEvent||{},r=n.x,s=n.y;return e!==r||i!==s},i._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),i=this.getSize(),n=i.width,r=i.height;return[t.containerPointToCoordinate(e.add(-n/2,0)),t.containerPointToCoordinate(e.add(n/2,0)),t.containerPointToCoordinate(e.add(0,r/2)),t.containerPointToCoordinate(e.add(0,-r/2))]},i._getViewPoint=function(){var t=0;if(this._owner){var e=this.getAltitude();e>0&&(t=this._meterToPoint(this._coordinate,e))}return this.getMap().coordToViewPoint(this._coordinate,void 0,t)._add(this.options.dx,this.options.dy)},i._getDefaultEvents=function(){return Wa({},t.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},i._setPosition=function(){this.onZoomFilter(),t.prototype._setPosition.call(this)},i.onZoomFilter=function(){var t=this.getDOM();t&&(this.isVisible()||"none"===t.style.display?this.isVisible()&&"none"===t.style.display&&(t.style.display=""):t.style.display="none")},i.isVisible=function(){var t=this.getMap();if(!t)return!1;if(!this.options.visible)return!1;var e=t.getZoom(),i=this.options,n=i.minZoom,r=i.maxZoom;return!(!Za(n)&&e<n||!Za(r)&&e>r)&&(this.getDOM()&&!0)},i.isSupportZoomFilter=function(){return!0},e}(Nu(pm));mm.mergeOptions({containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null});var _m=zh.touch?"touchstart mousedown":"mousedown",vm=function(t){function e(e){return t.call(this,e)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on(_m,this._startDrag,this)},i.removeHooks=function(){this.target.off(_m,this._startDrag,this)},i._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},i._prepareDragHandler=function(){this._dragHandler=new Uu(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},i._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},i._onMouseDown=function(t){Yc(t.domEvent)},i._dragging=function(t){var e=this.target,i=e.getMap()._parseEvent(t.domEvent),n=i.domEvent;if(!(n.touches&&n.touches.length>1))if(this._isDragging){var r=i.coordinate,s=i.containerPoint;this._lastCoord||(this._lastCoord=r),this._lastPoint||(this._lastPoint=s);var o=r.sub(this._lastCoord),a=s.sub(this._lastPoint);this._lastCoord=r,this._lastPoint=s,this.target.setCoordinates(this.target.getCoordinates().add(o)),i.coordOffset=o,i.pointOffset=a,e.fire("dragging",i)}else this._isDragging=!0},i._endDrag=function(t){var e=this.target,i=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,i){var n=i._parseEvent(t.domEvent);e&&e._mouseClickPositionIsChange&&e._mouseClickPositionIsChange()&&e.fire("dragend",n)}},i.isDragging=function(){return!!this._isDragging},e}(Ru);mm.addInitHook("addHandler","draggable",vm);var ym=/\{ *([\w_]+) *\}/g,xm={containerClass:"maptalks-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:"auto",minHeight:120,custom:!1,title:null,content:null,enableTemplate:!1},wm=new cc(0,0),bm=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i._getClassName=function(){return"InfoWindow"},i.addTo=function(e){return e instanceof op&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},i.getContent=function(){return this.options.content},i.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},i.getTitle=function(){return this.options.title},i.buildOn=function(){var t=Qa(this.options.content),e=Ya(this.options.content);if(this.options.custom){if(e||t){var i=Hc("div");return e?(i.innerHTML=this.options.content,this._replaceTemplate(i)):this.options.content.bind(this)(i),i}return this._replaceTemplate(this.options.content),this.options.content}var n=Hc("div");this.options.containerClass&&(n.className=this.options.containerClass);var r=this._getWindowWidth();n.style.width=qa(r)?r+"px":"auto",n.style.bottom="0px";var s='<em class="maptalks-ico"></em>';this.options.title&&(s+="<h2>"+this.options.title+"</h2>"),s+='<a href="javascript:void(0);" class="maptalks-close"></a><div class="maptalks-msgContent"></div>',n.innerHTML=s,this._replaceTemplate(n);var o=n.querySelector(".maptalks-msgContent");return e||t?e?o.innerHTML=this.options.content:this.options.content.bind(this)(o):o.appendChild(this.options.content),this._onCloseBtnClick=this.hide.bind(this),Zc(n.querySelector(".maptalks-close"),"click touchend",this._onCloseBtnClick),t||this._replaceTemplate(o),n},i._replaceTemplate=function(t){if(this.options.enableTemplate&&this._owner&&this._owner.getProperties&&t&&t.innerHTML){var e=this._owner.getProperties()||{};if(Ja(e)){var i=t.innerHTML;t.innerHTML=i.replace(ym,(function(t,i){return e[i]}))}}return this},i.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},i.getOffset=function(){var t=this.getSize(),e=new Gh(-t.width/2,0);this.options.custom?e._sub(0,t.height):e._sub(4,12);var i=this.getOwner();if(i instanceof jp||i instanceof Zp){var n,r;if(i instanceof jp)n=i._getPainter(),r=i.getSize();else{var s=i.getGeometries();if(!s||!s.length)return e;n=s[0]._getPainter(),r=s[0].getSize()}if(r||(r=wm),n){var o=n.getFixedExtent();e._add(o.xmax-r.width/2,o.ymin)}else e._add(0,-r.height)}return e},i.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},i.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},i.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},i.onRemove=function(){this.onDomRemove()},i.onDomRemove=function(){this._onCloseBtnClick&&(qc(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},i._onAutoOpen=function(t){var e=this,i=this.getOwner();setTimeout((function(){i instanceof jp||i instanceof pm?e.show(i.getCoordinates()):i instanceof Zp?e.show(i.findClosest(t.coordinate)):i instanceof Up||i instanceof Xp?(e.getMap().getScale()>=8&&(t.coordinate=e._rectifyMouseCoordinte(i,t.coordinate)),e.show(t.coordinate)):e.show(t.coordinate)}),1)},i._rectifyMouseCoordinte=function(t,e){var i=this;return t instanceof Up?this._rectifyLineStringMouseCoordinate(t,e).coordinate:t instanceof Xp?t.getGeometries().map((function(t){return i._rectifyLineStringMouseCoordinate(t,e)})).sort((function(t,e){return t.dis-e.dis}))[0].coordinate:e},i._rectifyLineStringMouseCoordinate=function(t,e){for(var i=this,n=t.getCoordinates().map((function(t){return i.getMap().coordToContainerPoint(t)})),r=this.getMap().coordToContainerPoint(e),s=1/0,o=-1,a=0,h=n.length;a<h;a++){var l=n[a],c=r.distanceTo(l);c<s&&(s=c,o=a)}var u=[];0===o?u.push(n[0],n[1]):o===n.length-1?u.push(n[o-1],n[o]):u.push(n[o-1],n[o],n[o+1]);for(var d=[],f=this.getMap().getSize(),p=f.width,g=f.height,m=0,_=u.length-1;m<_;m++){var v=u[m],y=u[m+1];if(v.x===y.x)for(var x=Math.max(0,Math.min(v.y,y.y)),w=Math.min(g,Math.max(v.y,y.y)),b=x;b<=w;b++)d.push(new Gh(v.x,b));else for(var M=(y.y-v.y)/(y.x-v.x),S=Math.max(0,Math.min(v.x,y.x)),C=Math.min(p,Math.max(v.x,y.x)),T=S;T<=C;T++){var P=M*(T-v.x)+v.y;d.push(new Gh(T,P))}}for(var A=1/0,E=-1,L=0,R=d.length;L<R;L++){var O=d[L],D=r.distanceTo(O);D<A&&(A=D,E=L)}return{dis:A,coordinate:E<0?e:this.getMap().containerPointToCoord(d[E])}},i._getWindowWidth=function(){var t=xm.width,e=this.options.width;return e||(e=t),e},e}(pm);bm.mergeOptions(xm);var Mm="remove hide shapechange positionchange dragend animatestart",Sm=function(t){Nh(i,t);var e=i.prototype;function i(e,i){var n;return void 0===i&&(i={}),(n=t.call(this,i)||this)._content=e,n}return e._getClassName=function(){return"ToolTip"},e.addTo=function(e){if(i.isSupport(e))return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),e.on(Mm,this.hideDom,this),t.prototype.addTo.call(this,e);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},e.setStyle=function(t){return this.options.containerClass=t,this},e.getStyle=function(){return this.options.containerClass},e.getContent=function(){return this._content},e.buildOn=function(){var t=Hc("div"),e=this.options||{};e.height&&(t.style.height=e.height+"px"),e.width&&(t.style.width=e.width+"px");var i=e.containerClass||e.cssName;return!i&&e.height&&(t.style.lineHeight=e.height+"px"),Qa(this._content)?this._content.bind(this)(t):t.innerHTML='<div class="'+i+'">'+this._content+"</div>",t},e.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM(),this._switchMapEvents("off")},e.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var i=this.getMap();if(i){var n=i.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(n):this._timeout=setTimeout((function(){i&&e.show(n)}),this.options.showTimeout)}},e.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mouseover",this.onMouseOver,this),this._owner.off("mouseout",this.onMouseOut,this),this._owner.off(Mm,this.hideDom,this))},e.hideDom=function(){return this.hide()},e.onEvent=function(){return t.prototype.onEvent.call(this),this.hideDom(),this},e._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},i}(pm);Sm.mergeOptions({width:0,height:0,animation:"fade",containerClass:"maptalks-tooltip",showTimeout:400});var Cm=function(t){function e(e){return t.call(this,e)||this}Nh(e,t);var i=e.prototype;return i._getClassName=function(){return"Menu"},i.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,this._owner=t,pm.prototype.addTo.apply(this,arguments)},i.setItems=function(t){return this.options.items=t,this},i.getItems=function(){return this.options.items||[]},i.buildOn=function(){if(this.options.custom){if(Ya(this.options.items)){var t=Hc("div");return t.innerHTML=this.options.items,t}return this.options.items}var e=Hc("div");this.options.containerClass&&nu(e,this.options.containerClass),e.style.width=this._getMenuWidth()+"px";var i=this._createMenuItemDom();return e.appendChild(i),uu(e,"contextmenu",Jc),e},i.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),i=this.getSize(),n=0,r=0;return e.x+i.width>t.width&&(n=-i.width),e.y+i.height>t.height&&(r=-i.height),new Gh(n,r)},i.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},i.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},i._createMenuItemDom=function(){var t=this,e=this.getMap(),i=Hc("ul");nu(i,"maptalks-menu-items");var n,r,s=this.getItems();function o(i){return function(n){var r=e._parseEvent(n,"click");r.target=t,r.owner=t._owner,r.index=i,!1!==this._callback(r)&&(t.hide(),t._owner&&t._owner.fire("closemenu"))}}for(var a=0,h=s.length;a<h;a++){if("-"===(n=s[a])||"_"===n)nu(r=Hc("li"),"maptalks-menu-splitter");else{r=Hc("li");var l=n.item;Qa(l)&&(l=l({owner:this._owner,index:a})),r.innerHTML=l,r._callback=n.click,uu(r,"click",o(a))}i.appendChild(r)}var c=this.options.maxHeight||0;return c>0&&eu(i,"max-height: "+c+"px; overflow-y: auto;"),i},i._getMenuWidth=function(){return this.options.width||160},e}(pm);Cm.mergeOptions({containerClass:"maptalks-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var Tm={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu.setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},getMenu:function(){return this._menu},openMenu:function(t){var e=this instanceof yp?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(),this._menu.show(t)),this.fire("openmenu",{coordinate:t}),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this.fire("closemenu",{}),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this.fire("removemenu",{}),this},_bindMenu:function(){return this._menuOptions?(this._menu=new Cm(this._menuOptions),this._menu.addTo(this),this):this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.openMenu(t.coordinate),!1}};yp.include(Tm),op.include(Tm);var Pm=Object.freeze({UIComponent:pm,UIMarker:mm,InfoWindow:bm,ToolTip:Sm,Menuable:Tm,Menu:Cm}),Am=function(t){function e(e){return e&&e.position&&!Ya(e.position)&&(e.position=Wa({},e.position)),t.call(this,e)||this}Nh(e,t);var i=e.prototype;return i.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t._panels.control;return this.__ctrlContainer=Hc("div"),eu(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},i.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},i.getMap=function(){return this._map},i.getPosition=function(){return Wa({},this._parse(this.options.position))},i.setPosition=function(t){return Ya(t)?this.options.position=t:this.options.position=Wa({},t),this._updatePosition(),this},i.getContainerPoint=function(){var t,e,i=this.getPosition(),n=this.getMap().getSize();return Za(i.left)?Za(i.right)||(t=n.width-parseInt(i.right)):t=parseInt(i.left),Za(i.top)?Za(i.bottom)||(e=n.height-parseInt(i.bottom)):e=parseInt(i.top),new Gh(t,e)},i.getContainer=function(){return this.__ctrlContainer},i.getDOM=function(){return this._controlDom},i.show=function(){return this.__ctrlContainer.style.display="",this},i.hide=function(){return this.__ctrlContainer.style.display="none",this},i.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},i.remove=function(){return this._map?(Wc(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},i._parse=function(t){var i=t;return Ya(t)&&(i=e.positions[i]),i},i._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),t)t.hasOwnProperty(e)&&(t[e]=parseInt(t[e]),this.__ctrlContainer.style[e]=t[e]+"px");this.fire("positionchange",{position:Wa({},t)})},e}(Eu(Ou));Am.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},yp.mergeOptions({control:!0}),yp.include({addControl:function(t){return this._containerDOM.getContext||t.addTo(this),this},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var Em="addlayer removelayer setbaselayer baselayerremove",Lm=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(){return this._attributionContainer=Hc("div"),this._attributionContainer.className="maptalks-attribution",this._update(),this._attributionContainer},i.onAdd=function(){this.getMap().on(Em,this._update,this)},i.onRemove=function(){this.getMap().off(Em,this._update,this)},i._update=function(){var t=this.getMap();if(t){var e=t._getLayers((function(t){return t.options.attribution})).reverse().map((function(t){return t.options.attribution})),i=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+i+"</span>"}},e}(Am);Lm.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>'}),yp.mergeOptions({attribution:!0}),yp.addOnLoadHook((function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new Lm(t),this.addControl(this.attributionControl))}));var Rm=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(){var t=this.container=Hc("div",this.options.containerClass),e=this.panel=Hc("div","panel"),i=this.button=Hc("button");return t.appendChild(i),t.appendChild(e),t},i.onAdd=function(){uu(this.button,"mouseover",this._show,this),uu(this.panel,"mouseleave",this._hide,this),uu(this.getMap(),"click",this._hide,this)},i.onRemove=function(){this.panel&&(du(this.button,"mouseover",this._show),du(this.panel,"mouseleave",this._hide),du(this.getMap(),"click",this._hide),Wc(this.panel),Wc(this.button),delete this.panel,delete this.button,delete this.container)},i._show=function(){iu(this.container,"shown")||(nu(this.container,"shown"),this._createPanel())},i._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||ru(this.container,this.options.containerClass)},i._createPanel=function(){this.panel.innerHTML="";var t=Hc("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},i._renderLayers=function(t,e){var i=this,n=t.getBaseLayer(),r=t.getLayers(),s=r.length;if(n){var o=n.layers||[n],a=Hc("li","group"),h=Hc("ul"),l=Hc("label");l.innerHTML=this.options.baseTitle,a.appendChild(l);for(var c=0,u=o.length;c<u;c++){var d=o[c];this._isExcluded(d)&&(h.appendChild(this._renderLayer(o[c],!0)),a.appendChild(h),e.appendChild(a))}}if(s){var f=Hc("li","group"),p=Hc("ul"),g=Hc("label"),m=Hc("input");m.type="checkbox",m.checked=!0,g.innerHTML=this.options.overlayTitle,f.appendChild(m),f.appendChild(g);for(var _=function(t){var e=t.target.checked,i=t.target.parentNode;if(i){var n=i.getElementsByTagName("ul")[0];if(n){var r=function(t){var i=t._layer;i&&i[e?"show":"hide"]()},s=function(t){var i=t._layer,n=t.childNodes[0];n&&(n.checked=e),i&&i[e?"show":"hide"]()};r(i),n.childNodes.forEach((function(t){s(t);var e=t.getElementsByTagName("ul")[0];e&&(r(t),e.childNodes.forEach((function(t){s(t)})))}))}}},v=0;v<s;v++){var y=r[v];this._isExcluded(y)&&(y.getLayers?function(){var t=Hc("li","group"),e=Hc("ul"),n=Hc("label"),r=Hc("input");n.innerHTML=y.getId(),r.type="checkbox",r.checked=y.isVisible(),r.onchange=_,t.appendChild(r),t.appendChild(n),t.appendChild(e),t._layer=y,p.appendChild(t),(y.getLayers()||[]).forEach((function(t){e.appendChild(i._renderLayer(t,!1,r.checked))}))}():p.appendChild(this._renderLayer(y)),y&&!y.isVisible()&&(m.checked=!1))}f.appendChild(p),e.appendChild(f),m.onchange=_}},i._isExcluded=function(t){var e=t.getId(),i=this.options.excludeLayers;return!(i.length&&i.indexOf(e)>=0)},i._renderLayer=function(t,e,i){var n=this;void 0===i&&(i=!0);var r=Hc("li","layer"),s=Hc("label"),o=Hc("input"),a=this.getMap(),h=t.options.visible;t.options.visible=!0;var l=t.isVisible();return t.options.visible=h,r.className="layer",e?(o.type="radio",o.name="base"):o.type="checkbox",o.checked=h&&l,i||(o.checked=!1),l||o.setAttribute("disabled","disabled"),o.onchange=function(e){if("radio"===e.target.type){var i=a.getBaseLayer(),r=i.layers;if(r)for(var s=0,o=r.length;s<o;s++){var h=r[s];h[h===t?"show":"hide"]()}else i.isVisible()||i.show();a._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();n.fire("layerchange",{target:t})},r.appendChild(o),s.innerHTML=t.getId(),r.appendChild(s),r._layer=t,r},e}(Am);Rm.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),yp.mergeOptions({layerSwitcherControl:!1}),yp.addOnLoadHook((function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new Rm(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))}));var Om=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=Hc("div"),i=this.mapContainer=Hc("div");i.style.width=t[0]+"px",i.style.height=t[1]+"px",i.className=this.options.containerClass;var n=this.button=Hc("div");return n.className=this.options.buttonClass,e.appendChild(i),e.appendChild(n),e},i.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),uu(this.button,"click",this._onButtonClick,this),this._updateButtonText()},i.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),du(this.button,"click",this._onButtonClick)},i.maxmize=function(){var t=this.options.size,e=this.mapContainer;return e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview(),this},i.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;return t.style.width="0px",t.style.height="0px",this},i.getOverviewMap=function(){return this._overview},i._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},i._updateButtonText=function(){this._overview?this.button.innerHTML="-":this.button.innerHTML="+"},i._createOverview=function(){var t=this.getMap(),e=this.mapContainer,i=t.config();Wa(i,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new yp(e,i),this._updateBaseLayer(),this._perspective=new zp(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new yg("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},i._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),i=t.getMinZoom(),n=this.options.level;if(n>0){for(var r=n;r>0;r--)if(e-r>=i)return e-r}else for(var s=n;s<0;s++)if(e-s>=i)return e-s;return e},i._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},i._getPerspectiveCoords=function(){var t=this.getMap(),e=t.getProjection();return t.getContainerExtent().toArray().map((function(i){if(e){var n=t._containerPointToPrj(i);return t._fixPrjOnWorldWide(n),e.unproject(n)}return t.containerPointToCoordinate(i)}))},i._update=function(){if(this._overview){$c(this._overview._containerDOM);var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},i._updateSpatialReference=function(){if(this._overview){var t=this.getMap().options.spatialReference;this._overview.setSpatialReference(t)}},i._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,i=0;if(e)for(var n=0,r=e.length;n<r;n++){if(e[n].isVisible()){i=n;break}}var s=t.toJSON(),o=null;e?(o=s.layers[i].options).visible=!0:o=s.options,this._overview.setMinZoom(o.minZoom||null).setMaxZoom(o.maxZoom||null),delete o.minZoom,delete o.maxZoom,delete s.options.canvas,s.options.visible=!0,s.options.renderer="canvas";var a=hp.fromJSON(s);for(var h in t)Qa(t[h])&&t.hasOwnProperty(h)&&t[h]!==t.constructor.prototype[h]&&(a[h]=t[h]);this._overview.setBaseLayer(a)}else this._overview.setBaseLayer(null)}},e}(Am);Om.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),yp.mergeOptions({overviewControl:!1}),yp.addOnLoadHook((function(){this.options.overviewControl&&(this.overviewControl=new Om(this.options.overviewControl),this.addControl(this.overviewControl))}));var Dm=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(){var t;if(this.options.custom)Ya(this.options.content)?(t=Hc("div")).innerHTML=this.options.content:t=this.options.content;else{if(t=Hc("div","maptalks-panel"),this.options.closeButton){var e=Hc("a","maptalks-close");e.href="javascript:;",e.onclick=function(){t.style.display="none"},t.appendChild(e)}var i=Hc("div","maptalks-panel-content");i.innerHTML=this.options.content,t.appendChild(i)}return this.draggable=new Uu(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},i.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),Am.prototype.update.call(this)},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},i.getContent=function(){return this.options.content},i._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},i._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=Wa({},this.getPosition()),this.fire("dragstart",t)},i._onDragging=function(t){var e=t.mousePos.sub(this._startPos),i=this._startPosition,n=this.getPosition();Za(n.top)||(n.top=parseInt(i.top)+e.y),Za(n.bottom)||(n.bottom=parseInt(i.bottom)-e.y),Za(n.left)||(n.left=parseInt(i.left)+e.x),Za(n.right)||(n.right=parseInt(i.right)-e.x),this.setPosition(n),this.fire("dragging",t)},i._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},i._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),i=this.getDOM(),n=parseInt(i.clientWidth),r=parseInt(i.clientHeight);return[t.containerPointToCoordinate(e.add(n/2,0)),t.containerPointToCoordinate(e.add(n,r/2)),t.containerPointToCoordinate(e.add(n/2,r)),t.containerPointToCoordinate(e.add(0,r/2))]},e}(Am);Dm.mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var Im=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(t){return this._map=t,this._scaleContainer=Hc("div",this.options.containerClass),this._addScales(),t.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},i.onRemove=function(){this.getMap().off("zoomend",this._update,this)},i._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=Vc("div",this.options.containerClass?null:t,this._scaleContainer)),this.options.imperial&&(this._iScale=Vc("div",this.options.containerClass?null:t,this._scaleContainer))},i._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},i._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},i._updateMetric=function(t){var e=this._getRoundNum(t),i=e<1e3?e+" m":e/1e3+" km";this._updateScale(this._mScale,i,e/t)},i._updateImperial=function(t){var e,i,n,r=3.2808399*t;r>5280?(e=r/5280,i=this._getRoundNum(e),this._updateScale(this._iScale,i+" mile",i/e)):(n=this._getRoundNum(r),this._updateScale(this._iScale,n+" feet",n/r))},i._updateScale=function(t,e,i){t.style.width=Math.round(this.options.maxWidth*i)+"px",t.innerHTML=e},i._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return e*(i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1)},e}(Am);Im.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),yp.mergeOptions({scaleControl:!1}),yp.addOnLoadHook((function(){this.options.scaleControl&&(this.scaleControl=new Im(this.options.scaleControl),this.addControl(this.scaleControl))}));var km=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(t){this._map=t;var e=Hc("div"),i=Hc("ul","maptalks-toolbar-hx");e.appendChild(i),this.options.vertical?nu(e,"maptalks-toolbar-vertical"):nu(e,"maptalks-toolbar-horizonal");var n=this;function r(t,e,i,r){var s=n._getItems()[e];return function(n){return Yc(n),t({target:s,index:e,childIndex:i,dom:r})}}var s=this.options.items;if(rl(s))for(var o=0,a=s.length;o<a;o++){var h=s[o],l=Hc("li");if(28!==this.options.height&&(l.style.lineHeight=this.options.height+"px"),l.style.height=this.options.height+"px",l.style.cursor="pointer",au(h.item)){l.style.textAlign="center";var c=hu("div",h.item);l.innerHTML='<div style="margin-top:'+(this.options.height-c.height)/2+'px;">'+h.item+"</div>"}else l.innerHTML=h.item;if(h.click&&uu(l,"click",r(h.click,o,null,l)),rl(h.children)){var u=this._createDropMenu(o);l.appendChild(u),l._menu=u,uu(l,"mouseover",(function(){this._menu.style.display=""})),uu(l,"mouseout",(function(){this._menu.style.display="none"}))}i.appendChild(l)}return e},i._createDropMenu=function(t){var e=this;function i(t,i,n){var r=e._getItems()[i].children[n];return function(e){return Yc(e),t({target:r,index:i,childIndex:n})}}var n=Hc("div","maptalks-dropMenu"),r=this._getItems(),s=r.length,o=Hc("ul"),a=r[t].children;t===s-1&&a&&(n.style.cssText="right: 0px;",o.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(o.style.bottom=0)),n.appendChild(Hc("em","maptalks-ico"));for(var h=0,l=0,c=a.length;l<c;l++){var u=_c(a[l].item,"12px");u.width>h&&(h=u.width)}for(var d=0,f=a.length;d<f;d++){var p=a[d],g=Hc("li");g.innerHTML='<a href="javascript:;">'+p.item+"</a>",g.style.cursor="pointer",g.style.width=h+24+"px",uu(g.childNodes[0],"click",i(p.click,t,d)),o.appendChild(g)}if(this.options.vertical){var m=h<95?95:h;this.options.reverseMenu?n.style.right=-(m+20)+"px":n.style.left=-(m+20)+"px"}else this.options.reverseMenu?n.style.bottom="28px":n.style.top="28px";return n.appendChild(o),n.style.display="none",n},i._getItems=function(){return this.options.items||[]},e}(Am);km.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:{}});var zm=10,Nm=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.buildOn=function(t){var e=this.options,i=Hc("div","maptalks-zoom");if(e.zoomLevel){var n=Hc("span","maptalks-zoom-zoomlevel");i.appendChild(n),this._levelDOM=n}var r=Hc("div","maptalks-zoom-slider"),s=Hc("a","maptalks-zoom-zoomin");if(s.href="javascript:;",s.innerHTML="+",r.appendChild(s),this._zoomInButton=s,e.slider){var o=Hc("div","maptalks-zoom-slider-box"),a=Hc("div","maptalks-zoom-slider-ruler"),h=Hc("span","maptalks-zoom-slider-reading"),l=Hc("span","maptalks-zoom-slider-dot");a.appendChild(h),o.appendChild(a),o.appendChild(l),r.appendChild(o),this._sliderBox=o,this._sliderRuler=a,this._sliderReading=h,this._sliderDot=l}var c=Hc("a","maptalks-zoom-zoomout");return c.href="javascript:;",c.innerHTML="-",r.appendChild(c),this._zoomOutButton=c,i.appendChild(r),t.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),i},i.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._zoomInButton&&du(this._zoomInButton,"click",this._onZoomInClick),this._zoomOutButton&&du(this._zoomOutButton,"click",this._onZoomOutClick),this._sliderRuler&&(du(this._sliderRuler,"click",this._onClickRuler),this.dotDragger.disable(),delete this.dotDragger)},i._update=function(){var t=this.getMap();if(this._sliderBox){var e=(t.getMaxZoom()-t.getMinZoom())*zm;this._sliderBox.style.height=e+16+"px",this._sliderRuler.style.height=e+8+"px",this._sliderRuler.style.cursor="pointer";var i=(t.getMaxZoom()-t.getZoom())*zm;this._sliderReading.style.height=(t.getZoom()-t.getMinZoom()+1)*zm+"px",this._sliderDot.style.top=i+"px"}this._updateText()},i._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();Xa(t)||(t=Math.floor(10*t)/10),this._levelDOM.innerHTML=t}},i._registerDomEvents=function(){this._zoomInButton&&uu(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&uu(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(uu(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger=new Uu(this._sliderDot,{ignoreMouseleave:!0}),this.dotDragger.on("dragstart",this._onDotDragstart,this).on("dragging dragend",this._onDotDrag,this).enable())},i._onZoomInClick=function(t){Jc(t),this.getMap().zoomIn()},i._onZoomOutClick=function(t){Jc(t),this.getMap().zoomOut()},i._onClickRuler=function(t){Jc(t);var e=this.getMap(),i=tu(t,this._sliderRuler).y,n=e.getMaxZoom(),r=Math.floor(n-i/zm);e.setZoom(r)},i._onDotDragstart=function(t){Jc(t.domEvent);var e=this.getMap(),i=e.getSize().toPoint()._multi(.5);e.onZoomStart(e.getZoom(),i)},i._onDotDrag=function(t){Jc(t.domEvent);var e=this.getMap(),i=e.getSize().toPoint()._multi(.5),n=tu(t.domEvent,this._sliderRuler),r=e.getMaxZoom(),s=e.getMinZoom(),o=n.y,a=r-o/zm;r<a?(a=r,o=0):s>a&&(a=s,o=(r-s)*zm),"dragging"===t.type?e.onZooming(a,i,1):"dragend"===t.type&&(this.options.seamless?e.onZoomEnd(a,i):e.onZoomEnd(Math.round(a),i)),this._sliderDot.style.top=o+"px",this._sliderReading.style.height=(e.getZoom()-s+1)*zm+"px",this._updateText()},e}(Am);Nm.mergeOptions({position:"top-left",slider:!0,zoomLevel:!0,seamless:!1}),yp.mergeOptions({zoomControl:!1}),yp.addOnLoadHook((function(){this.options.zoomControl&&(this.zoomControl=new Nm(this.options.zoomControl),this.addControl(this.zoomControl))}));var Fm=function(){function t(t,e,i,n){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:i,y:n})}return t.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"identity"===t.code.toLowerCase()?[1,-1,0,0]:"web-mercator"},t}(),jm=6378137*Math.PI;Wa(Fm,{"web-mercator":new Fm([1,-1,-jm,jm]),"tms-global-mercator":new Fm([1,1,-jm,-jm]),"tms-global-geodetic":new Fm([1,1,-180,-90]),baidu:new Fm([1,1,0,0])});var Bm=function(){function t(t,e,i,n){this.map=t,this.tileSize=n,this.fullExtent=i,this.prepareTileInfo(e,i),this._xScale=i.right>=i.left?1:-1,this._yScale=i.top>=i.bottom?1:-1;var r=t.getGLRes();this._pointOrigin=t._prjToPointAtRes(new Gh(this.tileSystem.origin),r),this._glRes=r}var e=t.prototype;return e.prepareTileInfo=function(t,e){if(Ya(t)?t=Fm[t.toLowerCase()]:Array.isArray(t)&&(t=new Fm(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t;var i=e.right>e.left?1:-1,n=e.top>e.bottom?-1:1,r=t.origin.x,s=t.origin.y;this.transformation=new rd([i,n,r,s])},e._getTileNum=function(t,e){var i=this.tileSystem,n=this.tileSize,r=Math.floor(1e-7*i.scale.x+t.x/(n.width*e)),s=Math.ceil(1e-7*i.scale.y+t.y/(n.height*e));return{x:i.scale.x*r,y:i.scale.y*s}},e.getTileIndex=function(t,e,i){var n=this.tileSystem,r=this.transformation.transform(t,1),s=this._getTileNum(r,e);return n.scale.x<0&&(s.x-=1),n.scale.y>0&&(s.y-=1),this.getNeighorTileIndex(s.x,s.y,0,0,e,i)},e.getNeighorTileIndex=function(t,e,i,n,r,s){var o=this.tileSystem,a=t+o.scale.x*i,h=e-o.scale.y*n,l=!1,c=a,u=h,d=this._getTileFullIndex(r);return s&&(!0!==s&&"x"!==s||(d.xmax===d.xmin?a=d.xmin:a<d.xmin?(a=d.xmax-(d.xmin-a)%(d.xmax-d.xmin))===d.xmax&&(a=d.xmin):a>=d.xmax&&(a=d.xmin+(a-d.xmin)%(d.xmax-d.xmin))),!0!==s&&"y"!==s||(d.ymax===d.ymin?h=d.ymin:h>=d.ymax?h=d.ymin+(h-d.ymin)%(d.ymax-d.ymin):h<d.ymin&&(h=d.ymax-(d.ymin-h)%(d.ymax-d.ymin))===d.ymax&&(h=d.ymin))),(a<d.xmin||a>d.xmax||h>d.ymax||h<d.ymin)&&(l=!0),{x:a,y:h,idx:c,idy:u,out:l}},e._getTileFullIndex=function(t){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[t])return this._tileFullIndex[t];var e=this.fullExtent,i=this.transformation,n=this._getTileNum(i.transform(new Gu(e.left,e.top),1),t),r=this._getTileNum(i.transform(new Gu(e.right,e.bottom),1),t),s=this.tileSystem;return s.scale.x<0&&(n.x-=1,r.x-=1),s.scale.y>0&&(n.y-=1,r.y-=1),this._tileFullIndex[t]=new id(n,r),this._tileFullIndex[t]},e.getTilePrjNW=function(t,e,i){var n=this.tileSystem,r=this.tileSize,s=n.origin.y+this._yScale*n.scale.y*(e+(1===n.scale.y?1:0))*i*r.height,o=n.origin.x+this._xScale*n.scale.x*(t+(1===n.scale.x?0:1))*i*r.width;return new Gu(o,s)},e.getTilePointNW=function(t,e,i){var n=this._glRes/i,r=this.tileSystem,s=this.tileSize,o=this._pointOrigin.y*n+this._yScale*r.scale.y*(e+(1===r.scale.y?1:0))*s.height,a=this._pointOrigin.x*n+this._xScale*r.scale.x*(t+(1===r.scale.x?0:1))*s.width;return new Gh(a,o)},e.getTilePrjSE=function(t,e,i){var n=this.tileSystem,r=this.tileSize,s=n.origin.y+this._yScale*n.scale.y*(e+(1===n.scale.y?0:1))*i*r.height,o=n.origin.x+this._xScale*n.scale.x*(t+(1===n.scale.x?1:0))*i*r.width;return new Gu(o,s)},e.getTilePointSE=function(t,e,i){var n=this._glRes/i,r=this.tileSystem,s=this.tileSize,o=this._pointOrigin.y*n+this._yScale*r.scale.y*(e+(1===r.scale.y?0:1))*s.height,a=this._pointOrigin.x*n+this._xScale*r.scale.x*(t+(1===r.scale.x?1:0))*s.width;return new Gh(a,o)},e.getTilePrjExtent=function(t,e,i){var n=this.getTilePrjNW(t,e,i),r=this.getTilePrjSE(t,e,i);return new id(n,r)},t}(),Um=new Gh(0,0),Gm="undefined"!=typeof Set,Hm=function(){function t(){this._table=Gm?new Set:{}}var e=t.prototype;return e.add=function(t){Gm?this._table.add(t):this._table[t]=!0},e.has=function(t){return Gm?this._table.has(t):this._table[t]},e.reset=function(){Gm?this._table.clear():this._table={}},t}(),Vm={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,backgroundZoomDiff:6,loadingLimitOnInteracting:3,tileRetryCount:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!nh,debug:!1,spatialReference:null,maxCacheSize:256,renderer:zh.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1,decodeImageInWorker:!1,tileLimitPerFrame:0,backZoomOffset:0},Wm=/\{ *([\w_]+) *\}/g,Zm=new Gh(0,0),qm=new Gh(0,0),Xm=new Gh(0,0),Jm=new Gh(0,0),Ym=new Gh(0,0),Qm=new Gh(0,0),Km=[[0,0,0],[0,0,0]],$m=[0,0,0],t_=[0,0,0],e_=[],i_=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null};var i=e.prototype;return i.getTileSize=function(){if(this._tileSize)return this._tileSize;var t=this.options.tileSize;return qa(t)&&(t=[t,t]),this._tileSize=new cc(t),this._tileSize},i.getTiles=function(t,e){return this._coordCache={},this._isPyramidMode()?this._getPyramidTiles(t,e):this._getCascadeTiles(t,e)},i._isPyramidMode=function(){var t=this.getSpatialReference();return!this._disablePyramid&&!this._hasOwnSR&&this.options.pyramidMode&&t&&t.isPyramid()},i._getTileFullExtent=function(){if(this._tileFullExtent)return this._tileFullExtent;var t=this.getSpatialReference(),e=t.getFullExtent(),i=t.getResolution(0),n=this.getMap();return this._tileFullExtent=e.convertTo((function(t){return n._prjToPointAtRes(t,i,Um)})),this._tileFullExtent},i._getRootNodes=function(t){var e=this.getMap();if(this._rootNodes){var i=this._rootNodes,n=i.tiles,r=i.mapWidth,s=i.mapHeight;if(e.width!==r||e.height!==s){for(var o=this._getRootError(),a=0;a<n.length;a++)n[a].error=o;this._rootNodes.mapWidth=e.width,this._rootNodes.mapHeight=e.height}for(var h=0;h<n.length;h++)n[h].offset[0]=t[0],n[h].offset[1]=t[1];return this._rootNodes}var l=this.getSpatialReference(),c=l.getResolution(0),u=this._getTileConfig(),d=l.getFullExtent(),f=u.tileSystem,p=f.origin,g=f.scale,m=u.getTilePrjExtent(0,0,c),_=m.getWidth(),v=m.getHeight(),y=1e-5,x=Math.abs((p.x-d.left)/_);x=Math.ceil(x-y);var w=Math.abs((d.right-p.x)/_);w=Math.ceil(w-y);var b=Math.ceil(Math.abs(d.top-p.y)/v);b=Math.ceil(b-y);var M=Math.ceil(Math.abs(d.bottom-p.y)/v);if((w+x)*((M=Math.ceil(M-y))+b)>32)return{status:0,error:"Too many root nodes"};for(var S=this._getRootError(),C=[],T=-x;T<w;T++)for(var P=-b;P<M;P++){var A=g.y<0?P:-(P+1);C.push({x:T,y:A,z:0,idx:T,idy:A,res:c,extent2d:u.getTilePrjExtent(T,A,c).convertTo((function(t){return e._prjToPointAtRes(t,c,Um)})),id:this._getTileId(T,A,0),url:this.getTileUrl(T,A,0+this.options.zoomOffset),offset:[0,0],error:S,children:[]})}return this._rootNodes={status:1,tiles:C,mapWidth:e.width,mapHeight:e.height},this._getRootNodes(t)},i._getRootError=function(){var t=this.getMap(),e=eh(t.getFov()),i=t.width/t.height,n=t.cameraPosition[2],r=n*Math.tan(.5*e),s=r*i,o=Math.sqrt(n*n+r*r+s*s);return t._getFovZ(0)*(o/n)*this.getSpatialReference().getResolution(0)/t.getResolution(0)},i._getPyramidTiles=function(t,e){var i=this.getMap();isNaN(+t)&&(t=this._getTileZoom(i.getZoom()));var n,r=this.getSpatialReference(),s=Math.min(t,this.getMaxZoom()),o=i.projViewMatrix,a=this._getTileFullExtent(),h=this._getTileOffset(0);if(this.options.repeatWorld){var l=i.getContainerExtent(),c=this._convertToExtent2d(l),u=r.getResolution(0)/i.getResolution();if(c.within(a.copy()._scale(u))){var d=this._getRootNodes(h);if(1!==d.status)return this._disablePyramid=!0,this.getTiles(t,e);n=d.tiles.concat()}else{var f=i.getPitch(),p=i.options.cascadePitches[1],g=Math.floor(i._getVisualHeight(p)),m=f<=p?l:new nd(0,i.height-g,i.width,i.height);this._visitedTiles=new Hm;var _=this._getTiles(0,m,2,e&&e.getRenderer(),!0),v=this._getRootError();_.tiles.forEach((function(t){t.error=v})),n=_.tiles}}else{var y=this._getRootNodes(h);if(1!==y.status)return this._disablePyramid=!0,this.getTiles(t,e);n=y.tiles.concat()}for(var x=i.getGLRes(),w={0:h},b=this.options.backZoomOffset+t,M=new nd,S=[];n.length>0;){var C=n.pop();C.z!==s?(w[C.z+1]||(w[C.z+1]=this._getTileOffset(C.z+1)),this._splitNode(C,o,n,S,M,s,w[C.z+1],e&&e.getRenderer(),x),b<t&&S[S.length-1]!==C&&b===C.z&&S.push(C)):(M._combine(C.extent2d),S.push(C))}return{tileGrids:[{extent:M,count:S.length,tiles:S,offset:[0,0],zoom:t}],count:S.length}},i._splitNode=function(t,e,i,n,r,s,o,a,h){for(var l=this._getTileConfig().tileSystem.scale.y,c=t.z+1,u=this.getSpatialReference(),d=t.x,f=t.y,p=t.extent2d,g=t.idx,m=t.idy,_=p.getWidth()/2*2,v=p.getHeight()/2*2,y=2*p.xmin,x=2*p.ymax,w=2*p.ymin,b=a||this.getRenderer(),M=!1,S=[],C=u.getResolution(c),T=C/h,P=0;P<4;P++){var A=P%2,E=P>>1,L=(d<<1)+A,R=(f<<1)+E,O=(g<<1)+A,D=(m<<1)+E;t.children||(t.children=[]);var I=t.children[P];I||(I=this._getTileId(O,D,c),t.children[P]=I);var k=b.isTileCachedOrLoading(I),z=void 0,N=k&&k.info;if(!N){if(this.tileInfoCache||(this.tileInfoCache=new _u(4*this.options.maxCacheSize)),!(N=this.tileInfoCache.get(I))){if(l<0){var F=y+A*_,j=x-E*v;z=new nd(F,j-v,F+_,j)}else{var B=y+A*_,U=w+E*v;z=new nd(B,U,B+_,U+v)}N={x:L,y:R,idx:O,idy:D,z:c,extent2d:z,error:t.error/2,res:C,id:I,parentNodeId:t.id,children:[],url:this.getTileUrl(L,R,c+this.options.zoomOffset),offset:o},this.tileInfoCache.add(I,N)}a&&(N.layer=this.getId())}N.error=t.error/2,N.offset[0]=o[0],N.offset[1]=o[1];var G=this._isTileVisible(N,e,T,s,o);if(1===G)M=!0;else{if(-1===G)continue;if(0===G&&c!==s)return n.push(t),void r._combine(t.extent2d)}S.push(N)}c===s?M?i.push.apply(i,S):(n.push(t),r._combine(t.extent2d)):i.push.apply(i,S)},i._isTileVisible=function(t,e,i,n,r){if(0===t.z)return 1;if(!this._isTileInFrustum(t,e,i,r))return-1;var s=this.options.maxError;return Za(s)&&(s=1),this._getScreenSpaceError(t,i,n,r)>=s?1:0},i._isTileInFrustum=function(t,e,i,n){if(!this._zScale){var r=this.getMap(),s=r.getGLRes();this._zScale=r.altitudeToPoint(100,s)/100}var o=t.extent2d,a=o.xmin,h=o.ymin,l=o.xmax,c=o.ymax;return Km[0][0]=(a-n[0])*i,Km[0][1]=(h-n[1])*i,Km[0][2]=(t.minAltitude||0)*this._zScale,Km[1][0]=(l-n[0])*i,Km[1][1]=(c-n[1])*i,Km[1][2]=(t.maxAltitude||0)*this._zScale,Da(e,Km)},i._getScreenSpaceError=function(t,e,i,n){var r=t.error,s=this.getMap(),o=t.extent2d,a=o.xmin,h=o.ymin,l=o.xmax,c=o.ymax;$m[0]=(a-n[0])*e,$m[1]=(h-n[1])*e,t_[0]=(l-n[0])*e,t_[1]=(c-n[1])*e;var u,d,f,p,g,m,_=(u=$m,d=t_,f=s.cameraPosition,p=Math.max(u[0]-f[0],0,f[0]-d[0]),g=Math.max(u[1]-f[1],0,f[1]-d[1]),m=Math.max(u[2]-f[2],0,f[2]-d[2]),Math.sqrt(p*p+g*g+m*m)),v=Math.max(Math.abs(_),1e-7),y=Math.abs(t.z-i);return r*(s.height<1e3||y<=1?1:y<=2?.7:.605)/v},i._getCascadeTiles=function(t,e){var i=this.getMap(),n=i.getPitch(),r=e&&e.getRenderer(),s=i.getContainerExtent(),o=[],a=0,h=this.getMinZoom(),l=i.options.cascadePitches[0],c=i.options.cascadePitches[1],u=Math.floor(i._getVisualHeight(c)),d=Za(t)?this._getTileZoom(i.getZoom()):t;if(this._visitedTiles=new Hm,!Za(t)||!this.options.cascadeTiles||n<=l||!Za(h)&&d<=h){var f=n<=c?s:new nd(0,i.height-u,i.width,i.height),p=this._getTiles(d,f,2,r);return p&&(a+=p.tiles.length,o.push(p)),{tileGrids:o,count:a}}var g=Math.floor(i._getVisualHeight(l)),m=new nd(0,i.height-g,i.width,i.height),_=this._getTiles(d,m,0,r);a+=_?_.tiles.length:0,o.push(_);var v,y,x=m.ymin,w=i.getSpatialReference().getZoomDirection(),b=w;if(n>c){d-b<=h&&(b=0);var M=new nd(0,i.height-u,i.width,x);a+=(v=this._getTiles(d-b,M,1,r))?v.tiles.length:0,x=M.ymin,b+=4*w,o.push(v)}if(d-b>=h){var S=new nd(0,s.ymin,i.width,x);a+=(y=this._getTiles(d-b,S,2,r))?y.tiles.length:0,o.push(y)}return v&&y&&(o[1]=y,o[2]=v),{tileGrids:o,count:a}},i.getTileUrl=function(t,e,i){var n=this.options.urlTemplate,r="";if(this.options.subdomains){var s=this.options.subdomains;if(rl(s)){var o=(t+e)%s.length;o<0&&(o=0),r=s[o]}}if(Qa(n))return n(t,e,i,r);var a={x:t,y:e,z:i,s:r};return this.options.token&&(a.token=this.options.token),this.options.customTags&&Wa(a,this.options.customTags),n.replace(Wm,(function(t,e){var i=a[e];if(void 0===i)throw new Error("No value provided for variable "+t);return"function"==typeof i&&(i=i(a)),i}))},i.clear=function(){return this._renderer&&this._renderer.clear(),this.tileInfoCache&&this.tileInfoCache.reset(),this.fire("clear"),this},i.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},i.getSpatialReference=function(){var t=this.getMap();if(t&&(!this.options.spatialReference||np.equals(this.options.spatialReference,t.options.spatialReference)))return t.getSpatialReference();if(this._sr)return this._sr;var e=this.options.spatialReference;if(Ya(e)&&!(e=np.getPreset(e)))throw new Error("Unsupported spatial reference: "+this.options.spatialReference+", possible values: "+np.getAllPresets().join());return this._sr=new np(e),this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom(),this._hasOwnSR=this._sr.toJSON().projection!==t.getSpatialReference().toJSON().projection,this._sr},i.getMinZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.max(t.prototype.getMinZoom.call(this),this._srMinZoom):t.prototype.getMinZoom.call(this)},i.getMaxZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.min(t.prototype.getMaxZoom.call(this),this._srMaxZoom):t.prototype.getMaxZoom.call(this)},i._getTileZoom=function(t){if(!this._hasOwnSR){var e=this.getMap().getResolution(t),i=this.getSpatialReference().getResolution(t);t+=Math.log(i/e)*Math.LOG2E}var n=this.options.maxAvailableZoom;return!Za(n)&&t>n&&(t=n),Xa(t)||(t=Math.round(t)),t=Math.max(0,t)},i._getTiles=function(t,e,i,n,r){var s=this.getMap(),o=t,a=s.projViewMatrix,h=s.getResolution(t)/s.getResolution(t-1)==.5;i<2&&(0===i&&h&&(o-=1),a=0===i?s.cascadeFrustumMatrix0:1===i?s.cascadeFrustumMatrix1:s.projViewMatrix);var l=o+this.options.zoomOffset,c=this._getTileOffset(l),u=c[0]||c[1],d={zoom:o,extent:null,offset:c,tiles:[]};if(l<0)return d;if(!(s&&this.isVisible()&&s.width&&s.height))return d;if(!r){var f=this.getMinZoom(),p=this.getMaxZoom();if(!Za(f)&&o<f||!Za(p)&&o>p)return d}var g=this._getTileConfig();if(!g)return d;var m,_={zoom:c},v=this.getSpatialReference().getResolution(l);m=this._hasOwnSR?s.getGLScale(o):v/s.getGLRes();var y=!this._hasOwnSR&&this.options.repeatWorld,x=this._convertToExtent2d(e),w=this._getMask2DExtent();if(w){var b=w.intersection(x);if(!b)return d;e=b.convertTo((function(t){return s._pointToContainerPoint(t,void 0,0,Um)}))}var M,S=s._containerPointToPrj(e.getCenter(),Zm),C=s._prjToPoint(S,l,qm);M=u?this._project(s._pointToPrj(C._add(c),l,qm),qm):this._project(S,qm);var T=s.getGLScale()/s.getGLScale(l);Xm.x=x.xmin*T,Xm.y=x.ymax*T,Jm.x=x.xmax*T,Jm.y=x.ymin*T;for(var P=this._project(s._pointToPrj(Xm._add(c),l,Xm),Xm),A=this._project(s._pointToPrj(Jm._add(c),l,Jm),Jm),E=g.getTileIndex(M,v,y),L=g.getTileIndex(P,v,y),R=g.getTileIndex(A,v,y),O=Math.ceil(Math.abs(E.idy-L.idy)),D=Math.ceil(Math.abs(E.idx-L.idx)),I=Math.ceil(Math.abs(E.idy-R.idy)),k=Math.ceil(Math.abs(E.idx-R.idx)),z=(O+I+1)*(D+k+1),N=this.getTileSize(),F=this.getRenderer()||n,j=this._getTileConfig().tileSystem.scale,B=[],U=new nd,G=new Gh(0,0),H=-O;H<=I;H++)for(var V=-D,W=-1/0,Z=!1;V>=W&&V<=k;){var q=g.getNeighorTileIndex(E.idx,E.idy,V,H,v,y);W===-1/0?V++:V--;var X=this._getTileId(q.idx,q.idy,o);if(!(q.out||this._visitedTiles&&this._visitedTiles.has(X))){var J=F&&F.isTileCachedOrLoading(X);J&&(J=J.info);var Y=void 0;if(J){var Q=J.extent2d;G.set(Q.xmin,Q.ymax),Y=G}else if(this._hasOwnSR){var K=g.getTilePrjNW(q.x,q.y,v);Y=s._prjToPoint(this._unproject(K,Jm),o)}else Y=g.getTilePointNW(q.x,q.y,v);var $=void 0,tt=void 0;if(this._hasOwnSR){var et=void 0;if(this._hasOwnSR){var it=g.getTilePrjSE(q.x,q.y,v);et=s._prjToPoint(this._unproject(it,Jm),o,Jm)}else et=g.getTilePointSE(q.x,q.y,v);$=Math.ceil(Math.abs(et.x-Y.x)),tt=Math.ceil(Math.abs(et.y-Y.y))}else $=N.width,tt=N.height;var nt=j.x*(q.idx-q.x)*$,rt=j.y*(q.idy-q.y)*tt;J||!nt&&!rt||Y._add(nt,rt);var st=J&&J.extent2d||new nd(Y.x,Y.y-tt,Y.x+$,Y.y);if(z<=4||Z||this._isTileInExtent(a,st,c,m)){var ot=this._hasOwnSR?s._getResolution(o):v;this._visitedTiles&&0===i&&this._visitedTiles.add(X),h&&0===i?(this._splitTiles(a,B,F,q,o+1,ot,st,nt,rt,_,n),U._combine(st)):(J?(J.offset[0]=c[0],J.offset[1]=c[1]):(J={z:o,x:q.x,y:q.y,idx:q.idx,idy:q.idy,extent2d:st,offset:c,id:X,res:ot,url:this.getTileUrl(q.x,q.y,o)},n&&(J.layer=this.getId())),B.push(J),U._combine(st)),W===-1/0?(W=V,V=k):Z||(Z=!0)}}}if(B.length){var at=s._containerPointToPoint(e.getCenter(),o,Um)._add(c),ht=new Gh(0,0),lt=new Gh(0,0);B.sort((function(t,e){return ht.set((t.extent2d.xmin+t.extent2d.xmax)/2,(t.extent2d.ymin+t.extent2d.ymax)/2),lt.set((e.extent2d.xmin+e.extent2d.xmax)/2,(e.extent2d.ymin+e.extent2d.ymax)/2),ht.distanceTo(at)-lt.distanceTo(at)}))}return{offset:c,zoom:t,extent:U,tiles:B}},i._convertToExtent2d=function(t){var e=this,i=this.getMap();return t.convertTo((function(t){if(t.y>0&&t.y<i.height){var n=(0===t.x?0:1)+t.y;e._coordCache[n]||(e._coordCache[n]=i._containerPointToPoint(t)),e._coordCache[n]}return i._containerPointToPoint(t,void 0,Um)}))},i._splitTiles=function(t,e,i,n,r,s,o,a,h,l,c){var u=this._getTileConfig().tileSystem.scale.y,d=this.getMap().getGLScale(r),f=Ym.set(2*o.xmin,u<0?2*o.ymax:2*o.ymin),p=o.getWidth(),g=o.getHeight(),m=2*n.idx,_=2*n.idy,v=2*n.x,y=2*n.y,x=this._checkAndAddTile(t,i,m,_,v,y,r,s,0,0,p,g,f,d,l,c);x&&e.push(x),(x=this._checkAndAddTile(t,i,m,_,v,y,r,s,0,1,p,g,f,d,l,c))&&e.push(x),(x=this._checkAndAddTile(t,i,m,_,v,y,r,s,1,0,p,g,f,d,l,c))&&e.push(x),(x=this._checkAndAddTile(t,i,m,_,v,y,r,s,1,1,p,g,f,d,l,c))&&e.push(x)},i._checkAndAddTile=function(t,e,i,n,r,s,o,a,h,l,c,u,d,f,p,g){var m=this._getTileId(i+h,n+l,o);if(this._visitedTiles&&this._visitedTiles.has(m))return null;var _=p[o];_||(_=p[o]=this._getTileOffset(o));var v=this._getTileConfig().tileSystem.scale.y,y=new nd(d.x+h*c,d.y+v*l*u,d.x+(h+1)*c,d.y+v*(l+1)*u);if(!this._isSplittedTileInExtent(t,y,_,f))return null;var x=a/2,w=e&&e.isTileCachedOrLoading(m);return w?w=w.info:(w={z:o,x:r+h,y:s+l,extent2d:y,id:m,offset:_,res:x,url:this.getTileUrl(r+h,s+l,o+this.options.zoomOffset)},g&&(w.layer=this.getId())),w},i._getTileOffset=function(t){var e=this.options.offset;return Qa(e)&&(e=e.call(this,t)),qa(e)?[e,e]:e||[0,0]},i._getTileId=function(t,e,i,n){return(n||this.getId())+"_"+e+"_"+t+"_"+i},i._project=function(t,e){if(this._hasOwnSR){var i=this.getMap().getProjection();return this.getSpatialReference().getProjection().project(i.unproject(t,e),e)}return t},i._unproject=function(t,e){if(this._hasOwnSR){var i=this.getMap(),n=this.getSpatialReference(),r=i.getProjection(),s=n.getProjection();return r.project(s.unproject(t,e),e)}return t},i._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),i=this.getSpatialReference(),n=i.getProjection(),r=i.getFullExtent();this._defaultTileConfig=new Bm(t,Fm.getDefault(n),r,e),this.options.hasOwnProperty("tileSystem")&&(this._tileConfig=new Bm(t,this.options.tileSystem,r,e)),delete this._rootNodes,delete this._tileFullExtent,delete this._disablePyramid},i._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},i._bindMap=function(e){var i=e.getBaseLayer();return i===this&&(i.options.hasOwnProperty("forceRenderOnMoving")||this.config({forceRenderOnMoving:!0})),this._onSpatialReferenceChange(),t.prototype._bindMap.apply(this,arguments)},i._isTileInExtent=function(t,e,i,n){var r,s=this.getMap();if(t!==s.projViewMatrix){var o=e.getCenter(Qm)._sub(i[0],i[1])._multi(n);zg(e_,o.x,o.y,0);var a=function(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[3]*n+i[7]*r+i[11]*s+i[15];return o=o||1,t[0]=(i[0]*n+i[4]*r+i[8]*s+i[12])/o,t[1]=(i[1]*n+i[5]*r+i[9]*s+i[13])/o,t[2]=(i[2]*n+i[6]*r+i[10]*s+i[14])/o,t}(e_,e_,s.projViewMatrix);r=a[1]<0?s.projViewMatrix:t}else r=s.projViewMatrix;return Km[0][0]=(e.xmin-i[0])*n,Km[0][1]=(e.ymin-i[1])*n,Km[1][0]=(e.xmax-i[0])*n,Km[1][1]=(e.ymax-i[1])*n,Da(r,Km)},i._isSplittedTileInExtent=function(t,e,i,n){var r=this.getMap();return Km[0][0]=(e.xmin-i[0])*n,Km[0][1]=(e.ymin-i[1])*n,Km[1][0]=(e.xmax-i[0])*n,Km[1][1]=(e.ymax-i[1])*n,Da(r.projViewMatrix,Km)},i.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},i._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr,delete this._srMinZoom,delete this._hasOwnSR,delete this._rootNodes,this.tileInfoCache&&this.tileInfoCache.reset();var t=this.getRenderer();t&&t.clear()},e}(hp);i_.registerJSONType("TileLayer"),i_.mergeOptions(Vm);var n_=new cc(256,256),r_="show hide remove";function s_(t){return Array.isArray(t)||(t=[t]),t}var o_=function(t){function e(e,i,n){var r;return(r=t.call(this,e,n)||this).layers=i||[],r._checkChildren(),r.layerMap={},r._groupChildren=[],r}Nh(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var i=t.layers.map((function(t){return hp.fromJSON(t)}));return new e(t.id,i,t.options)};var i=e.prototype;return i.getLayers=function(){return this.layers},i.addLayer=function(t){var e=this;void 0===t&&(t=[]),t=s_(t);var i=this.layers.length;return t.forEach((function(t){t instanceof i_&&(-1!==e.layers.indexOf(t)||e.layerMap[t.getId()]||e.layers.push(t))})),i!==this.layers.length&&(this._sortLayers(),this._refresh(),this._renderLayers()),this},i.removeLayer=function(t){var e=this;void 0===t&&(t=[]),t=s_(t);var i=this.layers.length;return t.forEach((function(t){if(t instanceof i_||(t=e.layerMap[t]),t instanceof i_){var i=e.layers.indexOf(t);i>=0&&(e.layers.splice(i,1),t._doRemove(),t.off(r_,e._onLayerShowHide,e))}})),i!==this.layers.length&&(this._refresh(),this._renderLayers()),this},i.clearLayers=function(){var t=this;return this.layers.forEach((function(e){e._doRemove(),e.off(r_,t._onLayerShowHide,t)})),this.layers=[],this._refresh(),this._renderLayers(),this},i.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map((function(t){return t.toJSON()})),options:this.config()}},i.getTileSize=function(t){var e=this.getLayer(t);return e?e.getTileSize():n_},i.getTiles=function(t,e){for(var i=this.layers,n=[],r=0,s=0,o=i.length;s<o;s++){var a=i[s];if(a&&a.options.visible&&a.isVisible()&&a.getMap()){var h=a.getTiles(t,e||this);h&&0!==h.count&&(r+=h.count,Jh(n,h.tileGrids))}}return{count:r,tileGrids:n}},i.onAdd=function(){this._sortLayers(),this._refresh(),t.prototype.onAdd.call(this)},i.onRemove=function(){var e=this;this.layers.forEach((function(t){t._doRemove(),t.off(r_,e._onLayerShowHide,e)})),this.layerMap={},this._groupChildren=[],t.prototype.onRemove.call(this)},i.getLayer=function(t){return this.getChildLayer(t)},i.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var i=0;i<this._groupChildren.length;i++){var n=this._groupChildren[i].getChildLayer(t);if(n)return n}return null},i._onLayerShowHide=function(t){var e=t||{},i=e.type,n=e.target;return"remove"===i&&n&&(this.layers.splice(this.layers.indexOf(n),1),n._doRemove(),n.off(r_,this._onLayerShowHide,this),this._refresh()),this._renderLayers(),this},i._renderLayers=function(){var t=this.getRenderer();return t&&t.setToRedraw(),this},i._refresh=function(){var t=this,e=this.getMap();return this._groupChildren=[],this.layerMap={},this.layers.forEach((function(i){t.layerMap[i.getId()]=i,i.getChildLayer&&t._groupChildren.push(i),i.getMap()||i._bindMap(e),i.on(r_,t._onLayerShowHide,t)})),this},i.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,i=0,n=e.length;i<n;i++)if(e[i].isVisible())return!0;return!1},i._checkChildren=function(){var t=this,e={};this.layers.forEach((function(i){var n=i.getId();if(e[n])throw new Error("Duplicate child layer id ("+n+") in the GroupTileLayer ("+t.getId()+")");e[n]=1}))},i._sortLayers=function(){this.layers.sort((function(t,e){return t.options.zIndex-e.options.zIndex}))},e}(i_);o_.registerJSONType("GroupTileLayer"),o_.mergeOptions({maxCacheSize:1024});var a_={crs:null,uppercase:!1,detectRetina:!1},h_={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},l_=function(t){function e(e,i){var n;n=t.call(this,e)||this;var r=Wa({},h_);for(var s in i)s in n.options||(r[s]=i[s]);n.setOptions(i),n.setZIndex(i.zIndex);var o=n.getTileSize();return r.width=o.width,r.height=o.height,n.wmsParams=r,n._wmsVersion=parseFloat(r.version),n}Nh(e,t);var i=e.prototype;return i.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),i=a_.detectRetina?e:1;this.wmsParams.width*=i,this.wmsParams.height*=i;var n=this.options.crs||this.getMap().getProjection().code,r=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[r]=n,t.prototype.onAdd.call(this)},i.getTileUrl=function(e,i,n){var r=this.getSpatialReference().getResolution(n),s=this._getTileConfig().getTilePrjExtent(e,i,r),o=s.getMax(),a=s.getMin(),h=(this._wmsVersion>=1.3&&("EPSG:4326"===this.wmsParams.crs||"EPSG:4490"===this.wmsParams.crs)?[a.y,a.x,o.y,o.x]:[a.x,a.y,o.x,o.y]).join(","),l=t.prototype.getTileUrl.call(this,e,i,n);return l+function(t,e,i){var n=[];for(var r in t)n.push(encodeURIComponent(i?r.toUpperCase():r)+"="+encodeURIComponent(t[r]));return(e&&-1!==e.indexOf("?")?"&":"?")+n.join("&")}(this.wmsParams,l,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},i.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(i_);l_.registerJSONType("WMSTileLayer"),l_.mergeOptions(a_);var c_=function(t){function e(e,i){var n;return(n=t.call(this,e,i)||this).options.hasOwnProperty("forceRenderOnMoving")||(n.options.forceRenderOnMoving=!1),n}Nh(e,t);var i=e.prototype;return i.drawTile=function(){},i.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(i_);function u_(t,e,i){var n=t.createShader(e);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){var r=t.getShaderInfoLog(n);throw t.deleteShader(n),new Error("Failed to compile shader: "+r)}return n}function d_(t,e,i){var n=u_(t,t.VERTEX_SHADER,e),r=u_(t,t.FRAGMENT_SHADER,i);if(!n||!r)return null;var s=t.createProgram();return s?(t.attachShader(s,n),t.attachShader(s,r),t.linkProgram(s),{program:s,vertexShader:n,fragmentShader:r}):null}function f_(t,e,i){if(Array.isArray(i[0])){for(var n=Float32Array.BYTES_PER_ELEMENT,r=0,s=0;s<i.length;s++)r+=i[s][1]||0;for(var o=0,a=0;a<i.length;a++){var h=t.getAttribLocation(e,i[a][0]);if(h<0)throw new Error("Failed to get the storage location of "+i[a][0]);t.vertexAttribPointer(h,i[a][1],t[i[a][2]||"FLOAT"],!1,n*r,n*o),o+=i[a][1]||0,t.enableVertexAttribArray(h)}}else{var l=t.getAttribLocation(e,i[0]);t.vertexAttribPointer(l,i[1],t[i[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(l)}}c_.registerJSONType("CanvasTileLayer");var p_="\n        attribute vec2 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 0., 1.);\n\n            v_texCoord = a_texCoord;\n        }\n    ",g_="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n        uniform float u_debug_line;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            if (u_debug_line == 1.) {\n                gl_FragColor = vec4(0., 1., 0., 1.);\n            } else {\n                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n            }\n        }\n    ",m_=[0,0],__=[0,0,0],v_=new Array(16),y_=new Gh(20,20),x_=function(t){var e,i=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.drawGLImage=function(t,e,i,n,r,s,o,a){this.gl.program!==this.program&&this.useProgram(this.program);var h=this.gl;if(this.loadTexture(t),this.canvas.gl&&this.canvas.gl.wrap){var l=this.layer&&this.layer.options.opacity;Za(l)&&(l=1),o*=l}__[0]=e||0,__[1]=i||0;var c=Ig(v_);Lg(c,c,__),Rg(c,c,[s,s,1]),Og(c,this.getMap().projViewMatrix,c),h.uniformMatrix4fv(this.program.u_matrix,!1,c),h.uniform1f(this.program.u_opacity,o),h.uniform1f(this.program.u_debug_line,0);var u=t.glBuffer;!u||u.width===n&&u.height===r||(this.saveImageBuffer(u),delete t.glBuffer),t.glBuffer?h.bindBuffer(h.ARRAY_BUFFER,u):t.glBuffer=this.bufferTileData(0,0,n,r),m_[0]="a_position",m_[1]=2,m_[2]=t.glBuffer.type,this.enableVertexAttrib(m_),h.drawArrays(h.TRIANGLE_STRIP,0,4),a&&this.drawDebug(c,0,0,n,r,a)},i.drawDebug=function(t,e,i,n,r,s){var o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),o.bufferData(o.ARRAY_BUFFER,new Float32Array([e,i,e+n,i,e+n,i-r,e,i-r,e,i]),o.DYNAMIC_DRAW),o.uniformMatrix4fv(this.program.u_matrix,!1,t),o.uniform1f(this.program.u_opacity,1),o.uniform1f(this.program.u_debug_line,1),o.drawArrays(o.LINE_STRIP,0,5);var a=this._debugInfoCanvas;if(!a){var h=this.getMap().getDevicePixelRatio()>1?2:1;(a=this._debugInfoCanvas=document.createElement("canvas")).width=256*h,a.height=32*h;var l=a.getContext("2d");l.font="20px monospace",l.scale(h,h)}var c=a.getContext("2d");c.clearRect(0,0,a.width,a.height);var u=this.layer.options.debugOutline;Mu.fillText(c,s,y_,u),this.loadTexture(a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a);var d=e,f=e+(n=256),p=i-r+32,g=i-r;o.bufferData(o.ARRAY_BUFFER,this.set8(d,p,d,g,f,p,f,g),o.DYNAMIC_DRAW),o.uniform1f(this.program.u_debug_line,0),o.drawArrays(o.TRIANGLE_STRIP,0,4)},i.bufferTileData=function(t,e,i,n,r){var s,o=t,a=t+i,h=e,l=e-n;s=Xa(o)&&Xa(a)&&Xa(h)&&Xa(l)?this.set8Int(o,h,o,l,a,h,a,l):this.set8(o,h,o,l,a,h,a,l);var c=this.loadImageBuffer(s,r);return c.width=i,c.height=n,c.type=s instanceof Int16Array?"SHORT":"FLOAT",c},i.drawTinImage=function(t,e,i,n,r){var s=this.gl;this.loadTexture(t),s.uniformMatrix4fv(this.program.u_matrix,!1,this.getMap().projViewMatrix),s.uniform1f(this.program.u_opacity,r),s.bindBuffer(s.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),s.bufferData(s.ARRAY_BUFFER,new Float32Array(e),s.DYNAMIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),s.bufferData(s.ARRAY_BUFFER,new Float32Array(i),s.DYNAMIC_DRAW),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),s.DYNAMIC_DRAW),s.drawElements(s.TRIANGLES,n.length,s.UNSIGNED_SHORT,0)},i.createCanvas2=function(){this.canvas2=Mu.createCanvas(this.canvas.width,this.canvas.height)},i.createGLContext=function(){this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():this.gl=function(t,e){for(var i={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},n=["webgl","experimental-webgl"],r=null,s=0;s<n.length;++s){try{r=t.getContext(n[s],e||i)}catch(rM){}if(r)break}return r}(this.canvas2||this.canvas,this.layer.options.glOptions);var t=this.gl;t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(p_,this.layer.options.fragmentShader||g_),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),t.bufferData(t.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},i.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},i.clearGLCanvas=function(){this.gl&&(this.gl.clearStencil(255),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT))},i.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},i._createTexture=function(t){var e=this.gl,i=this.getTexture()||e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),Xa(tl(t.width))&&Xa(tl(t.width))&&e.generateMipmap(e.TEXTURE_2D),i},i.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},i.saveTexture=function(t){this._textures.push(t)},i.loadTexture=function(t){var e=this.gl,i=t.texture;return i||(i=this._createTexture(t),t.texture=i),e.bindTexture(e.TEXTURE_2D,i),i},i.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},i.saveImageBuffer=function(t){this._imageBuffers||(this._imageBuffers=[]),this._imageBuffers.push(t)},i.loadImageBuffer=function(t,e){var i=this.gl,n=e||this.createImageBuffer();return i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW),n},i.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},i.removeGLCanvas=function(){var t=this.gl;if(t){if(this._debugBuffer&&(t.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach((function(e){t.deleteBuffer(e)})),delete this._buffers),this._textures&&(this._textures.forEach((function(e){return t.deleteTexture(e)})),delete this._textures),this._debugInfoCanvas){var e=this._debugInfoCanvas.texture;e&&t.deleteTexture(e),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var i=t.program;t.deleteShader(i.fragmentShader),t.deleteShader(i.vertexShader),t.deleteProgram(i),delete this.gl,delete this.canvas2}},i.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},i.enableVertexAttrib=function(t){f_(this.gl,this.gl.program,t)},i.createProgram=function(t,e){for(var i=this.gl,n=d_(i,t,e),r=n.program,s=n.vertexShader,o=n.fragmentShader,a=i.getProgramParameter(r,35718),h=[],l=0;l<a;++l){var c=i.getActiveUniform(r,l);h.push(c.name)}return r.vertexShader=s,r.fragmentShader=o,this._initUniforms(r,h),r},i.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},i.enableSampler=function(t,e){var i=this.gl,n=this._getUniform(i.program,t);return e||(e=0),i.uniform1i(n,e),n},i._initUniforms=function(t,e){for(var i=0;i<e.length;i++){var n=e[i],r=e[i],s=n.indexOf("[");s>=0&&(n=n.substring(0,s),nh||(r=r.substring(0,s))),t[n]=this._getUniform(t,r)}},i._getUniform=function(t,e){var i=this.gl.getUniformLocation(t,e);if(!i)throw new Error("Failed to get the storage location of "+e);return i},e}(t);return Wa(i.prototype,{set8:(e=zh.ie9?null:new Float32Array(8),function(t,i,n,r,s,o,a,h){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e[4]=s,e[5]=o,e[6]=a,e[7]=h,e}),set8Int:function(){var t=zh.ie9?null:new Int16Array(8);return function(e,i,n,r,s,o,a,h){return t[0]=e,t[1]=i,t[2]=n,t[3]=r,t[4]=s,t[5]=o,t[6]=a,t[7]=h,t}}()}),i},w_={renderer:zh.webgl?"gl":"canvas",crossOrigin:null},b_=new Gh(0,0),M_=function(t){function e(e,i,n){var r;return!i||Array.isArray(i)||i.url||(n=i,i=null),(r=t.call(this,e,n)||this)._images=i,r}Nh(e,t);var i=e.prototype;return i.onAdd=function(){this._prepareImages(this._images)},i.setImages=function(t){return this._images=t,this._prepareImages(t),this},i.getImages=function(){return this._images},i._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]);var e=this.getMap(),i=e.getGLRes();this._imageData=t.map((function(t){var n=new id(t.extent);return Wa({},t,{extent:n,extent2d:n.convertTo((function(t){return e.coordToPointAtRes(t,i)}))})})),this._images=t;var n=this.getRenderer();n&&n.refreshImages()},e}(hp);M_.mergeOptions(w_);var S_=[],C_=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.isDrawable=function(){return!this.getMap().getPitch()||(console,!1)},i.checkResources=function(){var t=this;if(this._imageLoaded)return S_;var e=this.layer._imageData.map((function(t){return[t.url,null,null]}));if(this.resources){var i=[],n=new Ud;e.forEach((function(e){if(t.resources.isResourceLoaded(e)){var r=t.resources.getImage(e);n.addResource(e,r)}else i.push(e)})),this.resources.forEach((function(e,i){n.isResourceLoaded(e)||t.retireImage(i.image)})),this.resources=n,e=i}return this._imageLoaded=!0,e},i.retireImage=function(t){t.close&&t.close()},i.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},i.draw=function(){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(),this.completeRender())},i._drawImages=function(){var t=this.layer._imageData,e=this.getMap(),i=e._get2DExtentAtRes(e.getGLRes());if(t&&t.length)for(var n=0;n<t.length;n++){var r=t[n].extent2d,s=this.resources&&this.resources.getImage(t[n].url);s&&i.intersects(r)&&(this._painted=!0,this._drawImage(s,r,t[n].opacity||1))}},i._drawImage=function(t,e,i){var n=0,r=this.context;i<1&&(n=r.globalAlpha,r.globalAlpha=i);var s=this.getMap(),o=b_.set(e.xmin,e.ymax),a=s._pointAtResToContainerPoint(o,s.getGLRes()),h=a.x,l=a.y,c=s.getBearing();c&&(r.save(),r.translate(h,l),c&&r.rotate(-c*Math.PI/180),h=l=0);var u=s.getGLScale();r.drawImage(t,h,l,e.getWidth()/u,e.getHeight()/u),c&&r.restore(),n&&(r.globalAlpha=n)},i.drawOnInteracting=function(){this.draw()},e}(Bd),T_=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.isDrawable=function(){return!0},i._drawImage=function(t,e,i){this.drawGLImage(t,e.xmin,e.ymax,e.getWidth(),e.getHeight(),1,i)},i.createContext=function(){this.createGLContext()},i.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},i.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},i.retireImage=function(t){t.close&&t.close(),this.disposeImage(t)},i.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(x_(C_));M_.registerRenderer("canvas",C_),M_.registerRenderer("gl",T_);var P_=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.getPrepareParams=function(){return[]},i.getDrawParams=function(){return[]},i.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=Mu.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},i.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},i.draw=function(){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer.apply(this,arguments)},i.drawOnInteracting=function(){this._drawLayerOnInteracting.apply(this,arguments)},i.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var i=e.image;this.buffer.width===i.width&&this.buffer.height===i.height||(this.buffer.width=i.width,this.buffer.height=i.height);var n=this.buffer.getContext("2d"),r=this.layer.doubleBuffer(n,this.context);(void 0===r||r)&&(Mu.image(n,i,0,0),e.image=this.buffer)}return e},i.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},i.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},i.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},i.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},i.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},i.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},i.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},i.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},i.prepareDrawContext=function(){if(!this._predrawed){var t=A_(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw.apply(this.layer,[this.context].concat(t)),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},i._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();if(t.maskExtent&&!t.extent.intersects(t.maskExtent))return this.completeRender(),null;var e=[this.context,t],i=A_(this.getDrawParams());return e.push.apply(e,i),e.push.apply(e,this._drawContext),e},i._drawLayer=function(){var t=this._prepareDrawParams();if(t){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.layer.draw.apply(this.layer,t.concat(i)),this.completeRender()}},i._drawLayerOnInteracting=function(){if(this.layer.drawOnInteracting){var t=this._prepareDrawParams();if(t){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.layer.drawOnInteracting.apply(this.layer,t.concat(i)),this.completeRender()}}},e}(Bd);function A_(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var E_=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.isCanvasRender=function(){return!0},i.prepareToDraw=function(){},i.draw=function(){},i.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},i.play=function(){return this.config("animation",!0),this},i.pause=function(){return this.config("animation",!1),this},i.isPlaying=function(){return this.options.animation},i.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},i.requestMapToRender=function(){return this._getRenderer()&&this._getRenderer().requestMapToRender(),this},i.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},i.onCanvasCreate=function(){return this},i.onZoomStart=function(){},i.onZooming=function(){},i.onZoomEnd=function(){},i.onMoveStart=function(){},i.onMoving=function(){},i.onMoveEnd=function(){},i.onResize=function(){},i.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},e}(hp);E_.mergeOptions({doubleBuffer:!1,animation:!1}),E_.registerRenderer("canvas",P_);var L_=new Gh(0,0),R_=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.getParticles=function(){},i.draw=function(t,e){var i=this.getParticles(Va());if(i&&0!==i.length){var n=this.getMap(),r=e.extent;e.maskExtent&&(r=e.extent.intersection(e.maskExtent)),r=r.convertTo((function(t){return n._pointToContainerPoint(t,void 0,0,L_)}));for(var s=2*Math.PI,o=0,a=i.length;o<a;o++){var h=i[o].point;if(r.contains(h)){var l=i[o].color||this.options.lineColor||"#fff",c=i[o].r;t.fillStyle!==l&&(t.fillStyle=l),c<=2?t.fillRect(h.x-c/2,h.y-c/2,c,c):(t.beginPath(),t.arc(h.x,h.y,c/2,0,s),t.fill())}}this._fillCanvas(t)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},i._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out";var i=this.options.trail||30;t.fillStyle="rgba(0, 0, 0, "+1/i+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}(E_);R_.mergeOptions({animation:!0}),R_.registerRenderer("canvas",function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},i.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},i.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(P_));var O_,D_,I_=new Ud,k_=function(t){function e(e,i,n){var r;(r=t.call(this,n)||this).target=e,e.once("remove",r.delete,Fh(Fh(r)));var s=r.options.symbol,o=s.markerLineWidth||1;return r.w=s.markerWidth+o,r.h=s.markerHeight+o,r.opacity=Za(s.opacity)?1:s.opacity,r.map=i,r.events=n.events,r._fetchImage(),r.addTo(i),r}Nh(e,t);var i=e.prototype;return i.getCursor=function(){return this.options.cursor||"default"},i._fetchImage=function(){var t=this.map,e=this.options.symbol,i=e.markerFile;this.url=i||Ac(e);var n=I_.getImage(this.url);if(!n){var r=this.w,s=this.h;if(i)(n=new Image).onload=function(){var e=t.getRenderer();e&&e.setToRedraw()},n.src=this.url;else{var o=document.createElement("canvas");o.width=r,o.height=s,n=bf(o.getContext("2d"),{x:r/2,y:s/2},e,I_)}I_.addResource([this.url,r,s],n)}I_.login(this.url),this._img=n},i.setContainerPoint=function(t){this._point=t,this._point._sub(this.w/2,this.h/2)},i.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},i.offset=function(t){this._point._add(t)},i.render=function(t){if(!this._img)return!1;var e=this.options.symbol,i=e.markerDx||0,n=e.markerDy||0,r=this.map,s=this._point,o=s.x,a=s.y,h=this.w,l=this.h;if(o+h>0&&o<r.width&&a+l>0&&a<r.height){var c=r.getDevicePixelRatio();return t.globalAlpha=this.opacity,t.drawImage(this._img,Math.round((o+i)*c),Math.round((a+n)*c),Math.round(h*c),Math.round(l*c)),!0}return!1},i.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}I_.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},i.hitTest=function(t){var e=this.options.symbol,i=e.markerDx||0,n=e.markerDy||0,r=this.w,s=this.h,o=this._point.x+i,a=this._point.y+n;return t.x>=o&&t.x<=o+r&&t.y>=a&&t.y<=a+s},i.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},i.onEvent=function(t){this.fire(t.type,t)},i.mousedown=function(t){var e=t.target,i=this.options.cursor;i&&e.setCursor(i),this.onDragstart(t)},i.onDragstart=function(t){var e=t.containerPoint,i=t.target,n=i._panels.mapWrapper||i._containerDOM,r=this._dragger=new Uu(n);r.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),r.type="handle",r.onMouseDown(t.domEvent),O_=e.x,D_=e.y,this.fire("dragstart",{containerPoint:e})},i.onDragging=function(t){if(this._dragger){var e=this.map,i=tu(t.domEvent,e._containerDOM),n={x:i.x-O_,y:i.y-D_},r=e.containerPointToCoord(new Gh(O_,D_)),s=e.containerPointToCoord(i);O_=i.x,D_=i.y,this.offset(n),this.fire("dragging",{containerPoint:i,coordOffset:s._sub(r)})}},i.onDragend=function(t){if(this._dragger){var e=this.map;e.resetCursor();var i=tu(t.domEvent,e._containerDOM),n={x:i.x-O_,y:i.y-D_};this.offset(n),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:i})}},e}(Eu(Ou)),z_=function(){function t(t,e){this.target=t,t.once("remove",this.delete,this),this.map=e,this.addTo(e)}var e=t.prototype;return e.setPoints=function(t){this.points=t;var e=t.map((function(t){return t.x})),i=t.map((function(t){return t.y}));this.xmin=Math.min.apply(Math,e),this.xmax=Math.max.apply(Math,e),this.ymin=Math.min.apply(Math,i),this.ymax=Math.max.apply(Math,i)},e.hitTest=function(){return!1},e.render=function(t){var e=this.map;if(!(this.xmax<=0||this.xmin>=e.width||this.ymax<=0||this.ymin>=e.height)){var i=e.getDevicePixelRatio();t.lineWidth=1,t.strokeStyle="#000",t.globalAlpha=1,t.beginPath();var n=this.points;t.moveTo(s(n[0].x),s(n[0].y));for(var r=1;r<this.points.length;r++)t.lineTo(s(n[r].x),s(n[r].y));t.closePath(),t.stroke()}function s(t){return Math.round(t)*i+.5}},e.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},e.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}},t}(),N_=Na+"_edit_stage_";function F_(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}var j_={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:F_("ellipse",1),vertexHandleSymbol:F_("square",1),newVertexHandleSymbol:F_("square",.4)},B_=function(t){function e(e,i){var n;return(n=t.call(this,i)||this)._geometry=e,n._geometry?n:Fh(n)}Nh(e,t);var i=e.prototype;return i.getMap=function(){return this._geometry.getMap()},i.prepare=function(){var t=this.getMap();t&&(t.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},i._prepareEditStageLayer=function(){var t=this._geometry.getLayer();if("canvas"===t.options.renderer){var e=this.getMap(),i=Zh(),n=N_+i+"_shadow";if(this._shadowLayer=e.getLayer(n),!this._shadowLayer){var r=t.constructor;this._shadowLayer=new r(n),e.addLayer(this._shadowLayer)}}},i.start=function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0,this.prepare();var t,e=this._geometry,i="canvas"===this._geometry.getLayer().options.renderer;this._geometryDraggble=e.options.draggable,i?(e.config("draggable",!1),(t=e.copy()).setSymbol(e._getInternalSymbol()),t.copyEventListeners(e),e._getParent()&&t.copyEventListeners(e._getParent()),t._setEventTarget(e),t.setId(null).config({draggable:!1}),this._shadow=t,e.hide()):e instanceof jp&&e.config("draggable",!0),this._switchGeometryEvents("on"),(e instanceof jp||e instanceof Kp||e instanceof tg||e instanceof $p)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(t),e instanceof jp?t&&(t.config("draggable",!0),t.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),e instanceof jp&&!1!==this.options.resize?this.createMarkerEditor():e instanceof Kp?this.createCircleEditor():e instanceof tg||e instanceof $p?this.createEllipseOrRectEditor():e instanceof eg||(e instanceof zp||e instanceof Up)&&this.createPolygonEditor()}},i.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()?(this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")):this.fire("remove")},i.isEditing=function(){return!Za(this.editing)&&this.editing},i._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},i._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var i in e)this._geometry[t](i,e[i],this)}},i._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},i._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},i._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;e||(this._editOutline=new z_(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var i=this._editOutline.points;if(t instanceof jp)this._editOutline.setPoints(t.getContainerExtent().toArray(i));else{var n=this.getMap();(i=t._getPrjExtent().toArray(i)).forEach((function(t){return n._prjToContainerPoint(t,null,t)})),this._editOutline.setPoints(i)}return e},i._createCenterHandle=function(){var t,e=this,i=this.getMap(),n=this.options.centerHandleSymbol,r=i.coordToContainerPoint(this._geometry.getCenter()),s=this.createHandle(r,{symbol:n,cursor:"move",onDown:function(){if(e._shadow){var i=Ec((t=e._shadow.copy())._getInternalSymbol(),.5);t.setSymbol(i).addTo(e._geometry.getLayer())}},onMove:function(i){var n=i.coordOffset;t?t.translate(n):e._geometry.translate(n)},onUp:function(){var i=t||e._geometry;e._update("setCoordinates",Gu.toNumberArrays(i.getCoordinates())),t&&t.remove()}});this._addRefreshHook((function(){var t=e._geometry.getCenter();s.setContainerPoint(i.coordToContainerPoint(t))}))},i._createHandleInstance=function(t,e){var i=this.getMap(),n=Bl(e.symbol,(function(){return[i.getZoom(),{"{bearing}":i.getBearing(),"{pitch}":i.getPitch(),"{zoom}":i.getZoom()}]})),r=this.options.removeVertexOn,s=new k_(this,i,{symbol:n,cursor:e.cursor,events:r});return s.setContainerPoint(t),s},i.createHandle=function(t,e){e||(e={});var i=this._createHandleInstance(t,e),n=this;return i.on("dragstart",(function(t){return this._updating=!0,e.onDown&&(this._geometry.fire("handledragstart"),e.onDown.call(n,t.containerPoint,t)),!1}),this),i.on("dragging",(function(t){return n._hideContext(),e.onMove&&(this._geometry.fire("handledragging"),e.onMove.call(n,t)),!1}),this),i.on("dragend",(function(t){return e.onUp&&(this._geometry.fire("handledragend"),e.onUp.call(n,t)),this._updating=!1,!1}),this),e.onRefresh&&(i.refresh=e.onRefresh),i},i._createResizeHandles=function(t,e,i){var n=this,r=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],s=[null,"y",null,"x","x",null,"y",null],o=this._geometry,a=o instanceof jp;t||(t=[]);var h=this,l=[],c={},u=this.getMap(),d=this.options.vertexHandleSymbol,f=function(){for(var f=function(){if(a){var t=o.getContainerExtent();return[new Gh(t.xmin,t.ymin),new Gh((t.xmax+t.xmin)/2,t.ymin),new Gh(t.xmax,t.ymin),new Gh(t.xmin,(t.ymin+t.ymax)/2),new Gh(t.xmax,(t.ymin+t.ymax)/2),new Gh(t.xmin,t.ymax),new Gh((t.xmax+t.xmin)/2,t.ymax),new Gh(t.xmax,t.ymax)]}var e=o._getPrjExtent();return[new Gh(e.xmin,e.ymax),new Gh((e.xmax+e.xmin)/2,e.ymax),new Gh(e.xmax,e.ymax),new Gh(e.xmin,(e.ymax+e.ymin)/2),new Gh(e.xmax,(e.ymax+e.ymin)/2),new Gh(e.xmin,e.ymin),new Gh((e.xmax+e.xmin)/2,e.ymin),new Gh(e.xmax,e.ymin)]}(),p=function(p){if(Array.isArray(t)&&t.some((function(t){return t===p})))return"continue";var g,m=f[p],_=a?m:u._prjToContainerPoint(m);if(l.length<f.length-t.length){var v=n.createHandle(_,{symbol:d,cursor:r[p],axis:s[p],onMove:(g=p,function(t){h._updating=!0,e(t.containerPoint,g),o.fire("resizing")}),onUp:function(){h._updating=!1,i()}});c[p]=l.length,l.push(v)}else l[c[p]].setContainerPoint(_)},g=0;g<f.length;g++)p(g)};return f(),this._addRefreshHook(f),l},i.createMarkerEditor=function(){var t=this,e=this._shadow||this._geometry,i=this.getMap();if(e._canEdit()){this._history||this._recordHistory(f());var n=e._getInternalSymbol(),r=new Gh(0,0);qa(n.markerDx)&&(r.x=n.markerDx),qa(n.markerDy)&&(r.y=n.markerDy);var s=null,o="middle",a="middle";if(jf.test(n)){var h=n.markerType;"pin"===h||"pie"===h||"bar"===h?(s=[5,6,7],o="bottom"):"rectangle"===h&&(s=[0,1,2,3,5],o="top",a="left")}else(Df.test(n)||Bf.test(n))&&(o="bottom",s=[5,6,7]);var l,c=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var u=e.getSize();l=u.width/u.height}var d=this._createResizeHandles(s,(function(n,h){if(s&&s.indexOf(h)>=0){var u=i.containerPointToCoordinate(n.sub(r)),f=e.getCoordinates();u.x=f.x,e.setCoordinates(u),t._updateCoordFromShadow(!0),n=d[d.length-1-h].getContainerPoint()}var p=i.coordToContainerPoint(e.getCoordinates()).add(r),g=e._getInternalSymbol(),m=n.sub(p);"bottom"===o&&n.y>p.y&&(m.y=0);var _="middle"===o?2:1,v="left"===a?1:2,y=Math.abs(m.x)*v,x=Math.abs(m.y)*_;l&&(x=(y=Math.max(y,x*l))/l);var w=c[h];e instanceof lg?((l||0===w||2===w)&&(e.setWidth(y),e!==t._geometry&&t._geometry.setWidth(y)),(l||1===w||2===w)&&(e.setHeight(x),e!==t._geometry&&t._geometry.setHeight(x))):((l||0===w||2===w)&&(g.markerWidth=Math.min(y,t._geometry.options.maxMarkerWidth||1/0)),(l||1===w||2===w)&&(g.markerHeight=Math.min(x,t._geometry.options.maxMarkerHeight||1/0)),e.setSymbol(g),e!==t._geometry&&t._geometry.setSymbol(g))}),(function(){t._update(f())}))}else console;function f(){var t=[["setCoordinates",e.getCoordinates().toArray()]];return e instanceof lg?(t.push(["setWidth",e.getWidth()]),t.push(["setHeight",e.getHeight()])):t.push(["setSymbol",e.getSymbol()]),t}},i.createCircleEditor=function(){var t=this,e=this._shadow||this._geometry,i=this.getMap();this._history||this._recordHistory([["setCoordinates",e.getCoordinates().toArray()],["setRadius",e.getRadius()]]),this._createResizeHandles(null,(function(n){var r=e.getCenter(),s=i.containerPointToCoord(n),o=new Up([[r.x,r.y],[s.x,r.y]]),a=new Up([[r.x,r.y],[r.x,s.y]]),h=Math.max(i.computeGeometryLength(o),i.computeGeometryLength(a));e.setRadius(h),e!==t._geometry&&t._geometry.setRadius(h)}),(function(){t._update("setRadius",e.getRadius())}))},i.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],i=this._shadow||this._geometry;this._history||this._recordHistory(a());var n,r=this.getMap(),s=this._geometry instanceof tg;this.options.fixAspectRatio&&(n=i.getWidth()/i.getHeight());var o=this._createResizeHandles(null,(function(a,h){var l,c,u,d=s?1:2,f=o[h].getContainerPoint(),p=e[h];if(s){var g=o[7-h].getContainerPoint(),m=(l=f.sub(g)).abs();c=r.pixelToDistance(m.x,0),u=r.pixelToDistance(0,m.y);var _=i.getSize(),v=i.getCoordinates(),y=i.getWidth(),x=i.getHeight(),w=r.containerPointToCoord(a),b=r.containerPointToCoord(g),M=new Up([[b.x,b.y],[w.x,b.y]]),S=new Up([[b.x,b.y],[b.x,w.y]]);if(c=r.computeGeometryLength(M),u=r.computeGeometryLength(S),0===p)if(n&&(m.y=m.x/n,_.height=Math.abs(m.y),u=c/n),f.y=g.y-_.height/2,w.y=v.y,4===h)w.x=Math.min(w.x,v.x);else{var C=r.locate(v,y,0);w.x=r.locate(new Gu(C.x,w.y),-c,0).x}else if(1===p)n&&(m.x=m.y*n,_.width=Math.abs(m.x),c=u*n),f.x=g.x-_.width/2,w.x=v.x,w.y=Math.max(w.y,b.y);else{if(n&&(c>u*n?(u=c/n,f.y=g.y+m.x*$h(l.y)/n):(c=u*n,f.x=g.x+m.y*$h(l.x)*n)),0===h||5===h){var T=0===h?r.locate(v,y,0):r.locate(v,y,-x);w.x=r.locate(new Gu(T.x,w.y),-c,0).x}else w.x=Math.min(w.x,b.x);w.y=Math.max(w.y,b.y)}i.setCoordinates(w),t._updateCoordFromShadow(!0)}else{var P=i.getCenter(),A=r.containerPointToCoord(f),E=new Up([[P.x,P.y],[A.x,P.y]]),L=new Up([[P.x,P.y],[P.x,A.y]]);c=r.computeGeometryLength(E),u=r.computeGeometryLength(L),n&&(u=(c=Math.max(c,u*n))/n)}(n||0===p||2===p)&&(i.setWidth(c*d),i!==t._geometry&&t._geometry.setWidth(c*d)),(n||1===p||2===p)&&(i.setHeight(u*d),i!==t._geometry&&t._geometry.setHeight(u*d))}),(function(){t._update(a())}));function a(){return[["setCoordinates",i.getCoordinates().toArray()],["setWidth",i.getWidth()],["setHeight",i.getHeight()]]}},i.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow||this._geometry,i=this;this._history||this._recordHistory("setCoordinates",Gu.toNumberArrays(e.getCoordinates()));var n=e instanceof zp?3:2,r="maptalks--editor-vertex-index",s={0:[]},o={0:[]};function a(t){if(void 0===t&&(t=0),e instanceof zp){var i=e.getCoordinates()[t]||[];return i.slice(0,i.length-1)}return e.getCoordinates()}function h(t){return void 0===t&&(t=0),0===t?e._getPrjCoordinates():e._getPrjHoles()[t-1]}function l(){for(var t in s){for(var e=s[t].length-1;e>=0;e--)s[t][e][r]=e;for(var n=o[t].length-1;n>=0;n--)o[t][n][r]=n}i._updateCoordFromShadow()}function c(t){i._updating=!0;var a=t.target,c=a[r],u=qa(a._ringIndex)?a._ringIndex:0,d=h(u);if(!(d.length<=n)){var f,p=e instanceof Up&&(0===c||c===d.length-1);d.splice(c,1),u>0?e._prjHoles[u-1]=d:e._setPrjCoordinates(d),e._updateCache(),s[u].splice(c,1)[0].delete(),c<o[u].length&&o[u].splice(c,1)[0].delete(),f=0===c?o[u].length-1:c-1,o[u].splice(f,1)[0].delete(),p||o[u].splice(f,0,m.call(i,f,u)),l(),i._updating=!1}}function u(n,r,s){void 0===s&&(s=0);var a=i._geometry.snapTo;a&&Qa(a)&&(n=i._geometry.snapTo(n)||n);var l,c=h(s),u=t._containerPointToPrj(n.sub(f())),d=c[r];d.x=u.x,d.y=u.y,e._updateCache(),e.onShapeChanged(),i._updateCoordFromShadow(!0),l=0===r?o[s].length-1:r-1,o[s][r]&&o[s][r].refresh(),o[s][l]&&o[s][l].refresh()}var d=new Gh(0,0);function f(){var t=e._getCompiledSymbol();return d.x=t.lineDx||0,d.y=t.lineDy||0,d}function p(e,n,s){void 0===n&&(n=0);var o=(s||a(n))[e],h=i.createHandle(t.coordToContainerPoint(o)._add(f()),{symbol:i.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){u(h.getContainerPoint(),h[r],n)},onRefresh:function(e,i){o=(i||a(n))[h[r]];var s=t.coordToContainerPoint(o);h.setContainerPoint(s._add(f()))},onUp:function(){i._updateCoordFromShadow()},onDown:function(t,e){!e||!e.domEvent||e.domEvent.button}});return h[r]=e,h._ringIndex=n,h.on(i.options.removeVertexOn,c),h}var g=!1;function m(n,c,d){void 0===c&&(c=0);var _,v=d||a(c);_=n+1>=v.length?v[0]:v[n+1];var y=v[n].add(_).multi(.5),x=i.createHandle(y,{symbol:i.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(n,s){if(!s||!s.domEvent||2!==s.domEvent.button){var a=h(c),l=x[r],u=x.getContainerPoint(),d=t._containerPointToPrj(u);a.splice(l+1,0,d),c>0?e._prjHoles[c-1]=a:e._setPrjCoordinates(a),e._updateCache(),x.opacity=1,o[c].splice(l,0,m.call(i,l,c),m.call(i,l+1,c)),g=!0}},onMove:function(){u(x.getContainerPoint(),x[r]+1,c)},onUp:function(t){if(t&&t.domEvent&&2===t.domEvent.button)g=!1;else{var e=x[r];Yh(x,o[c]),x.delete(),s[c].splice(e+1,0,p.call(i,e+1,c)),l(),i._updateCoordFromShadow(),g=!1}},onRefresh:function(e,i){v=i||a(e);var n,s=x[r];n=s===v.length-1?0:s+1;var o=v[s].add(v[n]).multi(.5),h=t.coordToContainerPoint(o);x.setContainerPoint(h._add(f()))}});return x[r]=n,x}if(e instanceof zp)for(var _=e.getHoles().length+1,v=0;v<_;v++){s[v]=[],o[v]=[];for(var y=a(v),x=0,w=y.length;x<w;x++)s[v].push(p.call(this,x,v,y)),x<w-1&&o[v].push(m.call(this,x,v,y));o[v].push(m.call(this,y.length-1,v,y))}else{for(var b=a(0),M=0,S=b.length;M<S;M++)s[0].push(p.call(this,M,0,b)),M<S-1&&o[0].push(m.call(this,M,0,b));o[0].length&&2===e.getCoordinates().length&&(o[0][0].options.symbol.markerDx=12)}this._addRefreshHook((function(){if(!g){for(var t in o)for(var i=a(t),n=o[t].length-1;n>=0;n--)o[t][n].refresh(t,i);for(var r in o[0].length&&e instanceof Up&&(2===e.getCoordinates().length?o[0][0].options.symbol.markerDx=12:e.getCoordinates().length>2&&(o[0][0].options.symbol.markerDx=0)),s)for(var h=a(r),l=s[r].length-1;l>=0;l--)s[r][l].refresh(r,h)}}))},i._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},i._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},i._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},i._update=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];this._exeHistory([t,i]),this._recordHistory.apply(this,[t].concat(i))},i._updateCoordFromShadow=function(t){var e=(this._shadow||this._geometry).getCoordinates(),i=this._geometry,n=this._updating;this._updating=!0,i.setCoordinates(e),t||this._recordHistory("setCoordinates",Gu.toNumberArrays(i.getCoordinates())),this._updating=n},i._recordHistory=function(t){this._history||(this._history=[],this._historyPointer=0);for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(this._history.length){var r=this._history[this._history.length-1];if(r[0]===t&&JSON.stringify(r[1])===JSON.stringify(i))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([t,i]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},i.cancel=function(){if(!this._history||0===this._historyPointer)return this;this._historyPointer=0;var t=this._history[0];return this._exeAndReset(t),this},i.undo=function(){if(!this._history||0===this._historyPointer)return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},i.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return this;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},i._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,i=this._historyPointer;this.stop(),this._history=e,this._historyPointer=i,this.start()}},i._onDragStart=function(){this._updating=!0},i._onDragEnd=function(){this._updating=!1},i._exeHistory=function(t){if(Array.isArray(t)){var e=this._updating;this._updating=!0;var i=this._shadow||this._geometry,n=this._geometry;Array.isArray(t[0])?t[0].forEach((function(t){var e=t[0],r=t.slice(1);i[e].apply(i,r),i!==n&&n[e].apply(n,r)})):(i[t[0]].apply(i,t[1]),i!==n&&n[t[0]].apply(n,t[1])),this._updating=e}},e}(Eu(Ou));B_.mergeOptions(j_);var U_={startEditText:function(){return this.getMap()?(this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),du(this._textEditor,"mousedown dblclick",Yc),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var i=this._getEditorOffset();this._editUIMarker=new mm(this.getCoordinates(),{animation:null,content:e,dx:i.dx,dy:i.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,i=0,n=t.textHorizontalAlignment;return"middle"===n||Za(n)?(e=(t.textDx||0)-2,i=(t.textDy||0)-2):(e=(t.markerDx||0)-2,i=(t.markerDy||0)-2),{dx:e,dy:i}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),i=this._getInternalSymbol()||{},n=e.width,r=i.textFill||"#000000",s=i.textSize||12,o=e.height,a=i.markerLineColor||"#000",h=i.markerFill||"#3398CC",l=i.textLineSpacing||0,c=Hc("div");return c.contentEditable=!0,c.style.cssText="background:"+h+"; border:1px solid "+a+";\n            color:"+r+";font-size:"+s+"px;width:"+(n-2)+"px;height:"+(o-2)+"px;margin: auto;\n            line-height:"+(s+l)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",c.innerText=t,uu(c,"mousedown dblclick",Yc),c.onkeyup=function(t){var e=c.style.height||0;13===t.keyCode&&(c.style.height=parseInt(e)+s/2+"px")},c},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}};hg.include(U_),op.include({animate:function(t,e,i){var n=this;this._animPlayer&&this._animPlayer.finish(),Qa(e)&&(i=e),e||(e={});var r,s=this.getMap(),o=this._getProjection(),a=this._prepareAnimationStyles(t),h=e.focus;if(delete this._animationStarted,s){var l=s._getRenderer();e.framer=function(t){l.callInNextFrame(t)}}var c=Op.animate(a,e,(function(t){if(s&&s.isRemoved())c.finish();else{s&&!n._animationStarted&&h&&s.onMoveStart();var e=t.styles;for(var a in e)if("symbol"!==a&&"translate"!==a&&e.hasOwnProperty(a)){var l="set"+a[0].toUpperCase()+a.slice(1);n[l](e[a])}var u=e.translate;if(u){var d=u;r&&(d=u.sub(r)),r=u,n.translate(d)}var f=e.symbol;if(f){var p=n.getSymbol()||{};n.setSymbol(Lc(p,f))}if(s&&h){var g=o.project(n.getCenter());s._setPrjCenter(g);var m=s._parseEventFromCoord(o.unproject(g));"running"!==c.playState?s.onMoveEnd(m):s.onMoving(m)}n._fireAnimateEvent(c.playState),i&&i(t)}}),this);return this._animPlayer=c,this._animPlayer.play()},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),i={};for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if("translate"!==n&&"symbol"!==n){var s=this["get"+n[0].toUpperCase()+n.substring(1)]();i[n]=[s,r]}else if("symbol"===n){var o=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");o=[];for(var a=t.symbol,h=0;h<a.length;h++)if(a[h]){var l={};for(var c in a[h])a[h].hasOwnProperty(c)&&(l[c]=[e[h][c],a[h][c]]);o.push(l)}else o.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var u in o={},r)r.hasOwnProperty(u)&&(o[u]=[e[u],r[u]])}i.symbol=o}else"translate"===n&&(i.translate=new Gu(r))}return i},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var G_=Na+"_drag_stage",H_=zh.touch?"touchstart mousedown":"mousedown",V_=function(t){function e(e){return t.call(this,e)||this}Nh(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on(H_,this._startDrag,this)},i.removeHooks=function(){this._endDrag(),this.target.off(H_,this._startDrag,this),delete this.container},i._prepareDragHandler=function(){this._dragHandler=new Uu(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},i._prepareShadow=function(){var t=this,e=this.target;if("canvas"===e.getLayer().options.renderer){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var i=this._shadow=e.copy();if(i.getGeometries){var n=i.getGeometries(),r=e.getGeometries();n.forEach((function(e,i){t._updateShadowSymbol(e,r[i])}))}else this._updateShadowSymbol(i,e);i.setId(null),this._prepareShadowConnectors()}},i._updateShadowSymbol=function(t,e){if(t.setSymbol(e._getInternalSymbol()),e.options.dragShadow){var i=Ec(t._getInternalSymbol(),.5);t.setSymbol(i)}},i._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,i=this._dragStageLayer._getRenderer().resources,n=[];if(fg._hasConnectors(t))for(var r=fg._getConnectors(t),s=0,o=r.length;s<o;s++){var a=r[s],h=a.config(),l=a._getInternalSymbol();h.symbol=Ec(l,.5);var c=void 0;c=a.getConnectSource()===t?new a.constructor(e,a.getConnectTarget(),h):new a.constructor(a.getConnectSource(),e,h),n.push(c),a.getLayer()&&a.getLayer()._getRenderer()&&i.merge(a.getLayer()._getRenderer().resources)}this._shadowConnectors=n,n.push(e),this._dragStageLayer.bringToFront().addGeometry(n)},i._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},i._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer(G_),this._dragStageLayer||(this._dragStageLayer=new yg(G_,{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer));var i=new Ud;i.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=i},i._startDrag=function(t){var e=this.target.getMap();if(e&&(!this.target._getParent()&&!this.isDragging())){var i=t.domEvent;i.touches&&i.touches.length>1||2===i.button||(this.container=e._panels.mapWrapper||e._containerDOM,this.target.on("click",this._endDrag,this),this._lastCoord=this._correctCoord(t.coordinate),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),uu(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1)}},i._dragging=function(t){var e=this.target,i=e.getMap(),n=i._parseEvent(t.domEvent),r=n.domEvent;if(!(r.touches&&r.touches.length>1)){var s=i._getVisualHeight(i.options.maxVisualPitch);if(!(n.containerPoint.y<i.height-s)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",n)),this.target._fireEvent("dragstart",this._startParam||n),void delete this._startParam;var o=this._shadow||e,a=o.options.dragOnAxis,h=o.options.dragOnScreenAxis,l=n.containerPoint,c=n.coordinate;this._lastPoint=this._lastPoint||l,this._lastCoord=this._lastCoord||c,h?("x"===a?l.y=this._lastPoint.y:"y"===a&&(l.x=this._lastPoint.x),c=i.containerPointToCoord(l)):c=this._correctCoord(c);var u=l.sub(this._lastPoint),d=c.sub(this._lastCoord);h||("x"===a?u.y=d.y=0:"y"===a&&(u.x=d.x=0)),this._lastPoint=l,this._lastCoord=c,o.translate(d),o===e||e.options.dragShadow||e.translate(d),n.coordOffset=d,n.pointOffset=u,o._fireEvent("dragging",n),o!==e&&e._fireEvent("dragging",n)}}},i._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&du(this.container,"mouseleave",this._endDrag),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var i=e.getMap();if(this.enabled()&&i){var n=i._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(n),this._moved&&e._fireEvent("dragend",n)}}},i.isDragging=function(){return!!this._isDragging},i._updateTargetAndRemoveShadow=function(t){if(this._shadow){var e=this.target,i=e.getMap();e.options.dragShadow||e.show();var n=this._shadow;if(n){if(e.options.dragShadow)if(e.getGeometries){var r=n.getGeometries(),s=e.getGeometries();r.forEach((function(t,e){s[e].setCoordinates(r[e].getCoordinates())}))}else e.setCoordinates(n.getCoordinates());n._fireEvent("dragend",t),n.remove(),delete this._shadow}this._shadowConnectors&&(i.getLayer(G_).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&(this._dragStageLayer._getRenderer().resources=new Ud,this._dragStageLayer.remove())}},i._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var i=this.target;if(!i.getMinAltitude())return t;var n=(i.getMinAltitude()+i.getMaxAltitude())/2;return e.locateByPoint(t,0,-n)},e}(Ru);op.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null,dragOnScreenAxis:!1}),op.addInitHook("addHandler","draggable",V_),op.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),op.include({startEdit:function(t){return this.getMap()&&this.options.editable?(this._editor&&this.endEdit(),this._editor=new B_(this,t),this._editor.start(),this._getParent()||this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this._getParent()||this.fire("editend")),this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this._getParent()||this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this._getParent()||this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._editor.cancel(),this._getParent()||this.fire("canceledit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),op.include({_onEvent:function(t,e){var i=this.getMap();if(i){var n=e||this._getEventTypeToFire(t);"contextmenu"===n&&this.listens("contextmenu")&&(Yc(t),Jc(t));var r=i._getEventParams(t);qa(this._pickGeometryIndex)&&(r.pickGeometryIndex=this._pickGeometryIndex),this._fireEvent(n,r)}},_getEventTypeToFire:function(t){return t.type}}),op.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof bm?(this._infoWindow=t,this._infoWinOptions=Wa({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=Wa({},t),this._infoWindow?this._infoWindow.setOptions(t):this.getMap()&&this._bindInfoWindow(),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(){var t=this._infoWinOptions;return t?(this._infoWindow=new bm(t),this._infoWindow.addTo(this),this):this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}});var W_=new Gh(0,0),Z_=new Gh(0,0),q_=new Gh(0,0),X_=new Gh(0,0),J_=[],Y_=function(t){function e(){return t.call(this,Nd)||this}Nh(e,t);var i=e.prototype;return i.checkUrl=function(t){return t&&Ya(t)?wl(t):t},i.fetchImage=function(t,e,i,n){var r={url:t=this.checkUrl(t),fetchOptions:n};this.send(r,J_,i,e)},e}(zd),Q_=new Image,K_=function(t){function e(e){var i;return(i=t.call(this,e)||this).tilesInView={},i.tilesLoading={},i._parentTiles=[],i._childTiles=[],i._tileQueue=[],i.tileCache=new _u(e.options.maxCacheSize,i.deleteTile.bind(Fh(Fh(i)))),!zh.decodeImageInWorker||!i.layer.options.decodeImageInWorker||"gl"!==e.options.renderer&&zh.safari||(i._tileImageWorkerConn=new Y_),i._compareTiles=tv.bind(Fh(Fh(i))),i}Nh(e,t);var i=e.prototype;return i.getCurrentTileZoom=function(){return this._tileZoom},i.draw=function(t,e){var i=this.getMap();if(this.isDrawable()){var n=this.prepareCanvas();if(!n||n.intersects(this.canvasExtent2D)){var r;this._renderTimestamp!==t&&(this._consumeTileQueue(),this._renderTimestamp=t);var s=!1,o=this._frameTiles;if(o&&t===o.timestamp){if(o.empty)return;r=o}else{if(!(r=this._getTilesInCurrentFrame()))return this._frameTiles={empty:!0,timestamp:t},void this.completeRender();s=!0,this._frameTiles=r,this._frameTiles.timestamp=t,r.loadingCount&&this.loadTileQueue(r.tileQueue)}var a=r,h=a.tiles,l=a.childTiles,c=a.parentTiles,u=a.placeholders,d=a.loading,f=a.loadingCount;this._drawTiles(h,c,l,u,e),f||d||(i.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),s&&this._retireTiles()}else this.completeRender()}},i.getTileGridsInCurrentFrame=function(){return this._frameTileGrids},i._getTilesInCurrentFrame=function(){var t=this.getMap(),e=this.layer.getTiles();if(this._frameTileGrids=e,!(e=e.tileGrids)||!e.length)return null;var i=e.reduce((function(t,e){return t+(e&&e.tiles&&e.tiles.length||0)}),0);i>=this.tileCache.max/2&&this.tileCache.setMaxSize(2*i+1);var n=0,r=!1,s={},o=[],a=[],h={},l=[],c={},u=[],d={},f={},p=this._markTiles(),g=this._getLoadLimit(),m=e.length;this._tileZoom=e[0].zoom;for(var _=0;_<m;_++){var v=e[_].tiles,y=void 0;v.length&&(y=this._generatePlaceHolder(v[0].res));for(var x=0,w=v.length;x<w;x++){var b=v[x],M=b.id,S=!1;if(this._isLoadingTile(M))S=r=!0,this.tilesLoading[M].current=!0;else{var C=this._getCachedTile(M);if(C)C.image&&this.getTileOpacity(C.image)<1&&(S=r=!0,this.setToRedraw()),o.push(C);else if(S=r=!0,!(g&&n+p[0]>g)&&(!t.isInteracting()||t.isMoving()||t.isRotating()))n++,f[M]=b}if(S&&!s[M]){s[M]=1,y&&!d[M]&&(b.cache=!1,u.push({image:y,info:b}),d[M]=1);var T=this._findParentTile(b);if(T){var P=T.info.id;void 0===h[P]&&(h[P]=a.length,a.push(T))}else if(!a.length){var A=this._findChildTiles(b);A.length&&A.forEach((function(t){c[t.info.id]||(l.push(t),c[t.info.id]=1)}))}}}}return a.length&&(l.length=0,this._childTiles.length=0),{childTiles:l,parentTiles:a,tiles:o,placeholders:u,loading:r,loadingCount:n,tileQueue:f}},i.isTileCachedOrLoading=function(t){return this.tileCache.get(t)||this.tilesInView[t]||this.tilesLoading[t]},i._drawTiles=function(t,e,i,n,r){var s=this;e.length&&(e.sort((function(t,e){return Math.abs(e.info.z-s._tileZoom)-Math.abs(t.info.z-s._tileZoom)})),this._parentTiles=e),i.length&&(this._childTiles=i);var o={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:r};this.onDrawTileStart(o,r),1===this.layer.options.opacity&&(this._childTiles.forEach((function(t){return s._drawTile(t.info,t.image,r)})),this._parentTiles.forEach((function(t){return s._drawTile(t.info,t.image,r)}))),t.sort(this._compareTiles);for(var a=0,h=t.length;a<h;a++)this._drawTileAndCache(t[a],r);this.layer.options.opacity<1&&(this._childTiles.forEach((function(t){return s._drawTile(t.info,t.image,r)})),this._parentTiles.forEach((function(t){return s._drawTile(t.info,t.image,r)}))),n.forEach((function(t){return s._drawTile(t.info,t.image,r)})),this.onDrawTileEnd(o,r)},i.onDrawTileStart=function(){},i.onDrawTileEnd=function(){},i._drawTile=function(t,e,i){e&&this.drawTile(t,e,i)},i._drawTileAndCache=function(t,e){t.current=!0,this.tilesInView[t.info.id]=t,this._drawTile(t.info,t.image,e),this.tileCache.add(t.info.id,t)},i.drawOnInteracting=function(t,e,i){this.draw(e,i)},i.needToRedraw=function(){var e=this.getMap();return!!this._tileQueue.length||(e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this)))},i.hitDetect=function(){return!1},i._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:0},i.isDrawable=function(){return!this.getMap().getPitch()||(console,this.clear(),!1)},i.clear=function(){this._retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],t.prototype.clear.call(this)},i._isLoadingTile=function(t){return!!this.tilesLoading[t]},i.clipCanvas=function(e){return t.prototype.clipCanvas.call(this,e)},i._clipByPitch=function(t){var e=this.getMap();if(e.getPitch()<=e.options.maxVisualPitch)return!1;if(!this.layer.options.clipByPitch)return!1;var i=e.getContainerExtent(),n=e.getDevicePixelRatio();return t.save(),t.strokeStyle="rgba(0, 0, 0, 0)",t.beginPath(),t.rect(0,Math.ceil(i.ymin)*n,Math.ceil(i.getWidth())*n,Math.ceil(i.getHeight())*n),t.stroke(),t.clip(),!0},i.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var i=t[e],n=this.loadTile(i);void 0===n.loadTime&&(this.tilesLoading[i.id]={image:n,current:!0,info:i})}},i.loadTile=function(t){var e;if(this._tileImageWorkerConn&&this.loadTileImage===this.constructor.prototype.loadTileImage)e={},this._fetchImage(e,t);else{var i=this.layer.getTileSize(t.layer);(e=new Image).width=i.width,e.height=i.height,e.onload=this.onTileLoad.bind(this,e,t),e.onerror=this.onTileError.bind(this,e,t),this.loadTileImage(e,t.url)}return e},i._fetchImage=function(t,e){var i=this;if(t instanceof Image)t.src=e.url;else{var n=e.x,r=e.y,s=Math.abs(n+r)%this._tileImageWorkerConn.workers.length;this._tileImageWorkerConn.fetchImage(e.url,s,(function(n,r){n?i.onTileError(t,e,n):xl(r,(function(t){i.onTileLoad(t,e)}))}),this.layer.options.fetchOptions||{referrer:document.location.href,headers:{accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}})}},i.loadTileImage=function(t,e){var i=this.layer.options.crossOrigin;return Za(i)||(t.crossOrigin=i),Vh(t,[e])},i.abortTileLoading=function(t){t&&(t.onload=$_,t.onerror=$_,t.src=pl)},i.onTileLoad=function(t,e){this._tileQueue.push({tileInfo:e,tileData:t})},i._consumeTileQueue=function(){for(var t=0,e=this.layer.options.tileLimitPerFrame,i=this._tileQueue;i.length&&(e<=0||t<e);){var n=i.shift(),r=n.tileData,s=n.tileInfo;this.checkTileInQueue(r,s)&&(this.consumeTile(r,s),t++)}},i.checkTileInQueue=function(){return!0},i.consumeTile=function(t,e){if(this.layer){var i=e.id;if(this.tilesInView){var n={tile:e,tileImage:t};this.layer.fire("tileload",n),(t=n.tileImage).loadTime=Va(),delete this.tilesLoading[i],this._addTileToCache(e,t),this.setToRedraw()}}},i.onTileError=function(t,e){if(this.layer){if(t.onerrorTick=t.onerrorTick||0,this.layer.options.tileRetryCount>t.onerrorTick)return t.onerrorTick++,void this._fetchImage(t,e);var i=this.layer.options.errorUrl;if(i){if(t instanceof Image&&t.src!==i)return void(t.src=i);(t=new Image).src=i}t=t instanceof Image?t:Q_,this.abortTileLoading(t,e),t.loadTime=0,delete this.tilesLoading[e.id],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e})}},i.drawTile=function(t,e){if(e&&this.getMap()){var i=t.extent2d,n=t.offset,r=W_.set(i.xmin-n[0],i.ymax-n[1]),s=t.z,o=t.id,a=this.getMap(),h=a.getZoom(),l=this.context,c=a._pointAtResToContainerPoint(r,t.res,0,Z_),u=a.getBearing(),d=u||h!==s,f=this.getTileOpacity(e),p=l.globalAlpha;f<1&&(l.globalAlpha=f,this.setToRedraw()),d||c._round();var g=c.x,m=c.y,_=t.extent2d.xmax-t.extent2d.xmin,v=t.extent2d.ymax-t.extent2d.ymin;if(d){l.save(),l.translate(g,m),u&&(l.rotate(-u*Math.PI/180),_+=.1,v+=.1);var y=a._getResolution();if(y!==t.res){var x=t.res/y;l.scale(x,x)}g=m=0}if(Mu.image(l,e,g,m,_,v),this.layer.options.debug){var w=this.layer.options.debugOutline;l.save(),l.strokeStyle=w,l.fillStyle=w,l.strokeWidth=10,l.font="20px monospace";var b=new Gh(g,m);Mu.rectangle(l,b,{width:_,height:v},1,0),Mu.fillText(l,this.getDebugInfo(o),b._add(32,v-14),w),Mu.drawCross(l,g+_/2,m+v/2,2,w),l.restore()}d&&l.restore(),l.globalAlpha!==p&&(l.globalAlpha=p),this.setCanvasUpdated()}},i.getDebugInfo=function(t){var e=t.split("_"),i=e.length;return"x:"+e[i-2]+", y:"+e[i-3]+", z:"+e[i-1]},i._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer);if(!e||!e.options.background)return[];for(var i=this.getMap(),n=[],r=t.res,s=t.extent2d.getMin(),o=t.extent2d.getMax(),a=e._project(i._pointToPrjAtRes(s,r,q_),q_),h=e._project(i._pointToPrjAtRes(o,r,X_),X_),l=1;l<3;l++)this._findChildTilesAt(n,a,h,e,t.z+l);return n},i._findChildTilesAt=function(t,e,i,n,r){var s=n.options.zoomOffset,o=n.getId(),a=n.getSpatialReference().getResolution(r+s);if(a)for(var h,l,c=n._getTileConfig().getTileIndex(e,a),u=n._getTileConfig().getTileIndex(i,a),d=Math.min(c.idx,u.idx),f=Math.max(c.idx,u.idx),p=Math.min(c.idy,u.idy),g=Math.max(c.idy,u.idy),m=d;m<f;m++)for(var _=p;_<g;_++)h=n._getTileId(m,_,r+s,o),this.tileCache.has(h)&&(l=this.tileCache.getAndRemove(h),t.push(l),this.tileCache.add(h,l))},i._findParentTile=function(t){var e=this.getMap(),i=this._getLayerOfTile(t.layer);if(!i||!i.options.background)return null;for(var n=i.getSpatialReference(),r=n.getZoomDirection(),s=i.options.zoomOffset,o=i.options.backgroundZoomDiff,a=t.res,h=t.extent2d.getCenter(),l=i._project(e._pointToPrjAtRes(h,a)),c=1;c<=o;c++){var u=t.z-r*c,d=n.getResolution(u+s);if(d){var f=i._getTileConfig().getTileIndex(l,d),p=i._getTileId(f.x,f.y,u+s,t.layer);if(this.tileCache.has(p)){var g=this.tileCache.getAndRemove(p);return this.tileCache.add(p,g),g}}}return null},i._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},i._getCachedTile=function(t){var e=this.tilesInView,i=this.tileCache.getAndRemove(t);if(i){e[t]=i;var n=this.tilesLoading;if(n&&n[t]){n[t].current=!1;var r=n[t],s=r.image,o=r.info;this.abortTileLoading(s,o),delete n[t]}}else i=e[t];return i},i._addTileToCache=function(t,e){this.tilesInView[t.id]={image:e,current:!0,info:t}},i.getTileOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(Va()-t.loadTime)/(1e3/60*10)):1},i.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,t.prototype.onRemove.call(this)},i._markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var i in this.tilesLoading)this.tilesLoading[i].current=!1,t++;if(this.tilesInView)for(var n in this.tilesInView)this.tilesInView[n].current=!1,e++;return[t,e]},i._retireTiles=function(t){for(var e in this.tilesLoading){var i=this.tilesLoading[e];!t&&i.current||(i.image&&this.abortTileLoading(i.image,i.info),this.deleteTile(i),delete this.tilesLoading[e])}for(var n in this.tilesInView){var r=this.tilesInView[n];r.current||(delete this.tilesInView[n],this.tileCache.has(n)||this.deleteTile(r))}},i.deleteTile=function(t){t&&t.image&&(t.image.close&&t.image.close(),t.image.onload=null,t.image.onerror=null)},i._generatePlaceHolder=function(t){var e=this.getMap(),i=this.layer.options.placeholder;if(!i||e.getPitch())return null;var n=this.layer.getTileSize(),r=t/e._getResolution(),s=this._tilePlaceHolder=this._tilePlaceHolder||Mu.createCanvas(1,1,e.CanvasClass);return s.width=n.width*r,s.height=n.height*r,Qa(i)?i(s):function(t){var e=t.getContext("2d"),i=t.width,n=t.height,r=i/16,s=n/16;e.beginPath();for(var o=0;o<16;o++)e.moveTo(0,o*s),e.lineTo(i,o*s),e.moveTo(o*r,0),e.lineTo(o*r,n);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var a=[[0,0],[i,0],[0,n],[i,n],[0,0],[0,n],[i,0],[i,n],[0,n/2],[i,n/2],[i/2,0],[i/2,n]],h=1;h<a.length;h+=2)e.moveTo(a[h-1][0],a[h-1][1]),e.lineTo(a[h][0],a[h][1]);e.lineWidth=4,e.stroke()}(s),s},e}(Bd);function $_(){return!1}function tv(t,e){return Math.abs(this._tileZoom-t.info.z)-Math.abs(this._tileZoom-e.info.z)}i_.registerRenderer("canvas",K_);var ev=new Gh(0,0),iv={properties:{}},nv=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.isDrawable=function(){return!0},i.needToRedraw=function(){var e=this.getMap();return!(!this._gl()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},i.onDrawTileStart=function(t,e){var i=this.gl;if(i.stencilOp(i.KEEP,i.KEEP,i.REPLACE),e&&e.renderTarget){var n=e.renderTarget.fbo;if(n){var r=e.renderTarget.getFramebuffer(n);i.bindFramebuffer(i.FRAMEBUFFER,r)}}},i.onDrawTileEnd=function(t,e){var i=this.gl;e&&e.renderTarget&&(e.renderTarget.fbo&&i.bindFramebuffer(i.FRAMEBUFFER,null))},i.drawTile=function(e,i,n){if(!n||!n.sceneFilter||n.sceneFilter(iv)){var r=this.getMap();if(e&&r&&i){var s=e._glScale=e._glScale||e.res/r.getGLRes(),o=e.extent2d.xmax-e.extent2d.xmin,a=e.extent2d.ymax-e.extent2d.ymin;if(!1!==e.cache&&this._bindGLBuffer(i,o,a),this._gl()){var h=e.extent2d,l=e.offset,c=ev.set(h.xmin-l[0],e.extent2d.ymax-l[1]),u=c.x*s,d=c.y*s,f=this.getTileOpacity(i),p=null;this.layer.options.debug&&(p=this.getDebugInfo(e.id));var g=this.gl;g.stencilFunc(g.LEQUAL,Math.abs(this.getCurrentTileZoom()-e.z),255),this.drawGLImage(i,u,d,o,a,s,f,p),f<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,i)}}},i._bindGLBuffer=function(t,e,i){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,i))},i.loadTileImage=function(t,e){var i=this.layer.options.crossOrigin;t.crossOrigin=null!==i?i:"",t.src=e},i.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},i.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},i.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},i.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},i.getCanvasImage=function(){if(!this._gl()||!this.canvas2)return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},i._gl=function(){if(this.canvas.gl&&this.canvas.gl.wrap)return!0;var t=this.getMap();return t&&(t.getPitch()||t.getBearing())||this.layer&&!!this.layer.options.fragmentShader},i.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image),delete e.image},i.onRemove=function(){t.prototype.onRemove.call(this),this.removeGLCanvas()},e}(x_(K_));function rv(t){var e=this.layer.getTileSize(),i=this.canvas.constructor,n=this.getMap(),r=n.getDevicePixelRatio(),s=Mu.createCanvas(e.width*r,e.height*r,i);s.layer=this.layer;var o=this,a=new Gh(t.extent2d.xmin,t.extent2d.ymax),h=new id(n.pointToCoordinate(a),n.pointToCoordinate(a.add(e.width,e.height)),n.getProjection());return this.layer.drawTile(s,{url:t.url,point:a,center:n.pointToCoordinate(a.add(e.width/2,e.height/2)),extent:h,z:t.z,x:t.x,y:t.y},(function(e){e?o.onTileError(s,t):o.onTileLoad(s,t)})),s}i_.registerRenderer("gl",nv);var sv=function(t){function e(){return t.apply(this,arguments)||this}return Nh(e,t),e.prototype.loadTile=function(){return rv.apply(this,arguments)},e}(K_),ov=function(t){function e(){return t.apply(this,arguments)||this}return Nh(e,t),e.prototype.loadTile=function(){return rv.apply(this,arguments)},e}(nv);c_.registerRenderer("canvas",sv),c_.registerRenderer("gl",ov);var av="undefined"!=typeof Int8Array?new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]):[],hv=function(){function t(t,e,i){this.gl=t,this.quadVertices=e||av,this.attributes=["a_position",3,lv(e)],this.debug=i}var e=t.prototype;return e.start=function(){var t=this.gl;t.enable(t.STENCIL_TEST),t.stencilMask(255),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.depthMask(!1),this._save(),this.buffer||(this._createBuffer(),this._createProgram()),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),f_(t,this.program,this.attributes),this.transformLoc||(this.transformLoc=t.getUniformLocation(this.program,"transform")),this.colorLoc||(this.colorLoc=t.getUniformLocation(this.program,"color")),this.debug||t.colorMask(!1,!1,!1,!1)},e.end=function(){var t=this.gl;t.depthMask(!0),this._restore(),this.debug||t.colorMask(!0,!0,!0,!0)},e.draw=function(t){var e=this.gl;e.uniformMatrix4fv(this.transformLoc,!1,t),e.uniform3fv(this.colorLoc,[Math.random(),Math.random(),Math.random()]),e.drawArrays(e.TRIANGLE_STRIP,0,4)},e.remove=function(){var t=this.gl;return this.buffer&&t.deleteBuffer(this.buffer),this.program&&(t.deleteShader(this.program.fragmentShader),t.deleteShader(this.program.vertexShader),t.deleteProgram(this.program)),delete this.transformLoc,delete this.gl,this},e.stencilMask=function(t){return this.gl.stencilMask(t),this},e.stencilFunc=function(t,e,i){return this.ref=e,this.gl.stencilFunc(t,e,i),this},e.stencilOp=function(t,e,i){return this.gl.stencilOp(t,e,i),this},e.resetFunc=function(){return this.ref=1,this.gl.stencilFunc(this.gl.ALWAYS,1,255),this},e._save=function(){var t=this.gl;this._savedProgram=t.program},e._restore=function(){var t=this.gl;t.program=this._savedProgram,t.program&&t.useProgram(t.program)},e._createBuffer=function(){var t=this.gl;if(this.buffer=t.createBuffer(),!this.buffer)throw new Error("Failed to create the buffer object");t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.quadVertices,t.STATIC_DRAW)},e._createProgram=function(){var t=d_(this.gl,"\n    attribute vec3 a_position;\n    uniform mat4 transform;\n\n    void main()\n    {\n        gl_Position = transform * vec4(a_position, 1.0);\n    }\n","\n    precision mediump float;\n    uniform vec3 color;\n    void main()\n    {\n        gl_FragColor = vec4(color, 1.0);\n    }\n"),e=t.program,i=t.vertexShader,n=t.fragmentShader;e.vertexShader=i,e.fragmentShader=n,this.program=e},t}();function lv(t){return t instanceof Float32Array?"FLOAT":t instanceof Int16Array?"SHORT":t instanceof Uint16Array?"UNSIGNED_SHORT":t instanceof Int8Array?"BYTE":t instanceof Uint8Array||t instanceof Uint8ClampedArray?"UNSIGNED_BYTE":"FLOAT"}var cv=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.checkResources=function(){var t=this._geosToCheck;if(this._resourceChecked||t||(t=this.layer._geoList),!rl(t))return[];for(var e=[],i={},n=t.length-1;n>=0;n--){var r=t[n]._getExternalResources();if(r.length)if(this.resources)for(var s=0;s<r.length;s++){var o=r[s][0];this.resources.isResourceLoaded(r[s])||i[o]||(e.push(r[s]),i[o]=1)}else e.push.apply(e,r)}return this._resourceChecked=!0,delete this._geosToCheck,e},i.render=function(){return this.layer._sortGeometries(),t.prototype.render.apply(this,arguments)},i._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),Jh(this._geosToCheck,t))},i.onGeometryAdd=function(t){this._addGeoToCheckRes(t),uv(this)},i.onGeometryRemove=function(){uv(this)},i.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),uv(this)},i.onGeometryShapeChange=function(){uv(this)},i.onGeometryPositionChange=function(){uv(this)},i.onGeometryZIndexChange=function(){uv(this)},i.onGeometryShow=function(){uv(this)},i.onGeometryHide=function(){uv(this)},i.onGeometryPropertiesChange=function(){uv(this)},e}(Bd);function uv(t){t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var dv=new nd,fv=[],pv=new nd,gv=function(t){function e(){return t.apply(this,arguments)||this}Nh(e,t);var i=e.prototype;return i.getImageData=function(){if(!this.layer.options.geometryEvents||!this._lastRenderTime||Va()-this._lastRenderTime<32)return null;if(!this.context||!this.context.canvas)return null;if(!this._imageData){var t=this.context.canvas,e=t.width,i=t.height;try{this._imageData=this.context.getImageData(0,0,e,i)}catch(n){}}return this._imageData},i.clearImageData=function(){this._imageData=null,delete this._imageData,this._lastRenderTime=Va()},i.checkResources=function(){var e=this,i=t.prototype.checkResources.apply(this,arguments),n=this.layer.getStyle();return n&&(Array.isArray(n)||(n=[n]),n.forEach((function(t){for(var n=ac(t.symbol,!0),r=0,s=n.length;r<s;r++)e.resources.isResourceLoaded(n[r])||i.push(n[r])}))),i},i.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===yg)&&t.prototype.needToRedraw.call(this)},i.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},i.isBlank=function(){return!!this.context&&!this.context.canvas._drawn},i.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var t=this.getMap(),e=this.layer.getCount(),i=this.mapStateCache.resolution;(t.isZooming()&&t.options.seamlessZoom&&void 0!==this._drawnRes&&i>1.5*this._drawnRes&&this._geosToDraw.length<e||t.isMoving()||t.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this.forEachGeo(this.checkGeo,this),this._drawnRes=i),this._sortByDistanceToCamera(t.cameraPosition);for(var n=0,r=this._geosToDraw.length;n<r;n++){var s=this._geosToDraw[n];s._isCheck||s.isVisible()?(s._paint(this._displayExtent),this._geosToDraw[n]._cPoint=void 0,this._geosToDraw[n]._inCurrentView=void 0):(delete s._cPoint,delete s._inCurrentView)}this.clearImageData()}},i.show=function(){this.layer.forEach((function(t){t._repaint()})),t.prototype.show.apply(this,arguments)},i.forEachGeo=function(t,e){this.layer.forEach(t,e)},i.drawGeos=function(){this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this.forEachGeo(this.checkGeo,this),this._sortByDistanceToCamera(this.getMap().cameraPosition);for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint(),this._geosToDraw[t]._cPoint=void 0,this._geosToDraw[t]._inCurrentView=void 0;this.clearImageData()},i.prepareToDraw=function(){this._hasPoint=!1,this._geosToDraw=[]},i.checkGeo=function(t){if("Point"!==t.type||void 0===this._onlyHasPoint){if(t._isCheck=!1,t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),i=!0;if(t._inCurrentView)i=!0;else if(!1===t._inCurrentView)i=!1;else{var n=e.get2DExtent(this.resources,dv);n&&n.intersects(this._displayExtent)||(i=!1)}i&&(e.hasPoint()&&(this._hasPoint=!0),t._isCheck=!0,this._geosToDraw.push(t))}}else t._inCurrentView&&(this._hasPoint=!0,t._isCheck=!0,this._geosToDraw.push(t))},i.onZoomEnd=function(){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,arguments)},i.onRemove=function(){this.forEachGeo((function(t){t.onHide()})),delete this._geosToDraw},i.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},i._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},i.identifyAtPoint=function(t,e){void 0===e&&(e={});var i=this._geosToDraw;return i?this.layer._hitGeos(i,t,e):[]},i._updateMapStateCache=function(){var t=this.getMap(),e=t._pointToContainerPoint(this.southWest)._add(0,-t.height),i=t.getResolution(),n=t.getPitch(),r=t.getBearing(),s=t.getGLScale(),o=t.getGLRes(),a=t.getContainerExtent(),h=t._get2DExtent(),l=t._get2DExtentAtRes(o);return this.mapStateCache={resolution:i,pitch:n,bearing:r,glScale:s,glRes:o,_2DExtent:h,glExtent:l,containerExtent:a,offset:e},this},i._batchConversionMarkers=function(t){if(this._onlyHasPoint=void 0,!this._constructorIsThis())return[];var e=[],i=[],n=[],r={},s=this.layer,o=s.options,a=s.getAltitude?s.getAltitude():0,h=s.isCanvasRender();this._onlyHasPoint=!0;for(var l=0,c=0,u=this.layer._geoList.length;c<u;c++){var d=this.layer._geoList[c];if("Point"===d.getType()){var f=d._painter;f||(f=d._getPainter());var p=f.getRenderPoints("center")[0][0],g=o.enableAltitude?d.getAltitude():a;void 0===r[g]&&(r[g]=f.getAltitude()),e[l]=p,n[l]=r[g],i[l]=d,l++}else this._onlyHasPoint=!1}if(0===l)return[];var m=this.getMap(),_=vl(e,"_pt");_=m._pointsAtResToContainerPoints(e,t,n,_);for(var v=m.getContainerExtent(),y=v.xmax,x=v.ymax,w=v.xmin,b=v.ymin,M={},S=0,C=i.length;S<C;S++){var T=i[S];if(T._cPoint=_[S],T._cPoint){var P=_[S],A=P.x,E=P.y;if(T._inCurrentView=A>=w&&E>=b&&A<=y&&E<=x,!T._inCurrentView){var L=T.getSymbolHash(),R=void 0;R=L?M[L]=M[L]||T._painter.getFixedExtent():T._painter.getFixedExtent(),pv.set(R.xmin,R.ymin,R.xmax,R.ymax),pv._add(_[S]),T._inCurrentView=pv.intersects(v)}T._inCurrentView&&(T.isVisible()&&h||(T._inCurrentView=!1),this._onlyHasPoint&&T._inCurrentView&&(this._hasPoint=!0,T._isCheck=!0,this._geosToDraw.push(T)))}else T._inCurrentView=!1}return _},i._sortByDistanceToCamera=function(t){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var e=this.getMap(),i=e.distanceToPoint(1e3,0,e.getGLScale()).x/1e3,n="center";this._geosToDraw.sort((function(e,r){var s=e.getType(),o=r.getType();if("Point"!==s||"Point"!==o)return 0;var a=e._painter,h=r._painter;if(!a||!h)return 0;var l=a.getRenderPoints(n)[0][0],c=h.getRenderPoints(n)[0][0],u=a.getAltitude()*i,d=h.getAltitude()*i;zg(fv,l.x,l.y,u);var f=Ug(fv,t);return zg(fv,c.x,c.y,d),Ug(fv,t)-f}))}},i._constructorIsThis=function(){return this.constructor===e},e}(cv);yg.registerRenderer("canvas",gv);var mv=function(t){function e(e){var i;return(i=t.call(this)||this).map=e,i._handlerQueue=[],i._thisDocVisibilitychange=i._onDocVisibilitychange.bind(Fh(Fh(i))),i._thisDocDragStart=i._onDocDragStart.bind(Fh(Fh(i))),i._thisDocDragEnd=i._onDocDragEnd.bind(Fh(Fh(i))),i}Nh(e,t);var i=e.prototype;return i.callInNextFrame=function(t){this._handlerQueue.push(t)},i.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,i=t.length;e<i;e++)t[e]()},i.offsetPlatform=function(t,e){if(!this.map._panels.front)return this;if(!e&&0===t.x&&0===t.y)return this;var i=this.map._panels,n=this._frontCount=i.back.layerDOM.childElementCount,r=this._backCount=i.front.layerDOM.childElementCount,s=this._uiCount=i.front.uiDOM.childElementCount;if(n||r||s){var o=this.map.offsetPlatform();o=t?o.add(t)._round():o.round(),r&&Kc(i.back,o),(n||s)&&Kc(i.front,o)}return this},i.domChanged=function(){var t=this.map._panels;if(!t.front)return!1;var e=t.back.layerDOM.childElementCount;if(void 0===this._frontCount||this._frontCount!==e)return!0;var i=t.front.layerDOM.childElementCount;if(void 0===this._backCount||this._backCount!==i)return!0;var n=t.front.uiDOM.childElementCount;return void 0===this._uiCount||this._uiCount!==n},i.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map._panels.front)){var t=new Gh(0,0);Kc(this.map._panels.back,t),Kc(this.map._panels.front,t)}},i.onZoomEnd=function(){this.resetContainer()},i.onLoad=function(){this._frameLoop()},i._onDocVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},i._getWrapPanel=function(){if(!this.map)return null;var t=this.map.getPanels();return t&&t.mapWrapper},i._onDocDragStart=function(){var t=this._getWrapPanel();t&&(t.style.overflow="visible")},i._onDocDragEnd=function(){var t=this._getWrapPanel();t&&(t.style.overflow="hidden")},i._containerIsOffscreen=function(){var t=this.map.getContainer();return!t||!t.style||"none"===t.style.display||Math.min(t.clientWidth,t.clientHeight)<=0},e}(Ou),_v=function(t){function e(e){var i;return(i=t.call(this,e)||this)._containerIsCanvas=!!e._containerDOM.getContext,i._registerEvents(),i._loopTime=0,i}Nh(e,t);var i=e.prototype;return i.load=function(){this.initContainer()},i.renderFrame=function(t){var e=this.map;if(!e||!e.options.renderable)return!1;if(e.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!0;this._updateDomPosition(t),delete this._isViewChanged,e._fireEvent("framestart"),this.updateMapDOM(),e.clearCollisionIndex();var i=this._getAllLayerToRender();return this.drawLayers(i,t),this.drawLayerCanvas(i)&&(this.drawTops(),this._drawCenterCross()),e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,!0},i.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t._getViewPointFrameOffset();e?t.offsetPlatform(e):this.domChanged()&&this.offsetPlatform(null,!0)}},i.drawLayers=function(t,e){for(var i=this.map,n=i.isInteracting(),r=[],s=[],o=i.options.fpsOnInteracting||0,a=0===o?0:1e3/o,h=this.map.options.layerCanvasLimitOnInteracting,l=t.length,c=i.getBaseLayer(),u=0,d=0;d<l;d++){var f=t[d];if(f.isVisible()){var p=f.isCanvasRender();p&&r.push(f.getId());var g=f._getRenderer();if(g){var m=this._checkLayerRedraw(f);p&&g.isCanvasUpdated()&&(m||s.push(f.getId()),this.setLayerCanvasUpdated());var _=g.__zoomTransformMatrix;if(delete g.__zoomTransformMatrix,m){if(n&&p){if(h>0&&l-1-d>h&&f!==c){f._getRenderer().clearCanvas();continue}u+=this._drawCanvasLayerOnInteracting(f,u,a,e)}else n&&g.drawOnInteracting?(g.prepareRender&&g.prepareRender(),g.checkAndDraw?g.checkAndDraw(g.drawOnInteracting,this._eventParam,e):g.drawOnInteracting(this._eventParam,e)):(g.render(e),p&&_&&g.isLoadingResource()&&(g.__zoomTransformMatrix=_));p&&(s.push(f.getId()),this.setLayerCanvasUpdated())}else p&&n&&(i.isZooming()&&!i.getPitch()?(g.prepareRender(),g.__zoomTransformMatrix=this._zoomMatrix):(i.getPitch()||i.isRotating())&&g.clearCanvas())}}}var v=this._canvasIds||[],y=this._updatedIds||[];if(this._canvasIds=r,this._updatedIds=s,!this.isLayerCanvasUpdated()){var x="---";v.join(x)===r.join(x)&&y.join(x)===s.join(x)||this.setLayerCanvasUpdated()}},i._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,i=t._getRenderer();return t.isCanvasRender()?i.testIfNeedRedraw():!(!i.needToRedraw||!i.needToRedraw())||(e.isInteracting()||this.isViewChanged())},i._drawCanvasLayerOnInteracting=function(t,e,i,n){var r=this.map,s=t._getRenderer(),o=s.getDrawTime(),a=0===i||i>0&&e+o<=i;if(s.mustRenderOnInteracting&&s.mustRenderOnInteracting())s.render(n);else{if(s.drawOnInteracting&&(t===r.getBaseLayer()||a||r.isZooming()&&t.options.forceRenderOnZooming||r.isMoving()&&t.options.forceRenderOnMoving||r.isRotating()&&t.options.forceRenderOnRotating))return s.prepareRender(),s.prepareCanvas(),s.checkAndDraw?s.checkAndDraw(s.drawOnInteracting,this._eventParam,n):s.drawOnInteracting(this._eventParam,n),o;!r.isZooming()||r.getPitch()||r.isRotating()?(r.getPitch()||r.isRotating())&&s.clearCanvas():(s.prepareRender(),s.__zoomTransformMatrix=this._zoomMatrix)}return s.drawOnInteracting&&!a&&s.onSkipDrawOnInteracting(this._eventParam,n),0},i._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach((function(e){var i=t.getLayer(e);if(i){var n=i._getRenderer();n&&n.isRenderComplete()&&i.fire("layerload")}}))}},i.isLayerCanvasUpdated=function(){return this._canvasUpdated},i.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},i.drawLayerCanvas=function(t){var e=this.map;if(!e)return!1;if(!this.isLayerCanvasUpdated()&&!this.isViewChanged())return!1;this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var i,n=e.isInteracting(),r=e.options.layerCanvasLimitOnInteracting,s=t.length,o=[],a=0;a<s;a++){if(t[a].isVisible()&&t[a].isCanvasRender())if(t[a]._getRenderer()){var h=this._getLayerImage(t[a]);h&&h.image&&(t[a]===e.getBaseLayer()?i=[t[a],h]:o.push([t[a],h]))}}var l=this.canvas.width,c=this.canvas.height;i&&(this._drawLayerCanvasImage(i[0],i[1],l,c),this._drawFog()),s=o.length;for(var u=n&&r>=0&&s>r?s-r:0;u<s;u++)this._drawLayerCanvasImage(o[u][0],o[u][1],l,c);return e._fireEvent("renderend",{context:this.context}),!0},i.setToRedraw=function(){for(var t=this._getAllLayerToRender(),e=0,i=t.length;e<i;e++){var n=t[e].getRenderer();n&&n.canvas&&n.setToRedraw&&n.setToRedraw()}},i.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.width+"px",i=t.height+"px",n=this.map._panels;n.mapWrapper.style.width=e,n.mapWrapper.style.height=i,this._updateCanvasSize()}},i.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map._containerDOM:this.map._panels?this.map._panels.mapWrapper:null:null},i.toDataURL=function(t,e){return this.canvas?this.canvas.toDataURL(t,e):null},i.remove=function(){zh.webgl&&"undefined"!=typeof document&&(qc(document,"visibilitychange",this._thisDocVisibilitychange),qc(document,"dragstart",this._thisDocDragStart),qc(document,"dragend",this._thisDocDragEnd)),this._resizeInterval&&clearInterval(this._resizeInterval),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},i.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){var i=e._getLayers(),n="default",r=e.options.hitDetectLimit||0,s=0;t&&t._round&&t._round();for(var o=i.length-1;o>=0;o--){var a=i[o];if(!(!a.options.hitDetect||a.isEmpty&&a.isEmpty())){var h=a._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==a.options.cursor&&h.hitDetect(t)){n=a.options.cursor||"pointer";break}if(s++,r>0&&s>r)break}}}e._trySetCursor(n)}},i._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},i.initContainer=function(){var t=this.map._panels;function e(e,i,n,r){var s=Hc("div",i);return n&&(s.style.cssText=n),t[e]=s,r||Qc(s),s}var i=this.map._containerDOM;if(!this._containerIsCanvas){i.innerHTML="";var n="position:absolute;top:0px;left:0px;",r=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),s=e("allLayers","maptalks-all-layers",n+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),o=e("backStatic","maptalks-back-static",n+"z-index:0;",!0),a=e("back","maptalks-back",n+"z-index:1;"),h=e("backLayer","maptalks-back-layer",n),l=e("canvasContainer","maptalks-canvas-layer",n+"border:none;z-index:2;"),c=e("frontStatic","maptalks-front-static",n+"z-index:3;",!0),u=e("front","maptalks-front",n+"z-index:4;",!0),d=e("frontLayer","maptalks-front-layer",n+"z-index:0;"),f=e("ui","maptalks-ui",n+"border:none;z-index:1;",!0),p=e("control","maptalks-control","z-index:1",!0);i.appendChild(r),s.appendChild(o),a.appendChild(h),a.layerDOM=h,s.appendChild(a),s.appendChild(l),u.appendChild(d),u.layerDOM=d,u.uiDOM=f,s.appendChild(c),s.appendChild(u),u.appendChild(f),r.appendChild(s),r.appendChild(p),this.createCanvas(),this.resetContainer();var g=this.map._getContainerDomSize();this.updateMapSize(g)}},i.isViewChanged=function(){if(void 0!==this._isViewChanged)return this._isViewChanged;var t=this._mapview,e=this._getMapView();return this._isViewChanged=!t||!gl(t,e),this._isViewChanged},i._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||gl(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},i.isSpatialReferenceChanged=function(){return this._spatialRefChanged},i._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},i._frameLoop=function(t){var e=this;this.map?(t=t||0,this._frameTimestamp=t,this._resizeCount=0,this.renderFrame(t),this._animationFrame=jh((function(t){e._frameLoop(t)}))):this._cancelFrameLoop()},i._cancelFrameLoop=function(){this._animationFrame&&Bh(this._animationFrame)},i._drawLayerCanvasImage=function(t,e,i,n){var r=this.context,s=e.point.round(),o=this.map.getDevicePixelRatio();1!==o&&s._multi(o);var a=e.image,h=a.width,l=a.height;if(!(s.x+h<=0||s.y+l<=0)){var c=t.options.opacity;if(qa(c)||(c=1),!(c<=0)){var u=e.opacity;if(qa(u)||(u=1),!(u<=0)){var d=r.globalAlpha;c<1&&(r.globalAlpha*=c),u<1&&(r.globalAlpha*=u),t.options.cssFilter&&(r.filter=t.options.cssFilter);var f=t.getRenderer(),p=f.__zoomTransformMatrix,g=f.clipCanvas(this.context);p&&(r.save(),r.setTransform.apply(r,p)),r.drawImage(a,0,0,h,l,s.x,s.y,i,n),p&&r.restore(),g&&r.restore(),"none"!==r.filter&&(r.filter="none"),r.globalAlpha=d}}}},i._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,i=new Gh(this.canvas.width/2,this.canvas.height/2);Qa(t)?t(e,i):Mu.drawCross(this.context,i.x,i.y,2,"#f00")}},i._drawContainerExtent=function(){var t=this.map.options.cascadePitches,e=this.map.height-this.map._getVisualHeight(t[0]),i=this.map.height-this.map._getVisualHeight(t[1]),n=this.map.getContainerExtent(),r=this.context;r.beginPath(),r.moveTo(0,n.ymin),r.lineTo(n.xmax,n.ymin),r.stroke(),r.beginPath(),r.moveTo(0,e),r.lineTo(n.xmax,e),r.stroke(),r.beginPath(),r.moveTo(0,i),r.lineTo(n.xmax,i),r.stroke()},i._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=t.getDevicePixelRatio(),i=this.context,n=t.getContainerExtent(),r=(t.height-t._getVisualHeight(75))*e;r<0&&(r=0);var s=n.ymin*e,o=Math.ceil(s-r),a=t.options.fogColor.join(),h=i.createLinearGradient(0,r,0,s+30),l=1-30/(o+30);h.addColorStop(0,"rgba("+a+", 0)"),h.addColorStop(.3,"rgba("+a+", 0.3)"),h.addColorStop(l,"rgba("+a+", 1)"),h.addColorStop(1,"rgba("+a+", 0)"),i.beginPath(),i.fillStyle=h,i.fillRect(0,r,Math.ceil(n.getWidth())*e,Math.ceil(o+30))}},i._getAllLayerToRender=function(){return this.map._getLayers()},i.clearCanvas=function(){this.canvas&&Mu.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},i._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map,e=t.getSize(),i=this.canvas,n=Sl(e,t.getDevicePixelRatio()),r=n.width,s=n.height,o=n.cssWidth,a=n.cssHeight;return!i.style||i.style.width===o&&i.style.height===a||(i.style.width=o,i.style.height=a),(r!==i.width||s!==i.height)&&(i.height=s,i.width=r,this.topLayer.width=i.width,this.topLayer.height=i.height,!0)},i.createCanvas=function(){this.topLayer=Hc("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map._containerDOM:(this.canvas=Hc("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},i._updateDomPosition=function(t){return void 0===this._checkPositionTime&&(this._checkPositionTime=-1/0),Math.abs(t-this._checkPositionTime)>=500&&($c(this.map._containerDOM),this._checkPositionTime=Math.min(t,this._checkPositionTime)),this},i._checkSize=function(){this.map&&this.map.checkSize()},i._setCheckSizeInterval=function(t){var e=this;zh.resizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver((function(t){!e.map||e.map.isRemoved()?e._resizeObserver.disconnect():t.length&&(e.map._containerDomContentRect=t[0].contentRect,e._checkSize(t[0].contentRect),e._resizeCount=e._resizeCount||0,e.renderFrame((e._frameTimestamp||0)+ ++e._resizeCount/100))})),this._resizeObserver.observe(this.map._containerDOM))):(clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval((function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()}),this._checkSizeInterval))},i._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!nh&&"undefined"!=typeof window&&this._setCheckSizeInterval(e.options.checkSizeInterval),zh.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",(function(e){t._eventParam=e})),e.on("_zooming",(function(i){e.getPitch()||(t._zoomMatrix=i.matrix.container),t._eventParam=i})),e.on("_zoomend",(function(e){t._eventParam=e,delete t._zoomMatrix})),e.on("_spatialreferencechange",(function(){t._spatialRefChanged=!0})),zh.webgl&&"undefined"!=typeof document&&(Zc(document,"visibilitychange",this._thisDocVisibilitychange,this),Zc(document,"dragstart",this._thisDocDragStart,this),Zc(document,"dragend",this._thisDocDragEnd,this)),zh.addDPRListening&&zh.addDPRListening(this.map)},i._onMapMouseMove=function(t){var e=this,i=this.map;!i.isInteracting()&&i.options.hitDetect&&(this._hitDetectFrame&&Bh(this._hitDetectFrame),this._hitDetectFrame=jh((function(){e.hitDetect(t.containerPoint)})))},i._getCanvasLayers=function(){return this.map._getLayers((function(t){return t.isCanvasRender()}))},i.addTopElement=function(t){this._tops||(this._tops=[]),this._tops.push(t)},i.removeTopElement=function(t){if(this._tops){var e=this._tops.indexOf(t);e>=0&&this._tops.splice(e,1)}},i.getTopElements=function(){return this._tops||[]},i.drawTops=function(){this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var t=this.getTopElements(),e=!1,i=0;i<t.length;i++)t[i].render(this.topCtx)&&(e=!0);e&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},e}(mv);yp.registerRenderer("canvas",_v),yp.mergeOptions({fog:!1,fogColor:[233,233,233]});var vv=Object.freeze({ResourceCache:Ud,CanvasRenderer:Bd,ImageGLRenderable:x_,MapRenderer:mv,MapCanvasRenderer:_v,Renderable:Md,ImageLayerCanvasRenderer:C_,ImageLayerGLRenderer:T_,TileLayerCanvasRenderer:K_,TileLayerGLRenderer:nv,CanvasTileLayerCanvasRenderer:sv,CanvasTileLayerGLRenderer:ov,QuadStencil:hv,OverlayLayerCanvasRenderer:cv,VectorLayerCanvasRenderer:gv,CanvasLayerRenderer:P_}),yv={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLRes())],null]}};jp.include(yv),$p.include(yv),Kp.include(yv),eg.include(yv),tg.include({_getRenderPoints:function(t){var e=this.getMap(),i=e.getGLRes();if("vertex"===t){for(var n=this._trimRing(this.getShell()),r=[],s=0,o=n.length;s<o;s++)r.push(e.coordToPointAtRes(n[s],i));return[r,null]}return[[e.coordToPointAtRes(this.getCenter(),i)],null]}});var xv={_getRenderPoints:function(t){var e,i=this.getMap(),n=i.getGLRes(),r=null;if("point"===t)(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,n))&&e.length>0&&Array.isArray(e[0])&&(e=e[0].concat(e[1]));else if("vertex"===t)if(r=[],(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,n))&&e.length>0&&Array.isArray(e[0])){for(var s=0,o=e.length;s<o;s++)for(var a=0,h=e[s].length;a<h;a++)0===a?r.push([e[s][a],e[s][a+1]]):r.push([e[s][a-1],e[s][a]]);e=e[0].concat(e[1])}else for(var l=0,c=e.length;l<c;l++)0===l?r.push([e[l],e[l+1]]):r.push([e[l-1],e[l]]);else if("line"===t){e=[],r=[];var u=this._getPath2DPoints(this._getPrjCoordinates(),!1,n);if(u.length>0&&Array.isArray(u[0]))for(var d,f=1,p=u.length;f<p;f++){d=u[f],this instanceof zp&&d.length>0&&!d[0].equals(d[d.length-1])&&d.push(d[0]);for(var g=1,m=d.length;g<m;g++)e.push(d[g].add(d[g-1])._multi(.5)),r.push([d[g-1],d[g]])}else{this instanceof zp&&u.length>0&&!u[0].equals(u[u.length-1])&&u.push(u[0]);for(var _=1,v=u.length;_<v;_++)e.push(u[_].add(u[_-1])._multi(.5)),r.push([u[_-1],u[_]])}}else if("vertex-first"===t){var y=this._getPrjCoordinates(),x=y.length,w=x?i._prjToPointAtRes(y[0],n):null;e=x?[w]:[],r=x?[[w,y[1]?i._prjToPointAtRes(y[1],n):w]]:[]}else if("vertex-last"===t){var b=this._getPrjCoordinates(),M=b.length,S=M?i._prjToPointAtRes(b[M-1],n):null;e=M?[S]:[];var C=M>1?M-2:M-1;r=M?[[b[C]?i._prjToPointAtRes(b[C],n):S,S]]:[]}else{var T=this.getCenter();if(T){var P=this._getProjection().project(T);e=[i._prjToPointAtRes(P,n)]}else e=[]}return[e,r]}};Up.include(xv),zp.include(xv);var wv={within:!1,center:[0,0]};function bv(t){if(t&&t._containerBbox){wv.within=!1;var e=t._containerBbox,i=e.minx,n=e.miny,r=e.maxx,s=e.maxy,o=Math.abs(r-i),a=Math.abs(s-n);o<=1&&a<=1&&(wv.within=!0,wv.center[0]=(i+r)/2,wv.center[1]=(n+s)/2),delete t._containerBbox}else wv.within=!1;return wv}op.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1}});var Mv={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof $p||this instanceof eg},_paintAsPath:function(){var t=this.getMap();return this.getAltitude()>0||t.getPitch()||this instanceof $p&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return zp.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),i=t._prjToPointAtRes(e,t.getGLRes()),n=this._getRenderSize(i);return[i].concat(n)},_paintOn:function(){return this._paintAsPath()?Mu.polygon.apply(Mu,arguments):Mu.ellipse.apply(Mu,arguments)},_getRenderSize:function(t){var e=this.getMap(),i=e.getGLRes(),n=this._getPrjExtent(),r=e._prjToPointAtRes(n.getMin(),i),s=e._prjToPointAtRes(n.getMax(),i);return[Math.abs(s.x-r.x)/2,Math.abs(s.y-t.y),Math.abs(t.y-r.y)]}};$p.include(Mv),Kp.include(Mv),tg.include({_getPaintParams:function(){var t=this.getMap(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t.getGLRes())]},_paintOn:Mu.polygon}),eg.include(Mv,{_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return zp.prototype._getPaintParams.call(this,!0);var t=this.getMap(),e=t._prjToPointAtRes(this._getPrjCoordinates(),t.getGLRes());return[e,this._getRenderSize(e)[0],[this.getStartAngle(),this.getEndAngle()]]},_paintOn:function(){if(this._paintAsPath())return Mu.polygon.apply(Mu,arguments);var t=this.getMap().getBearing(),e=arguments;return t&&(e[3]=e[3].slice(0),e[3][0]+=t,e[3][1]+=t),Mu.sector.apply(Mu,e)}}),Ip.include({_paintAsPath:function(){return!0}}),Up.include({arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,i,n,r){if(!t||!e||t.equals(e))return null;r||(r=0);var s,o=i*n[0],a=i*n[1]+r,h=o/2+r;(s=e.nextCtrlPoint||e.prevCtrlPoint?e.prevCtrlPoint?e.sub(new Gh(e.prevCtrlPoint)):e.sub(new Gh(e.nextCtrlPoint)):e.sub(t))._unit();var l=e.sub(s.multi(a));s._perp();var c=l.add(s.multi(h));return s._multi(-1),[c,e,l.add(s.multi(h)),c]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLRes())]},_paintOn:function(t,e,i,n,r){var s=bv(this._painter);s.within?Mu.pixelRect(t,s.center,i,n):this.options.smoothness?Mu.paintSmoothLine(t,e,i,this.options.smoothness,!1,this._animIdx,this._animTailRatio):Mu.path(t,e,i,null,r),this._paintArrow(t,e,i)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,i){var n=this._getArrowStyle();if(!n||t.length<2)return[];for(var r=t.length>0&&Array.isArray(t[0])?t:[t],s=this._getArrowPlacement(),o=[],a=this.getMap(),h=a.coordToContainerPoint(this.getFirstCoordinate()),l=a.coordToContainerPoint(this.getLastCoordinate()),c=r.length-1;c>=0;c--){if("vertex-first"===s||"vertex-firstlast"===s&&r[c][0].closeTo(h,.01)){var u=this._getArrowShape(r[c][1],r[c][0],e,n,i);u&&o.push(u)}if("vertex-last"===s||"vertex-firstlast"===s&&r[c][r[c].length-1].closeTo(l,.01)){var d=this._getArrowShape(r[c][r[c].length-2],r[c][r[c].length-1],e,n,i);d&&o.push(d)}else"point"===s&&this._getArrowPoints(o,r[c],e,n,i)}return o},_getArrowPoints:function(t,e,i,n,r){for(var s=0,o=e.length-1;s<o;s++){var a=this._getArrowShape(e[s],e[s+1],i,n,r);a&&t.push(a)}},_paintArrow:function(t,e,i){var n=this._getInternalSymbol().lineWidth;(!qa(n)||n<3)&&(n=3);var r=this._getArrows(e,n);if(r.length){t.setLineDash&&t.setLineDash([]);for(var s=r.length-1;s>=0;s--)t.fillStyle=t.strokeStyle,Mu.polygon(t,r[s],i,i)}}}),zp.include({_getPaintParams:function(t){var e=this.getMap().getGLRes(),i=this._getPrjShell(),n=this._getPath2DPoints(i,t,e),r=n.length>0&&Array.isArray(n[0]);r&&(n=[[n[0]],[n[1]]]);var s=this._getPrjHoles(),o=[];if(s&&s.length>0){for(var a=this._simplified,h=0;h<s.length;h++){var l=this._getPath2DPoints(s[h],t,e);Array.isArray(l)&&r?Array.isArray(l[0])?(n[0].push(l[0]),n[1].push(l[1])):n[0].push(l):o.push(l)}a&&(this._simplified=a)}return r||Jh(n=[n],o),[n]},_paintOn:function(t,e,i,n,r){var s=bv(this._painter);s.within?Mu.pixelRect(t,s.center,i,n):Mu.polygon(t,e,i,n,r,this.options.smoothness)}}),yp.VERSION="1.0.0-rc.17";var Sv={Actor:zd};
/**
			 * three api adapt
			 */const Cv=parseInt(i.replace("dev",""));//Three does not print version information now. Output the version of three to find compatibility problems
/**
			 *
			 * @param {THREE.BufferGeometry} bufferGeomertry
			 * @param {String} key
			 * @param {*} value
			 */
function Tv(t,e,i){return Cv>109?t.setAttribute(e,i):t.addAttribute(e,i),t}
/**
			 * @author WestLangley / http://github.com/WestLangley
			 *
			 */
class Pv extends ia{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),Tv(this,"position",new qe([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),Tv(this,"uv",new qe([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}// THREE.InstancedBufferGeometry.call(this);
// var plane = new THREE.BufferGeometry();
// this.addAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
// this.addAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));
applyMatrix(t){var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(i),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new na(e,6,1);// xyz, xyz
return Tv(this,"instanceStart",new ys(i,3,0)),Tv(this,"instanceEnd",new ys(i,3,3)),// this.addAttribute('instanceStart', new THREE.InterleavedBufferAttribute(instanceBuffer, 3, 0)); // xyz
// this.addAttribute('instanceEnd', new THREE.InterleavedBufferAttribute(instanceBuffer, 3, 3)); // xyz
this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new na(e,6,1);// rgb, rgb
// this.addAttribute('instanceColorStart', new THREE.InterleavedBufferAttribute(instanceColorBuffer, 3, 0)); // rgb
// this.addAttribute('instanceColorEnd', new THREE.InterleavedBufferAttribute(instanceColorBuffer, 3, 3)); // rgb
return Tv(this,"instanceColorStart",new ys(i,3,0)),Tv(this,"instanceColorEnd",new ys(i,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){// set colors, maybe
return this.fromWireframeGeometry(new Bo(t.geometry)),this}fromLineSegements(t){var e=t.geometry;// set colors, maybe
return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new Et;null===this.boundingBox&&(this.boundingBox=new Et);var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==e&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(i),this.boundingBox.union(t))}computeBoundingSphere(){var t=new Tt;null===this.boundingSphere&&(this.boundingSphere=new qt),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;if(void 0!==e&&void 0!==i){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var r=0,s=0,o=e.count;s<o;s++)t.fromBufferAttribute(e,s),r=Math.max(r,n.distanceToSquared(t)),t.fromBufferAttribute(i,s),r=Math.max(r,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)}}toJSON(){// todo
}// clone: function () {
//     // todo
// },
// eslint-disable-next-line no-unused-vars
copy(t){// todo
return this}}
/**
			 * @author WestLangley / http://github.com/WestLangley
			 *
			 * parameters = {
			 *  color: <hex>,
			 *  linewidth: <float>,
			 *  dashed: <boolean>,
			 *  dashScale: <float>,
			 *  dashSize: <float>,
			 *  gapSize: <float>,
			 *  resolution: <Vector2>, // to be set by renderer
			 * }
			 */const Av={},Ev={};Av.line={linewidth:{value:1},resolution:{value:new $(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},Ev.line={uniforms:wi.merge([Bi.common,Bi.fog,Av.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class Lv extends bi{constructor(t){super({uniforms:wi.clone(Ev.line.uniforms),vertexShader:Ev.line.vertexShader,fragmentShader:Ev.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}
/**
			 * @author WestLangley / http://github.com/WestLangley
			 *
			 */class Rv extends gi{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new Pv,this.material=void 0!==e?e:new Lv({color:16777215*Math.random()})}computeLineDistances(){var t=new Tt,e=new Tt,i=this.geometry,n=i.attributes.instanceStart,r=i.attributes.instanceEnd;if(!n||!r)return this;for(var s=new Float32Array(2*n.data.count),o=0,a=0,h=n.data.count;o<h;o++,a+=2)t.fromBufferAttribute(n,o),e.fromBufferAttribute(r,o),s[a]=0===a?0:s[a-1],s[a+1]=s[a]+t.distanceTo(e);var l=new na(s,2,1);// d0, d1
// geometry.addAttribute('instanceDistanceStart', new THREE.InterleavedBufferAttribute(instanceDistanceBuffer, 1, 0)); // d0
// geometry.addAttribute('instanceDistanceEnd', new THREE.InterleavedBufferAttribute(instanceDistanceBuffer, 1, 1)); // d1
return Tv(i,"instanceDistanceStart",new ys(l,1,0)),Tv(i,"instanceDistanceEnd",new ys(l,1,1)),this}}
/**
			 * @author WestLangley / http://github.com/WestLangley
			 *
			 */class Ov extends Pv{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}
/**
			 * @author WestLangley / http://github.com/WestLangley
			 *
			 */class Dv extends Rv{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new Ov,this.material=void 0!==e?e:new Lv({color:16777215*Math.random()})}copy(t){return this}}const Iv={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1,bloom:!1};
/**
			 * a Class for Eventable
			 */function kv(){}// class Base {
//     constructor() {
//     }
// }
/**
			 * EVENTS=[
			 *  'add',
			 *  'remove',
			    'mousemove',
			    'click',
			    'mousedown',
			    'mouseup',
			    'dblclick',
			    'contextmenu',
			    'touchstart',
			    'touchmove',
			    'touchend',
			    'mouseover',
			    'mouseout',
			    'idchange',
			    'propertieschange',
			    'show',
			    'hide',
			    'symbolchange'
			     empty
			];
			 * This is the base class for all 3D objects
			 *
			 *
			 * Its function and maptalks.geometry are as similar as possible
			 *
			 * maptalks.Eventable(Base) return a Class  https://github.com/maptalks/maptalks.js/blob/master/src/core/Eventable.js
			 *
			 */class zv extends(Eu(kv)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=Nc.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type&&t.addMesh([this]),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}// eslint-disable-next-line consistent-return
getMap(){const t=this.getLayer();if(t)return t.getMap()}// eslint-disable-next-line consistent-return
getCenter(){const t=this.getOptions(),{coordinate:e,lineString:i,polygon:n}=t;if(e)return e instanceof Gu?e:new Gu(e);{const t=n||i;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}
/**
			     * Different objects need to implement their own methods
			     * @param {*} altitude
			     */setAltitude(t){if(Nc.isNumber(t)){const e=this.getLayer().altitudeToVector3(t,t).x;//fix merged mesh
if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,i=this._baseObjects.length;t<i;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}supportHeight(){return this.getOptions().heightEnable}getHeight(){const{height:t}=this.getOptions();return Nc.isNumber(t)?t:0}setHeight(t){if(!Nc.isNumber(t)||this._baseObjects||!this.supportHeight())return this;const e=this.getLayer();if(!e)return this;const{geometry:i}=this.getObject3d();if(i instanceof ei){const{position:n}=i.attributes||{};if(!n)return this;const r=n.array;let s=1/0,o=-1/0;for(let t=0,e=r.length;t<e;t+=3){const e=r[t+2];s=Math.min(e,s),o=Math.max(e,o)}const a=(s+o)/2;let h=e.altitudeToVector3(t,t).x;// z>0
h=Math.max(h,1e-6);for(let t=0,e=r.length;t<e;t+=3)r[t+2]>a&&(r[t+2]=h);i.attributes.position.needsUpdate=!0,i.computeBoundingBox(),i.computeBoundingSphere(),this.getOptions().height=t}return this}show(){//  in zoom range
return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this._hideUI(),this}isVisible(){return!!this.getObject3d().visible}
/**
			     *  Different objects need to implement their own methods
			     */getSymbol(){return this.getObject3d().material}
/**
			     *  Different objects need to implement their own methods
			     * @param {*} material
			     */setSymbol(t){if(t&&t instanceof Be){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new Pm.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof Gu||(t=new Gu(t)),// eslint-disable-next-line no-unused-expressions
t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){// eslint-disable-next-line no-unused-expressions
return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){// eslint-disable-next-line no-unused-expressions
return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new Pm.ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return(t=t||this.getCenter())instanceof Gu||(t=new Gu(t)),// eslint-disable-next-line no-unused-expressions
t&&this.toolTip&&this.toolTip.show(t),this}closeToolTip(){// eslint-disable-next-line no-unused-expressions
return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){// eslint-disable-next-line no-unused-expressions
return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}_hideUI(){return this.closeInfoWindow(),this.closeToolTip(),this}
/**
			     * different components should implement their own animation methods
			     * @param {*} options
			     * @param {*} cb
			     */
// eslint-disable-next-line no-unused-vars
animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),Nc.isFunction(t)&&(e=t={});const i=t.duration||1e3,n=t.easing||"out",r=this._showPlayer=Dp.Animation.animate({scale:1},{duration:i,easing:n},(t=>{const i=t.styles.scale;i>0&&(this.getObject3d().scale.z=i),e&&e(t,i)}));return r.play(),r}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}get bloom(){return this.getOptions().bloom}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}
/**
			     * more method support
			     * @param {*} options
			     */
/**
			     *
			     * @param {*} options
			     */_initOptions(t){return this.options=Nc.extend({},Iv,t),this}_createMesh(t,e){return this.object3d=new gi(t,e),this.object3d.__parent=this,this}_createInstancedMesh(t,e,i){return this.object3d=new Ts(t,e,i),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new hs,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new Ds(t,e),// (this.object3d as THREE.Line).computeLineDistances();
this._computeLineDistances(t),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new Dv(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}// eslint-disable-next-line no-unused-vars
_createPoints(t,e){//Serving for particles
return this.object3d=new Gs(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new zs(t,e),// (this.object3d as THREE.LineSegments).computeLineDistances();
this._computeLineDistances(t),this.object3d.__parent=this,this}
/**
			     * rewrite three.js computeLineDistances ,1.7 speed
			     * @param geometry
			     */_computeLineDistances(t){const e=t.attributes.position.array,i=t.attributes.position.count,n=new Float32Array(i);n[0]=0;const r=new Tt(0,0,0),s=new Tt(0,0,0);for(let o=1;o<i;o++){const t=3*(o-1);r.x=e[t],r.y=e[t+1],r.z=e[t+2];const i=3*o;s.x=e[i],s.y=e[i+1],s.z=e[i+2];const a=s.distanceTo(r);n[o]=n[o-1]+a}Tv(t,"lineDistance",new Ve(n,1))}}/* eslint-disable indent */const Nv=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function Fv(t){return t.geometry?t.geometry.type:null}function jv(t){const e=Fv(t);if(e)for(let i=0,n=Nv.length;i<n;i++)if(Nv[i]===e)return!0;return!1}function Bv(t){const e=Fv(t);return!(!e||e!==Nv[4]&&e!==Nv[5])}function Uv(t){const e=Fv(t);return!(!e||e!==Nv[2]&&e!==Nv[3])}function Gv(t){const e=Fv(t);return!(!e||e!==Nv[0]&&e!==Nv[1])}function Hv(t){const e=Fv(t);return!!(e&&e.indexOf("Multi")>-1)}function Vv(t){return t.geometry?t.geometry.coordinates:[]}function Wv(t,e){const i=Fv(t);if(!i||!t.geometry)return null;const n=t.geometry.coordinates;if(!n)return null;// const coords: Array<Array<number>> = [];
let r=0,s=0,o=0;switch(i){case"Point":r=n[0],s=n[1],// coords.push(coordinates as Array<number>);
o++;break;case"MultiPoint":case"LineString":for(let t=0,e=n.length;t<e;t++)r+=n[t][0],s+=n[t][1],o++;break;case"MultiLineString":case"Polygon":for(let t=0,e=n.length;t<e;t++)for(let i=0,a=n[t].length;i<a;i++)// coords.push((coordinates[i] as Array<Array<number>>)[j]);
r+=n[t][i][0],s+=n[t][i][1],o++;break;case"MultiPolygon":for(let t=0,e=n.length;t<e;t++)for(let i=0,a=n[t].length;i<a;i++)for(let e=0,h=n[t][i].length;e<h;e++)// coords.push(((coordinates[i] as Array<Array<Array<number>>>)[j])[m]);
r+=n[t][i][e][0],s+=n[t][i][e][1],o++}const a=r/o,h=s/o;return e?(e.x=a,e.y=h,e):new Gu(a,h)}function Zv(t){const e=Fv(t);if(!e||!t.geometry)return null;const i=t.geometry,n=t.properties||{},r=i.coordinates;if(!r)return null;const s=[];let o;switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(let a=0,h=r.length;a<h;a++)s.push({type:"Feature",geometry:{type:o,coordinates:r[a]},properties:n});else s.push(t);return s}
/*!
			 * poly-extrude v0.2.0
			  */var qv={exports:{}};function Xv(t,e,i){i=i||2;var n,r,s,o,a,h,l,c=e&&e.length,u=c?e[0]*i:t.length,d=Jv(t,0,u,i,!0),f=[];if(!d||d.next===d.prev)return f;// if the shape is not too simple, we'll use z-order curve hash later; calculate polygon bbox
if(c&&(d=// link every hole into the outer loop, producing a single-ring polygon without holes
function(t,e,i,n){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=Jv(t,e[r]*n,r<s-1?e[r+1]*n:t.length,n,!1))===o.next&&(o.steiner=!0),a.push(oy(o));// process holes from left to right
for(a.sort(iy),r=0;r<a.length;r++)i=ny(a[r],i);return i}(t,e,d,i)),t.length>80*i){n=s=t[0],r=o=t[1];for(var p=i;p<u;p+=i)(a=t[p])<n&&(n=a),(h=t[p+1])<r&&(r=h),a>s&&(s=a),h>o&&(o=h);// minX, minY and invSize are later used to transform coords into integers for z-order calculation
l=0!==(l=Math.max(s-n,o-r))?32767/l:0}return Qv(d,f,i,n,r,l,0),f}// create a circular doubly linked list from polygon points in the specified winding order
function Jv(t,e,i,n,r){var s,o;if(r===yy(t,e,i,n)>0)for(s=e;s<i;s+=n)o=my(s,t[s],t[s+1],o);else for(s=i-n;s>=e;s-=n)o=my(s,t[s],t[s+1],o);return o&&cy(o,o.next)&&(_y(o),o=o.next),o}// eliminate colinear or duplicate points
function Yv(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!cy(n,n.next)&&0!==ly(n.prev,n,n.next))n=n.next;else{if(_y(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}// main ear slicing loop which triangulates a polygon (given as a linked list)
function Qv(t,e,i,n,r,s,o){if(t){// interlink polygon nodes in z-order
!o&&s&&// interlink polygon nodes in z-order
function(t,e,i,n){var r=t;do{0===r.z&&(r.z=sy(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,// Simon Tatham's linked list merge sort algorithm
// http://www.chiark.greenend.org.uk/~sgtatham/algorithms/listsort.html
function(t){var e,i,n,r,s,o,a,h,l=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,n=i,a=0,e=0;e<l&&(a++,n=n.nextZ);e++);for(h=l;a>0||h>0&&n;)0!==a&&(0===h||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,h--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=n}s.nextZ=null,l*=2}while(o>1)}// z-order of a point given coords and inverse of the longer side of data bbox
(r)}(t,n,r,s);// iterate through ears, slicing them one by one
for(var a,h,l=t;t.prev!==t.next;)if(a=t.prev,h=t.next,s?$v(t,n,r,s):Kv(t))// cut off the triangle
e.push(a.i/i|0),e.push(t.i/i|0),e.push(h.i/i|0),_y(t),// skipping the next vertex leads to less sliver triangles
t=h.next,l=h.next;else// if we looped through the whole remaining polygon and can't find any more ears
if((t=h)===l){// try filtering points and slicing again
o?1===o?Qv(t=ty(Yv(t),e,i),e,i,n,r,s,2):2===o&&ey(t,e,i,n,r,s):Qv(Yv(t),e,i,n,r,s,1);break}}}// check whether a polygon node forms a valid ear with adjacent nodes
function Kv(t){var e=t.prev,i=t,n=t.next;if(ly(e,i,n)>=0)return!1;// reflex, can't be an ear
// now make sure we don't have other points inside the potential ear
for(var r=e.x,s=i.x,o=n.x,a=e.y,h=i.y,l=n.y,c=r<s?r<o?r:o:s<o?s:o,u=a<h?a<l?a:l:h<l?h:l,d=r>s?r>o?r:o:s>o?s:o,f=a>h?a>l?a:l:h>l?h:l,p=n.next// triangle bbox; min & max are calculated like this for speed
;p!==e;){if(p.x>=c&&p.x<=d&&p.y>=u&&p.y<=f&&ay(r,a,s,h,o,l,p.x,p.y)&&ly(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function $v(t,e,i,n){var r=t.prev,s=t,o=t.next;if(ly(r,s,o)>=0)return!1;// reflex, can't be an ear
// look for points inside the triangle in both directions
for(var a=r.x,h=s.x,l=o.x,c=r.y,u=s.y,d=o.y,f=a<h?a<l?a:l:h<l?h:l,p=c<u?c<d?c:d:u<d?u:d,g=a>h?a>l?a:l:h>l?h:l,m=c>u?c>d?c:d:u>d?u:d,_=sy(f,p,e,i,n),v=sy(g,m,e,i,n),y=t.prevZ,x=t.nextZ// triangle bbox; min & max are calculated like this for speed
;y&&y.z>=_&&x&&x.z<=v;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&ay(a,c,h,u,l,d,y.x,y.y)&&ly(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==r&&x!==o&&ay(a,c,h,u,l,d,x.x,x.y)&&ly(x.prev,x,x.next)>=0)return!1;x=x.nextZ}// look for remaining points in decreasing z-order
for(;y&&y.z>=_;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&ay(a,c,h,u,l,d,y.x,y.y)&&ly(y.prev,y,y.next)>=0)return!1;y=y.prevZ}// look for remaining points in increasing z-order
for(;x&&x.z<=v;){if(x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==r&&x!==o&&ay(a,c,h,u,l,d,x.x,x.y)&&ly(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}// go through all polygon nodes and cure small local self-intersections
function ty(t,e,i){var n=t;do{var r=n.prev,s=n.next.next;!cy(r,s)&&uy(r,n,n.next,s)&&py(r,s)&&py(s,r)&&(e.push(r.i/i|0),e.push(n.i/i|0),e.push(s.i/i|0),// remove two nodes involved
_y(n),_y(n.next),n=t=s),n=n.next}while(n!==t);return Yv(n)}// try splitting polygon into two and triangulate them independently
function ey(t,e,i,n,r,s){// look for a valid diagonal that divides the polygon into two
var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&hy(o,a)){// split the polygon in two by the diagonal
var h=gy(o,a);// filter colinear points around the cuts
return o=Yv(o,o.next),h=Yv(h,h.next),// run earcut on each half
Qv(o,e,i,n,r,s,0),void Qv(h,e,i,n,r,s,0)}a=a.next}o=o.next}while(o!==t)}function iy(t,e){return t.x-e.x}// find a bridge between vertices that connects hole with an outer ring and and link it
function ny(t,e){var i=// David Eberly's algorithm for finding a bridge between hole and outer polygon
function(t,e){var i,n=e,r=t.x,s=t.y,o=-1/0;// find a segment intersected by a ray from the hole's leftmost point to the left;
// segment's endpoint with lesser x will be potential connection point
do{if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){var a=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=r&&a>o&&(o=a,i=n.x<n.next.x?n:n.next,a===r))return i;// hole touches outer segment; pick leftmost endpoint
}n=n.next}while(n!==e);if(!i)return null;// look for points inside the triangle of hole point, segment intersection and endpoint;
// if there are no points found, we have a valid connection;
// otherwise choose the point of the minimum angle with the ray as connection point
var h,l=i,c=i.x,u=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=c&&r!==n.x&&ay(s<u?r:o,s,c,u,s<u?o:r,s,n.x,n.y)&&(h=Math.abs(s-n.y)/(r-n.x),// tangential
py(n,t)&&(h<d||h===d&&(n.x>i.x||n.x===i.x&&ry(i,n)))&&(i=n,d=h)),n=n.next}while(n!==l);return i}// whether sector in vertex m contains sector in vertex p in the same coordinates
(t,e);if(!i)return e;var n=gy(i,t);// filter collinear points around the cuts
return Yv(n,n.next),Yv(i,i.next)}function ry(t,e){return ly(t.prev,t,e.prev)<0&&ly(e.next,t,t.next)<0}function sy(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((// coords are transformed into non-negative 15-bit integer range
t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}// find the leftmost node of a polygon ring
function oy(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}// check if a point lies within a convex triangle
function ay(t,e,i,n,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(n-a)>=(i-o)*(e-a)&&(i-o)*(s-a)>=(r-o)*(n-a)}// check if a diagonal between two polygon nodes is valid (lies in polygon interior)
function hy(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!// check if a polygon diagonal intersects any polygon segments
function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&uy(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}// check if a polygon diagonal is locally inside the polygon
(t,e)&&(// dones't intersect other edges
py(t,e)&&py(e,t)&&// check if the middle point of a polygon diagonal is inside the polygon
function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}// link two polygon vertices with a bridge; if the vertices belong to the same ring, it splits polygon into two;
// if one belongs to the outer ring and another to a hole, it merges it into a single ring
(t,e)&&(// locally visible
ly(t.prev,t,e.prev)||ly(t,e.prev,e))||// does not create opposite-facing sectors
cy(t,e)&&ly(t.prev,t,t.next)>0&&ly(e.prev,e,e.next)>0);// special zero-length case
}// signed area of a triangle
function ly(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}// check if two points are equal
function cy(t,e){return t.x===e.x&&t.y===e.y}// check if two segments intersect
function uy(t,e,i,n){var r=fy(ly(t,e,i)),s=fy(ly(t,e,n)),o=fy(ly(i,n,t)),a=fy(ly(i,n,e));return r!==s&&o!==a||(// general case
!(0!==r||!dy(t,i,e))||(// p1, q1 and p2 are collinear and p2 lies on p1q1
!(0!==s||!dy(t,n,e))||(// p1, q1 and q2 are collinear and q2 lies on p1q1
!(0!==o||!dy(i,t,n))||!(0!==a||!dy(i,e,n)))))}// for collinear points p, q, r, check if point q lies on segment pr
function dy(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function fy(t){return t>0?1:t<0?-1:0}function py(t,e){return ly(t.prev,t,t.next)<0?ly(t,e,t.next)>=0&&ly(t,t.prev,e)>=0:ly(t,e,t.prev)<0||ly(t,t.next,e)<0}function gy(t,e){var i=new vy(t.i,t.x,t.y),n=new vy(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}// create a node and optionally link it with previous one (in a circular doubly linked list)
function my(t,e,i,n){var r=new vy(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function _y(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function vy(t,e,i){// vertex index in coordinates array
this.i=t,// vertex coordinates
this.x=e,this.y=i,// previous and next vertex nodes in a polygon ring
this.prev=null,this.next=null,// z-order curve value
this.z=0,// previous and next nodes in z-order
this.prevZ=null,this.nextZ=null,// indicates whether this is a steiner point
this.steiner=!1}// return a percentage difference between the polygon area and its triangulation area;
// used to verify correctness of triangulation
function yy(t,e,i,n){for(var r=0,s=e,o=i-n;s<i;s+=n)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}// turn a polygon in a multi-dimensional array form (e.g. as in GeoJSON) into a form Earcut accepts
qv.exports=Xv,qv.exports.default=Xv,Xv.deviation=function(t,e,i,n){var r=e&&e.length,s=r?e[0]*i:t.length,o=Math.abs(yy(t,0,s,i));if(r)for(var a=0,h=e.length;a<h;a++){var l=e[a]*i,c=a<h-1?e[a+1]*i:t.length;o-=Math.abs(yy(t,l,c,i))}var u=0;for(a=0;a<n.length;a+=3){var d=n[a]*i,f=n[a+1]*i,p=n[a+2]*i;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},Xv.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)i.vertices.push(t[r][s][o]);r>0&&(n+=t[r-1].length,i.holes.push(n))}return i};var xy=qv.exports;
/**
			 * https://github.com/Turfjs/turf/blob/master/packages/turf-boolean-clockwise/index.ts
			 * @param {*} ring
			 * @returns
			 */function wy(t){for(var e,i,n=0,r=1,s=t.length;r<s;)e=i||t[0],n+=((i=t[r])[0]-e[0])*(i[1]+e[1]),r++;return n>0}function by(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function My(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[0],a=i[1],h=i[2];return t[0]=r*h-s*a,t[1]=s*o-n*h,t[2]=n*a-r*o,t}function Sy(t,e){function i(t,e,i,n){t[0]=e,t[1]=i,t[2]=n}for(var n=[],r=[],s=[],o=[],a=[],h=[],l=t.length,c=new Float32Array(e.length),u=0;u<l;){// const i1 = indices[f++] * 3;
// const i2 = indices[f++] * 3;
// const i3 = indices[f++] * 3;
// const i1 = indices[f];
// const i2 = indices[f + 1];
// const i3 = indices[f + 2];
var d=3*t[u],f=3*t[u+1],p=3*t[u+2];i(n,e[d],e[d+1],e[d+2]),i(r,e[f],e[f+1],e[f+2]),i(s,e[p],e[p+1],e[p+2]),by(a,s,r),by(o,n,r),My(h,a,o);// Already be weighted by the triangle area
for(var g=0;g<3;g++)c[d+g]+=h[g],c[f+g]+=h[g],c[p+g]+=h[g];u+=3}for(var m,_,v,y,x,w,b=0,M=c.length;b<M;)i(h,c[b],c[b+1],c[b+2]),m=h,v=void 0,y=void 0,x=void 0,w=void 0,v=(_=h)[0],y=_[1],x=_[2],w=Math.sqrt(v*v+y*y+x*x)||1,m[0]=v/w,m[1]=y/w,m[2]=x/w,c[b]=h[0]||0,c[b+1]=h[1]||0,c[b+2]=h[2]||0,b+=3;return c}function Cy(t){if(1===t.length)return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t};for(var e=0,i=0,n=0,r=t.length;n<r;n++){var s=t[n],o=s.position,a=s.indices;e+=o.length,i+=a.length}for(var h={position:new Float32Array(e),normal:new Float32Array(e),uv:new Float32Array(e/3*2),indices:new Uint32Array(i),results:t},l=0,c=0,u=0,d=0,f=0,p=t.length;f<p;f++){var g=t[f],m=g.position,_=g.indices,v=g.normal,y=g.uv;h.position.set(m,l),h.normal.set(v,l),h.uv.set(y,d);for(var x=0,w=_.length;x<w;){var b=_[x]+c;h.indices[u]=b,u++,x++}d+=y.length,l+=m.length,c+=m.length/3}return h}function Ty(t){return 180*t/Math.PI}function Py(t){return t/180*Math.PI}// https://github.com/mrdoob/three.js/blob/16f13e3b07e31d0e9a00df7c3366bbe0e464588c/src/geometries/ExtrudeGeometry.js?_pjax=%23js-repo-pjax-container#L736
function Ay(t,e,i,n,r,s){var o=3*i,a=3*n,h=3*r,l=3*s,c=e[o],u=e[o+1],d=e[o+2],f=e[a],p=e[a+1],g=e[a+2],m=e[h],_=e[h+1],v=e[h+2],y=e[l],x=e[l+1],w=e[l+2];Math.abs(u-p)<Math.abs(c-f)?(t.push(c,1-d),t.push(f,1-g),t.push(m,1-v),t.push(y,1-w)):(t.push(u,1-d),t.push(p,1-g),t.push(_,1-v),t.push(x,1-w))}function Ey(t,e){e=Object.assign({},{depth:2},e);var i=t.map((function(t){for(var i=0,n=t.length;i<n;i++){var r=t[i];Ly(r),0===i?wy(r)||(t[i]=r.reverse()):wy(r)&&(t[i]=r.reverse()),Ry(r)&&r.splice(r.length-1,1)}var s=function(t,e){for(var i=function(t){var e=0,i=0,n=t.length;for(;i<n;)e+=t[i].length,i++;return e}(t),n=t.length,r=[],s=new Float32Array(2*i),o=[],a=[],h=3*i,l=2*i,c=e.depth,u=0,d=0,f=0,p=0;p<n;p++){var g=t[p];p>0&&r.push(u/2);for(var m=0,_=g.length;m<_;){var v=g[m],y=v[0],x=v[1];s[u++]=y,s[u++]=x,// top vertices
o[d]=y,o[d+1]=x,o[d+2]=c,// bottom vertices
o[h+d]=y,o[h+d+1]=x,o[h+d+2]=0,a[f]=y,a[f+1]=x,a[l+f]=y,a[l+f+1]=x,d+=3,f+=2,m++}}return{flatVertices:s,holes:r,points:o,count:i,uvs:a}}(t,e);return s.polygon=t,function(t,e){for(var i=[],n=t.count,r=0,s=e.length;r<s;r+=3){// top
var o=e[r],a=e[r+1],h=e[r+2];i[r]=o,i[r+1]=a,i[r+2]=h;// bottom
var l=s+r,c=n+o,u=n+a,d=n+h;i[l]=c,i[l+1]=u,i[l+2]=d}t.index=i}(s,xy(s.flatVertices,s.holes,2)),function(t,e){for(var i=t.points,n=t.index,r=t.polygon,s=t.uvs,o=e.depth,a=0,h=r.length;a<h;a++)for(var l=r[a],c=0,u=l.length;c<u;){var d=l[c],f=l[c+1];c===u-1&&(f=l[0]);var p=i.length/3,g=d[0],m=d[1],_=f[0],v=f[1];i.push(g,m,o,_,v,o,g,m,0,_,v,0);var y=p+2,x=p+3,w=p,b=p+1;// points.push(p3, p4, p1, p2);
n.push(y,w,x,w,b,x),// index.push(c, d, b);
Ay(s,i,y,x,w,b),c++}}(s,e),s.position=new Float32Array(s.points),s.indices=new Uint32Array(s.index),s.uv=new Float32Array(s.uvs),s.normal=Sy(s.indices,s.position),s})),n=Cy(i);return n.polygons=t,n}function Ly(t){Ry(t)||t.push(t[0])}function Ry(t){var e=t.length,i=t[0],n=i[0],r=i[1],s=t[e-1],o=s[0],a=s[1];return n===o&&r===a}function Oy(t,e){e=Object.assign({},{depth:2,lineWidth:1},e);var i=t.map((function(t){var i=function(t,e){var i=0,n=e.lineWidth/2,r=[],s=[],o=[],a=t.length,h=0;for(;h<a-1;){var l=t[h],c=t[h+1],u=c[1]-l[1],d=c[0]-l[0],f=0,p=Ty(Math.atan(u/d));if(i=p,0===h)f=p,f-=90;else{var g=t[h-1];Dy.x=g[0]-l[0],Dy.y=g[1]-l[1],Iy.x=c[0]-l[0],Iy.y=c[1]-l[1],f=p-zy(Dy,Iy)/2}var m=ky(Py(f),n,l),_=m[0],v=m[1];r.push(_,v),Ny(_,l,c)?(s.push(_),o.push(v)):(s.push(v),o.push(_)),h++}var y=i,x=Py(y-=90),w=t[a-2],b=t[a-1],M=ky(x,n,b),S=M[0],C=M[1];r.push(S,C),Ny(S,w,b)?(s.push(S),o.push(C)):(s.push(C),o.push(S));return{offsetPoints:r,leftPoints:s,rightPoints:o}}(t,e);return i.line=t,function(t,e){var i=e.depth,n=[],r=[],s=[],o=t.leftPoints,a=t.rightPoints,h=0,l=o.length;for(;h<l;){// top left
var c=3*h,u=o[h],d=u[0],f=u[1],p=u[2];n[c]=d,n[c+1]=f,n[c+2]=i+p;// top right
var g=a[h],m=g[0],_=g[1],v=g[2],y=3*l+c;n[y]=m,n[y+1]=_,n[y+2]=i+v;// bottom left
var x=2*l*3+c;n[x]=d,n[x+1]=f,n[x+2]=p;// bottom right
var w=2*l*3+3*l+c;n[w]=m,n[w+1]=_,n[w+2]=v,h++}h=0,l=n.length;for(;h<l;){var b=n[h],M=n[h+1];s.push(b,M),h+=3}h=0,l=o.length;for(;h<l-1;){// top
// left1 left2 right1,right2
var S=h,C=h+1,T=S+l,P=C+l;r.push(S,T,C),r.push(T,P,C);// bottom
// left1 left2 right1,right2
var A=h+2*l,E=A+1,L=A+l,R=E+l;r.push(A,L,E),r.push(L,R,E),h++}t.index=r,t.points=n,t.uvs=s}(i,e),function(t,e){var i=t.points,n=t.index,r=t.leftPoints,s=t.rightPoints,o=t.uvs,a=e.depth,h=[r,s];function l(t,e){var r=i.length/3;i.push(t[0],t[1],a+t[2],e[0],e[1],a+e[2],t[0],t[1],t[2],e[0],e[1],e[2]);var s=r+2,h=r+3,l=r,c=r+1;n.push(s,l,h,l,c,h),Ay(o,i,s,h,l,c)}for(var c=0,u=h.length;c<u;c++){var d=h[c];c>0&&(d=d.map((function(t){return t})),d=d.reverse());for(var f=0,p=d.length-1;f<p;){l(d[f],d[f+1]),f++}}for(var g=r.length,m=[s[0],r[0],r[g-1],s[g-1]],_=0;_<m.length;_+=2){l(m[_],m[_+1])}}(i,e),i.position=new Float32Array(i.points),i.indices=new Uint32Array(i.index),i.uv=new Float32Array(i.uvs),i.normal=Sy(i.indices,i.position),i})),n=Cy(i);return n.lines=t,n}var Dy={x:0,y:0},Iy={x:0,y:0};function ky(t,e,i){var n=i[0],r=i[1],s=i[2]||0,o=[n+Math.cos(t)*e,r+Math.sin(t)*e,s],a=t+=Math.PI;return[o,[n+Math.cos(a)*e,r+Math.sin(a)*e,s]]}var zy=function(t,e){var i=t.x,n=t.y,r=e.x,s=e.y,o=i*r+n*s,a=i*s-n*r;return(Math.atan2(a,o)/Math.PI*180+360)%360};function Ny(t,e,i){var n=e[0],r=e[1],s=i[0],o=i[1];return(r-o)*t[0]+(s-n)*t[1]+n*o-s*r>0}//Using cache to reduce computation
function Fy(t,e,i={}){return void 0===i[t]&&(i[t]=e.distanceToVector3(t,t).x),i[t]}function jy(t,e,i={}){return void 0===i[t]&&(i[t]=e.altitudeToVector3(t,t).x),i[t]}
/**
			 *Get the center point of the point set
			 * @param {*} coordinates
			 */function By(t=[]){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const{coordinate:n,lnglat:s,lnglats:o,xy:a,xys:h}=t[r],l=n||s||o||a||h||t[r];let c,u;Array.isArray(l)?(c=l[0],u=l[1]):l instanceof Gu&&(c=l.x,u=l.y),e+=c,i+=u}return new Gu(e/n,i/n)}function Uy(t,e,i,n){if(void 0===e||"number"!=typeof e||0===e)return 0;let r;r=t instanceof ei?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position;let s=0;if(r){n?(void 0===n[e]&&(n[e]=i.altitudeToVector3(e,e).x),s=n[e]):s=i.altitudeToVector3(e,e).x;const t=r.length;if(r[0]instanceof Tt)for(let e=0;e<t;e++)r[e].z+=s;else for(let e=0;e<t;e+=3)r[e+2]+=s}return s}function Gy(t){const e=t.length;let i=0;for(let n=0;n<e;n++){const{count:e}=t[n].position;i+=e}return new Float32Array(3*i)}function Hy(t=[]){const e=t.length,i=new Float64Array(2*e);for(let n=0;n<e;n++){let e,r;const s=t[n];s.x?(e=s.x,r=s.y):(e=s[0],r=s[1]),i[2*n]=e,i[2*n+1]=r}return i.buffer}const Vy=new pt("#fff"),Wy=new pt("#fff");
/**
			 * this is for ExtrudeMesh util
			 */
/**
			 * Fix the bug in the center of multipoygon
			 * @param {maptalks.Polygon} polygon
			 * @param {*} layer
			 */
// export function toShape(datas = []) {
//     const shapes = [];
//     for (let i = 0, len = datas.length; i < len; i++) {
//         const { outer, holes } = datas[i];
//         const shape = [outer];
//         if (holes && holes.length) {
//             for (let j = 0, len1 = holes.length; j < len1; j++) {
//                 shape.push(holes[j]);
//             }
//         }
//         shapes.push(shape);
//     }
//     return shapes;
// }
/**
			 *  Support custom center point
			 * @param {maptalks.Polygon|maptalks.MultiPolygon} polygon
			 * @param {*} height
			 * @param {*} layer
			 */function Zy(t,e,i,n,r,s){const o=Xy(t,i,n,r,!1);//Possible later use of geojson
if(!o)return null;//Reduce height and repeat calculation
s?(null==s[e]&&(s[e]=i.altitudeToVector3(e,e).x),e=s[e]):e=i.altitudeToVector3(e,e).x;const{position:a,normal:h,uv:l,indices:c}=Ey(o,{depth:e});return{position:a,normal:h,uv:l,indices:c}}
/**
			 *
			 * @param {*} geometry
			 * @param {*} color
			 * @param {*} _topColor
			 */function qy(t,e,i,n){void 0===n&&(n=0);const r=t.attributes.position.array,s=r.length;let o;if(Wy.setStyle(e),Vy.setStyle(i),Array.isArray(n)){let t=0;for(let e=0,i=n.length;e<i;e++){const{count:i}=n[e].position;t+=3*i}o=new Float32Array(t)}else o=new Float32Array(r.length);if(Array.isArray(n))for(let a=0,h=n.length;a<h;a++){const{middleZ:t,start:e,end:i}=n[a].position;for(let n=e;n<i;n+=3){r[n+2]>t?(o[n]=Vy.r,o[n+1]=Vy.g,o[n+2]=Vy.b):(o[n]=Wy.r,o[n+1]=Wy.g,o[n+2]=Wy.b)}}else for(let a=0;a<s;a+=3){r[a+2]>n?(o[a]=Vy.r,o[a+1]=Vy.g,o[a+2]=Vy.b):(o[a]=Wy.r,o[a+1]=Wy.g,o[a+2]=Wy.b)}return Tv(t,"color",new Ve(o,3,!0)),o}
/**
			 *
			 * @param {*} polygon
			 * @param {*} layer
			 * @param {*} center
			 */function Xy(t,e,i,n,r=!1){if(!t)return null;let s=[];if(t instanceof Jp)s=t.getGeometries().map((s=>Jy(s,e,i||t.getCenter(),n,r)));else if(t instanceof zp){const o=Jy(t,e,i||t.getCenter(),n,r);s.push(o)}else if(Bv(t))// const cent = getGeoJSONCenter(polygon);
if(Hv(t)){const o=Zv(t);for(let a=0,h=o.length;a<h;a++)s.push(Jy(o[a],e,i||Wv(t),n,r))}else{const o=Jy(t,e,i||Wv(t),n,r);s.push(o)}return s}function Jy(t,e,i,n,r=!1){let s,o,a;//it is pre for geojson,Possible later use of geojson
if(Bv(t)){const e=Vv(t);s=e[0],o=e.slice(1,e.length),i=i||Wv(t)}else t instanceof zp&&(s=t.getShell(),o=t.getHoles(),i=i||t.getCenter());n=n||e.coordinateToVector3(i),a=r?e.coordinatiesToGLFloatArray(s,n).positons2d:e.coordinatiesToGLArray(s,n);const h=[r?a.buffer:a];if(o&&o.length>0)for(let l=0,c=o.length;l<c;l++){let t;t=r?e.coordinatiesToGLFloatArray(o[l],n).positons2d:e.coordinatiesToGLArray(o[l],n),h.push(r?t.buffer:t)}return h}function Yy(t){if(!t)return null;let e=[];if(t instanceof Jp)e=t.getGeometries().map((t=>Qy(t,!1)));else if(t instanceof zp){const i=Qy(t,!1);e.push(i)}else if(Bv(t))// const cent = getGeoJSONCenter(polygon);
if(Hv(t)){const i=Zv(t);for(let t=0,n=i.length;t<n;t++)e.push(Qy(i[t],!0))}else{const i=Qy(t,!0);e.push(i)}return e}function Qy(t,e){let i,n;//it is pre for geojson,Possible later use of geojson
if(e){const e=Vv(t);i=e[0],n=e.slice(1,e.length)}else t instanceof zp&&(i=t.getShell(),n=t.getHoles());const r=[Hy(i)];if(n&&n.length>0)for(let s=0,o=n.length;s<o;s++){const t=Hy(n[s]);r.push(t)}return r}
/**
			 *
			 * @param {maptalks.LineString} lineString
			 * @param {ThreeLayer} layer
			 */
function Ky(t,e,i,n=!0){let r,s,o=[];if(Array.isArray(t)&&t[0]instanceof Tt)o=t;else{Array.isArray(t)&&(t=new Up(t));const a=0;//support geojson
let h,l;jv(t)?(h=Vv(t),i||(l=Wv(t))):t instanceof Up&&(h=t.getCoordinates(),i||(l=t.getCenter()));const c=e.coordinateToVector3(i||l);if(n)for(let t=0,i=h.length;t<i;t++){const i=h[t],n=e.coordinateToVector3(i,a).sub(c);// positions.push(v.x, v.y, v.z);
o.push(n)}else{const t=e.coordinatiesToGLFloatArray(h,c);r=t.positions,s=t.positons2d}}if(!n)return{positions:r,positionsV:o,positions2d:s,arrayBuffer:s.buffer};s=new Float32Array(2*o.length),r=new Float32Array(3*o.length);for(let a=0,h=o.length;a<h;a++){const t=3*a,e=o[a];r[t]=e.x,r[t+1]=e.y,r[t+2]=e.z;const i=2*a;s[i]=e.x,s[i+1]=e.y}return{positions:r,positionsV:o,positions2d:s,arrayBuffer:s.buffer}}
/**
			 *
			 * @param {Array[Array]} chunkLines
			 * @param {*} layer
			 */function $y(t,e,i,n){const r=[],s=[],o=[];let a,h;for(let l=0,c=t.length;l<c;l++){const i=t[l];for(let t=0,l=i.length;t<l;t++){const l=i[t],c=l.join(",").toString();a?(c!==a&&(h=e.coordinateToVector3(l,0).sub(n),r.push(h.x,h.y,h.z),s.push(h),o.push(l)),a=c):(o.push(l),a=c,h=e.coordinateToVector3(l,0).sub(n),r.push(h.x,h.y,h.z),s.push(h))}}return{positions:r,positionsV:s,lnglats:o}}function tx(t){let e;const i=[];for(let n=0,r=t.length;n<r;n++){const r=t[n];for(let t=0,n=r.length;t<n;t++){const n=r[t],s=n.join(",").toString();e?(s!==e&&i.push(n),e=s):(i.push(n),e=s)}}return i}
/**
			 *
			 * @param {*} lineString
			 * @param {*} lineWidth
			 * @param {*} depth
			 * @param {*} layer
			 */function ex(t,e=1,i=1,n,r){const s=Ky(t,n,r).positionsV,o=[];for(let u=0,d=s.length;u<d;u++){const t=s[u];o.push([t.x,t.y])}const{indices:a,position:h,normal:l,uv:c}=Oy([o],{lineWidth:e,depth:i});return{position:h,normal:l,indices:a,uv:c}}function ix(t){let e,i=[];return t instanceof Xp?(i=t.getGeometries(),e=t.getCenter()):t instanceof Up?(i.push(t),e=t.getCenter()):jv(t)&&(e=Wv(t),Hv(t)?i=Zv(t):i.push(t)),{lineStrings:i,center:e}}function nx(t){const e=new Float32Array(2*t.length-6);let i=0;for(let n=0,r=t.length/3;n<r;n++){const s=t[3*n],o=t[3*n+1],a=t[3*n+2];if(n>0&&n<r-1){const t=3*i;e[t]=s,e[t+1]=o,e[t+2]=a,i++}const h=3*i;e[h]=s,e[h+1]=o,e[h+2]=a,i++}return e}function rx(t){let e=0;const i=t.length;if(1===i)return t[0];for(let s=0;s<i;s++)e+=t[s].length;const n=new Float32Array(e);let r=0;for(let s=0;s<i;s++)n.set(t[s],r),r+=t[s].length;return n}function sx(t){return t instanceof Up?Hy(t.getCoordinates()):Uv(t)?Hy(t.geometry.coordinates):void 0}let ox;function ax(){return ox||(ox=new ei,Tv(ox,"position",new Ve(new Float32Array(3),3))),ox}// eslint-disable-next-line quotes
let hx;var lx;function cx(){return!lx&&hx&&(lx=new hx("__maptalks.three__")),lx}
/**
			 *
			 * @param distance
			 * @param layer
			 * @param altCache
			 * @returns
			 */function ux(t,e,i={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===i[t]&&(i[t]=e.distanceToVector3(t,t).x),i[t]):0}function dx(t,e,i={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===i[t]&&(i[t]=e.altitudeToVector3(t,t).x),i[t]):0}
/**
			 * generate extrudepolygons data for worker
			 * @param {*} polygons
			 * @param {*} layer
			 */
/**
			 * generate ExtrudeLines data for worker
			 * @param {*} lineStringList
			 * @param {*} center
			 * @param {*} layer
			 */
function fx(t,e,i,n,r=[]){const s=i.isMercator();let o,a,h;if(s){const t=i.getMap();o=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(h=i.coordinateToVector3(e));const l=[],c=[],u={},d={},f=t.length;for(let p=0;p<f;p++){const o=t[p],a=r[p]?r[p]:Uv(n[p])?n[p].properties:n[p].getProperties()||{};e||(h=i.coordinateToVector3(a.center));let f=a.width||1,g=a.height||1,m=a.bottomHeight||0;f=ux(f,i,u),g=dx(g,i,d),m=dx(m,i,d);const _=[];for(let t=0,n=o.length;t<n;t++){const n=o[t];let r;r=s?sx(n):Ky(n,i,e,!1).arrayBuffer,c.push(r),_.push(r)}const v={id:a.id,data:_,height:g,width:f,bottomHeight:m};s&&(v.center=[h.x,h.y]),l.push(v)}return{datas:l,transfer:c,glRes:o,matrix:a,center:s?[h.x,h.y]:null}}
/**
			 * generate Lines data for worker
			 * @param lineStringList
			 * @param center
			 * @param layer
			 * @param lineStrings
			 * @param options
			 * @returns
			 */function px(t,e,i,n,r=[]){const s=i.isMercator();let o,a,h;if(s){const t=i.getMap();o=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(h=i.coordinateToVector3(e));const l=[],c=[],u={},d=t.length;for(let f=0;f<d;f++){const o=t[f],a=r[f]?r[f]:Uv(n[f])?n[f].properties:n[f].getProperties()||{};e||(h=i.coordinateToVector3(a.center));let d=a.bottomHeight||0;d=dx(d,i,u);const p=[];for(let t=0,n=o.length;t<n;t++){const n=o[t];if(s){const t=sx(n);p.push(t),p.push(t)}else{const t=Ky(n,i,e,!1).arrayBuffer;c.push(t),p.push(t)}}const g={id:a.id,data:p,bottomHeight:d};s&&(g.center=[h.x,h.y]),l.push(g)}return{datas:l,transfer:c,glRes:o,matrix:a,center:s?[h.x,h.y]:null}}function gx(t){return t.map((t=>t.data))}function mx(t){return t.map((t=>t.option||t.baseObject.getOptions()))}Sv&&(hx=class extends Sv.Actor{test(t,e){//send data to worker thread
this.send(t,null,e)}pushQueue(t={}){const{type:e,data:i,callback:n,layer:r,key:s,center:o,lineStrings:a,options:h,id:l}=t;let c;e.indexOf("ExtrudePolygon")>-1?c=function(t=[],e,i,n=[]){const r=i.isMercator();let s,o,a;if(r){const t=i.getMap();s=t.getGLRes(),o=t.getSpatialReference().getTransformation().matrix}e&&(a=i.coordinateToVector3(e));const h=t.length,l=[],c=[],u={};for(let d=0;d<h;d++){const s=t[d],o=s,h=n[d]?n[d]:Bv(o)?o.properties:o.getProperties()||{};let f;e||(a=i.coordinateToVector3(h.center)),f=r?Yy(s):Xy(s,i,h.center||e,a,!0);for(let t=0,e=f.length;t<e;t++){const e=f[t];for(let t=0,i=e.length;t<i;t++)//ring
c.push(e[t])}let p=h.height||1,g=h.bottomHeight||0;p=dx(p,i,u),g=dx(g,i,u);const m={id:h.id,data:f,height:p,bottomHeight:g};r&&(m.center=[a.x,a.y]),l.push(m),//delete Internal properties
o._properties&&delete o._properties}return{datas:l,transfer:c,glRes:s,matrix:o,center:r?[a.x,a.y]:null}}(i,o,r,h):"ExtrudeLines"===e?c=fx(i,o,r,a):"Point"===e||("Line"===e||"FatLine"===e?c=px(i,o,r,a,h):"Lines"===e||"FatLines"===e?c=px(i,o,r,a):"ExtrudeLine"===e?c=fx(i,o,r,a,h):"Bar"!==e&&"Bars"!==e||(c=function(t){const e=t.length,i=new Float32Array(7*e);let n=0;for(let s=0;s<e;s++){let{center:e,radialSegments:r,radius:o,height:a,altitude:h,id:l}=t[s];e=e||[0,0],i[n]=e[0],i[n+1]=e[1],i[n+2]=r||6,i[n+3]=o||1,i[n+4]=a,i[n+5]=h||0,i[n+6]=l,n+=7}const r=i.buffer;return{datas:r,transfer:[r]}}(i))),c&&this.send({type:e,datas:c.datas,glRes:c.glRes,matrix:c.matrix,center:c.center},c.transfer,(function(t,e){e.key=s,e.id=l,n(e)}))}});class _x{constructor(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}getActor(){return cx()}getCurrentTime(){return Nc.now()}loop(){this.deQueue()}push(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this}reset(){return this.time=this.getCurrentTime(),this.tempQueue=[],this}pushResult(t){if(t)return Array.isArray(t)||(t=[t]),t.forEach((t=>{this.resultQueue.push(t)})),this}deQueue(){if(!this.resultQueue.length)return this;const t=this.deQueueCount;return(this.resultQueue.slice(0,t)||[]).forEach((t=>{const{id:e}=t;if(this.queueMap[e]){const{baseObject:i}=this.queueMap[e];i&&i._workerLoad&&i._workerLoad(t),delete this.queueMap[e]}})),this.resultQueue.splice(0,t),this}}const vx=new class extends _x{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){cx().pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:gx(this.tempQueue),options:mx(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},yx=new class extends _x{loop(){if(this.tempQueue.length){const t=cx();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudePolygons",layer:e.layer,data:e.data,key:e.key,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},xx=new class extends _x{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){cx().pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:gx(this.tempQueue),options:mx(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},wx=new class extends _x{loop(){if(this.tempQueue.length){const t=cx();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudeLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},bx=new class extends _x{constructor(){super(),this.deQueueCount=200}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){cx().pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:gx(this.tempQueue),options:mx(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Mx=new class extends _x{loop(){if(this.tempQueue.length){const t=cx();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Lines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Sx=new class extends _x{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){cx().pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:gx(this.tempQueue),options:mx(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Cx=new class extends _x{loop(){if(this.tempQueue.length){const t=cx();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"FatLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Tx=new class extends _x{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){cx().pushQueue({type:"Bar",layer:this.tempQueue[0].layer,data:gx(this.tempQueue),options:mx(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Px=new class extends _x{constructor(){super(),this.deQueueCount=1}loop(){if(this.tempQueue.length){const t=cx();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Bars",layer:e.layer,data:e.data,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Ax={isRunning:!1,tasks:[],addTask:t=>{t&&Ax.tasks.push(t)},removeTask:t=>{Ax.tasks.splice(Ax.tasks.indexOf(t),1)},loop(){vx.loop(),yx.loop(),xx.loop(),wx.loop(),bx.loop(),Mx.loop(),Sx.loop(),Cx.loop(),Tx.loop(),Px.loop(),Ax.tasks.forEach((t=>{t&&t.loop&&t.loop()})),Nc.requestAnimFrame(Ax.loop)},star(){Ax.isRunning||(Ax.isRunning=!0,Ax.loop())}};function Ex(t){const{position:e,normal:i,uv:n,indices:r}=Lx(t),s=new ei,o=new Float32Array(e.length);return o.fill(1,0,e.length),Tv(s,"color",new Ve(o,3)),Tv(s,"normal",new Ve(i,3)),Tv(s,"position",new Ve(e,3)),n&&n.length&&Tv(s,"uv",new Ve(n,2)),s.setIndex(new Ve(r,1)),s}function Lx(t){const e={},i={};for(let o=0;o<t.length;++o){const n=t[o];for(const t in n)void 0===e[t]&&(e[t]=[],i[t]=0),e[t].push(n[t]),i[t]+=n[t].length}// merge attributes
const n={};let r=0;const s=new Uint32Array(i.indices);for(const o in e)if("indices"===o){const t=e[o];let i=0;for(let n=0,o=t.length;n<o;n++){const o=t[n];for(let t=0,e=o.length;t<e;t++)s[i]=o[t]+r,i++;r+=e.position[n].length/3}}else{const t=Rx(e[o],i[o]);if(!t)return null;n[o]=t}return n.indices=s,n}function Rx(t,e){const i=new Float32Array(e);let n=0;for(let r=0;r<t.length;++r)i.set(t[r],n),n+=t[r].length;return i}function Ox(t){//arraybuffer data
const{position:e,normal:i,uv:n,indices:r}=t,s=new ei;// const color = new Float32Array(position.length);
// color.fill(1, 0, position.length);
// addAttribute(bufferGeomertry, 'color', new THREE.BufferAttribute(color, 3));
return Tv(s,"normal",new Ve(new Float32Array(i),3)),Tv(s,"position",new Ve(new Float32Array(e),3)),Tv(s,"uv",new Ve(new Float32Array(n),2)),s.setIndex(new Ve(new Uint32Array(r),1)),s}function Dx(t){const e=new ei;return Tv(e,"normal",t.getAttribute("normal")),Tv(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let Ix;function kx(){if(!Ix){const t=1e-6;Ix=new aa(t,t,t)}return Ix}kx();// type Cache = {
//     [key: number]: THREE.BufferGeometry
// }
// const barGeometryCache: Cache = {};
const zx=new aa(1,1,1);zx.translate(0,0,.5);const Nx=new pt("#fff"),Fx=new pt("#fff");// function getDefaultCylinderBufferGeometry(radialSegments: number = 6): THREE.BufferGeometry {
//     if (!barGeometryCache[radialSegments]) {
//         const geometry = new THREE.CylinderBufferGeometry(1, 1, 1, radialSegments, 1);
//         geometry.rotateX(Math.PI / 2);
//         geometry.translate(0, 0, 0.5);
//         geometry.rotateZ(Math.PI / 6);
//         barGeometryCache[radialSegments] = geometry;
//     }
//     return barGeometryCache[radialSegments];
// }
function jx(t){const{position:e,normal:i,uv:n,indices:r}=function(t,e){void 0===e&&(e={}),e=Object.assign({},{radius:1,height:2,radialSegments:6},e);for(var i=Math.round(Math.max(4,e.radialSegments)),n=e,r=n.radius,s=n.height,o=360/i/360*Math.PI*2,a=i+1,h=new Float32Array(3*a*2),l=t[0],c=t[1],u=0,d=0,f=3*a,p=2*a,g=[],m=[],_=-1;_<i;_++){var v,y,x=o*_,w=Math.cos(x)*r+l,b=Math.sin(x)*r+c;// bottom vertices
h[u]=w,h[u+1]=b,h[u+2]=0,// top vertices
h[u+f]=w,h[u+1+f]=b,h[u+2+f]=s,v=.5+w/r/2,y=.5+b/r/2,m[d]=v,m[d+1]=y,m[d+p]=v,m[d+1+p]=y,u+=3,d+=2,_>1&&// bottom indices
g.push(0,_-1,_)}h[u-=3]=h[0],h[u+1]=h[1],h[u+2]=h[2];var M=h.length;h[M-3]=h[0],h[M-2]=h[1],h[M-1]=s;// top indices
for(var S=g.length,C=0;C<S;C++){var T=g[C];g.push(T+a)}var P=new Float32Array(2*(3*a*2-6)),A=-1;u=2*a,d=0;for(var E=0,L=h.length/2;E<L-3;E+=3){var R=h[E],O=h[E+1],D=h[E+3],I=h[E+4];P[++A]=R,P[++A]=O,P[++A]=s,P[++A]=D,P[++A]=I,P[++A]=s,P[++A]=R,P[++A]=O,P[++A]=0,P[++A]=D,P[++A]=I,P[++A]=0;var k=u+2,z=u+3,N=u,F=u+1;// indices.push(a, c, b, c, d, b);
g.push(N,k,F,k,z,F),u+=4;var j=d/a,B=(d+1)/a;m.push(j,s/r/2,B,s/r/2,j,0,B,0),d++}var U=new Float32Array(h.length+P.length);U.set(h,0),U.set(P,h.length);var G=Sy(g,U);return{points:h,indices:new Uint32Array(g),position:U,normal:G,uv:new Float32Array(m)}}(t.center||[0,0],t),s=new ei;return Tv(s,"normal",new Ve(i,3)),Tv(s,"position",new Ve(e,3)),Tv(s,"uv",new Ve(n,2)),s.setIndex(new Ve(r,1)),s}
/**
			 * Reuse Geometry   , Meter as unit
			 * @param {*} property
			 */
// eslint-disable-next-line no-unused-vars
function Bx(t){// const {
//     height,
//     radialSegments,
//     radius
// } = property;
// const geometry = getDefaultCylinderBufferGeometry(radialSegments).clone();
// geometry.scale(radius, radius, height);
// return geometry;
const e=Object.assign({},t);return e._radius&&(e.radius=e._radius),jx(e)}
/**
			 * init Colors
			 * @param {*} geometry
			 * @param {*} color
			 * @param {*} _topColor
			 */function Ux(t,e,i,n="y",r=0){let s=0;"y"===n?s=1:"z"===n&&(s=2);const o=t.attributes.position.array,a=o.length;Fx.setStyle(e),Nx.setStyle(i);const h=new Float32Array(a);if(Array.isArray(r))for(let l=0,c=r.length;l<c;l++){const{middleZ:t,start:e,end:i}=r[l].position;for(let n=e;n<i;n+=3){o[n+2]>t?(h[n]=Nx.r,h[n+1]=Nx.g,h[n+2]=Nx.b):(h[n]=Fx.r,h[n+1]=Fx.g,h[n+2]=Fx.b)}}else for(let l=0;l<a;l+=3){o[l+s]>r?(h[l]=Nx.r,h[l+1]=Nx.g,h[l+2]=Nx.b):(h[l]=Fx.r,h[l+1]=Fx.g,h[l+2]=Fx.b)}return Tv(t,"color",new Ve(h,3,!0)),h}function Gx(t){const e=[],i=t.length;let n=0;for(let a=0;a<i;a++){const{color:e}=t[a].attributes;e&&(n+=e.array.length)}const r=new Float32Array(n);let s=0;for(let a=0,h=t.length;a<h;a++){const{color:i,normal:n,position:o,uv:h}=t[a].attributes,l=t[a].index;i&&(r.set(i.array,s),s+=i.array.length),e.push({// color: color.array,
normal:n.array,uv:h.array,position:o.array,indices:l.array})}const o=Ex(e);r.length&&Tv(o,"color",new Ve(r,3,!0));for(let a=0,h=t.length;a<h;a++)t[a].dispose();return o}function Hx(){return zx}const Vx={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};
/**
			 *
			 */class Wx extends zv{constructor(t,e,i,n){e=Nc.extend({},Vx,e,{layer:n,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:s,topColor:o,bottomColor:a,altitude:h,asynchronous:l}=e;let c;if(e.height=n.altitudeToVector3(r,r).x,e.radius=n.distanceToVector3(s,s).x,l){c=kx();const t=Nc.GUID();this.getOptions().id=t,Tx.push({data:{radius:e.radius,height:e.height,radialSegments:e.radialSegments,id:t},layer:n,id:t,baseObject:this})}else c=Bx(e),o&&(Ux(c,a,o,"z",e.height/2),i.vertexColors=!0);this._createMesh(c,i);const u=n.altitudeToVector3(h,h).x,d=n.coordinateToVector3(t,u);this.getObject3d().position.copy(d),this.type="Bar"}_workerLoad(t){const e=Ox(t),{topColor:i,bottomColor:n,height:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(i){Ux(e,n,i,"z",this.getLayer().altitudeToVector3(r,r).x/2),o.vertexColors=!0}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}function Zx(t){const e=[];return t&&t.length&&t.forEach((t=>{t=t instanceof pt?t:new pt(t),e.push(t.r,t.g,t.b)})),e}const qx={altitude:0,bottomHeight:0,colors:null};
/**
			 *
			 */class Xx extends zv{constructor(t,e,i,n){e=Nc.extend({},qx,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{lineStrings:r,center:s}=ix(t),{asynchronous:o}=e;let a;if(o){a=ax();const i=Nc.GUID();this.getOptions().id=i,this.getOptions().center=s,bx.push({id:i,data:r,layer:n,key:e.key,lineString:t,baseObject:this})}else{const t=[];for(let e=0,i=r.length;e<i;e++){const i=r[e],{positions:o}=Ky(i,n,s,!1);t.push(nx(o))}const o=rx(t);a=new ei,Tv(a,"position",new Ve(o,3)),Uy(a,e.bottomHeight,n);const h=Zx(e.colors);h&&h.length&&(Tv(a,"color",new qe(h,3)),i.vertexColors=!0)}this._createLineSegments(a,i);const{altitude:h}=e,l=n.altitudeToVector3(h,h).x,c=n.coordinateToVector3(s,l);this.getObject3d().position.copy(c),this.type="Line"}_workerLoad(t){const e=new ei;Tv(e,"position",new Ve(new Float32Array(t.position),3));const i=Zx(this.getOptions().colors),n=this.getObject3d(),r=n.material;i&&i.length&&(Tv(e,"color",new qe(i,3)),r.vertexColors=!0),this._computeLineDistances(e),n.geometry=e,n.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const Jx={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};
/**
			 *
			 */class Yx extends zv{constructor(t,e,i,n){e=Nc.extend({},Jx,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{height:r,width:s,bottomColor:o,topColor:a,bottomHeight:h,altitude:l,asynchronous:c}=e,u=n.altitudeToVector3(r,r).x,d=n.distanceToVector3(s,s).x,{lineStrings:f,center:p}=ix(t);let g;if(c){g=kx();const e=Nc.GUID();this.getOptions().id=e,this.getOptions().center=p,xx.push({id:e,data:f,layer:n,center:p,lineString:t,baseObject:this})}else{const t=[];let e=0;const r={};for(let i=0,s=f.length;i<s;i++){const s=ex(f[i],d,u,n,p);e=Uy(s,h,n,r),t.push(s)}g=Ex(t),a&&(qy(g,o,a,e+u/2),i.vertexColors=!0)}this._createMesh(g,i);// const center = (isGeoJSON(lineString) ? getGeoJSONCenter(lineString) : lineString.getCenter());
const m=n.altitudeToVector3(l,l).x,_=n.coordinateToVector3(p,m);this.getObject3d().position.copy(_),this.type="ExtrudeLine"}_workerLoad(t){const e=Ox(t),{topColor:i,bottomColor:n,bottomHeight:r,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(i){const t=this.getLayer();qy(e,n,i,t.altitudeToVector3(r,r).x+t.altitudeToVector3(s,s).x/2),a.vertexColors=!0}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const Qx={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};
/**
			 *
			 */class Kx extends zv{constructor(t,e,i,n){e=Nc.extend({},Qx,e,{layer:n,polygon:t}),super(),this._initOptions(e);const{height:r,topColor:s,bottomColor:o,altitude:a,bottomHeight:h,asynchronous:l}=e;let c;const u=Bv(t)?Wv(t):t.getCenter();if(l){c=kx();const e=Nc.GUID();this.getOptions().id=e,this.getOptions().center=u,vx.push({data:t,layer:n,id:e,baseObject:this})}else{c=function(t,e,i,n){const{position:r,normal:s,uv:o,indices:a}=Zy(t,e,i,n),h=new Float32Array(r.length);h.fill(1,0,r.length);const l=new ei;return Tv(l,"color",new Ve(h,3)),Tv(l,"normal",new Ve(s,3)),Tv(l,"position",new Ve(r,3)),Tv(l,"uv",new Ve(o,2)),l.setIndex(new Ve(a,1)),l}(t,r,n);const e=Uy(c,h,n);if(s){qy(c,o,s,e+n.altitudeToVector3(r,r).x/2),i.vertexColors=!0}}this._createMesh(c,i);const d=n.altitudeToVector3(a,a).x,f=n.coordinateToVector3(u,d);this.getObject3d().position.copy(f),this.type="ExtrudePolygon"}_workerLoad(t){const e=Ox(t),{topColor:i,bottomColor:n,bottomHeight:r,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(i){const t=this.getLayer();qy(e,n,i,t.altitudeToVector3(r,r).x+t.altitudeToVector3(s,s).x/2),a.vertexColors=!0}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const $x={altitude:0,coordinate:null};
/**
			 * Model container
			 */class tw extends zv{constructor(t,e={},i){e.coordinate||(e.coordinate=i.getMap().getCenter()),e=Nc.extend({},$x,e,{layer:i,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:n,coordinate:r}=e,s=i.altitudeToVector3(n,n).x,o=i.coordinateToVector3(r,s);this.getObject3d().position.copy(o),this.type="Model"}}const ew=Math.PI/180;function iw(t){return t*ew}function nw(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let i=iw(t[1]);const n=iw(e[1]),r=i-n,s=iw(t[0])-iw(e[0]);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(n)*Math.pow(Math.sin(s/2),2))),i*=6378137,Math.round(1e5*i)/1e5}function rw(t,e){const{len:i,c1:n,c2:r}=t,s=r[0]-n[0],o=r[1]-n[1],a=e/i;return[n[0]+a*s,n[1]+a*o]}
/**
			 * This is not an accurate line segment cutting method, but rough, in order to speed up the calculation,
			 * the correct cutting algorithm can be referred to. http://turfjs.org/docs/#lineChunk
			 * @param {*} cs
			 * @param {*} lineChunkLength
			 */const sw=1e3;
/**
			 *
			 * @param {THREE.BufferGeometry} geometry
			 * @param {*} ps
			 * @param {*} norls
			 * @param {*} indices
			 */const ow={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1,heightEnable:!0};
/**
			 *
			 */class aw extends zv{constructor(t,e,i,n){e=Nc.extend({},ow,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{width:r,height:s,altitude:o,speed:a,chunkLength:h,trail:l}=e;let c,u;jv(t)?(c=Wv(t),u=Vv(t)):(c=t.getCenter(),u=t);const d=function(t,e=10){e=Math.max(e,.1),Array.isArray(t)||(t=t.getCoordinates().map((t=>t.toArray())));const i=t.length;let n=[],r=0;for(let u=0;u<i-1;u++){const e=nw(t[u],t[u+1]),i=Math.floor(e);n.push({c1:t[u],len:i,c2:t[u+1]}),r+=i}if(r<=e)return n.map((t=>[t.c1,t.c2]));if(1===n.length&&n[0].len<=e)return[[n[0].c1,n[0].c2]];const s=n.length;let o,a=0,h=0;const l=[];let c=[n[0].c1];for(;a<s;){const{len:t,c2:i}=n[a];if(h+=t,h<e&&(c.push(i),a===s-1&&l.push(c),a++),h===e&&(c.push(i),h=0,l.push(c),//next
c=[i],a++),h>e){const i=t-h+e;o=rw(n[a],i),c.push(o),l.push(c),h=0,n[a].c1=o,n[a].len=t-i,//next
c=[],c.push(o)}}return l}(u,h),f=n.coordinateToVector3(c),p=new ei,g=new Float32Array(3e3),m=new Float32Array(3e3),_=new Uint16Array(sw);Tv(p,"position",new Ve(g,3)),Tv(p,"normal",new Ve(m,3)),p.setIndex(new Ve(_,1));const v=n.distanceToVector3(r,r).x,y=n.altitudeToVector3(s,s).x;// const params = getExtrudeLineParams(positions, lineWidth, depth, layer);
// setExtrudeLineGeometryAttribute(geometry, params.position, params.normal, params.indices);
this._createMesh(p,i);const x=n.altitudeToVector3(o,o).x,w=n.coordinateToVector3(c,x);this.getObject3d().position.copy(w),this._params={index:0,chunkLines:d,geometries:[],layer:n,trail:Math.max(1,l),lineWidth:v,depth:y,speed:Math.min(1,a),idx:0,loaded:!0,center:c,// positionMap,
centerPt:f,workerInitCount:0},this._init(this._params),this.type="ExtrudeLineTrail"}
/**
			     * Follow-up support for adding webworker
			     * @param {*} params
			     */_init(t){const{layer:e,trail:i,lineWidth:n,depth:r,chunkLines:s,positionMap:o,centerPt:a,center:h}=t,l=s.length,c=[];if(this.options.asynchronous){t.loaded=!1;const n=Nc.GUID();for(let t=0;t<l;t++){const r={type:"Feature",geometry:{type:"LineString",coordinates:tx(s.slice(t,t+i))}},o=`${n}-${t}`,a=Nc.extend({},this.options);a.id=o,a.center=h,xx.push({id:o,data:[r],layer:e,center:h,lineString:r,baseObject:this,option:a})}}else for(let u=0;u<l;u++){const t=$y(s.slice(u,u+i),e,0,a).positionsV;c.push(ex(t,n,r,e))}}_animation(){const{index:t,geometries:e,speed:i,idx:n,chunkLines:r,trail:s,lineWidth:o,depth:a,loaded:h,layer:l,positionMap:c,centerPt:u}=this._params;if(!h)return;const d=Math.round(t);if(d>n){this._params.idx++;let t=e[d];//if not init, this is will running
if(!t){t=ex($y(r.slice(d,d+s),l,0,u).positionsV,o,a,l),e[d]=t}const i=this.getObject3d();!function(t,e,i,n){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const s=t.attributes.position.array,o=t.attributes.normal.array;for(let a=0;a<r;a++)s[a]=e[a],o[a]=i[a];// geometry.index.array = new Uint16Array(indices.length);
t.index.count=n.length;// geometry.index.needsUpdate = true;
for(let a=0,h=n.length;a<h;a++)t.index.array[a]=n[a];// geometry.setIndex(new THREE.Uint32BufferAttribute(indices, 1));
// geometry.setDrawRange(0, len / 3);
}(i.geometry,t.position,t.normal,t.indices),i.geometry.attributes.position.needsUpdate=!0,i.geometry.attributes.normal.needsUpdate=!0,i.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=i}_workerLoad(t){if(!t)return this;const{id:e,indices:i,position:n,normal:r,uv:s}=t;if(!(e&&i&&n&&r&&s))return;let o=e.split("-")[1];if(o=parseInt(o),Nc.isNumber(o)){this._params.geometries[o]={indices:new Uint32Array(i),position:new Float32Array(n),uv:new Float32Array(s),normal:new Float32Array(r)},this._params.workerInitCount++}this._params.workerInitCount===this._params.chunkLines.length&&(this._params.loaded=!0,this._fire("workerload",{target:this}))}}const hw=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),lw=new Ue;lw.vertexColors=!0;
/**
			 * This is for the merger, MergedExtrudeMesh,Points ...
			 * @param {*} Base
			 */
const cw=t=>class extends t{// this._faceMap=[];
// this._baseObjects = [];
// this._datas = [];
// this.faceIndex = null;
// this.index=null;
// this._geometriesAttributes = [];
// this._geometryCache = geometry.clone();
// this.isHide = false;
/**
			         *
			         * @param {*} baseObjects
			         */
_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,i=t.length;e<i;e++){const i=t[e];this._proxyEvent(i)}return this}
/**
			         *Events representing the merge
			         * @param {*} baseObject
			         */_proxyEvent(t){t.on("add",(t=>{this._showGeometry(t.target,!0)})),t.on("remove",(t=>{this._showGeometry(t.target,!1)})),t.on("mouseout",(t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}// this._showGeometry(e.target, false);
)),t.on(hw,(t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}))}
/**
			         * Get the index of the monomer to be hidden
			         * @param {*} attribute
			         */_getHideGeometryIndex(t){const e=[];let i=0;for(let n=0,r=this._geometriesAttributes.length;n<r;n++)!0===this._geometriesAttributes[n].hide&&(e.push(n),i+=this._geometriesAttributes[n][t].count);return{indexs:e,count:i}}
/**
			         * update geometry attributes
			         * @param {*} bufferAttribute
			         * @param {*} attribute
			         */_updateAttribute(t,e){const{indexs:i}=this._getHideGeometryIndex(e),n=this._geometryCache.attributes[e].array,r=n.length;for(let o=0;o<r;o++)t.array[o]=n[o];let s=NaN;this.getObject3d()instanceof zs&&(s=0);for(let o=0;o<i.length;o++){const n=i[o],{start:r,end:a}=this._geometriesAttributes[n][e];for(let e=r;e<a;e++)t.array[e]=s}return this}
/**
			         * show or hide monomer
			         * @param {*} baseObject
			         * @param {*} isHide
			         */_showGeometry(t,e){let i;if(t&&(i=t.getOptions().index),null!=i){const t=this._geometriesAttributes[i],{hide:n}=t;if(n===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),// this._updateAttribute(buffGeom.attributes.normal, 'normal', 3);
// this._updateAttribute(buffGeom.attributes.color, 'color', 3);
// this._updateAttribute(buffGeom.attributes.uv, 'uv', 2);
r.attributes.position.needsUpdate=!0,// buffGeom.attributes.color.needsUpdate = true;
// buffGeom.attributes.normal.needsUpdate = true;
// buffGeom.attributes.uv.needsUpdate = true;
this.isHide=e}return this}
/**
			         * Get selected monomer
			         */
// eslint-disable-next-line consistent-return
getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}//Different objects need to implement their own methods
_setPickObject3d(){if(!this._colorMap)return;// multiplexing geometry
const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:i}=this,n=i.length,r=Gy(i);let s=0;for(let h=0;h<n;h++){const t=e.getColor(),n=t.getHex();this._colorMap[n]=h;const{count:o}=i[h].position;this._datas[h].colorIndex=n;for(let e=0;e<o;e++)r[s]=t.r,r[s+1]=t.g,r[s+2]=t.b,s+=3}Tv(t,"color",new Ve(r,3,!0));// const material = new THREE.MeshBasicMaterial();
// material.vertexColors = THREE.VertexColors;
const o=e.getColor().getHex(),a=new gi(t,lw);a.position.copy(this.getObject3d().position),a._colorIndex=o,this.setPickObject3d(a)}},uw={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},dw=new Gu(0,0);class fw extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=t.length;// const centers = [];
let s=1/0,o=1/0,a=-1/0,h=-1/0;for(let y=0;y<r;y++){const e=t[y],i=e.getCenter?e.getCenter():Wv(e,dw);let n,r;Array.isArray(i)?(n=i[0],r=i[1]):i instanceof Gu&&(n=i.x,r=i.y),s=Math.min(s,n),o=Math.min(o,r),a=Math.max(a,n),h=Math.max(h,r)}// Get the center point of the point set
const l=new Gu((s+a)/2,(o+h)/2);e=Nc.extend({},uw,e,{layer:n,polygons:t,coordinate:l});const{topColor:c,bottomColor:u,altitude:d,asynchronous:f}=e;let p;const g=[],m=[];if(super(),f)p=kx(),yx.push({id:Nc.GUID(),layer:n,key:e.key,center:l,data:t,baseObject:this});else{const e=n.coordinateToVector3(l),s=[];let o=0;const a={};for(let i=0;i<r;i++){const r=t[i],h=Bv(r)?r.properties:r.getProperties()||{},c=h.height||1,u=h.bottomHeight||0,d=Zy(r,c,n,l,e,a);s.push(d);const f=Uy(d,u,n,a),{position:p,normal:g,uv:_,indices:v}=d;// const extrudePolygon = new ExtrudePolygon(polygon, Object.assign({}, options, { height, index: i }), material, layer);
// extrudePolygons.push(extrudePolygon);
v.length;const y=p.length/3;//  colorCount = buffGeom.attributes.color.count,
g.length,_.length,m[i]={position:{middleZ:f+a[c]/2,count:y,start:o,end:o+3*y},// normal: {
//     count: normalCount,
//     start: normalIndex,
//     end: normalIndex + normalCount * 3,
// },
// // color: {
// //     count: colorCount,
// //     start: colorIndex,
// //     end: colorIndex + colorCount * 3,
// // },
// uv: {
//     count: uvCount,
//     start: uvIndex,
//     end: uvIndex + uvCount * 2,
// },
hide:!1},o+=3*y}p=Ex(s),c&&(qy(p,u,c,m),i.vertexColors=!0)}this._initOptions(e),this._createMesh(p,i);const _=n.altitudeToVector3(d,d).x,v=n.coordinateToVector3(l,_);this.getObject3d().position.copy(v),//Face corresponding to monomer
// this._faceMap = faceMap;
this._baseObjects=g,this._datas=t,this._geometriesAttributes=m,this.faceIndex=null,this._geometryCache=Dx(p),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(g),f||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}// eslint-disable-next-line consistent-return
getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Object.assign({},this.options,Bv(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Kx(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}// eslint-disable-next-line no-unused-vars
identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;// this._faceMap = faceMap;
this._geometriesAttributes=e;const i=Ox(t);this._geometryCache=Dx(i);const{topColor:n,bottomColor:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(n&&(qy(i,r,n,e),o.vertexColors=!0),s.geometry=i,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}// eslint-disable-next-line camelcase
function pw(t,e,i){// eslint-disable-next-line camelcase
const n=t.project(i),r=e.width/2,s=e.height/2;return{x:Math.round(n.x*r+r),y:Math.round(-n.y*s+s)}}const gw={altitude:0,height:0,color:null},mw=new Tt;class _w extends zv{constructor(t,e,i,n){e=Nc.extend({},gw,e,{layer:n,coordinate:t}),super();let{height:r,altitude:s,color:o,size:a}=e;const h=[],l=[];o&&(o=o instanceof pt?o:new pt(o),l.push(o.r,o.g,o.b));const c=n.altitudeToVector3(r,r).x,u=n.coordinateToVector3(t,c);h.push(0,0,u.z);const d=new ei;Tv(d,"position",new qe(h,3,!0)),l.length&&Tv(d,"color",new qe(l,3,!0)),void 0!==a&&Tv(d,"size",new qe([a],1,!0)),e.positions=u,this._initOptions(e),this._createPoints(d,i);const f=n.altitudeToVector3(s,s).x,p=new Tt(u.x,u.y,f);this.getObject3d().position.copy(p),this.type="Point"}
/**
			     *
			     * @param {maptalks.Coordinate} coordinate
			     */identify(t){const e=this.getLayer(),i=this.getMap().getSize(),n=this.getLayer().getCamera(),r=this.getOptions().positions,s=this.getOptions().altitude;//Size of points
let o=this.getObject3d().material.size;void 0===o&&(o=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),h=e.altitudeToVector3(s,s).x;mw.x=r.x,mw.y=r.y,mw.z=r.z+h;//3D vector to screen coordinates
const l=pw(mw,i,n);//Distance between two points
return Math.sqrt(Math.pow(a.x-l.x,2)+Math.pow(a.y-l.y,2))<=o/2}}function vw(t,e){const{minx:i,miny:n,maxx:r,maxy:s}=t,[o,a]=e;return i<=o&&o<=r&&n<=a&&a<=s}class yw{constructor(t,e,i,n){this.minlng=t,this.minlat=e,this.maxlng=i,this.maxlat=n,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}
/**
			     *
			     * @param {*} map
			     */updateBBoxPixel(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;const{minlng:s,minlat:o,maxlng:a,maxlat:h}=this;return[[s,o],[s,h],[a,o],[a,h]].map((t=>new Gu(t))).map((e=>t.coordToContainerPoint(e))).forEach((t=>{e=Math.min(e,t.x),i=Math.min(i,t.y),n=Math.max(n,t.x),r=Math.max(r,t.y)})),this.minx=e,this.miny=i,this.maxx=n,this.maxy=r,this}
/**
			     *Determine whether a point is included
			     * @param {*} c
			     */containsCoordinate(t){let e,i;Array.isArray(t)?(e=t[0],i=t[1]):t instanceof Gu&&(e=t.x,i=t.y);const{minlng:n,minlat:r,maxlng:s,maxlat:o}=this;return n<=e&&e<=s&&r<=i&&i<=o}
/**
			     *Judge rectangle intersection
			     * @param {*} pixel
			     * @param {*} size
			     */isRecCross(t,e){const{x:i,y:n}=t,r={minx:i-e/2,miny:n-e/2,maxx:i+e/2,maxy:n+e/2},{minx:s,miny:o,maxx:a,maxy:h}=r;return!!(vw(this,[s,o])||vw(this,[s,h])||vw(this,[a,o])||vw(this,[a,h])||vw(r,[this.minx,this.miny])||vw(r,[this.minx,this.maxy])||vw(r,[this.maxx,this.miny])||vw(r,[this.maxx,this.maxy]))}
/**
			     *generate grids
			     * @param {*} minlng
			     * @param {*} minlat
			     * @param {*} maxlng
			     * @param {*} maxlat
			     */static initGrids(t,e,i,n){const r=[],s=(i-t)/30,o=(n-e)/30;let a=t,h=e;for(let l=0;l<30;l++){a=t+l*s;for(let t=0;t<30;t++){h=e+t*o;const i=new yw(a,h,a+s,h+o);i.key=t+"-"+l,r.push(i)}}return{grids:r,averageX:s,averageY:o,ROWS:30,COLS:30}}}const xw={altitude:0},ww=new Tt;function bw(t,e){const i=Math.pow(10,e);return Math.round(t*i)/i}
/**
			 *points
			 */class Mw extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]),e=Nc.extend({},xw,e,{layer:n,points:t});let r=1/0,s=1/0,o=-1/0,a=-1/0;for(let E=0,L=t.length;E<L;E++){const{coordinate:e}=t[E];let i,n;Array.isArray(e)?(i=e[0],n=e[1]):e instanceof Gu&&(i=e.x,n=e.y),t[E].coords=[i,n],r=Math.min(r,i),s=Math.min(s,n),o=Math.max(o,i),a=Math.max(a,n)}const h=n.coordinateToVector3([(r+o)/2,(s+a)/2]),{grids:l,averageX:c,averageY:u,ROWS:d,COLS:f}=yw.initGrids(r,s,o,a);l.length;const p=new Float32Array(3*t.length),g=[],m=new Float32Array(3*t.length),_=new Float32Array(t.length),v=[],y=[],x={};let w=0,b=!1,M=!1;const S=new Tt(0,0,0);for(let E=0,L=t.length;E<L;E++){let{coordinate:e,height:i,color:o,size:a,coords:f}=t[E];const v=3*E;o&&(b=!0,o=o instanceof pt?o:new pt(o),m[v]=o.r,m[v+1]=o.g,m[v+2]=o.b),a&&(M=!0,_[E]=a,w=Math.max(w,a));const C=jy(i,n,x),T=n.coordinateToVector3(e,C);S.x=T.x,S.y=T.y,S.z=T.z,S.sub(h),// const v1 = v.clone().sub(centerPt);
p[v]=S.x,p[v+1]=S.y,p[v+2]=S.z,g.push(T),y[E]={position:{count:1,start:3*E,end:3*E+3},hide:!1};let P=bw((f[1]-s)/u,4),A=bw((f[0]-r)/c,4);P-=1,A-=1,P=Math.max(0,P),A=Math.max(0,A),P=Math.ceil(P),A=Math.ceil(A);const L=A*d+P;l[L]&&(l[L].positions.push(T),l[L].indexs.push(E));// for (let j = 0; j < gridslen; j++) {
//     if (grids[j].containsCoordinate(coordinate)) {
//         // grids[j].coordinates.push(coordinate);
//         grids[j].positions.push(v);
//         grids[j].indexs.push(i);
//         console.log(j, gridIndex);
//         break;
//     }
// }
}const C=new ei;Tv(C,"position",new Ve(p,3,!0)),b&&Tv(C,"color",new Ve(m,3,!0)),M&&Tv(C,"size",new Ve(_,1,!0)),//for identify
e.positions=g,super(),this._initOptions(e),this._createPoints(C,i);const T=e.altitude,P=n.altitudeToVector3(T,T).x,A=h.clone();A.z=P,this.getObject3d().position.copy(A),this._baseObjects=v,this._datas=t,this.faceIndex=null,this._geometriesAttributes=y,this._geometryCache=C.clone(),this.isHide=!1,this._initBaseObjectsEvent(v),this._grids=l,this._bindMapEvents(),this.type="Points",this.maxSize=w}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(()=>{this._updateGrids(),t.on(e,this._updateGrids,this)})),this.on("remove",(()=>{t.off(e,this._updateGrids,this)}))}_updateGrids(){const t=this.getMap();this._grids.forEach((e=>{e.indexs.length&&e.updateBBoxPixel(t)}))}// eslint-disable-next-line consistent-return
getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:i,height:n,color:r,size:s}=e;this._baseObjects[t]=new _w(i,{height:n,index:t,color:r,size:s},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}
/**
			   *
			   * @param {maptalks.Coordinate} coordinate
			   */identify(t){const e=this.getLayer(),i=this.getMap().getSize(),n=this.getLayer().getCamera(),r=this.getOptions().altitude,s=this.getMap(),o=e.altitudeToVector3(r,r).x;let a=this.getObject3d().material.size;const h=void 0===a,l=s.coordToContainerPoint(t),c=[];if(this._grids.forEach((t=>{t.indexs.length&&t.isRecCross(l,h?this.maxSize:a)&&c.push(t)})),c.length<1)return!1;for(let u=0,d=c.length;u<d;u++)for(let t=c[u].positions.length-1;t>=0;t--){h&&(a=this._datas[c[u].indexs[t]].size||1);const e=c[u].positions[t];ww.x=e.x,ww.y=e.y,ww.z=e.z+o;const r=pw(ww,i,n);if(Math.sqrt(Math.pow(l.x-r.x,2)+Math.pow(l.y-r.y,2))<=a/2)return this.faceIndex=c[u].indexs[t],!0}return!1}}const Sw={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};
/**
			 * merged bars
			 */class Cw extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=t.length,s=By(t),o=n.coordinateToVector3(s),a=[],h=[],l=[];let c=0;const u={},d={};let f;super(),e=Nc.extend({},{altitude:0,layer:n,points:t},Sw,e),this._initOptions(e);const p=new Tt;if(e.asynchronous){f=kx();const e=Nc.GUID();this.getOptions().id=e;const i=[];for(let s=0;s<r;s++){const e=Nc.extend({index:s},Sw,t[s]),{radius:r,radialSegments:a,altitude:h,height:l,coordinate:c}=e,f=Fy(r,n,u);t[s]._radius=f;const g=jy(l,n,d),m=jy(h,n,d),_=n.coordinateToVector3(c,0,p).sub(o);i.push({radialSegments:a,radius:f,height:g,center:[_.x,_.y],altitude:m})}Px.push({id:e,data:i,layer:n,baseObject:this})}else{for(let e=0;e<r;e++){const r=Nc.extend({index:e},Sw,t[e]),{radius:s,radialSegments:f,altitude:g,topColor:m,bottomColor:_,height:v,coordinate:y}=r,x=Fy(s,n,u),w=jy(v,n,d),b=jy(g,n,d),M=n.coordinateToVector3(y,0,p).sub(o),S=Bx({radius:x,height:w,radialSegments:f,center:[M.x,M.y]});m&&(Ux(S,_,m,"z",w/2),i.vertexColors=!0);// buffGeom.rotateX(Math.PI / 2);
const C=S.attributes.position.array;for(let t=0,e=C.length;t<e;t+=3)C[t+2]+=b;// parray[j] += v.x;
// parray[j + 1] += v.y;
// parray[j + 2] += v.z;
a.push(S);const T=new Wx(y,r,i,n);h.push(T),S.index.count;const P=S.attributes.position.count;//  colorCount = buffGeom.attributes.color.count,
S.attributes.normal.count,S.attributes.uv.count,l[e]={position:{count:P,start:c,end:c+3*P},// normal: {
//     count: normalCount,
//     start: normalIndex,
//     end: normalIndex + normalCount * 3,
// },
// // color: {
// //     count: colorCount,
// //     start: colorIndex,
// //     end: colorIndex + colorCount * 3,
// // },
// uv: {
//     count: uvCount,
//     start: uvIndex,
//     end: uvIndex + uvCount * 2,
// },
hide:!1},c+=3*P}f=Gx(a)}this._createMesh(f,i);const g=e.altitude,m=n.altitudeToVector3(g,g).x,_=o.clone();_.z=m,this.getObject3d().position.copy(_),// this._faceMap = faceMap;
this._baseObjects=h,this._datas=t,this._geometriesAttributes=l,this.faceIndex=null,this._geometryCache=Dx(f),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(h),e.asynchronous||(this._setPickObject3d(),this._init()),this.type="Bars"}// eslint-disable-next-line no-unused-vars
identify(){return this.picked}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Object.assign({},this.options,e,{index:t,asynchronous:!1});this._baseObjects[t]=new Wx(e.coordinate,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const i=Ox(t);this._geometryCache=Dx(i);const{topColor:n,bottomColor:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(n&&(Ux(i,r,n,"z",e),o.vertexColors=!0),s.geometry=i,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Tw={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class Pw extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=[],s=[],o=t.length;for(let _=0;_<o;_++){const e=ix(t[_]);r.push(e.center),s.push(e.lineStrings)}// Get the center point of the point set
const a=By(r);e=Nc.extend({},Tw,e,{layer:n,lineStrings:t,coordinate:a});const{altitude:h,topColor:l,bottomColor:c,asynchronous:u}=e;let d;const f=[],p=[];if(super(),u)d=kx(),wx.push({id:Nc.GUID(),layer:n,key:e.key,center:a,data:s,lineStrings:t,baseObject:this});else{const e=[];let r=0;const h={},u={};for(let i=0;i<o;i++){const o=t[i],l=Nc.extend({},Tw,jv(o)?o.properties:o.getProperties(),{index:i}),{height:c,width:d,bottomHeight:f}=l,g=Fy(d,n,h),m=jy(c,n,u),_=s[i],v=[];let y=0;for(let t=0,e=_.length;t<e;t++){const e=ex(_[t],g,m,n,a);y=Uy(e,f,n,h),v.push(e)}const x=Lx(v);e.push(x);// const extrudeLine = new ExtrudeLine(lineString, opts, material, layer);
// extrudeLines.push(extrudeLine);
const{position:w,normal:b,indices:M}=x;M.length;const S=w.length/3;//  colorCount = buffGeom.attributes.color.count,
b.length,p[i]={position:{middleZ:y+m/2,count:S,start:r,end:r+3*S},// normal: {
//     count: normalCount,
//     start: normalIndex,
//     end: normalIndex + normalCount * 3,
// },
// color: {
//     count: colorCount,
//     start: colorIndex,
//     end: colorIndex + colorCount * 3,
// },
// uv: {
//     count: uvCount,
//     start: uvIndex,
//     end: uvIndex + uvCount * 2,
// },
hide:!1},r+=3*S}d=Ex(e),l&&(qy(d,c,l,p),i.vertexColors=!0)}this._initOptions(e),this._createMesh(d,i);const g=n.altitudeToVector3(h,h).x,m=n.coordinateToVector3(a,g);this.getObject3d().position.copy(m),//Face corresponding to monomer
// this._faceMap = faceMap;
this._baseObjects=f,this._datas=t,this._geometriesAttributes=p,this.faceIndex=null,this._geometryCache=Dx(d),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(f),u||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}// eslint-disable-next-line consistent-return
getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Object.assign({},this.options,Uv(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Yx(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}// eslint-disable-next-line no-unused-vars
identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;// this._faceMap = faceMap;
this._geometriesAttributes=e;const i=Ox(t);this._geometryCache=Dx(i);const{topColor:n,bottomColor:r,bottomHeight:s,height:o}=this.getOptions(),a=this.getObject3d().material;if(n&&(qy(i,r,n,e),a.vertexColors=!0),this.getObject3d().geometry=i,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Aw={altitude:0,colors:null};
/**
			 *
			 */class Ew extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=[],s=[],o=t.length;for(let v=0;v<o;v++){const e=ix(t[v]);r.push(e.center),s.push(e.lineStrings)}// Get the center point of the point set
const a=By(r);e=Nc.extend({},Aw,e,{layer:n,lineStrings:t,coordinate:a}),super(),this._initOptions(e);const{asynchronous:h}=e;let l;const c=[],u={};let d=[],f=0,p=[];if(h)l=ax(),Mx.push({id:Nc.GUID(),layer:n,key:e.key,center:a,data:s,lineStrings:t,baseObject:this});else{for(let e=0;e<o;e++){const t=s[e];let i=0;for(let e=0,r=t.length;e<r;e++){const r=Uv(t[e])?t[e].properties:t[e].getProperties()||{},{positions:s}=Ky(t[e],n,a,!1);Uy(s,r.bottomHeight,n,u),i+=s.length/3*2-2,p.push(nx(s))}d[e]={position:{count:i,start:f,end:f+3*i},hide:!1},f+=3*i}const t=rx(p);l=new ei,Tv(l,"position",new Ve(t,3))}this._createLineSegments(l,i);const{altitude:g}=e,m=n.altitudeToVector3(g,g).x,_=n.coordinateToVector3(a,m);this.getObject3d().position.copy(_),// this._faceMap = faceMap;
this._baseObjects=c,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this.index=null,this._geometryCache=l.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(c),h||(this._setPickObject3d(),this._init()),this.type="Lines"}// eslint-disable-next-line consistent-return
getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Nc.extend({},this.getOptions(),{index:t},Uv(e)?e.properties:e.getProperties());this._baseObjects[t]=new Xx(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:i}=this,n=i.length,r=Gy(i);let s=0;for(let l=0;l<n;l++){const t=e.getColor(),n=t.getHex();this._colorMap[n]=l;const{count:o}=i[l].position;this._datas[l].colorIndex=n;for(let e=0;e<o;e++)r[s]=t.r,r[s+1]=t.g,r[s+2]=t.b,s+=3}Tv(t,"color",new Ve(r,3,!0));const o=this.getObject3d().material.clone();o.color.set("#fff"),o.vertexColors=!0;const a=e.getColor().getHex(),h=new zs(t,o);h.position.copy(this.getObject3d().position),h._colorIndex=a,this.setPickObject3d(h)}// eslint-disable-next-line no-unused-vars
identify(t){return this.picked}_workerLoad(t){const{position:e,geometriesAttributes:i}=t;// this._faceMap = faceMap;
this._geometriesAttributes=i;const n=new ei;if(Tv(n,"position",new Ve(new Float32Array(e),3)),this._computeLineDistances(n),this._geometryCache=n.clone(),this.getObject3d().geometry=n,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}
/*

			Global sharing

			*/
//Maximum concurrent
const Lw=[],Rw=[];function Ow(){return{waitingQueue:Lw,currentQueue:Rw}}
/**
			 *
			 * @param {*} key
			 * @param {*} url
			 * @param {*} callback
			 * @param {*} img
			 * @param {*} vt
			 */
/**
			 *
			 * @param {*} queArray
			 * @param {*} index
			 */
function Dw(t,e){for(let i=0,n=t.length;i<n;i++){const n=t[i];if(n){const{key:r,callback:s}=n;if(e===r)return t.splice(i,1),s}}return null}
/**
			 *
			 * @param {*} key
			 * @param {*} vt
			 */const Iw=document.createElement("canvas");let kw;function zw(t,e=!1){if(kw)return kw;const i=Iw.getContext("2d");return i.clearRect(0,0,256,256),i.save(),kw=Iw.toDataURL(),kw}function Nw(t=1,e=1){let i;return"undefined"==typeof document||(i=document.createElement("canvas"),t&&(i.width=t),e&&(i.height=e)),i}
/**
			 *
			 */Iw.width=Iw.height=256;class Fw extends i_{constructor(t,e={}){super(Nc.GUID(),Nc.extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}
/**
			     *get current all baseobject
			     */getBaseObjects(){const t=this._loadTiles,e=[];for(let i in t){const t=this._baseObjectKeys[i];if(t&&Array.isArray(t)&&t.length)for(let i=0,n=t.length;i<n;i++)e.push(t[i])}return e}
/**
			   * This method should be overridden for event handling
			   * @param {*} type
			   * @param {*} e
			   */
// eslint-disable-next-line no-unused-vars
onSelectMesh(t,e){}
/**
			   * this is can override
			   * @param {*} index
			   * @param {*} json
			   */
// eslint-disable-next-line no-unused-vars
formatBaseObjects(t,e){return[]}//queue loop
// eslint-disable-next-line no-unused-vars
loopMessage(t){}
/**
			    *
			    * @param {*} q
			    */getTileData(t){const{key:e,url:i,callback:n,img:r}=t;vu.getJSON(i,{},(function(t,i){n(e,t?null:i,r)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],i={};for(let n=0,r=t.length;n<r;n++){const r=t[n].tiles||[];for(let t=0,n=r.length;t<n;t++){const{id:n}=r[t];e.push(n),i[n]=!0}}return{keys:e,keysMap:i}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){// This event will be triggered multiple times per unit time
const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,i=this._loadTiles,n=this._layer,r=this._baseObjectKeys,s=Object.keys(e).length,o=Object.keys(i).length,a=[];if(s&&o)for(let h in i)e[h]||r[h]&&(r[h]||[]).forEach((t=>{a.push(t)}));if(a.length&&n.removeMesh(a,!1),s&&o)for(let h in e)if(!i[h])if(r[h]){const t=r[h];n.addMesh(t)}else{const{x:t,y:e,z:i}=this._getXYZOfIndex(h);this.getTileUrl(t,e,i)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=zw(e._key,this._opts.debug))}_generateBaseObjects(t,e,i){if(e&&i){const{keysMap:n}=this._getCurentTileKeys();//not in current ,ignore
if(!n[t])return void(i.src=zw(0,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){i.needCount=r.length,i.currentCount=0;for(let e=0,n=r.length;e<n;e++){const n=r[e];n._img=i,n._vt=this,this.isVisible()||n.hide(),this._cachetile(t,n),n.isAsynchronous()||i.currentCount++}this._layer.addMesh(r,!1),i.needCount===i.currentCount&&(i.src=zw(0,this._opts.debug)),this.isAsynchronous()?r.filter((t=>t.isAsynchronous())).forEach((t=>{t.on("workerload",this._workerLoad,this)})):i.src=zw(0,this._opts.debug)}else i.src=zw(0,this._opts.debug);this._loadTiles[t]=!0}else i&&(i.src=zw(0,this._opts.debug))}_diffCache(){// if (this._layer.getMap().isInteracting()) {
//     return;
// }
if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,i=[];for(let n in this._baseObjectKeys)t[n]||e[n]||((this._baseObjectKeys[n]||[]).forEach((t=>{t.isAdd&&i.push(t)})),this._diposeBaseObject(n),delete this._baseObjectKeys[n]);// Batch deletion can have better performance
i.length&&this._layer.removeMesh(i,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[i,n,r]=t.split(e).slice(1,4);return{x:parseInt(n),y:parseInt(i),z:parseInt(r)}}_getTileExtent(t,e,i){const n=this.getMap()._getResolution(i);return this._getTileConfig().getTilePrjExtent(t,e,n)}
/**
			     *
			     * @param {} x
			     * @param {*} y
			     * @param {*} z
			     */_getTileLngLatExtent(t,e,i){const n=this._getTileExtent(t,e,i);let r=n.getMax(),s=n.getMin();const o=this.getMap().getProjection();return s=o.unproject(s),r=o.unproject(r),new id(s,r)}}const jw={worker:!1};
/**
			 *Provide a simple data loading layer with large amount of data
			 */class Bw extends Fw{constructor(t,e={},i,n){super(Nc.GUID(),Nc.extend({urlTemplate:t},jw,e)),this._opts=e,this._layer=n,this.getMaterial=i,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}
/**
			     * this is can override
			     * @param {*} index
			     * @param {*} json
			     */formatBaseObjects(t,e){const i=this._opts,n=[],r=this.isAsynchronous();for(let s in e){const o=e[s]||{};let a;if(Array.isArray(o)?a=o:"FeatureCollection"===o.type&&(a=o.features),a&&a.length){const e=[],h=[],l=[];for(let t=0,i=a.length;t<i;t++){const i=a[t];if(Bv(i))e.push(i);else if(Uv(i)){const t=Zv(i);for(let e=0,i=t.length;e<i;e++)h.push(t[e])}else if(Gv(i)){const t=Zv(i);for(let e=0,i=t.length;e<i;e++)l.push(Nc.extend({},t[e].properties,t[e],{coordinate:Vv(t[e])}))}}if(e.length){const a=this._getMaterial(s,e,t,o);if(a){const o=this._layer.toExtrudePolygons(e,Nc.extend({},{topColor:"#fff",layerName:s,asynchronous:r,key:t},i),a);n.push(o)}}if(h.length){const e=this._getMaterial(s,h,t,o);if(e&&(e instanceof Ps||e instanceof Go)){const t=this._layer.toLines(h,Nc.extend({},{layerName:s,asynchronous:r},i),e);n.push(t)}}if(l.length){const e=this._getMaterial(s,l,t,o);if(e&&e instanceof Ns){const t=this._layer.toPoints(l,Nc.extend({},{layerName:s,asynchronous:r},i),e);n.push(t)}}}}return n}//queue loop
loopMessage(t){const{currentQueue:e}=Ow();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,
/**
			             * layerload have a bug ,Sometimes it doesn't trigger,I don't know why
			             * Add heartbeat detection mechanism
			             */
this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),i=new Image;return i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t),this.loadTileImage(i,t.url,t.id),i},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!
/**
			 *
			 * @param {*} index
			 */
function(t){const e=Dw(Lw,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,i)=>{t._key=i,function(t,e,i,n,r){// url += `?key=${key}`;
const s={key:t,url:e,callback:i,img:n,vt:r};Rw.length<10?(Rw.push(s),r.loopMessage(s)):Lw.push(s)}(i,e,((t,e,i)=>{// img.src = generateImage(key, this._opts.debug);
this._generateBaseObjects(t,e,i),function(t,e){if(Dw(Rw,t),Lw.length){Rw.push(Lw[0]),Lw.splice(0,1);const t=Rw[Rw.length-1];e.loopMessage(t)}}(t,this)}),t,this)}}))}_getMaterial(t,e,i,n){return this.getMaterial&&Nc.isFunction(this.getMaterial)?this.getMaterial(t,e,i,n):null}}function Uw(t,e,i,n){const{position:r,uv:s,normal:o,indexs:a}=function(t,e,i,n){const r=t/i,s=e/n,o=-t/2,a=e/2,h=-e/2,l=(i+1)*(n+1),c=new Float32Array(3*l),u=new Float32Array(2*l),d=new Float32Array(3*l),f=new Uint32Array(10*l);let p=0,g=0,m=0;for(let v=0;v<=n;v++)for(let l=0;l<=i;l++){const _=o+r*l,y=a-s*v;c[p]=_,c[p+1]=y,c[p+2]=0,d[p]=0,d[p+1]=0,d[p+2]=1;const x=(_-o)/t,w=(y-h)/e;if(u[g]=x,u[g+1]=w,p+=3,g+=2,l<i&&v<n){const t=v*(i+1)+l,e=t+1,n=(i+1)*(v+1)+l,r=n+1;f[m]=t,f[m+1]=n,f[m+2]=e,f[m+3]=n,f[m+4]=r,f[m+5]=e,m+=6}}const _=new Uint32Array(m);for(let v=0,y=_.length;v<y;v++)_[v]=f[v];return{position:c,uv:u,normal:d,indexs:_}}(t,e,i,n),h=new ei;return Tv(h,"position",new Ve(r,3)),Tv(h,"normal",new Ve(o,3)),Tv(h,"uv",new Ve(s,2)),h.setIndex(new Ve(a,1)),h}// import { addAttribute } from './util/ThreeAdaptUtil';
const Gw=new class extends Zo{constructor(t){super(t)}load(t,e,i,n){const r=new xt,s=new qo(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(t,(function(t){r.image=t,r.needsUpdate=!0,void 0!==e&&e(r)}),i,n),r}},Hw=document.createElement("canvas");function Vw(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const Ww=new Map;function Zw(t,e,i,n){if(!e||!i)return;const{imageWidth:r,imageHeight:s}=n;let o;if(o=t instanceof Uint32Array||t instanceof Uint8ClampedArray?t:function(t,e=256,i=256){Hw.width=e,Hw.height=i;const n=Hw.getContext("2d");return n.drawImage(t,0,0,e,i),n.getImageData(0,0,e,i).data}(t,r,s),!o)return;let a=0,h=0,l=0;const c=new Tt,u=Ww;//rgb to height  https://docs.mapbox.com/help/troubleshooting/access-elevation-data/
for(let d=0,f=o.length;d<f;d+=4){const t=.1*(256*o[d]*256+256*o[d+1]+o[d+2])-1e4;let n=0;if(0!==h&&h+1!==s&&0!==l&&l+1!==r){const e=u.get(t);void 0!==e?n=e:(n=i.altitudeToVector3(t,t,null,c).x,u.set(t,n))}e.attributes.position.array[3*a+2]=n,a++,l++,l===r&&(h++,l=0)}e.attributes.position.needsUpdate=!0}const qw={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null};
/**
			 *
			 */class Xw extends zv{constructor(t,e,i,n){e=Nc.extend({},qw,e,{layer:n,extent:t});const{texture:r,image:s,altitude:o,imageHeight:a,imageWidth:h}=e;// if (!image) {
//     console.error('not find image');
// }
t instanceof id||(t=new id(t));const{xmin:l,ymin:c,xmax:u,ymax:d}=t;let f=1/0,p=1/0,g=-1/0,m=-1/0;[[l,c],[l,d],[u,d],[u,c]].forEach((t=>{const e=n.coordinateToVector3(t),{x:i,y:r}=e;f=Math.min(i,f),p=Math.min(r,p),g=Math.max(i,g),m=Math.max(r,m)}));const _=(g-f)/h,v=(m-p)/a;//buffer 1px
f-=_,g+=_,p-=v,m+=v;const y=Math.abs(g-f),x=Math.abs(m-p),w=Vw(s),b=Vw(r),M=Uw(y,x,h-1,a-1);super(),this._initOptions(e),this._createMesh(M,i);const S=n.altitudeToVector3(o,o).x,C=n.coordinateToVector3(t.getCenter(),S);this.getObject3d().position.copy(C),i.transparent=!0,w&&(w.onload=()=>{Zw(w,M,n,{imageWidth:h,imageHeight:a})},w.onerror=function(){}),b?(i.opacity=0,Gw.load(b.src,(t=>{i.map=t,i.opacity=1,i.needsUpdate=!0}))):i.opacity=1,this.type="Terrain"}updateData(t){return Zw(t,this.getObject3d().geometry,this.getLayer(),this.getOptions()),this}}const Jw={// worker: false
scale:1,tileDivisor:4};
/**
			 *
			 */class Yw extends Fw{constructor(t,e={},i,n){super(Nc.GUID(),Nc.extend({urlTemplate:t},Jw,e)),this._opts=e,this._layer=n,this.material=i,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}
/**
			     * this is can override
			     * @param {*} index
			     * @param {*} json
			     */formatBaseObjects(t,e){const i=this.options,n=[],{scale:r,tileDivisor:s}=i,{x:o,y:a,z:h}=this._getXYZOfIndex(t),l=this.getMap().getZoom(),c=this.getTileUrl(o,a,h),[u,d]=this.options.tileSize,f=this._getTileLngLatExtent(o,a,h),p=this.material.clone();if(h+1>=Math.round(l)){const t=new Xw(f,{image:e,imageWidth:u/s,imageHeight:d/s,texture:c},p,this._layer);t.getObject3d().scale.set(r,r,1),n.push(t)}return n}//queue loop
loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,
/**
			             * layerload have a bug ,Sometimes it doesn't trigger,I don't know why
			             * Add heartbeat detection mechanism
			             */
this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),i=new Image;return i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t),this.loadTileImage(i,t.url,t.id),i},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},i=this._imgQueue[e.id];i&&(i.src="",i.onload=null,i.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,i)=>{t._key=i;const n=new Image;this._imgQueue[i]=n;const r={key:i,url:e,rgbImage:n,callback:(t,e,i)=>{this._generateBaseObjects(t,e,i)},img:t,vt:this};this.loopMessage(r)}}))}}
/*!
			 * Code from baidu mapv
			 * License: BSD-3
			 * https://github.com/huiyan-fe/mapv
			 *
			 */
/**
			 * Category
			 * @param {Object} [options]   Available options:
			 *                             {Object} gradient: { 0.25: "rgb(0,0,255)", 0.55: "rgb(0,255,0)", 0.85: "yellow", 1.0: "rgb(255,0,0)"}
			 */function Qw(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function Kw(t,e,i){var n=$w(i),r=function(t){var e=t.min||0;return e}(i),s=n-r,o=i.range||null,a=0,h=1024;o&&2===o.length&&(a=(o[0]-r)/s*1024),o&&2===o.length&&(h=(o[1]-r)/s*1024);// var range = options.range;
for(var l,c=i.maxOpacity||.8,u=i.minOpacity||0,d=3,f=t.length;d<f;d+=4)l=4*t[d],// get gradient color from opacity value
t[d]/256>c&&(t[d]=256*c),t[d]/256<u&&(t[d]=256*u),l&&l>=a&&l<=h?(t[d-3]=e[l],t[d-2]=e[l+1],t[d-1]=e[l+2]):t[d]=0}function $w(t){return t.max||100}function tb(t,e,i){var n=$w(i),r=
/*!
			 * Code from baidu mapv
			 * License: BSD-3
			 * https://github.com/huiyan-fe/mapv
			 *
			 */
function(t){var e=t/2,i=t+e,n=1e4,r=Nw(2*i,2*i),s=r.getContext("2d");return s.shadowBlur=e,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=n,s.beginPath(),s.arc(i-n,i-n,t,0,2*Math.PI,!0),s.closePath(),s.fill(),r}(i._size||i.size||13),s=r.width/2,o=r.height/2,a=e,h={};// var min = getMin(options);
// console.log(max)
for(var l in a.forEach((function(t){var e=void 0===t.count?1:t.count,i=Math.min(1,e/n).toFixed(2);h[i]=h[i]||[],h[i].push(t)})),h)if(!isNaN(l)){var c=h[l];t.beginPath(),i.withoutAlpha||(t.globalAlpha=l),// context.strokeStyle = intensity.getColor(i * max);
c.forEach((function(e){var i=e.coordinate,a=void 0===e.count?1:e.count;t.globalAlpha=a/n,t.drawImage(r,i[0]-s,i[1]-o)}))}}Qw.prototype.setMax=function(t){this.max=t||100},Qw.prototype.setMin=function(t){this.min=t||0},Qw.prototype.setMaxSize=function(t){this.maxSize=t||35},Qw.prototype.setMinSize=function(t){this.minSize=t||0},Qw.prototype.initPalette=function(){var t=this.gradient,e=Nw(256,1),i=this.paletteCtx=e.getContext("2d"),n=i.createLinearGradient(0,0,256,1);for(var r in t)n.addColorStop(parseFloat(r),t[r]);i.fillStyle=n,i.fillRect(0,0,256,1)},Qw.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},Qw.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var i=this.max,n=this.min;t>i&&(t=i),t<n&&(t=n);var r=4*Math.floor((t-n)/(i-n)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},
/**
			 * @param Number value
			 * @param Number max of value
			 * @param Number max of size
			 * @param Object other options
			 */
Qw.prototype.getSize=function(t){var e=this.max,i=this.min,n=this.maxSize,r=this.minSize;return t>e&&(t=e),t<i&&(t=i),e>i?r+(t-i)/(e-i)*(n-r):n},Qw.prototype.getLegend=function(t){var e=this.gradient,i=t.width||20,n=t.height||180,r=Nw(i,n),s=r.getContext("2d"),o=s.createLinearGradient(0,n,0,0);for(var a in e)o.addColorStop(parseFloat(a),e[a]);return s.fillStyle=o,s.fillRect(0,0,i,n),r};const eb={draw:function(t,e,i){if(!(t.canvas.width<=0||t.canvas.height<=0)){var n=i.strength||.3;t.strokeStyle="rgba(0,0,0,"+n+")";// var shadowCanvas = new Canvas(context.canvas.width, context.canvas.height);
var r=Nw(t.canvas.width,t.canvas.height),s=r.getContext("2d");s.scale(devicePixelRatio,devicePixelRatio),i=i||{},// var data = dataSet instanceof DataSet ? dataSet.get() : dataSet;
t.save();var o=new Qw({gradient:i.gradient});// return false;
if(tb(s,e,i),!i.absolute){var a=s.getImageData(0,0,t.canvas.width,t.canvas.height);Kw(a.data,o.getImageData(),i),t.putImageData(a,0,0),t.restore()}o=null,r=null}},drawGray:tb,colorize:Kw},ib={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5};
/**
			 *
			 */
class nb extends zv{constructor(t,e,i,n){Array.isArray(t)||(t=[t]);let r=1/0,s=1/0,o=-1/0,a=-1/0;const h=[];//Calculate bbox
for(let k=0,z=t.length;k<z;k++){const{coordinate:e,lnglat:i,xy:l}=t[k],c=e||i||l;if(!c)continue;const u=n.coordinateToVector3(c);h.push(u);const{x:d,y:f}=u;r=Math.min(r,d),s=Math.min(s,f),o=Math.max(o,d),a=Math.max(a,f)}e=Nc.extend({},ib,e,{layer:n,points:t});// Calculate canvas width and height
let{gridScale:l,altitude:c}=e;const u=Math.abs(o-r),d=Math.abs(a-s),f=Math.max(u*l,d*l);if(f>2048){l=2048/(f/l)}const p=Math.ceil(u*l),g=Math.ceil(d*l),m=p/u,_=g/d,v=[];for(let k=0,z=h.length;k<z;k++){const e=h[k];e.x-=r,e.y-=s,e.x*=m,e.y*=_,e.y=g-e.y,//for heat draw data
v.push({coordinate:[e.x,e.y],count:t[k].count})}let y=Nw(p,g),x=y.getContext("2d");// shadowContext.scale(devicePixelRatio, devicePixelRatio);
eb.drawGray(x,v,e);const w=x.getImageData(0,0,x.canvas.width,x.canvas.height);let b=-1/0;const M=new Float32Array(w.data.length/4),S=new Float32Array(w.data.length/4);for(let k=3,z=w.data.length,N=0;k<z;k+=4){const t=w.data[k];b=Math.max(b,t),S[N]=t,//Points that do not need to be drawn
t<=0&&(M[N]=1),N++}const C=new Qw({gradient:e.gradient});eb.colorize(w.data,C.getImageData(),e),y=null,x=null;// const geometry = new THREE.PlaneBufferGeometry(offsetX, offsetY, canvasWidth - 1, canvasHeight - 1);
const T=Uw(u,d,p-1,g-1),P=T.getIndex().array,A=T.attributes.position.array,E=new Float32Array(A.length),L=new Uint32Array(6*A.length),R=new pt;let O=0;for(let k=0,z=A.length,N=0,F=P.length,j=0,B=w.data.length,U=0;k<Math.max(z,F,B);k+=3){if(k<z){const t=S[U];t>0&&(A[k+2]=t/b)}if(N<F){const t=P[N],e=P[N+1],i=P[N+2];M[t]&&M[e]&&M[i]||(L[O]=t,L[O+1]=e,L[O+2]=i,O+=3)}if(j<B){const t=`rgb(${w.data[j]},${w.data[j+1]},${w.data[j+2]})`;// a = colored.data[i + 3];
R.setStyle(t),E[N]=R.r,E[N+1]=R.g,E[N+2]=R.b}N+=3,j+=4,U++}const D=new Uint32Array(O);for(let k=0;k<O;k++)D[k]=L[k];T.setIndex(new Ve(D,1)),Tv(T,"color",new Ve(E,3,!0)),i.vertexColors=!0,super(),this._initOptions(e),this._createMesh(T,i);const I=n.altitudeToVector3(c,c).x;this.getObject3d().position.copy(new Tt((r+o)/2,(s+a)/2,I)),this.type="HeatMap"}}const rb=new pt;let sb=1;
/**
			 *https://github.com/mrdoob/three.js/blob/master/examples/webgl_interactive_cubes_gpu.html
			 */class ob{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new bt(1,1),this.pickingScene=new ms}getColor(){return rb.setHex(sb),sb++,rb}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:i,pickingTexture:n,pickingScene:r,object3ds:s,layer:o}=this,a=this.pickingScene.children.length;// reset all object3d picked
for(let x=0;x<a;x++){const t=this.pickingScene.children[x];t&&t.__parent&&(t.__parent.picked=!1)}//resize size
const{width:h,height:l}=o._getRenderer().canvas,c=n.width,u=n.height;h===c&&l===u||n.setSize(h,l),//render the picking scene off-screen
// set the view offset to represent just a single pixel under the mouse
// camera.setViewOffset(width, height, mouse.x, mouse.y, 1, 1);
// render the scene
i.setRenderTarget(n),i.clear(),e&&e.layers&&this.camera.layers.set(0),i.render(r,e);// clear the view offset so rendering returns to normal
// camera.clearViewOffset();
//create buffer for reading single pixel
const d=new Uint8Array(4),{x:f,y:p}=t,g=window.devicePixelRatio,m=f*g,_=n.height-p*g;//read the pixel
i.readRenderTargetPixels(n,Math.round(m),Math.round(_),1,1,d);//interpret the pixel as an ID
const v=d[0]<<16|d[1]<<8|d[2],y=s[v];if(y)y.__parent&&(s[v].__parent.picked=!0);else//for merged mesh
for(let x=0;x<a;x++){const t=this.pickingScene.children[x];if(t&&t.__parent){const e=t.__parent;if(e._colorMap&&null!=e._colorMap[v]){e.picked=!0,e.index=e._colorMap[v];break}}}i.setRenderTarget(null)}}const ab={bottomHeight:0,altitude:0};class hb extends zv{constructor(t,e,i,n){e=Nc.extend({},ab,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{asynchronous:r}=e,{lineStrings:s,center:o}=ix(t),a=new Ov;let h;if(r){const e=Nc.GUID();this.getOptions().id=e,this.getOptions().center=o,Sx.push({id:e,data:s,lineString:t,center:o,layer:n,baseObject:this})}else{const t=[],i={};for(let r=0,a=s.length;r<a;r++){const a=Ky(s[r],n,o,!1).positions;Uy(a,e.bottomHeight,n,i),t.push(nx(a))}h=rx(t),a.setPositions(h)}this._setMaterialRes(n,i),this._createLine2(a,i);const{altitude:l}=e,c=n.altitudeToVector3(l,l).x,u=n.coordinateToVector3(o,c);this.getObject3d().position.copy(u),r||(this._setPickObject3d(h,i.linewidth),this._init()),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setMaterialRes(t,e){const i=t.getMap().getSize(),n=i.width,r=i.height;e.resolution.set(n,r)}_setPickObject3d(t,e){// if (!this._colorMap) {
//     return;
// }
const i=new Ov;i.setPositions(t);const n=this.getLayer().getPick().getColor(),r=[];for(let h=0,l=t.length/3;h<l;h++)r.push(n.r,n.g,n.b);i.setColors(r);const s=new Lv({color:"#fff",// side: THREE.BackSide,
linewidth:e,vertexColors:!0});this._setMaterialRes(this.getLayer(),s);const o=n.getHex(),a=new Dv(i,s);a.position.copy(this.getObject3d().position),a._colorIndex=o,this.setPickObject3d(a)}// eslint-disable-next-line no-unused-vars
identify(t){return this.picked}setSymbol(t){if(t&&t instanceof Be){t.needsUpdate=!0;const e=this.getMap().getSize(),i=e.width,n=e.height;t.resolution.set(i,n),this.getObject3d().material=t}return this}_workerLoad(t){const e=new Float32Array(t.position),i=this.getObject3d();if(i.geometry.setPositions(e),i.computeLineDistances(),this._setPickObject3d(e,i.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const lb={altitude:0,colors:null};
/**
			 *
			 */class cb extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=[],s=[],o=t.length;for(let x=0;x<o;x++){const e=ix(t[x]);r.push(e.center),s.push(e.lineStrings)}// Get the center point of the point set
const a=By(r);e=Nc.extend({},lb,e,{layer:n,lineStrings:t,coordinate:a}),super(),this._initOptions(e);const{asynchronous:h}=e,l=new Ov,c=[],u={};let d,f,p=[],g=0,m=[];if(h)Cx.push({id:Nc.GUID(),data:s,key:e.key,center:a,layer:n,baseObject:this,lineStrings:t});else{//LineSegmentsGeometry
for(let t=0;t<o;t++){const e=s[t];let i=0;for(let t=0,r=e.length;t<r;t++){const r=Uv(e[t])?e[t].properties:e[t].getProperties()||{},{positions:s}=Ky(e[t],n,a,!1);Uy(s,r.bottomHeight,n,u),i+=s.length/3*2-2,m.push(nx(s))}p[t]={position:{count:i,start:g,end:g+3*i},instanceStart:{count:i,start:g,end:g+3*i},instanceEnd:{count:i,start:g,end:g+3*i},hide:!1},g+=3*i}d=rx(m),l.setPositions(d)}this._setMaterialRes(n,i),this._createLine2(l,i);const{altitude:_}=e,v=n.altitudeToVector3(_,_).x,y=n.coordinateToVector3(a,v);this.getObject3d().position.copy(y),// this._faceMap = faceMap;
this._baseObjects=c,this._datas=t,this._geometriesAttributes=p,this.faceIndex=null,this.index=null,this._geometryCache=new Ov,h||(f=new Float32Array(d),this._geometryCache.setPositions(f)),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(c),h||(this._setPickObject3d(f,i.linewidth),this._init()),this.type="FatLines"}_setMaterialRes(t,e){const i=t.getMap().getSize(),n=i.width,r=i.height;e.resolution.set(n,r)}_setPickObject3d(t,e){if(!this._colorMap)return;const i=this._geometryCache||new Ov;i.setPositions(t);const n=this.getLayer().getPick(),{_geometriesAttributes:r}=this,s=Gy(r);let o=0;for(let c=0,u=r.length;c<u;c++){const t=n.getColor(),e=t.getHex();this._colorMap[e]=c;const{count:i}=r[c].position;this._datas[c].colorIndex=e;for(let n=0;n<i;n++)s[o]=t.r,s[o+1]=t.g,s[o+2]=t.b,o+=3}i.setColors(s);const a=new Lv({// color: color.getStyle(),
// side: THREE.BackSide,
color:"#fff",linewidth:e,vertexColors:!0});this._setMaterialRes(this.getLayer(),a);const h=n.getColor().getHex(),l=new Dv(i,a);l.position.copy(this.getObject3d().position),l._colorIndex=h,this.setPickObject3d(l)}// eslint-disable-next-line no-unused-vars
identify(t){return this.picked}setSymbol(t){if(t&&t instanceof Be){t.needsUpdate=!0;const e=this.getMap().getSize(),i=e.width,n=e.height;t.resolution.set(i,n),this.getObject3d().material=t}return this}// eslint-disable-next-line consistent-return
getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Nc.extend({},this.getOptions(),{index:t},Uv(e)?e.properties:e.getProperties());this._baseObjects[t]=new hb(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}
/**
			       * update geometry attributes
			       * @param {*} bufferAttribute
			       * @param {*} attribute
			       */_updateAttribute(t,e){const{indexs:i}=this._getHideGeometryIndex(e),n=this._geometryCache.attributes[e].array,r=n.length;for(let s=0;s<r;s++)t.array[s]=n[s];for(let s=0;s<i.length;s++){const n=i[s],{start:r,end:o}=this._geometriesAttributes[n][e];for(let e=r;e<o;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let i;if(t&&(i=t.getOptions().index),null!=i){const t=this._geometriesAttributes[i],{hide:n}=t;if(n===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),// this._updateAttribute(buffGeom.attributes.instanceDistanceStart, 'instanceDistanceStart');
// this._updateAttribute(buffGeom.attributes.instanceDistanceEnd, 'instanceDistanceEnd');
r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,// buffGeom.attributes.instanceDistanceStart.data.needsUpdate = true;
// buffGeom.attributes.instanceDistanceEnd.data.needsUpdate = true;
this.isHide=e}return this}_workerLoad(t){const{geometriesAttributes:e}=t;// this._faceMap = faceMap;
this._geometriesAttributes=e;const i=this.getObject3d(),n=new Float32Array(t.position),r=new Float32Array(n);if(i.geometry.setPositions(new Float32Array(n)),this._geometryCache.setPositions(r),this._setPickObject3d(r,i.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const ub={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class db extends zv{constructor(t,e,i,n){e=Nc.extend({},ub,e,{layer:n,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:s,topColor:o,bottomColor:a,altitude:h}=e,l=n.altitudeToVector3(r,r).x,c=n.distanceToVector3(s,s).x,u=Hx().clone();u.scale(2*c,2*c,l),o&&(Ux(u,a,o,"z",l/2),i.vertexColors=!0),this._createMesh(u,i);const d=n.altitudeToVector3(h,h).x,f=n.coordinateToVector3(t,d);this.getObject3d().position.copy(f),this.type="Box"}}const fb={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"};class pb extends(cw(zv)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=t.length,s=By(t),o=n.coordinateToVector3(s),a=[],h=[],l=[];let c=0;const u={},d={};for(let _=0;_<r;_++){const e=Nc.extend({index:_},fb,t[_]),{radius:r,altitude:s,topColor:f,bottomColor:p,height:g,coordinate:m}=e,v=Fy(r,n,u),y=jy(g,n,d),x=jy(s,n,d),w=Hx().clone();w.scale(2*v,2*v,y),f&&(Ux(w,p,f,"z",y/2),i.vertexColors=!0);const b=n.coordinateToVector3(m).sub(o),M=w.attributes.position.array;for(let t=0,i=M.length;t<i;t+=3)M[t+2]+=x,M[t]+=b.x,M[t+1]+=b.y,M[t+2]+=b.z;a.push(w);const S=new db(m,e,i,n);h.push(S),w.index.count;const C=w.attributes.position.count;//  colorCount = buffGeom.attributes.color.count,
w.attributes.normal.count,w.attributes.uv.count,l[_]={position:{count:C,start:c,end:c+3*C},// normal: {
//     count: normalCount,
//     start: normalIndex,
//     end: normalIndex + normalCount * 3,
// },
// // color: {
// //     count: colorCount,
// //     start: colorIndex,
// //     end: colorIndex + colorCount * 3,
// // },
// uv: {
//     count: uvCount,
//     start: uvIndex,
//     end: uvIndex + uvCount * 2,
// },
hide:!1},c+=3*C}super(),e=Nc.extend({},{altitude:0,layer:n,points:t},e),this._initOptions(e);const f=Gx(a);this._createMesh(f,i);const p=e.altitude,g=n.altitudeToVector3(p,p).x,m=o.clone();m.z=g,this.getObject3d().position.copy(m),// this._faceMap = faceMap;
this._baseObjects=h,this._datas=t,this._geometriesAttributes=l,this.faceIndex=null,this._geometryCache=Dx(f),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(h),this._setPickObject3d(),this._init(),this.type="Boxs"}// eslint-disable-next-line no-unused-vars
identify(t){return this.picked}}var gb={};function mb(t,e,i){i=i||2;var n,r,s,o,a,h,l,c=e&&e.length,u=c?e[0]*i:t.length,d=_b(t,0,u,i,!0),f=[];if(!d||d.next===d.prev)return f;// if the shape is not too simple, we'll use z-order curve hash later; calculate polygon bbox
if(c&&(d=// link every hole into the outer loop, producing a single-ring polygon without holes
function(t,e,i,n){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=_b(t,e[r]*n,r<s-1?e[r+1]*n:t.length,n,!1))===o.next&&(o.steiner=!0),a.push(Ab(o));// process holes from left to right
for(a.sort(Sb),r=0;r<a.length;r++)i=Cb(a[r],i);return i}(t,e,d,i)),t.length>80*i){n=s=t[0],r=o=t[1];for(var p=i;p<u;p+=i)(a=t[p])<n&&(n=a),(h=t[p+1])<r&&(r=h),a>s&&(s=a),h>o&&(o=h);// minX, minY and invSize are later used to transform coords into integers for z-order calculation
l=0!==(l=Math.max(s-n,o-r))?32767/l:0}return yb(d,f,i,n,r,l,0),f}// create a circular doubly linked list from polygon points in the specified winding order
function _b(t,e,i,n,r){var s,o;if(r===Ub(t,e,i,n)>0)for(s=e;s<i;s+=n)o=Fb(s,t[s],t[s+1],o);else for(s=i-n;s>=e;s-=n)o=Fb(s,t[s],t[s+1],o);return o&&Ob(o,o.next)&&(jb(o),o=o.next),o}// eliminate colinear or duplicate points
function vb(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!Ob(n,n.next)&&0!==Rb(n.prev,n,n.next))n=n.next;else{if(jb(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}// main ear slicing loop which triangulates a polygon (given as a linked list)
function yb(t,e,i,n,r,s,o){if(t){// interlink polygon nodes in z-order
!o&&s&&// interlink polygon nodes in z-order
function(t,e,i,n){var r=t;do{0===r.z&&(r.z=Pb(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,// Simon Tatham's linked list merge sort algorithm
// http://www.chiark.greenend.org.uk/~sgtatham/algorithms/listsort.html
function(t){var e,i,n,r,s,o,a,h,l=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,n=i,a=0,e=0;e<l&&(a++,n=n.nextZ);e++);for(h=l;a>0||h>0&&n;)0!==a&&(0===h||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,h--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=n}s.nextZ=null,l*=2}while(o>1)}// z-order of a point given coords and inverse of the longer side of data bbox
(r)}(t,n,r,s);// iterate through ears, slicing them one by one
for(var a,h,l=t;t.prev!==t.next;)if(a=t.prev,h=t.next,s?wb(t,n,r,s):xb(t))// cut off the triangle
e.push(a.i/i|0),e.push(t.i/i|0),e.push(h.i/i|0),jb(t),// skipping the next vertex leads to less sliver triangles
t=h.next,l=h.next;else// if we looped through the whole remaining polygon and can't find any more ears
if((t=h)===l){// try filtering points and slicing again
o?1===o?yb(t=bb(vb(t),e,i),e,i,n,r,s,2):2===o&&Mb(t,e,i,n,r,s):yb(vb(t),e,i,n,r,s,1);break}}}// check whether a polygon node forms a valid ear with adjacent nodes
function xb(t){var e=t.prev,i=t,n=t.next;if(Rb(e,i,n)>=0)return!1;// reflex, can't be an ear
// now make sure we don't have other points inside the potential ear
for(var r=e.x,s=i.x,o=n.x,a=e.y,h=i.y,l=n.y,c=r<s?r<o?r:o:s<o?s:o,u=a<h?a<l?a:l:h<l?h:l,d=r>s?r>o?r:o:s>o?s:o,f=a>h?a>l?a:l:h>l?h:l,p=n.next// triangle bbox; min & max are calculated like this for speed
;p!==e;){if(p.x>=c&&p.x<=d&&p.y>=u&&p.y<=f&&Eb(r,a,s,h,o,l,p.x,p.y)&&Rb(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function wb(t,e,i,n){var r=t.prev,s=t,o=t.next;if(Rb(r,s,o)>=0)return!1;// reflex, can't be an ear
// look for points inside the triangle in both directions
for(var a=r.x,h=s.x,l=o.x,c=r.y,u=s.y,d=o.y,f=a<h?a<l?a:l:h<l?h:l,p=c<u?c<d?c:d:u<d?u:d,g=a>h?a>l?a:l:h>l?h:l,m=c>u?c>d?c:d:u>d?u:d,_=Pb(f,p,e,i,n),v=Pb(g,m,e,i,n),y=t.prevZ,x=t.nextZ// triangle bbox; min & max are calculated like this for speed
;y&&y.z>=_&&x&&x.z<=v;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&Eb(a,c,h,u,l,d,y.x,y.y)&&Rb(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==r&&x!==o&&Eb(a,c,h,u,l,d,x.x,x.y)&&Rb(x.prev,x,x.next)>=0)return!1;x=x.nextZ}// look for remaining points in decreasing z-order
for(;y&&y.z>=_;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&Eb(a,c,h,u,l,d,y.x,y.y)&&Rb(y.prev,y,y.next)>=0)return!1;y=y.prevZ}// look for remaining points in increasing z-order
for(;x&&x.z<=v;){if(x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==r&&x!==o&&Eb(a,c,h,u,l,d,x.x,x.y)&&Rb(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}// go through all polygon nodes and cure small local self-intersections
function bb(t,e,i){var n=t;do{var r=n.prev,s=n.next.next;!Ob(r,s)&&Db(r,n,n.next,s)&&zb(r,s)&&zb(s,r)&&(e.push(r.i/i|0),e.push(n.i/i|0),e.push(s.i/i|0),// remove two nodes involved
jb(n),jb(n.next),n=t=s),n=n.next}while(n!==t);return vb(n)}// try splitting polygon into two and triangulate them independently
function Mb(t,e,i,n,r,s){// look for a valid diagonal that divides the polygon into two
var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Lb(o,a)){// split the polygon in two by the diagonal
var h=Nb(o,a);// filter colinear points around the cuts
return o=vb(o,o.next),h=vb(h,h.next),// run earcut on each half
yb(o,e,i,n,r,s,0),void yb(h,e,i,n,r,s,0)}a=a.next}o=o.next}while(o!==t)}function Sb(t,e){return t.x-e.x}// find a bridge between vertices that connects hole with an outer ring and and link it
function Cb(t,e){var i=// David Eberly's algorithm for finding a bridge between hole and outer polygon
function(t,e){var i,n=e,r=t.x,s=t.y,o=-1/0;// find a segment intersected by a ray from the hole's leftmost point to the left;
// segment's endpoint with lesser x will be potential connection point
do{if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){var a=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=r&&a>o&&(o=a,i=n.x<n.next.x?n:n.next,a===r))return i;// hole touches outer segment; pick leftmost endpoint
}n=n.next}while(n!==e);if(!i)return null;// look for points inside the triangle of hole point, segment intersection and endpoint;
// if there are no points found, we have a valid connection;
// otherwise choose the point of the minimum angle with the ray as connection point
var h,l=i,c=i.x,u=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=c&&r!==n.x&&Eb(s<u?r:o,s,c,u,s<u?o:r,s,n.x,n.y)&&(h=Math.abs(s-n.y)/(r-n.x),// tangential
zb(n,t)&&(h<d||h===d&&(n.x>i.x||n.x===i.x&&Tb(i,n)))&&(i=n,d=h)),n=n.next}while(n!==l);return i}// whether sector in vertex m contains sector in vertex p in the same coordinates
(t,e);if(!i)return e;var n=Nb(i,t);// filter collinear points around the cuts
return vb(n,n.next),vb(i,i.next)}function Tb(t,e){return Rb(t.prev,t,e.prev)<0&&Rb(e.next,t,t.next)<0}function Pb(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((// coords are transformed into non-negative 15-bit integer range
t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}// find the leftmost node of a polygon ring
function Ab(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}// check if a point lies within a convex triangle
function Eb(t,e,i,n,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(n-a)>=(i-o)*(e-a)&&(i-o)*(s-a)>=(r-o)*(n-a)}// check if a diagonal between two polygon nodes is valid (lies in polygon interior)
function Lb(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!// check if a polygon diagonal intersects any polygon segments
function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Db(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}// check if a polygon diagonal is locally inside the polygon
(t,e)&&(// dones't intersect other edges
zb(t,e)&&zb(e,t)&&// check if the middle point of a polygon diagonal is inside the polygon
function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}// link two polygon vertices with a bridge; if the vertices belong to the same ring, it splits polygon into two;
// if one belongs to the outer ring and another to a hole, it merges it into a single ring
(t,e)&&(// locally visible
Rb(t.prev,t,e.prev)||Rb(t,e.prev,e))||// does not create opposite-facing sectors
Ob(t,e)&&Rb(t.prev,t,t.next)>0&&Rb(e.prev,e,e.next)>0);// special zero-length case
}// signed area of a triangle
function Rb(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}// check if two points are equal
function Ob(t,e){return t.x===e.x&&t.y===e.y}// check if two segments intersect
function Db(t,e,i,n){var r=kb(Rb(t,e,i)),s=kb(Rb(t,e,n)),o=kb(Rb(i,n,t)),a=kb(Rb(i,n,e));return r!==s&&o!==a||(// general case
!(0!==r||!Ib(t,i,e))||(// p1, q1 and p2 are collinear and p2 lies on p1q1
!(0!==s||!Ib(t,n,e))||(// p1, q1 and q2 are collinear and q2 lies on p1q1
!(0!==o||!Ib(i,t,n))||!(0!==a||!Ib(i,e,n)))))}// for collinear points p, q, r, check if point q lies on segment pr
function Ib(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function kb(t){return t>0?1:t<0?-1:0}function zb(t,e){return Rb(t.prev,t,t.next)<0?Rb(t,e,t.next)>=0&&Rb(t,t.prev,e)>=0:Rb(t,e,t.prev)<0||Rb(t,t.next,e)<0}function Nb(t,e){var i=new Bb(t.i,t.x,t.y),n=new Bb(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}// create a node and optionally link it with previous one (in a circular doubly linked list)
function Fb(t,e,i,n){var r=new Bb(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function jb(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Bb(t,e,i){// vertex index in coordinates array
this.i=t,// vertex coordinates
this.x=e,this.y=i,// previous and next vertex nodes in a polygon ring
this.prev=null,this.next=null,// z-order curve value
this.z=0,// previous and next nodes in z-order
this.prevZ=null,this.nextZ=null,// indicates whether this is a steiner point
this.steiner=!1}// return a percentage difference between the polygon area and its triangulation area;
// used to verify correctness of triangulation
function Ub(t,e,i,n){for(var r=0,s=e,o=i-n;s<i;s+=n)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}// turn a polygon in a multi-dimensional array form (e.g. as in GeoJSON) into a form Earcut accepts
({get exports(){return gb},set exports(t){gb=t}}).exports=mb,gb.default=mb,mb.deviation=function(t,e,i,n){var r=e&&e.length,s=r?e[0]*i:t.length,o=Math.abs(Ub(t,0,s,i));if(r)for(var a=0,h=e.length;a<h;a++){var l=e[a]*i,c=a<h-1?e[a+1]*i:t.length;o-=Math.abs(Ub(t,l,c,i))}var u=0;for(a=0;a<n.length;a+=3){var d=n[a]*i,f=n[a+1]*i,p=n[a+2]*i;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},mb.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)i.vertices.push(t[r][s][o]);r>0&&(n+=t[r-1].length,i.holes.push(n))}return i};const Gb=Math.PI/180,Hb=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],Vb=["mouseout","mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Wb=new Gu(0,0),Zb=new Gh(0,0),qb="__webglFramebuffer";// const MATRIX4 = new THREE.Matrix4();
/**
			 * A Layer to render with THREE.JS (http://threejs.org), the most popular library for WebGL. <br>
			 *
			 * @classdesc
			 * A layer to render with THREE.JS
			 * @example
			 *  var layer = new maptalks.ThreeLayer('three');
			 *
			 *  layer.prepareToDraw = function (gl, scene, camera) {
			 *      var size = map.getSize();
			 *      return [size.width, size.height]
			 *  };
			 *
			 *  layer.draw = function (gl, view, scene, camera, width,height) {
			 *      //...
			 *  };
			 *  layer.addTo(map);
			 * @class
			 * @category layer
			 * @extends {maptalks.CanvasLayer}
			 * @param {String|Number} id - layer's id
			 * @param {Object} options - options defined in [options]{@link maptalks.ThreeLayer#options}
			 */
class Xb extends E_{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._mousedownTime=0,this._baseObjects=[],this._delayMeshes=[],this.type="ThreeLayer"}isMercator(){const t=this.getMap();if(!t)return!1;const e=t.getSpatialReference(),i=e._projection,n=e._resolutions;return!!(i&&"EPSG:3857"===i.code&&n&&n.length&&156543===Math.floor(n[0])&&t.getGLRes)}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}
/**
			     * Draw method of ThreeLayer
			     * In default, it calls renderScene, refresh the camera and the scene
			     */draw(t,e,i,n,r,s){this.renderScene(s,this)}
/**
			     * Draw method of ThreeLayer when map is interacting
			     * In default, it calls renderScene, refresh the camera and the scene
			     */drawOnInteracting(t,e,i,n,r,s,o){this.renderScene(o,this)}
/**
			     * Convert a geographic coordinate to THREE Vector3
			     * @param  {maptalks.Coordinate} coordinate - coordinate
			     * @param {Number} [z=0] z value
			     * @return {THREE.Vector3}
			     */coordinateToVector3(t,e=0,i){const n=this.getMap();if(!n)return null;const r=Array.isArray(t);r?(Wb.x=t[0],Wb.y=t[1]):t instanceof Gu||(t=new Gu(t));const s=Kb(n),o=$b(n,r?Wb:t,s,Zb);return i&&(i.x=o.x,i.y=o.y,i.z=e),new Tt(o.x,o.y,e)}coordinatiesToGLFloatArray(t,e){const i=this.getMap();if(!i)return null;const n=Kb(i),r=t.length,s=new Float32Array(2*r),o=new Float32Array(3*r);for(let a=0;a<r;a++){let r=t[a];const h=Array.isArray(r);h?(Wb.x=r[0],Wb.y=r[1]):r instanceof Gu||(r=new Gu(r));const l=$b(i,h?Wb:r,n,Zb);l.x-=e.x,l.y-=e.y;const c=2*a;s[c]=l.x,s[c+1]=l.y;const u=3*a;o[u]=l.x,o[u+1]=l.y,o[u+2]=0}return{positions:o,positons2d:s}}coordinatiesToGLArray(t,e){const i=this.getMap();if(!i)return null;const n=Kb(i),r=t.length,s=new Array(r);for(let o=0;o<r;o++){let r=t[o];const a=Array.isArray(r);a?(Wb.x=r[0],Wb.y=r[1]):r instanceof Gu||(r=new Gu(r));const h=$b(i,a?Wb:r,n,Zb);h.x-=e.x,h.y-=e.y,s[o]=[h.x,h.y]}return s}
/**
			     * Convert geographic distance to THREE Vector3
			     * @param  {Number} w - width
			     * @param  {Number} h - height
			     * @return {THREE.Vector3}
			     */distanceToVector3(t,e,i){if(0===t&&0===e||!Nc.isNumber(t)||!Nc.isNumber(e))return new Tt(0,0,0);const n=this.getMap(),r=Kb(n);let s=i||n.getCenter();s instanceof Gu||(s=new Gu(s));const o=n.locate(s,t,e),a=$b(n,s,r),h=$b(n,o,r),l=Math.abs(h.x-a.x)*Nc.sign(t),c=Math.abs(h.y-a.y)*Nc.sign(e);return new Tt(l,c,0)}altitudeToVector3(t,e,i,n){if(0===t||!Nc.isNumber(t))return new Tt(0,0,0);const r=this.getMap();if(r.altitudeToPoint){const e=Kb(r);let i=r.altitudeToPoint(t,e);return t<0&&i>0&&(i=-i),n?(n.x=i,n.y=i,n.z=0,n):new Tt(i,i,0)}return this.distanceToVector3(t,t,i)}
/**
			     * Convert a Polygon or a MultiPolygon to THREE shape
			     * @param  {maptalks.Polygon|maptalks.MultiPolygon} polygon - polygon or multipolygon
			     * @return {THREE.Shape}
			     */toShape(t){if(!t)return null;if(t instanceof Jp)return t.getGeometries().map((t=>this.toShape(t)));const e=t.getCenter(),i=this.coordinateToVector3(e),n=t.getShell().map((t=>{const e=this.coordinateToVector3(t).sub(i);return new $(e.x,e.y)})),r=new ao(n),s=t.getHoles();return s&&s.length>0&&(r.holes=s.map((t=>{const e=t.map((t=>{const e=this.coordinateToVector3(t).sub(i);return new $(e.x,e.y)}));return new ao(e)}))),r}
/**
			     * todo   This should also be extracted as a component
			     * @param {*} polygon
			     * @param {*} altitude
			     * @param {*} material
			     * @param {*} height
			     */toExtrudeMesh(t,e,n,r){if(!t)return null;if(t instanceof Jp)return t.getGeometries().map((t=>this.toExtrudeMesh(t,e,n,r)));const s=t.getCoordinates();s.forEach((t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(s);const o=this.toShape(t),a=this.coordinateToVector3(t.getCenter());r=Nc.isNumber(r)?r:e,r=this.altitudeToVector3(r,r).x;const h=this.altitudeToVector3(e,e).x,l={bevelEnabled:!1,bevelSize:1};//{ amount: extrudeH, bevelEnabled: true, bevelSegments: 2, steps: 2, bevelSize: 1, bevelThickness: 1 };
l[parseInt(i)>=93?"depth":"amount"]=r;const c=new No(o,l);let u=c;ei.prototype.fromGeometry&&(u=new ei,u.fromGeometry(c));const d=new gi(u,n);return d.position.set(a.x,a.y,h-r),d}
/**
			     *
			     * @param {maptalks.Polygon|maptalks.MultiPolygon} polygon
			     * @param {Object} options
			     * @param {THREE.Material} material
			     */toExtrudePolygon(t,e,i){return new Kx(t,e,i,this)}
/**
			     *
			     * @param {maptalks.Coordinate} coordinate
			     * @param {Object} options
			     * @param {THREE.Material} material
			     */toBar(t,e,i){return new Wx(t,e,i,this)}
/**
			    *
			    * @param {maptalks.LineString} lineString
			    * @param {Object} options
			    * @param {THREE.LineMaterial} material
			    */toLine(t,e,i){return new Xx(t,e,i,this)}
/**
			     *
			     * @param {maptalks.LineString} lineString
			     * @param {Object} options
			     * @param {THREE.Material} material
			     */toExtrudeLine(t,e,i){return new Yx(t,e,i,this)}
/**
			     *
			     * @param {THREE.Mesh|THREE.Group} model
			     * @param {Object} options
			     */toModel(t,e){return new tw(t,e,this)}
/**
			     *
			     * @param {maptalks.LineString} lineString
			     * @param {*} options
			     * @param {THREE.Material} material
			     */toExtrudeLineTrail(t,e,i){return new aw(t,e,i,this)}
/**
			     *
			     * @param {*} polygons
			     * @param {*} options
			     * @param {*} material
			     */toExtrudePolygons(t,e,i){return new fw(t,e,i,this)}
/**
			     *
			     * @param {maptalks.Coordinate} coordinate
			     * @param {*} options
			     * @param {*} material
			     */toPoint(t,e,i){return new _w(t,e,i,this)}
/**
			     *
			     * @param {Array} points
			     * @param {*} options
			     * @param {*} material
			     */toPoints(t,e,i){return new Mw(t,e,i,this)}
/**
			     *
			     * @param {Array} points
			     * @param {*} options
			     * @param {*} material
			     */toBars(t,e,i){return new Cw(t,e,i,this)}
/**
			     *
			     * @param {Array[maptalks.LineString]} lineStrings
			     * @param {*} options
			     * @param {*} material
			     */toExtrudeLines(t,e,i){return new Pw(t,e,i,this)}
/**
			     *
			     * @param {Array[maptalks.LineString]} lineStrings
			     * @param {*} options
			     * @param {*} material
			     */toLines(t,e,i){return new Ew(t,e,i,this)}
/**
			     *
			     * @param {*} url
			     * @param {*} options
			     * @param {*} getMaterial
			     * @param {*} worker
			     */toThreeVectorTileLayer(t,e,i){return new Bw(t,e,i,this)}
/**
			     *
			     * @param {*} extent
			     * @param {*} options
			     * @param {*} material
			     */toTerrain(t,e,i){return new Xw(t,e,i,this)}
/**
			     *
			     * @param {*} url
			     * @param {*} options
			     * @param {*} material
			     */toTerrainVectorTileLayer(t,e,i){return new Yw(t,e,i,this)}
/**
			     *
			     * @param {*} data
			     * @param {*} options
			     * @param {*} material
			     */toHeatMap(t,e,i){return new nb(t,e,i,this)}
/**
			     *
			     * @param {*} lineString
			     * @param {*} options
			     * @param {*} material
			     */toFatLine(t,e,i){return new hb(t,e,i,this)}
/**
			     *
			     * @param {*} lineStrings
			     * @param {*} options
			     * @param {*} material
			     */toFatLines(t,e,i){return new cb(t,e,i,this)}
/**
			     *
			     * @param {*} coorindate
			     * @param {*} options
			     * @param {*} material
			     */toBox(t,e,i){return new db(t,e,i,this)}
/**
			     *
			     * @param {*} points
			     * @param {*} options
			     * @param {*} material
			     */toBoxs(t,e,i){return new pb(t,e,i,this)}getBaseObjects(){return this.getMeshes().filter((t=>t instanceof zv))}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let i=0,n=t.children.length;i<n;i++){const n=t.children[i];n instanceof Pe&&!(n instanceof Mi)&&e.push(n.__parent||n)}return e}clear(){return this.clearMesh()}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const i=t.children[e];if(i instanceof Pe&&!(i instanceof Mi)){t.remove(i);const e=i.__parent;e&&e instanceof zv&&(e.isAdd=!1,e.options.layer=null,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[i.uuid],e._hideUI())}}return this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(t,e){const i=this._getRenderer();return i&&(i.clearCanvas(),i.renderScene(t),//redraw
e||i.setToRedraw()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const i=this.getMap();if(!i||i.isAnimating()||i.isInteracting())return;const n=this.options.loopRenderCount||50,r=e.slice(0,n);r&&this.addMesh(r,t),e.splice(0,n)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,i=t.length;e<i;e++)this._delayMeshes.push(t[e]);return this}
/**
			     * add object3ds
			     * @param {BaseObject} meshes
			     */addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const i=this.getScene();if(t.forEach((t=>{t instanceof zv?(i.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t.options.layer=this,t._fire("add",{target:t})),t._animation&&Nc.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof Pe&&i.add(t)})),this._zoomend(),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}
/**
			     * remove object3ds
			     * @param {BaseObject} meshes
			     */removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const i=this.getScene();if(t.forEach((t=>{if(t instanceof zv){i.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t.options.layer=null,t._fire("remove",{target:t}),t._hideUI()),t._animation&&Nc.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let i=0,n=e.length;i<n;i++)if(e[i]===t){e.splice(i,1);break}}else t instanceof Pe&&i.remove(t)})),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}_initRaycaster(){return this._raycaster||(this._raycaster=new ra,this._mouse=new $),this}getRaycaster(){return this._raycaster}
/**
			     *
			     * @param {Coordinate} coordinate
			     * @param {Object} options
			     * @return {Array}
			     */identify(t,e){if(!t)return[];if(Array.isArray(t)&&(t=new Gu(t)),!(t instanceof Gu))return[];const i=this.getMap().coordToContainerPoint(t);this._containerPoint=i;const{x:n,y:r}=i;this._initRaycaster(),this.fire("identify",{coordinate:t,options:e});const s=this._raycaster,o=this._mouse,a=this.getCamera(),h=this.getScene(),l=this.getMap().getSize();//fix Errors will be reported when the layer is not initialized
if(!h)return[];const c=l.width,u=l.height;o.x=n/c*2-1,o.y=-r/u*2+1,s.setFromCamera(o,a),s.layers&&s.layers.enableAll&&s.layers.enableAll(),//set linePrecision for THREE.Line
function(t,e){Cv>113?t.params.Line.threshold=e:t.linePrecision=e}(s,this._getLinePrecision(this.getMap().getResolution()));const d=[],f=[];h.children.forEach((t=>{const e=t.__parent;if(e&&e.getOptions){const i=e;i.getOptions().interactive&&i.isVisible()&&(//If baseobject has its own hit detection
i.identify&&Nc.isFunction(i.identify)?f.push(i):d.push(t))}else(t instanceof gi||t instanceof hs)&&d.push(t)}));let p=[];const g=s.intersectObjects(d,!0);g&&Array.isArray(g)&&g.length&&(p=g.map((t=>{let e=t.object;const i=t.instanceId;e=this._recursionMesh(e)||{};const n=e.__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n.intersect=t,Nc.isNumber(i)&&(n.instanceId=i),n}))),this.renderPickScene(),f.length&&f.forEach((e=>{// baseObject identify
e.identify(t)&&p.push(e)}));const m=p.length;for(let v=0;v<m;v++)if(p[v])for(let t=v+1;t<m;t++)p[v]===p[t]&&p.splice(t,1);const _=(e=Nc.extend({},e)).count;return Nc.isNumber(_)&&_>0?p.slice(0,_):p}
/**
			    * Recursively finding the root node of mesh,Until it is scene node
			    * @param {*} mesh
			    */_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}//get Line Precision by Resolution
_getLinePrecision(t=10){for(let e=0,i=Hb.length;e<i;e++){const[i,n]=Hb[e];if(t>i)return n}return.01}
/**
			     * fire baseObject events
			     * @param {*} e
			     */_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();//When map interaction, do not carry out mouse movement detection, which can have better performance
if(e.isInteracting()||!e.options.geometryEvents||e._ignoreEvent(t))return this;const i=t.type,n=e._getEventParams?e._getEventParams(t):this._getEventParams(t);n.type=i;const{type:r,coordinate:s}=n,o=Nc.now();if(this._mousemoveTimeOut&&"mousemove"===r&&o-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=o,// record mousedown/touchstart time
"mousedown"!==r&&"touchstart"!==r||(this._mousedownTime=Nc.now());let a=!1;if("click"===r||"touchend"===r){const t=e.options.clickTimeThreshold||280;a=Nc.now()-this._mousedownTime<t}//ignore click event
if("click"===r&&!a)return this;// map.resetCursor('default');
const h=this.options.identifyCountOnEvent;let l=Math.max(0,Nc.isNumber(h)?h:0);0===l&&(l=1/0);const c=t=>{const e=[];this._baseObjects&&this._baseObjects.forEach((i=>{let n=!0;t.forEach((t=>{i===t&&(n=!1)})),n&&e.push(i)})),e.forEach((t=>{t&&t instanceof zv&&(// reset _mouseover status
// Deal with the mergedmesh
t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout"})),t.closeToolTip()))}))};if("mouseout"===r)return c([]),this._baseObjects=[],this;const u=this.identify(s,{count:l}),d=this.getScene();if(0===u.length&&d)for(let p=0,g=d.children.length;p<g;p++){const t=(d.children[p]||{}).__parent;t&&t.fire("empty",Object.assign({},n,{target:t}))}function f(t,e){e=e||r;const i=t.getInfoWindow();i&&!i._owner&&i.addTo(t);((i?i.options:{}).autoOpenOn||"click")===e&&(t.openInfoWindow(s),t.fire("showinfowindow",{infoWindow:i}))}//simulation mouse click on mobile device
if("mousemove"===r?(// if (baseObjects.length) {
//     map.setCursor('pointer');
// }
// mouseout objects
c(u),u.forEach((t=>{if(t instanceof zv){t._mouseover||(t.fire("mouseover",Object.assign({},n,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,f(t,"mouseover")),t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));// tooltip
const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(s),f(t)}})),this._baseObjects=u):u.forEach((t=>{t instanceof zv&&(t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),f(t))})),"touchend"===r&&a){const e=Nc.extend({},n,{domEvent:t});u.forEach((t=>{t instanceof zv&&(t.fire("click",Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),f(t,"click"))}))}return this}_getEventParams(t){const e=this.getMap(),i={domEvent:t};if(!e)return i;const n=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(n){const t=(0,fu.getEventContainerPoint)(n,e._containerDOM);i.coordinate=e.containerPointToCoordinate(t),i.containerPoint=t,i.viewPoint=e.containerPointToViewPoint(t),i.pont2d=e._containerPointToPoint(t)}return i}
/**
			     *map zoom event
			     */_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach((t=>{const i=t.__parent;if(i&&i.getOptions){const t=i;t.zoomChange&&Nc.isFunction(t.zoomChange)&&t.zoomChange(e);const n=t.getMinZoom(),r=t.getMaxZoom();e<n||e>r?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):n<=e&&e<=r&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}}))}_getGeometryEventMapPanel(){const t=this.map||this.getMap();return t._panels.allLayers||t._containerDOM}onAdd(){super.onAdd();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return this._identifyBaseObjectEventsThis||(this._identifyBaseObjectEventsThis=this._identifyBaseObjectEvents.bind(this)),this._zoomendThis||(this._zoomendThis=this._zoomend.bind(this)),fu.on(e,Vb.join(" "),this._identifyBaseObjectEventsThis,this),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomendThis,this),this}onRemove(){super.onRemove();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return fu.off(e,Vb.join(" "),this._identifyBaseObjectEventsThis,this),t.off("zooming zoomend",this._zoomendThis,this),this.clear(),this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}
/**
			     * To make map's 2d point's 1 pixel euqal with 1 pixel on XY plane in THREE's scene:
			     * 1. fov is 90 and camera's z is height / 2 * scale,
			     * 2. if fov is not 90, a ratio is caculated to transfer z to the equivalent when fov is 90
			     * @return {Number} fov ratio on z axis
			     */_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*Gb)}}Xb.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});const Jb={bloom:!0};class Yb extends vv.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0,this._renderTarget=null}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments);// this.renderScene();
}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new ie;const t=new gs({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new pt(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),// renderer.canvas = this.canvas;
this.context=t;const e=this.scene=new ms,i=this.layer.getMap(),n=i.getFov()*Math.PI/180,r=this.camera=new Si(n,i.width/i.height,i.cameraNear,i.cameraFar);r.matrixAutoUpdate=!1,this._syncCamera(),e.add(r),this.pick=new ob(this.layer),Ax.star()}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,i=this.getMap();e=t||i.getSize();// const r = maptalks.Browser.retina ? 2 : 1;
const n=i.getDevicePixelRatio?i.getDevicePixelRatio():zh.retina?2:1,r=this.canvas,{width:s,height:o,cssWidth:a,cssHeight:h}=Nc.calCanvasSize(e,n);if(!this.layer._canvas||r.style.width===a&&r.style.height===h||(r.style.width=a,r.style.height=h),r.width===s&&r.height===o)return this;//retina support
r.width=s,r.height=o,this.context.setSize(r.width,r.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(t){//  WebglRenderTarget  framebuffer  GroupGLLayer  fbo
// : https://stackoverflow.com/questions/55082573/use-webgl-texture-as-a-three-js-texture-map
//  hacky three  
if(// const time = maptalks.Util.now();
// Make sure to execute only once in a frame
// if (time - this._renderTime >= 16) {
//     this.layer._callbackBaseObjectAnimation();
//     this._renderTime = time;
// }
this.layer._callbackBaseObjectAnimation(),this._syncCamera(),t&&t.renderTarget){const{width:e,height:i}=t.renderTarget.fbo;this._renderTarget?(// setSizesetSizefbo dipose
// this._renderTarget.setSize(width, height);
this._renderTarget.viewport.set(0,0,e,i),this._renderTarget.scissor.set(0,0,e,i)):(this._renderTarget=new bt(e,i,{// depthTexture: new THREE.DepthTexture(width, height, THREE.UnsignedInt248Type)
depthBuffer:!1}),//  framebuffer 
this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));const n=this.context.properties.get(this._renderTarget),r=n[qb];// GroupGLLayerwebgl fboWebglRenderTargetfbo
n[qb]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget);const s=1===t.bloom&&t.sceneFilter,o=this.scene.children||[];//bloom
let a=!1;if(s){const e=t.sceneFilter;// test bloom
a=e(Jb);for(let t=0,i=o.length;t<i;t++){if(!o[t]||!o[t].layers)continue;const i=o[t].__parent;o[t].bloom=!1,//ojbect3dbloom
i&&(o[t].bloom=i.bloom);let n=0;//object3dparent(baseobject)
//sceneFilter meshes
(o[t]&&e(o[t])||!i)&&a&&(n=1),// object3ds[i].layers.set(layer);
o[t].__layer!==n&&(Qb(o[t],n),o[t].__layer=n)}}else//reset all object3ds layers
for(let t=0,h=o.length;t<h;t++)o[t]&&o[t].layers&&0!==o[t].__layer&&(Qb(o[t],0),o[t].__layer=0);// object3ds[i].layers.set(0);
this.camera.layers.set(a?1:0),this.context.render(this.scene,this.camera),n[qb]=r}else this.context.render(this.scene,this.camera);this.context.setRenderTarget(null),this.completeRender()}remove(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,//https://github.com/mrdoob/three.js/commit/d52afdd2ceafd690ac9e20917d0c968ff2fa7661
this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse&&(e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements)}_createGLContext(t,e){const i=["webgl2","webgl","experimental-webgl"];let n=null;/* eslint-disable no-empty */for(let r=0;r<i.length;++r){try{n=t.getContext(i[r],e)}catch(rM){}if(n)break}return n;/* eslint-enable no-empty */}}function Qb(t,e){if(!t)return;t.layers&&t.layers.set(e);const i=t.children;if(i&&i.length)for(let n=0,r=i.length;n<r;n++)Qb(i[n],e)}function Kb(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function $b(t,e,i,n){return t.coordToPointAtRes?t.coordToPointAtRes(e,i,n):t.coordinateToPoint(e,i,n)}function tM(t){// layer animation support Skipping frames
t._needsUpdate&&t.redraw(),// stats.update()
requestAnimationFrame(tM)}/*  ShaderMaterial */Xb.registerRenderer("gl",Yb),Cd&&(Cd("__maptalks.three__",'(function(n){"use strict";\n/*!\n   * poly-extrude v0.1.0\n    */var t={exports:{}};function r(n,t,r){r=r||2;var i,o,u,v,s,l,x,c=t&&t.length,d=c?t[0]*r:n.length,g=e(n,0,d,r,!0),y=[];if(!g||g.next===g.prev)return y;if(c&&(g=function(n,t,r,i){var a,o,u,v=[];for(a=0,o=t.length;a<o;a++)(u=e(n,t[a]*i,a<o-1?t[a+1]*i:n.length,i,!1))===u.next&&(u.steiner=!0),v.push(p(u));for(v.sort(h),a=0;a<v.length;a++)r=f(v[a],r);return r}(n,t,g,r)),n.length>80*r){i=u=n[0],o=v=n[1];for(var m=r;m<d;m+=r)(s=n[m])<i&&(i=s),(l=n[m+1])<o&&(o=l),s>u&&(u=s),l>v&&(v=l);x=0!==(x=Math.max(u-i,v-o))?32767/x:0}return a(g,y,r,i,o,x,0),y}function e(n,t,r,e,i){var a,o;if(i===z(n,t,r,e)>0)for(a=t;a<r;a+=e)o=Z(a,n[a],n[a+1],o);else for(a=r-e;a>=t;a-=e)o=Z(a,n[a],n[a+1],o);return o&&y(o,o.next)&&(F(o),o=o.next),o}function i(n,t){if(!n)return n;t||(t=n);var r,e=n;do{if(r=!1,e.steiner||!y(e,e.next)&&0!==g(e.prev,e,e.next))e=e.next;else{if(F(e),(e=t=e.prev)===e.next)break;r=!0}}while(r||e!==t);return t}function a(n,t,r,e,h,f,l){if(n){!l&&f&&function(n,t,r,e){var i=n;do{0===i.z&&(i.z=x(i.x,i.y,t,r,e)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==n);i.prevZ.nextZ=null,i.prevZ=null,function(n){var t,r,e,i,a,o,u,v,s=1;do{for(r=n,n=null,a=null,o=0;r;){for(o++,e=r,u=0,t=0;t<s&&(u++,e=e.nextZ);t++);for(v=s;u>0||v>0&&e;)0!==u&&(0===v||!e||r.z<=e.z)?(i=r,r=r.nextZ,u--):(i=e,e=e.nextZ,v--),a?a.nextZ=i:n=i,i.prevZ=a,a=i;r=e}a.nextZ=null,s*=2}while(o>1)}(i)}(n,e,h,f);for(var p,c,d=n;n.prev!==n.next;)if(p=n.prev,c=n.next,f?u(n,e,h,f):o(n))t.push(p.i/r|0),t.push(n.i/r|0),t.push(c.i/r|0),F(n),n=c.next,d=c.next;else if((n=c)===d){l?1===l?a(n=v(i(n),t,r),t,r,e,h,f,2):2===l&&s(n,t,r,e,h,f):a(i(n),t,r,e,h,f,1);break}}}function o(n){var t=n.prev,r=n,e=n.next;if(g(t,r,e)>=0)return!1;for(var i=t.x,a=r.x,o=e.x,u=t.y,v=r.y,s=e.y,h=i<a?i<o?i:o:a<o?a:o,f=u<v?u<s?u:s:v<s?v:s,l=i>a?i>o?i:o:a>o?a:o,x=u>v?u>s?u:s:v>s?v:s,p=e.next;p!==t;){if(p.x>=h&&p.x<=l&&p.y>=f&&p.y<=x&&c(i,u,a,v,o,s,p.x,p.y)&&g(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function u(n,t,r,e){var i=n.prev,a=n,o=n.next;if(g(i,a,o)>=0)return!1;for(var u=i.x,v=a.x,s=o.x,h=i.y,f=a.y,l=o.y,p=u<v?u<s?u:s:v<s?v:s,d=h<f?h<l?h:l:f<l?f:l,y=u>v?u>s?u:s:v>s?v:s,m=h>f?h>l?h:l:f>l?f:l,w=x(p,d,t,r,e),M=x(y,m,t,r,e),b=n.prevZ,A=n.nextZ;b&&b.z>=w&&A&&A.z<=M;){if(b.x>=p&&b.x<=y&&b.y>=d&&b.y<=m&&b!==i&&b!==o&&c(u,h,v,f,s,l,b.x,b.y)&&g(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,A.x>=p&&A.x<=y&&A.y>=d&&A.y<=m&&A!==i&&A!==o&&c(u,h,v,f,s,l,A.x,A.y)&&g(A.prev,A,A.next)>=0)return!1;A=A.nextZ}for(;b&&b.z>=w;){if(b.x>=p&&b.x<=y&&b.y>=d&&b.y<=m&&b!==i&&b!==o&&c(u,h,v,f,s,l,b.x,b.y)&&g(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;A&&A.z<=M;){if(A.x>=p&&A.x<=y&&A.y>=d&&A.y<=m&&A!==i&&A!==o&&c(u,h,v,f,s,l,A.x,A.y)&&g(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function v(n,t,r){var e=n;do{var a=e.prev,o=e.next.next;!y(a,o)&&m(a,e,e.next,o)&&b(a,o)&&b(o,a)&&(t.push(a.i/r|0),t.push(e.i/r|0),t.push(o.i/r|0),F(e),F(e.next),e=n=o),e=e.next}while(e!==n);return i(e)}function s(n,t,r,e,o,u){var v=n;do{for(var s=v.next.next;s!==v.prev;){if(v.i!==s.i&&d(v,s)){var h=A(v,s);return v=i(v,v.next),h=i(h,h.next),a(v,t,r,e,o,u,0),void a(h,t,r,e,o,u,0)}s=s.next}v=v.next}while(v!==n)}function h(n,t){return n.x-t.x}function f(n,t){var r=function(n,t){var r,e=t,i=n.x,a=n.y,o=-1/0;do{if(a<=e.y&&a>=e.next.y&&e.next.y!==e.y){var u=e.x+(a-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(u<=i&&u>o&&(o=u,r=e.x<e.next.x?e:e.next,u===i))return r}e=e.next}while(e!==t);if(!r)return null;var v,s=r,h=r.x,f=r.y,x=1/0;e=r;do{i>=e.x&&e.x>=h&&i!==e.x&&c(a<f?i:o,a,h,f,a<f?o:i,a,e.x,e.y)&&(v=Math.abs(a-e.y)/(i-e.x),b(e,n)&&(v<x||v===x&&(e.x>r.x||e.x===r.x&&l(r,e)))&&(r=e,x=v)),e=e.next}while(e!==s);return r}(n,t);if(!r)return t;var e=A(r,n);return i(e,e.next),i(r,r.next)}function l(n,t){return g(n.prev,n,t.prev)<0&&g(t.next,n,n.next)<0}function x(n,t,r,e,i){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*i|0)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-e)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(n){var t=n,r=n;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==n);return r}function c(n,t,r,e,i,a,o,u){return(i-o)*(t-u)>=(n-o)*(a-u)&&(n-o)*(e-u)>=(r-o)*(t-u)&&(r-o)*(a-u)>=(i-o)*(e-u)}function d(n,t){return n.next.i!==t.i&&n.prev.i!==t.i&&!function(n,t){var r=n;do{if(r.i!==n.i&&r.next.i!==n.i&&r.i!==t.i&&r.next.i!==t.i&&m(r,r.next,n,t))return!0;r=r.next}while(r!==n);return!1}(n,t)&&(b(n,t)&&b(t,n)&&function(n,t){var r=n,e=!1,i=(n.x+t.x)/2,a=(n.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&i<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(e=!e),r=r.next}while(r!==n);return e}(n,t)&&(g(n.prev,n,t.prev)||g(n,t.prev,t))||y(n,t)&&g(n.prev,n,n.next)>0&&g(t.prev,t,t.next)>0)}function g(n,t,r){return(t.y-n.y)*(r.x-t.x)-(t.x-n.x)*(r.y-t.y)}function y(n,t){return n.x===t.x&&n.y===t.y}function m(n,t,r,e){var i=M(g(n,t,r)),a=M(g(n,t,e)),o=M(g(r,e,n)),u=M(g(r,e,t));return i!==a&&o!==u||(!(0!==i||!w(n,r,t))||(!(0!==a||!w(n,e,t))||(!(0!==o||!w(r,n,e))||!(0!==u||!w(r,t,e)))))}function w(n,t,r){return t.x<=Math.max(n.x,r.x)&&t.x>=Math.min(n.x,r.x)&&t.y<=Math.max(n.y,r.y)&&t.y>=Math.min(n.y,r.y)}function M(n){return n>0?1:n<0?-1:0}function b(n,t){return g(n.prev,n,n.next)<0?g(n,t,n.next)>=0&&g(n,n.prev,t)>=0:g(n,t,n.prev)<0||g(n,n.next,t)<0}function A(n,t){var r=new P(n.i,n.x,n.y),e=new P(t.i,t.x,t.y),i=n.next,a=t.prev;return n.next=t,t.prev=n,r.next=i,i.prev=r,e.next=r,r.prev=e,a.next=e,e.prev=a,e}function Z(n,t,r,e){var i=new P(n,t,r);return e?(i.next=e.next,i.prev=e,e.next.prev=i,e.next=i):(i.prev=i,i.next=i),i}function F(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function P(n,t,r){this.i=n,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function z(n,t,r,e){for(var i=0,a=t,o=r-e;a<r;a+=e)i+=(n[o]-n[a])*(n[a+1]+n[o+1]),o=a;return i}t.exports=r,t.exports.default=r,r.deviation=function(n,t,r,e){var i=t&&t.length,a=i?t[0]*r:n.length,o=Math.abs(z(n,0,a,r));if(i)for(var u=0,v=t.length;u<v;u++){var s=t[u]*r,h=u<v-1?t[u+1]*r:n.length;o-=Math.abs(z(n,s,h,r))}var f=0;for(u=0;u<e.length;u+=3){var l=e[u]*r,x=e[u+1]*r,p=e[u+2]*r;f+=Math.abs((n[l]-n[p])*(n[x+1]-n[l+1])-(n[l]-n[x])*(n[p+1]-n[l+1]))}return 0===o&&0===f?0:Math.abs((f-o)/o)},r.flatten=function(n){for(var t=n[0][0].length,r={vertices:[],holes:[],dimensions:t},e=0,i=0;i<n.length;i++){for(var a=0;a<n[i].length;a++)for(var o=0;o<t;o++)r.vertices.push(n[i][a][o]);i>0&&(e+=n[i-1].length,r.holes.push(e))}return r};var I=t.exports;function E(n){for(var t,r,e=0,i=1,a=n.length;i<a;)t=r||n[0],e+=((r=n[i])[0]-t[0])*(r[1]+t[1]),i++;return e>0}function L(n,t,r){return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],n}function H(n,t){var r=t[0],e=t[1],i=t[2],a=Math.sqrt(r*r+e*e+i*i)||1;return n[0]=r/a,n[1]=e/a,n[2]=i/a,n}function U(n,t){function r(n,t,r,e){n[0]=t,n[1]=r,n[2]=e}for(var e,i,a,o,u,v,s,h,f,l=[],x=[],p=[],c=[],d=[],g=[],y=n.length,m=new Float32Array(t.length),w=0;w<y;){var M=3*n[w],b=3*n[w+1],A=3*n[w+2];r(l,t[M],t[M+1],t[M+2]),r(x,t[b],t[b+1],t[b+2]),r(p,t[A],t[A+1],t[A+2]),L(d,p,x),L(c,l,x),e=g,a=c,o=void 0,u=void 0,v=void 0,s=void 0,h=void 0,f=void 0,o=(i=d)[0],u=i[1],v=i[2],s=a[0],h=a[1],f=a[2],e[0]=u*f-v*h,e[1]=v*s-o*f,e[2]=o*h-u*s;for(var Z=0;Z<3;Z++)m[M+Z]+=g[Z],m[b+Z]+=g[Z],m[A+Z]+=g[Z];w+=3}for(var F=0,P=m.length;F<P;)r(g,m[F],m[F+1],m[F+2]),H(g,g),m[F]=g[0]||0,m[F+1]=g[1]||0,m[F+2]=g[2]||0,F+=3;return m}function j(n){if(1===n.length)return{position:n[0].position,normal:n[0].normal,uv:n[0].uv,indices:n[0].indices,results:n};for(var t=0,r=0,e=0,i=n.length;e<i;e++){var a=n[e],o=a.position,u=a.indices;t+=o.length,r+=u.length}for(var v={position:new Float32Array(t),normal:new Float32Array(t),uv:new Float32Array(t/3*2),indices:new Uint32Array(r),results:n},s=0,h=0,f=0,l=0,x=0,p=n.length;x<p;x++){var c=n[x],d=c.position,g=c.indices,y=c.normal,m=c.uv;v.position.set(d,s),v.normal.set(y,s),v.uv.set(m,l);for(var w=0,M=g.length;w<M;){var b=g[w]+h;v.indices[f]=b,f++,w++}l+=m.length,s+=d.length,h+=d.length/3}return v}function O(n){return 180*n/Math.PI}function S(n){return n/180*Math.PI}function W(n,t,r,e,i,a){var o=3*r,u=3*e,v=3*i,s=3*a,h=t[o],f=t[o+1],l=t[o+2],x=t[u],p=t[u+1],c=t[u+2],d=t[v],g=t[v+1],y=t[v+2],m=t[s],w=t[s+1],M=t[s+2];Math.abs(f-p)<Math.abs(h-x)?(n.push(h,1-l),n.push(x,1-c),n.push(d,1-y),n.push(m,1-M)):(n.push(f,1-l),n.push(p,1-c),n.push(g,1-y),n.push(w,1-M))}function k(n,t){t=Object.assign({},{depth:2},t);var r=n.map((function(n){for(var r=0,e=n.length;r<e;r++){var i=n[r];B(i),0===r?E(i)||(n[r]=i.reverse()):E(i)&&(n[r]=i.reverse()),V(i)&&i.splice(i.length-1,1)}var a=function(n,t){for(var r=function(n){var t=0,r=0,e=n.length;for(;r<e;)t+=n[r].length,r++;return t}(n),e=n.length,i=[],a=new Float32Array(2*r),o=[],u=[],v=3*r,s=2*r,h=t.depth,f=0,l=0,x=0,p=0;p<e;p++){var c=n[p];p>0&&i.push(f/2);for(var d=0,g=c.length;d<g;){var y=c[d],m=y[0],w=y[1];a[f++]=m,a[f++]=w,o[l]=m,o[l+1]=w,o[l+2]=h,o[v+l]=m,o[v+l+1]=w,o[v+l+2]=0,u[x]=m,u[x+1]=w,u[s+x]=m,u[s+x+1]=w,l+=3,x+=2,d++}}return{flatVertices:a,holes:i,points:o,count:r,uvs:u}}(n,t);return a.polygon=n,function(n,t){for(var r=[],e=n.count,i=0,a=t.length;i<a;i+=3){var o=t[i],u=t[i+1],v=t[i+2];r[i]=o,r[i+1]=u,r[i+2]=v;var s=a+i,h=e+o,f=e+u,l=e+v;r[s]=h,r[s+1]=f,r[s+2]=l}n.index=r}(a,I(a.flatVertices,a.holes,2)),function(n,t){for(var r=n.points,e=n.index,i=n.polygon,a=n.uvs,o=t.depth,u=0,v=i.length;u<v;u++)for(var s=i[u],h=0,f=s.length;h<f;){var l=s[h],x=s[h+1];h===f-1&&(x=s[0]);var p=r.length/3,c=l[0],d=l[1],g=x[0],y=x[1];r.push(c,d,o,g,y,o,c,d,0,g,y,0);var m=p+2,w=p+3,M=p,b=p+1;e.push(m,M,w,M,b,w),W(a,r,m,w,M,b),h++}}(a,t),a.position=new Float32Array(a.points),a.indices=new Uint32Array(a.index),a.uv=new Float32Array(a.uvs),a.normal=U(a.indices,a.position),a})),e=j(r);return e.polygons=n,e}function B(n){V(n)||n.push(n[0])}function V(n){var t=n.length,r=n[0],e=r[0],i=r[1],a=n[t-1],o=a[0],u=a[1];return e===o&&i===u}function _(n,t){t=Object.assign({},{depth:2,lineWidth:1},t);var r=n.map((function(n){var r=function(n,t){var r=0,e=t.lineWidth/2,i=[],a=[],o=[],u=n.length,v=0;for(;v<u-1;){var s=n[v],h=n[v+1],f=h[1]-s[1],l=h[0]-s[0],x=0,p=O(Math.atan(f/l));if(r=p,0===v)x=p,x-=90;else{var c=n[v-1];q.x=c[0]-s[0],q.y=c[1]-s[1],R.x=h[0]-s[0],R.y=h[1]-s[1],x=p-D(q,R)/2}var d=C(S(x),e,s),g=d[0],y=d[1];i.push(g,y),G(g,s,h)?(a.push(g),o.push(y)):(a.push(y),o.push(g)),v++}var m=r,w=S(m-=90),M=n[u-2],b=n[u-1],A=C(w,e,b),Z=A[0],F=A[1];i.push(Z,F),G(Z,M,b)?(a.push(Z),o.push(F)):(a.push(F),o.push(Z));return{offsetPoints:i,leftPoints:a,rightPoints:o}}(n,t);return r.line=n,function(n,t){var r=t.depth,e=[],i=[],a=[],o=n.leftPoints,u=n.rightPoints,v=0,s=o.length;for(;v<s;){var h=3*v,f=o[v],l=f[0],x=f[1];e[h]=l,e[h+1]=x,e[h+2]=r;var p=u[v],c=p[0],d=p[1],g=3*s+h;e[g]=c,e[g+1]=d,e[g+2]=r;var y=2*s*3+h;e[y]=l,e[y+1]=x,e[y+2]=0;var m=2*s*3+3*s+h;e[m]=c,e[m+1]=d,e[m+2]=0,v++}v=0,s=e.length;for(;v<s;){var w=e[v],M=e[v+1];a.push(w,M),v+=3}v=0,s=o.length;for(;v<s-1;){var b=v,A=v+1,Z=b+s,F=A+s;i.push(b,Z,A),i.push(Z,F,A);var P=v+2*s,z=P+1,I=P+s,E=z+s;i.push(P,I,z),i.push(I,E,z),v++}n.index=i,n.points=e,n.uvs=a}(r,t),function(n,t){var r=n.points,e=n.index,i=n.leftPoints,a=n.rightPoints,o=n.uvs,u=t.depth,v=[i,a];function s(n,t){var i=r.length/3;r.push(n[0],n[1],u,t[0],t[1],u,n[0],n[1],0,t[0],t[1],0);var a=i+2,v=i+3,s=i,h=i+1;e.push(a,s,v,s,h,v),W(o,r,a,v,s,h)}for(var h=0,f=v.length;h<f;h++){var l=v[h];h>0&&(l=(l=l.map((function(n){return n}))).reverse());for(var x=0,p=l.length-1;x<p;){s(l[x],l[x+1]),x++}}for(var c=i.length,d=[a[0],i[0],i[c-1],a[c-1]],g=0;g<d.length;g+=2){s(d[g],d[g+1])}}(r,t),r.position=new Float32Array(r.points),r.indices=new Uint32Array(r.index),r.uv=new Float32Array(r.uvs),r.normal=U(r.indices,r.position),r})),e=j(r);return e.lines=n,e}var q={x:0,y:0},R={x:0,y:0};function C(n,t,r){var e=r[0],i=r[1],a=[e+Math.cos(n)*t,i+Math.sin(n)*t],o=n+=Math.PI;return[a,[e+Math.cos(o)*t,i+Math.sin(o)*t]]}var D=function(n,t){var r=n.x,e=n.y,i=t.x,a=t.y,o=r*i+e*a,u=r*a-e*i;return(Math.atan2(u,o)/Math.PI*180+360)%360};function G(n,t,r){var e=t[0],i=t[1],a=r[0],o=r[1];return(i-o)*n[0]+(a-e)*n[1]+e*o-a*i>0}function J(n,t){void 0===t&&(t={}),t=Object.assign({},{radius:1,height:2,radialSegments:6},t);for(var r=Math.round(Math.max(4,t.radialSegments)),e=t,i=e.radius,a=e.height,o=360/r/360*Math.PI*2,u=r+1,v=new Float32Array(3*u*2),s=n[0],h=n[1],f=0,l=0,x=3*u,p=2*u,c=[],d=[],g=-1;g<r;g++){var y=o*g,m=Math.cos(y)*i+s,w=Math.sin(y)*i+h;v[f]=m,v[f+1]=w,v[f+2]=0,v[f+x]=m,v[f+1+x]=w,v[f+2+x]=a;var M,b;M=.5+m/i/2,b=.5+w/i/2,d[l]=M,d[l+1]=b,d[l+p]=M,d[l+1+p]=b,f+=3,l+=2,g>1&&c.push(0,g-1,g)}v[f-=3]=v[0],v[f+1]=v[1],v[f+2]=v[2];var A=v.length;v[A-3]=v[0],v[A-2]=v[1],v[A-1]=a;for(var Z=c.length,F=0;F<Z;F++){var P=c[F];c.push(P+u)}var z=new Float32Array(2*(3*u*2-6)),I=-1;f=2*u,l=0;for(var E=0,L=v.length/2;E<L-3;E+=3){var H=v[E],j=v[E+1],O=v[E+3],S=v[E+4];z[++I]=H,z[++I]=j,z[++I]=a,z[++I]=O,z[++I]=S,z[++I]=a,z[++I]=H,z[++I]=j,z[++I]=0,z[++I]=O,z[++I]=S,z[++I]=0;var W=f+2,k=f+3,B=f,V=f+1;c.push(B,W,V,W,k,V),f+=4;var _=l/u,q=(l+1)/u;d.push(_,a/i/2,q,a/i/2,_,0,q,0),l++}var R=new Float32Array(v.length+z.length);R.set(v,0),R.set(z,v.length);var C=U(c,R);return{points:v,indices:new Uint32Array(c),position:R,normal:C,uv:new Float32Array(d)}}var K={x:0,y:0},N={x:0,y:0};function Q(n,t,r,e){for(var i=n.length,a=0;a<i;a++){var o=n[a].data;t=n[a].center||t;for(var u=0,v=o.length;u<v;u++)for(var s=o[u],h=0,f=s.length;h<f;h++)n[a].data[u][h]=T(s[h],t,r,e)}}function T(n,t,r,e){for(var i,a=[],o=0,u=(i=r?new Float64Array(n):new Float32Array(n)).length;o<u;o+=2){var v=i[o],s=i[o+1];if(t&&r&&e){K.x=v,K.y=s;var h=un(K,N);K.x=h.x,K.y=h.y,v=(h=vn(e,K,r,N)).x,s=h.y,v-=t[0],s-=t[1]}a.push([v,s])}return a}function X(n,t){void 0===t&&(t=!1);for(var r=n.length,e=[],i=[],a=0,o=0;o<r;o++){var u=t?$(n[o]):Y(n[o]),v=n[o].bottomHeight||0,s=u.position;i.push(u);var h=s.length/3;e[o]={position:{middleZ:v+(n[o].height||0)/2,count:h,start:a,end:a+3*h},hide:!1},a+=3*h}var f=tn(i),l=f.position,x=f.normal,p=f.uv,c=f.indices;return{position:l.buffer,normal:x.buffer,uv:p.buffer,indices:c.buffer,geometriesAttributes:e}}function Y(n){var t=n.data,r=n.height,e=n.bottomHeight,i=k(t,{depth:r}),a=i.position,o=i.normal,u=i.uv,v=i.indices;return rn(a,e),{position:a,normal:o,uv:u,indices:v}}function $(n){var t=n.data,r=n.height,e=n.width,i=n.bottomHeight,a=_(t,{lineWidth:e,depth:r}),o=a.position,u=a.normal,v=a.uv,s=a.indices;return rn(o,i),{position:o,normal:u,uv:v,indices:s}}function nn(n,t){for(var r=new Float32Array(t),e=0,i=0;i<n.length;++i)r.set(n[i],e),e+=n[i].length;return r}function tn(n){for(var t={},r={},e=0;e<n.length;++e){var i=n[e];for(var a in i)void 0===t[a]&&(t[a]=[],r[a]=0),t[a].push(i[a]),r[a]+=i[a].length}var o={},u=0,v=[];for(var s in t)if("indices"===s)for(var h=t[s],f=0,l=h.length;f<l;f++){for(var x=h[f],p=0,c=x.length;p<c;p++)v.push(x[p]+u);u+=t.position[f].length/3}else{var d=nn(t[s],r[s]);if(!d)return null;o[s]=d}return o.indices=new Uint32Array(v),o}function rn(n,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var r=0,e=n.length;r<e;r+=3)n[r+2]+=t}function en(n){for(var t=[],r=0,e=n.length;r<e;r+=7){var i=n[r],a=n[r+1],o=n[r+2],u=n[r+3],v=n[r+4],s=n[r+5];t.push({radialSegments:o,radius:u,height:v,altitude:s,center:[i,a]})}for(var h=t.length,f=[],l=[],x=0,p=0;p<h;p++){var c=J(t[p].center||[0,0],t[p]),d=c.position;if(t[p].altitude)for(var g=t[p].altitude,y=0,m=d.length;y<m;y+=3)c[y+2]+=g;l.push(c);var w=d.length/3;f[p]={position:{middleZ:t[p].height/2,count:w,start:x,end:x+3*w},hide:!1},x+=3*w}var M=tn(l),b=M.position,A=M.normal,Z=M.uv,F=M.indices;return{position:b.buffer,normal:A.buffer,uv:Z.buffer,indices:F.buffer,geometriesAttributes:f}}var an=Math.PI/180,on=6378137*Math.PI/180;function un(n,t){var r,e=85.0511287798,i=n.x,a=Math.max(Math.min(e,n.y),-e);r=0===a?0:Math.log(Math.tan((90+a)*an/2))/an;var o=i*on,u=r*on;return t?(t.x=o,t.y=u,t):{x:o,y:u}}function vn(n,t,r,e){var i=n[0]*(t.x-n[2])/r,a=-n[1]*(t.y-n[3])/r;return e?(e.x=i,e.y=a,e):{x:i,y:a}}function sn(n){void 0===n&&(n=[]);for(var t=n.length,r=new Float32Array(3*t),e=0;e<t;e++){var i=n[e],a=3*e;r[a]=i[0],r[a+1]=i[1]}return r}function hn(n){for(var t=new Float32Array(2*n.length-6),r=0,e=0,i=n.length/3;e<i;e++){var a=n[3*e],o=n[3*e+1],u=n[3*e+2];if(e>0&&e<i-1){var v=3*r;t[v]=a,t[v+1]=o,t[v+2]=u,r++}var s=3*r;t[s]=a,t[s+1]=o,t[s+2]=u,r++}return t}function fn(n){var t=0,r=n.length;if(1===r)return n[0];for(var e=0;e<r;e++)t+=n[e].length;for(var i=new Float32Array(t),a=0,o=0;o<r;o++)i.set(n[o],a),a+=n[o].length;return i}n.initialize=function(){},n.onmessage=function(n,t){var r=n.data,e=r.type,i=r.datas,a=r.glRes,o=r.matrix,u=r.center;if("ExtrudePolygons"===e){Q(i,u,a,o);var v=X(i);t(null,v,[v.position,v.normal,v.uv,v.indices])}else if("ExtrudeLines"===e){for(var s=0,h=i.length;s<h;s++)for(var f=0,l=i[s].data.length;f<l;f++)i[s].data[f]=T(i[s].data[f],i[s].center||u,a,o);var x=X(i,!0);t(null,x,[x.position,x.normal,x.uv,x.indices])}else if("ExtrudePolygon"===e){var p=[],c=[];i.forEach((function(n){var t=[n];Q(t,u,a,o);var r=X(t),e=r.position,i=r.normal,v=r.uv,s=r.indices;p.push({id:n.id,position:e,normal:i,uv:v,indices:s}),c.push(e,i,v,s)})),t(null,p,c)}else if("Line"===e||"FatLine"===e){for(var d=[],g=[],y=0,m=i.length;y<m;y++){for(var w=[],M=0,b=i[y].data.length;M<b;M++){i[y].data[M]=T(i[y].data[M],i[y].center||u,a,o);var A=sn(i[y].data[M]);w.push(hn(A))}var Z=fn(w);rn(Z,i[y].bottomHeight),d.push({id:i[y].id,position:Z.buffer}),g.push(Z.buffer)}t(null,d,g)}else if("Lines"===e||"FatLines"===e){for(var F=0,P=[],z=[],I=0,E=[],L=0,H=i.length;L<H;L++){for(var U=0,j=0,O=i[L].data.length;j<O;j++){i[L].data[j]=T(i[L].data[j],i[L].center||u,a,o);var S=sn(i[L].data[j]);rn(S,i[L].bottomHeight),U+=S.length/3*2-2,E.push(hn(S))}var W=U;P[L]=[F,F+W],F+=W,z[L]={position:{count:U,start:I,end:I+3*U},hide:!1},"FatLines"===e&&(z[L].instanceStart={count:U,start:I,end:I+3*U},z[L].instanceEnd={count:U,start:I,end:I+3*U}),I+=3*U}var k=fn(E);t(null,{id:i.id,position:k.buffer,geometriesAttributes:z,faceMap:P},[k.buffer])}else if("ExtrudeLine"===e){for(var B=0,V=i.length;B<V;B++)for(var _=0,q=i[B].data.length;_<q;_++)i[B].data[_]=T(i[B].data[_],i[B].center||u,a,o);var R=[],C=[];i.forEach((function(n){var t=X([n],!0),r=t.position,e=t.normal,i=t.uv,a=t.indices;R.push({id:n.id,position:r,normal:e,uv:i,indices:a}),C.push(r,e,i,a)})),t(null,R,C)}else if("Bar"===e){for(var D=[],G=[],J=(i=new Float32Array(i)).length/7,K=0;K<J;){var N=i.slice(7*K,7*(K+1)),Y=en(N),$=Y.position,nn=Y.normal,tn=Y.uv,an=Y.indices;D.push({id:parseInt(N[6]),position:$,normal:nn,uv:tn,indices:an}),G.push($,nn,tn,an),K++}t(null,D,G)}else if("Bars"===e){var on=en(i=new Float32Array(i));t(null,on,[on.position,on.normal,on.uv,on.indices])}},Object.defineProperty(n,"__esModule",{value:!0})})'),Cd("__maptalks.three.fetchdata__",(function(t){const e=[],i=[];function n(t){t.abort?(i.splice(i.indexOf(t),1),e.length&&(i.push(e[0]),e.splice(0,1),r(i[i.length-1]))):i.length<5?(i.push(t),r(t)):e.push(t)}function r(t){fetch(t.url).then((t=>t.text())).then((e=>{new Blob([e],{type:"application/json"}).arrayBuffer().then((e=>{t.postResponse(null,e,[e]),t.abort=!0,n(t)}))})).catch((e=>{t.abort=!0,n(t)}))}t.initialize=function(){},t.onmessage=function(t,e){n({url:t.data,postResponse:e,abort:!1})}})));const eM={speed:.02,radius:1,altitude:0};
/**
			 * 
			 * */class iM extends zv{constructor(t,e,i,n){e=Nc.extend({},eM,e,{layer:n,coordinate:t}),super(),//Initialize internal configuration
// https://github.com/maptalks/maptalks.three/blob/1e45f5238f500225ada1deb09b8bab18c1b52cf2/src/BaseObject.js#L135
this._initOptions(e);const{altitude:r,radius:s}=e,o=n.distanceToVector3(s,s).x,a=new ha(o,50,50,0,2*Math.PI);//generate geometry
//Initialize internal object3d
// https://github.com/maptalks/maptalks.three/blob/1e45f5238f500225ada1deb09b8bab18c1b52cf2/src/BaseObject.js#L140
this._createMesh(a,i),this._createGroup();const h=new gi(a,i);this.getObject3d().add(h);//set object3d position
const l=n.altitudeToVector3(r,r).x,c=n.coordinateToVector3(t,l);this.getObject3d().position.copy(c),this.getObject3d().rotation.x=Math.PI/2}_animation(){this.getObject3d().children[0].material.uniforms.time.value+=this.getOptions().speed}}e("default",l(r({__name:"smartCity",setup(t){const e=s(null);o((()=>{i(e.value)}));const i=(t,e)=>{let i={center:[113.64,34.75],zoom:16,pitch:40,bearing:160,centerCross:!0,doubleClickZoom:!1,baseLayer:new i_("tile",{urlTemplate:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",subdomains:["a","b","c","d"],attribution:'&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>'})};e=Object.assign(i,e);let n=new yp(t,e);const r=new Xb("t",{forceRenderOnMoving:!0,forceRenderOnRotating:!0,forceRenderOnZooming:!0,identifyCountOnEvent:1});return r.prepareToDraw=function(t,e,i){const s=new ta(16777215);s.position.set(0,0,0).normalize(),e.add(s),e.add(new ea("#fff",.2)),function(t){var e=new Ue({color:"#3e35cf"}),i=[];fetch("/base.geojson").then((function(t){return t.json()})).then((function(n){n.features.forEach((function(n){var r=2,s=n.properties.Elevation||1,o=t.toExtrudePolygon(Qp.toGeometry(n),{height:r*s,topColor:"#fff",interactive:!1},e);i.push(o)})),t.addMesh(i)}))}(r),function(t,e){const i=function(){var t={uniforms:{time:{type:"f",value:0},color:{type:"c",value:new pt("#9999FF")},opacity:{type:"f",value:1}},vertexShaderSource:"\n  precision lowp float;\n  precision lowp int;\n  ".concat(ji.fog_pars_vertex,"\n  varying vec2 vUv;\n  void main() {\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    ").concat(ji.fog_vertex,"\n  }\n"),// 
fragmentShaderSource:"\n          #if __VERSION__ == 100\n           #extension GL_OES_standard_derivatives : enable\n          #endif\n          uniform vec3 color;\n          uniform float opacity;\n          uniform float time;\n          varying vec2 vUv;\n          #define pi 3.1415926535\n          #define PI2RAD 0.01745329252\n          #define TWO_PI (2. * PI)\n          float rands(float p){\n              return fract(sin(p) * 10000.0);\n          }\n          float noise(vec2 p){\n              float t = time / 20000.0;\n              if(t > 1.0) t -= floor(t);\n              return rands(p.x * 14. + p.y * sin(t) * 0.5);\n          }\n          vec2 sw(vec2 p){\n              return vec2(floor(p.x), floor(p.y));\n          }\n          vec2 se(vec2 p){\n              return vec2(ceil(p.x), floor(p.y));\n          }\n          vec2 nw(vec2 p){\n              return vec2(floor(p.x), ceil(p.y));\n          }\n          vec2 ne(vec2 p){\n              return vec2(ceil(p.x), ceil(p.y));\n          }\n          float smoothNoise(vec2 p){\n              vec2 inter = smoothstep(0.0, 1.0, fract(p));\n              float s = mix(noise(sw(p)), noise(se(p)), inter.x);\n              float n = mix(noise(nw(p)), noise(ne(p)), inter.x);\n              return mix(s, n, inter.y);\n          }\n          float fbm(vec2 p){\n              float z = 2.0;\n              float rz = 0.0;\n              vec2 bp = p;\n              for(float i = 1.0; i < 6.0; i++){\n              rz += abs((smoothNoise(p) - 0.5)* 2.0) / z;\n              z *= 2.0;\n              p *= 2.0;\n              }\n              return rz;\n          }\n          void main() {\n              vec2 uv = vUv;\n              vec2 uv2 = vUv;\n              if (uv.y < 0.5) {\n              discard;\n              }\n              uv *= 4.;\n              float rz = fbm(uv);\n              uv /= exp(mod(time * 2.0, pi));\n              rz *= pow(15., 0.9);\n              gl_FragColor = mix(vec4(color, opacity) / rz, vec4(color, 0.1), 0.2);\n              if (uv2.x < 0.05) {\n              gl_FragColor = mix(vec4(color, 0.1), gl_FragColor, uv2.x / 0.05);\n              }\n              if (uv2.x > 0.95){\n              gl_FragColor = mix(gl_FragColor, vec4(color, 0.1), (uv2.x - 0.95) / 0.05);\n              }\n          }"};return new bi({uniforms:t.uniforms,defaultAttributeValues:{},vertexShader:t.vertexShaderSource,fragmentShader:t.fragmentShaderSource,blending:2,depthWrite:!1,depthTest:!0,side:2,transparent:!0})}(),n=new iM(e.getCenter(),{radius:500},i,t);t.addMesh(n),tM(t)}(r,n)},r.addTo(n),r};return(t,i)=>(h(),a("div",{ref_key:"maptalksRef",ref:e,id:"maptalksID"},null,512))}}),[["__scopeId","data-v-928086a4"]]));/* unplugin-vue-components disabled */}}}))}();
